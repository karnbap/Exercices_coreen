<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice de Dictée : Comme en Coréen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .korean-font {
            font-family: 'Gowun Dodum', sans-serif;
        }

        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #d1d5db;
        }

        .btn-hint {
            background-color: #fefce8;
            color: #a16207;
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            border: 1px solid #fde047;
        }
        .btn-hint:hover:not(:disabled) {
             background-color: #fef08a;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dictation-card {
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
        }
        
        .feedback {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .feedback.correct {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        .feedback.incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
</head>

<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-2">Dictée : Comme en Coréen 🎧</h1>
            <p class="text-lg text-slate-600">Écoutez bien et écrivez les phrases avec 같아요, 같은, 처럼, 같이 !</p>
        </header>

        <!-- Explanations Section -->
        <section id="explanations" class="mb-12 card">
            <h2 class="text-2xl font-bold mb-4 text-slate-700">Rappel : La Règle d'Or 🔑</h2>
            <div class="space-y-4 text-slate-600">
                <p>🙋‍♀️ <strong class="korean-font text-green-600">같아요</strong> : Pour dire "Être comme..." (simple comparaison).</p>
                <p>✍️ <strong class="korean-font text-purple-600">같은</strong> : Pour décrire un nom ("qui est comme...").</p>
                <p>🏃‍♂️ <strong class="korean-font text-blue-600">처럼 / 같이</strong> : Pour décrire une action (verbe).</p>
                <p>⚠️ <strong class="korean-font text-red-600">같이</strong> peut aussi vouloir dire "ensemble".</p>
            </div>
        </section>

        <!-- Exercises Section -->
        <section id="dictation-exercises">
            <!-- Les exercices seront injectés ici par JS -->
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const exercises = [
            { sentence: "천사 같아요.", translation: "Elle est comme un ange.", hint1: "ㅊㅅ ㄱㅇㅇ", hint2: "천사 = ange", voice: "Kore" },
            { sentence: "이건 꿈 같아요.", translation: "Ceci est comme un rêve.", hint1: "ㅇㄱ ㄲ ㄱㅇㅇ", hint2: "꿈 = rêve", voice: "Puck" },
            { sentence: "가족 같은 친구예요.", translation: "C'est une amie comme ma famille.", hint1: "ㄱㅈ ㄱㅇ ㅊㄱㅇㅇ", hint2: "가족  = famille", voice: "Charon" },
            { sentence: "바다 같은 넓은 마음.", translation: "Un coeur large comme la mer.", hint1: "ㅂㄷ ㄱㅇ ㄴㅇ ㅁㅇ", hint2: "바다 = mer, 넓은 = large", voice: "Leda" },
            { sentence: "소처럼 먹어요.", translation: "Il/Elle mange comme une vache.", hint1: "ㅅㅊㄹ ㅁㅇㅇ", hint2: "소 = vache", voice: "Fenrir" },
            { sentence: "그 사람은 바람처럼 달려요.", translation: "Il court comme le vent.", hint1: "ㄱㄴ ㅂㄹㅊㄹ ㄷㄹㅇ", hint2: "바람  = vent", voice: "Orus" },
            { sentence: "가수같이 노래를 잘해요.", translation: "Il/Elle chante bien comme un(e) chanteur(se).", hint1: "ㄱㅅㄱㅇ ㄴㄹㄹ ㅈㅎㅇ", hint2: "가수  = chanteur/chanteuse", voice: "Aoede" },
            { sentence: "로봇같이 걸어요.", translation: "Il/Elle marche comme un robot.", hint1: "ㄹㅂㄱㅇ ㄱㅇㅇ", hint2: "로봇 = robot", voice: "Callirrhoe" },
            { sentence: "친구랑 같이 갔어요.", translation: "Je suis allé(e) avec mon ami(e).", hint1: "ㅊㄱㄹ ㄱㅇ ㄱㅇㅇ", hint2: "같이  = ici, 'ensemble'", voice: "Zephyr" },
            { sentence: "별 같이 춤을 춰요.", translation: "Il/Elle danse comme une étoile.", hint1: "ㅂ ㄱㅇ ㅊㅇ ㅊㅇ", hint2: "별  = étoile", voice: "Enceladus" },
            { sentence: "오늘은 어제 같아요.", translation: "Aujourd'hui est comme hier.", hint1: "ㅇㄴㅇ ㅇㅈ ㄱㅇㅇ", hint2: "어제  = hier", voice: "Iapetus" },
            { sentence: "그 사람은 배우 같아요.", translation: "Cette personne est comme un(e) acteur/actrice.", hint1: "ㄱ ㅅㄹㅇ ㅂㅇ ㄱㅇㅇ", hint2: "배우  = acteur/actrice", voice: "Umbriel" },
            { sentence: "얼음 같은 손.", translation: "Une main (froide) comme la glace.", hint1: "ㅇㅇ ㄱㅇ ㅅ", hint2: "얼음 = glace", voice: "Despina" },
            { sentence: "설탕 같은 목소리.", translation: "Une voix (douce) comme le sucre.", hint1: "ㅅㅌ ㄱㅇ ㅁㅅㄹ", hint2: "설탕  = sucre", voice: "Erinome" },
            { sentence: "인형 같은 아이.", translation: "Un enfant comme une poupée.", hint1: "ㅇㅎ ㄱㅇ ㅇㅇ", hint2: "인형 = poupée", voice: "Algenib" },
            { sentence: "물처럼 돈을 써요.", translation: "Il/Elle dépense de l'argent comme de l'eau.", hint1: "ㅁㅊㄹ ㄷㅇ ㅆㅇ", hint2: "물 = eau", voice: "Rasalgethi" },
            { sentence: "거북이처럼 느려요.", translation: "Il/Elle est lent(e) comme une tortue.", hint1: "ㄱㅂㅇㅊㄹ ㄴㄹㅇ", hint2: "거북이 = tortue", voice: "Laomedeia" },
            { sentence: "전문가처럼 말해요.", translation: "Il/Elle parle comme un expert.", hint1: "ㅈㅁㄱㅊㄹ ㅁㅎㅇ", hint2: "전문가  = expert", voice: "Achernar" },
            { sentence: "아기같이 자요.", translation: "Il/Elle dort comme un bébé.", hint1: "ㅇㄱㄱㅇ ㅈㅇ", hint2: "아기 = bébé", voice: "Alnilam" },
            { sentence: "영화배우처럼 잘생겼어요.", translation: "Il est beau comme un acteur de cinéma.", hint1: "ㅇㅎㅂㅇㅊㄹ ㅈㅅㄱㅇㅇ", hint2: "영화배우 = acteur de cinéma", voice: "Schedar" }
        ];

        const container = document.getElementById('dictation-exercises');
        const audioCache = {};

        // --- Helper function to convert Base64 PCM to WAV Blob ---
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);

            return new Blob([header, pcm16], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- TTS API Call ---
        async function getAudio(text, voice, button) {
            if (audioCache[text]) {
                const audio = new Audio(audioCache[text]);
                audio.play();
                return;
            }

            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            try {
                // Calling your Netlify serverless function
                const apiUrl = `/.netlify/functions/generate-audio`;
                
                const payload = {
                    text: text,
                    voice: voice
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const result = await response.json();
                const audioData = result?.audioData;
                const mimeType = result?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioCache[text] = audioUrl;
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    throw new Error("Invalid audio data received from your API.");
                }

            } catch (error) {
                console.error("Audio Generation Error:", error);
                alert("Désolé, une erreur est survenue lors de la génération de l'audio via votre API.");
            } finally {
                button.disabled = false;
                 button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>`;
            }
        }

        // --- Render Exercises ---
        function renderExercises() {
            container.innerHTML = '';
            exercises.forEach((ex, index) => {
                const el = document.createElement('div');
                el.className = 'dictation-card';
                el.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold text-indigo-500">${index + 1}</span>
                        <button data-sentence="${ex.sentence}" data-voice="${ex.voice}" class="btn btn-primary play-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>
                        </button>
                        <input type="text" class="korean-font text-lg p-2 border-2 border-slate-300 rounded-lg w-full focus:border-indigo-500 focus:ring-indigo-500 transition" placeholder="Écrivez ici (한글로 작성)">
                    </div>
                    <div class="mt-3 ml-12 flex items-center gap-2">
                         <button class="btn btn-hint hint1-btn">💡 Indice 1 (초성)</button>
                         <button class="btn btn-hint hint2-btn">💡 Indice 2 (단어)</button>
                         <button class="btn btn-secondary check-btn">Vérifier (정답 확인)</button>
                    </div>
                    <div class="mt-2 ml-12 hint-display"></div>
                    <div class="mt-2 ml-12 feedback-display"></div>
                `;
                container.appendChild(el);
            });
            addEventListeners();
        }

        function addEventListeners() {
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const currentBtn = e.currentTarget;
                    getAudio(currentBtn.dataset.sentence, currentBtn.dataset.voice, currentBtn);
                });
            });

            document.querySelectorAll('.check-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => checkAnswer(index));
            });
            
            document.querySelectorAll('.hint1-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => showHint(index, 1));
            });
            
            document.querySelectorAll('.hint2-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => showHint(index, 2));
            });
            
            document.querySelectorAll('input[type="text"]').forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        checkAnswer(index);
                    }
                });
            });
        }

        function showHint(index, hintType) {
            const hintDisplay = document.querySelectorAll('.hint-display')[index];
            const exercise = exercises[index];
            const hint1Btn = document.querySelectorAll('.hint1-btn')[index];
            const hint2Btn = document.querySelectorAll('.hint2-btn')[index];

            if (hintType === 1) {
                hintDisplay.innerHTML = `<p class="text-sm text-amber-700 korean-font"><strong>Indice 1 :</strong> ${exercise.hint1}</p>`;
                hint1Btn.disabled = true;
            } else {
                let existingHint = hintDisplay.querySelector('p:first-child')?.outerHTML || '';
                hintDisplay.innerHTML = existingHint + `<p class="text-sm text-amber-700 korean-font mt-1"><strong>Indice 2 :</strong> ${exercise.hint2}</p>`;
                hint2Btn.disabled = true;
            }
        }

        function checkAnswer(index) {
            const input = document.querySelectorAll('input[type="text"]')[index];
            const feedbackDisplay = document.querySelectorAll('.feedback-display')[index];
            const userAnswer = input.value.replace(/[.\s]/g, ''); // Remove spaces and periods for comparison
            const correctAnswer = exercises[index].sentence.replace(/[.\s]/g, '');

            if (userAnswer === correctAnswer) {
                feedbackDisplay.innerHTML = `
                    <div class="feedback correct">
                        <strong class="text-lg">🥳 Bravo ! C'est parfait !</strong>
                        <p class="korean-font mt-1"><strong>Réponse :</strong> ${exercises[index].sentence}</p>
                        <p><strong>Traduction :</strong> ${exercises[index].translation}</p>
                    </div>
                `;
            } else {
                 feedbackDisplay.innerHTML = `
                    <div class="feedback incorrect">
                        <strong class="text-lg">🤔 Presque ! Essayez encore.</strong>
                        <p class="korean-font mt-1"><strong>Votre réponse :</strong> ${input.value}</p>
                        <p class="korean-font"><strong>Réponse correcte :</strong> ${exercises[index].sentence}</p>
                        <p><strong>Traduction :</strong> ${exercises[index].translation}</p>
                    </div>
                `;
            }
        }
        
        renderExercises();
    });
    </script>
</body>
</html>


