<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice CorÃ©en : Les Nombres (ìˆœìˆ˜ í•œêµ­ì–´ vs í•œìì–´)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .quiz-container{max-width:800px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .progress-bar{width:100%;height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden}
    .progress-bar-inner{height:100%;background:#3b82f6;transition:width .3s ease-in-out}
    .question-title{font-size:1.5rem;font-weight:700;color:#1f2937;margin-bottom:1rem}
    .question-text{font-size:1.1rem;color:#4b5563;margin-bottom:1.5rem;line-height:1.6}
    .btn{padding:.75rem 1.5rem;border-radius:.5rem;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff;font-size:1.2rem}.btn-sound:hover{background:#059669}
    .choice-btn{display:block;width:100%;text-align:left;padding:1rem;margin-bottom:.75rem;background:#fff;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem;transition:all .2s}
    .choice-btn:hover{background:#eff6ff;border-color:#3b82f6}
    .choice-btn.selected{background:#bfdbfe;border-color:#3b82f6;font-weight:600}
    .input-field{width:100%;padding:.75rem 1rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem}
    .hidden{display:none}.disabled{opacity:.5;cursor:not-allowed}
    .recording-dot{width:12px;height:12px;background:red;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
  </style>
</head>
<body class="bg-gray-50">

  <!-- ìƒë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="absolute top-4 left-4 text-sm text-gray-400">
    made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com
  </div>

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
    <h1 class="text-4xl font-bold text-slate-800 mb-2">Exercice : Les Nombres CorÃ©ens ğŸ”¢</h1>
    <p class="text-lg text-slate-600 mb-6">ìˆœìˆ˜ í•œêµ­ì–´ (natifs) vs í•œìì–´ (Hanja-corÃ©ens)</p>
    <div class="w-full max-w-sm">
      <input id="student-name" class="w-full p-3 text-center border-2 border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Quel est ton nom ? (ì´ë¦„ì´ ë­ì˜ˆìš”?)">
      <button id="start-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Commencer ! (ì‹œì‘!)</button>
    </div>
  </div>

  <!-- ì„¤ëª… -->
  <div id="explanation-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">ğŸ“˜ Apprendre les nombres corÃ©ens !</h2>
    <p class="text-center text-slate-600 mb-8">(Ft. í•œì vs chinois?!)</p>

    <div class="space-y-6 text-slate-700">
      <div>
        <h3 class="font-bold text-xl mb-3">1ï¸âƒ£ Petite explication</h3>
        <p class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">ğŸ‘‰ Beaucoup de FranÃ§ais pensent que Â« í•œì = chinois Â». Mais non !</p>
        <ul class="list-disc list-inside mt-3 space-y-2">
          <li><strong>í•œì (Hanja)</strong> = systÃ¨me dâ€™Ã©criture.</li>
          <li><strong>Chinois</strong> = langue.</li>
        </ul>
      </div>

      <div>
        <p class="mb-4">En corÃ©en, on utilise <strong>deux systÃ¨mes de nombres</strong> :</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h4 class="font-bold text-lg text-blue-800">Natifs (ìˆœìˆ˜ í•œêµ­ì–´)</h4>
            <p class="text-2xl font-bold my-2">í•˜ë‚˜, ë‘˜, ì…‹â€¦</p>
            <p><strong>Pour :</strong> comptages concrets (Ã¢ge, personnes, objetsâ€¦)</p>
          </div>
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 class="font-bold text-lg text-green-800">Hanja-corÃ©ens (í•œìì–´)</h4>
            <p class="text-2xl font-bold my-2">ì¼, ì´, ì‚¼â€¦</p>
            <p><strong>Pour :</strong> unitÃ©s/valeurs â€œnommÃ©esâ€ (dates, argent, minutesâ€¦)</p>
          </div>
        </div>
      </div>

      <div>
        <h3 class="font-bold text-xl mb-3">âš¡ Exception & Tendance</h3>
        <ul class="list-disc list-inside space-y-2">
          <li>Heures(ì‹œ) â†’ <b>natifs</b>, Minutes(ë¶„) â†’ <b>Hanja</b></li>
          <li>Mots rÃ©cents: parfois anglais mÃ©langÃ©</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-xl mb-3">âœ… RÃ©sumÃ© facile</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead><tr class="bg-gray-100"><th class="p-3 border">SystÃ¨me</th><th class="p-3 border">Usage</th><th class="p-3 border">Exemples</th></tr></thead>
            <tbody>
              <tr><td class="p-3 border font-semibold">ìˆœìˆ˜ í•œêµ­ì–´</td><td class="p-3 border">Compter</td><td class="p-3 border">Ã‚ge(ì‚´), Personnes(ëª…), Objets(ê°œ), Heures(ì‹œ)</td></tr>
              <tr><td class="p-3 border font-semibold">í•œìì–´</td><td class="p-3 border">UnitÃ©s</td><td class="p-3 border">Dates, Argent, Minutes, NumÃ©ros</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="explanation-next-btn" class="btn btn-primary text-lg">C'est compris, Ã  l'Ã©chauffement ! <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- ì›Œë°ì—… -->
  <div id="warmup-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">Ã‰chauffement : RÃ©pÃ©tition Rapide ğŸ—£ï¸</h2>
    <p class="text-lg text-slate-600 mb-8 text-center">ë“£ê³  ì—¬ëŸ¬ ë²ˆ ì†Œë¦¬ ë‚´ì–´ ë”°ë¼ ì½ìœ¼ì„¸ìš”.</p>

    <div class="space-y-4">
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Natifs (1-5) : <span class="font-normal text-gray-500">í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯</span></p>
        <!-- ë” ìì—°ìŠ¤ëŸ¬ìš´ ë‚¨ì„± D + ë‹¨ì–´ ì‚¬ì´ ì‰¬ê¸° + ëŠë¦¬ê²Œ -->
        <button class="btn btn-sound" onclick="playAudio('í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯','ko-KR-Neural2-D',{ ssml:true, insertBreakMs:350, speakingRate:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Natifs (6-10) : <span class="font-normal text-gray-500">ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´</span></p>
        <!-- ë°ê³  ìì—°ìŠ¤ëŸ¬ìš´ ì—¬ì„± A + ë‹¨ì–´ ì‚¬ì´ ì‰¬ê¸° + ëŠë¦¬ê²Œ -->
        <button class="btn btn-sound" onclick="playAudio('ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´','ko-KR-Neural2-A',{ ssml:true, insertBreakMs:350, speakingRate:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Hanja (1-5) : <span class="font-normal text-gray-500">ì¼, ì´, ì‚¼, ì‚¬, ì˜¤</span></p>
        <button class="btn btn-sound" onclick="playAudio('ì¼ì´ì‚¼ì‚¬ì˜¤','alloy')"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Hanja (6-10) : <span class="font-normal text-gray-500">ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­</span></p>
        <button class="btn btn-sound" onclick="playAudio('ìœ¡ì¹ íŒ”êµ¬ì‹­','alloy')"><i class="fas fa-play"></i></button>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="start-quiz-btn" class="btn btn-primary text-lg">Commencer l'exercice ! (ì—°ìŠµë¬¸ì œ ì‹œì‘!) <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- ë³¸ í€´ì¦ˆ -->
  <div id="quiz-screen" class="quiz-container hidden">
    <div class="flex justify-between items-center mb-4">
      <span id="progress-text" class="text-sm font-semibold text-gray-600"></span>
      <button id="print-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-print"></i> Imprimer / í”„ë¦°íŠ¸</button>
    </div>
    <div class="progress-bar mb-6"><div id="progress-bar-inner" class="progress-bar-inner"></div></div>
    <div id="question-area"></div>
    <div id="navigation-btns" class="mt-8 flex justify-between items-center">
      <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> PrÃ©cÃ©dent (ì´ì „)</button>
      <button id="next-btn" class="btn btn-primary">Suivant (ë‹¤ìŒ) <i class="fas fa-arrow-right"></i></button>
      <button id="finish-btn" class="btn btn-primary hidden">Terminer ! (ëë‚´ê¸°!)</button>
    </div>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result-screen" class="quiz-container hidden text-center">
    <h2 class="text-3xl font-bold text-slate-800 mb-4">RÃ©sultats du test</h2>
    <div id="result-feedback" class="text-2xl font-semibold mb-6"></div>
    <p class="text-slate-600 mb-2">Score final : <span id="final-score" class="font-bold"></span></p>
    <p class="text-slate-600 mb-6">Temps total : <span id="total-time" class="font-bold"></span> secondes</p>
    <div id="review-section"><h3 class="text-xl font-bold text-slate-700 mt-8 mb-4">RÃ©vision des questions</h3><div id="review-content" class="text-left space-y-4"></div></div>
    <div class="mt-8 flex justify-center gap-4">
      <button id="restart-btn" class="btn btn-primary"><i class="fas fa-redo"></i> Recommencer (ë‹¤ì‹œí•˜ê¸°)</button>
      <a href="../index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Retour aux exercices (ì—°ìŠµë¬¸ì œë¡œ ëŒì•„ê°€ê¸°)</a>
    </div>
  </div>

  <!-- í•˜ë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="absolute bottom-4 right-4 text-sm text-gray-400">
    made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com
  </div>

  <!-- ì˜¤ë¥˜ ëª¨ë‹¬ -->
  <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 class="text-xl font-bold text-red-600 mb-2">Oops ! Une erreur est survenue.</h3>
      <p id="error-message" class="text-gray-700 mb-4"></p>
      <button id="close-error-modal-btn" class="btn btn-primary w-full mt-4">J'ai compris</button>
    </div>
  </div>

  <script src="../assets/grading-criteria.js"></script>
  <script>
    // ===== Global =====
    let studentName = "";
    let currentQuestionIndex = 0;
    let questions = [];
    let startTime, endTime;
    let mediaRecorder, audioChunks = [];
    let currentAudio = null, currentBlobUrl = null;

    const placeholders = ["Camille","Lucas","ZoÃ©","Arthur","Ã‰lise","LÃ©a","Hugo","ThÃ©o","Oscar","ChloÃ©","Jeanne d'Arc","NapolÃ©on","Marie Curie","Louis XIV"];

    // ===== Error UI =====
    function showErrorModal(message){
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-modal').classList.remove('hidden');
    }
    async function logError(error, functionName, context){
      try{
        await fetch('/.netlify/functions/log-error',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({studentName:studentName||"Non dÃ©fini", error:{message:error?.message||String(error), stack:error?.stack||null}, functionName, context, pageUrl:window.location.href})
        });
      }catch(e){ console.error('log-error fail', e); }
    }

    // ===== Audio helpers =====
    function base64ToBlob(base64, mime='audio/mp3'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    function cleanupAudio(){
      if(currentAudio){ currentAudio.pause(); currentAudio.src=""; currentAudio=null; }
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
    }

    // ===== TTS =====
    async function playAudio(text, voice='alloy', opts = {}){
      try{
        if(questions.length>0 && questions[currentQuestionIndex]) questions[currentQuestionIndex].listenCount++;
        cleanupAudio();

        const res = await fetch('/.netlify/functions/generate-audio',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text, voice, ...opts })
        });
        if(!res.ok) throw new Error(`generate-audio: ${res.status} ${res.statusText}`);
        const data = await res.json();

        let srcUrl = null;
        if(data.audioUrl){
          srcUrl = data.audioUrl;
        }else if(data.audioBase64 || data.audioContent){
          const b64 = data.audioBase64 || data.audioContent;
          const blob = base64ToBlob(b64, data.mimeType||'audio/mpeg');
          srcUrl = URL.createObjectURL(blob); currentBlobUrl = srcUrl;
        }else{
          throw new Error('Invalid TTS response: missing audio');
        }

        const audio = new Audio(srcUrl);
        currentAudio = audio;
        let endedNaturally = false;  // âœ… ì¬ìƒ ì¢…ë£Œ í›„ ì—ëŸ¬ ë¬´ì‹œ

        audio.addEventListener('error', () => {
          if (endedNaturally) return; // âœ… ended ì´í›„ ì—ëŸ¬ëŠ” ë¬´ì‹œ
          const code = audio.error?.code ?? 0; // 1=ABORTED, 2=NETWORK, 3=DECODE, 4=SRC_NOT_SUPPORTED
          if(code === 1) return; // ì‚¬ìš©ìê°€ ì¤‘ë‹¨/ì¬ìƒ ì „í™˜ â†’ ëª¨ë‹¬ X
          console.error('Audio element fatal error', audio.error);
          showErrorModal("ì˜¤ë””ì˜¤ ì¬ìƒì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          cleanupAudio();
        });
        audio.addEventListener('ended', () => { endedNaturally = true; cleanupAudio(); });

        try{
          await audio.play();
        }catch(err){
          if(err?.name === 'AbortError' || err?.name === 'NotAllowedError') return;
          console.error('audio.play() failed', err);
          showErrorModal("ì˜¤ë””ì˜¤ ì¬ìƒì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          cleanupAudio();
        }
      }catch(error){
        console.error('playAudio error', error);
        logError(error,'playAudio',{text,voice,opts});
        showErrorModal("Impossible de jouer le son. L'erreur a Ã©tÃ© signalÃ©e.");
        cleanupAudio();
      }
    }

    // ===== Results =====
    async function sendResults(){
      endTime = new Date();
      const totalTimeSeconds = Math.round((endTime - startTime)/1000);
      const payload = {
        studentName,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        totalTimeSeconds,
        questions: questions.map(q=>({
          number:q.number, type:q.type,
          ko:q.ko||q.answer||'', fr:q.fr||q.context||'',
          userAnswer:q.userAnswer, isCorrect:q.isCorrect,
          listenCount:q.listenCount, hint1Count:q.hint1Count, hint2Count:q.hint2Count,
          recording:q.recording||null, pronunciationFeedback:q.pronunciationFeedback||null
        }))
      };
      try{
        const r = await fetch('/.netlify/functions/send-results',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        if(!r.ok) throw new Error(`send-results: ${r.status}`);
      }catch(e){
        console.error('sendResults error', e);
        logError(e,'sendResults',payload);
        showErrorModal("ê²°ê³¼ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë³´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ===== Questions =====
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

    function getQuestions(){
      const choiceData = [
        { context:"Pour la date '1ì¼', on dit :", options:["ì¼ì¼","í•˜ë‚˜ì¼"], answer:"ì¼ì¼", hint:"Date Ã©crite â‡’ Hanja" },
        { context:"Pour l'heure '1ì‹œ', on dit :", options:["í•œ ì‹œ","ì¼ ì‹œ"], answer:"í•œ ì‹œ", hint:"Heures â‡’ natif (ì˜ˆì™¸)" },
        { context:"Pour l'Ã¢ge '3ì‚´', on dit :", options:["ì„¸ ì‚´","ì‚¼ ì‚´"], answer:"ì„¸ ì‚´", hint:"Ã‚ge â‡’ natif" },
        { context:"Pour l'argent '10 euro', on dit :", options:["ì‹­ ìœ ë¡œ","ì—´ ìœ ë¡œ"], answer:"ì‹­ ìœ ë¡œ", hint:"Prix affichÃ© â‡’ Hanja" },
        { context:"Pour 30 minutes (30ë¶„), on dit :", options:["ì‚¼ì‹­ ë¶„","ì„œë¥¸ ë¶„"], answer:"ì‚¼ì‹­ ë¶„", hint:"Minutes â‡’ Hanja" }
      ];
      const fillData = [
        { fr:"J'ai trois ans. (ì €ëŠ” ___ ì‚´ì´ì—ìš”.)", ko:"ì„¸", hint:"Ã‚ge â‡’ natif" },
        { fr:"Il y a cinq livres. (ì±…ì´ ___ ê¶Œ ìˆì–´ìš”.)", ko:"ë‹¤ì„¯", hint:"Objets â‡’ natif" },
        { fr:"Aujourd'hui, c'est le 2 septembre. (ì˜¤ëŠ˜ì€ 9ì›” __ì¼ì´ì—ìš”.)", ko:"ì´", hint:"Date â‡’ Hanja" },
        { fr:"Nous sommes quatre personnes. (ìš°ë¦¬ëŠ” ___ ëª…ì´ì—ìš”.)", ko:"ë„¤", hint:"Personnes â‡’ natif" },
        { fr:"J'ai 10 euros. (ì €ëŠ” ___ ìœ ë¡œ ìˆì–´ìš”.)", ko:"ì‹­", hint:"Prix â‡’ Hanja" }
      ];
      const translateKoData = [
        { fr:"J'ai trois ans.", ko:"ì €ëŠ” ì„¸ ì‚´ì´ì—ìš”.", hint:"Ã‚ge â‡’ natif" },
        { fr:"Nous sommes quatre personnes.", ko:"ìš°ë¦¬ëŠ” ë„¤ ëª…ì´ì—ìš”.", hint:"Personnes â‡’ natif" },
        { fr:"Il y a cinq livres.", ko:"ì±…ì´ ë‹¤ì„¯ ê¶Œ ìˆì–´ìš”.", hint:"Objets â‡’ natif" },
        { fr:"Aujourd'hui, c'est le 2 septembre.", ko:"ì˜¤ëŠ˜ì€ 9ì›” 2ì¼ì´ì—ìš”.", hint:"Date â‡’ Hanja" },
        { fr:"Il est trois heures.", ko:"ì§€ê¸ˆì€ ì„¸ ì‹œì˜ˆìš”.", hint:"Heures â‡’ natif (ì˜ˆì™¸)" }
      ];
      const dictationData = [
        { ko:"ì‚¬ê³¼ ë‘ ê°œ ì£¼ì„¸ìš”.", fr:"Donnez-moi deux pommes, s'il vous plaÃ®t.", hint1:"ã……ã„± ã„· ã„± ã…ˆã……ã…‡", hint2:"ì‚¬ê³¼, ì£¼ì„¸ìš”", conceptualHint:"Compter â‡’ natif", voice:'shimmer' },
        { ko:"ì´ê±°ëŠ” ì˜¤ì²œ ì›ì´ì—ìš”.", fr:"Ceci coÃ»te 5000 won.", hint1:"ã…‡ã„±ã„´ ã…‡ã…Š ã…‡ã…‡ã…‡ã…‡", hint2:"ì´ê±°, ì›", conceptualHint:"Prix â‡’ Hanja", voice:'nova' },
        { ko:"ì œ ìƒì¼ì€ ì‹­ì´ì›” ì‹­ì¼ì´ì—ìš”.", fr:"Mon anniversaire est le 10 dÃ©cembre.", hint1:"ã…ˆ ã……ã…‡ã…‡ ã……ã…‡ã…‡ ã……ã…‡ã…‡ã…‡ã…‡", hint2:"ìƒì¼, ì‹­ì´ì›”", conceptualHint:"Date â‡’ Hanja", voice:'alloy' },
        { ko:"í•™ìƒ ì—¬ëŸ ëª…ì´ ìˆì–´ìš”.", fr:"Il y a huit Ã©tudiants.", hint1:"ã…ã…… ã…‡ã„· ã…ã…‡ ã…‡ã…‡ã…‡", hint2:"í•™ìƒ, ëª…", conceptualHint:"Personnes â‡’ natif", voice:'echo' },
        { ko:"ì§€ê¸ˆì€ ì˜¤í›„ ë„¤ ì‹œ ì‚¼ì‹­ ë¶„ì´ì—ìš”.", fr:"Il est 16h30.", hint1:"ã…ˆã„±ã…‡ ã…‡ã… ã„´ ã…… ã……ã…… ã…‚ã…‡ã…‡ã…‡", hint2:"ì‹œ, ë¶„", conceptualHint:"ì‹œ=natif / ë¶„=Hanja", voice:'fable' }
      ];

      const choice = shuffleArray(choiceData).slice(0,5).map((q,i)=>({number:i+1,type:'choice',context:q.context,answer:q.answer,options:shuffleArray(q.options),hint:q.hint,userAnswer:null,isCorrect:null,listenCount:0,hint1Count:0,hint2Count:0}));
      const fill = shuffleArray(fillData).slice(0,5).map((q,i)=>({number:choice.length+i+1,type:'fill',fr:q.fr,ko:q.ko,hint:q.hint,userAnswer:"",isCorrect:null,listenCount:0,hint1Count:0,hint2Count:0}));
      const translate = shuffleArray(translateKoData).slice(0,5).map((q,i)=>({number:choice.length+fill.length+i+1,type:'translate',fr:q.fr,ko:q.ko,hint:q.hint,userAnswer:"",isCorrect:null,listenCount:0,hint1Count:0,hint2Count:0}));
      const dictation = shuffleArray(dictationData).slice(0,5).map((q,i)=>({number:choice.length+fill.length+translate.length+i+1,type:'dictation',ko:q.ko,fr:q.fr,hint1:q.hint1,hint2:q.hint2,conceptualHint:q.conceptualHint,voice:q.voice,userAnswer:{ko:"",fr:"",selfDictation:""},isCorrect:null,listenCount:0,hint1Count:0,hint2Count:0,recording:null,pronunciationFeedback:null}));
      return [...choice,...fill,...translate,...dictation];
    }

    // ===== UI =====
    function renderQuestion(){
      const q = questions[currentQuestionIndex];
      const area = document.getElementById('question-area');
      const explanationMap = {
        choice:'Choisissez la bonne rÃ©ponse. / ì•Œë§ì€ ë‹µì„ ê³ ë¥´ì„¸ìš”.',
        fill:'Remplissez le champ vide. / ë¹ˆì¹¸ì„ ì±„ìš°ì„¸ìš”.',
        translate:'Traduisez en corÃ©en. / í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”.',
        dictation:'Ã‰coutez et Ã©crivez. / ë“£ê³  ë°›ì•„ì“°ì„¸ìš”.'
      };
      let html = `<h2 class="question-title">${q.type.toUpperCase()} - Question ${q.number}</h2><p class="question-text">${explanationMap[q.type]}</p>`;
      if(q.type==='choice'){
        html+=`<p class="text-lg font-semibold mb-4">${q.context}</p>
               <button class="btn btn-secondary w-full mb-4" onclick="showGeneralHint()">Aidez moi ğŸ™ (íŒíŠ¸)</button>
               <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg mb-4 hidden"></div>`;
        q.options.forEach(opt=>{ html+=`<button class="choice-btn ${q.userAnswer===opt?'selected':''}" onclick="selectChoiceAnswer('${opt}')">${opt}</button>`; });
      }else if(q.type==='fill'){
        html+=`<p class="text-lg font-semibold mb-4">${q.fr}</p>
               <button class="btn btn-secondary w-full mb-4" onclick="showGeneralHint()">Aidez moi ğŸ™ (íŒíŠ¸)</button>
               <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg mb-4 hidden"></div>
               <input class="input-field" value="${q.userAnswer||''}" oninput="updateFillAnswer(this.value)" placeholder="Ã‰crivez en hangeul...">`;
      }else if(q.type==='translate'){
        html+=`<p class="text-lg font-semibold mb-4">${q.fr}</p>
               <button class="btn btn-secondary w-full mb-4" onclick="showGeneralHint()">Aidez moi ğŸ™ (íŒíŠ¸)</button>
               <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg mb-4 hidden"></div>
               <input class="input-field" value="${q.userAnswer||''}" oninput="updateTranslateAnswer(this.value)" placeholder="Traduisez en corÃ©en...">`;
      }else if(q.type==='dictation'){
        html+=`<div class="space-y-4">
          <button class="btn btn-sound w-full text-lg" onclick="playAudio('${q.ko}','${q.voice}')"><i class="fas fa-play"></i> Ã‰couter la phrase (ë¬¸ì¥ ë“£ê¸°)</button>
          <div class="grid grid-cols-2 gap-2">
            <button class="btn btn-secondary" onclick="showHint(1)">Aidez moi ğŸ™ (ì´ˆì„±)</button>
            <button class="btn btn-secondary" onclick="showHint(2)">Au secours ğŸ›Ÿ (ë‹¨ì–´)</button>
            <button class="col-span-2 btn btn-secondary mt-2" onclick="showHint(3)">Pourquoi ce nombre ? ğŸ¤” (ìˆ«ì íŒíŠ¸)</button>
          </div>
          <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
          <div><label class="block mb-1 font-semibold">1. DictÃ©e (ë°›ì•„ì“°ê¸°)</label><input class="input-field" value="${q.userAnswer.ko||''}" oninput="updateDictationAnswer('ko',this.value)"></div>
          <div><label class="block mb-1 font-semibold">2. Traduction (ë²ˆì—­)</label><input class="input-field" value="${q.userAnswer.fr||''}" oninput="updateDictationAnswer('fr',this.value)"></div>
          <div><label class="block mb-1 font-semibold">3. Enregistrez votre voix (ë°œìŒ ë…¹ìŒ)</label>
            <div class="flex items-center gap-2">
              <button id="record-btn" class="btn btn-primary"><i class="fas fa-microphone"></i> DÃ©marrer</button>
              <div id="recording-indicator" class="hidden items-center gap-2 text-red-500 font-semibold"><div class="recording-dot"></div> Enregistrement...</div>
            </div>
            <audio id="audio-playback" controls class="mt-2 w-full hidden"></audio>
          </div>
          <div><label class="block mb-1 font-semibold">4. RÃ©Ã©coutez et Ã©crivez</label><input class="input-field" value="${q.userAnswer.selfDictation||''}" oninput="updateDictationAnswer('selfDictation',this.value)"></div>
        </div>`;
      }
      document.getElementById('question-area').innerHTML = html;
      if(q.type==='dictation') setupRecording();
      updateNavigation();
    }

    function updateNavigation(){
      document.getElementById('prev-btn').classList.toggle('disabled', currentQuestionIndex===0);
      document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex===questions.length-1);
      document.getElementById('finish-btn').classList.toggle('hidden', currentQuestionIndex<questions.length-1);
    }
    function updateProgressBar(){
      const progress=((currentQuestionIndex+1)/questions.length)*100;
      document.getElementById('progress-bar-inner').style.width=`${progress}%`;
      document.getElementById('progress-text').textContent=`Question ${currentQuestionIndex+1} sur ${questions.length}`;
    }

    // ===== Answers =====
    function selectChoiceAnswer(a){ questions[currentQuestionIndex].userAnswer=a; renderQuestion(); }
    function updateFillAnswer(a){ questions[currentQuestionIndex].userAnswer=a; }
    function updateTranslateAnswer(a){ questions[currentQuestionIndex].userAnswer=a; }
    function updateDictationAnswer(part,val){ questions[currentQuestionIndex].userAnswer[part]=val; }

    function showGeneralHint(){
      const q=questions[currentQuestionIndex], d=document.getElementById('hint-display');
      q.hint1Count++; d.textContent=q.hint; d.classList.remove('hidden');
    }
    function showHint(type){
      const q=questions[currentQuestionIndex], d=document.getElementById('hint-display');
      if(type===1){ q.hint1Count++; d.textContent=`Indice 1: ${q.hint1}`; }
      else if(type===2){ q.hint2Count++; d.textContent=`Indice 2: ${q.hint2}`; }
      else { q.hint2Count++; d.textContent=q.conceptualHint; }
      d.classList.remove('hidden');
    }

    // ===== Recording =====
    function setupRecording(){
      const recordBtn=document.getElementById('record-btn'),
            indicator=document.getElementById('recording-indicator'),
            playback=document.getElementById('audio-playback');

      recordBtn.onclick = async () => {
        if(mediaRecorder && mediaRecorder.state==="recording"){
          mediaRecorder.stop();
          recordBtn.innerHTML='<i class="fas fa-microphone"></i> DÃ©marrer';
          indicator.classList.add('hidden');
          recordBtn.classList.remove('bg-red-500','hover:bg-red-600');
        }else{
          try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
            mediaRecorder.onstop=()=>{
              const blob=new Blob(audioChunks,{type:'audio/webm'});
              const url=URL.createObjectURL(blob);
              playback.src=url; playback.classList.remove('hidden');

              const temp=new Audio(url);
              temp.addEventListener('loadedmetadata',()=>{
                const duration=temp.duration;
                const reader=new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend=()=>{ questions[currentQuestionIndex].recording={ base64:reader.result, filename:`rec_q${questions[currentQuestionIndex].number}.webm`, mimeType:'audio/webm', duration }; };
              });
              stream.getTracks().forEach(t=>t.stop());
            };
            mediaRecorder.start();
            recordBtn.innerHTML='<i class="fas fa-stop"></i> ArrÃªter';
            indicator.style.display='flex';
            recordBtn.classList.add('bg-red-500','hover:bg-red-600');
          }catch(err){
            logError(err,'setupRecording'); showErrorModal("ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          }
        }
      };
    }

    // ===== Flow =====
    function startQuiz(){
      studentName=document.getElementById('student-name').value.trim();
      if(!studentName){ showErrorModal("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (Entrez votre nom.)"); return; }
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('explanation-screen').classList.remove('hidden');
    }
    function showWarmupScreen(){
      document.getElementById('explanation-screen').classList.add('hidden');
      document.getElementById('warmup-screen').classList.remove('hidden');
    }
    function startRealQuiz(){
      startTime=new Date(); questions=getQuestions(); currentQuestionIndex=0;
      document.getElementById('warmup-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      renderQuestion(); updateProgressBar();
    }
    function nextQuestion(){ if(currentQuestionIndex<questions.length-1){ currentQuestionIndex++; renderQuestion(); updateProgressBar(); } }
    function prevQuestion(){ if(currentQuestionIndex>0){ currentQuestionIndex--; renderQuestion(); updateProgressBar(); } }

    function checkAnswers(){
      questions.forEach(q=>{
        if(q.type==='choice') q.isCorrect = q.userAnswer===q.answer;
        else if(q.type==='fill') q.isCorrect = (q.userAnswer||'').trim()===q.ko;
        else if(q.type==='translate') q.isCorrect = (q.userAnswer||'').trim().replace(/\s/g,'').replace(/[.,!?]/g,"")===q.ko.replace(/\s/g,'').replace(/[.,!?]/g,"");
        else if(q.type==='dictation') q.isCorrect = (q.userAnswer.ko||'').trim().replace(/\s/g,'')===q.ko.replace(/\s/g,'');
      });
    }
    function getFeedback(score){
      if(score>=90) return {fr:"Excellent travail ! ğŸŒŸ",ko:"ì™„ë²½í•´ìš”! ë„ˆë¬´ ì˜í–ˆì–´ìš” ğŸ˜Š",className:"text-green-600"};
      if(score>=70) return {fr:"TrÃ¨s bien ! Continuez ğŸ’ª",ko:"ì•„ì£¼ ì¢‹ì•„ìš”! ê³„ì†í•´ìš”!",className:"text-emerald-600"};
      if(score>=50) return {fr:"Pas mal ! On rÃ©vise encore ğŸ‘",ko:"ë‚˜ì˜ì§€ ì•Šì•„ìš”! ì¡°ê¸ˆë§Œ ë”!",className:"text-yellow-600"};
      return {fr:"Courage ! On va y arriver ğŸ‘Š",ko:"ê´œì°®ì•„ìš”! ê°™ì´ ë‹¤ì‹œ í•´ë´ìš”!",className:"text-orange-600"};
    }
    function showResults(){
      cleanupAudio();
      checkAnswers(); sendResults();

      const correct=questions.filter(q=>q.isCorrect).length;
      const score=Math.round((correct/questions.length)*100);
      const time=Math.round((new Date()-startTime)/1000);
      document.getElementById('final-score').textContent=`${score}% (${correct}/${questions.length})`;
      document.getElementById('total-time').textContent=`${time}`;
      const fb=getFeedback(score);
      const fbDiv=document.getElementById('result-feedback');
      fbDiv.innerHTML=`${fb.fr}<br>${fb.ko}`; fbDiv.className=`text-2xl font-semibold mb-6 ${fb.className}`;

      const review=document.getElementById('review-content'); review.innerHTML='';
      questions.forEach(q=>{
        const icon=q.isCorrect?'<i class="fas fa-check-circle text-green-500"></i>':'<i class="fas fa-times-circle text-red-500"></i>';
        let html=`<div class="p-4 border rounded-lg ${q.isCorrect?'bg-green-50':'bg-red-50'}"><p class="font-bold text-lg">${icon} Q${q.number} (${q.type})</p>`;
        let uAns='', cAns='';
        if(q.type==='choice'){ html+=`<p><strong>Q:</strong> ${q.context}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.answer; }
        else if(q.type==='fill'){ html+=`<p><strong>Q:</strong> ${q.fr.replace('___', `<strong>${q.userAnswer||'...'}</strong>`)}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.ko; }
        else if(q.type==='translate'){ html+=`<p><strong>Ã€ traduire:</strong> ${q.fr}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.ko; }
        else if(q.type==='dictation'){ html+=`<p><strong>Ã€ Ã©couter:</strong> ${q.ko}</p>`; uAns=`<strong>KR:</strong> ${q.userAnswer.ko||'vide'}<br><strong>FR:</strong> ${q.userAnswer.fr||'vide'}`; cAns=`<strong>KR:</strong> ${q.ko}<br><strong>FR:</strong> ${q.fr}`; }
        html += q.isCorrect ? `<p><strong>RÃ©ponse:</strong> ${uAns||cAns}</p>` : `<p><strong>Votre rÃ©ponse:</strong> <span class="text-red-700">${uAns}</span></p><p><strong>RÃ©ponse correcte:</strong> <span class="text-green-700">${cAns}</span></p>`;
        review.insertAdjacentHTML('beforeend', html + '</div>');
      });

      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
    }
    function restartQuiz(){
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }

    // ===== Events =====
    document.getElementById('start-btn').addEventListener('click', startQuiz);
    document.getElementById('explanation-next-btn').addEventListener('click', showWarmupScreen);
    document.getElementById('start-quiz-btn').addEventListener('click', startRealQuiz);
    document.getElementById('next-btn').addEventListener('click', nextQuestion);
    document.getElementById('prev-btn').addEventListener('click', prevQuestion);
    document.getElementById('finish-btn').addEventListener('click', showResults);
    document.getElementById('restart-btn').addEventListener('click', restartQuiz);
    document.getElementById('print-btn').addEventListener('click', ()=>window.print());
    document.getElementById('close-error-modal-btn').addEventListener('click', ()=>document.getElementById('error-modal').classList.add('hidden'));

    document.addEventListener('DOMContentLoaded', ()=>{
      const nameInput=document.getElementById('student-name');
      nameInput.placeholder=`Ex: ${placeholders[Math.floor(Math.random()*placeholders.length)]}`;
    });
  </script>
</body>
</html>
