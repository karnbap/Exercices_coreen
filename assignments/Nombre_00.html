<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice Coréen : Les Nombres (순수 한국어 vs 한자어) – Final v3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .quiz-container{max-width:800px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .progress-bar{width:100%;height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden}
    .progress-bar-inner{height:100%;background:#3b82f6;transition:width .3s ease-in-out}
    .question-title{font-size:1.5rem;font-weight:700;color:#1f2937;margin-bottom:1rem}
    .question-text{font-size:1.1rem;color:#4b5563;margin-bottom:1.5rem;line-height:1.6}
    .btn{padding:.75rem 1.5rem;border-radius:.5rem;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff;font-size:1.05rem}.btn-sound:hover{background:#059669}
    .choice-btn{display:block;width:100%;text-align:left;padding:1rem;margin-bottom:.75rem;background:#fff;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem;transition:all .2s}
    .choice-btn:hover{background:#eff6ff;border-color:#3b82f6}
    .choice-btn.selected{background:#bfdbfe;border-color:#3b82f6;font-weight:600}
    .input-field{width:100%;padding:.75rem 1rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem}
    .hidden{display:none}.disabled{opacity:.5;cursor:not-allowed}
    .recording-dot{width:12px;height:12px;background:red;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
  </style>
</head>
<body class="bg-gray-50">

  <!-- 상단 제작자/팀/메일 -->
  <div class="absolute top-4 left-4 text-sm text-gray-400">
    made by 성일, Pongdang · Lapeace29@gmail.com
  </div>

  <!-- 시작 화면 -->
  <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
    <h1 class="text-4xl font-bold text-slate-800 mb-2">Exercice : Les Nombres Coréens 🔢</h1>
    <p class="text-lg text-slate-600 mb-6">순수 한국어 (natifs) vs 한자어 (sino-coréen)</p>
    <div class="w-full max-w-sm">
      <input id="student-name" class="w-full p-3 text-center border-2 border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Quel est ton nom ? (이름이 뭐예요?)">
      <button id="start-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Commencer ! (시작!)</button>
    </div>
  </div>

  <!-- 설명 -->
  <div id="explanation-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">📘 Apprendre les nombres coréens !</h2>
    <p class="text-center text-slate-600 mb-8">(Hanja ≠ chinois : Hanja = écriture, chinois = langue / 한자는 글자, 중국어는 말)</p>

    <div class="space-y-6 text-slate-700">
      <div>
        <h3 class="font-bold text-xl mb-3">1️⃣ Petite explication / 간단 설명</h3>
        <ul class="list-disc list-inside mt-3 space-y-2">
          <li><strong>한자 (Hanja)</strong> = système d’écriture / 글자 체계</li>
          <li><strong>Chinois</strong> = langue / 중국어(말)</li>
        </ul>
      </div>

      <div>
        <p class="mb-4">En coréen, on utilise <strong>deux systèmes</strong> de nombres :</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h4 class="font-bold text-lg text-blue-800">Natifs (순수 한국어)</h4>
            <p class="text-2xl font-bold my-2">하나, 둘, 셋…</p>
            <p><strong>Pour :</strong> compter des choses qu’on voit (âge, personnes, objets…)
              <br>→ 눈앞에서 직접 세는 것(나이, 사람 수, 물건 개수…)</p>
          </div>
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 class="font-bold text-lg text-green-800">Sino-coréen (한자어)</h4>
            <p class="text-2xl font-bold my-2">일, 이, 삼…</p>
            <p><strong>Pour :</strong> noms/unités déjà écrits (dates, argent, minutes…)
              <br>→ 이미 정해진 이름/단위(날짜, 돈, 분 등)</p>
          </div>
        </div>
      </div>

      <div>
        <h3 class="font-bold text-xl mb-3">⚡ Exception & Tendance / 예외와 포인트</h3>
        <ul class="list-disc list-inside space-y-2">
          <li><b>Heures(시)</b> → natifs / <b>Minutes(분)</b> → sino-coréen.
            <br>→ <b>시=고유수 / 분=한자어</b></li>
          <li>Petit mémo ⌛ : Avant, on avait d’autres unités (ex. ‘각’ ≈ 15 min). Maintenant : 1 h = 60 min → <b>시=natifs / 분=sino-coréen</b>.
            <br>간단 역사: 예전엔 ‘각(15분)’ 같은 전통 단위 → 지금은 1시간=60분, 그래서 <b>시=고유 / 분=한자</b>.</li>
        </ul>
      </div>

      <div>
        <h3 class="font-bold text-xl mb-3">✅ Résumé facile / 한눈에 보기</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead><tr class="bg-gray-100"><th class="p-3 border">Système</th><th class="p-3 border">Usage</th><th class="p-3 border">Exemples</th></tr></thead>
            <tbody>
              <tr><td class="p-3 border font-semibold">순수 한국어</td><td class="p-3 border">Compter / 세기</td><td class="p-3 border">Âge(살), Personnes(명), Objets(개), Heures(시)</td></tr>
              <tr><td class="p-3 border font-semibold">한자어</td><td class="p-3 border">Noms/Unités écrits / 이름·단위</td><td class="p-3 border">Dates, Argent, Minutes, Numéros</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="explanation-next-btn" class="btn btn-primary text-lg">C'est compris, à l'échauffement ! <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- 워밍업 (간단 듣기) -->
  <div id="warmup-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center"> Méthode 5 par 5 🗣️</h2>
    <p class="text-lg text-slate-600 mb-8 text-center">Écoute et répète plusieurs fois ! / 여러 번 듣고 따라해요!</p>

    <div class="space-y-4">
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Natifs (1-5) : <span class="font-normal text-gray-500">하나, 둘, 셋, 넷, 다섯</span></p>
        <button class="btn btn-sound" onclick="playAudio('하나, 둘, 셋, 넷, 다섯','alloy',{ speed:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Natifs (6-10) : <span class="font-normal text-gray-500">여섯, 일곱, 여덟, 아홉, 열</span></p>
        <button class="btn btn-sound" onclick="playAudio('여섯, 일곱, 여덟, 아홉, 열','shimmer',{ speed:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Sino-coréen (1-5) : <span class="font-normal text-gray-500">일, 이, 삼, 사, 오</span></p>
        <button class="btn btn-sound" onclick="playAudio('일, 이, 삼, 사, 오','alloy')"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">Sino-coréen (6-10) : <span class="font-normal text-gray-500">육, 칠, 팔, 구, 십</span></p>
        <button class="btn btn-sound" onclick="playAudio('육, 칠, 팔, 구, 십','alloy')"><i class="fas fa-play"></i></button>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="start-quiz-btn" class="btn btn-primary text-lg">Commencer l'exercice ! (연습문제 시작!) <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- 본 퀴즈 -->
  <div id="quiz-screen" class="quiz-container hidden">
    <div class="flex justify-between items-center mb-4">
      <span id="progress-text" class="text-sm font-semibold text-gray-600"></span>
      <button id="print-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-print"></i> Imprimer / 프린트</button>
    </div>
    <div class="progress-bar mb-6"><div id="progress-bar-inner" class="progress-bar-inner"></div></div>
    <div id="question-area"></div>
    <div id="navigation-btns" class="mt-8 flex justify-between items-center">
      <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Précédent (이전)</button>
      <button id="next-btn" class="btn btn-primary">Suivant (다음) <i class="fas fa-arrow-right"></i></button>
      <button id="finish-btn" class="btn btn-primary hidden">Terminer ! (끝내기!)</button>
    </div>
  </div>

  <!-- 결과 -->
  <div id="result-screen" class="quiz-container hidden text-center">
    <h2 class="text-3xl font-bold text-slate-800 mb-4">Résultats du test</h2>
    <div id="result-feedback" class="text-2xl font-semibold mb-6"></div>
    <p class="text-slate-600 mb-2">Score final : <span id="final-score" class="font-bold"></span></p>
    <p class="text-slate-600 mb-6">Temps total : <span id="total-time" class="font-bold"></span> secondes</p>
    <div id="review-section"><h3 class="text-xl font-bold text-slate-700 mt-8 mb-4">Révision des questions</h3><div id="review-content" class="text-left space-y-4"></div></div>
    <div class="mt-8 flex justify-center gap-4">
      <button id="restart-btn" class="btn btn-primary"><i class="fas fa-redo"></i> Recommencer (다시하기)</button>
      <a href="../index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Retour aux exercices (연습문제로 돌아가기)</a>
    </div>
  </div>

  <!-- 하단 제작자/팀/메일 -->
  <div class="absolute bottom-4 right-4 text-sm text-gray-400">
    made by 성일, Pongdang · Lapeace29@gmail.com
  </div>

  <!-- 오류 모달 -->
  <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 class="text-xl font-bold text-red-600 mb-2">Oops ! Une erreur est survenue.</h3>
      <p id="error-message" class="text-gray-700 mb-4"></p>
      <button id="close-error-modal-btn" class="btn btn-primary w-full mt-4">J'ai compris</button>
    </div>
  </div>

  <!-- 이 페이지는 기본을 OpenAI 로 사용 -->
  <script>
    window.PONGDANG_TTS = { provider: 'openai' };
  </script>

  <script src="../assets/grading-criteria.js"></script>
  <script>
    // ===== Global =====
    let studentName = "";
    let currentQuestionIndex = 0;
    let questions = [];
    let startTime, endTime;
    let mediaRecorder, audioChunks = [];
    let currentAudio = null, currentBlobUrl = null;
    let currentFetchAbort = null;      // 최신 요청만 유효
    let audioClickLocked = false;      // 더블클릭 방지
    let isPlayingOrFetching = false;   // 동시 요청/재생 보호
    function tinyDelay(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // 받아쓰기 컨트롤용 메타 (워밍업도 공유)
    let currentAudioMeta = { text: null, voice: null };
    let currentAudioUI   = { playBtn: null, loopBtn: null };
    let isLooping = false;

    const placeholders = ["Camille","Lucas","Zoé","Arthur","Élise","Léa","Hugo","Théo","Oscar","Chloé","Jeanne d'Arc","Napoléon","Marie Curie","Louis XIV"];

    // ===== Error UI =====
    function showErrorModal(message){
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-modal').classList.remove('hidden');
    }
    async function logError(error, functionName, context){
      try{
        await fetch('/.netlify/functions/log-error',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            studentName:studentName||"Non défini",
            error:{message:error?.message||String(error), stack:error?.stack||null},
            functionName, context, pageUrl:window.location.href
          })
        });
      }catch(e){ console.error('log-error fail', e); }
    }

    // ===== Audio helpers =====
    function base64ToBlob(base64, mime='audio/mp3'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    function cleanupAudio(){
      if(currentAudio){ currentAudio.pause(); currentAudio.src=""; currentAudio=null; }
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
    }

    function updatePlayButtonUI(isPlaying){
      const btn = currentAudioUI.playBtn;
      if(!btn) return;
      if(isPlaying){
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause (일시정지)';
        btn.classList.remove('bg-emerald-600');
        btn.classList.add('bg-emerald-700');
      }else{
        btn.innerHTML = '<i class="fas fa-play"></i> Écouter (듣기)';
        btn.classList.remove('bg-emerald-700');
        btn.classList.add('bg-emerald-600');
      }
    }
    function updateLoopButtonUI(){
      const btn = currentAudioUI.loopBtn;
      if(!btn) return;
      if(isLooping){
        btn.innerHTML = '<i class="fas fa-redo"></i> Répéter On';
        btn.classList.add('bg-yellow-200');
      }else{
        btn.innerHTML = '<i class="fas fa-redo"></i> Répéter Off';
        btn.classList.remove('bg-yellow-200');
      }
    }

    // ===== 쉬운 불어+한글 개념 힌트 =====
    function buildConceptHint(forWhat){
      const lines = {
        age: [
          "👶 Âge → nombres natifs (한/두/세 살).",
          "Pourquoi/이유: on compte une personne → 고유한국어 수"
        ],
        people: [
          "🧑‍🤝‍🧑 Personnes → natifs (… 명/분).",
          "Pourquoi/이유: nombre de gens qu’on voit → 고유한국어 수"
        ],
        objects: [
          "📦 Objets → natifs (… 개/권/장…).",
          "Pourquoi/이유: on compte des choses visibles → 고유한국어 수"
        ],
        date: [
          "📅 Dates (…일) → sino-coréen (일/이/삼…).",
          "Pourquoi/이유: c’est un nom écrit sur le calendrier → 한자어"
        ],
        money: [
          "💶 Prix/Argent → sino-coréen (십 유로, 오천 원…).",
          "Pourquoi/이유: unités fixées (유로/원) → 한자어"
        ],
        minutes: [
          "⏱️ Minutes(분) → sino-coréen.",
          "Pourquoi/이유: ‘분’ est un nom d’unité écrit → 한자어"
        ],
        hours: [
          "🕒 Heures(시) → natifs (한/두/세 시…).",
          "Mémo/메모: 옛 단위 영향 → 지금은 시=고유, 분=한자"
        ],
        time_history: [
          "🕰️ Histoire courte / 간단 역사",
          "Avant: ‘각’ ≈ 15 min. Maintenant: 1 h = 60 min.",
          "→ Aujourd’hui: 시(natif) / 분(sino-coréen)"
        ]
      };
      return lines[forWhat].concat(lines.time_history || []).join("\n");
    }

    function showGeneralHint(){
      const q = questions[currentQuestionIndex];
      const d = document.getElementById('hint-display');
      q.hint1Count++;
      let msg = "";
      const text = (q.context || q.fr || q.ko || "").toString();

      if (text.includes("살") || /Âge|age/i.test(text))       msg = buildConceptHint("age");
      else if (text.includes("명") || /Personnes/i.test(text)) msg = buildConceptHint("people");
      else if (text.includes("권") || text.includes("개") || /Objets|livres|책/i.test(text)) msg = buildConceptHint("objects");
      else if (text.includes("일") || /Date|septembre|월/i.test(text))  msg = buildConceptHint("date");
      else if (/유로|원|Prix|Argent/i.test(text))               msg = buildConceptHint("money");
      else if (text.includes("분") || /Minutes/i.test(text))    msg = buildConceptHint("minutes");
      else if (text.includes("시") || /Heures/i.test(text))     msg = buildConceptHint("hours");
      else msg = "ℹ️ Deux systèmes / 두 가지 숫자 체계:\n- Compter des choses → natifs\n- Noms/Unités écrits (date, prix, numéro…) → sino-coréen\n(Temps/시간: 시=고유, 분=한자)";

      d.textContent = msg;
      d.classList.remove('hidden');
    }

    function showHint(type){
      const q=questions[currentQuestionIndex], d=document.getElementById('hint-display');
      if(type===1){ q.hint1Count++; d.textContent=`Indice 1: ${q.hint1}`; }
      else if(type===2){ q.hint2Count++; d.textContent=`Indice 2: ${q.hint2}`; }
      else {
        q.hint2Count++;
        let extra = "";
        if (q.ko.includes("시")) extra += "\n" + buildConceptHint("hours");
        if (q.ko.includes("분")) extra += "\n" + buildConceptHint("minutes");
        if (q.ko.includes("원") || q.ko.includes("유로")) extra += "\n" + buildConceptHint("money");
        if (q.ko.includes("살")) extra += "\n" + buildConceptHint("age");
        if (q.ko.includes("명")) extra += "\n" + buildConceptHint("people");
        d.textContent = (q.conceptualHint || "Pourquoi ce nombre ? / 왜 이 숫자?") + (extra ? "\n\n" + extra : "");
      }
      d.classList.remove('hidden');
    }

    // ===== 제공자별 음성 매핑 =====
    const VOICE_MAP = {
      openai: { default: "alloy", alloy: "alloy", shimmer: "verse", nova: "alloy", echo: "alloy", fable: "verse" },
      google: { default: "ko-KR-Standard-A", alloy: "ko-KR-Standard-A", shimmer: "ko-KR-Standard-B", nova: "ko-KR-Standard-C", echo: "ko-KR-Standard-D", fable: "ko-KR-Neural2-A" }
    };
    function mapVoice(provider, reqName){
      const table = VOICE_MAP[provider] || {};
      return table[reqName] || table.default || reqName || "ko-KR-Standard-A";
    }

    // ===== TTS: Play/Pause 토글 & 오류 폴백 =====
    async function playAudio(text, voice='alloy', opts = {}){
      if (audioClickLocked || isPlayingOrFetching) {
        if (currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice){
          try{
            if (!currentAudio.paused) { currentAudio.pause(); updatePlayButtonUI(false); }
            else { await currentAudio.play(); updatePlayButtonUI(true); }
          }catch(_){/* ignore */}
        }
        return;
      }
      audioClickLocked = true; setTimeout(()=>audioClickLocked=false, 220);

      try{
        if (currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice && currentAudio.src){
          if(!currentAudio.paused){ currentAudio.pause(); updatePlayButtonUI(false); }
          else { await currentAudio.play(); updatePlayButtonUI(true); }
          return;
        }

        isPlayingOrFetching = true;
        if(questions.length>0 && questions[currentQuestionIndex]){ questions[currentQuestionIndex].listenCount++; }

        if(currentFetchAbort){ try{ currentFetchAbort.abort(); }catch(_){} }
        if(currentAudio){ try{ currentAudio.pause(); }catch(_){} }

        const ac = new AbortController();
        currentFetchAbort = ac;

        const configured = (window.PONGDANG_TTS && window.PONGDANG_TTS.provider) || 'openai';
        const primary   = opts.provider || configured;
        const secondary = (primary === 'openai') ? 'google' : 'openai';

        const basePayload = { text, voice, provider: primary, speed:(opts.speed ?? opts.speakingRate), speakingRate:opts.speakingRate };

        const tryFetch = async (prov) => {
          const payload = { ...basePayload, provider: prov, voice: mapVoice(prov, voice) };
          const res = await fetch('/.netlify/functions/generate-audio',{
            method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
            body:JSON.stringify(payload), signal: ac.signal
          });
          if(!res.ok){
            const msg = `generate-audio ${prov}: ${res.status}`;
            if (res.status===402 || res.status===429 || (res.status>=500 && res.status<=599)) throw new Error('RETRY:'+msg);
            throw new Error(msg);
          }
          const data = await res.json().catch(()=>{ throw new Error('Invalid JSON from TTS'); });
          return data;
        };

        let data;
        try { data = await tryFetch(primary); }
        catch(e){ if(String(e.message).startsWith('RETRY:')) data = await tryFetch(secondary); else throw e; }
        if(ac.signal.aborted || !data) return;

        let srcUrl = null;
        if(data.audioBase64 || data.audioContent){
          const b64 = data.audioBase64 || data.audioContent;
          const blob = base64ToBlob(b64, data.mimeType||'audio/mpeg');
          srcUrl = URL.createObjectURL(blob); currentBlobUrl = srcUrl;
        }else if(data.audioUrl){ srcUrl = data.audioUrl; }
        else { throw new Error('Invalid TTS response: missing audio'); }

        const audio = new Audio(srcUrl);
        currentAudio = audio;
        currentAudioMeta = { text, voice };
        audio.loop = isLooping;

        let endedNaturally = false;
        const canPlay = new Promise(resolve=>{
          const ready = () => { audio.removeEventListener('canplaythrough', ready); resolve(); };
          audio.addEventListener('canplaythrough', ready, { once:true });
          setTimeout(resolve, 380);
        });

        audio.addEventListener('playing', ()=> updatePlayButtonUI(true));
        audio.addEventListener('pause',   ()=> updatePlayButtonUI(false));
        audio.addEventListener('ended',   ()=> { endedNaturally = true; updatePlayButtonUI(false); cleanupAudio(); });
        audio.addEventListener('error',   ()=> { if(endedNaturally) return; showErrorModal('Problème de lecture audio. Réessaie ! / 오디오 재생에 문제가 있어요. 다시 시도해 주세요.'); });

        await canPlay;
        try{ await audio.play(); }
        catch(err){ await tinyDelay(150); try{ await audio.play(); }catch(_){ showErrorModal('Problème de lecture audio. Réessaie ! / 오디오 재생에 문제가 있어요. 다시 시도해 주세요.'); }}
      }catch(error){
        if (error?.name !== 'AbortError'){
          console.error('playAudio error', error);
          logError(error,'playAudio',{text,voice,opts});
          showErrorModal('Audio: petit souci. Réessaie dans un instant. / 오디오 생성·재생 중 오류가 발생했어요. 잠시 후 다시 시도해 주세요.');
        }
      }finally{ isPlayingOrFetching = false; }
    }

    // ===== 받아쓰기용 녹음 =====
    function setupRecording(){
      const recordBtn=document.getElementById('record-btn'),
            indicator=document.getElementById('recording-indicator'),
            playback=document.getElementById('audio-playback');

      recordBtn.onclick = async () => {
        if(mediaRecorder && mediaRecorder.state==="recording"){
          mediaRecorder.stop();
          recordBtn.innerHTML='<i class="fas fa-microphone"></i> Démarrer';
          indicator.classList.add('hidden');
          recordBtn.classList.remove('bg-red-500','hover:bg-red-600');
        }else{
          try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
            mediaRecorder.onstop=()=>{
              const blob=new Blob(audioChunks,{type:'audio/webm'});
              const url=URL.createObjectURL(blob);
              playback.src=url; playback.classList.remove('hidden');

              const temp=new Audio(url);
              temp.addEventListener('loadedmetadata',()=>{
                const duration=temp.duration;
                const reader=new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend=()=>{ questions[currentQuestionIndex].recording={ base64:reader.result, filename:`rec_q${questions[currentQuestionIndex].number}.webm`, mimeType:'audio/webm', duration }; };
              });
              stream.getTracks().forEach(t=>t.stop());
            };
            mediaRecorder.start();
            recordBtn.innerHTML='<i class="fas fa-stop"></i> Arrêter';
            indicator.style.display='flex';
            recordBtn.classList.add('bg-red-500','hover:bg-red-600');
          }catch(err){
            logError(err,'setupRecording'); showErrorModal("Micro bloqué. Active le micro dans ton navigateur. / 마이크 접근이 거부되었어요. 브라우저 설정을 확인해 주세요.");
          }
        }
      };
    }

    // ===== Flow =====
    function startQuiz(){
      studentName=document.getElementById('student-name').value.trim();
      if(!studentName){ showErrorModal("Entre ton nom, s'il te plaît. / 이름을 입력해 주세요."); return; }
      const start = document.getElementById('start-screen');
      const explain = document.getElementById('explanation-screen');
      if(!start || !explain){ console.error('[startQuiz] Missing screens'); return; }
      start.classList.add('hidden');
      explain.classList.remove('hidden');
      const next = document.getElementById('explanation-next-btn');
      if(next){ try{ next.focus({ preventScroll:true }); }catch(_){} }
      try{ window.scrollTo({ top:0, behavior:'smooth' }); }catch(_){ }
    }
    function showWarmupScreen(){
      document.getElementById('explanation-screen').classList.add('hidden');
      document.getElementById('warmup-screen').classList.remove('hidden');
    }
    function startRealQuiz(){
      startTime=new Date(); questions=getQuestions(); currentQuestionIndex=0;
      document.getElementById('warmup-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      renderQuestion(); updateProgressBar();
    }
    function nextQuestion(){
      if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} }
      if(currentQuestionIndex<questions.length-1){ currentQuestionIndex++; renderQuestion(); updateProgressBar(); }
    }
    function prevQuestion(){
      if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} }
      if(currentQuestionIndex>0){ currentQuestionIndex--; renderQuestion(); updateProgressBar(); }
    }

    function checkAnswers(){
      questions.forEach(q=>{
        if(q.type==='choice') q.isCorrect = q.userAnswer===q.answer;
        else if(q.type==='fill') q.isCorrect = (q.userAnswer||'').trim()===q.ko;
        else if(q.type==='translate') q.isCorrect = (q.userAnswer||'').trim().replace(/\s/g,'').replace(/[.,!?]/g,"")===q.ko.replace(/\s/g,'').replace(/[.,!?]/g,"");
        else if(q.type==='dictation') q.isCorrect = (q.userAnswer.ko||'').trim().replace(/\s/g,'')===q.ko.replace(/\s/g,'');
      });
    }
    function getFeedback(score){
      if(score>=90) return {fr:"Excellent travail ! 🌟",ko:"완벽해요! 너무 잘했어요 😊",className:"text-green-600"};
      if(score>=70) return {fr:"Très bien ! Continuez 💪",ko:"아주 좋아요! 계속해요!",className:"text-emerald-600"};
      if(score>=50) return {fr:"Pas mal ! On révise encore 👍",ko:"나쁘지 않아요! 조금만 더!",className:"text-yellow-600"};
      return {fr:"Courage ! On va y arriver 👊",ko:"괜찮아요! 같이 다시 해봐요!",className:"text-orange-600"};
    }
    function showResults(){
      if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} }
      cleanupAudio();
      checkAnswers(); sendResults();

      const correct=questions.filter(q=>q.isCorrect).length;
      const score=Math.round((correct/questions.length)*100);
      const time=Math.round((new Date()-startTime)/1000);
      document.getElementById('final-score').textContent=`${score}% (${correct}/${questions.length})`;
      document.getElementById('total-time').textContent=`${time}`;
      const fb=getFeedback(score);
      const fbDiv=document.getElementById('result-feedback');
      fbDiv.innerHTML=`${fb.fr}<br>${fb.ko}`; fbDiv.className=`text-2xl font-semibold mb-6 ${fb.className}`;

      const review=document.getElementById('review-content'); review.innerHTML='';
      questions.forEach(q=>{
        const icon=q.isCorrect?'\u003ci class="fas fa-check-circle text-green-500"\u003e\u003c/i\u003e':'\u003ci class="fas fa-times-circle text-red-500"\u003e\u003c/i\u003e';
        let html=`<div class="p-4 border rounded-lg ${q.isCorrect?'bg-green-50':'bg-red-50'}"><p class="font-bold text-lg">${icon} Q${q.number} (${q.type})</p>`;
        let uAns='', cAns='';
        if(q.type==='choice'){ html+=`<p><strong>Q:</strong> ${q.context}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.answer; }
        else if(q.type==='fill'){ html+=`<p><strong>Q:</strong> ${q.fr.replace('___', `<strong>${q.userAnswer||'...'}</strong>`)}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.ko; }
        else if(q.type==='translate'){ html+=`<p><strong>À traduire:</strong> ${q.fr}</p>`; uAns=q.userAnswer||"N/A"; cAns=q.ko; }
        else if(q.type==='dictation'){ html+=`<p><strong>À écouter:</strong> ${q.ko}</p>`; uAns=`<strong>KR:</strong> ${q.userAnswer.ko||'vide'}<br><strong>FR:</strong> ${q.userAnswer.fr||'vide'}`; cAns=`<strong>KR:</strong> ${q.ko}<br><strong>FR:</strong> ${q.fr}`; }
        html += q.isCorrect ? `<p><strong>Réponse:</strong> ${uAns||cAns}</p>` : `<p><strong>Votre réponse:</strong> <span class="text-red-700">${uAns}</span></p><p><strong>Réponse correcte:</strong> <span class="text-green-700">${cAns}</span></p>`;
        review.insertAdjacentHTML('beforeend', html + '</div>');
      });

      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
    }
    function restartQuiz(){
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }

    // ===== Events =====
    document.getElementById('start-btn').addEventListener('click', startQuiz);
    document.getElementById('explanation-next-btn').addEventListener('click', showWarmupScreen);
    document.getElementById('start-quiz-btn').addEventListener('click', startRealQuiz);
    document.getElementById('next-btn').addEventListener('click', nextQuestion);
    document.getElementById('prev-btn').addEventListener('click', prevQuestion);
    document.getElementById('finish-btn').addEventListener('click', showResults);
    document.getElementById('restart-btn').addEventListener('click', restartQuiz);
    document.getElementById('print-btn').addEventListener('click', ()=>window.print());
    document.getElementById('close-error-modal-btn').addEventListener('click', ()=>document.getElementById('error-modal').classList.add('hidden'));

    document.addEventListener('DOMContentLoaded', ()=>{
      const nameInput=document.getElementById('student-name');
      nameInput.placeholder=`Ex: ${placeholders[Math.floor(Math.random()*placeholders.length)]}`;
    });
  </script>
</body>
</html>
