<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice CorÃ©en : Les Nombres â€“ ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanjaâ€‘corÃ©ens (v2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .quiz-container{max-width:800px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .progress-bar{width:100%;height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden}
    .progress-bar-inner{height:100%;background:#3b82f6;transition:width .3s ease-in-out}
    .question-title{font-size:1.5rem;font-weight:700;color:#1f2937;margin-bottom:.25rem}
    .question-text{font-size:1.05rem;color:#4b5563;margin-bottom:1.25rem;line-height:1.6}
    .btn{padding:.75rem 1.5rem;border-radius:.5rem;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff;font-size:1.05rem}.btn-sound:hover{background:#059669}
    .choice-btn{display:block;width:100%;text-align:left;padding:1rem;margin-bottom:.75rem;background:#fff;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem;transition:all .2s}
    .choice-btn:hover{background:#eff6ff;border-color:#3b82f6}
    .choice-btn.selected{background:#bfdbfe;border-color:#3b82f6;font-weight:600}
    .input-field{width:100%;padding:.75rem 1rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1.1rem}
    .hidden{display:none}.disabled{opacity:.5;cursor:not-allowed}
    .recording-dot{width:12px;height:12px;background:red;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
  </style>
</head>
<body class="bg-gray-50">

  <!-- ìƒë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="absolute top-4 left-4 text-sm text-gray-400">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ì‹œì‘ í™”ë©´ -->
  <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
    <h1 class="text-4xl font-bold text-slate-800 mb-2">Exercice : Les Nombres CorÃ©ens ğŸ”¢</h1>
    <p class="text-lg text-slate-600 mb-6">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanjaâ€‘corÃ©ens</p>
    <div class="w-full max-w-sm">
      <input id="student-name" class="w-full p-3 text-center border-2 border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Quel est ton nom ? (ì´ë¦„ì´ ë­ì˜ˆìš”?)">
      <button id="start-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Commencer ! (ì‹œì‘!)</button>
    </div>
  </div>

  <!-- ì„¤ëª… (ì •í™• í…ìŠ¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸) -->
  <div id="explanation-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">ğŸ“˜ Apprendre les nombres corÃ©ens ! / í•œêµ­ì–´ ìˆ«ì ë°°ìš°ê¸°!</h2>
    <p class="text-center text-slate-600 mb-8">(Ft. í•œì(Hanja = Ã©criture) vs chinois (la langue) ?!)</p>

    <div class="space-y-6 text-slate-700">
      <!-- 1) Petite explication -->
      <div>
        <h3 class="font-bold text-xl mb-3">1ï¸âƒ£ Petite explication / ê°„ë‹¨ ì„¤ëª…</h3>
        <p class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">ğŸ‘‰ Beaucoup de FranÃ§ais pensent que Â« í•œì = chinois Â». Mais non ! / ë§ì€ í”„ë‘ìŠ¤ì¸ì´ â€˜í•œì = ì¤‘êµ­ì–´(ì–¸ì–´)â€™ë¼ê³  ìƒê°í•˜ì§€ë§Œ ì•„ë‹™ë‹ˆë‹¤!</p>
        <ul class="list-disc list-inside mt-3 space-y-2">
          <li><strong>í•œì (Hanja)</strong> = systÃ¨me dâ€™Ã©criture / ê¸€ì(ë¬¸ì) ì²´ê³„</li>
          <li><strong>Chinois</strong> = langue / ì¤‘êµ­ì–´(ì–¸ì–´)</li>
        </ul>
        <div class="mt-3 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700">
          <p>
            <strong>Astuce (analogie) / ë¹„ìœ </strong> : En Europe, on Ã©crit avec <b>l'alphabet latin</b> (pas Â« alphabet italien Â»).<br>
            â†’ <b>Italien</b> = une <u>langue</u> / <b>lettres</b> = alphabet <u>latin</u>.<br>
            â†’ <b>chinois</b> = une <u>langue</u> / <b>lettres</b> = <u>caractÃ¨res han (Hanja)</u>.<br>
            ğŸ‡°ğŸ‡· <b>Le corÃ©en aussi</b> : <b>langue</b> = corÃ©en / <b>nombres</b> = <u>2 jeux</u> (ìˆœìˆ˜ í•œêµ­ì–´ / natifs, í•œìì–´ / Hanjaâ€‘corÃ©ens).<br>
            <em>Hanja â‰  chinois (la langue)</em> â†’ Â« <b>caractÃ¨res han</b> Â» = Ã©criture, pas la langue chinoise.
          </p>
        </div>
      </div>

      <!-- 2) Deux systÃ¨mes -->
      <div>
        <p class="mb-4">En corÃ©en, on utilise <strong>deux systÃ¨mes</strong> de nombres / í•œêµ­ì–´ì—ëŠ” ìˆ«ì ì²´ê³„ê°€ <strong>ë‘ ê°€ì§€</strong> ìˆì–´ìš”:</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h4 class="font-bold text-lg text-blue-800">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</h4>
            <p class="text-2xl font-bold my-2">í•˜ë‚˜, ë‘˜, ì…‹â€¦</p>
            <p><strong>Pour / ìš©ë„:</strong> compter des choses quâ€™on voit (Ã¢ge, personnes, objetsâ€¦) / ëˆˆì•ì—ì„œ ì„¸ëŠ” ê²ƒ(ë‚˜ì´, ì‚¬ëŒ ìˆ˜, ë¬¼ê±´ ê°œìˆ˜â€¦)</p>
          </div>
          <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 class="font-bold text-lg text-green-800">í•œìì–´ / Hanjaâ€‘corÃ©ens</h4>
            <p class="text-2xl font-bold my-2">ì¼, ì´, ì‚¼â€¦</p>
            <p><strong>Pour / ìš©ë„:</strong> noms/unitÃ©s dÃ©jÃ  <u>Ã©crits</u> (dates, argent, minutesâ€¦) / ì´ë¯¸ ì í˜€ ìˆëŠ” ì´ë¦„Â·ë‹¨ìœ„(ë‚ ì§œ, ëˆ, ë¶„ ë“±)</p>
          </div>
        </div>
      </div>

      <!-- 3) Exception & Tendance -->
      <div>
        <h3 class="font-bold text-xl mb-3">âš¡ Exception & Tendance / ì˜ˆì™¸ì™€ ê²½í–¥</h3>
        <ul class="list-disc list-inside space-y-2">
          <li>Heures(ì‹œ) â†’ <b>ìˆœìˆ˜ í•œêµ­ì–´ / natifs</b> Â· Minutes(ë¶„) â†’ <b>í•œìì–´ / Hanjaâ€‘corÃ©ens</b></li>
          <li>
            Pourquoi ? Autrefois, on utilisait des unitÃ©s comme Â« 1ê° â‰ˆ 15 min Â». Puis, Ã  lâ€™Ã©poque moderne, le systÃ¨me
            <b>1 h = 60 min</b> sâ€™est imposÃ©. â‡’ Aujourdâ€™hui : <b>ì‹œ (heures) = natifs</b> Â· <b>ë¶„ (minutes) = Hanja-corÃ©ens</b>.
            â‡’ <i>Tendance moderne</i> : les nouveaux mots se forment plutÃ´t en <b>corÃ©en natif</b> (pas en caractÃ¨res han).
          </li>
        </ul>
      </div>

    <!-- 4) RÃ©sumÃ© -->
<div>
  <h3 class="font-bold text-xl mb-3">âœ… RÃ©sumÃ© facile / ìš”ì•½</h3>
  <div class="overflow-x-auto">
    <table class="w-full text-left border-collapse text-sm">
      <thead>
        <tr class="bg-gray-100 text-gray-800">
          <th class="p-3 border border-slate-200">SystÃ¨me / ì²´ê³„</th>
          <th class="p-3 border border-slate-200">Usage / ìš©ë„</th>
          <th class="p-3 border border-slate-200">Exemples / ì˜ˆ</th>
        </tr>
      </thead>
      <tbody>
        <!-- Natifs -->
        <tr class="odd:bg-white even:bg-gray-50">
          <td class="p-3 border border-slate-200 font-semibold">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</td>
          <td class="p-3 border border-slate-200">
            Compter (valeur libre), classificateurs, durÃ©es libres<br>
          </td>
          <td class="p-3 border border-slate-200">
            <span class="font-medium">DurÃ©e (mois)</span> : <b>í•œ ë‹¬, ë‘ ë‹¬</b><br>
            <span class="font-medium">Classificateurs</span> : <b>í•œ ê°œ, ë‘ ëª…, ì„¸ ì”, í•œ ê¶Œ</b><br>
            <span class="font-medium">Heures (ì‹œ)</span> : <b>í•œ ì‹œ, ë‘ ì‹œ</b>
          </td>
        </tr>
        <!-- Hanja-corÃ©ens -->
        <tr class="odd:bg-white even:bg-gray-50">
          <td class="p-3 border border-slate-200 font-semibold">í•œìì–´ / Hanja-corÃ©ens</td>
          <td class="p-3 border border-slate-200">
            LibellÃ©s/valeurs Â« dÃ©jÃ  Ã©crits Â» (calendrier, montre, monnaie, numÃ©ros)<br>
          </td>
          <td class="p-3 border border-slate-200">
            <span class="font-medium">Mois du calendrier</span> : <b>1ì›”, 2ì›”, 3ì›”</b><br>
            <span class="font-medium">Minutes/Secondes</span> : <b>10ë¶„, 30ì´ˆ</b><br>
            <span class="font-medium">Dates/Argent</span> : <b>2025ë…„ 9ì›” 7ì¼, 1,000ì›</b><br>
            <span class="font-medium">NumÃ©ros d'un appartement</span> : <b>3ì¸µ, 302í˜¸</b>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Notes courtes / ê°ì£¼ -->
  <ul class="mt-2 text-xs text-gray-600 list-disc list-inside leading-relaxed">
    <li><b>Temps</b> : <b>ì‹œ(heures)</b> â†’ natifs / <b>ë¶„Â·ì´ˆ(minutes/secondes)</b> â†’ Hanja.</li>
    <li><b>MÃ©langes</b> : on peut utiliser l'un des deux pour certains mots comme <b>ë‹¬/ê°œì›”(les mois comme durÃ©e)</b>, <b>ì£¼/ì£¼ì¼(les semaines)</b>.</li>
  </ul>
</div>

</div>
    <div class="mt-8 text-center">
      <button id="explanation-next-btn" class="btn btn-primary text-lg">C'est compris, on s'Ã©chauffe ! (ì›Œë°ì—…) <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- ì›Œë°ì—… -->
  <div id="warmup-screen" class="quiz-container hidden">
    <h2 class="text-3xl font-bold text-slate-800 mb-2 text-center">MÃ©thode 5 par 5 ğŸ—£ï¸ / 5ê°œì”© í›ˆë ¨ë²•</h2>
    <p class="text-lg text-slate-600 mb-8 text-center">Ã‰couter & RÃ©pÃ©ter plusieurs fois! / ì—¬ëŸ¬ ë²ˆ ë“£ê³  ë”°ë¼í•´ìš”!</p>

    <div class="space-y-4">
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs (1â€“5) : <span class="font-normal text-gray-500">í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯</span></p>
        <button class="btn btn-sound" onclick="onPlayPause('í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯','alloy',{ speed:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs (6â€“10) : <span class="font-normal text-gray-500">ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´</span></p>
        <button class="btn btn-sound" onclick="onPlayPause('ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´','shimmer',{ speed:0.92 })"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">í•œìì–´ / Hanjaâ€‘corÃ©en (1â€“5) : <span class="font-normal text-gray-500">ì¼, ì´, ì‚¼, ì‚¬, ì˜¤</span></p>
        <button class="btn btn-sound" onclick="onPlayPause('ì¼, ì´, ì‚¼, ì‚¬, ì˜¤','alloy')"><i class="fas fa-play"></i></button>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
        <p class="font-semibold text-lg text-slate-700">í•œìì–´ / Hanjaâ€‘corÃ©en (6â€“10) : <span class="font-normal text-gray-500">ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­</span></p>
        <button class="btn btn-sound" onclick="onPlayPause('ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­','alloy')"><i class="fas fa-play"></i></button>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="start-quiz-btn" class="btn btn-primary text-lg">Commencer l'exercice ! (ì—°ìŠµë¬¸ì œ ì‹œì‘!) <i class="fas fa-arrow-right"></i></button>
    </div>
  </div>

  <!-- ë³¸ í€´ì¦ˆ -->
  <div id="quiz-screen" class="quiz-container hidden">
    <div class="flex justify-between items-center mb-4">
      <span id="progress-text" class="text-sm font-semibold text-gray-600"></span>
      <button id="print-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-print"></i> Imprimer / í”„ë¦°íŠ¸</button>
    </div>
    <div class="progress-bar mb-6"><div id="progress-bar-inner" class="progress-bar-inner"></div></div>

    <!-- MÃ©thode 5Ã—5 : í•­ìƒ ë³´ì´ê¸° (Q6â€“20) -->
    <div id="sticky-55" class="sticky top-0 z-30 -mx-4 sm:-mx-6 -mt-2 mb-4 hidden">
      <div class="p-3 rounded-lg bg-white/90 backdrop-blur border border-slate-200 shadow-sm flex flex-wrap gap-2 items-center justify-between">
        <span class="text-sm font-semibold text-slate-700">MÃ©thode 5Ã—5 (í•„ìš”í•  ë•Œ ì–¸ì œë“  ë“£ê¸°)</span>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-sound" onclick="playAudio('í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯','alloy',{ speed:0.92 })"><i class="fas fa-play"></i> 1â€“5 natifs</button>
          <button class="btn btn-sound" onclick="playAudio('ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´','shimmer',{ speed:0.92 })"><i class="fas fa-play"></i> 6â€“10 natifs</button>
          <button class="btn btn-sound" onclick="playAudio('ì¼, ì´, ì‚¼, ì‚¬, ì˜¤','alloy')"><i class="fas fa-play"></i> 1â€“5 Hanja</button>
          <button class="btn btn-sound" onclick="playAudio('ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­','alloy')"><i class="fas fa-play"></i> 6â€“10 Hanja</button>
        </div>
      </div>
    </div>

    <div id="question-area"></div>
    <div id="navigation-btns" class="mt-8 flex justify-between items-center">
      <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> PrÃ©cÃ©dent (ì´ì „)</button>
      <button id="next-btn" class="btn btn-primary">Suivant (ë‹¤ìŒ) <i class="fas fa-arrow-right"></i></button>
      <button id="finish-btn" class="btn btn-primary hidden">Terminer ! (ëë‚´ê¸°!)</button>
    </div>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result-screen" class="quiz-container hidden text-center">
    <h2 class="text-3xl font-bold text-slate-800 mb-4">RÃ©sultats du test / ê²°ê³¼</h2>
    <div id="result-feedback" class="text-2xl font-semibold mb-6"></div>
    <p class="text-slate-600 mb-2">Score final : <span id="final-score" class="font-bold"></span></p>
    <p class="text-slate-600 mb-6">Temps total : <span id="total-time" class="font-bold"></span> secondes</p>
    <div id="review-section" class="">
      <h3 class="text-xl font-bold text-slate-700 mt-8 mb-4">RÃ©vision des questions / ì˜¤ë‹µë…¸íŠ¸</h3>
      <div id="review-content" class="text-left space-y-4"></div>
    </div>
    <div class="mt-8 flex justify-center gap-4">
      <button id="restart-btn" class="btn btn-primary"><i class="fas fa-redo"></i> Recommencer (ë‹¤ì‹œí•˜ê¸°)</button>
      <a href="../index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Retour aux exercices (ì—°ìŠµë¬¸ì œë¡œ ëŒì•„ê°€ê¸°)</a>
    </div>
  </div>

  <!-- í•˜ë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="absolute bottom-4 right-4 text-sm text-gray-400">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ì˜¤ë¥˜ ëª¨ë‹¬ -->
  <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 class="text-xl font-bold text-red-600 mb-2">Oops ! Une erreur est survenue. / ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.</h3>
      <p id="error-message" class="text-gray-700 mb-4"></p>
      <button id="close-error-modal-btn" class="btn btn-primary w-full mt-4">J'ai compris (í™•ì¸)</button>
    </div>
  </div>

  <!-- ê¸°ë³¸ TTS/Functions ì„¤ì • -->
  <script>
    window.PONGDANG_TTS = window.PONGDANG_TTS || { provider: 'openai' };
    // âœ… ë°°í¬ í™˜ê²½ì— ë”°ë¼ ì¡°ì • (ì˜ˆ: Vercelì´ë©´ '/api')
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
    // âœ… ê²°ê³¼ ì „ì†¡ ì‹œ ë…¹ìŒ(base64) í¬í•¨ ì—¬ë¶€ (ëŒ€ìš©ëŸ‰ ì˜¤ë¥˜ ë°©ì§€ìš©). í•„ìš” ì‹œ trueë¡œ.
    window.PONGDANG_SEND_AUDIO = (typeof window.PONGDANG_SEND_AUDIO === 'boolean') ? window.PONGDANG_SEND_AUDIO : false;
  </script>
  <script src="../assets/grading-criteria.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    // ===== Global =====
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    let studentName = "";
    let currentQuestionIndex = 0;
    let questions = [];
    let startTime, endTime;
    let mediaRecorder, audioChunks = [];
    let currentAudio = null, currentBlobUrl = null;
    let currentFetchAbort = null;      // ìµœì‹  ìš”ì²­ë§Œ ìœ íš¨
    let audioClickLocked = false;      // ë”ë¸”í´ë¦­ ë°©ì§€
    let isPlayingOrFetching = false;   // ë™ì‹œ ìš”ì²­/ì¬ìƒ ë³´í˜¸
    function tinyDelay(ms){ return new Promise(r=>setTimeout(r, ms)); }

    let currentAudioMeta = { text: null, voice: null };
    let currentAudioUI   = { playBtn: null, loopBtn: null };
    let isLooping = false;

    const placeholders = ["Camille","Lucas","ZoÃ©","Arthur","Ã‰lise","LÃ©a","Hugo","ThÃ©o","Oscar","ChloÃ©","Jeanne d'Arc","NapolÃ©on","Marie Curie","Louis XIV"];

    // ===== Error UI =====
    function showErrorModal(message){
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-modal').classList.remove('hidden');
    }
    async function logError(error, functionName, context){
      try{
        await fetch(`${FN_BASE}/log-error`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ studentName:studentName||"Non dÃ©fini", error:{message:error?.message||String(error), stack:error?.stack||null}, functionName, context, pageUrl:window.location.href })
        });
      }catch(e){ console.error('log-error fail', e); }
    }

    // ===== Audio helpers =====
    function base64ToBlob(base64, mime='audio/mp3'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    function cleanupAudio(){
      if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } currentAudio=null; }
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
    }


    function updatePlayButtonUI(isPlaying){
      const btn = currentAudioUI.playBtn;
      if(!btn) return;
      if(isPlaying){
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause (ì¼ì‹œì •ì§€)';
        btn.classList.remove('bg-emerald-600');
        btn.classList.add('bg-emerald-700');
      }else{
        btn.innerHTML = '<i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)';
        btn.classList.remove('bg-emerald-700');
        btn.classList.add('bg-emerald-600');
      }
    }
    function updateLoopButtonUI(){
      const btn = currentAudioUI.loopBtn;
      if(!btn) return;
      if(isLooping){
        btn.innerHTML = '<i class="fas fa-redo"></i> RÃ©pÃ©ter On (ë°˜ë³µ ì¼œì§)';
        btn.classList.add('bg-yellow-200');
      }else{
        btn.innerHTML = '<i class="fas fa-redo"></i> RÃ©pÃ©ter Off (ë°˜ë³µ êº¼ì§)';
        btn.classList.remove('bg-yellow-200');
      }
    }


      // ===== ì•ˆì „ ë¬¸ìì—´ ìœ í‹¸ =====
      function safeAttr(s){
        return String(s||"")
          .replace(/\\/g, "\\\\")
          .replace(/'/g, "&#39;")
          .replace(/"/g, "&quot;")
          .replace(/\n/g, " ");
      }

    /* ===== ì‰¬ìš´ ë¶ˆì–´+í•œê¸€ ê°œë… íŒíŠ¸ ===== */
    function buildConceptHint(forWhat){
      const lines = {
        age: ["ğŸ‘¶ Ã‚ge â†’ nombres natifs corÃ©ens (í•œ/ë‘/ì„¸ ì‚´).","Pourquoi : on compte des choses rÃ©elles â†’ systÃ¨me natif."],
        people: ["ğŸ§‘â€ğŸ¤â€ğŸ§‘ Personnes â†’ natifs corÃ©ens (â€¦ ëª…/ë¶„).","On compte des personnes devant soi (ëˆˆì•ì˜ ì‚¬ëŒ ìˆ˜ ì„¸ê¸°)."],
        objects: ["ğŸ“¦ Objets â†’ natifs corÃ©ens (â€¦ ê°œ/ê¶Œ/ì¥â€¦).","On compte le nombre d'objets visibles (ëˆˆì•ì˜ ì‚¬ë¬¼ ê°œìˆ˜)."],
        date: ["ğŸ“… Dates (â€¦ì¼) â†’ Hanja-corÃ©en.","Ce sont des noms/unitÃ©s Ã©crits sur le calendrier."],
        money: ["ğŸ’¶ Prix/Argent â†’ Hanja-corÃ©en (ì‹­ ìœ ë¡œ, ì˜¤ì²œ ì›â€¦).","UnitÃ©s fixes et montants affichÃ©s."],
        minutes: ["â±ï¸ Minutes(ë¶„) â†’ Hanja-corÃ©en.","â€˜ë¶„â€™ est une unitÃ© de temps standard Ã©crite."],
        hours: ["ğŸ•’ Heures(ì‹œ) â†’ natifs (í•œ/ë‘/ì„¸ ì‹œâ€¦).","Aujourdâ€™hui : heures(ì‹œ)=natifs, minutes(ë¶„)=Hanja-corÃ©en."]
      };
      return lines[forWhat] || [];
    }

    function showGeneralHint(){
      const q = questions[currentQuestionIndex];
      const d = document.getElementById('hint-display');
      q.hint1Count++;

      const text = (q.context || q.fr || q.ko || "").toString();
      let key = null;
      if (text.includes("ì‚´") || /Ã‚ge|age/i.test(text)) key = "age";
      else if (text.includes("ëª…") || /Personnes/i.test(text)) key = "people";
      else if (text.includes("ê¶Œ") || text.includes("ê°œ") || /Objets|livres|ì±…/i.test(text)) key = "objects";
      else if (text.includes("ì¼") || /Date|septembre|ì›”/i.test(text)) key = "date";
      else if (/ìœ ë¡œ|ì›|Prix|Argent/i.test(text)) key = "money";
      else if (text.includes("ë¶„") || /Minutes/i.test(text)) key = "minutes";
      else if (text.includes("ì‹œ") || /Heures/i.test(text)) key = "hours";

      let msgLines = [];
      if (key) msgLines = buildConceptHint(key);
      else { msgLines = ["â„¹ï¸ Deux systÃ¨mes :","- Compter des choses â†’ natifs corÃ©ens","- Noms/unitÃ©s Ã©crits (date, prix, numÃ©roâ€¦) â†’ Hanja-corÃ©en"]; }

      if (key === "hours" || key === "minutes") {
        msgLines.push("","ğŸ•°ï¸ Petit rappel historique","Autrefois : unitÃ©s traditionnelles (ex. 1ê° â‰ˆ 15 min).","Ã‰poque moderne : Â« 1 h = 60 min Â».","Aujourdâ€™hui : ì‹œ (heures) = natifs / ë¶„ (minutes) = Hanja-corÃ©en.");
      }

      d.textContent = msgLines.join("\n");
      d.classList.remove('hidden');
    }

    // ===== ì œê³µìë³„ ìŒì„± ë§¤í•‘ =====
    const VOICE_MAP = {
      openai: { default: "alloy", alloy: "alloy", shimmer: "verse", nova: "alloy", echo: "alloy", fable: "verse" },
      google: { default: "ko-KR-Standard-A", alloy: "ko-KR-Standard-A", shimmer: "ko-KR-Standard-B", nova: "ko-KR-Standard-C", echo: "ko-KR-Standard-D", fable: "ko-KR-Neural2-A" }
    };
    function mapVoice(provider, reqName){
      const table = VOICE_MAP[provider] || {};
      return table[reqName] || table.default || reqName || "ko-KR-Standard-A";
    }

    // ===== TTS: Play / Pause í† ê¸€, Stop, Loop =====
    async function playAudio(text, voice='alloy', opts = {}){
      if (audioClickLocked || isPlayingOrFetching) {
        if (currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice){
          try{ if (!currentAudio.paused) { currentAudio.pause(); updatePlayButtonUI(false); } else { await currentAudio.play(); updatePlayButtonUI(true); } }catch(_){ }
        }
        return;
      }
      audioClickLocked = true; setTimeout(()=>audioClickLocked=false, 220);

      try{
        if (currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice && currentAudio.src){
          if(!currentAudio.paused){ currentAudio.pause(); updatePlayButtonUI(false); }
          else { await currentAudio.play(); updatePlayButtonUI(true); }
          return;
        }

        isPlayingOrFetching = true;
        if(questions.length>0 && questions[currentQuestionIndex]){ questions[currentQuestionIndex].listenCount++; }

        if(currentFetchAbort){ try{ currentFetchAbort.abort(); }catch(_){} }
        if(currentAudio){ try{ currentAudio.pause(); }catch(_){} }

        const ac = new AbortController();
        currentFetchAbort = ac;

        const configured = (window.PONGDANG_TTS && window.PONGDANG_TTS.provider) || 'openai';
        const primary   = opts.provider || configured;
        const secondary = (primary === 'openai') ? 'google' : 'openai';

        const basePayload = { text, voice, provider: primary, speed:(opts.speed ?? opts.speakingRate), speakingRate:opts.speakingRate };

        const tryFetch = async (prov) => {
          const payload = { ...basePayload, provider: prov, voice: mapVoice(prov, voice) };
          const res = await fetch(`${FN_BASE}/generate-audio`,{ method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'}, body:JSON.stringify(payload), signal: ac.signal });
          if(!res.ok){
            const body = await res.text().catch(()=>"");
            const msg = `generate-audio ${prov}: ${res.status} ${body}`;
            if (res.status===402 || res.status===429 || (res.status>=500 && res.status<=599)) throw new Error('RETRY:'+msg);
            throw new Error(msg);
          }
          const data = await res.json().catch(()=>{ throw new Error('Invalid JSON from TTS'); });
          return data;
        };

        let data;
        try { data = await tryFetch(primary); }
        catch(e){ if(String(e.message).startsWith('RETRY:')) data = await tryFetch(secondary); else throw e; }
        if(ac.signal.aborted || !data) return;

        let srcUrl = null;
        if(data.audioBase64 || data.audioContent){
          const b64 = data.audioBase64 || data.audioContent;
          const blob = base64ToBlob(b64, data.mimeType||'audio/mpeg');
          srcUrl = URL.createObjectURL(blob); currentBlobUrl = srcUrl;
        }else if(data.audioUrl){ srcUrl = data.audioUrl; }
        else { throw new Error('Invalid TTS response: missing audio'); }

        const audio = new Audio(srcUrl);
        currentAudio = audio;
        currentAudioMeta = { text, voice };
        audio.loop = isLooping;

        const canPlay = new Promise(resolve=>{
          const ready = () => { audio.removeEventListener('canplaythrough', ready); resolve(); };
          audio.addEventListener('canplaythrough', ready, { once:true });
          setTimeout(resolve, 380);
        });

      audio.addEventListener('playing', ()=> updatePlayButtonUI(true));
      audio.addEventListener('pause',   ()=> updatePlayButtonUI(false));
      audio.addEventListener('ended',   ()=> { updatePlayButtonUI(false); /* cleanupì€ ë‹¤ìŒ ì¬ìƒ ì‹œ */ });
      audio.addEventListener('error',   (e)=> {
        console.warn('audio error', e);
        if (!audio.ended) showErrorModal('ì˜¤ë””ì˜¤ ì¬ìƒì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      });

        await canPlay;
        try{ await audio.play(); }
        catch(err){ await tinyDelay(150); try{ await audio.play(); }catch(_){ showErrorModal('ì˜¤ë””ì˜¤ ì¬ìƒì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'); }}
      }catch(error){
        if (error?.name !== 'AbortError'){
          console.error('playAudio error', error);
          logError(error,'playAudio',{text,voice,opts});
          showErrorModal('ì˜¤ë””ì˜¤ ìƒì„±/ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        }
      }finally{ isPlayingOrFetching = false; }
    }

    // ë°›ì•„ì“°ê¸° ì»¨íŠ¸ë¡¤ í•¸ë“¤ëŸ¬
    function onPlayPause(text, voice, btnEl, opts){
      currentAudioUI.playBtn = btnEl;
      updatePlayButtonUI(currentAudio && !currentAudio.paused);
      return playAudio(text, voice, opts); // â¬…ï¸ opts ì „ë‹¬
    }
    function onStop(){ if(!currentAudio) return; try{ currentAudio.pause(); currentAudio.currentTime = 0; }catch(_){ } updatePlayButtonUI(false); }
    function onToggleLoop(btnEl){ currentAudioUI.loopBtn = btnEl; isLooping = !isLooping; if(currentAudio){ currentAudio.loop = isLooping; } updateLoopButtonUI(); }

    // ===== Sticky 5Ã—5 (Q6â€“20ì—ì„œ ìƒë‹¨ ë°” ë…¸ì¶œ) =====
    function toggleSticky55(show){
      const bar = document.getElementById('sticky-55');
      if (!bar) return;
      bar.classList.toggle('hidden', !show);
    }

    // ===== ê²°ê³¼ ì „ì†¡ =====
    async function sendResults(){
      endTime = new Date();
      const totalTimeSeconds = Math.round((endTime - startTime)/1000);

      const includeAudio = !!window.PONGDANG_SEND_AUDIO;

      const payload = {
        studentName,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        totalTimeSeconds,
        questions: questions.map(q=>{
          let rec = null;
          if(q.recording){
            const tooBig = ((q.recording.base64||'').length > 500000); // ~0.5MB ë¬¸ì ê¸¸ì´ ê¸°ì¤€
            if(includeAudio && !tooBig){ rec = q.recording; }
            else { rec = { hasRecording:true, duration:q.recording.duration, filename:q.recording.filename, omitted:true, reason: tooBig? 'size':'disabled' }; }
          }
          return ({
            number:q.number, type:q.type,
            ko:(q.type==='fr_fill_audio' ? (q.audioKo||'') : (q.ko||q.answer||'')),
            fr:(q.type==='fr_fill_audio' ? (q.answerTemplateFr||'') : (q.fr||q.context||'')),
            userAnswer:q.userAnswer, isCorrect:q.isCorrect,
            listenCount:q.listenCount, hint1Count:q.hint1Count, hint2Count:q.hint2Count,
            recording: rec, pronunciationFeedback:q.pronunciationFeedback||null
          });
        })
      };
      try{
        const r = await fetch(`${FN_BASE}/send-results`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!r.ok){
          const body = await r.text().catch(()=>"");
          throw new Error(`send-results: ${r.status} ${body}`);
        }
      }catch(e){ console.error('sendResults error', e); logError(e,'sendResults',{}); showErrorModal("ê²°ê³¼ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ê²½ë¡œë‚˜ ë³¸ë¬¸ í¬ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”."); }
    }

    // ===== íƒ€ì… ë¼ë²¨ =====
 const TYPE_TITLES = {
  choice: 'Choix / ì„ íƒ',
  fr_fill_audio: 'Audio(KO)â†’Chiffre(FR) / ë“£ê³  ìˆ«ìë§Œ ë¶ˆì–´ë¡œ',
  fr_prompt_ko: 'FranÃ§ais â†’ í•œêµ­ì–´ / ë¶ˆâ†’í•œ',
  listen_write: 'Ã‰couter-Ã‰crire / ë“£ê³  ì“°ê¸°',
  dictation: 'DictÃ©e / ë°›ì•„ì“°ê¸°',
  fill: 'ComplÃ©ter / ë¹ˆì¹¸ ì±„ìš°ê¸°',
  translate: 'Traduire / ë²ˆì—­'
};

    // ===== ë¬¸ì œ ì„¸íŠ¸ =====
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

    function getQuestions(){
      // 1â€“5 ì„ íƒí˜• ìœ ì§€
      const choiceData = [
        { context:"Pour la date '1ì¼', on dit :", options:["ì¼ì¼","í•˜ë‚˜ì¼"], answer:"ì¼ì¼", hint:"RÃ¨gle/ê·œì¹™: Dates â‡’ Hanja-corÃ©en" },
        { context:"Pour l'heure '1ì‹œ', on dit :", options:["í•œ ì‹œ","ì¼ ì‹œ"], answer:"í•œ ì‹œ", hint:"RÃ¨gle/ê·œì¹™: Heures(ì‹œ) â‡’ Natifs (ì˜ˆì™¸)" },
        { context:"Pour l'Ã¢ge '3ì‚´', on dit :", options:["ì„¸ ì‚´","ì‚¼ ì‚´"], answer:"ì„¸ ì‚´", hint:"RÃ¨gle/ê·œì¹™: Ã‚ge â‡’ Natifs" },
        { context:"Pour l'argent '10 euro', on dit :", options:["ì‹­ ìœ ë¡œ","ì—´ ìœ ë¡œ"], answer:"ì‹­ ìœ ë¡œ", hint:"RÃ¨gle/ê·œì¹™: Prix â‡’ Hanja-corÃ©en" },
        { context:"Pour 30 minutes (30ë¶„), on dit :", options:["ì‚¼ì‹­ ë¶„","ì„œë¥¸ ë¶„"], answer:"ì‚¼ì‹­ ë¶„", hint:"RÃ¨gle/ê·œì¹™: Minutes(ë¶„) â‡’ Hanja-corÃ©en" }
      ];

      // 6â€“15 ğŸ‡«ğŸ‡· í”„ë¡¬í”„íŠ¸ â†’ ğŸ‡°ğŸ‡· ë‹µ (ëª¨ë‘ ê°™ì€ íŒ¨í„´, ìš”ì²­ëŒ€ë¡œ)
      const baseHintFr = "Astuce : pour les unitÃ©s (heure, date, prix, etc.), Ã©coute bien lâ€™audio et imite. Tu peux rÃ©Ã©couter les nombres avec les boutons en haut.";
      const frPromptKoData = Array.from({length:10}).map(_=>({
        fr:"Quelle heure est-il ?",
        audio:"Quelle heure est-il ? ëª‡ ì‹œì˜ˆìš”?",
        frGuide:"Ex. Il est 3 h.",
        ko:"ì„¸ ì‹œì˜ˆìš”.",
        acceptedKo:["ì§€ê¸ˆì€ ì„¸ ì‹œì˜ˆìš”.","ì„¸ì‹œì˜ˆìš”","ì„¸ ì‹œì…ë‹ˆë‹¤."],
        voice:"alloy"
      }));

      // 16â€“20 ë°›ì•„ì“°ê¸° ìœ ì§€
      const dictationData = [
        { ko:"ì‚¬ê³¼ ë‘ ê°œ ì£¼ì„¸ìš”.", fr:"Donnez-moi deux pommes, s'il vous plaÃ®t.", hint1:"ã……ã„± ã„· ã„± ã…ˆã……ã…‡", hint2:"ë‹¨ì–´: ì‚¬ê³¼ Â· ë‘ Â· ê°œ Â· ì£¼ì„¸ìš” | mots: pomme Â· deux Â· classificateur Â· s'il vous plaÃ®t", conceptualHint:"Objets â‡’ natifs", voice:'shimmer' },
        { ko:"ì´ê±°ëŠ” ì˜¤ì²œ ì›ì´ì—ìš”.", fr:"Ceci coÃ»te 5000 won.", hint1:"ã…‡ã„±ã„´ ã…‡ã…Š ã…‡ã…‡ã…‡ã…‡", hint2:"ë‹¨ì–´: ì´ê±° Â· ì˜¤ì²œ Â· ì›", conceptualHint:"Prix â‡’ Hanja-corÃ©en", voice:'nova' },
        { ko:"ì œ ìƒì¼ì€ ì‹­ì´ì›” ì‹­ì¼ì´ì—ìš”.", fr:"Mon anniversaire est le 10 dÃ©cembre.", hint1:"ã…ˆ ã……ã…‡ã…‡ ã……ã…‡ã…‡ ã……ã…‡ã…‡ã…‡ã…‡", hint2:"ë‹¨ì–´: ìƒì¼ Â· ì‹­ì´ì›” Â· ì‹­ì¼", conceptualHint:"Date â‡’ Hanja-corÃ©en", voice:'alloy' },
        { ko:"í•™ìƒ ì—¬ëŸ ëª…ì´ ìˆì–´ìš”.", fr:"Il y a huit Ã©tudiants.", hint1:"ã…ã…… ã…‡ã„· ã…ã…‡ ã…‡ã…‡ã…‡", hint2:"ë‹¨ì–´: í•™ìƒ Â· ì—¬ëŸ Â· ëª…", conceptualHint:"Personnes â‡’ natifs", voice:'echo' },
        { ko:"ì§€ê¸ˆì€ ì˜¤í›„ ë„¤ ì‹œ ì‚¼ì‹­ ë¶„ì´ì—ìš”.", fr:"Il est 16h30.", hint1:"ã…ˆã„±ã…‡ ã…‡ã… ã„´ ã…… ã……ã…… ã…‚ã…‡ã…‡ã…‡", hint2:"ë‹¨ì–´: ì‹œ Â· ë¶„ Â· ì˜¤í›„", conceptualHint:"Temps â‡’ ì‹œ natifs / ë¶„ Hanja", voice:'fable' }
      ];

      const choice = choiceData.map((q,i)=>({
        number:i+1,
        type:'choice', typeLabel: TYPE_TITLES['choice'],
        context:q.context, answer:q.answer, options:[...q.options].sort(()=>Math.random()-0.5), hint:q.hint,
        userAnswer:null, isCorrect:null, listenCount:0, hint1Count:0, hint2Count:0
      }));

      const frPromptKo = frPromptKoData.map((q,i)=>({
        number: choice.length + i + 1,
        type:'fr_prompt_ko', typeLabel: TYPE_TITLES['fr_prompt_ko'],
        fr:q.fr,
        audioText:q.audio,
        frGuide:q.frGuide,
        ko:q.ko,
        acceptedKo:q.acceptedKo || [],
        voice:q.voice || 'alloy',
        baseHintFr: baseHintFr,
        userAnswer:"",
        isCorrect:null, listenCount:0, hint1Count:0, hint2Count:0
      }));

      const dictation = dictationData.map((q,i)=>({
        number: choice.length + frPromptKo.length + i + 1,
        type:'dictation', typeLabel: TYPE_TITLES['dictation'],
        ko:q.ko, fr:q.fr, hint1:q.hint1, hint2:q.hint2, conceptualHint:q.conceptualHint, voice:q.voice,
        userAnswer:{ko:"",fr:"",selfDictation:""},
        isCorrect:null, listenCount:0, hint1Count:0, hint2Count:0, recording:null, pronunciationFeedback:null
      }));

      return [...choice, ...frPromptKo, ...dictation];
    }

    // ===== UI =====
    function renderQuestion(){ try {
      const q = questions[currentQuestionIndex];
      const area = document.getElementById('question-area');
      const explanationMap = {
        choice:'Choisissez la bonne rÃ©ponse. / ì•Œë§ì€ ë‹µì„ ê³ ë¥´ì„¸ìš”.',
        fill:'Remplissez le champ vide. / ë¹ˆì¹¸ì„ ì±„ìš°ì„¸ìš”.',
        translate:'Traduisez en corÃ©en. / í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”.',
        dictation:'Ã‰coutez et Ã©crivez. / ë“£ê³  ë°›ì•„ì“°ì„¸ìš”.',
        fr_fill_audio:'Ã‰coutez (corÃ©en) â†’ rÃ©pondez en franÃ§ais (chiffre). / ë“£ê³  ìˆ«ìë§Œ ë¶ˆì–´ë¡œ!',
        fr_prompt_ko:"ğŸ‡«ğŸ‡· Ã‰coutez la consigne â†’ ğŸ‡°ğŸ‡· rÃ©pondez en corÃ©en. / ì˜¤ë””ì˜¤ ë“£ê³  í•œêµ­ì–´ë¡œ ë‹µí•˜ì„¸ìš”.",
        listen_write:'Ã‰coutez et Ã©crivez la phrase corÃ©enne. / ë¬¸ì¥ ë°›ì•„ì“°ê¸°'
      };

      const typeBadge = `<span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-800 text-white">${q.typeLabel || (TYPE_TITLES[q.type]||q.type.toUpperCase())}</span>`;
      let html = `<div class=\"flex items-center gap-2 mb-1\">${typeBadge}<span class=\"text-sm text-slate-500\">Q${q.number}</span></div>`;
      html += `<h2 class="question-title">${q.frTitle || q.context || q.fr || `Question ${q.number}`}</h2>`;
      html += `<p class="question-text">${explanationMap[q.type]}</p>`;

      if(q.type==='choice'){
        html+=`<p class="text-lg font-semibold mb-4">${q.context}</p>
               <button class="btn btn-secondary w-full mb-4" onclick="showGeneralHint()">Aidez-moi ğŸ™ (íŒíŠ¸)</button>
               <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg mb-4 hidden"></div>`;
        q.options.forEach(opt=>{ html+=`<button class="choice-btn ${q.userAnswer===opt?'selected':''}" onclick=\"selectChoiceAnswer('${opt}')\">${opt}</button>`; });
      }
      else if(q.type==='dictation'){
        html+=`<div class="space-y-4">
          <div class="flex gap-2">
            <button id="playpause-btn" class="btn btn-sound flex-1 text-lg bg-emerald-600" onclick="onPlayPause('${safeAttr(q.ko)}','${q.voice}', this)">
              <i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)
            </button>
            <button id="stop-btn" class="btn btn-secondary" onclick="onStop()"><i class="fas fa-square"></i> Stop</button>
            <button id="loop-btn" class="btn btn-secondary" onclick="onToggleLoop(this)"><i class="fas fa-redo"></i> RÃ©pÃ©ter Off</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button class="btn btn-secondary" onclick="showGeneralHint()">Aidez-moi ğŸ™ (íŒíŠ¸)</button>
            <button class="btn btn-secondary" onclick="showGeneralHint()">Au secours ğŸ›Ÿ (ë‹¨ì–´)</button>
            <button class="col-span-2 btn btn-secondary mt-2" onclick="showGeneralHint()">Pourquoi ce nombre ? ğŸ¤” (ìˆ«ì íŒíŠ¸)</button>
          </div>
          <div id="hint-display" class="p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
          <div><label class="block mb-1 font-semibold">1. DictÃ©e (ë°›ì•„ì“°ê¸°)</label><input class="input-field" value="${q.userAnswer.ko||''}" oninput="updateDictationAnswer('ko',this.value)"></div>
          <div><label class="block mb-1 font-semibold">2. Traduction (ë²ˆì—­)</label><input class="input-field" value="${q.userAnswer.fr||''}" oninput="updateDictationAnswer('fr',this.value)"></div>
          <div><label class="block mb-1 font-semibold">3. Enregistrez votre voix (ë°œìŒ ë…¹ìŒ)</label>
            <div class="flex items-center gap-2">
              <button id="record-btn" class="btn btn-primary"><i class="fas fa-microphone"></i> DÃ©marrer (ì‹œì‘)</button>
              <div id="recording-indicator" class="hidden items-center gap-2 text-red-500 font-semibold"><div class="recording-dot"></div> Enregistrementâ€¦ (ë…¹ìŒ ì¤‘)</div>
            </div>
            <audio id="audio-playback" controls class="mt-2 w-full hidden"></audio>
          </div>
          <div><label class="block mb-1 font-semibold">4. RÃ©Ã©coutez et Ã©crivez (ë‹¤ì‹œ ë“£ê³  ì ê¸°)</label><input class="input-field" value="${q.userAnswer.selfDictation||''}" oninput="updateDictationAnswer('selfDictation',this.value)"></div>
        </div>`;
      }
      else if(q.type==='fr_prompt_ko'){
        html+=`
          <p class="text-lg font-semibold mb-2">${q.fr}</p>
          <div class="flex gap-2 mb-3">
            <button id="playpause-btn" class="btn btn-sound flex-1 text-lg bg-emerald-600" onclick="onPlayPause('${safeAttr(q.audioText)}','${q.voice||'alloy'}', this)"><i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)</button>
            <button id="stop-btn" class="btn btn-secondary" onclick="onStop()"><i class="fas fa-square"></i> Stop</button>
            <button id="loop-btn" class="btn btn-secondary" onclick="onToggleLoop(this)"><i class="fas fa-redo"></i> RÃ©pÃ©ter Off</button>
          </div>
          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded mb-3 text-sm text-yellow-800">${q.baseHintFr}</div>
          <div class="p-3 bg-white rounded border mb-3 text-sm text-slate-600"><span class="font-medium">Guide (FR)</span> : ${q.frGuide} <span class="text-slate-400">â†’ rÃ©pondez en corÃ©en</span></div>
          <label class="block mb-1 font-semibold">RÃ©ponse en corÃ©en (í•œêµ­ì–´ë¡œ):</label>
          <input class="input-field input-ko" value="${q.userAnswer||''}" oninput="updateTranslateAnswer(this.value)" placeholder="ì˜ˆ: ${q.ko}">
          <input class="input-field" value="${q.userAnswer||''}" oninput="updateTranslateAnswer(this.value)" placeholder="ì˜ˆ: ${q.ko}">`;
      }

      area.innerHTML = html;
      if(q.type==='dictation') setupRecording();
      if(q.type==='fr_prompt_ko' && q.number >= 11){
        const card = document.getElementById('pronun-card');
        if(card && window.Pronun){
          try{
            Pronun.mount(card, {
              getReferenceText: () => q.ko,
              isKoCorrect: () => stripKo(document.querySelector('#question-area .input-ko')?.value||'') === stripKo(q.ko),
              onResult: (r) => { q.pronunciationFeedback = r; } // ê²°ê³¼ëŠ” send-resultsì— ê°™ì´ ì „ì†¡ë¨
            });
          }catch(err){
            console.error('Pronun.mount error', err);
            logError(err,'Pronun.mount',{ qnum:q.number });
          }
        }
      }

     toggleSticky55((questions[currentQuestionIndex]?.number || 0) >= 6);
     updateNavigation();
      } catch (err) {
        console.error('renderQuestion error', err);
        logError(err, 'renderQuestion', { idx: currentQuestionIndex });
        showErrorModal('ì—°ìŠµë¬¸ì œë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)');
      }
    }
        

    function updateNavigation(){
      document.getElementById('prev-btn').classList.toggle('disabled', currentQuestionIndex===0);
      document.getElementById('next-btn').classList.toggle('hidden', currentQuestionIndex===questions.length-1);
      document.getElementById('finish-btn').classList.toggle('hidden', currentQuestionIndex<questions.length-1);
      const pb = document.getElementById('progress-bar-inner');
      if(pb){ const progress=((currentQuestionIndex+1)/questions.length)*100; pb.style.width=`${progress}%`; }
      const pt = document.getElementById('progress-text');
      if(pt){ pt.textContent=`Question ${currentQuestionIndex+1} sur ${questions.length}`; }
    }

    // ===== Answers =====
    function selectChoiceAnswer(a){ questions[currentQuestionIndex].userAnswer=a; renderQuestion(); }
    function updateTranslateAnswer(a){ questions[currentQuestionIndex].userAnswer=a; }
    function updateDictationAnswer(part,val){ questions[currentQuestionIndex].userAnswer[part]=val; }

    // ===== Recording =====
    function setupRecording(){
      const recordBtn=document.getElementById('record-btn'), indicator=document.getElementById('recording-indicator'), playback=document.getElementById('audio-playback');
      recordBtn.onclick = async () => {
        if(mediaRecorder && mediaRecorder.state==="recording"){
          mediaRecorder.stop();
          recordBtn.innerHTML='<i class="fas fa-microphone"></i> DÃ©marrer (ì‹œì‘)';
          indicator.classList.add('hidden');
          recordBtn.classList.remove('bg-red-500','hover:bg-red-600');
        }else{
          try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
            mediaRecorder.onstop=()=>{
              const blob=new Blob(audioChunks,{type:'audio/webm'});
              const url=URL.createObjectURL(blob);
              playback.src=url; playback.classList.remove('hidden');
              const temp=new Audio(url);
              temp.addEventListener('loadedmetadata',()=>{
                const duration=temp.duration;
                const reader=new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend=()=>{ questions[currentQuestionIndex].recording={ base64:reader.result, filename:`rec_q${questions[currentQuestionIndex].number}.webm`, mimeType:'audio/webm', duration }; };
              });
              stream.getTracks().forEach(t=>t.stop());
            };
            mediaRecorder.start();
            recordBtn.innerHTML='<i class="fas fa-stop"></i> ArrÃªter (ì •ì§€)';
            indicator.style.display='flex';
            recordBtn.classList.add('bg-red-500','hover:bg-red-600');
          }catch(err){ logError(err,'setupRecording'); showErrorModal("ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); }
        }
      };
    }

    // ===== Flow =====
    function startQuiz(){
      studentName=document.getElementById('student-name').value.trim();
      if(!studentName){ showErrorModal("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (Entrez votre nom.)"); return; }
      const start = document.getElementById('start-screen');
      const explain = document.getElementById('explanation-screen');
      start.classList.add('hidden');
      explain.classList.remove('hidden');
      const next = document.getElementById('explanation-next-btn');
      if(next){ try{ next.focus({ preventScroll:true }); }catch(_){} }
      try{ window.scrollTo({ top:0, behavior:'smooth' }); }catch(_){ }
    }
    function showWarmupScreen(){ document.getElementById('explanation-screen').classList.add('hidden'); document.getElementById('warmup-screen').classList.remove('hidden'); }
    function startRealQuiz(){
     startTime=new Date(); 
     questions=getQuestions(); 
     currentQuestionIndex=0;
       if(!questions || !questions.length){
        showErrorModal('ë¬¸í•­ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        console.error('getQuestions returned', questions);
        return;
      }
    document.getElementById('warmup-screen').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('hidden'); renderQuestion(); updateNavigation(); }
    function nextQuestion(){ if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} } if(currentQuestionIndex<questions.length-1){ currentQuestionIndex++; renderQuestion(); updateNavigation(); } }
    function prevQuestion(){ if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} } if(currentQuestionIndex>0){ currentQuestionIndex--; renderQuestion(); updateNavigation(); } }

    // ===== ì±„ì  =====
    function stripKo(s){ return String(s||'').replace(/\s/g,'').replace(/[.,!?]/g,''); }
    function checkAnswers(){
      questions.forEach(q=>{
        if(q.type==='choice') q.isCorrect = q.userAnswer===q.answer;
        else if(q.type==='dictation') q.isCorrect = stripKo(q.userAnswer.ko)===stripKo(q.ko);
        else if(q.type==='fr_prompt_ko'){
          if(q.number >= 11){
            html += `
              <div id="pronun-card" class="mt-4 p-4 rounded-lg border border-indigo-200 bg-indigo-50/60">
                <div class="text-sm text-slate-700 mb-2">ğŸ¤ VÃ©rifie ta prononciation / ë°œìŒ í™•ì¸</div>
                <div class="flex gap-2">
                  <button class="btn btn-secondary btn-rec-start">ğŸ™ï¸ Enregistrer / ë…¹ìŒ</button>
                  <button class="btn btn-secondary btn-rec-stop" disabled>â¹ï¸ Stop</button>
                </div>
                <canvas class="vu-canvas mt-2 w-full" height="48"></canvas>
                <div class="pronun-display mt-2 text-sm"></div>
              </div>`;
          }

          const candidates = [q.ko, ...(q.acceptedKo||[])];
          q.isCorrect = candidates.some(ans=> stripKo(q.userAnswer)===stripKo(ans));
        }
      });
    }
    function getFeedback(score){
      if(score>=90) return {fr:"Excellent travail ! ğŸŒŸ",ko:"ì™„ë²½í•´ìš”! ë„ˆë¬´ ì˜í–ˆì–´ìš” ğŸ˜Š",className:"text-green-600"};
      if(score>=70) return {fr:"TrÃ¨s bien ! Continuez ğŸ’ª",ko:"ì•„ì£¼ ì¢‹ì•„ìš”! ê³„ì†í•´ìš”!",className:"text-emerald-600"};
      if(score>=50) return {fr:"Pas mal ! On rÃ©vise encore ğŸ‘",ko:"ë‚˜ì˜ì§€ ì•Šì•„ìš”! ì¡°ê¸ˆë§Œ ë”!",className:"text-yellow-600"};
      return {fr:"Courage ! On va y arriver ğŸ‘Š",ko:"ê´œì°®ì•„ìš”! ê°™ì´ ë‹¤ì‹œ í•´ë´ìš”!",className:"text-orange-600"};
    }

    function showResults(){
      if (currentFetchAbort) { try{ currentFetchAbort.abort(); }catch(_){} }
      cleanupAudio();
      checkAnswers();
      sendResults();

      const correct=questions.filter(q=>q.isCorrect).length;
      const score=Math.round((correct/questions.length)*100);
      const time=Math.round((new Date()-startTime)/1000);

      const fb=getFeedback(score);
      document.getElementById('final-score').textContent=score+"/100";
      document.getElementById('total-time').textContent=time;
      const rf=document.getElementById('result-feedback');
      rf.className='text-2xl font-semibold mb-6 '+fb.className;
      rf.textContent=`${fb.fr} / ${fb.ko}`;

      const review=document.getElementById('review-content');
      review.innerHTML='';
      questions.forEach(q=>{
        if(!q.isCorrect){
          const block=document.createElement('div');
          block.className='p-3 bg-white rounded border';
          const userAns=(q.type==='dictation'? (q.userAnswer.ko||'') : (q.userAnswer||''));
          block.innerHTML=`<div class='text-sm text-gray-500 mb-1'>Q${q.number} (${q.type})</div><div class='font-semibold mb-1'>${(q.fr||q.context||'')}</div><div class='text-green-700'>âœ… ${q.ko||q.answer||''}</div><div class='text-red-700'>âŒ ${userAns||'(vide)'}</div>`;
          review.appendChild(block);
        }
      });

      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
    }

    // ===== Event bindings =====
    document.addEventListener('DOMContentLoaded', ()=>{
      const nameInput=document.getElementById('student-name');
      if(nameInput){ const names=["Camille","Lucas","ZoÃ©","Arthur","Ã‰lise","LÃ©a","Hugo","ThÃ©o","Oscar","ChloÃ©","Jeanne d'Arc","NapolÃ©on","Marie Curie","Louis XIV"]; nameInput.placeholder = nameInput.placeholder || names[Math.floor(Math.random()*names.length)]; }
      const byId=(id,fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',fn); };
      byId('start-btn', startQuiz);
      byId('explanation-next-btn', showWarmupScreen);
      byId('start-quiz-btn', startRealQuiz);
      byId('next-btn', nextQuestion);
      byId('prev-btn', prevQuestion);
      byId('finish-btn', showResults);
      byId('print-btn', ()=>window.print());
      byId('restart-btn', ()=>window.location.reload());
      byId('close-error-modal-btn', ()=>document.getElementById('error-modal').classList.add('hidden'));
      if(nameInput){ nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') startQuiz(); }); }
    });

    window.addEventListener('beforeunload', ()=>{ try{ if(currentFetchAbort) currentFetchAbort.abort(); cleanupAudio(); }catch(_){ } });
  </script>
</body>
</html>
