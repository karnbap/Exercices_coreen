<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice Cor√©en : Structure de Phrase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap');
        body {
            font-family: 'Roboto', 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }
        .royal-blue { background-color: #0033a0; }
        .gold-text { color: #ffbf00; }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-primary { background-color: #0033a0; border: 2px solid #002269; }
        .btn-primary:hover { background-color: #002269; }
        .btn-secondary { background-color: #6c757d; border: 2px solid #5a6268; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-gold { background-color: #ffbf00; color: #0033a0; border: 2px solid #e6ac00; }
        .btn-gold:hover { background-color: #e6ac00; }
        .btn-green { background-color: #16a34a; border: 2px solid #15803d; }
        .btn-green:hover { background-color: #15803d; }
        input[type="text"] {
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        input[type="text"]:focus { outline: none; border-color: #0033a0; }
        .correct { border-color: #22c55e !important; background-color: #f0fff4; }
        .incorrect { border-color: #ef4444 !important; background-color: #fff1f2; }
        #result-message {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-6 royal-blue rounded-xl shadow-lg">
            <h1 class="text-3xl md:text-4xl font-bold gold-text">Exercice de Cor√©en üá∞üá∑</h1>
            <p class="text-white mt-2">D√©composer les phrases</p>
        </header>

        <div class="card p-6 mb-8">
            <label for="student-name" class="block text-lg font-bold text-gray-700 mb-2">Entrez votre nom :</label>
            <input type="text" id="student-name" placeholder="Ex: C√©dric" class="text-lg">
        </div>

        <!-- Explication + Exemple -->
        <div class="card p-6 mb-12 bg-blue-50 border border-blue-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìù Comment √ßa marche ?</h2>
            <p class="text-gray-700 mb-6">Une phrase complexe est souvent compos√©e de <strong>deux parties</strong> : une <strong>partie principale</strong> (l'id√©e de base) et une <strong>partie qui d√©crit</strong> un nom. Votre mission est de les retrouver !</p>
            
            <h3 class="text-xl font-bold text-blue-800 mb-4">‚≠ê Exemple</h3>
            <p class="text-lg mb-2">Le livre que j‚Äôai achet√© est int√©ressant. / <span class="font-bold text-blue-700">ÎÇ¥Í∞Ä ÏÇ∞ Ï±ÖÏùÄ Ïû¨ÎØ∏ÏûàÏñ¥Ïöî.</span></p>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="font-semibold">1Ô∏è‚É£ Partie principale :</label>
                    <p class="p-2 bg-gray-100 rounded-md mt-1">Le livre est int√©ressant. / Ï±ÖÏùÄ Ïû¨ÎØ∏ÏûàÏñ¥Ïöî.</p>
                </div>
                <div>
                    <label class="font-semibold">2Ô∏è‚É£ Partie qui d√©crit :</label>
                    <p class="p-2 bg-gray-100 rounded-md mt-1">que j‚Äôai achet√© / ÎÇ¥Í∞Ä ÏÇ∞</p>
                </div>
            </div>
        </div>


        <!-- PARTIE 1 -->
        <div id="part1-container" class="mb-12">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Partie 1 : Analyse en fran√ßais</h2>
                <p class="text-gray-600">Lisez la phrase en fran√ßais et s√©parez-la en deux parties. √âcrivez vos r√©ponses en <strong>fran√ßais</strong>.</p>
            </div>
            <div id="questions-part1" class="space-y-6">
                <!-- Questions de la partie 1 ins√©r√©es ici -->
            </div>
        </div>

        <!-- PARTIE 2 -->
        <div id="part2-container">
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Partie 2 : Analyse en cor√©en</h2>
                <p class="text-gray-600">Lisez la phrase en cor√©en, aidez-vous de la traduction et du vocabulaire. S√©parez la phrase en deux parties et √©crivez vos r√©ponses en <strong>cor√©en</strong>.</p>
            </div>
            <div id="questions-part2" class="space-y-6">
                <!-- Questions de la partie 2 ins√©r√©es ici -->
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-4 mt-8">
            <button id="check-button" class="btn btn-primary"><i class="fas fa-check-circle mr-2"></i>V√©rifier</button>
            <button id="retry-button" class="btn btn-green"><i class="fas fa-redo mr-2"></i>Recommencer</button>
            <button id="finish-button" class="btn btn-gold"><i class="fas fa-paper-plane mr-2"></i>Terminer & Envoyer</button>
        </div>

        <div id="result-container" class="mt-8"></div>
        
        <div class="flex justify-between items-center mt-8 border-t pt-6">
            <button onclick="window.history.back();" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Pr√©c√©dent</button>
            <button onclick="window.print();" class="btn btn-secondary"><i class="fas fa-print mr-2"></i>Imprimer</button>
        </div>
    </div>

    <script>
        const allQuestions = [
            // Part 1 Questions (type: 'fr') - 10 questions
            { type: 'fr', id: 'fr1', sentence: "Le livre que j‚Äôai achet√© est int√©ressant.", part1: "Le livre est int√©ressant.", part2: "que j‚Äôai achet√©" },
            { type: 'fr', id: 'fr2', sentence: "J‚Äôai rencontr√© une femme qui parle fran√ßais.", part1: "J‚Äôai rencontr√© une femme.", part2: "qui parle fran√ßais" },
            { type: 'fr', id: 'fr3', sentence: "C‚Äôest la ville o√π je suis n√©.", part1: "C‚Äôest la ville.", part2: "o√π je suis n√©" },
            { type: 'fr', id: 'fr4', sentence: "Le film que tu as conseill√© √©tait super.", part1: "Le film √©tait super.", part2: "que tu as conseill√©" },
            { type: 'fr', id: 'fr5', sentence: "La personne dont je t‚Äôai parl√© est mon professeur.", part1: "La personne est mon professeur.", part2: "dont je t‚Äôai parl√©" },
            { type: 'fr', id: 'fr6', sentence: "Voici le parc o√π nous jouons.", part1: "Voici le parc.", part2: "o√π nous jouons" },
            { type: 'fr', id: 'fr7', sentence: "J'aime la chanson que tu chantes.", part1: "J'aime la chanson.", part2: "que tu chantes" },
            { type: 'fr', id: 'fr8', sentence: "Le chat qui dort sur le canap√© est gris.", part1: "Le chat est gris.", part2: "qui dort sur le canap√©" },
            { type: 'fr', id: 'fr9', sentence: "C'est un ami dont je suis tr√®s fier.", part1: "C'est un ami.", part2: "dont je suis tr√®s fier" },
            { type: 'fr', id: 'fr10', sentence: "Montre-moi la photo que tu as prise.", part1: "Montre-moi la photo.", part2: "que tu as prise" },

            // Part 2 Questions (type: 'ko') - 20 questions
            { type: 'ko', id: 'ko1', ko: "Ïñ¥Ï†ú Î®πÏùÄ ÏùåÏãùÏùÄ ÎßõÏûàÏóàÏñ¥Ïöî.", fr: "La nourriture que j'ai mang√©e hier √©tait d√©licieuse.", vocab: [{ko:"Ïñ¥Ï†ú",fr:"hier"},{ko:"Î®πÏùÄ",fr:"que j'ai mang√©"},{ko:"ÏùåÏãù",fr:"nourriture"},{ko:"ÎßõÏûàÏóàÏñ¥Ïöî",fr:"√©tait d√©licieux"}], part1: "ÏùåÏãùÏùÄ ÎßõÏûàÏóàÏñ¥Ïöî.", part2: "Ïñ¥Ï†ú Î®πÏùÄ" },
            { type: 'ko', id: 'ko2', ko: "ÏπúÍµ¨Í∞Ä Ï§Ä ÏÑ†Î¨ºÏùÄ ÏòàÎªêÏöî.", fr: "Le cadeau que mon ami m'a donn√© est joli.", vocab: [{ko:"ÏπúÍµ¨",fr:"ami"},{ko:"Ï§Ä",fr:"que...a donn√©"},{ko:"ÏÑ†Î¨º",fr:"cadeau"},{ko:"ÏòàÎªêÏöî",fr:"est joli"}], part1: "ÏÑ†Î¨ºÏùÄ ÏòàÎªêÏöî.", part2: "ÏπúÍµ¨Í∞Ä Ï§Ä" },
            { type: 'ko', id: 'ko3', ko: "Ïö∞Î¶¨Í∞Ä Í∞à Í≥≥ÏùÄ ÏÑúÏö∏Ïù¥ÏóêÏöî.", fr: "L'endroit o√π nous irons est S√©oul.", vocab: [{ko:"Ïö∞Î¶¨",fr:"nous"},{ko:"Í∞à",fr:"o√π...irons"},{ko:"Í≥≥",fr:"endroit"},{ko:"ÏÑúÏö∏",fr:"S√©oul"}], part1: "Í≥≥ÏùÄ ÏÑúÏö∏Ïù¥ÏóêÏöî.", part2: "Ïö∞Î¶¨Í∞Ä Í∞à" },
            { type: 'ko', id: 'ko4', ko: "ÏßÄÍ∏à ÏùΩÎäî Ï±ÖÏùÄ Ïñ¥Î†§ÏõåÏöî.", fr: "Le livre que je lis maintenant est difficile.", vocab: [{ko:"ÏßÄÍ∏à",fr:"maintenant"},{ko:"ÏùΩÎäî",fr:"que...lis"},{ko:"Ï±Ö",fr:"livre"},{ko:"Ïñ¥Î†§ÏõåÏöî",fr:"est difficile"}], part1: "Ï±ÖÏùÄ Ïñ¥Î†§ÏõåÏöî.", part2: "ÏßÄÍ∏à ÏùΩÎäî" },
            { type: 'ko', id: 'ko5', ko: "Ï†ÄÍ∏∞ Ïò§Îäî ÏÇ¨ÎûåÏù¥ Ï†ú ÎèôÏÉùÏù¥ÏóêÏöî.", fr: "La personne qui vient l√†-bas est mon petit fr√®re.", vocab: [{ko:"Ï†ÄÍ∏∞",fr:"l√†-bas"},{ko:"Ïò§Îäî",fr:"qui vient"},{ko:"ÏÇ¨Îûå",fr:"personne"},{ko:"ÎèôÏÉù",fr:"petit fr√®re/s≈ìur"}], part1: "Ï†Ä ÏÇ¨ÎûåÏùÄ Ï†ú ÎèôÏÉùÏù¥ÏóêÏöî.", part2: "Ï†ÄÍ∏∞ Ïò§Îäî" },
            { type: 'ko', id: 'ko6', ko: "Ï†úÍ∞Ä Ï¢ãÏïÑÌïòÎäî Í∞ÄÏàòÎäî BTSÏòàÏöî.", fr: "Le chanteur que j'aime est BTS.", vocab: [{ko:"Ï†úÍ∞Ä",fr:"je"},{ko:"Ï¢ãÏïÑÌïòÎäî",fr:"que j'aime"},{ko:"Í∞ÄÏàò",fr:"chanteur"},{ko:"-Îäî",fr:"particule sujet"}], part1: "Í∞ÄÏàòÎäî BTSÏòàÏöî.", part2: "Ï†úÍ∞Ä Ï¢ãÏïÑÌïòÎäî" },
            { type: 'ko', id: 'ko7', ko: "ÌïôÏÉùÎì§Ïù¥ Í≥µÎ∂ÄÌïòÎäî ÍµêÏã§ÏùÄ Ï°∞Ïö©Ìï¥Ïöî.", fr: "La salle de classe o√π les √©tudiants √©tudient est calme.", vocab: [{ko:"ÌïôÏÉùÎì§",fr:"√©tudiants"},{ko:"Í≥µÎ∂ÄÌïòÎäî",fr:"o√π...√©tudient"},{ko:"ÍµêÏã§",fr:"salle de classe"},{ko:"Ï°∞Ïö©Ìï¥Ïöî",fr:"est calme"}], part1: "ÍµêÏã§ÏùÄ Ï°∞Ïö©Ìï¥Ïöî.", part2: "ÌïôÏÉùÎì§Ïù¥ Í≥µÎ∂ÄÌïòÎäî" },
            { type: 'ko', id: 'ko8', ko: "Í≥†ÏñëÏù¥Í∞Ä ÏûêÎäî ÏÜåÌååÎäî Ìé∏ÏïàÌï¥Ïöî.", fr: "Le canap√© sur lequel le chat dort est confortable.", vocab: [{ko:"Í≥†ÏñëÏù¥",fr:"chat"},{ko:"ÏûêÎäî",fr:"sur lequel...dort"},{ko:"ÏÜåÌåå",fr:"canap√©"},{ko:"Ìé∏ÏïàÌï¥Ïöî",fr:"est confortable"}], part1: "ÏÜåÌååÎäî Ìé∏ÏïàÌï¥Ïöî.", part2: "Í≥†ÏñëÏù¥Í∞Ä ÏûêÎäî" },
            { type: 'ko', id: 'ko9', ko: "Ïö∞Î¶¨Í∞Ä Ïñ¥Ï†ú Î≥∏ ÏòÅÌôîÎäî Ïä¨ÌéêÏñ¥Ïöî.", fr: "Le film que nous avons vu hier √©tait triste.", vocab: [{ko:"Ïö∞Î¶¨",fr:"nous"},{ko:"Ïñ¥Ï†ú",fr:"hier"},{ko:"Î≥∏",fr:"que...avons vu"},{ko:"ÏòÅÌôî",fr:"film"}], part1: "ÏòÅÌôîÎäî Ïä¨ÌéêÏñ¥Ïöî.", part2: "Ïö∞Î¶¨Í∞Ä Ïñ¥Ï†ú Î≥∏" },
            { type: 'ko', id: 'ko10', ko: "ÏóÑÎßàÍ∞Ä ÎßåÎì† ÏºÄÏù¥ÌÅ¨Îäî Îã¨ÏΩ§Ìï¥Ïöî.", fr: "Le g√¢teau que maman a fait est sucr√©.", vocab: [{ko:"ÏóÑÎßà",fr:"maman"},{ko:"ÎßåÎì†",fr:"que...a fait"},{ko:"ÏºÄÏù¥ÌÅ¨",fr:"g√¢teau"},{ko:"Îã¨ÏΩ§Ìï¥Ïöî",fr:"est sucr√©"}], part1: "ÏºÄÏù¥ÌÅ¨Îäî Îã¨ÏΩ§Ìï¥Ïöî.", part2: "ÏóÑÎßàÍ∞Ä ÎßåÎì†" },
            { type: 'ko', id: 'ko11', ko: "ÏïÑÎπ†Í∞Ä ÏÇ¨Ï£ºÏã† ÏûêÏ†ÑÍ±∞Îäî Îπ®ÎùºÏöî.", fr: "Le v√©lo que papa m'a achet√© est rapide.", vocab: [{ko:"ÏïÑÎπ†",fr:"papa"},{ko:"ÏÇ¨Ï£ºÏã†",fr:"que...a achet√©"},{ko:"ÏûêÏ†ÑÍ±∞",fr:"v√©lo"},{ko:"Îπ®ÎùºÏöî",fr:"est rapide"}], part1: "ÏûêÏ†ÑÍ±∞Îäî Îπ®ÎùºÏöî.", part2: "ÏïÑÎπ†Í∞Ä ÏÇ¨Ï£ºÏã†" },
            { type: 'ko', id: 'ko12', ko: "Ï†úÍ∞Ä Îß§Ïùº Îì£Îäî ÎÖ∏ÎûòÍ∞Ä ÏûàÏñ¥Ïöî.", fr: "Il y a une chanson que j'√©coute tous les jours.", vocab: [{ko:"Îß§Ïùº",fr:"tous les jours"},{ko:"Îì£Îäî",fr:"que...√©coute"},{ko:"ÎÖ∏Îûò",fr:"chanson"},{ko:"ÏûàÏñ¥Ïöî",fr:"il y a"}], part1: "ÎÖ∏ÎûòÍ∞Ä ÏûàÏñ¥Ïöî.", part2: "Ï†úÍ∞Ä Îß§Ïùº Îì£Îäî" },
            { type: 'ko', id: 'ko13', ko: "Ïö∞Î¶¨Í∞Ä ÏÇ¥ ÏßëÏùÄ Ïª§Ïöî.", fr: "La maison dans laquelle nous vivrons est grande.", vocab: [{ko:"Ïö∞Î¶¨",fr:"nous"},{ko:"ÏÇ¥",fr:"dans laquelle...vivrons"},{ko:"Ïßë",fr:"maison"},{ko:"Ïª§Ïöî",fr:"est grande"}], part1: "ÏßëÏùÄ Ïª§Ïöî.", part2: "Ïö∞Î¶¨Í∞Ä ÏÇ¥" },
            { type: 'ko', id: 'ko14', ko: "Ï†úÍ∞Ä ÏûÖÏùÑ Ïò∑ÏùÄ ÌååÎûÄÏÉâÏù¥ÏóêÏöî.", fr: "Les v√™tements que je vais porter sont bleus.", vocab: [{ko:"Ï†úÍ∞Ä",fr:"je"},{ko:"ÏûÖÏùÑ",fr:"que...vais porter"},{ko:"Ïò∑",fr:"v√™tements"},{ko:"ÌååÎûÄÏÉâ",fr:"couleur bleue"}], part1: "Ïò∑ÏùÄ ÌååÎûÄÏÉâÏù¥ÏóêÏöî.", part2: "Ï†úÍ∞Ä ÏûÖÏùÑ" },
            { type: 'ko', id: 'ko15', ko: "ÌòïÏù¥ Í∑∏Î¶∞ Í∑∏Î¶ºÏùÄ Î©ãÏûàÏñ¥Ïöî.", fr: "Le dessin que mon grand fr√®re a fait est cool.", vocab: [{ko:"Ìòï",fr:"grand fr√®re"},{ko:"Í∑∏Î¶∞",fr:"que...a fait"},{ko:"Í∑∏Î¶º",fr:"dessin"},{ko:"Î©ãÏûàÏñ¥Ïöî",fr:"est cool"}], part1: "Í∑∏Î¶ºÏùÄ Î©ãÏûàÏñ¥Ïöî.", part2: "ÌòïÏù¥ Í∑∏Î¶∞" },
            { type: 'ko', id: 'ko16', ko: "ÎèôÏÉùÏù¥ Î≥¥Îäî ÎßåÌôîÎäî Ïû¨ÎØ∏ÏûàÏñ¥Ïöî.", fr: "Le dessin anim√© que mon petit fr√®re regarde est amusant.", vocab: [{ko:"ÎèôÏÉù",fr:"petit fr√®re/s≈ìur"},{ko:"Î≥¥Îäî",fr:"que...regarde"},{ko:"ÎßåÌôî",fr:"dessin anim√©"},{ko:"Ïû¨ÎØ∏ÏûàÏñ¥Ïöî",fr:"est amusant"}], part1: "ÎßåÌôîÎäî Ïû¨ÎØ∏ÏûàÏñ¥Ïöî.", part2: "ÎèôÏÉùÏù¥ Î≥¥Îäî" },
            { type: 'ko', id: 'ko17', ko: "Ïö∞Î¶¨Í∞Ä ÎßåÎÇ† ÏãúÍ∞ÑÏùÄ 3ÏãúÏòàÏöî.", fr: "L'heure √† laquelle nous nous rencontrerons est 3 heures.", vocab: [{ko:"ÎßåÎÇ†",fr:"√† laquelle...rencontrerons"},{ko:"ÏãúÍ∞Ñ",fr:"heure"},{ko:"3Ïãú",fr:"3 heures"}], part1: "ÏãúÍ∞ÑÏùÄ 3ÏãúÏòàÏöî.", part2: "Ïö∞Î¶¨Í∞Ä ÎßåÎÇ†" },
            { type: 'ko', id: 'ko18', ko: "Ï†úÍ∞Ä ÏûêÏ£º Í∞ÄÎäî Ïπ¥ÌéòÍ∞Ä ÏûàÏñ¥Ïöî.", fr: "Il y a un caf√© o√π je vais souvent.", vocab: [{ko:"ÏûêÏ£º",fr:"souvent"},{ko:"Í∞ÄÎäî",fr:"o√π...vais"},{ko:"Ïπ¥Ìéò",fr:"caf√©"},{ko:"ÏûàÏñ¥Ïöî",fr:"il y a"}], part1: "Ïπ¥ÌéòÍ∞Ä ÏûàÏñ¥Ïöî.", part2: "Ï†úÍ∞Ä ÏûêÏ£º Í∞ÄÎäî" },
            { type: 'ko', id: 'ko19', ko: "Ï†úÍ∞Ä ÏûÉÏñ¥Î≤ÑÎ¶∞ Ïó¥Ïá†Î•º Ï∞æÏïòÏñ¥Ïöî.", fr: "J'ai trouv√© la cl√© que j'avais perdue.", vocab: [{ko:"ÏûÉÏñ¥Î≤ÑÎ¶∞",fr:"que j'avais perdue"},{ko:"Ïó¥Ïá†",fr:"cl√©"},{ko:"Ï∞æÏïòÏñ¥Ïöî",fr:"j'ai trouv√©"}], part1: "Ïó¥Ïá†Î•º Ï∞æÏïòÏñ¥Ïöî.", part2: "Ï†úÍ∞Ä ÏûÉÏñ¥Î≤ÑÎ¶∞" },
            { type: 'ko', id: 'ko20', ko: "ÏπúÍµ¨Í∞Ä ÎπåÎ†§Ï§Ä Ï±ÖÏùÑ Îã§ ÏùΩÏóàÏñ¥Ïöî.", fr: "J'ai fini de lire le livre que mon ami m'a pr√™t√©.", vocab: [{ko:"ÎπåÎ†§Ï§Ä",fr:"que...a pr√™t√©"},{ko:"Ï±Ö",fr:"livre"},{ko:"Îã§ ÏùΩÏóàÏñ¥Ïöî",fr:"j'ai fini de lire"}], part1: "Ï±ÖÏùÑ Îã§ ÏùΩÏóàÏñ¥Ïöî.", part2: "ÏπúÍµ¨Í∞Ä ÎπåÎ†§Ï§Ä" }
        ];

        let currentQuestions = [];
        const studentData = { name: '', startTime: null, endTime: null, score: 0, total: 30, incorrectAnswers: [], actions: [] };

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            studentData.startTime = new Date();
            studentData.actions = [{ time: new Date(), action: 'start_exercise' }];
            
            let frQuestions = allQuestions.filter(q => q.type === 'fr');
            let koQuestions = allQuestions.filter(q => q.type === 'ko');
            shuffleArray(frQuestions);
            shuffleArray(koQuestions);
            
            currentQuestions = [...frQuestions, ...koQuestions];

            const container1 = document.getElementById('questions-part1');
            const container2 = document.getElementById('questions-part2');
            let html1 = '';
            let html2 = '';
            let questionCounter = 0;

            currentQuestions.forEach((q) => {
                questionCounter++;
                if (q.type === 'fr') {
                    html1 += `
                    <div class="card p-6" id="${q.id}">
                        <p class="text-lg mb-4"><b>Question ${questionCounter}:</b> ${q.sentence}</p>
                        <div class="space-y-3">
                            <div><label class="font-semibold">1Ô∏è‚É£ Premi√®re partie :</label><input type="text" data-part="1" class="mt-1"></div>
                            <div><label class="font-semibold">2Ô∏è‚É£ Deuxi√®me partie :</label><input type="text" data-part="2" class="mt-1"></div>
                        </div>
                    </div>`;
                } else {
                    const vocabHtml = q.vocab.map(v => `<div class="p-2 bg-gray-100 rounded-md text-center"><span class="font-bold">${v.ko}</span><br><span class="text-sm text-gray-600">${v.fr}</span></div>`).join('');
                    html2 += `
                    <div class="card p-6" id="${q.id}">
                        <p class="text-lg mb-4"><b>Question ${questionCounter}:</b> <span class="font-bold text-blue-700">${q.ko}</span></p>
                        <p class="text-sm text-gray-500 italic mb-4">${q.fr}</p>
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2">Vocabulaire :</h4>
                            <div class="vocab-grid">${vocabHtml}</div>
                        </div>
                        <div class="space-y-3">
                            <div><label class="font-semibold">1Ô∏è‚É£ Premi√®re partie (en cor√©en) :</label><input type="text" data-part="1" class="mt-1"></div>
                            <div><label class="font-semibold">2Ô∏è‚É£ Deuxi√®me partie (en cor√©en) :</label><input type="text" data-part="2" class="mt-1"></div>
                        </div>
                    </div>`;
                }
            });
            container1.innerHTML = html1;
            container2.innerHTML = html2;
            document.getElementById('result-container').innerHTML = '';
        }

        function normalizeAnswer(str) {
            return str.replace(/\s+/g, '').replace(/[.?!~,]/g, '').toLowerCase();
        }
        
        function normalizeKoreanAnswer(str) {
             return str.replace(/\s+/g, '').replace(/[.?!~,]/g, '').replace(/Í∑∏ÏÇ¨Îûå/g, 'ÏÇ¨Îûå').replace(/Ï†ÄÏÇ¨Îûå/g, 'ÏÇ¨Îûå');
        }

        function checkAnswers() {
            let correctCount = 0;
            studentData.incorrectAnswers = [];
            
            currentQuestions.forEach(q => {
                const questionDiv = document.getElementById(q.id);
                if (!questionDiv) return;

                const userPart1Input = questionDiv.querySelector('input[data-part="1"]');
                const userPart2Input = questionDiv.querySelector('input[data-part="2"]');
                const userPart1 = userPart1Input.value.trim();
                const userPart2 = userPart2Input.value.trim();

                let isPart1Correct, isPart2Correct;
                let correctAnswerText = '';

                if (q.type === 'fr') {
                    isPart1Correct = normalizeAnswer(userPart1) === normalizeAnswer(q.part1);
                    isPart2Correct = normalizeAnswer(userPart2) === normalizeAnswer(q.part2);
                    correctAnswerText = `1: ${q.part1}, 2: ${q.part2}`;
                } else { // type 'ko'
                    isPart1Correct = normalizeKoreanAnswer(userPart1) === normalizeKoreanAnswer(q.part1);
                    isPart2Correct = normalizeKoreanAnswer(userPart2) === normalizeKoreanAnswer(q.part2);
                    correctAnswerText = `1: ${q.part1}, 2: ${q.part2}`;
                }

                userPart1Input.classList.remove('correct', 'incorrect');
                userPart2Input.classList.remove('correct', 'incorrect');
                userPart1Input.classList.add(isPart1Correct ? 'correct' : 'incorrect');
                userPart2Input.classList.add(isPart2Correct ? 'correct' : 'incorrect');

                if (isPart1Correct && isPart2Correct) {
                    correctCount++;
                } else {
                     studentData.incorrectAnswers.push({
                        questionId: q.id,
                        questionText: q.type === 'fr' ? q.sentence : q.ko,
                        userAnswer: `1: ${userPart1}, 2: ${userPart2}`,
                        correctAnswer: correctAnswerText
                    });
                }
            });

            studentData.score = correctCount;
            displayResult(correctCount, currentQuestions.length);
        }

        function displayResult(score, total) {
            const resultContainer = document.getElementById('result-container');
            const percentage = total > 0 ? (score / total) * 100 : 0;
            let message = '', bgColor = '', textColor = '', resultHTML = '';

            if (percentage === 100) { message = "ÏôÑÎ≤ΩÌï¥Ïöî!! üéâüëëüëç (Parfait !!)"; bgColor = 'bg-green-100'; textColor = 'text-green-800'; }
            else if (percentage >= 80) { message = "ÏûòÌñàÏñ¥Ïöî!! üéâüëç (Bien jou√© !!)"; bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; }
            else if (percentage >= 60) { message = "ÍΩ§ ÏûòÌñàÏñ¥Ïöî. üëç (Assez bien.)"; bgColor = 'bg-yellow-100'; textColor = 'text-yellow-800'; }
            else { message = "Îï°!! ÌãÄÎ†∏Ïñ¥Ïöî!! üò≠ (Incorrect !!)"; bgColor = 'bg-red-100'; textColor = 'text-red-800'; }

            resultHTML = `<div id="result-message" class="${bgColor} ${textColor}">${message}</div>`;
            if (percentage < 100) {
                resultHTML += `<div class="mt-4 p-4 card"><h3 class="font-bold text-lg mb-2">Corrections :</h3><ul class="list-disc list-inside space-y-2">`;
                studentData.incorrectAnswers.forEach(item => {
                    resultHTML += `<li>
                        <strong class="text-gray-700">${item.questionText}</strong><br>
                        <span class="text-red-600">Votre r√©ponse : ${item.userAnswer}</span><br>
                        <span class="text-green-600">R√©ponse correcte : ${item.correctAnswer}</span>
                    </li>`;
                });
                resultHTML += `</ul></div>`;
            }
            resultContainer.innerHTML = resultHTML;
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        document.addEventListener('DOMContentLoaded', generateQuestions);

        document.getElementById('student-name').addEventListener('change', (e) => {
            studentData.name = e.target.value;
            studentData.actions.push({ time: new Date(), action: 'entered_name', value: e.target.value });
        });

        document.getElementById('check-button').addEventListener('click', () => {
            studentData.actions.push({ time: new Date(), action: 'click_check_answers' });
            checkAnswers();
        });

        document.getElementById('retry-button').addEventListener('click', () => {
            studentData.actions.push({ time: new Date(), action: 'click_retry' });
            generateQuestions();
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        });

        document.getElementById('finish-button').addEventListener('click', () => {
            if (!studentData.name) {
                alert("Veuillez entrer votre nom avant de terminer.");
                return;
            }
            checkAnswers(); // Final check before sending
            studentData.endTime = new Date();
            sendResults();
        });

        async function sendResults() {
            const timeTaken = studentData.endTime && studentData.startTime ? (studentData.endTime - studentData.startTime) / 1000 : 0;
            const payload = {
                studentName: studentData.name,
                exercise: "Structure de Phrase (FR/KO)",
                score: studentData.score,
                total: currentQuestions.length,
                timeTaken: Math.round(timeTaken),
                incorrectAnswers: studentData.incorrectAnswers,
                actions: studentData.actions
            };
            
            studentData.actions.push({ time: new Date(), action: 'click_finish_send' });
            console.log("Sending results:", payload);

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    alert("R√©sultats envoy√©s avec succ√®s ! Merci !");
                    document.getElementById('finish-button').disabled = true;
                    document.getElementById('finish-button').innerText = "Envoy√© !";
                } else {
                    throw new Error(`Erreur du serveur: ${await response.text()}`);
                }
            } catch (error) {
                console.error('Failed to send results:', error);
                alert("Une erreur est survenue lors de l'envoi des r√©sultats.");
            }
        }
    </script>
</body>
</html>
