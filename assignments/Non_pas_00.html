<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ìŠµë¬¸ì œ: Aê°€ ì•„ë‹ˆë¼ B (Exercice: Pas A, mais B)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* assets/style.css ì™€ì˜ ì—°ë™ì„ ìœ„í•œ ì¶”ê°€/ìˆ˜ì • ìŠ¤íƒ€ì¼ */
        .text-royal-blue { 
            color: var(--royal-blue); 
        }
        .step-section { 
            display: none; 
        }
        .step-section.active { 
            display: block; 
        }
        /* ì„ íƒëœ ë²„íŠ¼ ìƒ‰ìƒì„ ë¡œì–„ë¸”ë£¨ë¡œ ë³€ê²½í•˜ì—¬ êµ¬ë³„ì´ ì‰½ë„ë¡ í•¨ */
        .choice-btn.selected {
            background-color: var(--royal-blue);
            color: white;
            border-color: var(--gold-leaf);
        }
        /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ê³¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .button:disabled:hover {
            transform: none;
        }
        .hint-box {
            background-color: #f0f8ff;
            border-left: 4px solid var(--royal-blue);
            padding: 12px;
            margin-top: 12px;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="main-container" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-royal-blue">ì—°ìŠµë¬¸ì œ: Aê°€ ì•„ë‹ˆë¼ B ğŸ‘‘</h1>
            <p class="text-lg text-slate-600 mt-2">Exercice de grammaire : "Pas A, mais B"</p>
        </header>

        <!-- Section 0: ì´ë¦„ ì…ë ¥ -->
        <section id="name-section" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-semibold text-royal-blue mb-4">ì‹œì‘í•˜ê¸° ì „ì—, ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”! ğŸš€</h2>
            <p class="text-slate-500 mb-6">Avant de commencer, quel est ton nom ?</p>
            <input type="text" id="student-name" placeholder="ì˜ˆ: ì„¸ë‘ (Ex: CÃ©dou)" class="w-full max-w-sm mx-auto p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-gold transition">
            <button id="start-btn" class="button button-primary w-full max-w-sm mx-auto mt-4">ì‹œì‘! (Commencer !)</button>
        </section>

        <!-- ì—°ìŠµë¬¸ì œ ì»¨í…Œì´ë„ˆ -->
        <div id="exercise-container" class="hidden">
            
            <!-- ë‹¨ê³„ 1: ì½ê³  ì„ íƒí•˜ê¸° -->
            <section id="step-1" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Ã‰tape 1 : Lire et choisir ğŸ¤” (5 questions)</h2>
                <p class="text-slate-500 mb-6">Choisissez la bonne rÃ©ponse pour complÃ©ter la phrase.</p>
                <div id="step-1-questions" class="space-y-8"></div>
            </section>

            <!-- ë‹¨ê³„ 2: ì½ê³  ì“°ê¸° -->
            <section id="step-2" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Ã‰tape 2 : Lire et Ã©crire âœï¸ (5 questions)</h2>
                <p class="text-slate-500 mb-6">Utilisez les mots donnÃ©s pour construire la phrase correcte.</p>
                <div id="step-2-questions" class="space-y-8"></div>
            </section>

            <!-- ë‹¨ê³„ 3: ë“£ê³ , íŒíŠ¸ ë³´ê³ , ë…¹ìŒí•˜ê¸° -->
            <section id="step-3" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Ã‰tape 3 : Ã‰couter, indice et enregistrement ğŸ¤ (5 questions)</h2>
                <p class="text-slate-500 mb-6">Ã‰coutez la phrase, utilisez les indices si besoin, puis enregistrez-vous.</p>
                <div id="step-3-questions" class="space-y-8"></div>
            </section>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
            <div class="flex justify-between mt-8">
                <button id="prev-btn" class="button button-secondary">ì´ì „ (PrÃ©cÃ©dent)</button>
                <button id="next-btn" class="button button-primary">ë‹¤ìŒ (Suivant)</button>
                <button id="finish-btn" class="button button-primary hidden">ëë‚´ê¸° & ê²°ê³¼ ë³´ê¸° (Terminer & voir les rÃ©sultats)</button>
            </div>
        </div>
        
        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section id="result-section" class="hidden bg-white p-8 rounded-xl shadow-lg text-center"></section>

    </div>

    <script src="../assets/grading-criteria.js"></script>
    <script>
        // --- ìƒíƒœ ê´€ë¦¬ (State Management) ---
        const state = {
            studentName: '',
            startTime: null,
            endTime: null,
            currentStep: 0,
            questions: []
        };

        // --- ë¬¸ì œ ì€í–‰ (Question Bank) ---
        const questionBank = {
            choice: [
                { fr: "Je ne suis pas mÃ©decin, je suis professeur.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ì„ ìƒë‹˜ì´ì—ìš”.", choices: ["ì˜ì‚¬ê°€", "í•™ìƒì´", "ìš”ë¦¬ì‚¬ê°€"], answer: "ì˜ì‚¬ê°€" },
                { fr: "Ce n'est pas du pain, c'est du riz.", ko_template: "ì´ê±´ ______ ì•„ë‹ˆë¼ ë°¥ì´ì—ìš”.", choices: ["ë¬¼ì´", "ë¹µì´", "ê³ ê¸°ê°€"], answer: "ë¹µì´" },
                { fr: "Je ne suis pas japonais, je suis corÃ©en.", ko_template: "ì €ëŠ” ì¼ë³¸ ì‚¬ëŒì´ ______ í•œêµ­ ì‚¬ëŒì´ì—ìš”.", choices: ["ì•„ë‹Œë°", "ì•„ë‹ˆë¼", "ì•„ë‹ˆë©´"], answer: "ì•„ë‹ˆë¼" },
                { fr: "Ce n'est pas lundi, c'est mardi.", ko_template: "ì˜¤ëŠ˜ì€ ì›”ìš”ì¼ì´ ______ í™”ìš”ì¼ì´ì—ìš”.", choices: ["ì•„ë‹ˆë¼", "ì•„ë‹ˆì–´ì„œ", "ì•„ë‹™ë‹ˆë‹¤"], answer: "ì•„ë‹ˆë¼" },
                { fr: "Ce n'est pas un chat, c'est un chien.", ko_template: "ì €ê±´ ______ ì•„ë‹ˆë¼ ê°•ì•„ì§€ì˜ˆìš”.", choices: ["ê³ ì–‘ì´ê°€", "ì‚¬ìê°€", "í† ë¼ê°€"], answer: "ê³ ì–‘ì´ê°€" },
                { fr: "Je ne bois pas de soda, je bois de l'eau.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ë¬¼ì„ ë§ˆì…”ìš”.", choices: ["ì£¼ìŠ¤ê°€", "ì½œë¼ê°€", "ìš°ìœ ê°€"], answer: "ì½œë¼ê°€" },
                { fr: "Ce n'est pas l'Ã©tÃ©, c'est l'hiver.", ko_template: "ì§€ê¸ˆì€ ì—¬ë¦„ì´ ______ ê²¨ìš¸ì´ì—ìš”.", choices: ["ì•„ë‹ˆë¼", "ì•„ë‹ˆì–´ë„", "ì•„ë‹ˆì–´ì„œ"], answer: "ì•„ë‹ˆë¼" }
            ],
            write: [
                { fr: "J'aime le cafÃ©, pas le thÃ©.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ì¢‹ì•„í•´ìš”.", words: ["ì»¤í”¼", "ì°¨"], answer: ["ì°¨ê°€", "ì»¤í”¼ë¥¼"] },
                { fr: "J'Ã©tudie le corÃ©en, pas l'anglais.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ê³µë¶€í•´ìš”.", words: ["í•œêµ­ì–´", "ì˜ì–´"], answer: ["ì˜ì–´ê°€", "í•œêµ­ì–´ë¥¼"] },
                { fr: "Je vais Ã  SÃ©oul, pas Ã  Busan.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ê°€ìš”.", words: ["ì„œìš¸", "ë¶€ì‚°"], answer: ["ë¶€ì‚°ì´", "ì„œìš¸ì—"] },
                { fr: "Je mange du Kimchi, pas des ramens.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ë¨¹ì–´ìš”.", words: ["ê¹€ì¹˜", "ë¼ë©´"], answer: ["ë¼ë©´ì´", "ê¹€ì¹˜ë¥¼"] },
                { fr: "J'ai achetÃ© des chaussures, pas un sac.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ìƒ€ì–´ìš”.", words: ["ì‹ ë°œ", "ê°€ë°©"], answer: ["ê°€ë°©ì´", "ì‹ ë°œì„"] },
                { fr: "Je regarde un film, pas un drama.", ko_template: "ì €ëŠ” ______ ì•„ë‹ˆë¼ ______ ë´ìš”.", words: ["ì˜í™”", "ë“œë¼ë§ˆ"], answer: ["ë“œë¼ë§ˆê°€", "ì˜í™”ë¥¼"] },
                { fr: "C'est une pomme, pas une orange.", ko_template: "ì´ê±´ ______ ì•„ë‹ˆë¼ ______ì˜ˆìš”.", words: ["ì‚¬ê³¼", "ì˜¤ë Œì§€"], answer: ["ì˜¤ë Œì§€ê°€", "ì‚¬ê³¼"] }
            ],
            record: [
                { fr: "Ce n'est pas un film, c'est un drama.", ko: "ì´ê±´ ì˜í™”ê°€ ì•„ë‹ˆë¼ ë“œë¼ë§ˆì˜ˆìš”.", hints: [{ fr: "film", ko: "ì˜í™”" }, { fr: "drama", ko: "ë“œë¼ë§ˆ" }] },
                { fr: "Je ne suis pas chinois, je suis franÃ§ais.", ko: "ì €ëŠ” ì¤‘êµ­ ì‚¬ëŒì´ ì•„ë‹ˆë¼ í”„ë‘ìŠ¤ ì‚¬ëŒì´ì—ìš”.", hints: [{ fr: "chinois", ko: "ì¤‘êµ­ ì‚¬ëŒ" }, { fr: "franÃ§ais", ko: "í”„ë‘ìŠ¤ ì‚¬ëŒ" }] },
                { fr: "Je n'aime pas la biÃ¨re, j'aime le soju.", ko: "ì €ëŠ” ë§¥ì£¼ê°€ ì•„ë‹ˆë¼ ì†Œì£¼ë¥¼ ì¢‹ì•„í•´ìš”.", hints: [{ fr: "biÃ¨re", ko: "ë§¥ì£¼" }, { fr: "soju", ko: "ì†Œì£¼" }] },
                { fr: "Ce n'est pas aujourd'hui, c'est demain.", ko: "ì˜¤ëŠ˜ì´ ì•„ë‹ˆë¼ ë‚´ì¼ì´ì—ìš”.", hints: [{ fr: "aujourd'hui", ko: "ì˜¤ëŠ˜" }, { fr: "demain", ko: "ë‚´ì¼" }] },
                { fr: "N'achetez pas Ã§a, achetez ceci.", ko: "ì €ê±° ë§ê³  ì´ê±° ì‚¬ì„¸ìš”.", hints: [{ fr: "Ã§a (lÃ -bas)", ko: "ì €ê±°" }, { fr: "ceci", ko: "ì´ê±°" }] },
                { fr: "Ce n'est pas une question, c'est une rÃ©ponse.", ko: "ì´ê±´ ì§ˆë¬¸ì´ ì•„ë‹ˆë¼ ëŒ€ë‹µì´ì—ìš”.", hints: [{ fr: "question", ko: "ì§ˆë¬¸" }, { fr: "rÃ©ponse", ko: "ëŒ€ë‹µ" }] },
                { fr: "Je ne vais pas au travail, je vais Ã  l'Ã©cole.", ko: "ì €ëŠ” íšŒì‚¬ê°€ ì•„ë‹ˆë¼ í•™êµì— ê°€ìš”.", hints: [{ fr: "travail (entreprise)", ko: "íšŒì‚¬" }, { fr: "Ã©cole", ko: "í•™êµ" }] }
            ]
        };
        
        // --- ìš”ì†Œ ì„ íƒ ---
        const nameSection = document.getElementById('name-section');
        const exerciseContainer = document.getElementById('exercise-container');
        const resultSection = document.getElementById('result-section');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        
        const steps = document.querySelectorAll('.step-section');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');

        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        
        // --- í•¨ìˆ˜ ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            state.questions = [];
            
            shuffleArray(questionBank.choice);
            for(let i = 0; i < 5; i++) {
                state.questions.push({ number: i + 1, type: 'choice', ...questionBank.choice[i], userAnswer: '', isCorrect: false });
            }
            
            shuffleArray(questionBank.write);
            for(let i = 0; i < 5; i++) {
                state.questions.push({ number: i + 6, type: 'write', ...questionBank.write[i], userAnswer: '', isCorrect: false });
            }
            
            shuffleArray(questionBank.record);
            for(let i = 0; i < 5; i++) {
                state.questions.push({ number: i + 11, type: 'record', ...questionBank.record[i], recording: null, hintLevel: 0, hint1Count: 0, hint2Count: 0, listenCount: 0 });
            }
        }
        
        function getChosung(str) {
            const chosung = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            let result = "";
            for (let i = 0; i < str.length; i++) {
                let code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    result += chosung[Math.floor(code / 588)];
                } else {
                    result += str.charAt(i);
                }
            }
            return result;
        }

        function renderStep(stepIndex) {
            const questionsPerStep = 5;
            const start = stepIndex * questionsPerStep;
            const end = start + questionsPerStep;
            const stepQuestions = state.questions.slice(start, end);
            
            const containerId = `step-${stepIndex + 1}-questions`;
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            stepQuestions.forEach((q, index) => {
                const questionIndex = start + index;
                let questionHTML = `<div class="p-4 border rounded-lg bg-slate-50">`;

                if (q.type === 'choice') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> ğŸ‡«ğŸ‡· ${q.fr}</p>
                        <p class="text-lg font-bold mb-4">${q.ko_template}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2" data-question-index="${questionIndex}">
                            ${q.choices.map(choice => `<button class="choice-btn button button-secondary" data-answer="${choice}">${choice}</button>`).join('')}
                        </div>`;
                } else if (q.type === 'write') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> ğŸ‡«ğŸ‡· ${q.fr}</p>
                        <p class="text-slate-600 mb-2">Mots Ã  utiliser : <span class="font-bold text-royal-blue">${q.words.join(', ')}</span></p>
                        <p class="text-lg font-bold mb-2">${q.ko_template}</p>
                        <div class="flex flex-col sm:flex-row gap-2 items-center">
                            <input type="text" class="w-full sm:w-1/2 p-2 border-2 rounded-lg" placeholder="N2+ì´/ê°€" data-question-index="${questionIndex}" data-input-part="0">
                            <input type="text" class="w-full sm:w-1/2 p-2 border-2 rounded-lg" placeholder="N1 + particule (ì„/ë¥¼, ì—...) ou sans" data-question-index="${questionIndex}" data-input-part="1">
                        </div>`;
                } else if (q.type === 'record') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> ğŸ‡«ğŸ‡· ${q.fr}</p>
                        <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center gap-4">
                                <button onclick="playAudio(${questionIndex})" class="button button-primary p-3 rounded-full play-audio-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                                </button>
                                <p class="text-sm text-slate-500">ë¬¸ì¥ ë“£ê¸°<br>(Ã‰couter)</p>
                                <button onclick="handleHintRequest(${questionIndex})" class="button button-secondary p-3 rounded-full hint-btn" id="hint-btn-${questionIndex}">ğŸ’¡</button>
                                <p class="text-sm text-slate-500">íŒíŠ¸ ë³´ê¸°<br>(Indice)</p>
                            </div>
                            <div id="hint-display-${questionIndex}" class="w-full text-center"></div>
                            <div class="flex justify-center items-center gap-4 mt-4">
                                <button onclick="startRecording(${questionIndex})" class="button button-secondary" id="record-btn-${questionIndex}">ğŸ”´ Enregistrer</button>
                                <button onclick="stopRecording(${questionIndex})" class="button button-secondary" id="stop-btn-${questionIndex}" disabled>â¹ï¸ ArrÃªter</button>
                            </div>
                            <p id="recording-status-${questionIndex}" class="mt-2 text-sm text-slate-500">Cliquez pour enregistrer.</p>
                            <audio id="audio-playback-${questionIndex}" controls class="mt-2 mx-auto hidden"></audio>
                        </div>`;
                }
                questionHTML += `</div>`;
                container.innerHTML += questionHTML;
            });
        }
        
        function initializeExercise() {
            state.studentName = studentNameInput.value.trim();
            if (!state.studentName) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom !)"); return; }
            state.startTime = new Date().toISOString();
            generateQuestions();
            nameSection.classList.add('hidden');
            exerciseContainer.classList.remove('hidden');
            showStep(0);
        }

        function showStep(stepIndex) {
            state.currentStep = stepIndex;
            steps.forEach((step, index) => step.classList.toggle('active', index === stepIndex));
            renderStep(stepIndex);
            updateNavButtons();
        }

        function updateNavButtons() {
            prevBtn.disabled = state.currentStep === 0;
            if (state.currentStep === steps.length - 1) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
            }
        }

        function handleChoiceSelection(e) {
            if (!e.target.classList.contains('choice-btn')) return;
            const questionIndex = e.target.parentElement.dataset.questionIndex;
            
            e.target.parentElement.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            state.questions[questionIndex].userAnswer = e.target.dataset.answer;
        }

        function checkAnswers() {
            state.questions.forEach((q, index) => {
                if (q.type === 'choice') {
                    q.isCorrect = q.userAnswer === q.answer;
                } else if (q.type === 'write') {
                    const inputs = document.querySelectorAll(`input[data-question-index="${index}"]`);
                    const userAnswer1 = inputs[0] ? inputs[0].value.trim() : '';
                    const userAnswer2 = inputs[1] ? inputs[1].value.trim() : '';
                    q.userAnswer = `${userAnswer1}, ${userAnswer2}`;
                    q.isCorrect = userAnswer1 === q.answer[0] && userAnswer2 === q.answer[1];
                }
            });
        }
        
               // âœ… ë³€ê²½ëœ playAudio(): Blob URLë¡œ ì¬ìƒ (ë¸Œë¼ìš°ì € í˜¸í™˜ì„±â†‘, data:URL ë¯¸ì‚¬ìš©)
        async function playAudio(questionIndex) {
          const question = state.questions[questionIndex];
          question.listenCount++;
          const textToSpeak = question.ko;
          const btn = document.querySelector(`.play-audio-btn[onclick="playAudio(${questionIndex})"]`);
          btn.disabled = true;
        
          let objectUrl = null;
        
          try {
            const response = await fetch('/.netlify/functions/generate-audio', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: textToSpeak, voice: 'woman' })
            });
        
            if (!response.ok) {
              let errorInfo = `API error: ${response.status} ${response.statusText}`;
              try {
                const errorData = await response.json();
                errorInfo += `\nServer message: ${errorData.error || JSON.stringify(errorData.debug)}`;
              } catch (_) {}
              throw new Error(errorInfo);
            }
        
            const data = await response.json();
            if (!data.audioData || !data.mimeType) {
              throw new Error("Invalid audio data received from server.");
            }
        
            // ğŸ”„ Base64 â†’ Blob â†’ Object URL
            const binary = atob(data.audioData);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            const blob = new Blob([bytes], { type: data.mimeType || 'audio/wav' });
            objectUrl = URL.createObjectURL(blob);
        
            const audio = new Audio(objectUrl);
            audio.onended = () => {
              if (objectUrl) URL.revokeObjectURL(objectUrl);
              btn.disabled = false;
            };
        
            await audio.play();
          } catch (error) {
            console.error('Error fetching or playing audio:', error);
            alert(`ì˜¤ë””ì˜¤ ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:\n(Ã‰chec de la lecture audio:)\n\n${error.message}`);
            if (objectUrl) URL.revokeObjectURL(objectUrl);
            btn.disabled = false;
          }
        }

        function handleHintRequest(questionIndex) {
            const question = state.questions[questionIndex];
            const hintDisplay = document.getElementById(`hint-display-${questionIndex}`);
            question.hintLevel++;

            if (question.hintLevel === 1) {
                question.hint1Count++;
                const chosungHint = getChosung(question.ko);
                hintDisplay.innerHTML = `<div class="hint-box"><strong>Indice 1 (ì´ˆì„±):</strong> ${chosungHint}</div>`;
            } else if (question.hintLevel === 2) {
                question.hint2Count++;
                const vocabHint = question.hints.map(h => `${h.fr}: ${h.ko}`).join(', ');
                hintDisplay.innerHTML += `<div class="hint-box mt-2"><strong>Indice 2 (ë‹¨ì–´):</strong> ${vocabHint}</div>`;
                document.getElementById(`hint-btn-${questionIndex}`).disabled = true;
            }
        }
        
        async function startRecording(questionIndex) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                mediaRecorder.onstop = () => {
                    const duration = (new Date() - recordingStartTime) / 1000;
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const playbackEl = document.getElementById(`audio-playback-${questionIndex}`);
                    playbackEl.src = audioUrl;
                    playbackEl.classList.remove('hidden');

                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        state.questions[questionIndex].recording = {
                            base64: reader.result.split(',')[1],
                            filename: `recording_q${questionIndex}_${state.studentName.replace(/\s/g, '_')}.webm`,
                            mimeType: 'audio/webm',
                            duration: duration.toFixed(2)
                        };
                    };
                };
                
                recordingStartTime = new Date();
                mediaRecorder.start();
                document.getElementById(`recording-status-${questionIndex}`).textContent = "ë…¹ìŒ ì¤‘...";
                document.getElementById(`record-btn-${questionIndex}`).disabled = true;
                document.getElementById(`stop-btn-${questionIndex}`).disabled = false;
            } catch (err) {
                document.getElementById(`recording-status-${questionIndex}`).textContent = "ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
        }

        function stopRecording(questionIndex) {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                document.getElementById(`recording-status-${questionIndex}`).textContent = "ë…¹ìŒ ì™„ë£Œ!";
                document.getElementById(`record-btn-${questionIndex}`).disabled = false;
                document.getElementById(`stop-btn-${questionIndex}`).disabled = true;
            }
        }
        
        async function finishExercise() {
            checkAnswers();
            state.endTime = new Date().toISOString();
            
            const payload = {
                studentName: state.studentName,
                startTime: state.startTime,
                endTime: state.endTime,
                totalTimeSeconds: Math.round((new Date(state.endTime) - new Date(state.startTime)) / 1000),
                questions: state.questions
            };

            displayResults(payload);

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                 if (!response.ok) {
                    console.error('Failed to send results:', await response.text());
                }
            } catch (error) { console.error("Error sending results:", error); }
        }

        function displayResults(payload) {
            exerciseContainer.classList.add('hidden');
            resultSection.classList.remove('hidden');

            const correctCount = payload.questions.filter(q => q.isCorrect).length;
            const totalGraded = payload.questions.filter(q => q.type !== 'record').length;
            const score = totalGraded > 0 ? Math.round((correctCount / totalGraded) * 100) : 100;
            const { message, frMessage, emoji } = getGradingMessage(score);

            let resultHTML = `
                <h2 class="text-3xl font-bold text-royal-blue mb-2">${state.studentName}, ìˆ˜ê³ í–ˆì–´ìš”!</h2>
                <p class="text-2xl mb-2">${emoji} ${message}</p>
                <p class="text-lg text-slate-600 mb-6">${frMessage}</p>
                <div class="text-left bg-slate-50 p-6 rounded-lg max-h-96 overflow-y-auto">`;

            payload.questions.filter(q => q.type !== 'record').forEach(q => {
                resultHTML += `<div class="mb-4 pb-4 border-b">
                    <p class="font-semibold text-lg">Question ${q.number}: ${q.fr}</p>`;
                if (q.isCorrect) {
                    resultHTML += `<p class="text-green-600">âœ”ï¸ ì œì¶œ ë‹µì•ˆ (Votre rÃ©ponse) : ${q.userAnswer.split(', ').join(', ')}</p>`;
                } else {
                     const userAnswers = q.userAnswer.split(', ');
                     const correctAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
                     let comparisonHTML = q.ko_template.replace('______', `<span class="text-red-600">${userAnswers[0] || '...'}</span>`);
                     if (userAnswers.length > 1) {
                        comparisonHTML = comparisonHTML.replace('______', `<span class="text-red-600">${userAnswers[1] || '...'}</span>`);
                     }

                    resultHTML += `
                        <p class="text-red-600">âŒ ì œì¶œ ë‹µì•ˆ (Votre rÃ©ponse) : ${comparisonHTML}</p>
                        <p class="text-blue-600">ğŸ’¡ ì •ë‹µ (RÃ©ponse correcte) : ${q.ko_template.replace('______', correctAnswers[0]).replace('______', correctAnswers[1] || '')}</p>
                        <p class="mt-1 text-sm text-orange-500">${comparisonMessage.ko}</p>
                        <p class="mt-1 text-sm text-orange-400">${comparisonMessage.fr}</p>`;
                }
                resultHTML += `</div>`;
            });
            
            payload.questions.filter(q => q.type === 'record').forEach(q => {
                 resultHTML += `<div class="mb-4 pb-4 border-b">
                    <p class="font-semibold text-lg">Question ${q.number}: ${q.fr}</p>
                    <p class="text-blue-600">ğŸ’¡ ì •ë‹µ (RÃ©ponse correcte) : ${q.ko}</p>
                 </div>`;
            });

            resultHTML += `</div>
                <div class="mt-8 flex justify-center gap-4">
                    <a href="/" class="button button-secondary">í™ˆìœ¼ë¡œ (Accueil)</a>
                    <button onclick="location.reload()" class="button button-primary">ë‹¤ì‹œí•˜ê¸° (Recommencer)</button>
                </div>`;
            resultSection.innerHTML = resultHTML;
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        startBtn.addEventListener('click', initializeExercise);
        prevBtn.addEventListener('click', () => { if (state.currentStep > 0) showStep(state.currentStep - 1); });
        nextBtn.addEventListener('click', () => { if (state.currentStep < steps.length - 1) showStep(state.currentStep + 1); });
        finishBtn.addEventListener('click', finishExercise);
        
        document.getElementById('step-1-questions').addEventListener('click', handleChoiceSelection);

    </script>
</body>
</html>
