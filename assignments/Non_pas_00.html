<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연습문제: A가 아니라 B (Exercice: Pas A, mais B)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .step-section { display: none; }
        .step-section.active { display: block; }
        .choice-btn { transition: all 0.2s ease-in-out; }
        .choice-btn.selected {
            background-color: #FFD700; /* gold */
            color: #000080; /* royalblue */
            border-color: #000080;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <div id="main-container" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-royal-blue">연습문제: A가 아니라 B 👑</h1>
            <p class="text-lg text-slate-600 mt-2">Exercice de grammaire : "Pas A, mais B"</p>
        </header>

        <!-- Section 0: 이름 입력 -->
        <section id="name-section" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-semibold text-royal-blue mb-4">시작하기 전에, 이름을 알려주세요! 🚀</h2>
            <p class="text-slate-500 mb-6">Avant de commencer, quel est ton nom ?</p>
            <input type="text" id="student-name" placeholder="예: 세두 (Ex: Cédou)" class="w-full max-w-sm mx-auto p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-gold transition">
            <button id="start-btn" class="btn-primary w-full max-w-sm mx-auto mt-4">시작! (Commencer !)</button>
        </section>

        <!-- 연습문제 컨테이너 -->
        <div id="exercise-container" class="hidden">
            
            <!-- 단계 1: 읽고 선택하기 -->
            <section id="step-1" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Étape 1 : Lire et choisir 🤔 (5 questions)</h2>
                <p class="text-slate-500 mb-6">Choisissez la bonne réponse pour compléter la phrase.</p>
                <div id="step-1-questions" class="space-y-8"></div>
            </section>

            <!-- 단계 2: 읽고 쓰기 -->
            <section id="step-2" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Étape 2 : Lire et écrire ✍️ (5 questions)</h2>
                <p class="text-slate-500 mb-6">Utilisez les mots donnés pour construire la phrase correcte.</p>
                <div id="step-2-questions" class="space-y-8"></div>
            </section>

            <!-- 단계 3: 듣고 녹음하기 -->
            <section id="step-3" class="step-section bg-white p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-royal-blue mb-1">Étape 3 : Écouter et enregistrer 🎤 (5 questions)</h2>
                <p class="text-slate-500 mb-6">Écoutez la phrase, puis enregistrez votre prononciation.</p>
                <div id="step-3-questions" class="space-y-8"></div>
            </section>

            <!-- 네비게이션 버튼 -->
            <div class="flex justify-between mt-8">
                <button id="prev-btn" class="btn-secondary">이전 (Précédent)</button>
                <button id="next-btn" class="btn-primary">다음 (Suivant)</button>
                <button id="finish-btn" class="btn-finish hidden">끝내기 & 결과 보기 (Terminer & voir les résultats)</button>
            </div>
        </div>
        
        <!-- 결과 섹션 -->
        <section id="result-section" class="hidden bg-white p-8 rounded-xl shadow-lg text-center"></section>

    </div>

    <script src="../assets/grading-criteria.js"></script>
    <script>
        // --- 상태 관리 (State Management) ---
        const state = {
            studentName: '',
            startTime: null,
            endTime: null,
            currentStep: 0,
            questions: []
        };

        // --- 문제 은행 (Question Bank) ---
        const questionBank = {
            choice: [
                { fr: "Je ne suis pas médecin, je suis professeur.", ko_template: "저는 ______ 아니라 선생님이에요.", choices: ["의사가", "학생이", "요리사가"], answer: "의사가" },
                { fr: "Ce n'est pas du pain, c'est du riz.", ko_template: "이건 ______ 아니라 밥이에요.", choices: ["물이", "빵이", "고기가"], answer: "빵이" },
                { fr: "Je ne suis pas japonais, je suis coréen.", ko_template: "저는 일본 사람이 ______ 한국 사람이에요.", choices: ["아닌데", "아니라", "아니면"], answer: "아니라" },
                // 수정됨: '아니지만'을 '아니어서'로 변경
                { fr: "Ce n'est pas lundi, c'est mardi.", ko_template: "오늘은 월요일이 ______ 화요일이에요.", choices: ["아니라", "아니어서", "아닙니다"], answer: "아니라" },
                { fr: "Ce n'est pas un chat, c'est un chien.", ko_template: "저건 ______ 아니라 강아지예요.", choices: ["고양이가", "사자가", "토끼가"], answer: "고양이가" },
                { fr: "Je ne bois pas de soda, je bois de l'eau.", ko_template: "저는 ______ 아니라 물을 마셔요.", choices: ["주스가", "콜라가", "우유가"], answer: "콜라가" },
                // 수정됨: '아니지만'을 '아니어도'로 변경
                { fr: "Ce n'est pas l'été, c'est l'hiver.", ko_template: "지금은 여름이 ______ 겨울이에요.", choices: ["아니라", "아니어도", "아니어서"], answer: "아니라" }
            ],
            write: [
                { fr: "J'aime le café, pas le thé.", ko_template: "저는 ______ 아니라 ______ 좋아해요.", words: ["커피", "차"], answer: ["차가", "커피를"] },
                { fr: "J'étudie le coréen, pas l'anglais.", ko_template: "저는 ______ 아니라 ______ 공부해요.", words: ["한국어", "영어"], answer: ["영어가", "한국어를"] },
                { fr: "Je vais à Séoul, pas à Busan.", ko_template: "저는 ______ 아니라 ______ 가요.", words: ["서울", "부산"], answer: ["부산이", "서울에"] },
                { fr: "Je mange du Kimchi, pas des ramens.", ko_template: "저는 ______ 아니라 ______ 먹어요.", words: ["김치", "라면"], answer: ["라면이", "김치를"] },
                { fr: "J'ai acheté des chaussures, pas un sac.", ko_template: "저는 ______ 아니라 ______ 샀어요.", words: ["신발", "가방"], answer: ["가방이", "신발을"] },
                { fr: "Je regarde un film, pas un drama.", ko_template: "저는 ______ 아니라 ______ 봐요.", words: ["영화", "드라마"], answer: ["드라마가", "영화를"] },
                { fr: "C'est une pomme, pas une orange.", ko_template: "이건 ______ 아니라 ______예요.", words: ["사과", "오렌지"], answer: ["오렌지가", "사과"] }
            ],
            record: [
                { fr: "Ce n'est pas un film, c'est un drama.", ko: "이건 영화가 아니라 드라마예요." },
                { fr: "Je ne suis pas chinois, je suis français.", ko: "저는 중국 사람이 아니라 프랑스 사람이에요." },
                { fr: "Je n'aime pas la bière, j'aime le soju.", ko: "저는 맥주가 아니라 소주를 좋아해요." },
                { fr: "Ce n'est pas aujourd'hui, c'est demain.", ko: "오늘이 아니라 내일이에요." },
                { fr: "N'achetez pas ça, achetez ceci.", ko: "저거 말고 이거 사세요." },
                { fr: "Ce n'est pas une question, c'est une réponse.", ko: "이건 질문이 아니라 대답이에요." },
                { fr: "Je ne vais pas au travail, je vais à l'école.", ko: "저는 회사가 아니라 학교에 가요." }
            ]
        };
        
        // --- 요소 선택 ---
        const nameSection = document.getElementById('name-section');
        const exerciseContainer = document.getElementById('exercise-container');
        const resultSection = document.getElementById('result-section');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        
        const steps = document.querySelectorAll('.step-section');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');

        let mediaRecorder;
        let audioChunks = [];
        
        // --- 함수 ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            state.questions = [];
            
            // Step 1: 5 choice questions
            shuffleArray(questionBank.choice);
            for(let i = 0; i < 5; i++) {
                const q = questionBank.choice[i];
                state.questions.push({
                    number: i + 1, type: 'choice', ...q, userAnswer: '', isCorrect: false
                });
            }
            
            // Step 2: 5 write questions
            shuffleArray(questionBank.write);
            for(let i = 0; i < 5; i++) {
                const q = questionBank.write[i];
                state.questions.push({
                    number: i + 6, type: 'write', ...q, userAnswer: '', isCorrect: false
                });
            }
            
            // Step 3: 5 record questions
            shuffleArray(questionBank.record);
            for(let i = 0; i < 5; i++) {
                const q = questionBank.record[i];
                state.questions.push({
                    number: i + 11, type: 'record', ...q, recording: null, listenCount: 0
                });
            }
        }

        function renderStep(stepIndex) {
            const questionsPerStep = 5;
            const start = stepIndex * questionsPerStep;
            const end = start + questionsPerStep;
            const stepQuestions = state.questions.slice(start, end);
            
            const containerId = `step-${stepIndex + 1}-questions`;
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            stepQuestions.forEach((q, index) => {
                const questionIndex = start + index;
                let questionHTML = `<div class="p-4 border rounded-lg bg-slate-50">`;

                if (q.type === 'choice') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> 🇫🇷 ${q.fr}</p>
                        <p class="text-lg font-bold mb-4">${q.ko_template}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2" data-question-index="${questionIndex}">
                            ${q.choices.map(choice => `<button class="choice-btn btn-secondary" data-answer="${choice}">${choice}</button>`).join('')}
                        </div>`;
                } else if (q.type === 'write') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> 🇫🇷 ${q.fr}</p>
                        <p class="text-slate-600 mb-2">Mots à utiliser : <span class="font-bold text-royal-blue">${q.words.join(', ')}</span></p>
                        <p class="text-lg font-bold mb-2">${q.ko_template}</p>
                        <div class="flex flex-col sm:flex-row gap-2 items-center">
                            <input type="text" class="w-full sm:w-1/2 p-2 border-2 rounded-lg" placeholder="N2+이/가" data-question-index="${questionIndex}" data-input-part="0">
                            <input type="text" class="w-full sm:w-1/2 p-2 border-2 rounded-lg" placeholder="N1 + particule (을/를, 에...) ou sans" data-question-index="${questionIndex}" data-input-part="1">
                        </div>`;
                } else if (q.type === 'record') {
                    questionHTML += `
                        <p class="text-md mb-2"><strong>Q${q.number}.</strong> 🇫🇷 ${q.fr}</p>
                        <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center gap-4">
                                <button onclick="playAudio(${questionIndex})" class="btn-primary p-3 rounded-full play-audio-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                                </button>
                                <p class="text-sm text-slate-500">버튼을 클릭해서 들어보세요.<br>(Cliquez pour écouter)</p>
                            </div>
                            <p id="q-sentence-${questionIndex}" class="text-lg font-bold text-slate-700 hidden">${q.ko}</p>
                            <div class="flex justify-center items-center gap-4">
                                <button onclick="startRecording(${questionIndex})" class="btn-record" id="record-btn-${questionIndex}">🔴 Enregistrer</button>
                                <button onclick="stopRecording(${questionIndex})" class="btn-secondary" id="stop-btn-${questionIndex}" disabled>⏹️ Arrêter</button>
                            </div>
                            <p id="recording-status-${questionIndex}" class="mt-2 text-sm text-slate-500">Cliquez pour enregistrer.</p>
                            <audio id="audio-playback-${questionIndex}" controls class="mt-2 mx-auto hidden"></audio>
                        </div>`;
                }
                questionHTML += `</div>`;
                container.innerHTML += questionHTML;
            });
        }
        
        function initializeExercise() {
            state.studentName = studentNameInput.value.trim();
            if (!state.studentName) { alert("이름을 입력해주세요! (Veuillez entrer votre nom !)"); return; }
            state.startTime = new Date().toISOString();
            generateQuestions();
            nameSection.classList.add('hidden');
            exerciseContainer.classList.remove('hidden');
            showStep(0);
        }

        function showStep(stepIndex) {
            state.currentStep = stepIndex;
            steps.forEach((step, index) => step.classList.toggle('active', index === stepIndex));
            renderStep(stepIndex);
            updateNavButtons();
        }

        function updateNavButtons() {
            prevBtn.disabled = state.currentStep === 0;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            if (state.currentStep === steps.length - 1) {
                nextBtn.classList.add('hidden');
                finishBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                finishBtn.classList.add('hidden');
            }
        }

        function handleChoiceSelection(e) {
            if (!e.target.classList.contains('choice-btn')) return;
            const questionIndex = e.target.parentElement.dataset.questionIndex;
            
            e.target.parentElement.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            state.questions[questionIndex].userAnswer = e.target.dataset.answer;
        }

        function checkAnswers() {
            state.questions.forEach((q, index) => {
                if (q.type === 'choice') {
                    q.isCorrect = q.userAnswer === q.answer;
                } else if (q.type === 'write') {
                    const inputs = document.querySelectorAll(`input[data-question-index="${index}"]`);
                    const userAnswer1 = inputs[0] ? inputs[0].value.trim() : '';
                    const userAnswer2 = inputs[1] ? inputs[1].value.trim() : '';
                    q.userAnswer = `${userAnswer1}, ${userAnswer2}`;
                    q.isCorrect = userAnswer1 === q.answer[0] && userAnswer2 === q.answer[1];
                }
            });
        }

        async function playAudio(questionIndex) {
            const question = state.questions[questionIndex];
            question.listenCount++;
            const textToSpeak = question.ko;
            const btn = document.querySelector(`.play-audio-btn[onclick="playAudio(${questionIndex})"]`);
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: textToSpeak, voice: 'woman' })
                });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const data = await response.json();
                const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
                audio.play();
                document.getElementById(`q-sentence-${questionIndex}`).classList.remove('hidden');
                audio.onended = () => {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                };
            } catch (error) {
                console.error('Error playing audio:', error);
                document.getElementById(`recording-status-${questionIndex}`).textContent = "오디오 재생 실패.";
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }
        
        async function startRecording(questionIndex) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById(`audio-playback-${questionIndex}`).src = audioUrl;
                    document.getElementById(`audio-playback-${questionIndex}`).classList.remove('hidden');

                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        state.questions[questionIndex].recording = {
                            base64: reader.result.split(',')[1],
                            filename: `recording_q${questionIndex}_${state.studentName.replace(/\s/g, '_')}.webm`,
                            mimeType: 'audio/webm'
                        };
                    };
                };

                mediaRecorder.start();
                document.getElementById(`recording-status-${questionIndex}`).textContent = "녹음 중...";
                document.getElementById(`record-btn-${questionIndex}`).disabled = true;
                document.getElementById(`stop-btn-${questionIndex}`).disabled = false;
            } catch (err) {
                document.getElementById(`recording-status-${questionIndex}`).textContent = "마이크 권한을 확인해주세요.";
            }
        }

        function stopRecording(questionIndex) {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                document.getElementById(`recording-status-${questionIndex}`).textContent = "녹음 완료!";
                document.getElementById(`record-btn-${questionIndex}`).disabled = false;
                document.getElementById(`stop-btn-${questionIndex}`).disabled = true;
            }
        }
        
        async function finishExercise() {
            checkAnswers();
            state.endTime = new Date().toISOString();
            
            const payload = {
                studentName: state.studentName,
                startTime: state.startTime,
                endTime: state.endTime,
                totalTimeSeconds: (new Date(state.endTime) - new Date(state.startTime)) / 1000,
                questions: state.questions
            };

            displayResults(payload);

            try {
                await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (error) { console.error("Error sending results:", error); }
        }

        function displayResults(payload) {
            exerciseContainer.classList.add('hidden');
            resultSection.classList.remove('hidden');

            const correctCount = payload.questions.filter(q => q.isCorrect).length;
            const totalGraded = payload.questions.filter(q => q.type !== 'record').length;
            const score = totalGraded > 0 ? (correctCount / totalGraded) * 100 : 100;
            const { message, frMessage, emoji } = getGradingMessage(score);

            let resultHTML = `
                <h2 class="text-3xl font-bold text-royal-blue mb-2">${state.studentName}, 수고했어요!</h2>
                <p class="text-2xl mb-4">${emoji} ${message}</p>
                <p class="text-lg text-slate-600 mb-6">${frMessage}</p>
                <div class="text-left bg-slate-50 p-6 rounded-lg max-h-96 overflow-y-auto">`;

            payload.questions.filter(q => q.type !== 'record').forEach(q => {
                resultHTML += `<div class="mb-4 pb-4 border-b">
                    <p class="font-semibold text-lg">Question ${q.number}: ${q.fr}</p>`;
                if (q.isCorrect) {
                    resultHTML += `<p class="text-green-600">✔️ 정답 (Correct) : ${Array.isArray(q.answer) ? q.answer.join(', ') : q.answer}</p>`;
                } else {
                     const userAnswers = q.userAnswer.split(', ');
                     const correctAnswers = Array.isArray(q.answer) ? q.answer : [q.answer];
                     let comparisonHTML = q.ko_template.replace('______', `<span class="text-red-600">${userAnswers[0] || '...'}</span>`);
                     if (userAnswers.length > 1) {
                        comparisonHTML = comparisonHTML.replace('______', `<span class="text-red-600">${userAnswers[1] || '...'}</span>`);
                     }

                    resultHTML += `
                        <p class="text-red-600">❌ 제출 답안 (Votre réponse) : ${comparisonHTML}</p>
                        <p class="text-blue-600">💡 정답 (Réponse correcte) : ${q.ko_template.replace('______', correctAnswers[0]).replace('______', correctAnswers[1] || '')}</p>
                        <p class="mt-1 text-sm text-orange-500">여기는 살짝 삐끗 😅 → 이렇게 하면 완벽!</p>`;
                }
                resultHTML += `</div>`;
            });

            resultHTML += `</div>
                <div class="mt-8 flex justify-center gap-4">
                    <a href="/" class="btn-secondary">홈으로 (Accueil)</a>
                    <button onclick="window.print()" class="btn-secondary">결과 인쇄 (Imprimer)</button>
                </div>`;
            resultSection.innerHTML = resultHTML;
        }

        // --- 이벤트 리스너 ---
        startBtn.addEventListener('click', initializeExercise);
        prevBtn.addEventListener('click', () => { if (state.currentStep > 0) showStep(state.currentStep - 1); });
        nextBtn.addEventListener('click', () => { if (state.currentStep < steps.length - 1) showStep(state.currentStep + 1); });
        finishBtn.addEventListener('click', finishExercise);
        
        document.getElementById('step-1-questions').addEventListener('click', handleChoiceSelection);

    </script>
</body>
</html>
