<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ì—°ìŠµ: í›„ì— / ì „ì—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; background-color: #f8fafc; }
        .made-by-top, .made-by-bottom { text-align: center; padding: 8px; font-size: 0.8rem; color: #64748b; background-color: #f1f5f9; }
        .made-by-top { border-bottom: 1px solid #e2e8f0; }
        .made-by-bottom { border-top: 1px solid #e2e8f0; margin-top: 40px; }
        .print-button-container { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .btn { display: flex; align-items: center; justify-content: center; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; padding: 0.75rem 1.5rem; }
        .btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #3730a3; }
        .btn-secondary { background-color: #e0e7ff; color: #3730a3; padding: 0.5rem 1rem; }
        .btn-secondary:hover:not(:disabled) { background-color: #c7d2fe; }
        .btn-choice { border: 2px solid #e5e7eb; width: 100%; justify-content: flex-start; text-align: left; padding: 1rem; font-size: 1.125rem; }
        .btn-choice:hover { border-color: #facc15; background-color: #fef9c3; }
        .btn-choice.selected { border-color: #fbbf24; background-color: #fef08a; }
        .btn-hint { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-record { background-color: #ef4444; color: white; }
        .btn-record.recording { background-color: #10b981; }
        .invisible { visibility: hidden; }
        .section-title { font-size: 1.5rem; font-weight: bold; color: #1e293b; border-bottom: 2px solid #cbd5e1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        @media print { .no-print { display: none !important; } main { box-shadow: none !important; padding: 0 !important; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="made-by-top no-print">Made with â¤ï¸ by ì„±ì¼, Pongdang</div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Exercice CorÃ©en : AprÃ¨s / Avant</h1>
            <p class="text-md text-slate-600 mt-2">N + í›„ì— / R+(ìœ¼)ã„´ í›„ì— / R+ê¸° ì „ì—</p>
        </header>

        <div class="print-button-container no-print">
            <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm2 5h6v1H7V9zm0 2h6v1H7v-1z" clip-rule="evenodd" /></svg>
                Imprimer / í”„ë¦°íŠ¸
            </button>
        </div>

        <div id="start-screen" class="text-center">
            <input type="text" id="student-name" class="w-full max-w-sm p-3 border-2 border-slate-300 rounded-lg text-center text-lg focus:border-purple-500 focus:ring focus:ring-purple-200 transition" placeholder="í•™ìƒ ì´ë¦„ì´ ê¶ê¸ˆí•´ìš”! (Ton nom)">
            <button id="start-btn" class="mt-4 w-full max-w-sm bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transform hover:scale-105 transition">
                ì‹œì‘! (Commencer)
            </button>
        </div>

        <main id="quiz-container" class="hidden"></main>

        <div id="result-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl max-w-2xl mx-auto no-print">
             <h2 class="text-3xl font-bold mb-4">ğŸ‰ Bravo ! ğŸ‰</h2>
             <p id="result-message" class="text-lg text-slate-700 mb-6"></p>
             
             <div class="flex justify-center space-x-4 mt-8">
                <button id="retry-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">
                    ë‹¤ì‹œí•˜ê¸° (Recommencer)
                </button>
             </div>
        </div>
    </div>
    
    <div class="made-by-bottom no-print">Made with â¤ï¸ by ì„±ì¼, Pongdang</div>

    <script>
        function getGradingMessage(percentage, lang = 'ko') {
            if (lang === 'fr') {
                if (percentage >= 100) return "Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !";
                if (percentage >= 80) return "TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !";
                if (percentage >= 60) return "Pas mal du tout ! ğŸ˜ Encore un petit effort et câ€™est le top !";
                return "Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª";
            }
            if (percentage >= 100) return "ì™„ë²½ ê·¸ ìì²´! ğŸ‘‘ğŸ‰ ì²œì¬ ì¸ì¦!";
            if (percentage >= 80) return "ì•„ì£¼ ì˜í–ˆì–´ìš”! ğŸ‘ ì´ ì •ë„ë©´ ê±°ì˜ ë§ˆìŠ¤í„°!";
            if (percentage >= 60) return "ê½¤ ì˜í–ˆì–´ìš”! ğŸ˜ ì¡°ê¸ˆë§Œ ë” ê°€ë©´ ìµœê³ !";
            return "ì, ì»¤í”¼ í•œ ì” í•˜ê³  ë‹¤ì‹œ ê°€ì! â˜•ğŸ’ªğŸ‡°ğŸ‡·";
        }

        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        const retryBtn = document.getElementById('retry-btn');

        let studentName = '', startTime, endTime;
        let currentQuestionIndex = 0;
        let questionsData = [], quizData = [];
        let mediaRecorder, audioChunks = [];

        studentNameInput.placeholder = ["Super CÃ©dou", "GÃ©nie Julie", "Champion LÃ©o", "Star Alice"][Math.floor(Math.random() * 4)];

        // [FIXED] Changed data structure to prevent duplicate choices.
        const verbPairs = [
            { base: 'ë°¥ì„ ë¨¹ë‹¤', verb: 'Manger', afterForm: 'ë¨¹ì€ í›„ì—', beforeForm: 'ë¨¹ê¸° ì „ì—' },
            { base: 'ìˆ™ì œë¥¼ í•˜ë‹¤', verb: 'Faire les devoirs', afterForm: 'í•œ í›„ì—', beforeForm: 'í•˜ê¸° ì „ì—' },
            { base: 'ì˜í™”ë¥¼ ë³´ë‹¤', verb: 'Regarder un film', afterForm: 'ë³¸ í›„ì—', beforeForm: 'ë³´ê¸° ì „ì—' },
            { base: 'ì±…ì„ ì½ë‹¤', verb: 'Lire un livre', afterForm: 'ì½ì€ í›„ì—', beforeForm: 'ì½ê¸° ì „ì—' },
            { base: 'ìš´ë™ì„ í•˜ë‹¤', verb: 'Faire du sport', afterForm: 'ìš´ë™í•œ í›„ì—', beforeForm: 'ìš´ë™í•˜ê¸° ì „ì—' },
            { base: 'ì ì„ ìë‹¤', verb: 'Dormir', afterForm: 'ì” í›„ì—', beforeForm: 'ìê¸° ì „ì—' },
            { base: 'ìˆ˜ì—…ì— ë“¤ì–´ê°€ë‹¤', verb: 'Entrer en classe', afterForm: 'ë“¤ì–´ê°„ í›„ì—', beforeForm: 'ë“¤ì–´ê°€ê¸° ì „ì—' },
            { base: 'ì†ì„ ì”»ë‹¤', verb: 'Se laver les mains', afterForm: 'ì”»ì€ í›„ì—', beforeForm: 'ì”»ê¸° ì „ì—' },
            { base: 'ë°–ìœ¼ë¡œ ë‚˜ê°€ë‹¤', verb: 'Sortir', afterForm: 'ë‚˜ê°„ í›„ì—', beforeForm: 'ë‚˜ê°€ê¸° ì „ì—' },
            { base: 'ì»¤í”¼ë¥¼ ë§ˆì‹œë‹¤', verb: 'Boire du cafÃ©', afterForm: 'ë§ˆì‹  í›„ì—', beforeForm: 'ë§ˆì‹œê¸° ì „ì—' }
        ];

        const sentencePool = [
            { fr: "AprÃ¨s avoir fini le travail, je suis rentrÃ© chez moi.", ko: "ì¼ì„ ëë‚¸ í›„ì— ì§‘ì— ëŒì•„ì™”ì–´ìš”.", hint1: "ã…‡ã…‡ ã„²ã„´ ã…ã…‡ ã…ˆã…‡ ã„·ã…‡ã…‡ã…‡ã…‡.", hint2: "ì¼(travail), ëë‚´ë‹¤(finir), ì§‘(maison)"},
            { fr: "Avant de sortir, jâ€™ai pris mon parapluie.", ko: "ë‚˜ê°€ê¸° ì „ì— ìš°ì‚°ì„ ì±™ê²¼ì–´ìš”.", hint1: "ã„´ã„±ã„± ã…ˆã…‡ ã…‡ã……ã…‡ ã…Šã„±ã…‡ã…‡.", hint2: "ë‚˜ê°€ë‹¤(sortir), ìš°ì‚°(parapluie), ì±™ê¸°ë‹¤(prendre)"},
            { fr: "AprÃ¨s avoir regardÃ© le film, jâ€™ai dormi.", ko: "ì˜í™”ë¥¼ ë³¸ í›„ì— ì ì„ ì¤ì–´ìš”.", hint1: "ã…‡ã…ã„¹ ã…‚ ã…ã…‡ ã…ˆã…‡ ã…ˆã…‡ã…‡.", hint2: "ì˜í™”(film), ë³´ë‹¤(regarder), ì ì„ ìë‹¤(dormir)"},
            { fr: "Avant de manger du pain, je bois du lait.", ko: "ë¹µì„ ë¨¹ê¸° ì „ì— ìš°ìœ ë¥¼ ë§ˆì…”ìš”.", hint1: "ã…ƒã…‡ ã…ã„± ã…ˆã…‡ ã…‡ã…‡ã„¹ ã…ã……ã…‡.", hint2: "ë¹µ(pain), ë¨¹ë‹¤(manger), ìš°ìœ (lait), ë§ˆì‹œë‹¤(boire)"},
            { fr: "AprÃ¨s avoir fait du sport, j'ai pris une douche.", ko: "ìš´ë™í•œ í›„ì— ìƒ¤ì›Œí–ˆì–´ìš”.", hint1: "ã…‡ã„·ã… ã…ã…‡ ã……ã…‡ã…ã…‡ã…‡.", hint2: "ìš´ë™í•˜ë‹¤(faire du sport), ìƒ¤ì›Œí•˜ë‹¤(prendre une douche)"},
            { fr: "Avant de dormir, je lis un livre.", ko: "ìê¸° ì „ì— ì±…ì„ ì½ì–´ìš”.", hint1: "ã…ˆã„± ã…ˆã…‡ ã…Šã…‡ ã…‡ã…‡ã…‡.", hint2: "ìë‹¤(dormir), ì±…(livre), ì½ë‹¤(lire)"},
        ];
        
        const shuffleArray = (arr) => arr.sort(() => 0.5 - Math.random());

        function generateAndSetQuizData() {
            quizData = [];
            quizData.push({ type: 'explanation' });
            
            const shuffledVerbPairs = shuffleArray([...verbPairs]);

            // MCQ Questions (5)
            shuffledVerbPairs.slice(0, 5).forEach(pair => {
                const useAfterForm = Math.random() > 0.5;
                const correctAnswer = useAfterForm ? pair.afterForm : pair.beforeForm;
                const distractor = useAfterForm ? pair.beforeForm : pair.afterForm;
                const fr_instruction = useAfterForm ? `aprÃ¨s avoir ${pair.verb.toLowerCase()}` : `avant de ${pair.verb.toLowerCase()}`;
                
                quizData.push({ 
                    type: 'multiple-choice', 
                    fr: `Choisissez la forme correcte pour dire "${fr_instruction}".`, 
                    ko: `(${pair.base}) ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`, 
                    correctAnswer: correctAnswer, 
                    choices: shuffleArray([correctAnswer, distractor]) 
                });
            });

            // Fill-in-the-blank Questions (5)
            shuffledVerbPairs.slice(5, 10).forEach(pair => {
                 const useAfterForm = Math.random() > 0.5;
                 const correctAnswer = useAfterForm ? pair.afterForm : pair.beforeForm;
                 const fr_instruction = useAfterForm ? `aprÃ¨s avoir ${pair.verb.toLowerCase()}` : `avant de ${pair.verb.toLowerCase()}`;
                 
                 quizData.push({ 
                     type: 'fill-in-the-blank', 
                     fr: `Ã‰crivez la forme pour dire "${fr_instruction}".`, 
                     ko: `(${pair.base}) ___ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`, 
                     correctAnswer: correctAnswer 
                 });
            });

            shuffleArray(sentencePool).slice(0, 5).forEach(q => quizData.push({ type: 'translate-sentence', ...q }));
            shuffleArray(sentencePool).slice(0, 5).forEach(q => quizData.push({ type: 'listening-dictation', ...q }));
        }

        startBtn.addEventListener('click', startQuiz);
        retryBtn.addEventListener('click', () => location.reload());

        // [FIXED] Audio playback function updated to work with generate-audio.js
        async function playAudio(text, voice = 'woman') {
            const qData = questionsData.find(d => d.ko === text);
            if (qData) qData.listenCount++;
            
            const btn = event.currentTarget;
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ë¡œë”©...';

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice }), // Pass 'man' or 'woman'
                });
                if (!response.ok) throw new Error('Failed to generate audio');
                
                // The server returns JSON, not a direct audio blob.
                const { audioData, mimeType } = await response.json();
                if (!audioData) throw new Error('No audio data in response');
                
                // Create audio object from base64 data URI
                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                audio.play();

                audio.onended = () => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                };
            } catch (error) {
                console.error('Audio playback error:', error);
                btn.disabled = false;
                btn.innerHTML = originalText;
                alert('DÃ©solÃ©, une erreur est survenue lors de la lecture audio.');
            }
        }

        async function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const player = document.getElementById('recording-player');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'Enregistrer ma voix / ë‚´ ëª©ì†Œë¦¬ ë…¹ìŒí•˜ê¸°';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        player.src = audioUrl; player.hidden = false;
                        const reader = new FileReader(); reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => { questionsData[currentQuestionIndex].recording = { base64: reader.result.split(',')[1] }; };
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start(); recordBtn.classList.add('recording'); recordBtn.textContent = 'ArrÃªter / ë…¹ìŒ ì¤‘ì§€';
                } catch (err) { console.error("Error recording:", err); alert("Le microphone est nÃ©cessaire. Veuillez autoriser l'accÃ¨s. / ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); }
            }
        }
        
        function startQuiz() {
            studentName = studentNameInput.value.trim();
            if (!studentName) { alert('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom)'); return; }
            startTime = new Date();
            startScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            generateAndSetQuizData();
            questionsData = quizData.map((q, i) => ({ number: i, ...q, userAnswer: {}, listenCount: 0, hint1Count: 0, hint2Count: 0, recording: {} }));
            renderQuestion();
        }

        function renderQuestion() {
            quizContainer.innerHTML = '';
            if (currentQuestionIndex >= quizData.length) { finishQuiz(); return; }
            const q = quizData[currentQuestionIndex];
            const card = document.createElement('div'); card.className = 'p-6 bg-white rounded-xl shadow-lg';
            let content = `<p class="text-sm text-slate-500 mb-4">Question ${currentQuestionIndex} / ${quizData.length - 1}</p>`;
            
            if (q.type === 'explanation') {
                content += `<h2 class="section-title">Comment dire "AprÃ¨s" et "Avant" en corÃ©en?</h2><div class="space-y-6 text-lg"><div><h3 class="font-bold text-xl mb-2 text-indigo-700">1. Avec un Verbe (ë™ì‚¬)</h3><div class="pl-4 border-l-4 border-indigo-200 space-y-4"><div><p><strong>Pour dire "aprÃ¨s avoir fait..." â†’ <code class="bg-indigo-100 p-1 rounded">-(ìœ¼)ã„´ í›„ì—</code></strong></p><p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> (manger) â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ì€ í›„ì—</span></strong> (aprÃ¨s avoir mangÃ©)</p><p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> (aller) â†’ <strong>ê°€<span class="text-red-500 font-semibold">ã„´ í›„ì—</span></strong> (aprÃ¨s Ãªtre allÃ©)</p></div><div><p><strong>Pour dire "avant de faire..." â†’ <code class="bg-green-100 p-1 rounded">-ê¸° ì „ì—</code></strong></p><p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> (manger) â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong> (avant de manger)</p><p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> (aller) â†’ <strong>ê°€<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong> (avant d'aller)</p></div></div></div><div class="border-t pt-6"><h3 class="font-bold text-xl mb-2 text-sky-700">2. Avec un Nom (ëª…ì‚¬)</h3><div class="pl-4 border-l-4 border-sky-200 space-y-2"><p>On peut aussi les utiliser avec des noms, surtout ceux qui dÃ©crivent <strong>une action ou un Ã©vÃ©nement</strong>.</p><p class="ml-4">Ex) <strong>ìˆ˜ì—…</strong> (le cours) â†’ <strong>ìˆ˜ì—…<span class="text-blue-500 font-semibold"> í›„ì—</span></strong> (aprÃ¨s le cours)</p><p class="ml-4">Ex) <strong>ì‹ì‚¬</strong> (le repas) â†’ <strong>ì‹ì‚¬<span class="text-blue-500 font-semibold"> ì „ì—</span></strong> (avant le repas)</p><div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg"><p class="font-bold text-amber-800">ğŸ’¡ Astuce !</p><p class="text-amber-700">Certains noms fonctionnent mieux que d'autres. Par exemple :</p><p class="ml-4">"ì¼ í›„ì—" (aprÃ¨s le travail) est correct, mais <strong>"í‡´ê·¼ í›„ì—"</strong> (aprÃ¨s avoir quittÃ© le travail) est plus naturel.</p><p class="ml-4">"í•™êµ ì „ì—" (avant l'Ã©cole) est un peu bizarre, mais <strong>"ìˆ˜ì—… ì „ì—"</strong> (avant le cours) ou <strong>"ë“±êµ ì „ì—"</strong> (avant d'aller Ã  l'Ã©cole) est mieux.</p></div></div></div></div>`;
            } else {
                 if(q.type === 'multiple-choice') content += `<h2 class="section-title">Ã‰tape 1: Choisir la bonne rÃ©ponse / ì•Œë§ì€ ë‹µ ê³ ë¥´ê¸°</h2>`;
                 if(q.type === 'fill-in-the-blank') content += `<h2 class="section-title">Ã‰tape 2: Remplir le vide / ë¹ˆì¹¸ ì±„ìš°ê¸°</h2>`;
                 if(q.type === 'translate-sentence') content += `<h2 class="section-title">Ã‰tape 3: Traduire la phrase / ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h2>`;
                 if(q.type === 'listening-dictation') content += `<h2 class="section-title">Ã‰tape 4: Ã‰couter et Ã©crire / ë“£ê³  ë°›ì•„ì“°ê¸°</h2>`;
                
                if (q.type === 'listening-dictation') { content += `<p class="text-xl font-semibold text-slate-800 mb-2">Ã‰coutez et Ã©crivez. <br> Mots-clÃ©s : <span class="font-normal text-slate-600">${q.hint2}</span></p>`; } else { content += `<p class="text-xl font-semibold text-slate-800 mb-2">${q.fr}</p>`; }
                
                if (q.type === 'listening-dictation') {
                    content += `<div class="flex items-center mt-2 mb-4"><button onclick="playAudio('${q.ko}', 'man')" class="btn btn-secondary">Ã‰couter la phrase / ë¬¸ì¥ ë“£ê¸°</button></div>`;
                } else if (q.type !== 'translate-sentence') {
                    content += `<p class="text-2xl font-bold text-indigo-600 mb-4">${q.ko}</p>`;
                }

                if (q.type === 'multiple-choice') { content += `<div class="grid grid-cols-1 gap-3">${q.choices.map(c => `<button class="btn btn-choice" data-answer="${c}">${c}</button>`).join('')}</div>`; } 
                else if (q.type === 'fill-in-the-blank') { 
                    content += q.ko.replace('___', `<input type="text" id="answer-input" class="p-2 border-2 border-slate-300 rounded-lg text-lg text-center mx-2" style="width: 200px;">`); 
                    content += `<div class="mt-4 p-3 bg-slate-50 rounded-lg text-slate-600"><p class="font-bold">ğŸ’¡ Rappel (ë³µìŠµ)</p><p><b class="text-green-700">-ê¸° ì „ì—</b> (avant de) : Toujours aprÃ¨s le radical du verbe.<br><b class="text-indigo-700">-(ìœ¼)ã„´ í›„ì—</b> (aprÃ¨s avoir) : -ì€ í›„ì— aprÃ¨s une consonne, -ã„´ í›„ì— aprÃ¨s une voyelle.</p></div>`;
                }
                else if (q.type === 'translate-sentence') { content += `<textarea id="answer-input" class="w-full p-3 border-2 border-slate-300 rounded-lg" rows="2" placeholder="Traduisez en corÃ©en..."></textarea>`; } 
                else if (q.type === 'listening-dictation') { content += `<p class="font-semibold mt-4 mb-2">1. Ã‰crivez ce que vous entendez / ë“¤ì€ ë‚´ìš©ì„ ì ì–´ë³´ì„¸ìš”</p><input id="dictation1" class="w-full p-2 border-2 border-slate-300 rounded-lg"><p class="font-semibold mt-4 mb-2">2. Enregistrez votre voix / ëª©ì†Œë¦¬ë¥¼ ë…¹ìŒí•˜ì„¸ìš”</p><div class="flex items-center gap-4"><button id="record-btn" class="btn btn-record" onclick="toggleRecording()">Enregistrer / ë…¹ìŒí•˜ê¸°</button><audio id="recording-player" controls hidden></audio></div><p class="font-semibold mt-4 mb-2">3. Ã‰coutez votre voix et Ã©crivez / ë³¸ì¸ ëª©ì†Œë¦¬ë¥¼ ë“£ê³  ì ì–´ë³´ì„¸ìš”</p><input id="dictation2" class="w-full p-2 border-2 border-slate-300 rounded-lg">`; }
                
                if (q.type === 'translate-sentence' && q.hint1 && q.hint2) { content += `<div class="mt-4 flex space-x-2"><button onclick="showHint(1, '${q.hint1}')" class="btn-hint bg-green-100 text-green-800">Aidez moi ğŸ™ (ì´ˆì„±)</button><button onclick="showHint(2, '${q.hint2}')" class="btn-hint bg-blue-100 text-blue-800">Au secours ğŸ›Ÿ (ë‹¨ì–´)</button></div><div id="hint-display" class="mt-3 p-3 bg-slate-50 rounded-lg text-slate-600 min-h-[50px]"></div>`; }
            }
            content += `<div class="mt-6 flex justify-between items-center no-print"><button id="prev-btn" class="btn btn-primary ${currentQuestionIndex === 0 ? 'invisible' : ''}">PrÃ©cÃ©dent / ì´ì „</button><button id="next-btn" class="btn btn-primary">${currentQuestionIndex === quizData.length - 1 ? 'Terminer / ëë‚´ê¸°' : 'Suivant / ë‹¤ìŒ'}</button></div>`;
            card.innerHTML = content; quizContainer.appendChild(card); addQuestionEventListeners();
        }

        function addQuestionEventListeners() {
            document.getElementById('prev-btn')?.addEventListener('click', prevQuestion);
            document.getElementById('next-btn')?.addEventListener('click', nextQuestion);
            document.querySelectorAll('.btn-choice').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.btn-choice').forEach(b => b.classList.remove('selected'));
                    e.currentTarget.classList.add('selected'); setTimeout(nextQuestion, 300);
                });
            });
        }
        function showHint(num, text) { if(num === 1) questionsData[currentQuestionIndex].hint1Count++; else questionsData[currentQuestionIndex].hint2Count++; document.getElementById('hint-display').textContent = text; }
        function saveCurrentAnswer() {
            const q = quizData[currentQuestionIndex]; const qData = questionsData[currentQuestionIndex]; if (!q || !qData) return;
            if (q.type === 'multiple-choice') { const selected = document.querySelector('.btn-choice.selected'); qData.userAnswer.main = selected ? selected.dataset.answer : ''; } else if (q.type === 'fill-in-the-blank' || q.type === 'translate-sentence') { qData.userAnswer.main = document.getElementById('answer-input')?.value.trim() || ''; } else if (q.type === 'listening-dictation') { qData.userAnswer.dictation1 = document.getElementById('dictation1')?.value.trim() || ''; qData.userAnswer.dictation2 = document.getElementById('dictation2')?.value.trim() || ''; }
        }
        function prevQuestion() { if (currentQuestionIndex > 0) { saveCurrentAnswer(); currentQuestionIndex--; renderQuestion(); } }
        function nextQuestion() { saveCurrentAnswer(); if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; renderQuestion(); } else { finishQuiz(); } }

        function finishQuiz() {
            endTime = new Date(); evaluateAnswers();
            quizContainer.classList.add('hidden'); resultScreen.classList.remove('hidden');
            const gradableQuestions = questionsData.filter(q => q.type !== 'explanation');
            const score = gradableQuestions.filter(q => q.isCorrect).length; 
            const total = gradableQuestions.length;
            const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
            const resultMessage = getGradingMessage(percentage, 'fr');
            document.getElementById('result-message').innerHTML = `<strong class="text-2xl">${studentName}, ton score est de ${score} / ${total}</strong><br>${resultMessage}`;
            if(percentage === 100) confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
            
            sendResults();
        }

        function evaluateAnswers() {
            questionsData.forEach(qData => {
                if (qData.type === 'explanation') return;
                const format = (str) => (str || '').replace(/[.\s+!?]/g, '').toLowerCase(); let isCorrect = false;
                if (qData.type === 'multiple-choice' || qData.type === 'fill-in-the-blank' ) { isCorrect = format(qData.userAnswer.main) === format(qData.correctAnswer); } else if (qData.type === 'translate-sentence') { isCorrect = format(qData.userAnswer.main) === format(qData.ko); } else if (q.type === 'listening-dictation') { isCorrect = format(qData.userAnswer.dictation1) === format(qData.ko); }
                qData.isCorrect = isCorrect;
            });
        }
        
        async function sendResults() {
            const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
            const payload = { studentName, startTime: startTime.toISOString(), endTime: endTime.toISOString(), totalTimeSeconds, questions: questionsData };
             try {
                const response = await fetch('/.netlify/functions/send-results', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Failed to send results: ${response.statusText}`);
                console.log('Results sent successfully!');
            } catch (error) { console.error('Error sending results:', error); }
        }

        window.playAudio = playAudio;
        window.toggleRecording = toggleRecording;
        window.showHint = showHint;

    </script>
</body>
</html>

