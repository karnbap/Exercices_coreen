<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ì—°ìŠµ: í›„ì— / ì „ì—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Pretendard', sans-serif; background-color: #f8fafc; }
        .made-by-top, .made-by-bottom { text-align: center; padding: 8px; font-size: 0.8rem; color: #64748b; background-color: #f1f5f9; }
        .made-by-top { border-bottom: 1px solid #e2e8f0; }
        .made-by-bottom { border-top: 1px solid #e2e8f0; margin-top: 40px; }
        .print-button-container { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .btn { display: flex; align-items: center; justify-content: center; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s ease-in-out; cursor: pointer; padding: 0.75rem 1.5rem; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #3730a3; }
        .btn-secondary { background-color: #e0e7ff; color: #3730a3; padding: 0.5rem 1rem; }
        .btn-secondary:hover { background-color: #c7d2fe; }
        .btn-choice { border: 2px solid #e5e7eb; width: 100%; justify-content: flex-start; text-align: left; padding: 1rem; font-size: 1.125rem; }
        .btn-choice:hover { border-color: #facc15; background-color: #fef9c3; }
        .btn-choice.selected { border-color: #fbbf24; background-color: #fef08a; }
        .btn-hint { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-record { background-color: #ef4444; color: white; }
        .btn-record.recording { background-color: #10b981; }
        .invisible { visibility: hidden; }
        .section-title { font-size: 1.5rem; font-weight: bold; color: #1e293b; border-bottom: 2px solid #cbd5e1; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        @media print { .no-print { display: none !important; } main { box-shadow: none !important; padding: 0 !important; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="made-by-top no-print">Made with â¤ï¸ by ì„±ì¼, Pongdang</div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Exercice CorÃ©en : AprÃ¨s / Avant</h1>
            <p class="text-md text-slate-600 mt-2">N + í›„ì— / R+(ìœ¼)ã„´ í›„ì— / R+ê¸° ì „ì—</p>
        </header>

        <div class="print-button-container no-print">
            <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm2 5h6v1H7V9zm0 2h6v1H7v-1z" clip-rule="evenodd" /></svg>
                Imprimer / í”„ë¦°íŠ¸
            </button>
        </div>

        <div id="start-screen" class="text-center">
            <input type="text" id="student-name" class="w-full max-w-sm p-3 border-2 border-slate-300 rounded-lg text-center text-lg focus:border-purple-500 focus:ring focus:ring-purple-200 transition" placeholder="í•™ìƒ ì´ë¦„ì´ ê¶ê¸ˆí•´ìš”! (Ton nom)">
            <button id="start-btn" class="mt-4 w-full max-w-sm bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transform hover:scale-105 transition">
                ì‹œì‘! (Commencer)
            </button>
        </div>

        <main id="quiz-container" class="hidden"></main>

        <div id="result-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl max-w-2xl mx-auto no-print">
             <h2 class="text-3xl font-bold mb-4">ğŸ‰ Bravo ! ğŸ‰</h2>
             <p id="result-message" class="text-lg text-slate-700 mb-6"></p>
             
             <!-- AI Feedback Section -->
             <div id="ai-feedback-container" class="mt-8 text-left p-6 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
                <h3 class="text-xl font-bold text-indigo-800 mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.707.707M12 21v-1" /></svg>
                    Analyse et conseils de l'IA
                </h3>
                <div id="ai-feedback-loading" class="text-center py-4">
                    <p class="text-slate-600">Analyse de tes rÃ©ponses en cours...</p>
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mt-4"></div>
                </div>
                <div id="ai-feedback-content" class="text-slate-700 space-y-2" style="white-space: pre-wrap;"></div>
             </div>

             <div class="flex justify-center space-x-4 mt-8">
                <button id="retry-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">
                    ë‹¤ì‹œí•˜ê¸° (Recommencer)
                </button>
             </div>
        </div>
    </div>
    
    <div class="made-by-bottom no-print">Made with â¤ï¸ by ì„±ì¼, Pongdang</div>

    <script>
        // --- GRADING CRITERIA ---
        function getGradingMessage(percentage, lang = 'ko') {
            if (lang === 'fr') {
                if (percentage >= 100) return "Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !";
                if (percentage >= 80) return "TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !";
                if (percentage >= 60) return "Pas mal du tout ! ğŸ˜ Encore un petit effort et câ€™est le top !";
                return "Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª";
            }
            if (percentage >= 100) return "ì™„ë²½ ê·¸ ìì²´! ğŸ‘‘ğŸ‰ ì²œì¬ ì¸ì¦!";
            if (percentage >= 80) return "ì•„ì£¼ ì˜í–ˆì–´ìš”! ğŸ‘ ì´ ì •ë„ë©´ ê±°ì˜ ë§ˆìŠ¤í„°!";
            if (percentage >= 60) return "ê½¤ ì˜í–ˆì–´ìš”! ğŸ˜ ì¡°ê¸ˆë§Œ ë” ê°€ë©´ ìµœê³ !";
            return "ì, ì»¤í”¼ í•œ ì” í•˜ê³  ë‹¤ì‹œ ê°€ì! â˜•ğŸ’ªğŸ‡°ğŸ‡·";
        }

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        const retryBtn = document.getElementById('retry-btn');

        // --- STATE VARIABLES ---
        let studentName = '', startTime, endTime;
        let currentQuestionIndex = 0;
        let questionsData = [], quizData = [];
        let mediaRecorder, audioChunks = [];

        studentNameInput.placeholder = ["Super CÃ©dou", "GÃ©nie Julie", "Champion LÃ©o", "Star Alice"][Math.floor(Math.random() * 4)];

        // --- QUESTION POOLS ---
        const questionPools = {
            afterVerb: [
                { base: 'ë°¥ì„ ë¨¹ë‹¤', answer: 'ë¨¹ì€ í›„ì—', verb: 'Manger' },
                { base: 'ìˆ™ì œë¥¼ í•˜ë‹¤', answer: 'í•œ í›„ì—', verb: 'Faire les devoirs' },
                { base: 'ì˜í™”ë¥¼ ë³´ë‹¤', answer: 'ë³¸ í›„ì—', verb: 'Regarder un film' },
                { base: 'ì±…ì„ ì½ë‹¤', answer: 'ì½ì€ í›„ì—', verb: 'Lire un livre' },
                { base: 'ìš´ë™ì„ í•˜ë‹¤', answer: 'ìš´ë™í•œ í›„ì—', verb: 'Faire du sport'}
            ],
            beforeVerb: [
                { base: 'ì ì„ ìë‹¤', answer: 'ìê¸° ì „ì—', verb: 'Dormir' },
                { base: 'ìˆ˜ì—…ì— ë“¤ì–´ê°€ë‹¤', answer: 'ë“¤ì–´ê°€ê¸° ì „ì—', verb: 'Entrer en classe' },
                { base: 'ì†ì„ ì”»ë‹¤', answer: 'ì”»ê¸° ì „ì—', verb: 'Se laver les mains' },
                { base: 'ë°–ìœ¼ë¡œ ë‚˜ê°€ë‹¤', answer: 'ë‚˜ê°€ê¸° ì „ì—', verb: 'Sortir' },
                { base: 'ì»¤í”¼ë¥¼ ë§ˆì‹œë‹¤', answer: 'ë§ˆì‹œê¸° ì „ì—', verb: 'Boire du cafÃ©'}
            ],
            sentences: [
                { fr: "AprÃ¨s avoir fini le travail, je suis rentrÃ© chez moi.", ko: "ì¼ì„ ëë‚¸ í›„ì— ì§‘ì— ëŒì•„ì™”ì–´ìš”.", hint1: "ã…‡ã…‡ ã„²ã„´ ã…ã…‡ ã…ˆã…‡ ã„·ã…‡ã…‡ã…‡ã…‡.", hint2: "ì¼(travail), ëë‚´ë‹¤(finir), ì§‘(maison)"},
                { fr: "Avant de sortir, jâ€™ai pris mon parapluie.", ko: "ë‚˜ê°€ê¸° ì „ì— ìš°ì‚°ì„ ì±™ê²¼ì–´ìš”.", hint1: "ã„´ã„±ã„± ã…ˆã…‡ ã…‡ã……ã…‡ ã…Šã„±ã…‡ã…‡.", hint2: "ë‚˜ê°€ë‹¤(sortir), ìš°ì‚°(parapluie), ì±™ê¸°ë‹¤(prendre)"},
                { fr: "AprÃ¨s avoir regardÃ© le film, jâ€™ai dormi.", ko: "ì˜í™”ë¥¼ ë³¸ í›„ì— ì ì„ ì¤ì–´ìš”.", hint1: "ã…‡ã…ã„¹ ã…‚ ã…ã…‡ ã…ˆã…‡ ã…ˆã…‡ã…‡.", hint2: "ì˜í™”(film), ë³´ë‹¤(regarder), ì ì„ ìë‹¤(dormir)"},
                { fr: "Avant de manger du pain, je bois du lait.", ko: "ë¹µì„ ë¨¹ê¸° ì „ì— ìš°ìœ ë¥¼ ë§ˆì…”ìš”.", hint1: "ã…ƒã…‡ ã…ã„± ã…ˆã…‡ ã…‡ã…‡ã„¹ ã…ã……ã…‡.", hint2: "ë¹µ(pain), ë¨¹ë‹¤(manger), ìš°ìœ (lait), ë§ˆì‹œë‹¤(boire)"},
                { fr: "AprÃ¨s avoir fait du sport, j'ai pris une douche.", ko: "ìš´ë™í•œ í›„ì— ìƒ¤ì›Œí–ˆì–´ìš”.", hint1: "ã…‡ã„·ã… ã…ã…‡ ã……ã…‡ã…ã…‡ã…‡.", hint2: "ìš´ë™í•˜ë‹¤(faire du sport), ìƒ¤ì›Œí•˜ë‹¤(prendre une douche)"},
                { fr: "Avant de dormir, je lis un livre.", ko: "ìê¸° ì „ì— ì±…ì„ ì½ì–´ìš”.", hint1: "ã…ˆã„± ã…ˆã…‡ ã…Šã…‡ ã…‡ã…‡ã…‡.", hint2: "ìë‹¤(dormir), ì±…(livre), ì½ë‹¤(lire)"},
            ]
        };
        
        // --- HELPER FUNCTIONS ---
        const shuffleArray = (arr) => arr.sort(() => 0.5 - Math.random());

        // --- QUIZ GENERATION ---
        function generateAndSetQuizData() {
            quizData = [];
            quizData.push({ type: 'explanation' });
            const mcqPool = shuffleArray([...questionPools.afterVerb, ...questionPools.beforeVerb]);
            mcqPool.slice(0, 5).forEach(q => {
                const isAfter = q.answer.includes('í›„ì—');
                const fr_instruction = isAfter ? `aprÃ¨s avoir ${q.verb.toLowerCase()}` : `avant de ${q.verb.toLowerCase()}`;
                const distractor = isAfter ? q.answer.replace(/(ìœ¼|ã„´|í•œ) í›„ì—/g, 'ê¸° ì „ì—') : q.answer.replace(/ê¸° ì „ì—/g, 'ã„´ í›„ì—');
                quizData.push({ type: 'multiple-choice', fr: `Choisissez la forme correcte pour dire "${fr_instruction}".`, ko: `(${q.base}) ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`, correctAnswer: q.answer, choices: shuffleArray([q.answer, distractor]) });
            });
            shuffleArray(mcqPool).slice(0, 5).forEach(q => {
                 const isAfter = q.answer.includes('í›„ì—');
                 const fr_instruction = isAfter ? `aprÃ¨s avoir ${q.verb.toLowerCase()}` : `avant de ${q.verb.toLowerCase()}`;
                 quizData.push({ type: 'fill-in-the-blank', fr: `Ã‰crivez la forme pour dire "${fr_instruction}".`, ko: `(${q.base}) ___ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`, correctAnswer: q.answer });
            });
            shuffleArray(questionPools.sentences).slice(0, 5).forEach(q => quizData.push({ type: 'translate-sentence', ...q }));
            shuffleArray(questionPools.sentences).slice(0, 5).forEach(q => quizData.push({ type: 'listening-dictation', ...q }));
        }

        // --- EVENT LISTENERS ---
        startBtn.addEventListener('click', startQuiz);
        retryBtn.addEventListener('click', () => location.reload());

        // --- AUDIO & RECORDING LOGIC ---
        async function playAudio(text, voice = 'alloy') {
            if(questionsData[currentQuestionIndex]) questionsData[currentQuestionIndex].listenCount++;
            alert('Audio playback is simulated in this environment.');
        }
        async function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const player = document.getElementById('recording-player');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'Enregistrer ma voix / ë‚´ ëª©ì†Œë¦¬ ë…¹ìŒí•˜ê¸°';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        player.src = audioUrl; player.hidden = false;
                        const reader = new FileReader(); reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => { questionsData[currentQuestionIndex].recording.base64 = reader.result.split(',')[1]; };
                    };
                    mediaRecorder.start(); recordBtn.classList.add('recording'); recordBtn.textContent = 'ArrÃªter / ë…¹ìŒ ì¤‘ì§€';
                } catch (err) { console.error("Error recording:", err); alert("Le microphone est nÃ©cessaire. Veuillez autoriser l'accÃ¨s. / ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); }
            }
        }
        
        // --- QUIZ FLOW ---
        function startQuiz() {
            studentName = studentNameInput.value.trim();
            if (!studentName) { alert('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom)'); return; }
            startTime = new Date();
            startScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            generateAndSetQuizData();
            questionsData = quizData.map((q, i) => ({ number: i, ...q, userAnswer: {}, listenCount: 0, hint1Count: 0, hint2Count: 0, recording: {} }));
            renderQuestion();
        }

        function renderQuestion() {
            quizContainer.innerHTML = '';
            if (currentQuestionIndex >= quizData.length) { finishQuiz(); return; }
            const q = quizData[currentQuestionIndex];
            const card = document.createElement('div'); card.className = 'p-6 bg-white rounded-xl shadow-lg';
            let content = `<p class="text-sm text-slate-500 mb-4">Question ${currentQuestionIndex} / ${quizData.length - 1}</p>`;
            
            if (q.type === 'explanation') {
                content += `<h2 class="section-title">Comment dire "AprÃ¨s" et "Avant" en corÃ©en?</h2><div class="space-y-6 text-lg"><div><h3 class="font-bold text-xl mb-2 text-indigo-700">1. Avec un Verbe (ë™ì‚¬)</h3><div class="pl-4 border-l-4 border-indigo-200 space-y-4"><div><p><strong>Pour dire "aprÃ¨s avoir fait..." â†’ <code class="bg-indigo-100 p-1 rounded">-(ìœ¼)ã„´ í›„ì—</code></strong></p><p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> (manger) â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ì€ í›„ì—</span></strong> (aprÃ¨s avoir mangÃ©)</p><p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> (aller) â†’ <strong>ê°€<span class="text-red-500 font-semibold">ã„´ í›„ì—</span></strong> (aprÃ¨s Ãªtre allÃ©)</p></div><div><p><strong>Pour dire "avant de faire..." â†’ <code class="bg-green-100 p-1 rounded">-ê¸° ì „ì—</code></strong></p><p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> (manger) â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong> (avant de manger)</p><p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> (aller) â†’ <strong>ê°€<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong> (avant d'aller)</p></div></div></div><div class="border-t pt-6"><h3 class="font-bold text-xl mb-2 text-sky-700">2. Avec un Nom (ëª…ì‚¬)</h3><div class="pl-4 border-l-4 border-sky-200 space-y-2"><p>On peut aussi les utiliser avec des noms, surtout ceux qui dÃ©crivent <strong>une action ou un Ã©vÃ©nement</strong>.</p><p class="ml-4">Ex) <strong>ìˆ˜ì—…</strong> (le cours) â†’ <strong>ìˆ˜ì—…<span class="text-blue-500 font-semibold"> í›„ì—</span></strong> (aprÃ¨s le cours)</p><p class="ml-4">Ex) <strong>ì‹ì‚¬</strong> (le repas) â†’ <strong>ì‹ì‚¬<span class="text-blue-500 font-semibold"> ì „ì—</span></strong> (avant le repas)</p><div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg"><p class="font-bold text-amber-800">ğŸ’¡ Astuce !</p><p class="text-amber-700">Certains noms fonctionnent mieux que d'autres. Par exemple :</p><p class="ml-4">"ì¼ í›„ì—" (aprÃ¨s le travail) est correct, mais <strong>"í‡´ê·¼ í›„ì—"</strong> (aprÃ¨s avoir quittÃ© le travail) est plus naturel.</p><p class="ml-4">"í•™êµ ì „ì—" (avant l'Ã©cole) est un peu bizarre, mais <strong>"ìˆ˜ì—… ì „ì—"</strong> (avant le cours) ou <strong>"ë“±êµ ì „ì—"</strong> (avant d'aller Ã  l'Ã©cole) est mieux.</p></div></div></div></div>`;
            } else {
                 if(q.type === 'multiple-choice') content += `<h2 class="section-title">Ã‰tape 1: Choisir la bonne rÃ©ponse / ì•Œë§ì€ ë‹µ ê³ ë¥´ê¸°</h2>`;
                 if(q.type === 'fill-in-the-blank') content += `<h2 class="section-title">Ã‰tape 2: Remplir le vide / ë¹ˆì¹¸ ì±„ìš°ê¸°</h2>`;
                 if(q.type === 'translate-sentence') content += `<h2 class="section-title">Ã‰tape 3: Traduire la phrase / ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h2>`;
                 if(q.type === 'listening-dictation') content += `<h2 class="section-title">Ã‰tape 4: Ã‰couter et Ã©crire / ë“£ê³  ë°›ì•„ì“°ê¸°</h2>`;
                if (q.type === 'listening-dictation') { content += `<p class="text-xl font-semibold text-slate-800 mb-2">Ã‰coutez et Ã©crivez. <br> Mots-clÃ©s : <span class="font-normal text-slate-600">${q.hint2}</span></p>`; } else { content += `<p class="text-xl font-semibold text-slate-800 mb-2">${q.fr}</p>`; }
                if(q.type.startsWith('listening')){ content += `<div class="flex items-center mt-2 mb-4"><p class="text-2xl font-bold text-indigo-600 mr-3">CorÃ©en : </p><button onclick="playAudio('${q.ko}')" class="btn btn-secondary">Ã‰couter / ë“£ê¸°</button></div>`; } else { content += `<p class="text-2xl font-bold text-indigo-600 mb-4">${q.ko}</p>`; }
                if (q.type === 'multiple-choice') { content += `<div class="grid grid-cols-1 gap-3">${q.choices.map(c => `<button class="btn btn-choice" data-answer="${c}">${c}</button>`).join('')}</div>`; } else if (q.type === 'fill-in-the-blank') { content += q.ko.replace('___', `<input type="text" id="answer-input" class="p-2 border-2 border-slate-300 rounded-lg text-lg text-center mx-2" style="width: 200px;">`); } else if (q.type === 'translate-sentence') { content += `<textarea id="answer-input" class="w-full p-3 border-2 border-slate-300 rounded-lg" rows="2" placeholder="Traduisez en corÃ©en..."></textarea>`; } else if (q.type === 'listening-dictation') { content += `<p class="font-semibold mt-4 mb-2">1. Ã‰crivez ce que vous entendez / ë“¤ì€ ë‚´ìš©ì„ ì ì–´ë³´ì„¸ìš”</p><input id="dictation1" class="w-full p-2 border-2 border-slate-300 rounded-lg"><p class="font-semibold mt-4 mb-2">2. Enregistrez votre voix / ëª©ì†Œë¦¬ë¥¼ ë…¹ìŒí•˜ì„¸ìš”</p><div class="flex items-center gap-4"><button id="record-btn" class="btn btn-record" onclick="toggleRecording()">Enregistrer / ë…¹ìŒí•˜ê¸°</button><audio id="recording-player" controls hidden></audio></div><p class="font-semibold mt-4 mb-2">3. Ã‰coutez votre voix et Ã©crivez / ë³¸ì¸ ëª©ì†Œë¦¬ë¥¼ ë“£ê³  ì ì–´ë³´ì„¸ìš”</p><input id="dictation2" class="w-full p-2 border-2 border-slate-300 rounded-lg">`; }
                if (q.hint1 && q.hint2 && q.type !== 'listening-dictation') { content += `<div class="mt-4 flex space-x-2"><button onclick="showHint(1, '${q.hint1}')" class="btn-hint bg-green-100 text-green-800">Aidez moi ğŸ™ (ì´ˆì„±)</button><button onclick="showHint(2, '${q.hint2}')" class="btn-hint bg-blue-100 text-blue-800">Au secours ğŸ›Ÿ (ë‹¨ì–´)</button></div><div id="hint-display" class="mt-3 p-3 bg-slate-50 rounded-lg text-slate-600 min-h-[50px]"></div>`; }
            }
            content += `<div class="mt-6 flex justify-between items-center no-print"><button id="prev-btn" class="btn btn-primary ${currentQuestionIndex === 0 ? 'invisible' : ''}">PrÃ©cÃ©dent / ì´ì „</button><button id="next-btn" class="btn btn-primary">${currentQuestionIndex === quizData.length - 1 ? 'Terminer / ëë‚´ê¸°' : 'Suivant / ë‹¤ìŒ'}</button></div>`;
            card.innerHTML = content; quizContainer.appendChild(card); addQuestionEventListeners();
        }

        function addQuestionEventListeners() {
            document.getElementById('prev-btn')?.addEventListener('click', prevQuestion);
            document.getElementById('next-btn')?.addEventListener('click', nextQuestion);
            document.querySelectorAll('.btn-choice').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.btn-choice').forEach(b => b.classList.remove('selected'));
                    e.currentTarget.classList.add('selected'); setTimeout(nextQuestion, 300);
                });
            });
        }
        function showHint(num, text) { if(num === 1) questionsData[currentQuestionIndex].hint1Count++; else questionsData[currentQuestionIndex].hint2Count++; document.getElementById('hint-display').textContent = text; }
        function saveCurrentAnswer() {
            const q = quizData[currentQuestionIndex]; const qData = questionsData[currentQuestionIndex]; if (!q || !qData) return;
            if (q.type === 'multiple-choice') { const selected = document.querySelector('.btn-choice.selected'); qData.userAnswer.main = selected ? selected.dataset.answer : ''; } else if (q.type === 'fill-in-the-blank' || q.type === 'translate-sentence') { qData.userAnswer.main = document.getElementById('answer-input')?.value.trim() || ''; } else if (q.type === 'listening-dictation') { qData.userAnswer.dictation1 = document.getElementById('dictation1')?.value.trim() || ''; qData.userAnswer.dictation2 = document.getElementById('dictation2')?.value.trim() || ''; }
        }
        function prevQuestion() { if (currentQuestionIndex > 0) { saveCurrentAnswer(); currentQuestionIndex--; renderQuestion(); } }
        function nextQuestion() { saveCurrentAnswer(); if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; renderQuestion(); } else { finishQuiz(); } }

        async function finishQuiz() {
            endTime = new Date(); evaluateAnswers();
            quizContainer.classList.add('hidden'); resultScreen.classList.remove('hidden');
            const score = questionsData.filter(q => q.isCorrect).length; const total = quizData.length - 1;
            const percentage = Math.round((score / total) * 100);
            const resultMessage = getGradingMessage(percentage, 'fr');
            document.getElementById('result-message').innerHTML = `<strong class="text-2xl">${studentName}, ton score est de ${score} / ${total}</strong><br>${resultMessage}`;
            if(percentage === 100) confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
            
            const aiFeedbackContainer = document.getElementById('ai-feedback-container');
            const aiFeedbackContent = document.getElementById('ai-feedback-content');
            const aiFeedbackLoading = document.getElementById('ai-feedback-loading');
            aiFeedbackContainer.classList.remove('hidden'); aiFeedbackLoading.classList.remove('hidden'); aiFeedbackContent.classList.add('hidden');
            
            const incorrectAnswers = questionsData.filter(qData => !qData.isCorrect && qData.type !== 'explanation').map(qData => ({ q: quizData[qData.number], qData }));
            const aiFeedback = await getAiFeedback(incorrectAnswers);
            
            aiFeedbackLoading.classList.add('hidden'); aiFeedbackContent.textContent = aiFeedback; aiFeedbackContent.classList.remove('hidden');
            sendResults(aiFeedback);
        }

        function evaluateAnswers() {
            questionsData.forEach(qData => {
                if (qData.type === 'explanation') return;
                const format = (str) => (str || '').replace(/[.\s+!?]/g, '').toLowerCase(); let isCorrect = false;
                if (qData.type === 'multiple-choice' || qData.type === 'fill-in-the-blank' ) { isCorrect = format(qData.userAnswer.main) === format(qData.correctAnswer); } else if (qData.type === 'translate-sentence') { isCorrect = format(qData.userAnswer.main) === format(qData.ko); } else if (qData.type === 'listening-dictation') { isCorrect = format(qData.userAnswer.dictation1) === format(qData.ko); }
                qData.isCorrect = isCorrect;
            });
        }

        async function getAiFeedback(incorrectAnswers) {
            if (incorrectAnswers.length === 0) {
                return "FÃ©licitations ! Aucune erreur trouvÃ©e. Tu es sur la bonne voie ! ğŸ‘";
            }
            const mistakesText = incorrectAnswers.map(item => {
                let userAnswerText = item.qData.userAnswer.main || item.qData.userAnswer.dictation1 || '';
                let correctAnswerText = item.q.correctAnswer || item.q.ko;
                return `Question Type: ${item.q.type}\nInstruction (FR): ${item.q.fr}\nStudent's Answer: "${userAnswerText}"\nCorrect Answer: "${correctAnswerText}"\n---`;
            }).join('\n');

            const systemPrompt = "Tu es un tuteur de corÃ©en sympathique et encourageant. L'Ã©tudiant est un dÃ©butant complet francophone. Analyse les erreurs suivantes, identifie le principal point de confusion (par exemple, confusion entre -ê¸° ì „ì— et -(ìœ¼)ã„´ í›„ì—, ou des erreurs de conjugaison). Fournis une explication trÃ¨s simple, courte et positive en franÃ§ais. Utilise des emojis pour rendre le tout plus amical. Termine par une phrase d'encouragement. Ne sois pas trop long.";
            const userQuery = `Voici les erreurs de l'Ã©tudiant :\n${mistakesText}\n\nAnalyse ces erreurs et donne une explication simple et encourageante.`;
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || "DÃ©solÃ©, une erreur est survenue lors de l'analyse. RÃ©essaye !";
            } catch (error) {
                console.error("Error fetching AI feedback:", error);
                return "Impossible de contacter le service d'analyse. VÃ©rifie ta connexion ou rÃ©essaye plus tard.";
            }
        }

        async function sendResults(aiFeedback = '') {
            const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
            const payload = { studentName, startTime: startTime.toISOString(), endTime: endTime.toISOString(), totalTimeSeconds, questions: questionsData, aiFeedback };
            console.log("--- QUIZ RESULTS (with AI Feedback) ---");
            console.log(JSON.stringify(payload, null, 2));
             try {
                const response = await fetch('/.netlify/functions/send-results', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Failed to send results: ${response.statusText}`);
                console.log('Results sent successfully!');
            } catch (error) { console.error('Error sending results:', error); }
        }

    </script>
</body>
</html>

