<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•œêµ­ì–´ ì—°ìŠµ: í›„ì— / ì „ì—</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body { font-family: 'Inter','Pretendard',sans-serif; background:#f8fafc; }
    .made-by-top,.made-by-bottom{ text-align:center; padding:8px; font-size:.85rem; color:#475569; background:#f1f5f9 }
    .made-by-top{ border-bottom:1px solid #e2e8f0 }
    .made-by-bottom{ border-top:1px solid #e2e8f0; margin-top:40px }
    .print-button-container{ display:flex; justify-content:flex-end; margin-bottom:20px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; font-weight:700; border-radius:.75rem; transition:.2s; cursor:pointer; padding:.75rem 1.25rem }
    .btn:disabled{ background:#d1d5db; cursor:not-allowed }
    .btn-primary{ background:#4f46e5; color:#fff }
    .btn-primary:hover:not(:disabled){ background:#3730a3 }
    .btn-secondary{ background:#e0e7ff; color:#3730a3; padding:.5rem 1rem }
    .btn-secondary:hover:not(:disabled){ background:#c7d2fe }
    .btn-choice{ border:2px solid #e5e7eb; width:100%; justify-content:flex-start; text-align:left; padding:1rem; font-size:1.05rem }
    .btn-choice:hover{ border-color:#facc15; background:#fef9c3 }
    .btn-choice.selected{ border-color:#fbbf24; background:#fef08a }
    .btn-hint{ padding:.5rem 1rem; font-size:.9rem }
    .btn-record{ background:#ef4444; color:#fff }
    .btn-record.recording{ background:#10b981 }
    .invisible{ visibility:hidden }
    .section-title{ font-size:1.35rem; font-weight:800; color:#1e293b; border-bottom:2px solid #cbd5e1; padding-bottom:.4rem; margin-bottom:1rem }
    @media print{ .no-print{ display:none !important } main{ box-shadow:none !important; padding:0 !important } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- ìƒë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="made-by-top no-print">
    made by <b>ì„±ì¼, Pondant</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
  </div>

  <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
    <header class="text-center mb-8">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900">Exercice CorÃ©en : AprÃ¨s / Avant</h1>
      <p class="text-md text-slate-600 mt-2">N + í›„ì— / R+(ìœ¼)ã„´ í›„ì— / R+ê¸° ì „ì—</p>
    </header>

    <!-- ìƒë‹¨ í”„ë¦°íŠ¸ ë²„íŠ¼ -->
    <div class="print-button-container no-print">
      <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 2h10v2H5V4zm2 5h6v1H7V9zm0 2h6v1H7v-1z" clip-rule="evenodd"/></svg>
        Imprimer / í”„ë¦°íŠ¸
      </button>
    </div>

    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen" class="text-center">
      <input type="text" id="student-name"
             class="w-full max-w-sm p-3 border-2 border-slate-300 rounded-lg text-center text-lg focus:border-purple-500 focus:ring focus:ring-purple-200 transition"
             placeholder="í•™ìƒ ì´ë¦„ì´ ê¶ê¸ˆí•´ìš”! (Ton nom)">
      <button id="start-btn"
              class="mt-4 w-full max-w-sm bg-purple-600 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transform hover:scale-105 transition">
        ì‹œì‘! (Commencer)
      </button>
    </div>

    <!-- ë¬¸ì œ ì»¨í…Œì´ë„ˆ -->
    <main id="quiz-container" class="hidden"></main>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="result-screen" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl max-w-2xl mx-auto no-print">
      <h2 class="text-3xl font-bold mb-4">ğŸ‰ Bravo ! ğŸ‰</h2>
      <p id="result-message" class="text-lg text-slate-700 mb-6"></p>

      <div class="flex justify-center space-x-3 mt-8">
        <a href="/index.html" class="btn btn-secondary">ì´ì „ ì—°ìŠµìœ¼ë¡œ ê°€ê¸° / Aller Ã  lâ€™exercice prÃ©cÃ©dent</a>
        <button id="retry-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg">
          ë‹¤ì‹œí•˜ê¸° (Recommencer)
        </button>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ì œì‘ì/íŒ€/ë©”ì¼ -->
  <div class="made-by-bottom no-print">
    made by <b>ì„±ì¼, Pondant</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
  </div>

  <script>
    // ===== ê³µí†µ ìœ í‹¸ =====
    function base64ToBlob(base64, mimeType) {
      const byteChars = atob(base64);
      const len = byteChars.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = byteChars.charCodeAt(i);
      return new Blob([bytes], { type: mimeType || 'audio/mpeg' });
    }
    const $ = (sel) => document.querySelector(sel);

    // ===== ìƒíƒœ =====
    const startScreen = $('#start-screen');
    const quizContainer = $('#quiz-container');
    const resultScreen = $('#result-screen');
    const startBtn = $('#start-btn');
    const studentNameInput = $('#student-name');
    const retryBtn = $('#retry-btn');

    studentNameInput.placeholder = ["Julien", "LÃ©a", "LÃ©o", "Alice", "Emma", "Lucas"][Math.floor(Math.random()*6)];

    let studentName = '', startTime, endTime;
    let currentQuestionIndex = 0;
    let questionsData = [], quizData = [];
    let mediaRecorder, audioChunks = [];
    let resultsSent = false; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€

    // ===== ë°ì´í„° =====
    const verbPairs = [
      { base:'ë°¥ì„ ë¨¹ë‹¤', verb:'manger', afterForm:'ë¨¹ì€ í›„ì—', beforeForm:'ë¨¹ê¸° ì „ì—' },
      { base:'ìˆ™ì œë¥¼ í•˜ë‹¤', verb:'faire les devoirs', afterForm:'í•œ í›„ì—', beforeForm:'í•˜ê¸° ì „ì—' },
      { base:'ì˜í™”ë¥¼ ë³´ë‹¤', verb:'regarder un film', afterForm:'ë³¸ í›„ì—', beforeForm:'ë³´ê¸° ì „ì—' },
      { base:'ì±…ì„ ì½ë‹¤', verb:'lire un livre', afterForm:'ì½ì€ í›„ì—', beforeForm:'ì½ê¸° ì „ì—' },
      { base:'ìš´ë™ì„ í•˜ë‹¤', verb:'faire du sport', afterForm:'ìš´ë™í•œ í›„ì—', beforeForm:'ìš´ë™í•˜ê¸° ì „ì—' },
      { base:'ì ì„ ìë‹¤', verb:'dormir', afterForm:'ì” í›„ì—', beforeForm:'ìê¸° ì „ì—' },
      { base:'ìˆ˜ì—…ì— ë“¤ì–´ê°€ë‹¤', verb:'entrer en classe', afterForm:'ë“¤ì–´ê°„ í›„ì—', beforeForm:'ë“¤ì–´ê°€ê¸° ì „ì—' },
      { base:'ì†ì„ ì”»ë‹¤', verb:'se laver les mains', afterForm:'ì”»ì€ í›„ì—', beforeForm:'ì”»ê¸° ì „ì—' },
      { base:'ë°–ìœ¼ë¡œ ë‚˜ê°€ë‹¤', verb:'sortir', afterForm:'ë‚˜ê°„ í›„ì—', beforeForm:'ë‚˜ê°€ê¸° ì „ì—' },
      { base:'ì»¤í”¼ë¥¼ ë§ˆì‹œë‹¤', verb:'boire du cafÃ©', afterForm:'ë§ˆì‹  í›„ì—', beforeForm:'ë§ˆì‹œê¸° ì „ì—' }
    ];
    const sentencePool = [
      { fr:"AprÃ¨s avoir fini le travail, je suis rentrÃ© chez moi.", ko:"ì¼ì„ ëë‚¸ í›„ì— ì§‘ì— ëŒì•„ì™”ì–´ìš”.", hint1:"ã…‡ã…‡ ã„²ã„´ ã…ã…‡ ã…ˆã…‡ ã„·ã…‡ã…‡ã…‡ã…‡.", hint2:"ì¼(travail), ëë‚´ë‹¤(finir), ì§‘(maison)"},
      { fr:"Avant de sortir, jâ€™ai pris mon parapluie.", ko:"ë‚˜ê°€ê¸° ì „ì— ìš°ì‚°ì„ ì±™ê²¼ì–´ìš”.", hint1:"ã„´ã„±ã„± ã…ˆã…‡ ã…‡ã……ã…‡ ã…Šã„±ã…‡ã…‡.", hint2:"ë‚˜ê°€ë‹¤(sortir), ìš°ì‚°(parapluie), ì±™ê¸°ë‹¤(prendre)"},
      { fr:"AprÃ¨s avoir regardÃ© le film, jâ€™ai dormi.", ko:"ì˜í™”ë¥¼ ë³¸ í›„ì— ì ì„ ì¤ì–´ìš”.", hint1:"ã…‡ã…ã„¹ ã…‚ ã…ã…‡ ã…ˆã…‡ ã…ˆã…‡ã…‡.", hint2:"ì˜í™”(film), ë³´ë‹¤(regarder), ì ì„ ìë‹¤(dormir)"},
      { fr:"Avant de manger du pain, je bois du lait.", ko:"ë¹µì„ ë¨¹ê¸° ì „ì— ìš°ìœ ë¥¼ ë§ˆì…”ìš”.", hint1:"ã…ƒã…‡ ã…ã„± ã…ˆã…‡ ã…‡ã…‡ã„¹ ã…ã……ã…‡.", hint2:"ë¹µ(pain), ë¨¹ë‹¤(manger), ìš°ìœ (lait), ë§ˆì‹œë‹¤(boire)"},
      { fr:"AprÃ¨s avoir fait du sport, j'ai pris une douche.", ko:"ìš´ë™í•œ í›„ì— ìƒ¤ì›Œí–ˆì–´ìš”.", hint1:"ã…‡ã„·ã… ã…ã…‡ ã……ã…‡ã…ã…‡ã…‡.", hint2:"ìš´ë™í•˜ë‹¤(faire du sport), ìƒ¤ì›Œí•˜ë‹¤(prendre une douche)"},
      { fr:"Avant de dormir, je lis un livre.", ko:"ìê¸° ì „ì— ì±…ì„ ì½ì–´ìš”.", hint1:"ã…ˆã„± ã…ˆã…‡ ã…Šã…‡ ã…‡ã…‡ã…‡.", hint2:"ìë‹¤(dormir), ì±…(livre), ì½ë‹¤(lire)"}
    ];
    const shuffle = (arr)=>arr.sort(()=>Math.random()-0.5);

    function getGradingMessage(p, lang='ko'){
      if(lang==='fr'){
        if(p>=100) return "Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !";
        if(p>=80)  return "TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !";
        if(p>=60)  return "Pas mal du tout ! ğŸ˜ Encore un petit effort et câ€™est le top !";
        return "Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª";
      }
      if(p>=100) return "ì™„ë²½ ê·¸ ìì²´! ğŸ‘‘ğŸ‰ ì²œì¬ ì¸ì¦!";
      if(p>=80)  return "ì•„ì£¼ ì˜í–ˆì–´ìš”! ğŸ‘ ê±°ì˜ ë§ˆìŠ¤í„°!";
      if(p>=60)  return "ê½¤ ì˜í–ˆì–´ìš”! ğŸ˜ ì¡°ê¸ˆë§Œ ë”!";
      return "ì, ì»¤í”¼ í•œ ì” í•˜ê³  ë‹¤ì‹œ! â˜•ğŸ’ªğŸ‡°ğŸ‡·";
    }

    // ===== í€´ì¦ˆ êµ¬ì„± =====
    function generateAndSetQuizData() {
      quizData = [];
      quizData.push({ type:'explanation' });

      const vp = shuffle([...verbPairs]);

      // ì‰¬ìš´ ì„ íƒí˜• 5
      vp.slice(0,5).forEach(pair=>{
        const useAfter = Math.random()>0.5;
        const correct = useAfter ? pair.afterForm : pair.beforeForm;
        const distract = useAfter ? pair.beforeForm : pair.afterForm;
        const fr_instruction = useAfter ? `aprÃ¨s avoir ${pair.verb}` : `avant de ${pair.verb}`;
        quizData.push({
          type:'multiple-choice',
          fr:`Choisissez la forme correcte pour dire "${fr_instruction}".`,
          ko:`(${pair.base}) ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`,
          correctAnswer: correct,
          choices: shuffle([correct, distract])
        });
      });

      // ë¹ˆì¹¸ 5
      vp.slice(5,10).forEach(pair=>{
        const useAfter = Math.random()>0.5;
        const correct = useAfter ? pair.afterForm : pair.beforeForm;
        const fr_instruction = useAfter ? `aprÃ¨s avoir ${pair.verb}` : `avant de ${pair.verb}`;
        quizData.push({
          type:'fill-in-the-blank',
          fr:`Ã‰crivez la forme pour dire "${fr_instruction}".`,
          ko:`(${pair.base}) ___ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.`,
          correctAnswer: correct
        });
      });

      // ë²ˆì—­ 5
      shuffle([...sentencePool]).slice(0,5).forEach(q=>quizData.push({ type:'translate-sentence', ...q }));
      // ë“£ê¸° 5
      shuffle([...sentencePool]).slice(0,5).forEach(q=>quizData.push({ type:'listening-dictation', ...q }));
    }

    // ===== ì´ë²¤íŠ¸ =====
    startBtn.addEventListener('click', startQuiz);
    retryBtn.addEventListener('click', () => location.reload());

    function startQuiz(){
      studentName = studentNameInput.value.trim();
      if(!studentName){ alert('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom)'); return; }
      startTime = new Date();
      startScreen.classList.add('hidden');
      quizContainer.classList.remove('hidden');
      generateAndSetQuizData();
      questionsData = quizData.map((q,i)=>({
        number:i,
        ...q,
        userAnswer:{},
        listenCount:0,
        hint1Count:0,
        hint2Count:0,
        recording:{}
      }));
      renderQuestion();
    }

    function renderQuestion(){
      quizContainer.innerHTML = '';
      if(currentQuestionIndex >= quizData.length){ finishQuiz(); return; }
      const q = quizData[currentQuestionIndex];

      const card = document.createElement('div');
      card.className = 'p-6 bg-white rounded-xl shadow-lg';

      let html = `<p class="text-sm text-slate-500 mb-4">Question ${currentQuestionIndex} / ${quizData.length-1}</p>`;

      if(q.type==='explanation'){
        html += `
          <h2 class="section-title">Comment dire "AprÃ¨s" et "Avant" en corÃ©en?</h2>
          <div class="space-y-6 text-lg">
            <div>
              <h3 class="font-bold text-xl mb-2 text-indigo-700">1. Avec un Verbe (ë™ì‚¬)</h3>
              <div class="pl-4 border-l-4 border-indigo-200 space-y-4">
                <div>
                  <p><strong>Pour dire "aprÃ¨s avoir fait..." â†’ <code class="bg-indigo-100 p-1 rounded">-(ìœ¼)ã„´ í›„ì—</code></strong></p>
                  <p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ì€ í›„ì—</span></strong></p>
                  <p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> â†’ <strong>ê°€<span class="text-red-500 font-semibold">ã„´ í›„ì—</span></strong></p>
                </div>
                <div>
                  <p><strong>Pour dire "avant de faire..." â†’ <code class="bg-green-100 p-1 rounded">-ê¸° ì „ì—</code></strong></p>
                  <p class="ml-4">Ex) <strong>ë¨¹ë‹¤</strong> â†’ <strong>ë¨¹<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong></p>
                  <p class="ml-4">Ex) <strong>ê°€ë‹¤</strong> â†’ <strong>ê°€<span class="text-red-500 font-semibold">ê¸° ì „ì—</span></strong></p>
                </div>
              </div>
            </div>
            <div class="border-t pt-6">
              <h3 class="font-bold text-xl mb-2 text-sky-700">2. Avec un Nom (ëª…ì‚¬)</h3>
              <div class="pl-4 border-l-4 border-sky-200 space-y-2">
                <p>On peut aussi les utiliser avec des noms dÃ©crivant <strong>une action/Ã©vÃ©nement</strong>.</p>
                <p class="ml-4"><strong>ìˆ˜ì—… í›„ì—</strong> (aprÃ¨s le cours) / <strong>ì‹ì‚¬ ì „ì—</strong> (avant le repas)</p>
                <div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                  <p class="font-bold text-amber-800">ğŸ’¡ Astuce !</p>
                  <p class="text-amber-700">"ì¼ í›„ì—" ë³´ë‹¤ëŠ” <strong>"í‡´ê·¼ í›„ì—"</strong>ê°€ ë” ìì—°ìŠ¤ëŸ¬ì›Œìš”.</p>
                </div>
              </div>
            </div>
          </div>`;
      } else {
        if(q.type==='multiple-choice') html += `<h2 class="section-title">Ã‰tape 1: Choisir / ì•Œë§ì€ ë‹µ ê³ ë¥´ê¸°</h2>`;
        if(q.type==='fill-in-the-blank') html += `<h2 class="section-title">Ã‰tape 2: Remplir / ë¹ˆì¹¸ ì±„ìš°ê¸°</h2>`;
        if(q.type==='translate-sentence') html += `<h2 class="section-title">Ã‰tape 3: Traduire / ë¬¸ì¥ ë²ˆì—­í•˜ê¸°</h2>`;
        if(q.type==='listening-dictation') html += `<h2 class="section-title">Ã‰tape 4: Ã‰couter et Ã©crire / ë“£ê³  ë°›ì•„ì“°ê¸°</h2>`;

        if(q.type==='listening-dictation'){
          html += `<p class="text-xl font-semibold mb-2">Ã‰coutez et Ã©crivez. <span class="font-normal text-slate-600 ml-1">Mots-clÃ©s: ${q.hint2}</span></p>`;
        } else {
          html += `<p class="text-xl font-semibold text-slate-800 mb-2">${q.fr}</p>`;
        }

        if(q.type==='listening-dictation'){
          html += `<div class="flex items-center mt-2 mb-4">
            <button onclick="playAudio(event, '${q.ko.replace(/'/g,"\\'")}', 'man')" class="btn btn-secondary">Ã‰couter / ë¬¸ì¥ ë“£ê¸°</button>
          </div>`;
        } else if(q.type!=='translate-sentence'){
          html += `<p class="text-2xl font-bold text-indigo-600 mb-4">${q.ko}</p>`;
        }

        if(q.type==='multiple-choice'){
          html += `<div class="grid grid-cols-1 gap-3">${
            q.choices.map(c=>`<button class="btn btn-choice" data-answer="${c}">${c}</button>`).join('')
          }</div>`;
        } else if(q.type==='fill-in-the-blank'){
          html += q.ko.replace('___', `<input type="text" id="answer-input" class="p-2 border-2 border-slate-300 rounded-lg text-lg text-center mx-2" style="width:220px;">`);
          html += `<div class="mt-4 p-3 bg-slate-50 rounded-lg text-slate-600">
              <p class="font-bold">ğŸ’¡ Rappel (ë³µìŠµ)</p>
              <p><b class="text-green-700">-ê¸° ì „ì—</b> (avant de) : ë™ì‚¬ ì–´ê°„ + ê¸° ì „ì—<br>
                 <b class="text-indigo-700">-(ìœ¼)ã„´ í›„ì—</b> (aprÃ¨s avoir) : -ì€ í›„ì—(ììŒ), -ã„´ í›„ì—(ëª¨ìŒ)</p>
            </div>`;
        } else if(q.type==='translate-sentence'){
          html += `<textarea id="answer-input" class="w-full p-3 border-2 border-slate-300 rounded-lg" rows="2" placeholder="Traduisez en corÃ©en..."></textarea>`;
          if(q.hint1 && q.hint2){
            html += `<div class="mt-4 flex gap-2">
                <button onclick="showHint(1, '${q.hint1}')" class="btn-hint bg-green-100 text-green-800">Aidez moi ğŸ™ (ì´ˆì„±)</button>
                <button onclick="showHint(2, '${q.hint2}')" class="btn-hint bg-blue-100 text-blue-800">Au secours ğŸ›Ÿ (ë‹¨ì–´)</button>
              </div>
              <div id="hint-display" class="mt-3 p-3 bg-slate-50 rounded-lg text-slate-600 min-h-[50px]"></div>`;
          }
        } else if(q.type==='listening-dictation'){
          html += `
            <p class="font-semibold mt-4 mb-2">1. ë“£ê³  ë°›ì•„ì“°ê¸°</p>
            <input id="dictation1" class="w-full p-2 border-2 border-slate-300 rounded-lg">
            <p class="font-semibold mt-4 mb-2">2. ë‚´ ëª©ì†Œë¦¬ ë…¹ìŒ</p>
            <div class="flex items-center gap-4">
              <button id="record-btn" class="btn btn-record" onclick="toggleRecording()">Enregistrer / ë…¹ìŒí•˜ê¸°</button>
              <audio id="recording-player" controls hidden></audio>
            </div>
            <p class="font-semibold mt-4 mb-2">3. ë‚´ ëª©ì†Œë¦¬ë¥¼ ë“£ê³  ë°›ì•„ì“°ê¸°</p>
            <input id="dictation2" class="w-full p-2 border-2 border-slate-300 rounded-lg">`;
        }
      }

      // í•˜ë‹¨ ë„¤ë¹„/ëë‚´ê¸°
      html += `
        <div class="mt-6 flex justify-between items-center no-print">
          <button id="prev-btn" class="btn btn-primary ${currentQuestionIndex===0?'invisible':''}">PrÃ©cÃ©dent / ì´ì „</button>
          <button id="next-btn" class="btn btn-primary">
            ${currentQuestionIndex===quizData.length-1 ? 'Terminer / ëë‚´ê¸°' : 'Suivant / ë‹¤ìŒ'}
          </button>
        </div>`;

      card.innerHTML = html;
      quizContainer.appendChild(card);

      addQuestionListeners();
    }

    function addQuestionListeners(){
      $('#prev-btn')?.addEventListener('click', prevQuestion);
      $('#next-btn')?.addEventListener('click', nextQuestion);

      document.querySelectorAll('.btn-choice').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          document.querySelectorAll('.btn-choice').forEach(b=>b.classList.remove('selected'));
          e.currentTarget.classList.add('selected');
          setTimeout(nextQuestion, 250);
        });
      });
    }

    function showHint(num, text){
      if(num===1) questionsData[currentQuestionIndex].hint1Count++;
      else questionsData[currentQuestionIndex].hint2Count++;
      const hintBox = $('#hint-display');
      if(hintBox) hintBox.textContent = text;
    }

    function saveCurrentAnswer(){
      const q = quizData[currentQuestionIndex];
      const qd = questionsData[currentQuestionIndex];
      if(!q || !qd) return;

      if(q.type==='multiple-choice'){
        const sel = document.querySelector('.btn-choice.selected');
        qd.userAnswer = sel ? sel.dataset.answer : '';
      } else if(q.type==='fill-in-the-blank' || q.type==='translate-sentence'){
        qd.userAnswer = $('#answer-input')?.value.trim() || '';
      } else if(q.type==='listening-dictation'){
        qd.userAnswer = {
          dictation1: $('#dictation1')?.value.trim() || '',
          dictation2: $('#dictation2')?.value.trim() || ''
        };
      }
    }

    function prevQuestion(){ if(currentQuestionIndex>0){ saveCurrentAnswer(); currentQuestionIndex--; renderQuestion(); } }
    function nextQuestion(){
      saveCurrentAnswer();
      if(currentQuestionIndex < quizData.length - 1){ currentQuestionIndex++; renderQuestion(); }
      else { finishQuiz(); }
    }

    function evaluateAnswers(){
      questionsData.forEach(qd=>{
        if(qd.type==='explanation') return;
        const fmt = (s)=>(s||'').replace(/[.\s+!?]/g,'').toLowerCase();
        let input = '';
        if(typeof qd.userAnswer === 'string') input = qd.userAnswer;
        else if(qd.userAnswer && qd.userAnswer.dictation1) input = qd.userAnswer.dictation1;

        if(qd.type==='multiple-choice' || qd.type==='fill-in-the-blank'){
          qd.isCorrect = fmt(input) === fmt(qd.correctAnswer);
        } else if(qd.type==='translate-sentence' || qd.type==='listening-dictation'){
          qd.isCorrect = fmt(input) === fmt(qd.ko);
        }
      });
    }

    async function finishQuiz(){
      endTime = new Date();
      evaluateAnswers();

      quizContainer.classList.add('hidden');
      resultScreen.classList.remove('hidden');

      const gradables = questionsData.filter(q=>q.type!=='explanation');
      const score = gradables.filter(q=>q.isCorrect).length;
      const total = gradables.length;
      const pct = total? Math.round(score/total*100) : 0;

      $('#result-message').innerHTML =
        `<strong class="text-2xl">${studentName}, ton score est de ${score} / ${total}</strong><br>${getGradingMessage(pct,'fr')}`;

      if(pct===100) confetti({ particleCount:200, spread:90, origin:{y:.6} });

      try { await sendResults(); }
      catch(e){ /* sendResults ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ */ }
    }

    // ===== ì˜¤ë””ì˜¤ ì¬ìƒ (Blob URL) =====
    async function playAudio(event, text, voice='woman'){
      const qd = questionsData.find(d=>d.ko===text);
      if(qd) qd.listenCount++;

      const btn = event.currentTarget;
      const original = btn.innerHTML;
      btn.disabled = true; btn.innerHTML = 'ë¡œë”©...';

      let url;
      try{
        const res = await fetch('/.netlify/functions/generate-audio',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text, voice })
        });
        if(!res.ok){
          const msg = await res.text();
          throw new Error(`generate-audio ${res.status}: ${msg}`);
        }
        const { audioData, mimeType } = await res.json();
        if(!audioData) throw new Error('No audio data returned');

        const blob = base64ToBlob(audioData, mimeType || 'audio/mpeg');
        url = URL.createObjectURL(blob);

        const audio = new Audio(url);
        await audio.play();
        audio.onended = ()=>{ if(url) URL.revokeObjectURL(url); btn.disabled=false; btn.innerHTML=original; };

      } catch(err){
        console.error('Audio playback error:', err);
        alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.\n' + String(err).slice(0,250));
        try { await sendErrorReport(err, { where:'playAudio', ko:text }); } catch(_){}
        if(url) URL.revokeObjectURL(url);
        btn.disabled=false; btn.innerHTML=original;
      }
    }

    // ===== ë…¹ìŒ =====
    async function toggleRecording(){
      const recordBtn = document.getElementById('record-btn');
      const player = document.getElementById('recording-player');

      if(typeof MediaRecorder === 'undefined'){
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”. (iOS SafariëŠ” ìµœì‹  ë²„ì „ í•„ìš”)');
        return;
      }

      if(mediaRecorder && mediaRecorder.state==='recording'){
        mediaRecorder.stop();
        recordBtn.classList.remove('recording');
        recordBtn.textContent = 'Enregistrer / ë…¹ìŒí•˜ê¸°';
        return;
      }

      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioChunks = [];
        const startedAt = Date.now();

        mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm' });
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = ()=>{
          const duration = Math.round((Date.now()-startedAt)/1000);
          const blob = new Blob(audioChunks, { type:'audio/webm' });
          const url = URL.createObjectURL(blob);
          player.src = url; player.hidden = false;

          const reader = new FileReader();
          reader.onloadend = ()=>{
            const base64 = (reader.result||'').split(',')[1] || '';
            const filename = `q${currentQuestionIndex+1}_${Date.now()}.webm`;
            questionsData[currentQuestionIndex].recording = {
              base64, filename, mimeType:'audio/webm', duration
            };
          };
          reader.readAsDataURL(blob);

          stream.getTracks().forEach(t=>t.stop());
        };

        mediaRecorder.start();
        recordBtn.classList.add('recording');
        recordBtn.textContent = 'ArrÃªter / ë…¹ìŒ ì¤‘ì§€';

      } catch(err){
        console.error('Error recording:', err);
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. (HTTPS í™˜ê²½) / Autorisez le micro.');
        try { await sendErrorReport(err, { where:'toggleRecording' }); } catch(_){}
      }
    }

    // ===== ê²°ê³¼ ì „ì†¡ =====
    async function sendResults(){
      if(resultsSent) return; // ì¤‘ë³µ ë°©ì§€
      resultsSent = true;

      const totalTimeSeconds = Math.round((endTime - startTime)/1000);
      const qs = JSON.parse(JSON.stringify(questionsData));

      // userAnswerë¥¼ ë¬¸ìì—´ë¡œ ì •ê·œí™” + recording í‚¤ ë³´ì •
      qs.forEach(q=>{
        if(typeof q.userAnswer === 'object' && q.userAnswer !== null){
          q.userAnswer = Object.values(q.userAnswer).filter(Boolean).join(' / ');
        } else {
          q.userAnswer = (q.userAnswer||'')+'';
        }
        if(!q.recording) q.recording = {};
        q.recording = {
          base64: q.recording.base64 || '',
          filename: q.recording.filename || `rec_q${q.number||'X'}.webm`,
          mimeType: q.recording.mimeType || 'audio/webm',
          duration: q.recording.duration || 0
        };
      });

      const payload = {
        studentName,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        totalTimeSeconds,
        questions: qs
      };

      try{
        const res = await fetch('/.netlify/functions/send-results',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const msg = await res.text();
          throw new Error(`send-results ${res.status}: ${msg}`);
        }
        console.log('Results sent successfully!');
      } catch(err){
        console.error('Error sending results:', err);
        alert('ê²°ê³¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.\n' + String(err).slice(0,300));
        try { await sendErrorReport(err, { where:'sendResults' }); } catch(_){}
        resultsSent = false; // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ í—ˆìš©
      }
    }

    // ===== ì—ëŸ¬ ë¦¬í¬íŠ¸(í•™ìƒì´ ë³¸ ì˜¤ë¥˜ë¥¼ ì„ ìƒë‹˜ ë©”ì¼ë¡œ ì „ì†¡) =====
    async function sendErrorReport(error, ctx={}){
      const q = questionsData[currentQuestionIndex] || {};
      const errQuestion = {
        number: q.number ?? -1,
        ko: q.ko || '',
        fr: q.fr || '',
        userAnswer: `__ERROR__ ${String(error).slice(0,500)}`,
        isCorrect: false,
        listenCount: q.listenCount || 0,
        hint1Count: q.hint1Count || 0,
        hint2Count: q.hint2Count || 0,
        recording: { base64:'', filename:'', mimeType:'', duration:0 }
      };
      const payload = {
        studentName: `${studentName || 'Ã‰lÃ¨ve'} (ErrorReport)`,
        startTime: (startTime||new Date()).toISOString(),
        endTime: (new Date()).toISOString(),
        totalTimeSeconds: 0,
        questions: [ errQuestion, { number:'context', ko: JSON.stringify(ctx), userAnswer:'error-context', isCorrect:false, recording:{} } ]
      };
      try{
        await fetch('/.netlify/functions/send-results',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
      } catch(_e){ /* ë¬´ì‹œ */ }
    }

    // ===== ì „ì—­ ë…¸ì¶œ =====
    window.playAudio = playAudio;
    window.toggleRecording = toggleRecording;
    window.showHint = showHint;
  </script>
</body>
</html>
