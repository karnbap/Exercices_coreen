<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice : particules de précision et de départ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .quiz-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #f9fafb; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn { transition: all 0.3s ease; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-audio { background-color: #f59e0b; color: white; }
        .btn-audio:hover:not(:disabled) { background-color: #d97706; }
        .btn-audio:disabled { background-color: #f59e0b; opacity: 0.7; cursor: not-allowed; }
        .feedback { font-size: 1rem; font-weight: bold; margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.5rem; display: none; }
        .feedback.correct { color: #16a34a; background-color: #dcfce7; }
        .feedback.incorrect { color: #dc2626; background-color: #fee2e2; }
        .answer-key { background-color: #eef2ff; border: 1px solid #c7d2fe; padding: 0.75rem; border-radius: 0.5rem; color: #4338ca; font-weight: 500; }
        input[type="text"] { border: 2px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem 0.75rem; transition: border-color 0.3s; }
        input[type="text"]:focus { outline: none; border-color: #3b82f6; }
        .tip-box { background-color: #fefce8; border-left: 4px solid #facc15; padding: 1rem; margin-top: 1.5rem; }
        .hint-box { font-size: 0.9rem; color: #4b5563; background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.75rem; }
        .analysis-box { background-color: #f0f9ff; border: 1px solid #bae6fd; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .question-block { padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; background-color: white; }
        .section-title { border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="quiz-container">
        <div class="text-center mb-8">
            <a href="/index.html" class="text-indigo-600 hover:text-indigo-800 mb-4 block">&larr; Retour à la liste</a>
            <h1 class="text-4xl font-bold text-gray-800">연습 문제: '에' vs '에서' (심화)</h1>
            <p class="text-gray-600 mt-2">Exercices pour maîtriser les usages variés de '에' et '에서'.</p>
        </div>

        <div class="mb-12 p-6 bg-white rounded-lg shadow-sm">
             <h2 class="text-2xl font-semibold text-blue-700 mb-4">📌 Concepts Clés : '에' vs '에서'</h2>
             <table class="w-full text-left border-collapse">
                 <thead>
                     <tr>
                         <th class="border-b-2 p-4 text-lg font-bold text-gray-700">Particule</th>
                         <th class="border-b-2 p-4 text-lg font-bold text-gray-700">Concept Principal</th>
                     </tr>
                 </thead>
                 <tbody>
                     <tr class="hover:bg-blue-50">
                         <td class="p-4 border-b font-mono text-xl text-blue-600 align-top">에</td>
                         <td class="p-4 border-b text-gray-600">
                             <strong class="text-lg text-gray-800">Lie une information au verbe.</strong>
                             <p class="mt-2">Spécifie des informations complémentaires comme le <strong>temps</strong>, le <strong>lieu (statique/destination)</strong>, ou le <strong>prix</strong>.</p>
                             <em class="block mt-2 text-gray-500">Ex: <strong>3시에</strong> 만나요 (Temps), <strong>집에</strong> 있어요 (Lieu), 한 개<strong>에</strong> 천 원 (Prix).</em>
                         </td>
                     </tr>
                     <tr class="hover:bg-amber-50">
                         <td class="p-4 border-b font-mono text-xl text-amber-600 align-top">에서</td>
                         <td class="p-4 border-b text-gray-600">
                            <strong class="text-lg text-gray-800">Indique le point de départ.</strong>
                            <p class="mt-2">Marque l'origine d'une <strong>action</strong> (lieu où elle se déroule), d'un <strong>trajet</strong>, ou d'un <strong>changement d'état</strong>.</p>
                            <em class="block mt-2 text-gray-500">Ex: <strong>도서관에서</strong> 공부해요 (Action), <strong>서울에서</strong> 왔어요 (Trajet), <strong>학생에서</strong> 선생님이 되었어요 (État).</em>
                         </td>
                     </tr>
                 </tbody>
             </table>
             <div class="tip-box">
                 <p class="font-bold text-lg text-yellow-800 flex items-center"><i class="fas fa-lightbulb mr-3"></i>L'astuce pour ne plus se tromper !</p>
                 <p class="mt-2 text-gray-700">Quand on utilise '에', on connecte une information (lieu, temps, prix) au verbe.</p>
                 <p class="mt-2 text-gray-700">Mais si le verbe décrit une <strong>ACTION</strong>, on ajoute <strong>"서"</strong> à "에" pour montrer le point de départ de cette action.</p>
                 <ul class="list-disc list-inside mt-2 pl-2 text-gray-700">
                     <li><strong>에</strong> = Lie la destination / le lieu à un verbe d'état.</li>
                     <li><strong>에 + 서</strong> = Montre qu'une <strong>action</strong> se déroule à cet endroit.</li>
                 </ul>
                 <p class="mt-3 font-semibold text-gray-800">Donc, quand un lieu apparaît, demandez-vous : le verbe décrit une <strong>action</strong> ou un <strong>état</strong> ? C'est la clé !</p>
             </div>
        </div>
        
        <div id="quiz-sections">
            <!-- Les sections seront générées ici -->
        </div>
    </div>

    <script>
        const questions = {
            read: [
                { id: 'read1', text: '저는 지금 회사( ? ) 있어요.', verb: '있다', verbType: 'state', correctAnswer: '에', explanation: "'있다' (être) est un verbe d'état. Il décrit où quelque chose se trouve, pas une action qui s'y déroule.", hint: "<strong>Vocabulaire:</strong> 저(je), 지금(maintenant), 회사(entreprise), 있다(être)" },
                { id: 'read2', text: '동생이 공원( ? ) 운동해요.', verb: '운동하다', verbType: 'action', correctAnswer: '에서', explanation: "'운동하다' (faire de l'exercice) est une action. L'action se déroule DANS le parc.", hint: "<strong>Vocabulaire:</strong> 동생(frère/sœur), 공원(parc), 운동하다(faire de l'exercice)" },
                { id: 'read3', text: '우리는 내일 부산( ? ) 갈 거예요.', verb: '가다', verbType: 'destination', correctAnswer: '에', explanation: "'가다' (aller) est un verbe de mouvement. '에' indique la destination.", hint: "<strong>Vocabulaire:</strong> 우리(nous), 내일(demain), 부산(Busan), 가다(aller)" },
                { id: 'read4', text: '저는 오후 3시( ? ) 친구를 만나요.', verb: '만나다', verbType: 'time', correctAnswer: '에', explanation: "Pour indiquer un moment précis dans le temps, on utilise toujours '에'.", hint: "<strong>Vocabulaire:</strong> 오후(après-midi), 시(heure), 친구(ami), 만나다(rencontrer)" },
                { id: 'read5', text: '고양이가 의자 위( ? ) 자고 있어요.', verb: '자고 있다', verbType: 'state', correctAnswer: '에', explanation: "'자고 있다' (être en train de dormir) est considéré comme un état. Le chat est DANS un état de sommeil SUR la chaise.", hint: "<strong>Vocabulaire:</strong> 고양이(chat), 의자 위(sur la chaise), 자다(dormir)" },
                { id: 'read6', text: '우리는 어제 영화관( ? ) 영화를 봤어요.', verb: '보다', verbType: 'action', correctAnswer: '에서', explanation: "'보다' (regarder) un film est une action. L'action se déroule DANS le cinéma.", hint: "<strong>Vocabulaire:</strong> 어제(hier), 영화관(cinéma), 영화(film), 보다(regarder)" },
                { id: 'read7', text: '이 버스는 서울( ? ) 출발해요.', verb: '출발하다', verbType: 'origin', correctAnswer: '에서', explanation: "'출발하다' (partir) indique un point de départ. '에서' marque cette origine.", hint: "<strong>Vocabulaire:</strong> 버스(bus), 서울(Séoul), 출발하다(partir)" },
                { id: 'read8', text: '이 사과는 3개( ? ) 5,000원이에요.', verb: '이다', verbType: 'price', correctAnswer: '에', explanation: "Pour indiquer le prix par unité, on utilise '에'.", hint: "<strong>Vocabulaire:</strong> 사과(pomme), 개(unité), 원(won)" },
                { id: 'read9', text: '은행( ? ) 돈을 찾았어요.', verb: '찾다', verbType: 'action', correctAnswer: '에서', explanation: "'돈을 찾다' (retirer de l'argent) est une action qui se déroule DANS la banque.", hint: "<strong>Vocabulaire:</strong> 은행(banque), 돈(argent), 찾다(retirer)" },
                { id: 'read10', text: '회의는 10층( ? ) 열릴 거예요.', verb: '열리다', verbType: 'action', correctAnswer: '에서', explanation: "'열리다' (se tenir, avoir lieu) est une action/événement qui se déroule AU 10ème étage.", hint: "<strong>Vocabulaire:</strong> 회의(réunion), 층(étage), 열리다(se tenir)" }
            ],
            write: [
                { id: 'write1', text: '백화점 ( ? ) 옷을 샀어요.', verb: '사다', verbType: 'action', correctAnswer: '에서', explanation: "'사다' (acheter) est une action. L'achat a lieu DANS le grand magasin.", hint: "<strong>Vocabulaire:</strong> 백화점(grand magasin), 옷(vêtement), 사다(acheter)" },
                { id: 'write2', text: '저는 프랑스 ( ? ) 왔어요.', verb: '오다', verbType: 'origin', correctAnswer: '에서', explanation: "'오다' (venir) indique l'origine, le point de départ. On utilise '에서'.", hint: "<strong>Vocabulaire:</strong> 프랑스(France), 오다(venir)" },
                { id: 'write3', text: '수업이 몇 시 ( ? ) 끝나요?', verb: '끝나다', verbType: 'time', correctAnswer: '에', explanation: "On demande un moment précis dans le temps, donc on utilise '에'.", hint: "<strong>Vocabulaire:</strong> 수업(cours), 몇 시(quelle heure), 끝나다(se terminer)" },
                { id: 'write4', text: '친구가 도서관 ( ? ) 책을 빌렸어요.', verb: '빌리다', verbType: 'action', correctAnswer: '에서', explanation: "'빌리다' (emprunter) est une action qui se déroule DANS la bibliothèque.", hint: "<strong>Vocabulaire:</strong> 도서관(bibliothèque), 책(livre), 빌리다(emprunter)" },
                { id: 'write5', text: '이 빵은 한 개 ( ? ) 2유로예요.', verb: '이다', verbType: 'price', correctAnswer: '에', explanation: "Pour indiquer le prix par unité, on utilise '에'.", hint: "<strong>Vocabulaire:</strong> 빵(pain), 한 개(une pièce), 유로(euro)" },
                { id: 'write6', text: '학생 ( ? ) 선생님이 되었어요.', verb: '되다', verbType: 'origin', correctAnswer: '에서', explanation: "'되다' (devenir) peut indiquer un changement d'état, où '학생' est le point de départ. On utilise '에서'.", hint: "<strong>Vocabulaire:</strong> 학생(étudiant), 선생님(professeur), 되다(devenir)" },
                { id: 'write7', text: '저는 한국 ( ? ) 살아요.', verb: '살다', verbType: 'action', correctAnswer: '에서', explanation: "Bien que 'vivre' puisse sembler un état, en coréen, l'action de 'mener sa vie' se déroule DANS un lieu. On utilise donc '에서'. C'est une exception importante!", hint: "<strong>Vocabulaire:</strong> 한국(Corée), 살다(vivre)" },
                { id: 'write8', text: '10시 ( ? ) 12시까지 회의가 있어요.', verb: '있다', verbType: 'origin', correctAnswer: '에서', explanation: "La structure 'A에서 B까지' (de A à B) est utilisée pour les périodes de temps. '에서' marque le début.", hint: "<strong>Vocabulaire:</strong> ~까지(jusqu'à), 회의(réunion)" },
                { id: 'write9', text: '저는 저녁 ( ? ) 약속이 있어요.', verb: '있다', verbType: 'time', correctAnswer: '에', explanation: "Pour indiquer une période de temps ('le soir'), on utilise '에'.", hint: "<strong>Vocabulaire:</strong> 저녁(soir), 약속(rendez-vous)" },
                { id: 'write10', text: '벽 ( ? ) 그림이 걸려 있어요.', verb: '걸려 있다', verbType: 'state', correctAnswer: '에', explanation: "'걸려 있다' (être accroché) est un verbe d'état. Le tableau est DANS un état statique SUR le mur.", hint: "<strong>Vocabulaire:</strong> 벽(mur), 그림(tableau), 걸려 있다(être accroché)" }
            ],
            listen: [
                { id: 'listen1', text: 'Écoutez et écrivez la phrase.', sentence: '친구를 카페에서 만나요.', verb: '만나다', verbType: 'action', explanation: "'만나다' (rencontrer) est une action qui se déroule DANS le café.", hint: '<strong>Vocabulaire:</strong> 친구(ami), 카페(café), 만나다(rencontrer)' },
                { id: 'listen2', text: 'Écoutez et écrivez la phrase.', sentence: '수업은 세 시에 시작해요.', verb: '시작하다', verbType: 'time', explanation: "Indique un moment précis dans le temps.", hint: '<strong>Vocabulaire:</strong> 수업(cours), 시(heure), 시작하다(commencer)' },
                { id: 'listen3', text: 'Écoutez et écrivez la phrase.', sentence: '저는 시장에 가요.', verb: '가다', verbType: 'destination', explanation: "'가다' (aller) indique une destination.", hint: '<strong>Vocabulaire:</strong> 저(je), 시장(marché), 가다(aller)' },
                { id: 'listen4', text: 'Écoutez et écrivez la phrase.', sentence: '12월에 눈이 많이 와요.', verb: '오다', verbType: 'time', explanation: "Indique une période de temps.", hint: '<strong>Vocabulaire:</strong> 12월(décembre), 눈(neige), 오다(venir/tomber)' },
                { id: 'listen5', text: 'Écoutez et écrivez la phrase.', sentence: '집에서 학교까지 걸어서 10분 걸려요.', verb: '걸리다', verbType: 'origin', explanation: "La structure 'A에서 B까지' (de A à B) marque un trajet.", hint: '<strong>Vocabulaire:</strong> 집(maison), 학교(école), 까지(jusqu\'à), 걸어서(à pied), 분(minute), 걸리다(prendre du temps)' },
                { id: 'listen6', text: 'Écoutez et écrivez la phrase.', sentence: '이 식당에서 자주 저녁을 먹어요.', verb: '먹다', verbType: 'action', explanation: "'먹다' (manger) est une action qui se déroule DANS le restaurant.", hint: '<strong>Vocabulaire:</strong> 식당(restaurant), 자주(souvent), 저녁(dîner), 먹다(manger)' },
                { id: 'listen7', text: 'Écoutez et écrivez la phrase.', sentence: '약속은 6시 30분에 있어요.', verb: '있다', verbType: 'time', explanation: "Indique à quel moment le rendez-vous 'existe'.", hint: '<strong>Vocabulaire:</strong> 약속(rendez-vous), 시(heure), 분(minute), 있다(avoir)' },
                { id: 'listen8', text: 'Écoutez et écrivez la phrase.', sentence: '저는 파리에서 태어났어요.', verb: '태어나다', verbType: 'origin', explanation: "'태어나다' (naître) indique une origine.", hint: '<strong>Vocabulaire:</strong> 저(je), 파리(Paris), 태어나다(naître)' },
                { id: 'listen9', text: 'Écoutez et écrivez la phrase.', sentence: '이 가방은 얼마에 사셨어요?', verb: '사다', verbType: 'price', explanation: "Pour demander un prix, on utilise '에'.", hint: '<strong>Vocabulaire:</strong> 가방(sac), 얼마(combien), 사다(acheter)' },
                { id: 'listen10', text: 'Écoutez et écrivez la phrase.', sentence: '저는 매일 아침 8시에 회사에 가요.', verb: '가다', verbType: 'time_destination', explanation: "Combine le temps ('8시에') et la destination ('회사에').", hint: '<strong>Vocabulaire:</strong> 매일(chaque jour), 아침(matin), 회사(entreprise), 가다(aller)' }
            ]
        };

        function renderAllSections() {
            const container = document.getElementById('quiz-sections');
            container.innerHTML = `
                <div class="mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 section-title">1. 읽기 (Lecture) - 10개</h2>
                    <div class="space-y-6">${renderSection('read')}</div>
                    <button onclick="showAllAnswers('read')" class="btn btn-secondary mt-6 px-4 py-2 rounded-lg">Voir toutes les réponses</button>
                </div>
                <div class="mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 section-title">2. 쓰기 (Écriture) - 10개</h2>
                    <div class="space-y-6">${renderSection('write')}</div>
                    <button onclick="showAllAnswers('write')" class="btn btn-secondary mt-6 px-4 py-2 rounded-lg">Voir toutes les réponses</button>
                </div>
                <div class="mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 section-title">3. 듣고 쓰기 (Dictée) - 10개</h2>
                    <div class="space-y-6">${renderSection('listen')}</div>
                    <button onclick="showAllAnswers('listen')" class="btn btn-secondary mt-6 px-4 py-2 rounded-lg">Voir toutes les réponses</button>
                </div>
            `;
        }
        
        function renderSection(sectionType) {
            let html = '';
            questions[sectionType].forEach((q, index) => {
                const isLocationQuestion = !['time', 'price', 'destination', 'time_destination'].includes(q.verbType);
                
                html += `<div class="question-block" id="block-${q.id}">`;
                html += `<p class="text-lg mb-2">${index + 1}. ${q.text.replace('( ? )', '(<span class="font-bold text-red-500">?</span>)')}</p>`;
                
                if (sectionType === 'listen') {
                    html += `<button onclick="speak(this, '${q.sentence}')" class="btn btn-audio px-4 py-2 rounded-lg mb-2"><i class="fas fa-play mr-2"></i> Écouter</button>`;
                }
                
                html += `<div class="hint-box">${q.hint}</div>`;

                if (isLocationQuestion) {
                    html += `<div class="analysis-box mt-4">
                                <p class="font-semibold">Étape 1 : Le verbe '<strong>${q.verb}</strong>' décrit-il une action ou un état/origine ?</p>
                                <div class="flex space-x-4 mt-2">
                                    <button onclick="checkAnalysis('${q.id}', 'action')" class="btn px-3 py-1 rounded-lg bg-blue-100 hover:bg-blue-200">Action</button>
                                    <button onclick="checkAnalysis('${q.id}', 'state')" class="btn px-3 py-1 rounded-lg bg-blue-100 hover:bg-blue-200">État / Origine</button>
                                </div>
                                <div id="feedback-analysis-${q.id}" class="feedback"></div>
                            </div>`;
                }

                html += `<div id="answer-section-${q.id}" class="${isLocationQuestion ? 'hidden' : ''} mt-4">`;
                
                if (sectionType === 'read') {
                    html += `<p class="font-semibold">${isLocationQuestion ? 'Étape 2 : ' : ''}Choisissez la bonne particule.</p>
                             <div class="mt-2 flex space-x-4">
                                <button onclick="checkChoiceAnswer('${q.id}', '에')" class="btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">에</button>
                                <button onclick="checkChoiceAnswer('${q.id}', '에서')" class="btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">에서</button>
                             </div>`;
                } else { // write or listen
                    html += `<p class="font-semibold">${isLocationQuestion ? 'Étape 2 : ' : ''}Complétez la phrase et vérifiez.</p>
                             <div class="mt-2 flex items-center space-x-2">
                                <div class="w-full text-lg">${q.text.replace('( ? )', `<input type="text" id="${q.id}-input" class="w-20 text-center">`)}</div>
                                <button onclick="checkWrittenAnswer('${q.id}')" class="btn btn-primary px-4 py-2 rounded-lg">Vérifier</button>
                             </div>`;
                }

                html += `<div id="feedback-${q.id}" class="feedback"></div>`;
                html += `</div>`; // Closing answer-section
                html += `<div id="answer-${q.id}" class="hidden mt-2 answer-key"></div>`;
                html += `</div>`; // Closing question-block
            });
            return html;
        }

        function checkAnalysis(questionId, userChoice) {
            const feedbackEl = document.getElementById(`feedback-analysis-${questionId}`);
            const answerSectionEl = document.getElementById(`answer-section-${questionId}`);
            const question = [...questions.read, ...questions.write].find(q => q.id === questionId);
            const correctType = (question.verbType === 'action' || question.verbType === 'origin') ? 'action' : 'state';

            feedbackEl.style.display = 'block';
            if (userChoice === correctType) {
                feedbackEl.innerHTML = `👍 Correct ! Le verbe '<strong>${question.verb}</strong>' implique bien une <strong>${correctType}</strong>. Passez à l'étape 2.`;
                feedbackEl.className = 'feedback correct';
                answerSectionEl.classList.remove('hidden');
            } else {
                feedbackEl.innerHTML = `🤔 Pas tout à fait. ${question.explanation} Réessayez !`;
                feedbackEl.className = 'feedback incorrect';
                answerSectionEl.classList.add('hidden');
            }
        }

        function checkChoiceAnswer(questionId, selectedAnswer) {
            const feedbackEl = document.getElementById(`feedback-${questionId}`);
            const question = questions.read.find(q => q.id === questionId);
            const isCorrect = question.correctAnswer === selectedAnswer;
            
            feedbackEl.style.display = 'block';
            if(isCorrect) {
                feedbackEl.innerHTML = 'Parfait ! 🎉';
                feedbackEl.className = 'feedback correct';
            } else {
                feedbackEl.innerHTML = `Incorrect. La bonne réponse est <strong>${question.correctAnswer}</strong>.`;
                feedbackEl.className = 'feedback incorrect';
            }
        }

        function checkWrittenAnswer(questionId) {
            const inputEl = document.getElementById(`${questionId}-input`);
            const feedbackEl = document.getElementById(`feedback-${questionId}`);
            const userAnswer = inputEl.value.trim();
            const question = [...questions.write, ...questions.listen].find(q => q.id === questionId);
            
            let isCorrect = false;
            if (questionId.startsWith('write')) {
                isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
            } else { // listen
                 isCorrect = userAnswer.replace(/[.\s!?]/g, '').toLowerCase() === question.sentence.replace(/[.\s!?]/g, '').toLowerCase();
            }
            
            feedbackEl.style.display = 'block';
            if (isCorrect) {
                feedbackEl.innerHTML = 'Parfait ! 🎉';
                feedbackEl.className = 'feedback correct';
            } else {
                feedbackEl.innerHTML = 'Ce n\'est pas tout à fait ça. Vérifiez la phrase.';
                feedbackEl.className = 'feedback incorrect';
            }
        }
        
        function showAllAnswers(sectionType = null) {
            const sections = sectionType ? [sectionType] : ['read', 'write', 'listen'];
            sections.forEach(section => {
                questions[section].forEach(q => {
                    const answerEl = document.getElementById(`answer-${q.id}`);
                    if (section === 'read') {
                        answerEl.innerHTML = `Réponse: ${q.text.replace('( ? )', `<strong>${q.correctAnswer}</strong>`)}`;
                    } else if (section === 'write') {
                        answerEl.innerHTML = `Réponse: ${q.text.replace('( ? )', `<strong>${q.correctAnswer}</strong>`)}`;
                    } else { // listen
                        answerEl.innerHTML = `Réponse: <strong>${q.sentence}</strong>`;
                    }
                    answerEl.classList.remove('hidden');
                });
            });
        }

        // --- Audio Generation Logic (Calls Netlify Function) ---
        function base64ToArrayBuffer(base64){const binaryString=window.atob(base64);const len=binaryString.length;const bytes=new Uint8Array(len);for(let i=0;i<len;i++){bytes[i]=binaryString.charCodeAt(i)}return bytes.buffer}function pcmToWav(pcmData,sampleRate){const pcm16=new Int16Array(pcmData);const header=new ArrayBuffer(44);const view=new DataView(header);function writeString(view,offset,string){for(let i=0;i<string.length;i++){view.setUint8(offset+i,string.charCodeAt(i))}}writeString(view,0,'RIFF');view.setUint32(4,36+pcm16.byteLength,true);writeString(view,8,'WAVE');writeString(view,12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);const numChannels=1;view.setUint16(22,numChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,sampleRate*numChannels*2,true);view.setUint16(32,numChannels*2,true);view.setUint16(34,16,true);writeString(view,36,'data');view.setUint32(40,pcm16.byteLength,true);return new Blob([header,pcm16],{type:'audio/wav'})}
        async function speak(button,text){const originalContent=button.innerHTML;const loadingSpinner=`<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Patientez...`;button.innerHTML=loadingSpinner;button.disabled=true;try{const response=await fetch('/.netlify/functions/generate-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text})});if(!response.ok){throw new Error(`Erreur du serveur: ${response.statusText}`)}const{audioData,mimeType}=await response.json();if(audioData&&mimeType?.startsWith("audio/")){const sampleRateMatch=mimeType.match(/rate=(\d+)/);const sampleRate=sampleRateMatch?parseInt(sampleRateMatch[1],10):24000;const pcmData=base64ToArrayBuffer(audioData);const pcm16=new Int16Array(pcmData);const wavBlob=pcmToWav(pcm16,sampleRate);const audioUrl=URL.createObjectURL(wavBlob);const audio=new Audio(audioUrl);audio.play();audio.onended=()=>{URL.revokeObjectURL(audioUrl);button.innerHTML=originalContent;button.disabled=false};audio.onerror=()=>{URL.revokeObjectURL(audioUrl);button.innerHTML=originalContent;button.disabled=false}}else{throw new Error("Données audio invalides reçues du serveur.")}}catch(error){console.error("Erreur lors de la génération de la parole:",error);alert("Désolé, une erreur est survenue lors de la génération de l'audio.");button.innerHTML=originalContent;button.disabled=false}}
        
        document.addEventListener('DOMContentLoaded', renderAllSections);
    </script>
</body>
</html>
