<script>
  // --- Global State & Config ---
  let currentStep = 1;
  const totalSteps = 6;

  const sessionMeta = { startTime: new Date().toISOString() };

  // Stats: listens & hints for ALL question blocks
  const stats = {}; // stats[qid] = { listens:0, hint1:0, hint2:0 }
  const recordings = {}; // recordings[qid] = { base64, mimeType, duration, filename }

  let recorder;
  let isRecording = false;
  let recordStartAt = 0;

  // Í≤∞Í≥º Ï†ÑÏÜ°/Ï±ÑÏ†ê 1Ìöå Í∞ÄÎìú
  let hasSubmitted = false;   // ÎÅùÎÇ¥Í∏∞ Î≤ÑÌäº Îã§Ï§ë ÌÅ¥Î¶≠ Î∞©ÏßÄ
  let emailSent   = false;    // Î©îÏùº Îã§Ï§ë Ï†ÑÏÜ° Î∞©ÏßÄ

  // ===== Quiz Data with Hints for ALL =====
  const quizData = {
    mcq: [
      {
        question: "Pour remplacer la particule sujet `Ïù¥/Í∞Ä` quand on parle de son grand-p√®re, on utilise...",
        options: ["ÏùÄ/Îäî", "ÍªòÏÑú", "ÏùÑ/Î•º", "Íªò"],
        answer: "ÍªòÏÑú",
        explanation: "`ÍªòÏÑú` est la particule honorifique qui remplace `Ïù¥/Í∞Ä` pour un sujet respect√©.",
        hint1: "Particule sujet‚Ä¶ mais version honorifique.",
        hint2: "Sujet respect√© ‚áí `ÍªòÏÑú` remplace `Ïù¥/Í∞Ä`."
      },
      {
        question: "Dans la phrase `Ïñ¥Î®∏ÎãàÍªòÏÑú Ï±ÖÏùÑ ÏùΩÏúºÏÑ∏Ïöî`, qu'est-ce qui montre le respect dans le verbe ?",
        options: ["-Ïñ¥Ïöî", "-ÏúºÏÑ∏Ïöî", "-ÏÑ∏Ïöî", "-Ïúº-"],
        answer: "-ÏúºÏÑ∏Ïöî",
        explanation: "On ajoute `-(Ïúº)Ïãú-` au radical du verbe (`ÏùΩ-`) + la terminaison `-Ïñ¥Ïöî` pour former `ÏùΩÏúºÏÑ∏Ïöî`.",
        hint1: "Regarde la terminaison polie + Ïãú.",
        hint2: "Honorification verbale: -(Ïúº)Ïãú- + Ìï¥ÏöîÏ≤¥ ‚áí -(Ïúº)ÏÑ∏Ïöî."
      },
      {
        question: "Quel est le verbe honorifique pour `Ï£ºÎã§` (donner) ?",
        options: ["ÎìúÎ¶¨Îã§", "Î∞õÎã§", "Î≥¥Îã§", "Í≥ÑÏãúÎã§"],
        answer: "ÎìúÎ¶¨Îã§",
        explanation: "Quand on donne quelque chose √† une personne respect√©e, on utilise `ÎìúÎ¶¨Îã§`.",
        hint1: "Donner ‚Üí verbe humble/hon.",
        hint2: "`Ï£ºÎã§`‚Üí`ÎìúÎ¶¨Îã§` (destinataire honorifique)."
      },
      {
        question: "Quelle est la phrase correcte pour dire 'Je vois le professeur' de mani√®re respectueuse ?",
        options: ["ÏÑ†ÏÉùÎãòÏùÑ Î¥êÏöî.", "ÏÑ†ÏÉùÎãòÍªòÏÑú Î¥êÏöî.", "ÏÑ†ÏÉùÎãòÏùÑ ÎµàÏñ¥Ïöî.", "ÏÑ†ÏÉùÎãòÏùÑ Î≥¥ÏÑ∏Ïöî."],
        answer: "ÏÑ†ÏÉùÎãòÏùÑ ÎµàÏñ¥Ïöî.",
        explanation: "`Î≥¥Îã§` devient `ÎµàÎã§` quand le COD est une personne respect√©e.",
        hint1: "`Î≥¥Îã§` ‚Üí ? (honorifique du compl√©ment)",
        hint2: "Voir une personne respect√©e ‚áí `ÎµàÎã§`."
      },
      {
        question: "La particule `Íªò` est la forme honorifique de...",
        options: ["ÏóêÏÑú", "ÌïòÍ≥†", "Îßå", "ÏóêÍ≤å/ÌïúÌÖå"],
        answer: "ÏóêÍ≤å/ÌïúÌÖå",
        explanation: "`Íªò` remplace `ÏóêÍ≤å/ÌïúÌÖå` pour indiquer le destinataire (COI) honorifique.",
        hint1: "COI (√†/chez) ‚Üí version honorifique.",
        hint2: "`ÏóêÍ≤å/ÌïúÌÖå` ‚Üí `Íªò`."
      }
    ],
    fillIn: [
      { sentence: "Ìï†Î®∏Îãà___ ÏßÄÍ∏à Ï£ºÎ¨¥ÏÑ∏Ïöî.", answer: "ÍªòÏÑú", translation: "Grand-m√®re dort maintenant.", vocab: { "Ìï†Î®∏Îãà": "grand-m√®re", "ÏßÄÍ∏à": "maintenant", "Ï£ºÎ¨¥ÏãúÎã§": "dormir (hon.)" }, hint1: "Sujet honorifique ‚Üí particule‚Ä¶", hint2: "`Ïù¥/Í∞Ä` ‚Üí `ÍªòÏÑú`" },
      { sentence: "ÏÇ¨Ïû•Îãò___ ÏÑ†Î¨ºÏùÑ ÎìúÎ†∏Ïñ¥Ïöî.", answer: "Íªò", translation: "J'ai donn√© un cadeau au patron.", vocab: { "ÏÇ¨Ïû•Îãò": "patron", "ÏÑ†Î¨º": "cadeau", "ÎìúÎ¶¨Îã§": "donner (hon.)" }, hint1: "COI honorifique.", hint2: "`ÏóêÍ≤å/ÌïúÌÖå` ‚Üí `Íªò`" },
      { sentence: "ÏïÑÎ≤ÑÏßÄÍªòÏÑú Ïã†Î¨∏ÏùÑ ÏùΩ___.", answer: "ÏúºÏÑ∏Ïöî", translation: "P√®re lit le journal.", vocab: { "ÏïÑÎ≤ÑÏßÄ": "p√®re", "Ïã†Î¨∏": "journal", "ÏùΩÎã§": "lire" }, hint1: "Honorification verbale + Ìï¥ÏöîÏ≤¥.", hint2: "Ïñ¥Í∞Ñ + (Ïúº)Ïãú + Ïñ¥Ïöî ‚áí (Ïúº)ÏÑ∏Ïöî" },
      { sentence: "Ï†ÄÎäî ÍµêÏàòÎãòÏùÑ Ï≤òÏùå ___.", answer: "ÎµôÍ≤†ÏäµÎãàÎã§", translation: "Je rencontre le professeur pour la premi√®re fois. (formel)", vocab: { "Ï†Ä": "je", "ÍµêÏàòÎãò": "professeur", "Ï≤òÏùå": "pour la premi√®re fois", "ÎµôÎã§": "voir/rencontrer (hon.)" }, hint1: "Formel/Ìï©ÏáºÏ≤¥ Ï¢ÖÍ≤∞.", hint2: "`ÎµôÎã§` + Í≤† + ÏäµÎãàÎã§" },
      { sentence: "Ïñ¥Î®∏Îãà, ÏßÑÏßÄ ___.", answer: "ÎìúÏÑ∏Ïöî", translation: "Maman, mange ton repas s'il te pla√Æt.", vocab: { "Ïñ¥Î®∏Îãà": "maman", "ÏßÑÏßÄ": "repas (hon.)", "ÎìúÏãúÎã§": "manger (hon.)" }, hint1: "Honorifique manger.", hint2: "`ÎìúÏãúÎã§` + (Ïúº)ÏÑ∏Ïöî" }
    ],
    writing: [
      { situation: "Dites que votre m√®re (Ïñ¥Î®∏Îãà) se repose (Ïâ¨Îã§).", answer: "Ïñ¥Î®∏ÎãàÍªòÏÑú Ïâ¨ÏÑ∏Ïöî.", hint1: "Sujet honorifique + -(Ïúº)Ïãú-.", hint2: "`Ïñ¥Î®∏ÎãàÍªòÏÑú` + `Ïâ¨ÏÑ∏Ïöî`" },
      { situation: "Dites que vous donnez un livre (Ï±Ö) au professeur (ÏÑ†ÏÉùÎãò).", answer: "ÏÑ†ÏÉùÎãòÍªò Ï±ÖÏùÑ ÎìúÎ†§Ïöî.", hint1: "COI honorifique + ÎìúÎ¶¨Îã§.", hint2: "`ÏÑ†ÏÉùÎãòÍªò` + `ÎìúÎ†§Ïöî`" },
      { situation: "Dites que le pr√©sident (ÎåÄÌÜµÎ†π) parle (ÎßêÏîÄÌïòÎã§).", answer: "ÎåÄÌÜµÎ†πÍªòÏÑú ÎßêÏîÄÌïòÏÑ∏Ïöî.", hint1: "ÎßêÌïòÎã§‚ÜíÎßêÏîÄÌïòÏãúÎã§.", hint2: "`ÎåÄÌÜµÎ†πÍªòÏÑú` + `ÎßêÏîÄÌïòÏÑ∏Ïöî`" },
      { situation: "Dites que vous voyez (ÎµàÎã§) votre grand-p√®re (Ìï†ÏïÑÎ≤ÑÏßÄ).", answer: "Ìï†ÏïÑÎ≤ÑÏßÄÎ•º ÎµàÏñ¥Ïöî.", hint1: "Î≥¥Îã§‚ÜíÎµàÎã§ (obj. honor.).", hint2: "`Ìï†ÏïÑÎ≤ÑÏßÄ` COD, verbe `ÎµàÏñ¥Ïöî`" },
      { situation: "Demandez si le client (ÏÜêÎãò) a mang√© (ÏãùÏÇ¨ÌïòÎã§).", answer: "ÏÜêÎãò, ÏãùÏÇ¨ÌïòÏÖ®Ïñ¥Ïöî?", hint1: "ÌïòÎã§‚ÜíÌïòÏãúÎã§.", hint2: "`ÏãùÏÇ¨ÌïòÏãúÎã§` + -Ïïò/ÏóàÏñ¥Ïöî?" }
    ],
    listening: [
      { number: 1, ko: "ÏÑ†ÏÉùÎãòÍªòÏÑú ÌïúÍµ≠Ïñ¥Î•º Í∞ÄÎ•¥ÏπòÏÑ∏Ïöî.", fr: "Le professeur enseigne le cor√©en.", hint1: "„ÖÖ„ÖÖ„Ñ¥„Ñ≤„ÖÖ „Öé„Ñ±„Öá„Ñπ „Ñ±„Ñπ„Öä„ÖÖ„Öá.", hint2: "Í∞ÄÎ•¥ÏπòÎã§ (enseigner)" },
      { number: 2, ko: "Ìï†Î®∏ÎãàÍªò Ï†ÑÌôîÎ•º ÎìúÎ†∏Ïñ¥Ïöî.", fr: "J'ai t√©l√©phon√© √† ma grand-m√®re.", hint1: "„Öé„ÖÅ„Ñ¥„Ñ≤ „Öà„Öé„Ñπ „Ñ∑„Ñπ„Öá„Öá.", hint2: "Ï†ÑÌôîÎ•º ÎìúÎ¶¨Îã§ (t√©l√©phoner - hon.)" },
      { number: 3, ko: "ÏÇ¨Ïû•ÎãòÏùÑ Î≥µÎèÑÏóêÏÑú ÎµàÏóàÏñ¥Ïöî.", fr: "J'ai vu le patron dans le couloir.", hint1: "„ÖÖ„Öà„Ñ¥„Öá „ÖÇ„Ñ∑„Öá„ÖÖ „ÖÇ„Öá„Öá„Öá.", hint2: "Î≥µÎèÑ (couloir), ÎµàÎã§ (voir - hon.)" },
      { number: 4, ko: "ÏïÑÎ≤ÑÎãò, ÏßÑÏßÄ ÎìúÏÑ∏Ïöî.", fr: "P√®re, mangez votre repas s'il vous pla√Æt.", hint1: "„Öá„ÖÇ„Ñ¥, „Öà„Öà „Ñ∑„ÖÖ„Öá.", hint2: "ÏïÑÎ≤ÑÎãò (p√®re - hon.), ÏßÑÏßÄ (repas - hon.)" },
      { number: 5, ko: "ÏùòÏÇ¨ ÏÑ†ÏÉùÎãòÍªòÏÑú ÏßÄÍ∏à Ïïà Í≥ÑÏÑ∏Ïöî.", fr: "Le docteur n'est pas l√† pour le moment.", hint1: "„Öá„ÖÖ „ÖÖ„ÖÖ„Ñ¥„Ñ≤„ÖÖ „Öà„Ñ± „Öá „Ñ±„ÖÖ„Öá.", hint2: "Í≥ÑÏãúÎã§ (√™tre - hon.), Ïïà (ne...pas)" }
    ]
  };

  // --- Init ---
  document.addEventListener('DOMContentLoaded', () => {
    populateMCQ();
    populateFillIn();
    populateWriting();
    populateListening();
    setupNavigation();
    document.getElementById('studentName').placeholder = getRandomPlaceholder();
  });

  function getRandomPlaceholder() {
    const placeholders = [
      "Le futur boss du TOPIK !",
      "Qui va briller aujourd'hui ?",
      "Ton nom pour la post√©rit√© cor√©enne...",
      "Pr√™t(e) √† tout d√©chirer ?",
      "Inscris ton nom dans la l√©gende !"
    ];
    return placeholders[Math.floor(Math.random() * placeholders.length)];
  }

  // --- helpers (stats) ---
  function ensureStat(qid) {
    if (!stats[qid]) stats[qid] = { listens: 0, hint1: 0, hint2: 0 };
  }
  function bumpHint(qid, which) {
    ensureStat(qid);
    if (which === 1) stats[qid].hint1++;
    else if (which === 2) stats[qid].hint2++;
  }

  // --- Populate: QCM (with hints) ---
  function populateMCQ() {
    const container = document.getElementById('mcq-questions');
    quizData.mcq.forEach((q, index) => {
      const qid = `mcq-${index}`;
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <p class="font-semibold mb-4">${index + 1}. ${q.question}</p>
        <div class="space-y-2">
          ${q.options.map(opt => `
            <div>
              <input type="radio" id="${qid}-${opt.replace(/\s/g, '-')}"
                    name="${qid}" value="${opt}" class="mr-2 cursor-pointer">
              <label for="${qid}-${opt.replace(/\s/g, '-')}" class="cursor-pointer">${opt}</label>
            </div>
          `).join('')}
        </div>
        <div class="mt-3 space-x-2">
          <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                  class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
          <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                  class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
        </div>
        <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
        <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
        <div id="${qid}-result" class="mt-4 text-sm"></div>
      `;
      container.appendChild(div);
    });
  }

  // --- Populate: Fill-in (with hints) ---
  function populateFillIn() {
    const container = document.getElementById('fill-in-the-blank-questions');
    quizData.fillIn.forEach((q, index) => {
      const qid = `fill-${index}`;
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      const sentenceParts = q.sentence.split('___');

      let vocabHTML = '<ul class="list-disc list-inside text-sm text-gray-600 mt-2">';
      for (const [ko, fr] of Object.entries(q.vocab)) {
        vocabHTML += `<li><strong>${ko}</strong> : ${fr}</li>`;
      }
      vocabHTML += '</ul>';

      div.innerHTML = `
        <div class="mb-4">
          <label for="${qid}-input" class="font-semibold text-lg">
            ${index + 1}. ${sentenceParts[0]}
            <input type="text" id="${qid}-input"
                  class="border-b-2 border-gray-300 focus:border-blue-500 outline-none w-24 text-center mx-1">
            ${sentenceParts[1]}
          </label>
          <p class="text-gray-500 italic mt-1">"${q.translation}"</p>
        </div>
        <div>
          <h5 class="font-bold text-sm">Mots utiles :</h5>
          ${vocabHTML}
        </div>
        <div class="mt-3 space-x-2">
          <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                  class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
          <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                  class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
        </div>
        <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
        <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>

        <div id="${qid}-result" class="mt-4 text-sm"></div>
      `;
      container.appendChild(div);
    });
  }

  // --- Populate: Writing (with hints) ---
  function populateWriting() {
    const container = document.getElementById('writing-questions');
    quizData.writing.forEach((q, index) => {
      const qid = `write-${index}`;
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-md';
      div.innerHTML = `
        <p class="font-semibold mb-2">${index + 1}. ${q.situation}</p>
        <textarea id="${qid}-input" rows="2"
                  class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="√âcrivez votre r√©ponse en cor√©en..."></textarea>

        <div class="mt-3 space-x-2">
          <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                  class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
          <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                  class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
        </div>
        <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
        <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>

        <div id="${qid}-result" class="mt-4 text-sm"></div>
      `;
      container.appendChild(div);
    });
  }

  // --- Populate: Listening (play button close + self-dictation) ---
  function populateListening() {
    const container = document.getElementById('listening-questions');
    quizData.listening.forEach((q, index) => {
      const qid = `listen-${index}`;
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow-lg';
      div.id = qid;

      div.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold text-blue-800">Phrase ${index + 1}</h3>
        </div>

        <div class="space-y-6">
          <!-- Dictation row with play button right here -->
          <div>
            <div class="flex items-center justify-between gap-2">
              <label class="block font-semibold text-gray-700">1. √âcoutez et √©crivez (Î∞õÏïÑÏì∞Í∏∞)</label>
              <button onclick="playAudio('${q.ko}', this, '${qid}')"
                      class="shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-full transition duration-300 ease-in-out">
                <i class="fas fa-play"></i>
              </button>
            </div>
            <input type="text" id="${qid}-dictation"
                    class="mt-2 w-full p-2 border border-gray-300 rounded-md"
                    placeholder="√âcrivez ce que vous entendez...">
            <div class="mt-2 space-x-2">
              <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                      class="text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1 (consonnes)</button>
              <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                      class="text-sm bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2 (mots cl√©s)</button>
            </div>
            <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
            <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
          </div>

          <div>
            <label class="block font-semibold mb-2 text-gray-700">2. Traduisez en fran√ßais</label>
            <input type="text" id="${qid}-translation" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Que signifie la phrase ?">
          </div>

          <div>
            <label class="block font-semibold mb-2 text-gray-700">3. Enregistrez votre prononciation</label>
            <div class="flex items-center gap-4">
              <button id="${qid}-record-btn" onclick="toggleRecording('${qid}')"
                      class="bg-red-500 hover:bg-red-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300">
                <i class="fas fa-microphone"></i>
              </button>
              <div id="${qid}-record-status" class="text-gray-600">Cliquez pour enregistrer</div>
            </div>
            <audio id="${qid}-audio-playback" controls class="w-full mt-4 hidden"></audio>
          </div>

          <div>
            <label class="block font-semibold mb-2 text-gray-700">4. Re-dict√©e d‚Äôapr√®s ma voix (non not√©e)</label>
            <input type="text" id="${qid}-selfdict" class="w-full p-2 border border-gray-300 rounded-md" placeholder="R√©√©crivez la phrase apr√®s avoir √©cout√© votre enregistrement.">
            <p class="text-xs text-gray-500 mt-1">Astuce: √âcoute ton enregistrement ci-dessus, puis r√©√©cris la phrase ici.</p>
          </div>
        </div>

        <div id="${qid}-result" class="mt-4 text-sm"></div>
      `;
      container.appendChild(div);
    });
  }

  // --- Navigation ---
  function setupNavigation() {
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const finishBtn = document.getElementById('finish-btn');

    nextBtn.addEventListener('click', () => {
      if (currentStep < totalSteps) changeStep(currentStep + 1);
    });

    prevBtn.addEventListener('click', () => {
      if (currentStep > 1) changeStep(currentStep - 1);
    });

    // ‚úÖ ÎÅùÎÇ¥Í∏∞: 1ÌöåÎßå ÎèôÏûë + 1ÌöåÎßå Î©îÏùº Ï†ÑÏÜ°
    finishBtn.addEventListener('click', () => {
      if (hasSubmitted) return;
      hasSubmitted = true;
      collectAndGradeAnswers();
    });
  }

  function changeStep(step) {
    document.querySelector(`.quiz-step[data-step="${currentStep}"]`).style.display = 'none';
    document.querySelector(`.quiz-step[data-step="${step}"]`).style.display = 'block';
    currentStep = step;
    updateNavigation();
    window.scrollTo(0, 0);
  }

  function updateNavigation() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    const stepIndicator = document.getElementById('step-indicator');
    prevBtn.disabled = (currentStep === 1);
    nextBtn.style.display = currentStep === totalSteps ? 'none' : 'inline-block';
    finishBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
    stepIndicator.textContent = `√âtape ${currentStep} / ${totalSteps}`;
  }

  // --- Audio (Google TTS + fallback) ---
  const ttsBusy = new Set();
  async function playAudio(text, button, qid = null) {
    if (ttsBusy.has(button)) return;
    ttsBusy.add(button);

    const icon = button.querySelector('i');
    icon.classList.remove('fa-play');
    icon.classList.add('fa-spinner', 'fa-spin');
    button.disabled = true;

    if (qid) {
      ensureStat(qid);
      stats[qid].listens++;
    }

    try {
      const res = await fetch('/.netlify/functions/generate-audio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      if (res.ok) {
        const data = await res.json();
        if (data.audioData) {
          const audio = new Audio(`data:${data.mimeType};base64,${data.audioData}`);
          audio.onended = () => resetAudioBtn(icon, button);
          audio.onerror = () => fallbackSpeechSynthesis(text, icon, button);
          audio.play();
          return;
        }
      }
      fallbackSpeechSynthesis(text, icon, button);
    } catch (e) {
      console.error('Audio playback error:', e);
      fallbackSpeechSynthesis(text, icon, button);
    } finally {
      ttsBusy.delete(button);
    }
  }

  function resetAudioBtn(icon, button) {
    icon.classList.remove('fa-spinner', 'fa-spin');
    icon.classList.add('fa-play');
    button.disabled = false;
  }

  function fallbackSpeechSynthesis(text, icon, button) {
    try {
      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ko-KR';
        u.onend = () => resetAudioBtn(icon, button);
        speechSynthesis.speak(u);
      } else {
        throw new Error('Speech Synthesis not supported');
      }
    } catch {
      alert("La synth√®se vocale n'est pas disponible sur votre navigateur.");
      icon.classList.remove('fa-spinner', 'fa-spin');
      icon.classList.add('fa-exclamation-circle');
      button.disabled = false;
    }
  }

  function toggleHint(hintId) {
    const el = document.getElementById(hintId);
    el.classList.toggle('hidden');
  }

  // --- Recording (webm -> base64) ---
  function toggleRecording(qid) {
    if (isRecording) stopRecording(qid);
    else startRecording(qid);
  }

  async function startRecording(qid) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      const chunks = [];
      recordStartAt = performance.now();

      recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };

      recorder.onstop = () => {
        const duration = Math.max(1, Math.round((performance.now() - recordStartAt) / 1000));
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);

        const audioEl = document.getElementById(`${qid}-audio-playback`);
        audioEl.src = url;
        audioEl.classList.remove('hidden');

        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = String(reader.result); // data:audio/webm;base64,AAAA...
          const [header, base64] = dataUrl.split(',');
          const mimeMatch = header.match(/data:(.*?);base64/);
          recordings[qid] = {
            base64,
            mimeType: mimeMatch ? mimeMatch[1] : 'audio/webm',
            duration,
            filename: `${qid}.webm`,
          };
          URL.revokeObjectURL(url);
        };
        reader.readAsDataURL(blob);

        recorder.stream.getTracks().forEach(t => t.stop());
      };

      recorder.start();
      isRecording = true;
      updateRecordingUI(qid, true);
    } catch (error) {
      console.error('Error starting recording:', error);
      alert("Impossible d'acc√©der au microphone. Veuillez v√©rifier les autorisations.");
    }
  }

  function stopRecording(qid) {
    if (recorder && recorder.state !== "inactive") {
      recorder.stop();
      isRecording = false;
      updateRecordingUI(qid, false);
    }
  }

  function updateRecordingUI(qid, isRec) {
    const recordBtn = document.getElementById(`${qid}-record-btn`);
    const statusDiv = document.getElementById(`${qid}-record-status`);
    const icon = recordBtn.querySelector('i');
    if (isRec) {
      recordBtn.classList.replace('bg-red-500', 'bg-gray-700');
      recordBtn.classList.add('animate-pulse');
      icon.classList.replace('fa-microphone', 'fa-stop');
      statusDiv.textContent = 'Enregistrement en cours...';
    } else {
      recordBtn.classList.replace('bg-gray-700', 'bg-red-500');
      recordBtn.classList.remove('animate-pulse');
      icon.classList.replace('fa-stop', 'fa-microphone');
      statusDiv.textContent = 'Enregistrement termin√©.';
    }
  }

  // --- Send results to server (guarded for single send) ---
  async function sendResultsToServer(payload) {
    if (emailSent) return;        // ‚úÖ Ïù¥ÎØ∏ Î≥¥ÎÉàÏúºÎ©¥ Î¨¥Ïãú
    emailSent = true;             // ‚úÖ Îî± Ìïú Î≤àÎßå Î≥¥ÎÇ¥Í∏∞
    try {
      const res = await fetch('/.netlify/functions/send-results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      console.log('R√©sultats envoy√©s:', data);
    } catch (err) {
      console.error("Erreur d'envoi des r√©sultats:", err);
    }
  }

  // --- Build summary (Ï†ïÏò§Ìëú) ---
  function buildSummaryHTML(questions) {
    const groups = { QCM: [], FILL: [], WR: [], LS: [] };
    questions.forEach(q => {
      const type = String(q.number).split(' ')[0]; // "QCM","FILL","WR","LS"
      groups[type]?.push(q);
    });

    const renderGroup = (title, arr) => {
      if (!arr || arr.length === 0) return '';
      const rows = arr.map(q => {
        const ok = q.isCorrect ? '‚úÖ' : '‚ùå';
        const prompt = q.fr || q.ko || '';
        const answerShown = q.ko ? `<div class="text-xs text-gray-500 mt-1"><b>R√©f√©rence:</b> ${q.ko}</div>` : '';
        const userShown = q.userAnswer ? `<div class="text-xs text-gray-500"><b>Votre r√©ponse:</b> ${q.userAnswer}</div>` : '';
        const selfDict = q.selfDictation ? `<div class="text-xs text-indigo-600 mt-1"><b>Re-dict√©e (non not√©e):</b> ${q.selfDictation}</div>` : '';
        return `
          <li class="border rounded-md p-3">
            <div class="font-semibold">${ok} ${q.number}</div>
            <div class="text-sm text-gray-700 mt-1">${prompt}</div>
            ${answerShown}
            ${userShown}
            ${selfDict}
          </li>
        `;
      }).join('');
      return `
        <div class="mt-6">
          <h3 class="text-lg font-bold text-blue-700 mb-2">${title}</h3>
          <ul class="space-y-2">${rows}</ul>
        </div>
      `;
    };

    return `
      ${renderGroup('QCM', groups.QCM)}
      ${renderGroup('Compl√®te le mot', groups.FILL)}
      ${renderGroup('√âcriture', groups.WR)}
      ${renderGroup('√âcoute & Dict√©e', groups.LS)}
    `;
  }

  // --- Grading and Results ---
  function collectAndGradeAnswers() {
    let score = 0, total = 0;
    const questionsForMail = [];

    // QCM
    quizData.mcq.forEach((q, i) => {
      const qid = `mcq-${i}`;
      const userAnswer = document.querySelector(`input[name="${qid}"]:checked`)?.value || '';
      const isCorrect = userAnswer === q.answer;
      if (isCorrect) score++; total++;

      document.getElementById(`${qid}-result`).innerHTML = isCorrect
        ? `<p class="text-green-600 font-bold">Correct ! üëç ${q.explanation}</p>`
        : `<p class="text-red-600 font-bold">Oups... La bonne r√©ponse √©tait : "${q.answer}"</p><p class="text-gray-600">üòÖ ‚Üí ${q.explanation}</p>`;

      const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
      questionsForMail.push({
        number: `QCM ${i + 1}`, fr: q.question, ko: '',
        userAnswer, isCorrect,
        listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
      });
    });

    // Fill-in
    quizData.fillIn.forEach((q, i) => {
      const qid = `fill-${i}`;
      const userAnswer = document.getElementById(`${qid}-input`).value.trim();
      const isCorrect = userAnswer === q.answer;
      if (isCorrect) score++; total++;

      document.getElementById(`${qid}-result`).innerHTML = isCorrect
        ? `<p class="text-green-600 font-bold">Parfait !</p>`
        : `<p class="text-red-600 font-bold">Oups, petit couac üòÖ ‚Üí La r√©ponse correcte est : "${q.answer}"</p>`;

      const koFull = q.sentence.replace('___', q.answer);
      const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
      questionsForMail.push({
        number: `FILL ${i + 1}`, fr: q.translation, ko: koFull,
        userAnswer, isCorrect,
        listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
      });
    });

    // Writing
    quizData.writing.forEach((q, i) => {
      const qid = `write-${i}`;
      const userAnswer = document.getElementById(`${qid}-input`).value.trim();
      const isCorrect = userAnswer.length > 0;
      if (isCorrect) score++; total++;

      document.getElementById(`${qid}-result`).innerHTML =
        `<p class="text-blue-600">R√©ponse sugg√©r√©e : "${q.answer}".</p>`;

      const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
      questionsForMail.push({
        number: `WR ${i + 1}`, fr: q.situation, ko: q.answer,
        userAnswer, isCorrect,
        listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
      });
    });

    // Listening (includes self-dictation & recording)
    quizData.listening.forEach((q, i) => {
      const qid = `listen-${i}`;
      const userAnswerKo = document.getElementById(`${qid}-dictation`).value.trim().replace(/[.?]/g, '');
      const isCorrectKo = userAnswerKo === q.ko.replace(/[.?]/g, '');
      if (isCorrectKo) score++; total++;

      const resultDiv = document.getElementById(`${qid}-result`);
      let resultHTML = isCorrectKo
        ? `<p class="text-green-600 font-bold">Dict√©e parfaite ! üëç</p>`
        : `<p class="text-red-600 font-bold">Dict√©e - Oups... üòÖ ‚Üí La phrase correcte est : "${q.ko}"</p>`;
      resultHTML += `<p class="text-blue-600 mt-1">Traduction : "${q.fr}"</p>`;
      resultDiv.innerHTML = resultHTML;

      const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
      const rec = recordings[qid];
      const selfDict = document.getElementById(`${qid}-selfdict`).value.trim();

      const item = {
        number: `LS ${i + 1}`, fr: q.fr, ko: q.ko,
        userAnswer: userAnswerKo, isCorrect: isCorrectKo,
        listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2,
        selfDictation: selfDict
      };
      if (rec) item.recording = rec;

      questionsForMail.push(item);
    });

    displayResults(score, total, questionsForMail);
  }

  function displayResults(score, total, questionsForMail) {
    // ÌôîÎ©¥ Ï†ÑÌôò
    document.getElementById('quiz-container').style.display = 'none';
    document.querySelector('.flex.justify-between.items-center').style.display = 'none';
    const resultsSection = document.getElementById('results-section');

    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
    let frMessage, icon;
    if (percentage === 100) { frMessage = "Parfait absolu ! üëëüéâ G√©nie confirm√© !"; icon = 'fa-crown text-yellow-500'; }
    else if (percentage >= 80) { frMessage = "Tr√®s bien jou√© ! üëç Presque un ma√Ætre !"; icon = 'fa-thumbs-up text-green-500'; }
    else if (percentage >= 60) { frMessage = "Pas mal du tout ! üòé Encore un petit effort !"; icon = 'fa-glasses text-blue-500'; }
    else { frMessage = "Allez, un petit caf√© et on repart ! ‚òïüí™"; icon = 'fa-coffee text-red-500'; }

    // ‚úÖ Ï†ïÏò§Ìëú(ÏöîÏïΩ) HTML
    const summaryHTML = buildSummaryHTML(questionsForMail);

    resultsSection.innerHTML = `
      <div class="bg-white p-8 rounded-xl shadow-2xl">
        <div class="text-center">
          <i class="fas ${icon} text-6xl mb-4"></i>
          <h2 class="text-3xl font-bold text-blue-800 mb-2">${frMessage}</h2>
          <p class="text-4xl font-bold text-gray-800">Votre score : ${score} / ${total} (${percentage}%)</p>
        </div>

        <div class="mt-8">
          <h3 class="text-xl font-bold text-gray-800 mb-2">R√©sum√© des r√©ponses</h3>
          <p class="text-sm text-gray-600 mb-4">‚úÖ = correct, ‚ùå = incorrect ‚Äî La re-dict√©e (√âtape 6.4) n'est pas not√©e mais envoy√©e au professeur avec l'audio.</p>
          ${summaryHTML}
        </div>

        <div class="mt-10 text-center">
          <button onclick="window.location.reload()"
                  class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105">
            <i class="fas fa-redo-alt mr-2"></i> Recommencer
          </button>
        </div>
      </div>
    `;
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });

    // ‚úÖ Î©îÏùº Ï†ÑÏÜ°ÏùÄ Îî± Ìïú Î≤àÎßå
    const endTime = new Date().toISOString();
    const totalTimeSeconds = Math.max(1, Math.round((new Date(endTime) - new Date(sessionMeta.startTime)) / 1000));
    const payload = {
      studentName: document.getElementById('studentName').value.trim() || '√âl√®ve',
      startTime: sessionMeta.startTime,
      endTime,
      totalTimeSeconds,
      questions: questionsForMail
    };
    sendResultsToServer(payload); // ÎÇ¥Î∂ÄÏóêÏÑú emailSent Í∞ÄÎìúÎ°ú 1ÌöåÎßå Ï†ÑÏÜ°
  }
</script>
