<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice CorÃ©en: Focus sur la Forme Honorifique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .quiz-step { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Table scroller on small screens */
    .table-wrap { overflow-x:auto; }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <!-- En-tÃªte -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    <div class="text-sm text-gray-500">
      <p class="font-semibold">Fait par ì„±ì¼, Pondant, Laon</p>
    </div>
    <h1 class="text-xl md:text-2xl font-bold text-center text-blue-800">Les 3 Types d'Honorifiques</h1>
    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex items-center">
      <i class="fas fa-print mr-2"></i> <span class="hidden md:inline">Imprimer</span>
    </button>
  </header>

  <main class="container mx-auto p-4 md:p-8">

    <!-- Section Nom de l'Ã©tudiant -->
    <section id="student-name-section" class="text-center mb-12">
      <h2 class="text-2xl font-bold mb-4">Qui est le champion du jour ? ğŸ†</h2>
      <input type="text" id="studentName"
             placeholder="Entrez votre nom ici, futur maÃ®tre du corÃ©en !"
             class="text-center p-3 border-2 border-blue-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-1/2">
    </section>

    <!-- Conteneur des exercices -->
    <div id="quiz-container" class="space-y-16">

      <!-- Ã‰tape 1: Explication simple -->
      <div class="quiz-step" data-step="1">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">1. Les 3 Types d'Honorifiques ! ğŸ¤”</h2>
        <div class="bg-white p-6 rounded-lg shadow-md space-y-6 text-base md:text-lg">

          <!-- ì£¼ì²´ ë†’ì„ë²• -->
          <div class="border-2 border-blue-200 p-4 rounded-lg">
            <h4 class="font-bold text-blue-600">ğŸŸ¢ ì£¼ì²´ ë†’ì„ë²• (Honorification du sujet)</h4>
            <p class="mt-2 text-gray-700">Le <strong>sujet</strong> de la phrase est une personne respectÃ©e (professeur, aÃ®nÃ©, etc.).</p>
            <p class="mt-3">On montre le respect en modifiant le verbe (suffixe <code class="bg-red-100 p-1 rounded font-bold">-(ìœ¼)ì‹œ-</code>) et en utilisant une particule de sujet honorifique (<code class="bg-blue-100 p-1 rounded font-bold">ê»˜ì„œ</code>).</p>
            <p class="mt-2">âœ… <code class="bg-gray-100 p-1 rounded">ì„ ìƒë‹˜<span class="text-blue-500 font-bold">ê»˜ì„œ</span> ì˜¤<span class="text-red-500 font-bold">ì„¸</span>ìš”.</code></p>
          </div>

          <!-- ê°ì²´ ë†’ì„ë²• -->
          <div class="border-2 border-green-200 p-4 rounded-lg">
            <h4 class="font-bold text-green-600">ğŸŸ¡ ê°ì²´ ë†’ì„ë²• (Honorification du complÃ©ment)</h4>
            <p class="mt-2 text-gray-700">Le <strong>complÃ©ment</strong> (COD ou COI) est une personne importante (professeur, parent, etc.).</p>
            <p class="mt-3">On utilise des verbes honorifiques spÃ©cifiques pour exprimer le respect (<code class="bg-purple-100 p-1 rounded font-bold">ëµ™ë‹¤, ë“œë¦¬ë‹¤, ì—¬ì­™ë‹¤</code>, etc.).</p>
            <p class="mt-2">âœ… <code class="bg-gray-100 p-1 rounded">ì„ ìƒë‹˜ê»˜ ì„ ë¬¼ì„ <span class="text-purple-500 font-bold">ë“œë ¤ìš”</span>.</code></p>
          </div>

          <!-- ìƒëŒ€ ë†’ì„ë²• -->
          <div class="border-2 border-orange-200 p-4 rounded-lg">
            <h4 class="font-bold text-orange-600">ğŸ”µ ìƒëŒ€ ë†’ì„ë²• (Honorification de lâ€™interlocuteur)</h4>
            <p class="mt-2 text-gray-700">Cela montre le niveau de politesse envers la personne <strong>Ã  qui lâ€™on parle</strong>.</p>
            <p class="text-sm text-gray-600 italic mt-1">
              ğŸ‘‰ Un peu comme Â« les 3 registres de langue Â» en franÃ§ais :
              Â« Je te remercie Â» (familier) â†’ Â« Je vous remercie Â» (standard/vouvoiement) â†’ Â« Je vous suis reconnaissant Â» (soutenu).
            </p>
            <p class="mt-3 text-gray-700">
              âš ï¸ DiffÃ©rence importante : En franÃ§ais, le registre soutenu dÃ©pend souvent du milieu (certains ne lâ€™utilisent presque jamais).
              Mais en corÃ©en, le style <strong>formel</strong> (í•©ì‡¼ì²´) sâ€™emploie selon la <u>situation</u> (cadre professionnel/officiel, avec des inconnus).
              Et certains mots comme <code class="bg-gray-100 p-1 rounded">ê°ì‚¬í•©ë‹ˆë‹¤</code> et <code class="bg-gray-100 p-1 rounded">ì£„ì†¡í•©ë‹ˆë‹¤</code> sâ€™utilisent trÃ¨s souvent pour renforcer la politesse, mÃªme hors cadre officiel.
            </p>
            <ul class="mt-2 space-y-1 list-disc list-inside">
              <li><code class="bg-gray-100 p-1 rounded">ê°€</code> (familier / registre familier / ë°˜ë§)</li>
              <li><code class="bg-gray-100 p-1 rounded">ê°€<span class="text-orange-500 font-bold">ìš”</span></code> (style poli / registre standard / í•´ìš”ì²´)</li>
              <li><code class="bg-gray-100 p-1 rounded">ê°‘<span class="text-orange-500 font-bold">ë‹ˆë‹¤</span></code> (style trÃ¨s formel / registre formel / í•©ì‡¼ì²´)</li>
            </ul>
          </div>

        </div>
      </div>

      <!-- Ã‰tape 2: Mots et Expressions ClÃ©s -->
      <div class="quiz-step" data-step="2" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">2. Mots et Expressions ClÃ©s ğŸ“‹</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <p class="text-gray-700 mb-4">
            Voici quelques mots et particules honorifiques essentiels Ã  mÃ©moriser !
          </p>
          <div class="table-wrap">
            <table class="min-w-full text-left text-sm">
              <thead>
                <tr class="bg-blue-50 text-blue-800">
                  <th class="px-3 py-2 font-semibold">Type</th>
                  <th class="px-3 py-2 font-semibold">Forme Standard</th>
                  <th class="px-3 py-2 font-semibold">Forme Honorifique</th>
                  <th class="px-3 py-2 font-semibold">Utilisation</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr><td class="px-3 py-2">ì£¼ì²´ (Sujet)</td><td class="px-3 py-2">Suffixe de verbe</td><td class="px-3 py-2">-(ìœ¼)ì‹œ-</td><td class="px-3 py-2">Ex: ì½ë‹¤ â†’ ì½ìœ¼ì‹œë‹¤</td></tr>
                <tr><td class="px-3 py-2">ì£¼ì²´ (Sujet)</td><td class="px-3 py-2">ì´/ê°€</td><td class="px-3 py-2">ê»˜ì„œ</td><td class="px-3 py-2">Pour le sujet respectÃ©</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ì—ê²Œ/í•œí…Œ</td><td class="px-3 py-2">ê»˜</td><td class="px-3 py-2">Pour le destinataire respectÃ©</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ë³´ë‹¤ (voir)</td><td class="px-3 py-2">ëµ™ë‹¤ / ëµˆë‹¤</td><td class="px-3 py-2">Quand on voit une personne respectÃ©e</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ì£¼ë‹¤ (donner)</td><td class="px-3 py-2">ë“œë¦¬ë‹¤</td><td class="px-3 py-2">Quand on donne Ã  une personne respectÃ©e</td></tr>
                <tr><td class="px-3 py-2">Verbe</td><td class="px-3 py-2">ë¨¹ë‹¤ (manger)</td><td class="px-3 py-2">ë“œì‹œë‹¤ / ì¡ìˆ˜ì‹œë‹¤</td><td class="px-3 py-2">Quand une personne respectÃ©e mange</td></tr>
                <tr><td class="px-3 py-2">Verbe</td><td class="px-3 py-2">ìë‹¤ (dormir)</td><td class="px-3 py-2">ì£¼ë¬´ì‹œë‹¤</td><td class="px-3 py-2">Quand une personne respectÃ©e dort</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ã‰tape 3: QCM -->
      <div class="quiz-step" data-step="3" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">3. Choisis la bonne rÃ©ponse ! ğŸ¤” (5 questions)</h2>
        <div id="mcq-questions" class="space-y-6"></div>
      </div>

      <!-- Ã‰tape 4: Mots Ã  complÃ©ter -->
      <div class="quiz-step" data-step="4" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">4. ComplÃ¨te avec le bon mot ! âœï¸ (5 questions)</h2>
        <div id="fill-in-the-blank-questions" class="space-y-6"></div>
      </div>

      <!-- Ã‰tape 5: Ã‰criture de phrases -->
      <div class="quiz-step" data-step="5" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">5. Ã€ toi d'Ã©crire ! âœ’ï¸ (5 phrases)</h2>
        <p class="text-gray-600 mb-6">Ã‰cris la phrase en corÃ©en en utilisant la forme honorifique.</p>
        <div id="writing-questions" class="space-y-8"></div>
      </div>

      <!-- Ã‰tape 6: Ã‰coute et Ã©cris -->
      <div class="quiz-step" data-step="6" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">6. Ã‰coute et Ã©cris ! ğŸ§ (5 phrases)</h2>
        <p class="text-gray-600 mb-6">Ã‰coute, Ã©cris, enregistre ta voix, puis rÃ©essaie la dictÃ©e dâ€™aprÃ¨s ta propre voix. (La 2e dictÃ©e nâ€™est pas notÃ©e, mais est envoyÃ©e au prof avec lâ€™audio.)</p>
        <div id="listening-questions" class="space-y-12"></div>
      </div>

      <!-- Section des rÃ©sultats -->
      <div id="results-section" class="text-center" style="display:none;"></div>
    </div>

    <!-- Boutons de navigation -->
    <div class="mt-12 flex justify-between items-center">
      <button id="prev-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50" disabled>
        <i class="fas fa-arrow-left mr-2"></i> PrÃ©cÃ©dent
      </button>
      <div id="step-indicator" class="text-gray-600 font-semibold">Ã‰tape 1 / 6</div>
      <button id="next-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        Suivant <i class="fas fa-arrow-right ml-2"></i>
      </button>
      <button id="finish-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300" style="display: none;">
        Terminer & Voir les rÃ©sultats <i class="fas fa-check-circle ml-2"></i>
      </button>
    </div>

    <footer class="text-center mt-12 text-sm text-gray-500">
      <p>Fait avec â¤ï¸ par ì„±ì¼, Pondant, Laon</p>
    </footer>
  </main>

  <script>
    // --- Global State & Config ---
    let currentStep = 1;
    const totalSteps = 6;

    const sessionMeta = { startTime: new Date().toISOString() };

    // Stats: listens & hints for ALL question blocks
    const stats = {}; // stats[qid] = { listens:0, hint1:0, hint2:0 }
    const recordings = {}; // recordings[qid] = { base64, mimeType, duration, filename }

    let recorder;
    let isRecording = false;
    let recordStartAt = 0;

    // ===== Quiz Data with Hints for ALL =====
    const quizData = {
      mcq: [
        {
          question: "Pour remplacer la particule sujet `ì´/ê°€` quand on parle de son grand-pÃ¨re, on utilise...",
          options: ["ì€/ëŠ”", "ê»˜ì„œ", "ì„/ë¥¼", "ê»˜"],
          answer: "ê»˜ì„œ",
          explanation: "`ê»˜ì„œ` est la particule honorifique qui remplace `ì´/ê°€` pour un sujet respectÃ©.",
          hint1: "Particule sujetâ€¦ mais version honorifique.",
          hint2: "Sujet respectÃ© â‡’ `ê»˜ì„œ` remplace `ì´/ê°€`."
        },
        {
          question: "Dans la phrase `ì–´ë¨¸ë‹ˆê»˜ì„œ ì±…ì„ ì½ìœ¼ì„¸ìš”`, qu'est-ce qui montre le respect dans le verbe ?",
          options: ["-ì–´ìš”", "-ìœ¼ì„¸ìš”", "-ì„¸ìš”", "-ìœ¼-"],
          answer: "-ìœ¼ì„¸ìš”",
          explanation: "On ajoute `-(ìœ¼)ì‹œ-` au radical du verbe (`ì½-`) + la terminaison `-ì–´ìš”` pour former `ì½ìœ¼ì„¸ìš”`.",
          hint1: "Regarde la terminaison polie + ì‹œ.",
          hint2: "Honorification verbale: -(ìœ¼)ì‹œ- + í•´ìš”ì²´ â‡’ -(ìœ¼)ì„¸ìš”."
        },
        {
          question: "Quel est le verbe honorifique pour `ì£¼ë‹¤` (donner) ?",
          options: ["ë“œë¦¬ë‹¤", "ë°›ë‹¤", "ë³´ë‹¤", "ê³„ì‹œë‹¤"],
          answer: "ë“œë¦¬ë‹¤",
          explanation: "Quand on donne quelque chose Ã  une personne respectÃ©e, on utilise `ë“œë¦¬ë‹¤`.",
          hint1: "Donner â†’ verbe humble/hon.",
          hint2: "`ì£¼ë‹¤`â†’`ë“œë¦¬ë‹¤` (destinataire honorifique)."
        },
        {
          question: "Quelle est la phrase correcte pour dire 'Je vois le professeur' de maniÃ¨re respectueuse ?",
          options: ["ì„ ìƒë‹˜ì„ ë´ìš”.", "ì„ ìƒë‹˜ê»˜ì„œ ë´ìš”.", "ì„ ìƒë‹˜ì„ ëµˆì–´ìš”.", "ì„ ìƒë‹˜ì„ ë³´ì„¸ìš”."],
          answer: "ì„ ìƒë‹˜ì„ ëµˆì–´ìš”.",
          explanation: "`ë³´ë‹¤` devient `ëµˆë‹¤` quand le COD est une personne respectÃ©e.",
          hint1: "`ë³´ë‹¤` â†’ ? (honorifique du complÃ©ment)",
          hint2: "Voir une personne respectÃ©e â‡’ `ëµˆë‹¤`."
        },
        {
          question: "La particule `ê»˜` est la forme honorifique de...",
          options: ["ì—ì„œ", "í•˜ê³ ", "ë§Œ", "ì—ê²Œ/í•œí…Œ"],
          answer: "ì—ê²Œ/í•œí…Œ",
          explanation: "`ê»˜` remplace `ì—ê²Œ/í•œí…Œ` pour indiquer le destinataire (COI) honorifique.",
          hint1: "COI (Ã /chez) â†’ version honorifique.",
          hint2: "`ì—ê²Œ/í•œí…Œ` â†’ `ê»˜`."
        }
      ],
      fillIn: [
        { sentence: "í• ë¨¸ë‹ˆ___ ì§€ê¸ˆ ì£¼ë¬´ì„¸ìš”.", answer: "ê»˜ì„œ", translation: "Grand-mÃ¨re dort maintenant.", vocab: { "í• ë¨¸ë‹ˆ": "grand-mÃ¨re", "ì§€ê¸ˆ": "maintenant", "ì£¼ë¬´ì‹œë‹¤": "dormir (hon.)" }, hint1: "Sujet honorifique â†’ particuleâ€¦", hint2: "`ì´/ê°€` â†’ `ê»˜ì„œ`" },
        { sentence: "ì‚¬ì¥ë‹˜___ ì„ ë¬¼ì„ ë“œë ¸ì–´ìš”.", answer: "ê»˜", translation: "J'ai donnÃ© un cadeau au patron.", vocab: { "ì‚¬ì¥ë‹˜": "patron", "ì„ ë¬¼": "cadeau", "ë“œë¦¬ë‹¤": "donner (hon.)" }, hint1: "COI honorifique.", hint2: "`ì—ê²Œ/í•œí…Œ` â†’ `ê»˜`" },
        { sentence: "ì•„ë²„ì§€ê»˜ì„œ ì‹ ë¬¸ì„ ì½___.", answer: "ìœ¼ì„¸ìš”", translation: "PÃ¨re lit le journal.", vocab: { "ì•„ë²„ì§€": "pÃ¨re", "ì‹ ë¬¸": "journal", "ì½ë‹¤": "lire" }, hint1: "Honorification verbale + í•´ìš”ì²´.", hint2: "ì–´ê°„ + (ìœ¼)ì‹œ + ì–´ìš” â‡’ (ìœ¼)ì„¸ìš”" },
        { sentence: "ì €ëŠ” êµìˆ˜ë‹˜ì„ ì²˜ìŒ ___.", answer: "ëµ™ê² ìŠµë‹ˆë‹¤", translation: "Je rencontre le professeur pour la premiÃ¨re fois. (formel)", vocab: { "ì €": "je", "êµìˆ˜ë‹˜": "professeur", "ì²˜ìŒ": "pour la premiÃ¨re fois", "ëµ™ë‹¤": "voir/rencontrer (hon.)" }, hint1: "Formel/í•©ì‡¼ì²´ ì¢…ê²°.", hint2: "`ëµ™ë‹¤` + ê²  + ìŠµë‹ˆë‹¤" },
        { sentence: "ì–´ë¨¸ë‹ˆ, ì§„ì§€ ___.", answer: "ë“œì„¸ìš”", translation: "Maman, mange ton repas s'il te plaÃ®t.", vocab: { "ì–´ë¨¸ë‹ˆ": "maman", "ì§„ì§€": "repas (hon.)", "ë“œì‹œë‹¤": "manger (hon.)" }, hint1: "Honorifique manger.", hint2: "`ë“œì‹œë‹¤` + (ìœ¼)ì„¸ìš”" }
      ],
      writing: [
        { situation: "Dites que votre mÃ¨re (ì–´ë¨¸ë‹ˆ) se repose (ì‰¬ë‹¤).", answer: "ì–´ë¨¸ë‹ˆê»˜ì„œ ì‰¬ì„¸ìš”.", hint1: "Sujet honorifique + -(ìœ¼)ì‹œ-.", hint2: "`ì–´ë¨¸ë‹ˆê»˜ì„œ` + `ì‰¬ì„¸ìš”`" },
        { situation: "Dites que vous donnez un livre (ì±…) au professeur (ì„ ìƒë‹˜).", answer: "ì„ ìƒë‹˜ê»˜ ì±…ì„ ë“œë ¤ìš”.", hint1: "COI honorifique + ë“œë¦¬ë‹¤.", hint2: "`ì„ ìƒë‹˜ê»˜` + `ë“œë ¤ìš”`" },
        { situation: "Dites que le prÃ©sident (ëŒ€í†µë ¹) parle (ë§ì”€í•˜ë‹¤).", answer: "ëŒ€í†µë ¹ê»˜ì„œ ë§ì”€í•˜ì„¸ìš”.", hint1: "ë§í•˜ë‹¤â†’ë§ì”€í•˜ì‹œë‹¤.", hint2: "`ëŒ€í†µë ¹ê»˜ì„œ` + `ë§ì”€í•˜ì„¸ìš”`" },
        { situation: "Dites que vous voyez (ëµˆë‹¤) votre grand-pÃ¨re (í• ì•„ë²„ì§€).", answer: "í• ì•„ë²„ì§€ë¥¼ ëµˆì–´ìš”.", hint1: "ë³´ë‹¤â†’ëµˆë‹¤ (obj. honor.).", hint2: "`í• ì•„ë²„ì§€` COD, verbe `ëµˆì–´ìš”`" },
        { situation: "Demandez si le client (ì†ë‹˜) a mangÃ© (ì‹ì‚¬í•˜ë‹¤).", answer: "ì†ë‹˜, ì‹ì‚¬í•˜ì…¨ì–´ìš”?", hint1: "í•˜ë‹¤â†’í•˜ì‹œë‹¤.", hint2: "`ì‹ì‚¬í•˜ì‹œë‹¤` + -ì•˜/ì—ˆì–´ìš”?" }
      ],
      listening: [
        { number: 1, ko: "ì„ ìƒë‹˜ê»˜ì„œ í•œêµ­ì–´ë¥¼ ê°€ë¥´ì¹˜ì„¸ìš”.", fr: "Le professeur enseigne le corÃ©en.", hint1: "ã……ã……ã„´ã„²ã…… ã…ã„±ã…‡ã„¹ ã„±ã„¹ã…Šã……ã…‡.", hint2: "ê°€ë¥´ì¹˜ë‹¤ (enseigner)" },
        { number: 2, ko: "í• ë¨¸ë‹ˆê»˜ ì „í™”ë¥¼ ë“œë ¸ì–´ìš”.", fr: "J'ai tÃ©lÃ©phonÃ© Ã  ma grand-mÃ¨re.", hint1: "ã…ã…ã„´ã„² ã…ˆã…ã„¹ ã„·ã„¹ã…‡ã…‡.", hint2: "ì „í™”ë¥¼ ë“œë¦¬ë‹¤ (tÃ©lÃ©phoner - hon.)" },
        { number: 3, ko: "ì‚¬ì¥ë‹˜ì„ ë³µë„ì—ì„œ ëµˆì—ˆì–´ìš”.", fr: "J'ai vu le patron dans le couloir.", hint1: "ã……ã…ˆã„´ã…‡ ã…‚ã„·ã…‡ã…… ã…‚ã…‡ã…‡ã…‡.", hint2: "ë³µë„ (couloir), ëµˆë‹¤ (voir - hon.)" },
        { number: 4, ko: "ì•„ë²„ë‹˜, ì§„ì§€ ë“œì„¸ìš”.", fr: "PÃ¨re, mangez votre repas s'il vous plaÃ®t.", hint1: "ã…‡ã…‚ã„´, ã…ˆã…ˆ ã„·ã……ã…‡.", hint2: "ì•„ë²„ë‹˜ (pÃ¨re - hon.), ì§„ì§€ (repas - hon.)" },
        { number: 5, ko: "ì˜ì‚¬ ì„ ìƒë‹˜ê»˜ì„œ ì§€ê¸ˆ ì•ˆ ê³„ì„¸ìš”.", fr: "Le docteur n'est pas lÃ  pour le moment.", hint1: "ã…‡ã…… ã……ã……ã„´ã„²ã…… ã…ˆã„± ã…‡ ã„±ã……ã…‡.", hint2: "ê³„ì‹œë‹¤ (Ãªtre - hon.), ì•ˆ (ne...pas)" }
      ]
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      populateMCQ();
      populateFillIn();
      populateWriting();
      populateListening();
      setupNavigation();
      document.getElementById('studentName').placeholder = getRandomPlaceholder();
    });

    function getRandomPlaceholder() {
      const placeholders = [
        "Le futur boss du TOPIK !",
        "Qui va briller aujourd'hui ?",
        "Ton nom pour la postÃ©ritÃ© corÃ©enne...",
        "PrÃªt(e) Ã  tout dÃ©chirer ?",
        "Inscris ton nom dans la lÃ©gende !"
      ];
      return placeholders[Math.floor(Math.random() * placeholders.length)];
    }

    // --- helpers (stats) ---
    function ensureStat(qid) {
      if (!stats[qid]) stats[qid] = { listens: 0, hint1: 0, hint2: 0 };
    }
    function bumpHint(qid, which) {
      ensureStat(qid);
      if (which === 1) stats[qid].hint1++;
      else if (which === 2) stats[qid].hint2++;
    }

    // --- Populate: QCM (with hints) ---
    function populateMCQ() {
      const container = document.getElementById('mcq-questions');
      quizData.mcq.forEach((q, index) => {
        const qid = `mcq-${index}`;
        const div = document.createElement('div');
        div.className = 'bg-white p-6 rounded-lg shadow-md';
        div.innerHTML = `
          <p class="font-semibold mb-4">${index + 1}. ${q.question}</p>
          <div class="space-y-2">
            ${q.options.map(opt => `
              <div>
                <input type="radio" id="${qid}-${opt.replace(/\s/g, '-')}"
                       name="${qid}" value="${opt}" class="mr-2 cursor-pointer">
                <label for="${qid}-${opt.replace(/\s/g, '-')}" class="cursor-pointer">${opt}</label>
              </div>
            `).join('')}
          </div>
          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                    class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                    class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
          <div id="${qid}-result" class="mt-4 text-sm"></div>
        `;
        container.appendChild(div);
      });
    }

    // --- Populate: Fill-in (with hints) ---
    function populateFillIn() {
      const container = document.getElementById('fill-in-the-blank-questions');
      quizData.fillIn.forEach((q, index) => {
        const qid = `fill-${index}`;
        const div = document.createElement('div');
        div.className = 'bg-white p-6 rounded-lg shadow-md';
        const sentenceParts = q.sentence.split('___');

        let vocabHTML = '<ul class="list-disc list-inside text-sm text-gray-600 mt-2">';
        for (const [ko, fr] of Object.entries(q.vocab)) {
          vocabHTML += `<li><strong>${ko}</strong> : ${fr}</li>`;
        }
        vocabHTML += '</ul>';

        div.innerHTML = `
          <div class="mb-4">
            <label for="${qid}-input" class="font-semibold text-lg">
              ${index + 1}. ${sentenceParts[0]}
              <input type="text" id="${qid}-input"
                     class="border-b-2 border-gray-300 focus:border-blue-500 outline-none w-24 text-center mx-1">
              ${sentenceParts[1]}
            </label>
            <p class="text-gray-500 italic mt-1">"${q.translation}"</p>
          </div>
          <div>
            <h5 class="font-bold text-sm">Mots utiles :</h5>
            ${vocabHTML}
          </div>
          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                    class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                    class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>

          <div id="${qid}-result" class="mt-4 text-sm"></div>
        `;
        container.appendChild(div);
      });
    }

    // --- Populate: Writing (with hints) ---
    function populateWriting() {
      const container = document.getElementById('writing-questions');
      quizData.writing.forEach((q, index) => {
        const qid = `write-${index}`;
        const div = document.createElement('div');
        div.className = 'bg-white p-6 rounded-lg shadow-md';
        div.innerHTML = `
          <p class="font-semibold mb-2">${index + 1}. ${q.situation}</p>
          <textarea id="${qid}-input" rows="2"
                    class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ã‰crivez votre rÃ©ponse en corÃ©en..."></textarea>

          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                    class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                    class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>

          <div id="${qid}-result" class="mt-4 text-sm"></div>
        `;
        container.appendChild(div);
      });
    }

    // --- Populate: Listening (play button close + self-dictation) ---
    function populateListening() {
      const container = document.getElementById('listening-questions');
      quizData.listening.forEach((q, index) => {
        const qid = `listen-${index}`;
        const div = document.createElement('div');
        div.className = 'bg-white p-6 rounded-lg shadow-lg';
        div.id = qid;

        // label + PLAY button side-by-side (closer to dictation)
        div.innerHTML = `
          <div class="mb-4">
            <h3 class="text-lg font-bold text-blue-800">Phrase ${index + 1}</h3>
          </div>

          <div class="space-y-6">
            <!-- Dictation row with play button right here -->
            <div>
              <div class="flex items-center justify-between gap-2">
                <label class="block font-semibold text-gray-700">1. Ã‰coutez et Ã©crivez (ë°›ì•„ì“°ê¸°)</label>
                <button onclick="playAudio('${q.ko}', this, '${qid}')"
                        class="shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-full transition duration-300 ease-in-out">
                  <i class="fas fa-play"></i>
                </button>
              </div>
              <input type="text" id="${qid}-dictation"
                     class="mt-2 w-full p-2 border border-gray-300 rounded-md"
                     placeholder="Ã‰crivez ce que vous entendez...">
              <div class="mt-2 space-x-2">
                <button onclick="toggleHint('${qid}-hint1'); bumpHint('${qid}',1)"
                        class="text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1 (consonnes)</button>
                <button onclick="toggleHint('${qid}-hint2'); bumpHint('${qid}',2)"
                        class="text-sm bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2 (mots clÃ©s)</button>
              </div>
              <p id="${qid}-hint1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
              <p id="${qid}-hint2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">2. Traduisez en franÃ§ais</label>
              <input type="text" id="${qid}-translation" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Que signifie la phrase ?">
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">3. Enregistrez votre prononciation</label>
              <div class="flex items-center gap-4">
                <button id="${qid}-record-btn" onclick="toggleRecording('${qid}')"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-microphone"></i>
                </button>
                <div id="${qid}-record-status" class="text-gray-600">Cliquez pour enregistrer</div>
              </div>
              <audio id="${qid}-audio-playback" controls class="w-full mt-4 hidden"></audio>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">4. Re-dictÃ©e dâ€™aprÃ¨s ma voix (non notÃ©e)</label>
              <input type="text" id="${qid}-selfdict" class="w-full p-2 border border-gray-300 rounded-md" placeholder="RÃ©Ã©crivez la phrase aprÃ¨s avoir Ã©coutÃ© votre enregistrement.">
              <p class="text-xs text-gray-500 mt-1">Astuce: Ã‰coute ton enregistrement ci-dessus, puis rÃ©Ã©cris la phrase ici.</p>
            </div>
          </div>

          <div id="${qid}-result" class="mt-4 text-sm"></div>
        `;
        container.appendChild(div);
      });
    }

    // --- Navigation ---
    function setupNavigation() {
      const nextBtn = document.getElementById('next-btn');
      const prevBtn = document.getElementById('prev-btn');
      const finishBtn = document.getElementById('finish-btn');
      nextBtn.addEventListener('click', () => { if (currentStep < totalSteps) changeStep(currentStep + 1); });
      prevBtn.addEventListener('click', () => { if (currentStep > 1) changeStep(currentStep - 1); });
      finishBtn.addEventListener('click', collectAndGradeAnswers);
    }

    function changeStep(step) {
      document.querySelector(`.quiz-step[data-step="${currentStep}"]`).style.display = 'none';
      document.querySelector(`.quiz-step[data-step="${step}"]`).style.display = 'block';
      currentStep = step;
      updateNavigation();
      window.scrollTo(0, 0);
    }

    function updateNavigation() {
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const finishBtn = document.getElementById('finish-btn');
      const stepIndicator = document.getElementById('step-indicator');
      prevBtn.disabled = (currentStep === 1);
      nextBtn.style.display = currentStep === totalSteps ? 'none' : 'inline-block';
      finishBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
      stepIndicator.textContent = `Ã‰tape ${currentStep} / ${totalSteps}`;
    }

    // --- Audio (Google TTS + fallback) ---
    const ttsBusy = new Set();
    async function playAudio(text, button, qid = null) {
      if (ttsBusy.has(button)) return;
      ttsBusy.add(button);

      const icon = button.querySelector('i');
      icon.classList.remove('fa-play');
      icon.classList.add('fa-spinner', 'fa-spin');
      button.disabled = true;

      if (qid) {
        ensureStat(qid);
        stats[qid].listens++;
      }

      try {
        const res = await fetch('/.netlify/functions/generate-audio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) {
          const data = await res.json();
          if (data.audioData) {
            const audio = new Audio(`data:${data.mimeType};base64,${data.audioData}`);
            audio.onended = () => resetAudioBtn(icon, button);
            audio.onerror = () => fallbackSpeechSynthesis(text, icon, button);
            audio.play();
            return;
          }
        }
        fallbackSpeechSynthesis(text, icon, button);
      } catch (e) {
        console.error('Audio playback error:', e);
        fallbackSpeechSynthesis(text, icon, button);
      } finally {
        ttsBusy.delete(button);
      }
    }

    function resetAudioBtn(icon, button) {
      icon.classList.remove('fa-spinner', 'fa-spin');
      icon.classList.add('fa-play');
      button.disabled = false;
    }

    function fallbackSpeechSynthesis(text, icon, button) {
      try {
        if ('speechSynthesis' in window) {
          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'ko-KR';
          u.onend = () => resetAudioBtn(icon, button);
          speechSynthesis.speak(u);
        } else {
          throw new Error('Speech Synthesis not supported');
        }
      } catch {
        alert("La synthÃ¨se vocale n'est pas disponible sur votre navigateur.");
        icon.classList.remove('fa-spinner', 'fa-spin');
        icon.classList.add('fa-exclamation-circle');
        button.disabled = false;
      }
    }

    function toggleHint(hintId) {
      const el = document.getElementById(hintId);
      el.classList.toggle('hidden');
    }

    // --- Recording (webm -> base64) ---
    function toggleRecording(qid) {
      if (isRecording) stopRecording(qid);
      else startRecording(qid);
    }

    async function startRecording(qid) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        const chunks = [];
        recordStartAt = performance.now();

        recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };

        recorder.onstop = () => {
          const duration = Math.max(1, Math.round((performance.now() - recordStartAt) / 1000));
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);

          const audioEl = document.getElementById(`${qid}-audio-playback`);
          audioEl.src = url;
          audioEl.classList.remove('hidden');

          const reader = new FileReader();
          reader.onloadend = () => {
            const dataUrl = String(reader.result); // data:audio/webm;base64,AAAA...
            const [header, base64] = dataUrl.split(',');
            const mimeMatch = header.match(/data:(.*?);base64/);
            recordings[qid] = {
              base64,
              mimeType: mimeMatch ? mimeMatch[1] : 'audio/webm',
              duration,
              filename: `${qid}.webm`,
            };
            URL.revokeObjectURL(url);
          };
          reader.readAsDataURL(blob);

          recorder.stream.getTracks().forEach(t => t.stop());
        };

        recorder.start();
        isRecording = true;
        updateRecordingUI(qid, true);
      } catch (error) {
        console.error('Error starting recording:', error);
        alert("Impossible d'accÃ©der au microphone. Veuillez vÃ©rifier les autorisations.");
      }
    }

    function stopRecording(qid) {
      if (recorder && recorder.state !== "inactive") {
        recorder.stop();
        isRecording = false;
        updateRecordingUI(qid, false);
      }
    }

    function updateRecordingUI(qid, isRec) {
      const recordBtn = document.getElementById(`${qid}-record-btn`);
      const statusDiv = document.getElementById(`${qid}-record-status`);
      const icon = recordBtn.querySelector('i');
      if (isRec) {
        recordBtn.classList.replace('bg-red-500', 'bg-gray-700');
        recordBtn.classList.add('animate-pulse');
        icon.classList.replace('fa-microphone', 'fa-stop');
        statusDiv.textContent = 'Enregistrement en cours...';
      } else {
        recordBtn.classList.replace('bg-gray-700', 'bg-red-500');
        recordBtn.classList.remove('animate-pulse');
        icon.classList.replace('fa-stop', 'fa-microphone');
        statusDiv.textContent = 'Enregistrement terminÃ©.';
      }
    }

    // --- Send results to server ---
    async function sendResultsToServer(payload) {
      try {
        const res = await fetch('/.netlify/functions/send-results', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        console.log('RÃ©sultats envoyÃ©s:', data);
      } catch (err) {
        console.error("Erreur d'envoi des rÃ©sultats:", err);
      }
    }

    // --- Grading and Results ---
    function collectAndGradeAnswers() {
      let score = 0, total = 0;
      const questionsForMail = [];

      // QCM
      quizData.mcq.forEach((q, i) => {
        const qid = `mcq-${i}`;
        const userAnswer = document.querySelector(`input[name="${qid}"]:checked`)?.value || '';
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) score++; total++;

        document.getElementById(`${qid}-result`).innerHTML = isCorrect
          ? `<p class="text-green-600 font-bold">Correct ! ğŸ‘ ${q.explanation}</p>`
          : `<p class="text-red-600 font-bold">Oups... La bonne rÃ©ponse Ã©tait : "${q.answer}"</p><p class="text-gray-600">ğŸ˜… â†’ ${q.explanation}</p>`;

        const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
        questionsForMail.push({
          number: `QCM ${i + 1}`, fr: q.question, ko: '',
          userAnswer, isCorrect,
          listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
        });
      });

      // Fill-in
      quizData.fillIn.forEach((q, i) => {
        const qid = `fill-${i}`;
        const userAnswer = document.getElementById(`${qid}-input`).value.trim();
        const isCorrect = userAnswer === q.answer;
        if (isCorrect) score++; total++;

        document.getElementById(`${qid}-result`).innerHTML = isCorrect
          ? `<p class="text-green-600 font-bold">Parfait !</p>`
          : `<p class="text-red-600 font-bold">Oups, petit couac ğŸ˜… â†’ La rÃ©ponse correcte est : "${q.answer}"</p>`;

        const koFull = q.sentence.replace('___', q.answer);
        const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
        questionsForMail.push({
          number: `FILL ${i + 1}`, fr: q.translation, ko: koFull,
          userAnswer, isCorrect,
          listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
        });
      });

      // Writing
      quizData.writing.forEach((q, i) => {
        const qid = `write-${i}`;
        const userAnswer = document.getElementById(`${qid}-input`).value.trim();
        const isCorrect = userAnswer.length > 0;
        if (isCorrect) score++; total++;

        document.getElementById(`${qid}-result`).innerHTML =
          `<p class="text-blue-600">RÃ©ponse suggÃ©rÃ©e : "${q.answer}".</p>`;

        const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
        questionsForMail.push({
          number: `WR ${i + 1}`, fr: q.situation, ko: q.answer,
          userAnswer, isCorrect,
          listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2
        });
      });

      // Listening (includes self-dictation & recording)
      quizData.listening.forEach((q, i) => {
        const qid = `listen-${i}`;
        const userAnswerKo = document.getElementById(`${qid}-dictation`).value.trim().replace(/[.?]/g, '');
        const isCorrectKo = userAnswerKo === q.ko.replace(/[.?]/g, '');
        if (isCorrectKo) score++; total++;

        const resultDiv = document.getElementById(`${qid}-result`);
        let resultHTML = isCorrectKo
          ? `<p class="text-green-600 font-bold">DictÃ©e parfaite ! ğŸ‘</p>`
          : `<p class="text-red-600 font-bold">DictÃ©e - Oups... ğŸ˜… â†’ La phrase correcte est : "${q.ko}"</p>`;
        resultHTML += `<p class="text-blue-600 mt-1">Traduction : "${q.fr}"</p>`;
        resultDiv.innerHTML = resultHTML;

        const s = stats[qid] || { listens:0, hint1:0, hint2:0 };
        const rec = recordings[qid];
        const selfDict = document.getElementById(`${qid}-selfdict`).value.trim();

        const item = {
          number: `LS ${i + 1}`, fr: q.fr, ko: q.ko,
          userAnswer: userAnswerKo, isCorrect: isCorrectKo,
          listenCount: s.listens, hint1Count: s.hint1, hint2Count: s.hint2,
          selfDictation: selfDict
        };
        if (rec) item.recording = rec;

        questionsForMail.push(item);
      });

      displayResults(score, total, questionsForMail);
    }

    function displayResults(score, total, questionsForMail) {
      document.getElementById('quiz-container').style.display = 'none';
      document.querySelector('.flex.justify-between.items-center').style.display = 'none';
      const resultsSection = document.getElementById('results-section');

      const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
      let frMessage, icon;
      if (percentage === 100) { frMessage = "Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !"; icon = 'fa-crown text-yellow-500'; }
      else if (percentage >= 80) { frMessage = "TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !"; icon = 'fa-thumbs-up text-green-500'; }
      else if (percentage >= 60) { frMessage = "Pas mal du tout ! ğŸ˜ Encore un petit effort !"; icon = 'fa-glasses text-blue-500'; }
      else { frMessage = "Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª"; icon = 'fa-coffee text-red-500'; }

      resultsSection.innerHTML = `
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
          <i class="fas ${icon} text-6xl mb-4"></i>
          <h2 class="text-3xl font-bold text-blue-800 mb-2">${frMessage}</h2>
          <p class="text-4xl font-bold text-gray-800 mb-6">Votre score : ${score} / ${total} (${percentage}%)</p>
          <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105">
            <i class="fas fa-redo-alt mr-2"></i> Recommencer
          </button>
        </div>
      `;
      resultsSection.style.display = 'block';
      resultsSection.scrollIntoView({ behavior: 'smooth' });

      // send payload
      const endTime = new Date().toISOString();
      const totalTimeSeconds = Math.max(1, Math.round((new Date(endTime) - new Date(sessionMeta.startTime)) / 1000));
      const payload = {
        studentName: document.getElementById('studentName').value.trim() || 'Ã‰lÃ¨ve',
        startTime: sessionMeta.startTime,
        endTime,
        totalTimeSeconds,
        questions: questionsForMail
      };
      sendResultsToServer(payload);
    }
  </script>
</body>
</html>
