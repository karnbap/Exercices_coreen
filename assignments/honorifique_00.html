<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice CorÃ©en: Focus sur la Forme Honorifique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .quiz-step { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from {opacity:0;transform:translateY(20px);} to {opacity:1;transform:translateY(0);} }
    .table-wrap { overflow-x:auto; }
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <!-- En-tÃªte -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    <div class="text-sm text-gray-500">
      <p class="font-semibold">Fait par ì„±ì¼, Pongdang</p>
    </div>
    <h1 class="text-xl md:text-2xl font-bold text-center text-blue-800">Les 3 Types d'Honorifiques</h1>
    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex items-center">
      <i class="fas fa-print mr-2"></i> <span class="hidden md:inline">Imprimer</span>
    </button>
  </header>

  <main class="container mx-auto p-4 md:p-8">

    <!-- Section Nom de l'Ã©tudiant -->
    <section id="student-name-section" class="text-center mb-12">
      <h2 class="text-2xl font-bold mb-4">Qui est le champion du jour ? ğŸ†</h2>
      <input type="text" id="studentName" placeholder="Entrez votre nom ici, futur maÃ®tre du corÃ©en !" class="text-center p-3 border-2 border-blue-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-1/2">
    </section>

    <!-- Conteneur des exercices -->
    <div id="quiz-container" class="space-y-16">

      <!-- Ã‰tape 1 -->
      <div class="quiz-step" data-step="1">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">1. Les 3 Types d'Honorifiques ! ğŸ¤”</h2>
        <div class="bg-white p-6 rounded-lg shadow-md space-y-6 text-base md:text-lg">
          <!-- ì£¼ì²´ ë†’ì„ë²• -->
          <div class="border-2 border-blue-200 p-4 rounded-lg">
            <h4 class="font-bold text-blue-600">ğŸŸ¢ ì£¼ì²´ ë†’ì„ë²• (Honorification du sujet)</h4>
            <p class="mt-2 text-gray-700">Le <strong>sujet</strong> de la phrase est une personne respectÃ©e (professeur, aÃ®nÃ©, etc.).</p>
            <p class="mt-3">On montre le respect en modifiant le verbe (suffixe <code class="bg-red-100 p-1 rounded font-bold">-(ìœ¼)ì‹œ-</code>) et en utilisant une particule de sujet honorifique (<code class="bg-blue-100 p-1 rounded font-bold">ê»˜ì„œ</code>).</p>
            <p class="mt-2">âœ… <code class="bg-gray-100 p-1 rounded">ì„ ìƒë‹˜<span class="text-blue-500 font-bold">ê»˜ì„œ</span> ì˜¤<span class="text-red-500 font-bold">ì„¸</span>ìš”.</code></p>
          </div>
          <!-- ê°ì²´ ë†’ì„ë²• -->
          <div class="border-2 border-green-200 p-4 rounded-lg">
            <h4 class="font-bold text-green-600">ğŸŸ¡ ê°ì²´ ë†’ì„ë²• (Honorification du complÃ©ment)</h4>
            <p class="mt-2 text-gray-700">Le <strong>complÃ©ment</strong> (COD ou COI) est une personne importante (professeur, parent, etc.).</p>
            <p class="mt-3">On utilise des verbes honorifiques spÃ©cifiques (<code class="bg-purple-100 p-1 rounded font-bold">ëµ™ë‹¤, ë“œë¦¬ë‹¤, ì—¬ì­™ë‹¤</code>...).</p>
            <p class="mt-2">âœ… <code class="bg-gray-100 p-1 rounded">ì„ ìƒë‹˜ê»˜ ì„ ë¬¼ì„ <span class="text-purple-500 font-bold">ë“œë ¤ìš”</span>.</code></p>
          </div>
          <!-- ìƒëŒ€ ë†’ì„ë²• -->
          <div class="border-2 border-orange-200 p-4 rounded-lg">
            <h4 class="font-bold text-orange-600">ğŸ”µ ìƒëŒ€ ë†’ì„ë²• (Honorification de lâ€™interlocuteur)</h4>
            <p class="mt-2 text-gray-700">Politesse envers la personne <strong>Ã  qui lâ€™on parle</strong>.</p>
            <p class="text-sm text-gray-600 italic mt-1">ğŸ‘‰ Comme Â« 3 registres de langue Â» en franÃ§ais : Â« Je te remercie Â» (familier) â†’ Â« Je vous remercie Â» (standard) â†’ Â« Je vous suis reconnaissant Â» (soutenu).</p>
            <p class="mt-3 text-gray-700">âš ï¸ DiffÃ©rence : en corÃ©en, le <strong>formel</strong> (í•©ì‡¼ì²´) dÃ©pend de la <u>situation</u> (pro, officiel, inconnus). Et <code class="bg-gray-100 p-1 rounded">ê°ì‚¬í•©ë‹ˆë‹¤</code>, <code class="bg-gray-100 p-1 rounded">ì£„ì†¡í•©ë‹ˆë‹¤</code> sâ€™emploient trÃ¨s souvent pour renforcer la politesse.</p>
            <ul class="mt-2 space-y-1 list-disc list-inside">
              <li><code class="bg-gray-100 p-1 rounded">ê°€</code> (familier / ë°˜ë§)</li>
              <li><code class="bg-gray-100 p-1 rounded">ê°€<span class="text-orange-500 font-bold">ìš”</span></code> (poli / í•´ìš”ì²´)</li>
              <li><code class="bg-gray-100 p-1 rounded">ê°‘<span class="text-orange-500 font-bold">ë‹ˆë‹¤</span></code> (trÃ¨s formel / í•©ì‡¼ì²´)</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Ã‰tape 2: Mots et Expressions ClÃ©s -->
      <div class="quiz-step" data-step="2" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">2. Mots et Expressions ClÃ©s ğŸ“‹</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <p class="text-gray-700 mb-4">Voici quelques mots et particules honorifiques essentiels Ã  mÃ©moriser !</p>
          <div class="table-wrap">
            <table class="min-w-full text-left text-sm">
              <thead>
                <tr class="bg-blue-50 text-blue-800">
                  <th class="px-3 py-2 font-semibold">Type</th>
                  <th class="px-3 py-2 font-semibold">Forme Standard</th>
                  <th class="px-3 py-2 font-semibold">Forme Honorifique</th>
                  <th class="px-3 py-2 font-semibold">Utilisation</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                <tr><td class="px-3 py-2">ì£¼ì²´ (Sujet)</td><td class="px-3 py-2">Suffixe de verbe</td><td class="px-3 py-2">-(ìœ¼)ì‹œ-</td><td class="px-3 py-2">Ex: ì½ë‹¤ â†’ ì½ìœ¼ì‹œë‹¤</td></tr>
                <tr><td class="px-3 py-2">ì£¼ì²´ (Sujet)</td><td class="px-3 py-2">ì´/ê°€</td><td class="px-3 py-2">ê»˜ì„œ</td><td class="px-3 py-2">Pour le sujet respectÃ©</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ì—ê²Œ/í•œí…Œ</td><td class="px-3 py-2">ê»˜</td><td class="px-3 py-2">Pour le destinataire respectÃ©</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ë³´ë‹¤ (voir)</td><td class="px-3 py-2">ëµ™ë‹¤ / ëµˆë‹¤</td><td class="px-3 py-2">Quand on voit une personne respectÃ©e</td></tr>
                <tr><td class="px-3 py-2">ê°ì²´ (ComplÃ©ment)</td><td class="px-3 py-2">ì£¼ë‹¤ (donner)</td><td class="px-3 py-2">ë“œë¦¬ë‹¤</td><td class="px-3 py-2">Quand on donne Ã  une personne respectÃ©e</td></tr>
                <tr><td class="px-3 py-2">Verbe</td><td class="px-3 py-2">ë¨¹ë‹¤ (manger)</td><td class="px-3 py-2">ë“œì‹œë‹¤ / ì¡ìˆ˜ì‹œë‹¤</td><td class="px-3 py-2">Quand une personne respectÃ©e mange</td></tr>
                <tr><td class="px-3 py-2">Verbe</td><td class="px-3 py-2">ìë‹¤ (dormir)</td><td class="px-3 py-2">ì£¼ë¬´ì‹œë‹¤</td><td class="px-3 py-2">Quand une personne respectÃ©e dort</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ã‰tape 3: QCM -->
      <div class="quiz-step" data-step="3" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">3. Choisis la bonne rÃ©ponse ! ğŸ¤” (5 questions)</h2>
        <div id="mcq-questions" class="space-y-6"></div>
      </div>

      <!-- Ã‰tape 4: Mots Ã  complÃ©ter -->
      <div class="quiz-step" data-step="4" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">4. ComplÃ¨te avec le bon mot ! âœï¸ (5 questions)</h2>
        <div id="fill-in-the-blank-questions" class="space-y-6"></div>
      </div>

      <!-- Ã‰tape 5: Ã‰criture -->
      <div class="quiz-step" data-step="5" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">5. Ã€ toi d'Ã©crire ! âœ’ï¸ (5 phrases)</h2>
        <p class="text-gray-600 mb-6">Ã‰cris la phrase en corÃ©en en utilisant la forme honorifique.</p>
        <div id="writing-questions" class="space-y-8"></div>
      </div>

      <!-- Ã‰tape 6: Ã‰coute et Ã©cris -->
      <div class="quiz-step" data-step="6" style="display:none;">
        <h2 class="text-2xl font-bold text-blue-700 mb-4">6. Ã‰coute et Ã©cris ! ğŸ§ (5 phrases)</h2>
        <p class="text-gray-600 mb-6">Ã‰coute, Ã©cris, enregistre ta voix, puis rÃ©essaie la dictÃ©e dâ€™aprÃ¨s ta propre voix. (La 2e dictÃ©e nâ€™est pas notÃ©e, mais est envoyÃ©e au prof avec l'audio.)</p>
        <div id="listening-questions" class="space-y-12"></div>
      </div>
    </div>

    <!-- Boutons de navigation -->
    <div id="nav-bar" class="mt-12 flex justify-between items-center">
      <button id="prev-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50" disabled>
        <i class="fas fa-arrow-left mr-2"></i> PrÃ©cÃ©dent
      </button>
      <div id="step-indicator" class="text-gray-600 font-semibold">Ã‰tape 1 / 6</div>
      <button id="next-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        Suivant <i class="fas fa-arrow-right ml-2"></i>
      </button>
      <button id="finish-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300" style="display:none;">
        Terminer & Voir les rÃ©sultats <i class="fas fa-check-circle ml-2"></i>
      </button>
    </div>

    <!-- âœ… RÃ©sultats: ì»¨í…Œì´ë„ˆ ë°–ìœ¼ë¡œ ì´ë™ (í•­ìƒ í‘œì‹œ ê°€ëŠ¥) -->
    <div id="results-section" class="text-center mt-10" style="display:none;"></div>

    <footer class="text-center mt-12 text-sm text-gray-500">
      <p>Fait avec â¤ï¸ par ì„±ì¼, Pondant, Laon</p>
    </footer>
  </main>

  <script>
    // --- Global State & Config ---
    let currentStep = 1;
    const totalSteps = 6;

    const sessionMeta = { startTime: new Date().toISOString() };
    const stats = {};
    const recordings = {};

    let recorder; let isRecording = false; let recordStartAt = 0;
    let hasSubmitted = false;  // finish guard
    let emailSent = false;     // email guard

    // ===== DATA (avec Indice 1/2 partout) =====
    const quizData = {
      mcq: [
        { question: "Pour remplacer la particule sujet `ì´/ê°€` quand on parle de son grand-pÃ¨re, on utilise...", options:["ì€/ëŠ”","ê»˜ì„œ","ì„/ë¥¼","ê»˜"], answer:"ê»˜ì„œ", explanation:"`ê»˜ì„œ` est la particule honorifique qui remplace `ì´/ê°€` pour un sujet respectÃ©.", hint1:"Particule sujetâ€¦ version honorifique.", hint2:"Sujet respectÃ© â‡’ `ê»˜ì„œ`." },
        { question: "Dans la phrase `ì–´ë¨¸ë‹ˆê»˜ì„œ ì±…ì„ ì½ìœ¼ì„¸ìš”`, qu'est-ce qui montre le respect dans le verbe ?", options:["-ì–´ìš”","-ìœ¼ì„¸ìš”","-ì„¸ìš”","-ìœ¼-"], answer:"-ìœ¼ì„¸ìš”", explanation:"On ajoute `-(ìœ¼)ì‹œ-` Ã  `ì½-` + `-ì–´ìš”` â‡’ `ì½ìœ¼ì„¸ìš”`.", hint1:"Terminaison polie + ì‹œ.", hint2:"-(ìœ¼)ì‹œ- + í•´ìš”ì²´ â‡’ -(ìœ¼)ì„¸ìš”." },
        { question: "Quel est le verbe honorifique pour `ì£¼ë‹¤` (donner) ?", options:["ë“œë¦¬ë‹¤","ë°›ë‹¤","ë³´ë‹¤","ê³„ì‹œë‹¤"], answer:"ë“œë¦¬ë‹¤", explanation:"Donner Ã  une personne respectÃ©e â‡’ `ë“œë¦¬ë‹¤`.", hint1:"Donner â†’ hon.", hint2:"`ì£¼ë‹¤`â†’`ë“œë¦¬ë‹¤`." },
        { question: "Quelle est la phrase correcte pour dire 'Je vois le professeur' de maniÃ¨re respectueuse ?", options:["ì„ ìƒë‹˜ì„ ë´ìš”.","ì„ ìƒë‹˜ê»˜ì„œ ë´ìš”.","ì„ ìƒë‹˜ì„ ëµˆì–´ìš”.","ì„ ìƒë‹˜ì„ ë³´ì„¸ìš”."], answer:"ì„ ìƒë‹˜ì„ ëµˆì–´ìš”.", explanation:"`ë³´ë‹¤` â†’ `ëµˆë‹¤` quand le COD est honorifique.", hint1:"`ë³´ë‹¤`ì˜ ê°ì²´ ë†’ì„.", hint2:"Voir â†’ `ëµˆë‹¤`." },
        { question: "La particule `ê»˜` est la forme honorifique de...", options:["ì—ì„œ","í•˜ê³ ","ë§Œ","ì—ê²Œ/í•œí…Œ"], answer:"ì—ê²Œ/í•œí…Œ", explanation:"COI honorifique â‡’ `ê»˜`.", hint1:"COI (Ã /chez) hon.", hint2:"`ì—ê²Œ/í•œí…Œ` â†’ `ê»˜`." }
      ],
      fillIn: [
        { sentence:"í• ë¨¸ë‹ˆ___ ì§€ê¸ˆ ì£¼ë¬´ì„¸ìš”.", answer:"ê»˜ì„œ", translation:"Grand-mÃ¨re dort maintenant.", vocab:{"í• ë¨¸ë‹ˆ":"grand-mÃ¨re","ì§€ê¸ˆ":"maintenant","ì£¼ë¬´ì‹œë‹¤":"dormir (hon.)"}, hint1:"Sujet honorifique â†’ particule.", hint2:"`ì´/ê°€`â†’`ê»˜ì„œ`" },
        { sentence:"ì‚¬ì¥ë‹˜___ ì„ ë¬¼ì„ ë“œë ¸ì–´ìš”.", answer:"ê»˜", translation:"J'ai donnÃ© un cadeau au patron.", vocab:{"ì‚¬ì¥ë‹˜":"patron","ì„ ë¬¼":"cadeau","ë“œë¦¬ë‹¤":"donner (hon.)"}, hint1:"COI honorifique.", hint2:"`ì—ê²Œ/í•œí…Œ`â†’`ê»˜`" },
        { sentence:"ì•„ë²„ì§€ê»˜ì„œ ì‹ ë¬¸ì„ ì½___.", answer:"ìœ¼ì„¸ìš”", translation:"PÃ¨re lit le journal.", vocab:{"ì•„ë²„ì§€":"pÃ¨re","ì‹ ë¬¸":"journal","ì½ë‹¤":"lire"}, hint1:"Honorification verbale+í•´ìš”ì²´.", hint2:"ì–´ê°„+(ìœ¼)ì‹œ+ì–´ìš”" },
        { sentence:"ì €ëŠ” êµìˆ˜ë‹˜ì„ ì²˜ìŒ ___.", answer:"ëµ™ê² ìŠµë‹ˆë‹¤", translation:"Je rencontre le professeur pour la premiÃ¨re fois. (formel)", vocab:{"ì €":"je","êµìˆ˜ë‹˜":"professeur","ì²˜ìŒ":"pour la premiÃ¨re fois","ëµ™ë‹¤":"voir (hon.)"}, hint1:"í•©ì‡¼ì²´ ì¢…ê²°.", hint2:"ëµ™ + ê²  + ìŠµë‹ˆë‹¤" },
        { sentence:"ì–´ë¨¸ë‹ˆ, ì§„ì§€ ___.", answer:"ë“œì„¸ìš”", translation:"Maman, mange ton repas s'il te plaÃ®t.", vocab:{"ì–´ë¨¸ë‹ˆ":"maman","ì§„ì§€":"repas (hon.)","ë“œì‹œë‹¤":"manger (hon.)"}, hint1:"ë¨¹ë‹¤ì˜ ë†’ì„.", hint2:"ë“œì‹œë‹¤+(ìœ¼)ì„¸ìš”" }
      ],
      writing: [
        { situation:"Dites que votre mÃ¨re (ì–´ë¨¸ë‹ˆ) se repose (ì‰¬ë‹¤).", answer:"ì–´ë¨¸ë‹ˆê»˜ì„œ ì‰¬ì„¸ìš”.", hint1:"Sujet honorifique + -(ìœ¼)ì‹œ-.", hint2:"ì–´ë¨¸ë‹ˆê»˜ì„œ + ì‰¬ì„¸ìš”" },
        { situation:"Dites que vous donnez un livre (ì±…) au professeur (ì„ ìƒë‹˜).", answer:"ì„ ìƒë‹˜ê»˜ ì±…ì„ ë“œë ¤ìš”.", hint1:"COI hon. + ë“œë¦¬ë‹¤.", hint2:"ì„ ìƒë‹˜ê»˜ + ë“œë ¤ìš”" },
        { situation:"Dites que le prÃ©sident (ëŒ€í†µë ¹) parle (ë§ì”€í•˜ë‹¤).", answer:"ëŒ€í†µë ¹ê»˜ì„œ ë§ì”€í•˜ì„¸ìš”.", hint1:"ë§í•˜ë‹¤â†’ë§ì”€í•˜ì‹œë‹¤.", hint2:"ëŒ€í†µë ¹ê»˜ì„œ + ë§ì”€í•˜ì„¸ìš”" },
        { situation:"Dites que vous voyez (ëµˆë‹¤) votre grand-pÃ¨re (í• ì•„ë²„ì§€).", answer:"í• ì•„ë²„ì§€ë¥¼ ëµˆì–´ìš”.", hint1:"ë³´ë‹¤â†’ëµˆë‹¤.", hint2:"í• ì•„ë²„ì§€(ëª©ì ì–´) + ëµˆì–´ìš”" },
        { situation:"Demandez si le client (ì†ë‹˜) a mangÃ© (ì‹ì‚¬í•˜ë‹¤).", answer:"ì†ë‹˜, ì‹ì‚¬í•˜ì…¨ì–´ìš”?", hint1:"í•˜ë‹¤â†’í•˜ì‹œë‹¤.", hint2:"-ì•˜/ì—ˆì–´ìš”?" }
      ],
      listening: [
        { number:1, ko:"ì„ ìƒë‹˜ê»˜ì„œ í•œêµ­ì–´ë¥¼ ê°€ë¥´ì¹˜ì„¸ìš”.", fr:"Le professeur enseigne le corÃ©en.", hint1:"ã……ã……ã„´ã„²ã…… ã…ã„±ã…‡ã„¹ ã„±ã„¹ã…Šã……ã…‡.", hint2:"ê°€ë¥´ì¹˜ë‹¤ (enseigner)" },
        { number:2, ko:"í• ë¨¸ë‹ˆê»˜ ì „í™”ë¥¼ ë“œë ¸ì–´ìš”.", fr:"J'ai tÃ©lÃ©phonÃ© Ã  ma grand-mÃ¨re.", hint1:"ã…ã…ã„´ã„² ã…ˆã…ã„¹ ã„·ã„¹ã…‡ã…‡.", hint2:"ì „í™”ë¥¼ ë“œë¦¬ë‹¤ (hon.)" },
        { number:3, ko:"ì‚¬ì¥ë‹˜ì„ ë³µë„ì—ì„œ ëµˆì—ˆì–´ìš”.", fr:"J'ai vu le patron dans le couloir.", hint1:"ã……ã…ˆã„´ã…‡ ã…‚ã„·ã…‡ã…… ã…‚ã…‡ã…‡ã…‡.", hint2:"ë³µë„, ëµˆë‹¤" },
        { number:4, ko:"ì•„ë²„ë‹˜, ì§„ì§€ ë“œì„¸ìš”.", fr:"PÃ¨re, mangez votre repas s'il vous plaÃ®t.", hint1:"ã…‡ã…‚ã„´, ã…ˆã…ˆ ã„·ã……ã…‡.", hint2:"ì•„ë²„ë‹˜, ì§„ì§€" },
        { number:5, ko:"ì˜ì‚¬ ì„ ìƒë‹˜ê»˜ì„œ ì§€ê¸ˆ ì•ˆ ê³„ì„¸ìš”.", fr:"Le docteur n'est pas lÃ  pour le moment.", hint1:"ã…‡ã…… ã……ã……ã„´ã„²ã…… ã…ˆã„± ã…‡ ã„±ã……ã…‡.", hint2:"ê³„ì‹œë‹¤, ì•ˆ" }
      ]
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      populateMCQ(); populateFillIn(); populateWriting(); populateListening();
      setupNavigation();
      document.getElementById('studentName').placeholder = getRandomPlaceholder();
    });

    function getRandomPlaceholder() {
      const p = ["Le futur boss du TOPIK !","Qui va briller aujourd'hui ?","Ton nom pour la postÃ©ritÃ© corÃ©enne...","PrÃªt(e) Ã  tout dÃ©chirer ?","Inscris ton nom dans la lÃ©gende !"];
      return p[Math.floor(Math.random()*p.length)];
    }

    function ensureStat(id){ if(!stats[id]) stats[id]={listens:0,hint1:0,hint2:0}; }
    function bumpHint(id,w){ ensureStat(id); if(w===1)stats[id].hint1++; else stats[id].hint2++; }
    function toggleHint(id){ document.getElementById(id).classList.toggle('hidden'); }

    // --- QCM ---
    function populateMCQ(){
      const c=document.getElementById('mcq-questions');
      quizData.mcq.forEach((q,i)=>{
        const id=`mcq-${i}`;
        const d=document.createElement('div');
        d.className='bg-white p-6 rounded-lg shadow-md';
        d.innerHTML=`
          <p class="font-semibold mb-4">${i+1}. ${q.question}</p>
          <div class="space-y-2">
            ${q.options.map(opt=>`
              <div>
                <input type="radio" id="${id}-${opt.replace(/\s/g,'-')}" name="${id}" value="${opt}" class="mr-2 cursor-pointer">
                <label for="${id}-${opt.replace(/\s/g,'-')}" class="cursor-pointer">${opt}</label>
              </div>`).join('')}
          </div>
          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${id}-h1');bumpHint('${id}',1)" class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${id}-h2');bumpHint('${id}',2)" class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${id}-h1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${id}-h2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
          <div id="${id}-result" class="mt-4 text-sm"></div>`;
        c.appendChild(d);
      });
    }

    // --- Fill-in ---
    function populateFillIn(){
      const c=document.getElementById('fill-in-the-blank-questions');
      quizData.fillIn.forEach((q,i)=>{
        const id=`fill-${i}`;
        const d=document.createElement('div');
        d.className='bg-white p-6 rounded-lg shadow-md';
        const parts=q.sentence.split('___');
        let vocab='<ul class="list-disc list-inside text-sm text-gray-600 mt-2">';
        Object.entries(q.vocab).forEach(([ko,fr])=>{vocab+=`<li><strong>${ko}</strong> : ${fr}</li>`}); vocab+='</ul>';
        d.innerHTML=`
          <div class="mb-4">
            <label for="${id}-in" class="font-semibold text-lg">
              ${i+1}. ${parts[0]}
              <input type="text" id="${id}-in" class="border-b-2 border-gray-300 focus:border-blue-500 outline-none w-24 text-center mx-1">
              ${parts[1]}
            </label>
            <p class="text-gray-500 italic mt-1">"${q.translation}"</p>
          </div>
          <div><h5 class="font-bold text-sm">Mots utiles :</h5>${vocab}</div>
          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${id}-h1');bumpHint('${id}',1)" class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${id}-h2');bumpHint('${id}',2)" class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${id}-h1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${id}-h2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
          <div id="${id}-result" class="mt-4 text-sm"></div>`;
        c.appendChild(d);
      });
    }

    // --- Writing ---
    function populateWriting(){
      const c=document.getElementById('writing-questions');
      quizData.writing.forEach((q,i)=>{
        const id=`write-${i}`;
        const d=document.createElement('div');
        d.className='bg-white p-6 rounded-lg shadow-md';
        d.innerHTML=`
          <p class="font-semibold mb-2">${i+1}. ${q.situation}</p>
          <textarea id="${id}-in" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ã‰crivez votre rÃ©ponse en corÃ©en..."></textarea>
          <div class="mt-3 space-x-2">
            <button onclick="toggleHint('${id}-h1');bumpHint('${id}',1)" class="text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1</button>
            <button onclick="toggleHint('${id}-h2');bumpHint('${id}',2)" class="text-xs bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2</button>
          </div>
          <p id="${id}-h1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
          <p id="${id}-h2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
          <div id="${id}-result" class="mt-4 text-sm"></div>`;
        c.appendChild(d);
      });
    }

    // --- Listening (ğŸ§ play ë²„íŠ¼ì„ ì…ë ¥ì°½ ì˜†ìœ¼ë¡œ) ---
    function populateListening(){
      const c=document.getElementById('listening-questions');
      quizData.listening.forEach((q,i)=>{
        const id=`listen-${i}`;
        const d=document.createElement('div');
        d.className='bg-white p-6 rounded-lg shadow-lg';
        d.id=id;
        d.innerHTML=`
          <div class="mb-4">
            <h3 class="text-lg font-bold text-blue-800">Phrase ${i+1}</h3>
          </div>

          <div class="space-y-6">

            <!-- 1. DictÃ©e + Play collÃ©s -->
            <div>
              <label class="block font-semibold text-gray-700 mb-1">1. Ã‰coutez et Ã©crivez (ë°›ì•„ì“°ê¸°)</label>
              <div class="flex items-center gap-2">
                <input type="text" id="${id}-dictation" class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Ã‰crivez ce que vous entendez...">
                <button onclick="playAudio('${q.ko}', this, '${id}')" aria-label="Ã‰couter la phrase"
                        class="w-10 h-10 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full transition duration-300">
                  <i class="fas fa-play text-sm"></i>
                </button>
              </div>
              <div class="mt-2 space-x-2">
                <button onclick="toggleHint('${id}-h1');bumpHint('${id}',1)" class="text-sm bg-yellow-400 hover:bg-yellow-500 text-yellow-900 py-1 px-3 rounded-full">Indice 1 (consonnes)</button>
                <button onclick="toggleHint('${id}-h2');bumpHint('${id}',2)" class="text-sm bg-orange-400 hover:bg-orange-500 text-orange-900 py-1 px-3 rounded-full">Indice 2 (mots clÃ©s)</button>
              </div>
              <p id="${id}-h1" class="hidden mt-2 text-sm text-yellow-700 p-2 bg-yellow-50 rounded-md">${q.hint1}</p>
              <p id="${id}-h2" class="hidden mt-2 text-sm text-orange-700 p-2 bg-orange-50 rounded-md">${q.hint2}</p>
            </div>

            <!-- 2. Traduction -->
            <div>
              <label class="block font-semibold mb-2 text-gray-700">2. Traduisez en franÃ§ais</label>
              <input type="text" id="${id}-translation" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Que signifie la phrase ?">
            </div>

            <!-- 3. Enregistrement -->
            <div>
              <label class="block font-semibold mb-2 text-gray-700">3. Enregistrez votre prononciation</label>
              <div class="flex items-center gap-4">
                <button id="${id}-record-btn" onclick="toggleRecording('${id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300">
                  <i class="fas fa-microphone"></i>
                </button>
                <div id="${id}-record-status" class="text-gray-600">Cliquez pour enregistrer</div>
              </div>
              <audio id="${id}-audio-playback" controls class="w-full mt-4 hidden"></audio>
            </div>

            <!-- 4. Re-dictÃ©e -->
            <div>
              <label class="block font-semibold mb-2 text-gray-700">4. Re-dictÃ©e dâ€™aprÃ¨s ma voix (non notÃ©e)</label>
              <input type="text" id="${id}-selfdict" class="w-full p-2 border border-gray-300 rounded-md" placeholder="RÃ©Ã©crivez la phrase aprÃ¨s avoir Ã©coutÃ© votre enregistrement.">
              <p class="text-xs text-gray-500 mt-1">Astuce: Ã‰coute ton enregistrement ci-dessus, puis rÃ©Ã©cris la phrase ici.</p>
            </div>
          </div>

          <div id="${id}-result" class="mt-4 text-sm"></div>`;
        c.appendChild(d);
      });
    }

    // --- Navigation ---
    function setupNavigation(){
      const nextBtn=document.getElementById('next-btn');
      const prevBtn=document.getElementById('prev-btn');
      const finishBtn=document.getElementById('finish-btn');

      nextBtn.addEventListener('click',()=>{ if(currentStep<totalSteps) changeStep(currentStep+1); });
      prevBtn.addEventListener('click',()=>{ if(currentStep>1) changeStep(currentStep-1); });

      // ëë‚´ê¸°: í•œ ë²ˆë§Œ ë™ì‘ + ì¦‰ì‹œ ë¹„í™œì„±í™”
      finishBtn.addEventListener('click', ()=>{
        if(hasSubmitted) return;
        hasSubmitted = true;
        finishBtn.disabled = true;
        finishBtn.classList.add('opacity-60','pointer-events-none');
        collectAndGradeAnswers();
      }, { once:true });
    }

    function changeStep(step){
      document.querySelector(`.quiz-step[data-step="${currentStep}"]`).style.display='none';
      document.querySelector(`.quiz-step[data-step="${step}"]`).style.display='block';
      currentStep=step; updateNavigation(); window.scrollTo(0,0);
    }
    function updateNavigation(){
      const prevBtn=document.getElementById('prev-btn');
      const nextBtn=document.getElementById('next-btn');
      const finishBtn=document.getElementById('finish-btn');
      const stepIndicator=document.getElementById('step-indicator');
      prevBtn.disabled=(currentStep===1);
      nextBtn.style.display=currentStep===totalSteps?'none':'inline-block';
      finishBtn.style.display=currentStep===totalSteps?'inline-block':'none';
      stepIndicator.textContent=`Ã‰tape ${currentStep} / ${totalSteps}`;
    }

    // --- Audio (TTS) ---
    const ttsBusy=new Set();
    async function playAudio(text,btn,qid=null){
      if(ttsBusy.has(btn)) return; ttsBusy.add(btn);
      const icon=btn.querySelector('i');
      icon.classList.remove('fa-play'); icon.classList.add('fa-spinner','fa-spin'); btn.disabled=true;
      if(qid){ ensureStat(qid); stats[qid].listens++; }
      try{
        const res=await fetch('/.netlify/functions/generate-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        if(res.ok){ const data=await res.json();
          if(data.audioData){ const audio=new Audio(`data:${data.mimeType};base64,${data.audioData}`);
            audio.onended=()=>resetAudioBtn(icon,btn);
            audio.onerror=()=>fallbackSpeechSynthesis(text,icon,btn);
            audio.play(); ttsBusy.delete(btn); return; } }
        fallbackSpeechSynthesis(text,icon,btn);
      }catch(e){ console.error(e); fallbackSpeechSynthesis(text,icon,btn); }
      finally{ ttsBusy.delete(btn); }
    }
    function resetAudioBtn(icon,btn){ icon.classList.remove('fa-spinner','fa-spin'); icon.classList.add('fa-play'); btn.disabled=false; }
    function fallbackSpeechSynthesis(text,icon,btn){
      try{ if('speechSynthesis'in window){ const u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; u.onend=()=>resetAudioBtn(icon,btn); speechSynthesis.speak(u); }
      else throw new Error('no synth'); }
      catch{ icon.classList.remove('fa-spinner','fa-spin'); icon.classList.add('fa-exclamation-circle'); btn.disabled=false; alert("La synthÃ¨se vocale n'est pas disponible sur votre navigateur."); }
    }

    // --- Recording ---
    function toggleRecording(id){ if(isRecording) stopRecording(id); else startRecording(id); }
    async function startRecording(id){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        recorder=new MediaRecorder(stream,{mimeType:'audio/webm'}); const chunks=[]; recordStartAt=performance.now();
        recorder.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
        recorder.onstop=()=>{
          const duration=Math.max(1,Math.round((performance.now()-recordStartAt)/1000));
          const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob);
          const audio=document.getElementById(`${id}-audio-playback`); audio.src=url; audio.classList.remove('hidden');
          const reader=new FileReader(); reader.onloadend=()=>{
            const [header,base64]=String(reader.result).split(','); const mime=(header.match(/data:(.*?);base64/)||[])[1]||'audio/webm';
            recordings[id]={base64,mimeType:mime,duration,filename:`${id}.webm`}; URL.revokeObjectURL(url);
          }; reader.readAsDataURL(blob);
          recorder.stream.getTracks().forEach(t=>t.stop());
        };
        recorder.start(); isRecording=true; updateRecordingUI(id,true);
      }catch(e){ console.error(e); alert("Impossible d'accÃ©der au microphone. VÃ©rifiez les autorisations."); }
    }
    function stopRecording(id){ if(recorder&&recorder.state!=="inactive"){ recorder.stop(); isRecording=false; updateRecordingUI(id,false); } }
    function updateRecordingUI(id,on){
      const btn=document.getElementById(`${id}-record-btn`); const st=document.getElementById(`${id}-record-status`); const ic=btn.querySelector('i');
      if(on){ btn.classList.replace('bg-red-500','bg-gray-700'); btn.classList.add('animate-pulse'); ic.classList.replace('fa-microphone','fa-stop'); st.textContent='Enregistrement en cours...'; }
      else { btn.classList.replace('bg-gray-700','bg-red-500'); btn.classList.remove('animate-pulse'); ic.classList.replace('fa-stop','fa-microphone'); st.textContent='Enregistrement terminÃ©.'; }
    }

    // --- Mail (single send guard) ---
    async function sendResultsToServer(payload){
      if(emailSent) return; emailSent=true;
      try{
        const r=await fetch('/.netlify/functions/send-results',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        console.log('RÃ©sultats envoyÃ©s:', await r.json());
      }catch(e){ console.error("Erreur d'envoi des rÃ©sultats:",e); }
    }

    // --- RÃ©sumÃ© list builder ---
    function buildSummaryHTML(items){
      const g={QCM:[],FILL:[],WR:[],LS:[]};
      items.forEach(x=>{ const t=String(x.number).split(' ')[0]; if(g[t]) g[t].push(x); });
      const render=(title,arr)=>!arr.length?'':`
        <div class="mt-6">
          <h3 class="text-lg font-bold text-blue-700 mb-2">${title}</h3>
          <ul class="space-y-2">
            ${arr.map(x=>`<li class="border rounded-md p-3">
              <div class="font-semibold">${x.isCorrect?'âœ…':'âŒ'} ${x.number}</div>
              <div class="text-sm text-gray-700 mt-1">${x.fr||''}</div>
              ${x.ko?`<div class="text-xs text-gray-500 mt-1"><b>RÃ©fÃ©rence:</b> ${x.ko}</div>`:''}
              ${x.userAnswer?`<div class="text-xs text-gray-500"><b>Votre rÃ©ponse:</b> ${x.userAnswer}</div>`:''}
              ${x.selfDictation?`<div class="text-xs text-indigo-600 mt-1"><b>Re-dictÃ©e:</b> ${x.selfDictation}</div>`:''}
            </li>`).join('')}
          </ul>
        </div>`;
      return render('QCM',g.QCM)+render('ComplÃ¨te le mot',g.FILL)+render('Ã‰criture',g.WR)+render('Ã‰coute & DictÃ©e',g.LS);
    }

    // --- Grading & Results ---
    function collectAndGradeAnswers(){
      let score=0,total=0; const out=[];

      // QCM
      quizData.mcq.forEach((q,i)=>{
        const id=`mcq-${i}`;
        const ans=document.querySelector(`input[name="${id}"]:checked`)?.value||'';
        const ok=ans===q.answer; if(ok)score++; total++;
        document.getElementById(`${id}-result`).innerHTML= ok?`<p class="text-green-600 font-bold">Correct ! ğŸ‘ ${q.explanation}</p>`:`<p class="text-red-600 font-bold">Oups... La bonne rÃ©ponse Ã©tait : "${q.answer}"</p><p class="text-gray-600">ğŸ˜… â†’ ${q.explanation}</p>`;
        const s=stats[id]||{listens:0,hint1:0,hint2:0};
        out.push({number:`QCM ${i+1}`,fr:q.question,ko:'',userAnswer:ans,isCorrect:ok,listenCount:s.listens,hint1Count:s.hint1,hint2Count:s.hint2});
      });

      // Fill-in
      quizData.fillIn.forEach((q,i)=>{
        const id=`fill-${i}`; const ans=document.getElementById(`${id}-in`).value.trim();
        const ok=ans===q.answer; if(ok)score++; total++;
        document.getElementById(`${id}-result`).innerHTML= ok?`<p class="text-green-600 font-bold">Parfait !</p>`:`<p class="text-red-600 font-bold">Oups, petit couac ğŸ˜… â†’ La rÃ©ponse correcte est : "${q.answer}"</p>`;
        const koFull=q.sentence.replace('___',q.answer); const s=stats[id]||{listens:0,hint1:0,hint2:0};
        out.push({number:`FILL ${i+1}`,fr:q.translation,ko:koFull,userAnswer:ans,isCorrect:ok,listenCount:s.listens,hint1Count:s.hint1,hint2Count:s.hint2});
      });

      // Writing
      quizData.writing.forEach((q,i)=>{
        const id=`write-${i}`; const ans=document.getElementById(`${id}-in`).value.trim();
        const ok=ans.length>0; if(ok)score++; total++;
        document.getElementById(`${id}-result`).innerHTML=`<p class="text-blue-600">RÃ©ponse suggÃ©rÃ©e : "${q.answer}".</p>`;
        const s=stats[id]||{listens:0,hint1:0,hint2:0};
        out.push({number:`WR ${i+1}`,fr:q.situation,ko:q.answer,userAnswer:ans,isCorrect:ok,listenCount:s.listens,hint1Count:s.hint1,hint2Count:s.hint2});
      });

      // Listening
      quizData.listening.forEach((q,i)=>{
        const id=`listen-${i}`;
        const ans=document.getElementById(`${id}-dictation`).value.trim().replace(/[.?]/g,'');
        const ok=ans===q.ko.replace(/[.?]/g,''); if(ok)score++; total++;
        const res=document.getElementById(`${id}-result`);
        res.innerHTML=(ok?`<p class="text-green-600 font-bold">DictÃ©e parfaite ! ğŸ‘</p>`:`<p class="text-red-600 font-bold">DictÃ©e - Oups... ğŸ˜… â†’ "${q.ko}"</p>`) + `<p class="text-blue-600 mt-1">Traduction : "${q.fr}"</p>`;
        const s=stats[id]||{listens:0,hint1:0,hint2:0}; const rec=recordings[id]; const self=document.getElementById(`${id}-selfdict`).value.trim();
        const item={number:`LS ${i+1}`,fr:q.fr,ko:q.ko,userAnswer:ans,isCorrect:ok,listenCount:s.listens,hint1Count:s.hint1,hint2Count:s.hint2,selfDictation:self};
        if(rec) item.recording=rec; out.push(item);
      });

      displayResults(score,total,out);
    }

    function displayResults(score,total,items){
      // ë‹¨ê³„ë§Œ ìˆ¨ê¸°ê³ , ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.quiz-step').forEach(el=>el.style.display='none');
      document.getElementById('nav-bar').style.display='none';

      const pct= total? Math.round((score/total)*100):0;
      let msg, icon;
      if(pct===100){ msg="Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !"; icon='fa-crown text-yellow-500'; }
      else if(pct>=80){ msg="TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !"; icon='fa-thumbs-up text-green-500'; }
      else if(pct>=60){ msg="Pas mal du tout ! ğŸ˜ Encore un petit effort !"; icon='fa-glasses text-blue-500'; }
      else { msg="Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª"; icon='fa-coffee text-red-500'; }

      const results=document.getElementById('results-section');
      results.innerHTML=`
        <div class="bg-white p-8 rounded-xl shadow-2xl">
          <div class="text-center">
            <i class="fas ${icon} text-6xl mb-4"></i>
            <h2 class="text-3xl font-bold text-blue-800 mb-2">${msg}</h2>
            <p class="text-4xl font-bold text-gray-800">Votre score : ${score} / ${total} (${pct}%)</p>
          </div>
          <div class="mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-2">RÃ©sumÃ© des rÃ©ponses</h3>
            <p class="text-sm text-gray-600 mb-4">âœ… = correct, âŒ = incorrect â€” La re-dictÃ©e n'est pas notÃ©e mais envoyÃ©e au professeur avec l'audio.</p>
            ${buildSummaryHTML(items)}
          </div>
          <div class="mt-10 text-center">
            <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105">
              <i class="fas fa-redo-alt mr-2"></i> Recommencer
            </button>
          </div>
        </div>`;
      results.style.display='block';
      results.scrollIntoView({behavior:'smooth'});

      // ë©”ì¼ ì „ì†¡ (1íšŒ)
      const endTime=new Date().toISOString();
      const totalTimeSeconds=Math.max(1,Math.round((new Date(endTime)-new Date(sessionMeta.startTime))/1000));
      sendResultsToServer({
        studentName: document.getElementById('studentName').value.trim() || 'Ã‰lÃ¨ve',
        startTime: sessionMeta.startTime,
        endTime,
        totalTimeSeconds,
        questions: items
      });
    }
  </script>
</body>
</html>
