<script>
  // ---- 전역 상태 (기존 let currentStep 등과 같은 레벨에 추가) ----
  const ttsBusy = new Set();       // 같은 문장/버튼 중복 재생 방지
  const listenStats = {};          // { [questionId]: { listenCount, hint1Count, hint2Count } }
  const recordings = {};           // { [questionId]: { base64, mimeType, duration, filename } }

  // questionId 초기화 함수 (listening 카드 생성 직후 호출되도록 populateListening()에서 보장됨)
  function ensureListenStat(questionId) {
    if (!listenStats[questionId]) {
      listenStats[questionId] = { listenCount: 0, hint1Count: 0, hint2Count: 0 };
    }
  }

  // --- Audio Functions (교체) ---
  async function playAudio(text, button, questionId = null) {
    // 버튼 UI 잠금
    if (ttsBusy.has(button)) return;
    ttsBusy.add(button);

    const icon = button.querySelector('i');
    icon.classList.remove('fa-play');
    icon.classList.add('fa-spinner', 'fa-spin');
    button.disabled = true;

    // 통계(청취 횟수) 증가
    if (questionId) {
      ensureListenStat(questionId);
      listenStats[questionId].listenCount++;
    }

    try {
      // 우선 Google TTS 시도
      const res = await fetch('/.netlify/functions/generate-audio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (res.ok) {
        const data = await res.json();
        if (data.audioData) {
          const audio = new Audio(`data:${data.mimeType};base64,${data.audioData}`);
          audio.onended = () => {
            icon.classList.remove('fa-spinner', 'fa-spin');
            icon.classList.add('fa-play');
            button.disabled = false;
            ttsBusy.delete(button);
          };
          audio.onerror = () => {
            fallbackSpeechSynthesis(text, icon, button);
            ttsBusy.delete(button);
          };
          audio.play();
          return;
        }
      }

      // 실패 시 브라우저 TTS 백업
      fallbackSpeechSynthesis(text, icon, button);
    } catch (error) {
      console.error("Audio playback error:", error);
      fallbackSpeechSynthesis(text, icon, button);
    } finally {
      ttsBusy.delete(button);
    }
  }

  function fallbackSpeechSynthesis(text, icon, button) {
    try {
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ko-KR';
        utter.onend = () => {
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-play');
          button.disabled = false;
        };
        speechSynthesis.speak(utter);
      } else {
        throw new Error('Speech Synthesis not supported.');
      }
    } catch {
      alert("음성 재생을 사용할 수 없습니다.");
      icon.classList.remove('fa-spinner', 'fa-spin');
      icon.classList.add('fa-exclamation-circle');
      button.disabled = false;
    }
  }

  // 힌트 토글(횟수 누적 포함) — 기존 toggleHint 대체
  function toggleHint(hintId, button) {
    const el = document.getElementById(hintId);
    el.classList.toggle('hidden');

    // hintId 규칙: `${questionId}-hint1` / `${questionId}-hint2`
    const [questionId, type] = hintId.split('-hint');
    ensureListenStat(questionId);
    if (type === '1') listenStats[questionId].hint1Count++;
    if (type === '2') listenStats[questionId].hint2Count++;
  }
</script>
