<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice Coréen – Intro + Méthode 5×5</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- (선택) 공용 스타일 -->
  <link rel="stylesheet" href="../assets/style.css"/>

  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 15px -8px rgba(0,0,0,.08);padding:20px}
    .kicker{color:#64748b;letter-spacing:.02em}

    /* 설명 가독성 */
    .readable { line-height: 1.9; }
    .readable p { margin:.85rem 0; }
    .soft-divider { height:1px;margin:1.2rem 0;background:linear-gradient(to right, transparent, #e5e7eb, transparent); }

    /* 버튼들 */
    .btn{padding:.65rem 1rem;border-radius:.65rem;font-weight:600;transition:all .2s;border:none;cursor:pointer}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .playing{background:#059669 !important}

    /* 스피드 칩 */
    .speed-chip{font-size:.9rem;border:1px solid #e5e7eb;background:#f8fafc;border-radius:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:.4rem}
    .speed-chip .dot{width:7px;height:7px;border-radius:50%;background:#94a3b8}
    .speed-chip b{font-weight:700}

    /* pronun 박스 */
    .pronun-box{border:1px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:12px}
    .pronun-box h5{font-size:.95rem;margin-bottom:.35rem;color:#1f2937}

    /* 하단 메이드바이(고정 한 곳) */
    .madeby{position:fixed;right:14px;bottom:12px;font-size:.85rem;color:#94a3b8}
  </style>
</head>
<body class="bg-gray-50">

  <div class="wrap space-y-6">
    <!-- 헤더 -->
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight">
        Exercice : Les Nombres Coréens 🔢
      </h1>
      <p class="kicker mt-1">순수 한국어 / Natifs vs 한자어 / Hanja-coréens</p>
    </header>

    <!-- 간단 설명 -->
    <section class="card readable">
      <h2 class="text-xl font-bold text-slate-900">📘 Pourquoi deux systèmes ? / 왜 두 가지 숫자?</h2>
      <p><b>한자(Hanja)</b>는 <u>글자(문자 체계)</u>, <b>chinois</b>는 <u>언어</u>예요. 한국어 숫자는 <b>순수 한국어(하나, 둘…)</b>와 <b>한자어(일, 이…)</b>를 모두 써요.</p>
      <ul class="list-disc list-inside">
        <li><b>Natifs</b> → 눈앞에서 세는 것(나이, 사람 수, 사물 개수 등)</li>
        <li><b>Hanja-coréens</b> → 달력·시계·돈처럼 <i>이미 정해져 적힌</i> 단위/값(날짜, 분·초, 금액, 호수 등)</li>
      </ul>
      <div class="soft-divider"></div>
      <p>⏱️ 예외: <b>Heures(시)</b>는 <b>natifs</b>, <b>Minutes(분)</b>은 <b>Hanja-coréens</b>를 주로 씁니다.</p>
    </section>

    <!-- Méthode 5×5 워밍업 -->
    <section id="warmup" class="card">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-bold text-slate-900">Méthode 5×5 🗣️ / 5개씩 훈련법</h2>
          <p class="text-slate-600">Écouter → Répéter → <b>Enregistrer & Évaluer</b> / 듣고 따라 말한 뒤 <b>녹음·평가</b></p>
        </div>
        <div class="text-sm text-slate-500">
          <span class="font-semibold">Quand vous voulez</span> / 필요할 때 언제든 듣기
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-5">
        <!-- 4개의 기본 구간이 JS에서 렌더링됩니다 -->
        <div id="set-1" class="space-y-3"></div>
        <div id="set-2" class="space-y-3"></div>
        <div id="set-3" class="space-y-3"></div>
        <div id="set-4" class="space-y-3"></div>
      </div>

      <div class="mt-5 text-xs text-slate-500">
        ※ 각 칸은 <b>0.7× → 1.0× → 1.2× → 1.5× → 1.5×(쉼표 제거)</b> 순서로 <u>듣고 → 녹음 → 발음평가</u>를 연습합니다.
      </div>
    </section>
  </div>

  <!-- 깔끔한 표기: 한 곳만 -->
  <div class="madeby">made by 성일, Pongdang · Lapeace29@gmail.com</div>

  <!-- 전역 설정 -->
  <script>
    window.PONGDANG_TTS   = window.PONGDANG_TTS   || { provider:'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
  </script>

  <!-- 유틸 & 발음 평가 클라이언트 & 이름 게이트 -->
  <script src="../assets/student-gate.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    /* ====== 재생 공통 ====== */
    let currentAudio = null, currentBlobUrl = null, currentFetchAbort = null;
    let audioClickLocked = false, isPlayingOrFetching = false;
    let currentAudioMeta = { text:null, voice:null, speed:1 };
    let currentPlayBtn = null;

    function base64ToBlob(base64, mime='audio/mp3'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    function cleanupAudio(){
      try{ currentAudio?.pause(); }catch(_){}
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
      currentAudio=null; currentPlayBtn=null;
    }
    function btnToPlaying(btn, playing){
      if(!btn) return;
      if(playing){
        btn.classList.add('playing');
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause (일시정지)';
      }else{
        btn.classList.remove('playing');
        btn.innerHTML = '<i class="fas fa-play"></i> Écouter (듣기)';
      }
    }
    function safeAttr(s){ return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/\n/g," "); }

    async function playKo(text, btn, { speed=1.0, voice='alloy' } = {}){
      if(audioClickLocked || isPlayingOrFetching){
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.speed===speed){
          try{
            if(!currentAudio.paused){ currentAudio.pause(); btnToPlaying(btn,false); }
            else { await currentAudio.play(); btnToPlaying(btn,true); }
          }catch(_){}
        }
        return;
      }
      audioClickLocked = true; setTimeout(()=>audioClickLocked=false, 220);

      try{
        // 동일 컨텐츠 → 토글
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.speed===speed){
          if(!currentAudio.paused){ currentAudio.pause(); btnToPlaying(btn,false); }
          else { await currentAudio.play(); btnToPlaying(btn,true); }
          return;
        }

        isPlayingOrFetching = true;
        if(currentFetchAbort){ try{ currentFetchAbort.abort(); }catch(_){ } }
        if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } }

        const ac = new AbortController();
        currentFetchAbort = ac;

        const payload = { text, voice, speed };
        const res = await fetch(`${FN_BASE}/generate-audio`,{
          method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body:JSON.stringify(payload), signal: ac.signal
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(`generate-audio fail: ${res.status} ${t}`);
        }
        const data = await res.json();
        let srcUrl = null;
        if(data.audioBase64 || data.audioContent){
          const blob = base64ToBlob(data.audioBase64 || data.audioContent, data.mimeType||'audio/mpeg');
          srcUrl = URL.createObjectURL(blob); currentBlobUrl = srcUrl;
        }else if(data.audioUrl){ srcUrl = data.audioUrl; }
        else { throw new Error('Invalid TTS response'); }

        const audio = new Audio(srcUrl);
        currentAudio = audio;
        currentAudioMeta = { text, voice, speed };
        currentPlayBtn = btn;

        audio.addEventListener('playing', ()=> btnToPlaying(btn,true));
        audio.addEventListener('pause',   ()=> btnToPlaying(btn,false));
        audio.addEventListener('ended',   ()=> btnToPlaying(btn,false));
        audio.addEventListener('error',   ()=> btnToPlaying(btn,false));

        await audio.play();
      }catch(e){
        console.error(e);
        alert('오디오 재생 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
      }finally{
        isPlayingOrFetching = false;
      }
    }

    /* ====== 5×5 데이터 ====== */
    const SETS = [
      { mountId:'set-1', title:'순수 한국어 / Natifs (1–5)', phrase:'하나, 둘, 셋, 넷, 다섯', voice:'alloy' },
      { mountId:'set-2', title:'순수 한국어 / Natifs (6–10)', phrase:'여섯, 일곱, 여덟, 아홉, 열', voice:'shimmer' },
      { mountId:'set-3', title:'한자어 / Hanja-coréens (1–5)', phrase:'일, 이, 삼, 사, 오', voice:'alloy' },
      { mountId:'set-4', title:'한자어 / Hanja-coréens (6–10)', phrase:'육, 칠, 팔, 구, 십', voice:'alloy' }
    ];
    const SPEED_STEPS = [
      { label:'0.7×', speed:0.7, strip:false },
      { label:'1.0×', speed:1.0, strip:false },
      { label:'1.2×', speed:1.2, strip:false },
      { label:'1.5×', speed:1.5, strip:false },
      { label:'1.5× (sans virgules / 쉼표 없음)', speed:1.5, strip:true }
    ];

    function stripCommasKo(s){ return s.replaceAll(',', ''); }

    function renderSet(container, meta){
      const block = document.createElement('div');
      block.className = 'p-4 rounded-xl border border-slate-200 bg-white/90 shadow-sm';
      block.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold text-slate-700">${meta.title}</div>
            <div class="text-slate-500 text-sm korean-font">${meta.phrase}</div>
          </div>
          <div class="hidden md:block text-xs text-slate-500">Écouter → Répéter → <b>Enregistrer & Évaluer</b></div>
        </div>
        <div class="mt-3 grid md:grid-cols-2 gap-3" data-steps></div>
      `;
      container.appendChild(block);

      const stepsWrap = block.querySelector('[data-steps]');
      SPEED_STEPS.forEach((st, idx) => {
        const refText = st.strip ? stripCommasKo(meta.phrase) : meta.phrase;
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-slate-200 p-3 bg-slate-50';
        card.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="speed-chip"><span class="dot"></span> <b>${st.label}</b></div>
            <button class="btn btn-sound btn-play"><i class="fas fa-play"></i> Écouter (듣기)</button>
          </div>
          <div class="mt-2 pronun-box">
            <h5>🎤 Enregistrer & évaluer / 녹음·발음 평가</h5>
            <div class="text-xs text-slate-500 mb-1">Référez-vous à&nbsp;<span class="korean-font font-semibold">${refText}</span></div>
            <div class="pronun-mount"></div>
          </div>
        `;
        stepsWrap.appendChild(card);

        // Play 버튼 동작
        const playBtn = card.querySelector('.btn-play');
        playBtn.addEventListener('click', () => {
          playKo(refText, playBtn, { speed: st.speed, voice: meta.voice || 'alloy' });
        });

        // 발음 평가 mount
        const mount = card.querySelector('.pronun-mount');
        if (window.Pronun && mount){
          try{
            Pronun.mount(mount, {
              getReferenceText: () => refText,
              onResult: (r) => {
                // 필요 시 후처리 가능. (r.score, r.detail 등)
                // console.log('Pronun result', r);
              }
            });
          }catch(e){
            console.warn('Pronun.mount error', e);
          }
        }
      });
    }

    /* ====== 부트스트랩 ====== */
    document.addEventListener('DOMContentLoaded', () => {
      // 이름 입력 가드(최초 한 번)
      if (window.StudentGate) {
        StudentGate.init();
        StudentGate.requireBeforeInteraction(document);
      }

      // 세트 렌더
      SETS.forEach((s) => {
        const host = document.getElementById(s.mountId);
        if (host) renderSet(host, s);
      });
    });
  </script>
</body>
</html>
