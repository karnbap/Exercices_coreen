<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CorÃ©en â€” Nombres | Explications + Warming up</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Optional shared styles -->
  <link rel="stylesheet" href="../assets/style.css">

  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif; background:#f3f4f6;}
    .shell{max-width:1000px;margin:0 auto;padding:24px}
    .info-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;box-shadow:0 1px 2px rgba(16,24,40,.06)}
    .kicker{color:#64748b}
    .soft-divider{height:1px;margin:18px 0;background:linear-gradient(to right,transparent,#e5e7eb,transparent)}
    .btn{padding:.72rem 1.1rem;border-radius:.7rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-ghost{background:#e5e7eb;color:#374151}.btn-ghost:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .btn-next{background:#111827;color:#fff}.btn-next[disabled]{opacity:.5;cursor:not-allowed}
    .step-pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #e5e7eb;background:#fff;border-radius:9999px;padding:4px 10px;font-size:.85rem}
    .warm-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:16px}
    .warm-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .warm-title{font-weight:700;color:#111827}
    .warm-sub{color:#6b7280}
    .step-box{border:1px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:12px;margin-top:12px}
    .result-chip{display:inline-flex;align-items:center;gap:6px;background:#ecfccb;color:#365314;border:1px solid #d9f99d;border-radius:9999px;padding:4px 10px;font-weight:600}
    .warn-chip{display:inline-flex;align-items:center;gap:6px;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:9999px;padding:4px 10px;font-weight:600}
    .brand-tag{position:fixed;right:16px;bottom:12px;font-size:12px;color:#9ca3af}
    .tiny{font-size:.82rem;color:#6b7280}
  </style>
</head>
<body>

  <!-- ======= Intro / Explications ======= -->
  <header class="shell">
    <div class="text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-2 leading-tight">Exercice : Les Nombres CorÃ©ens ğŸ”¢</h1>
      <p class="kicker mb-6">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanja-corÃ©ens</p>
    </div>

    <div class="grid md:grid-cols-2 gap-5">
      <div class="info-card">
        <h3 class="font-bold text-lg mb-2">1ï¸âƒ£ Petite explication / ê°„ë‹¨ ì„¤ëª…</h3>
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 text-yellow-900">
          ğŸ‘‰ Â« í•œì = chinois(ì–¸ì–´) Â»ê°€ ì•„ë‹ˆì—ìš”! Hanja = <b>ë¬¸ì ì²´ê³„</b>, Chinois = <b>ì–¸ì–´</b>.
        </div>
        <ul class="list-disc list-inside mt-3 space-y-1.5">
          <li><b>í•œì (Hanja)</b> = systÃ¨me dâ€™Ã©criture</li>
          <li><b>Chinois</b> = langue</li>
        </ul>
      </div>

      <div class="info-card">
        <h3 class="font-bold text-lg mb-2">2ï¸âƒ£ Deux systÃ¨mes / ë‘ ê°€ì§€ ìˆ«ì</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
            <div class="font-semibold text-blue-900">Natifs</div>
            <div class="text-xl font-bold">í•˜ë‚˜, ë‘˜, ì…‹â€¦</div>
            <div class="tiny">Ã‚ge, personnes, objetsâ€¦</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50 border border-green-200">
            <div class="font-semibold text-green-900">Hanja-corÃ©ens</div>
            <div class="text-xl font-bold">ì¼, ì´, ì‚¼â€¦</div>
            <div class="tiny">Dates, argent, minutesâ€¦</div>
          </div>
        </div>
      </div>

      <div class="info-card md:col-span-2">
        <h3 class="font-bold text-lg mb-2">âš¡ Exception & Tendance</h3>
        <ul class="list-disc list-inside space-y-1.5">
          <li>Heures(ì‹œ) â†’ <b>natifs</b> Â· Minutes(ë¶„) â†’ <b>Hanja-corÃ©ens</b></li>
          <li>Â« 1 h = 60 min Â» ì²´ê³„ ì´í›„ : ì‹œ=natifs / ë¶„=Hanja</li>
        </ul>
      </div>

      <div class="info-card md:col-span-2">
        <h3 class="font-bold text-lg mb-2">âœ… RÃ©sumÃ© / ìš”ì•½</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse text-sm">
            <thead>
              <tr class="bg-slate-50">
                <th class="border border-slate-200 p-2">SystÃ¨me / ì²´ê³„</th>
                <th class="border border-slate-200 p-2">Usage / ìš©ë„</th>
                <th class="border border-slate-200 p-2">Exemples / ì˜ˆ</th>
              </tr>
            </thead>
            <tbody>
              <tr class="odd:bg-white even:bg-gray-50">
                <td class="border border-slate-200 p-2 font-semibold">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</td>
                <td class="border border-slate-200 p-2">Compter librement, classificateurs, durÃ©es libres</td>
                <td class="border border-slate-200 p-2">í•œ ë‹¬, ë‘ ë‹¬ / í•œ ê°œ, ë‘ ëª…, ì„¸ ì”, í•œ ê¶Œ / í•œ ì‹œ, ë‘ ì‹œ</td>
              </tr>
              <tr class="odd:bg-white even:bg-gray-50">
                <td class="border border-slate-200 p-2 font-semibold">í•œìì–´ / Hanja-corÃ©ens</td>
                <td class="border border-slate-200 p-2">Valeurs Â« Ã©crites Â» (calendrier, montre, monnaieâ€¦)</td>
                <td class="border border-slate-200 p-2">1ì›”, 2ì›” / 10ë¶„, 30ì´ˆ / 2025ë…„ 9ì›” 7ì¼, 1,000ì› / 3ì¸µ, 302í˜¸</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="soft-divider"></div>
  </header>

  <!-- ======= WARMING UP: MÃ©thode 5Ã—5 ======= -->
  <main class="shell">
    <div class="text-center mb-6">
      <h2 class="text-3xl font-bold text-slate-800 mb-2">MÃ©thode 5Ã—5 ğŸ—£ï¸ / 5ê°œì”© í›ˆë ¨ë²•</h2>
      <p class="text-lg text-slate-600">Ã‰couter â†’ RÃ©pÃ©ter â†’ <b>Enregistrer & Ã‰valuer</b> / ë“£ê³  ë”°ë¼ ë§í•œ ë’¤ <b>ë…¹ìŒÂ·í‰ê°€</b></p>
      <div class="tiny mt-2">Chaque item avance par Ã©tapes de vitesse: <b>0.7Ã— â†’ 1.0Ã— â†’ 1.2Ã— â†’ 1.5Ã— â†’ 1.5Ã— (sans virgules)</b></div>
    </div>

    <!-- Cards (ì„¸ë¡œë¡œ í•˜ë‚˜ì”©) -->
    <div id="warmup-list"></div>

    <!-- Finish -->
    <div class="text-center mt-8">
      <button id="finish-btn" class="btn btn-primary text-lg" disabled>âœ… Terminer lâ€™Ã©chauffement / ì™„ë£Œí•˜ê¸°</button>
      <div id="finish-note" class="tiny mt-2 text-red-700">ëª¨ë“  í•­ëª©ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ê¹Œì§€ â€œë‚´ ë°œìŒ í™•ì¸í•˜ê¸°â€ë¥¼ í•´ì•¼ ì™„ë£Œí•  ìˆ˜ ìˆì–´ìš”.</div>
    </div>

    <!-- ê²°ê³¼ ëª¨ë‹¬/ì˜ì—­ -->
    <div id="summary-panel" class="hidden mt-8">
      <div class="info-card">
        <h3 class="font-bold text-xl mb-2">Bilan de lâ€™Ã©chauffement / ì›œì—… ê²°ê³¼</h3>
        <div id="summary-body" class="space-y-2 text-sm"></div>
        <div class="flex gap-2 mt-4">
          <a href="./numbers-exercises.html" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Passer aux exercices (ì—°ìŠµë¬¸ì œ ì‹œì‘)</a>
          <button class="btn btn-ghost" onclick="document.getElementById('summary-panel').classList.add('hidden')">Fermer</button>
        </div>
      </div>
    </div>
  </main>

  <div class="brand-tag">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- Global config -->
  <script>
    window.PONGDANG_TTS   = window.PONGDANG_TTS   || { provider: 'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
    window.PRONUN_OPTIONS = { hideTranscript: true, hideNumericSwap: true }; // â€˜ì „ì‚¬â€™ ë“± ë¬¸êµ¬ ìˆ¨ê¹€ ì˜µì…˜ íŒíŠ¸
  </script>

  <!-- Pronunciation client (VU íŒŒí˜•/í‰ê°€) -->
  <script src="../assets/pronun-utils.js"></script>
  <script src="../assets/pronun-vowel-middleware.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    /* ========= Data ========= */
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    const ITEMS = [
      { id:'wu1', title:'Natifs (1â€“5)',   sub:'í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯', voice:'alloy',  text:'í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯' },
      { id:'wu2', title:'Natifs (6â€“10)',  sub:'ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´', voice:'shimmer', text:'ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´' },
      { id:'wu3', title:'Hanja (1â€“5)',   sub:'ì¼, ì´, ì‚¼, ì‚¬, ì˜¤', voice:'alloy', text:'ì¼, ì´, ì‚¼, ì‚¬, ì˜¤' },
      { id:'wu4', title:'Hanja (6â€“10)',  sub:'ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­', voice:'alloy', text:'ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­' },
    ];

    const TRAIN_STEPS = [
      { key:'s0', label:'0.7Ã—', speed:0.7, strip:false, desc:'Ã‰couter (0.7Ã—) â†’ RÃ©pÃ©ter â†’ Enregistrer' },
      { key:'s1', label:'1.0Ã—', speed:1.0, strip:false, desc:'Ã‰couter (1.0Ã—) â†’ RÃ©pÃ©ter â†’ Enregistrer' },
      { key:'s2', label:'1.2Ã—', speed:1.2, strip:false, desc:'Ã‰couter (1.2Ã—) â†’ RÃ©pÃ©ter â†’ Enregistrer' },
      { key:'s3', label:'1.5Ã—', speed:1.5, strip:false, desc:'Ã‰couter (1.5Ã—) â†’ RÃ©pÃ©ter â†’ Enregistrer' },
      { key:'s4', label:'1.5Ã—, sans virgules', speed:1.5, strip:true,  desc:'Ã‰couter (1.5Ã—, sans virgules) â†’ RÃ©pÃ©ter â†’ Enregistrer' },
    ];

    // ìƒíƒœ: ê° ì•„ì´í…œë³„ í˜„ì¬ step index ë° step ê²°ê³¼
    const warmupState = ITEMS.map(item => ({
      id: item.id,
      stepIndex: 0,
      steps: TRAIN_STEPS.map(() => ({ result:null, verified:false, percent:null })),
    }));

    /* ========= Audio (TTS) ========= */
    const VOICE_MAP = {
      openai: { default: "alloy", alloy: "alloy", shimmer: "verse" },
      google: { default: "ko-KR-Standard-A", alloy: "ko-KR-Standard-A", shimmer: "ko-KR-Standard-B" }
    };
    const mapVoice=(p,v)=> (VOICE_MAP[p]||{})[v] || (VOICE_MAP[p]||{}).default || v;
    let currentAudio=null, currentBlobUrl=null, currentFetchAbort=null, audioBusy=false;

    function base64ToBlob(b64,mime='audio/mpeg'){
      const c=b64.includes(',')?b64.split(',')[1]:b64;
      const s=atob(c); const a=new Uint8Array(s.length);
      for(let i=0;i<s.length;i++) a[i]=s.charCodeAt(i);
      return new Blob([a],{type:mime});
    }
    function cleanupAudio(){
      if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } currentAudio=null; }
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
    }
    function removeCommas(txt){ return String(txt).replace(/,\s*/g,' '); }

    async function playTTS(text, voice, speed, btn){
      if(audioBusy){ if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } } return; }
      audioBusy=true;
      btn && (btn.disabled = true);
      try{
        cleanupAudio();
        currentFetchAbort?.abort?.();
        const ac=new AbortController(); currentFetchAbort=ac;

        const provider=(window.PONGDANG_TTS?.provider)||'openai';
        const payload={ text, voice: mapVoice(provider,voice), provider, speed };
        const res=await fetch(`${FN_BASE}/generate-audio`,{
          method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body:JSON.stringify(payload), signal:ac.signal
        });
        if(!res.ok){ throw new Error('TTS '+res.status); }
        const data=await res.json();

        let src=null;
        if(data.audioBase64||data.audioContent){
          const blob=base64ToBlob(data.audioBase64||data.audioContent,data.mimeType||'audio/mpeg');
          src=URL.createObjectURL(blob); currentBlobUrl=src;
        }else if(data.audioUrl){ src=data.audioUrl; }

        const audio=new Audio(src); currentAudio=audio;
        await audio.play();
        audio.addEventListener('ended', ()=>{ btn && (btn.disabled=false); });
      }catch(e){
        alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        btn && (btn.disabled=false);
      }finally{
        audioBusy=false;
      }
    }

    /* ========= Pronun UI mount & helpers ========= */
    function scrubPronun(container){
      if(!container) return;
      const killWords=['ì „ì‚¬','transcription','transcrit'];
      const sweep=()=>{
        container.querySelectorAll('*').forEach(n=>{
          n.childNodes?.forEach?.(c=>{
            if(c.nodeType===3 && killWords.some(k=>c.textContent?.toLowerCase().includes(k))){
              c.textContent='';
            }
          });
        });
      };
      sweep();
      new MutationObserver(sweep).observe(container,{childList:true,subtree:true});
    }

    function extractPercent(result){
      // pronun-client ê²°ê³¼ì—ì„œ í¼ì„¼íŠ¸ ì¶”ì •
      const cand = (
        result?.score?.overall ??
        result?.overall ??
        result?.accuracy ??
        result?.similarity ??
        result?.score
      );
      if(typeof cand === 'number'){
        if(cand<=1) return Math.round(cand*100);
        if(cand<=100) return Math.round(cand);
      }
      // ëª» ì°¾ìœ¼ë©´ 100ì€ ê³¼í•˜ê³  0ì€ í—ˆë¬´í•˜ë‹ˆ 80ìœ¼ë¡œ ë³´ìˆ˜ì  í‘œê¸°
      return 80;
    }

    /* ========= Render ========= */
    function renderWarmup(){
      const host = document.getElementById('warmup-list');
      host.innerHTML = '';

      ITEMS.forEach((item, idx)=>{
        const st = warmupState[idx];
        const stepIdx = st.stepIndex;
        const step = TRAIN_STEPS[stepIdx];

        const card = document.createElement('section');
        card.className = 'warm-card';

        const header = document.createElement('div');
        header.className = 'warm-head';
        header.innerHTML = `
          <div>
            <div class="warm-title">${item.title}</div>
            <div class="warm-sub tiny">${item.sub}</div>
          </div>
          <div class="step-pill"><i class="fas fa-bolt"></i> Ã‰tape ${stepIdx+1}/5 Â· ${step.label}</div>
        `;
        card.appendChild(header);

        // Step box
        const box = document.createElement('div');
        box.className = 'step-box';
        const displayText = step.strip ? removeCommas(item.text) : item.text;

        box.innerHTML = `
          <div class="mb-2 text-sm text-slate-700">
            <b>${step.label}</b> â€” ${step.desc}<br>
            <span class="tiny">FR: Appuie sur â€œÃ‰couterâ€, rÃ©pÃ¨te Ã  voix haute, puis enregistre et <b>clique â€œVÃ©rifier ma prononciationâ€</b>.<br>
            KR: â€œë“£ê¸°â€ â†’ ë”°ë¼ ë§í•˜ê¸° â†’ <b>ë…¹ìŒ</b> â†’ <b>ë‚´ ë°œìŒ í™•ì¸í•˜ê¸°</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”.</span>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <button class="btn btn-sound" id="${item.id}-listen"><i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)</button>
            <span class="tiny text-slate-500">Texte KO: <b>${displayText}</b></span>
          </div>

          <!-- Pronun mount -->
          <div id="${item.id}-mount" class="mt-2"></div>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <button class="btn btn-ghost" id="${item.id}-check"><i class="fas fa-check-circle"></i> VÃ©rifier ma prononciation / ë‚´ ë°œìŒ í™•ì¸í•˜ê¸°</button>
            <span id="${item.id}-score" class="tiny"></span>
          </div>

          <div class="mt-3">
            <button class="btn btn-next" id="${item.id}-next" disabled>Ã‰tape suivante (ë‹¤ìŒ ì†ë„)</button>
          </div>
        `;
        card.appendChild(box);

        // Past steps chips
        const doneWrap = document.createElement('div');
        doneWrap.className = 'mt-3 flex flex-wrap gap-2';
        st.steps.forEach((s, i)=>{
          if(i<stepIdx){
            const chip = document.createElement('span');
            chip.className = 'result-chip';
            const lab = TRAIN_STEPS[i]?.label || `v${i}`;
            chip.innerHTML = `<i class="fas fa-check"></i> ${lab}: ${s.percent ?? '--'}%`;
            doneWrap.appendChild(chip);
          }
        });
        if(doneWrap.childNodes.length) card.appendChild(doneWrap);

        host.appendChild(card);

        // Wire buttons
        document.getElementById(`${item.id}-listen`).onclick = (e)=> playTTS(displayText, item.voice, step.speed, e.currentTarget);

        // Mount Pronun UI (VU graph ë‚´ì¥)
        const mount = document.getElementById(`${item.id}-mount`);
        if(mount && window.Pronun){
          try{
            Pronun.mount(mount, {
              getReferenceText: () => displayText,
              isKoCorrect: () => true,
              onResult: (r) => {
                // ìµœì‹  ê²°ê³¼ ì €ì¥ë§Œ í•˜ê³ , 'í™•ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ê²€ì¦ ì™„ë£Œë¡œ ì²˜ë¦¬
                st.steps[stepIdx].result = r;
                scrubPronun(mount);
              }
            });
            scrubPronun(mount);
          }catch(e){ console.warn('Pronun.mount error', e); }
        }

        // Verify button
        document.getElementById(`${item.id}-check`).onclick = ()=>{
          const r = st.steps[stepIdx].result;
          const scoreEl = document.getElementById(`${item.id}-score`);
          if(!r){
            scoreEl.innerHTML = `<span class="warn-chip"><i class="fas fa-triangle-exclamation"></i> Dâ€™abord, enregistre puis ArrÃªter!</span>`;
            return;
          }
          const pct = extractPercent(r);
          st.steps[stepIdx].percent = pct;
          st.steps[stepIdx].verified = true;
          scoreEl.innerHTML = `<span class="result-chip"><i class="fas fa-gauge-high"></i> ${pct}% Â· Bien fait!</span> <span class="tiny text-slate-500">FR/KR: Prononciation Ã©valuÃ©e.</span>`;
          document.getElementById(`${item.id}-next`).disabled = false;
          // â€œì™„ë£Œâ€ ë²„íŠ¼ ì‚¬ìš© ê°€ëŠ¥ì„± ê°±ì‹ 
          updateFinishEnabled();
        };

        // Next step button
        document.getElementById(`${item.id}-next`).onclick = ()=>{
          // í˜„ ë‹¨ê³„ ê²€ì¦ ì²´í¬
          if(!st.steps[stepIdx].verified) return;
          if(st.stepIndex < TRAIN_STEPS.length-1){
            st.stepIndex++;
            renderWarmup();
          }else{
            // ì´ ì•„ì´í…œì€ ì „ë¶€ ì™„ë£Œë¨
            renderWarmup();
          }
        };
      });

      updateFinishEnabled();
    }

    function isAllDone(){
      return warmupState.every(st => st.stepIndex >= TRAIN_STEPS.length-1 && st.steps[TRAIN_STEPS.length-1].verified);
    }
    function updateFinishEnabled(){
      const done = isAllDone();
      const btn = document.getElementById('finish-btn');
      const note = document.getElementById('finish-note');
      btn.disabled = !done;
      note.style.display = done ? 'none' : 'block';
    }

    /* ========= Send results & summary ========= */
    async function sendWarmupResults(){
      const payload = {
        kind: 'warmup-5x5',
        createdAt: new Date().toISOString(),
        items: ITEMS.map((it, idx)=>({
          id: it.id,
          title: it.title,
          text: it.text,
          steps: warmupState[idx].steps.map((s, i)=>({
            label: TRAIN_STEPS[i].label,
            speed: TRAIN_STEPS[i].speed,
            stripped: TRAIN_STEPS[i].strip,
            percent: s.percent,
            verified: s.verified
          }))
        }))
      };
      try{
        const res = await fetch(`${FN_BASE}/send-results`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ studentName: '(warmup)', ...payload })
        });
        if(!res.ok){ throw new Error('send-results '+res.status); }
      }catch(e){
        console.warn('send-results failed', e);
      }
    }

    function showSummary(){
      const box = document.getElementById('summary-body');
      box.innerHTML = '';
      ITEMS.forEach((it, idx)=>{
        const row = document.createElement('div');
        const percents = warmupState[idx].steps.map(s=> s.percent ?? 0);
        const avg = Math.round( percents.reduce((a,b)=>a+b,0) / percents.length );
        const chips = warmupState[idx].steps.map((s,i)=>`<span class="result-chip"><i class="fas fa-check"></i> ${TRAIN_STEPS[i].label}: ${s.percent ?? '--'}%</span>`).join(' ');
        row.innerHTML = `
          <div class="font-semibold mb-1">${it.title} <span class="tiny text-slate-500">(${it.sub})</span></div>
          <div class="tiny mb-1">Moyenne / í‰ê· : <b>${isNaN(avg)?'--':avg}%</b></div>
          <div class="flex flex-wrap gap-2">${chips}</div>
        `;
        box.appendChild(row);
      });
      document.getElementById('summary-panel').classList.remove('hidden');
    }

    /* ========= Init ========= */
    document.addEventListener('DOMContentLoaded', ()=>{
      renderWarmup();

      document.getElementById('finish-btn').onclick = async ()=>{
        if(!isAllDone()) return;
        await sendWarmupResults();
        showSummary();
      };
    });
  </script>
</body>
</html>
