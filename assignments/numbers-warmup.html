<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CorÃ©en â€” Nombres | Explications + Warming up (5Ã—5 multi-vitesse)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;background:#f4f6f8}
    .wrap{max-width:980px;margin:2rem auto;padding:1rem}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 8px 20px rgba(15,23,42,.06)}
    .card-pad{padding:1.25rem 1.25rem}
    .btn{padding:.65rem 1rem;border-radius:.65rem;font-weight:600;border:none;cursor:pointer;transition:.2s}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-ghost{background:#eef2ff;color:#4338ca}.btn-ghost:hover{background:#e0e7ff}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .kicker{color:#64748b;letter-spacing:.02em}
    .soft{line-height:1.9}
    .soft p{margin:.7rem 0}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .stage-head{display:flex;align-items:flex-end;justify-content:space-between;gap:12px}
    .stage-tag{font-size:.85rem;font-weight:700;background:#111827;color:#fff;border-radius:.6rem;padding:.3rem .6rem}
    .stage-help{font-size:.9rem;color:#475569}
    .demo-head{font-weight:700;color:#0f172a}
    .demo-sub{color:#64748b}
    .block{border:1px solid #e5e7eb;border-radius:.85rem;padding:1rem}
    .muted{font-size:.9rem;color:#64748b}
    .score-pill{display:inline-flex;align-items:center;gap:.35rem;background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;border-radius:999px;padding:.25rem .6rem;font-weight:700}
    .brand{position:fixed;right:16px;bottom:12px;font-size:12px;color:#9ca3af}
    .vu{width:100%;height:48px;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:.5rem}
    .ok-badge{background:#dcfce7;border:1px solid #86efac;color:#065f46;padding:.25rem .5rem;border-radius:.5rem;font-weight:700}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:.6rem;padding:.6rem .8rem}
  </style>
</head>
<body>

  <div class="wrap">

    <!-- ===== [A] EXPLICATION â€” ì›ë³¸ë¬¸ì„œ 100% ìœ ì§€ ë³µêµ¬ ===== -->
    <section class="card card-pad soft" id="explanations">
      <header class="text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 leading-tight">Exercice : Les Nombres CorÃ©ens ğŸ”¢</h1>
        <p class="kicker mt-2">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanja-corÃ©ens</p>
      </header>

      <div class="mt-6 grid-2">
        <!-- 1) Petite explication -->
        <div class="block">
          <h3 class="demo-head mb-2">1ï¸âƒ£ Petite explication / ê°„ë‹¨ ì„¤ëª…</h3>
          <p class="warn">ğŸ‘‰ Beaucoup de FranÃ§ais pensent que Â« í•œì = chinois Â». Mais non ! / ë§ì€ í”„ë‘ìŠ¤ì¸ì´ â€˜í•œì = ì¤‘êµ­ì–´(ì–¸ì–´)â€™ë¼ê³  ìƒê°í•˜ì§€ë§Œ ì•„ë‹™ë‹ˆë‹¤!</p>
          <ul class="list-disc list-inside mt-3">
            <li><strong>í•œì (Hanja)</strong> = systÃ¨me dâ€™Ã©criture / ê¸€ì(ë¬¸ì) ì²´ê³„</li>
            <li><strong>Chinois</strong> = langue / ì¤‘êµ­ì–´(ì–¸ì–´)</li>
          </ul>
          <div class="mt-3 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700">
            <p>
              <strong>Astuce (analogie) / ë¹„ìœ </strong> : En Europe, on Ã©crit avec <b>l'alphabet latin</b> (pas Â« alphabet italien Â»).<br>
              â†’ <b>Italien</b> = une <u>langue</u> / <b>lettres</b> = alphabet <u>latin</u>.<br>
              â†’ <b>chinois</b> = une <u>langue</u> / <b>lettres</b> = <u>caractÃ¨res han (Hanja)</u>.<br>
              ğŸ‡°ğŸ‡· <b>Le corÃ©en aussi</b> : <b>langue</b> = corÃ©en / <b>nombres</b> = <u>2 jeux</u> (ìˆœìˆ˜ í•œêµ­ì–´ / natifs, í•œìì–´ / Hanja-corÃ©ens).<br>
              <em>Hanja â‰  chinois (la langue)</em> â†’ Â« <b>caractÃ¨res han</b> Â» = Ã©criture, pas la langue chinoise.
            </p>
          </div>
        </div>

        <!-- 2) Deux systÃ¨mes -->
        <div class="block">
          <h3 class="demo-head mb-2">2ï¸âƒ£ Deux systÃ¨mes / ë‘ ê°€ì§€ ìˆ«ì</h3>
          <p class="mb-2"><strong>ìˆœìˆ˜ í•œêµ­ì–´</strong> (natifs) â†” <strong>í•œìì–´</strong> (Hanja-corÃ©ens)</p>
          <div class="grid-2" style="gap:12px">
            <div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
              <div class="font-semibold text-blue-900">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</div>
              <div class="text-xl font-bold my-1">í•˜ë‚˜, ë‘˜, ì…‹â€¦</div>
              <div class="muted">Ã‚ge, personnes, objetsâ€¦ / ë‚˜ì´, ì‚¬ëŒ ìˆ˜, ì‚¬ë¬¼ ê°œìˆ˜â€¦</div>
            </div>
            <div class="p-3 rounded-lg bg-green-50 border border-green-200">
              <div class="font-semibold text-green-900">í•œìì–´ / Hanja-corÃ©ens</div>
              <div class="text-xl font-bold my-1">ì¼, ì´, ì‚¼â€¦</div>
              <div class="muted">Dates, argent, minutesâ€¦ / ë‚ ì§œ, ëˆ, ë¶„â€¦</div>
            </div>
          </div>
        </div>

        <!-- 3) Exception & Tendance -->
        <div class="block">
          <h3 class="demo-head mb-2">âš¡ Exception & Tendance / ì˜ˆì™¸ì™€ ê²½í–¥</h3>
          <ul class="list-disc list-inside">
            <li>Heures(ì‹œ) â†’ <b>ìˆœìˆ˜ í•œêµ­ì–´ / natifs</b> Â· Minutes(ë¶„) â†’ <b>í•œìì–´ / Hanja-corÃ©ens</b></li>
            <li>Autrefois Â« 1ê° â‰ˆ 15 min Â», puis systÃ¨me moderne <b>1 h = 60 min</b> â†’ aujourdâ€™hui : <b>ì‹œ = natifs</b>, <b>ë¶„ = Hanja</b>. Nouveaux mots â†’ tendance <b>corÃ©en natif</b>.</li>
          </ul>
        </div>

        <!-- 4) RÃ©sumÃ© -->
        <div class="block">
          <h3 class="demo-head mb-2">âœ… RÃ©sumÃ© facile / ìš”ì•½</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse text-sm">
              <thead>
                <tr class="bg-gray-100 text-gray-800">
                  <th class="p-3 border border-slate-200">SystÃ¨me / ì²´ê³„</th>
                  <th class="p-3 border border-slate-200">Usage / ìš©ë„</th>
                  <th class="p-3 border border-slate-200">Exemples / ì˜ˆ</th>
                </tr>
              </thead>
              <tbody>
                <tr class="odd:bg-white even:bg-gray-50">
                  <td class="p-3 border border-slate-200 font-semibold">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</td>
                  <td class="p-3 border border-slate-200">Compter (valeur libre), classificateurs, durÃ©es libres</td>
                  <td class="p-3 border border-slate-200">
                    <span class="font-medium">DurÃ©e (mois)</span> : <b>í•œ ë‹¬, ë‘ ë‹¬</b><br>
                    <span class="font-medium">Classificateurs</span> : <b>í•œ ê°œ, ë‘ ëª…, ì„¸ ì”, í•œ ê¶Œ</b><br>
                    <span class="font-medium">Heures (ì‹œ)</span> : <b>í•œ ì‹œ, ë‘ ì‹œ</b>
                  </td>
                </tr>
                <tr class="odd:bg-white even:bg-gray-50">
                  <td class="p-3 border border-slate-200 font-semibold">í•œìì–´ / Hanja-corÃ©ens</td>
                  <td class="p-3 border border-slate-200">LibellÃ©s/valeurs Â« dÃ©jÃ  Ã©crits Â» (calendrier, montre, monnaie, numÃ©ros)</td>
                  <td class="p-3 border border-slate-200">
                    <span class="font-medium">Mois (calendrier)</span> : <b>1ì›”, 2ì›”, 3ì›”</b><br>
                    <span class="font-medium">Minutes/Secondes</span> : <b>10ë¶„, 30ì´ˆ</b><br>
                    <span class="font-medium">Dates/Argent</span> : <b>2025ë…„ 9ì›” 7ì¼, 1,000ì›</b><br>
                    <span class="font-medium">NumÃ©ros d'appartement</span> : <b>3ì¸µ, 302í˜¸</b>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ul class="mt-2 text-xs text-gray-600 list-disc list-inside leading-relaxed">
            <li><b>Temps</b> : <b>ì‹œ(heures)</b> â†’ natifs / <b>ë¶„Â·ì´ˆ(minutes/secondes)</b> â†’ Hanja.</li>
            <li><b>MÃ©langes</b> : <b>ë‹¬/ê°œì›”</b>(durÃ©es en mois), <b>ì£¼/ì£¼ì¼</b>(semaines) â€” usages coexistent.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ===== [B] WARM-UP â€” 4ê°œ ë¬¶ìŒ â†’ ëª¨ë‘ ëë‚´ë©´ ë‹¤ìŒ ì†ë„ ë‹¨ê³„ ===== -->
    <section class="card card-pad mt-6" id="warmup">
      <header class="stage-head">
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-slate-900">MÃ©thode 5Ã—5 ğŸ—£ï¸ / 5ê°œì”© í›ˆë ¨ë²•</h2>
          <p class="stage-help">Ã‰couter â†’ RÃ©pÃ©ter â†’ <b>Enregistrer & Ã‰valuer</b> / ë“£ê³  ë”°ë¼ ë§í•œ ë’¤ <b>ë…¹ìŒÂ·í‰ê°€</b></p>
        </div>
        <div class="stage-tag" id="stageTag">Niveau 1 â€” lent (0.7Ã—)</div>
      </header>

      <p class="muted mt-2">
        4 items (Natifs 1â€“5, Natifs 6â€“10, Hanja 1â€“5, Hanja 6â€“10) sont groupÃ©s : ê° 4ê°œë¥¼ <b>ëª¨ë‘ ì™„ë£Œ</b>í•˜ë©´ ë‹¤ìŒ ì†ë„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
        <br><span class="text-slate-500">FRë„ í•¨ê»˜ í‘œê¸°: â€œEnregistrer / Ã‰valuerâ€ ë²„íŠ¼</span>
      </p>

      <div id="stageBlocks" class="mt-5 space-y-5">
        <!-- 4 Blocks injected here -->
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="row">
          <span class="score-pill"><i class="fa-solid fa-gauge-high"></i><span id="stageProgress">0/4 terminÃ©</span></span>
          <span class="muted">ComplÃ©tez les 4 pour continuer.</span>
        </div>
        <button id="nextStageBtn" class="btn btn-primary" disabled>Ã‰tape suivante (ë‹¤ìŒ ë‹¨ê³„)</button>
      </div>

      <div id="finalArea" class="hidden mt-6">
        <div class="p-4 rounded-lg bg-emerald-50 border border-emerald-200">
          <div class="flex items-center gap-2 text-emerald-800 font-bold text-lg">
            <i class="fa-solid fa-check-double"></i> ì›Œë°ì—… ì™„ë£Œ Â· Ã‰chauffement terminÃ© !
          </div>
          <p class="mt-1 text-slate-700">ê²°ê³¼ëŠ” ì„ ìƒë‹˜ê»˜ ì „ì†¡ë©ë‹ˆë‹¤. ë‹¤ìŒ ì—°ìŠµë¬¸ì œë¡œ ì´ë™í•˜ì„¸ìš”.</p>
          <div class="row mt-3">
            <a class="btn btn-ghost" href="./numbers-exercises.html"><i class="fa-solid fa-arrow-right"></i> Aller aux exercices (ì—°ìŠµë¬¸ì œ)</a>
          </div>
        </div>
      </div>
    </section>

  </div>

  <div class="brand">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ===== GLOBAL OPTIONS / SCRIPTS ===== -->
  <script>
    // í™˜ê²½ì„¤ì •
    window.PONGDANG_TTS = window.PONGDANG_TTS || { provider: 'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
    // pronun í´ë¼ì´ì–¸íŠ¸: ì „ì‚¬/ìˆ«ìì¹˜í™˜ ë¬¸êµ¬ ìˆ¨ê¹€
    window.PRONUN_OPTIONS = { hideTranscript: true, hideNumericSwap: true };
  </script>
  <script src="../assets/pronun-utils.js"></script>
  <script src="../assets/pronun-vowel-middleware.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    // ====== Data ======
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    // 4 ë¬¶ìŒ(í•­ìƒ ë™ì¼)
    const PHRASES = [
      { key:'nat1', title:'Natifs ìˆœí•œêµ­ì–´ (1â€“5)', text:'í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯', voice:'alloy' },
      { key:'nat2', title:'Natifs ìˆœí•œêµ­ì–´ (6â€“10)', text:'ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´', voice:'shimmer' },
      { key:'han1', title:'Hanja í•œì (1â€“5)', text:'ì¼, ì´, ì‚¼, ì‚¬, ì˜¤', voice:'alloy' },
      { key:'han2', title:'Hanja í•œì (6â€“10)', text:'ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­', voice:'alloy' }
    ];

    // ë‹¨ê³„(ì†ë„) â€” ë§ˆì§€ë§‰ ë‹¨ê³„ëŠ” ì‰¼í‘œ ì œê±°
    const STAGES = [
      { label:'Niveau 1 â€” lent (0.7Ã—)', speed:0.7, stripCommas:false },
      { label:'Niveau 2 â€” normal (1.0Ã—)', speed:1.0, stripCommas:false },
      { label:'Niveau 3 â€” rapide (1.2Ã—)', speed:1.2, stripCommas:false },
      { label:'Niveau 4 â€” trÃ¨s rapide (1.5Ã—)', speed:1.5, stripCommas:false },
      { label:'Niveau 5 â€” 1.5Ã— sans virgules', speed:1.5, stripCommas:true }
    ];

    // ì§„í–‰ ìƒíƒœ
    let stageIndex = 0;                               // 0..4
    const stageResults = STAGES.map(()=>({            // ê° ë‹¨ê³„ì˜ 4ê°œ ì™„ë£Œ ì—¬ë¶€ / ì ìˆ˜
      done:[false,false,false,false],
      scores:[null,null,null,null]
    }));

    // ====== Audio(TTS) helpers ======
    const VOICE_MAP = {
      openai: { default:'alloy', alloy:'alloy', shimmer:'verse' },
      google: { default:'ko-KR-Standard-A', alloy:'ko-KR-Standard-A', shimmer:'ko-KR-Standard-B' }
    };
    const mapVoice = (prov,req) => (VOICE_MAP[prov]||{})[req] || (VOICE_MAP[prov]||{}).default || req;

    let currentAudio=null, currentFetchAbort=null, audioBusy=false;
    function base64ToBlob(b64,mime='audio/mpeg'){const c=b64.includes(',')?b64.split(',')[1]:b64;const s=atob(c);const a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);return new Blob([a],{type:mime});}

    async function playTTS(btn, text, voice, speed){
      if(audioBusy){ try{ if(currentAudio?.paused){ await currentAudio.play(); btn.innerHTML='<i class="fa-solid fa-pause"></i>'; } else { currentAudio.pause(); btn.innerHTML='<i class="fa-solid fa-play"></i>'; } }catch(_){ } return; }
      try{
        audioBusy = true;
        if(currentFetchAbort){ try{currentFetchAbort.abort();}catch(_){ } }
        if(currentAudio){ try{currentAudio.pause();}catch(_){ } }

        const primary = window.PONGDANG_TTS?.provider || 'openai';
        const payload = { text, voice: mapVoice(primary,voice), provider: primary, speed };
        const ac = new AbortController(); currentFetchAbort = ac;

        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        const res = await fetch(`${FN_BASE}/generate-audio`, {
          method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body: JSON.stringify(payload), signal: ac.signal
        });
        if(!res.ok){ throw new Error('TTS failed '+res.status); }
        const data = await res.json();
        let src; if(data.audioBase64||data.audioContent){ src=URL.createObjectURL(base64ToBlob(data.audioBase64||data.audioContent,data.mimeType||'audio/mpeg')); } else { src=data.audioUrl; }

        const audio = new Audio(src); currentAudio = audio;
        audio.addEventListener('playing', ()=> btn.innerHTML='<i class="fa-solid fa-pause"></i>');
        audio.addEventListener('pause',   ()=> btn.innerHTML='<i class="fa-solid fa-play"></i>');
        audio.addEventListener('ended',   ()=> btn.innerHTML='<i class="fa-solid fa-play"></i>');
        await audio.play();
      }catch(e){
        alert('ì˜¤ë””ì˜¤ ìƒì„±/ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }finally{
        audioBusy = false;
      }
    }

    // ====== Pronunciation mount (ì‚¬ìš©ì ë²„íŠ¼/ìº”ë²„ìŠ¤ ì œê³µ) ======
    function mountPronun(container, refText, onEvaluated){
      if(!window.Pronun){ container.innerHTML = '<div class="text-red-600">pronun-client.js ë¡œë“œ ì˜¤ë¥˜</div>'; return; }

      // ì»¨í…Œì´ë„ˆ ê³¨ê²©: ì‚¬ìš©ì ë²„íŠ¼ + VU + ê²°ê³¼ ì˜ì—­
      container.innerHTML = `
        <div class="row">
          <button class="btn btn-ghost btn-rec-start">ğŸ™ï¸ Enregistrer / ë…¹ìŒ</button>
          <button class="btn btn-ghost btn-rec-stop" disabled>â¹ï¸ ArrÃªter / ì •ì§€</button>
          <button class="btn btn-primary btn-eval" disabled>âœ… Ã‰valuer ma prononciation / ë‚´ ë°œìŒ í™•ì¸</button>
        </div>
        <div class="mt-2 vu-canvas-wrap"><canvas class="vu"></canvas></div>
        <div class="pronun-display mt-2 text-sm"></div>
      `;

      // Pronun.mount: ë‚´ë¶€ì—ì„œ start/stop/ë¶„ì„ + í‘œì‹œê¹Œì§€ ìˆ˜í–‰
      const opts = {
        getReferenceText: ()=> refText,
        isKoCorrect: ()=> true, // ì›Œë°ì—…ì€ ë°œìŒë§Œ ë³¸ë‹¤
        onResult: (r)=>{
          // r.accuracy(0~1) ê°€ì • â€” ë¶ˆ/í•œ ì¹œì ˆ ë©”ì„¸ì§€(r.friendly?.[{fr,ko}] )ë„ í‘œì‹œë¨
          try{
            // %ë¡œ ê³„ì‚°
            const p = typeof r?.accuracy === 'number' ? Math.round(r.accuracy*100) : null;
            if(p!=null){
              const pill = container.querySelector('.score-lbl');
              if(pill) pill.textContent = `${p}%`;
              else {
                const box = document.createElement('div');
                box.className = 'mt-2';
                box.innerHTML = `<span class="score-pill"><i class="fa-solid fa-wave-square"></i> <span class="score-lbl">${p}%</span></span>`;
                container.appendChild(box);
              }
            }
          }catch(_){}
          // ì™„ë£Œ ì½œë°±
          if(typeof onEvaluated==='function') onEvaluated(r);
        }
      };
      Pronun.mount(container, opts);

      // ìˆ«ì ì „ì‚¬/ì¹˜í™˜ ë¬¸êµ¬ ì œê±°(ë³´ì´ëŠ” í…ìŠ¤íŠ¸ì—ì„œ 'ì „ì‚¬' ë‹¨ì–´ ìˆ¨ê¹€)
      scrubPronun(container);

      // í‰ê°€ ë²„íŠ¼: ë…¹ìŒ ì¤‘ì´ë©´ stopì„ ëˆ„ë¥´ê³ (=í‰ê°€ íŠ¸ë¦¬ê±°), ì•„ë‹ˆë©´ ìµœê·¼ ë…¹ìŒ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì—¬ì¤Œ
      const btnEval = container.querySelector('.btn-eval');
      const btnStop = container.querySelector('.btn-rec-stop');
      const btnStart= container.querySelector('.btn-rec-start');

      // ë…¹ìŒ ì‹œì‘/ì •ì§€ ìƒíƒœì— ë”°ë¼ Eval ë²„íŠ¼ í™œì„±í™”
      const enableEval = (on)=> { if(btnEval) btnEval.disabled = !on; };

      // Pronun.mount ê°€ ë²„íŠ¼ enable/disableì„ ì œì–´í•˜ë¯€ë¡œ MutationObserverë¡œ ê°ì‹œí•´ ë™ê¸°í™”
      const mo = new MutationObserver(()=> {
        const stopped = !btnStop.hasAttribute('disabled');
        const started = !btnStart.hasAttribute('disabled'); // mount ì§í›„ startê°€ í™œì„±ì„
        // ì‹¤ì œë¡œëŠ”: start í™œì„±/ stop ë¹„í™œì„±ì´ë©´ "ëŒ€ê¸°"; stop í™œì„± = "ë…¹ìŒ ì¤‘"
        // í‰ê°€ ë²„íŠ¼ì€ "ë…¹ìŒ í›„"ì—ë„ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ ì¼ë‹¨ í•­ìƒ í™œì„±í™” â†’ ë‹¨, ì²« ë…¹ìŒ ì „ì—ëŠ” ë¹„í™œì„±
      });
      mo.observe(container, { attributes:true, subtree:true });

      btnEval?.addEventListener('click', ()=>{
        // ë…¹ìŒ ì¤‘ì´ë©´ ì •ì§€ â†’ í‰ê°€
        if(!btnStop.disabled){ btnStop.click(); }
        // ë…¹ìŒì„ í•œ ë²ˆì´ë¼ë„ í–ˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ê²°ê³¼ í‘œì‹œ(Pronunê°€ onResultë¡œ ë Œë”)
      });

      // ì²« ë…¹ìŒ ì‹œì‘ ì‹œ ì´í›„ë¶€í„° í‰ê°€ ë²„íŠ¼ í™œì„±í™”
      btnStart?.addEventListener('click', ()=> enableEval(true));
    }

    function scrubPronun(container){
      if(!container) return;
      const kill = ['ì „ì‚¬','transcription','transcrit'];
      const sweep = ()=>{
        container.querySelectorAll('*').forEach(n=>{
          n.childNodes && n.childNodes.forEach(c=>{
            if(c.nodeType===3 && kill.some(k=>String(c.textContent).toLowerCase().includes(k))){
              c.textContent = '';
            }
          });
        });
      };
      sweep();
      new MutationObserver(sweep).observe(container,{childList:true,subtree:true});
    }

    // ====== Stage rendering ======
    function currentStageText(raw){
      const st = STAGES[stageIndex];
      if(st.stripCommas) return raw.replace(/,\s*/g,' ');
      return raw;
    }

    function renderStage(){
      // í—¤ë” íƒœê·¸
      document.getElementById('stageTag').textContent = STAGES[stageIndex].label;

      const holder = document.getElementById('stageBlocks');
      holder.innerHTML = '';
      const spd = STAGES[stageIndex].speed;

      PHRASES.forEach((ph, idx)=>{
        const text = currentStageText(ph.text);

        const block = document.createElement('div');
        block.className = 'block';
        block.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="demo-head">${ph.title}</div>
              <div class="demo-sub">Vitesse actuelle / í˜„ì¬ ì†ë„: <b>${spd}Ã—</b>${STAGES[stageIndex].stripCommas?' Â· (ì‰¼í‘œ ì—†ìŒ)':''}</div>
            </div>
            <button class="btn btn-sound playbtn"><i class="fa-solid fa-play"></i></button>
          </div>

          <div class="mt-3">
            <div class="muted mb-2">Ã‰couter â†’ RÃ©pÃ©ter â†’ Enregistrer / ë“£ê³  ë”°ë¼ ë§í•œ ë’¤ ë…¹ìŒ</div>
            <div class="row">
              <button class="btn btn-ghost btn-rec-start">ğŸ™ï¸ Enregistrer / ë…¹ìŒ</button>
              <button class="btn btn-ghost btn-rec-stop" disabled>â¹ï¸ ArrÃªter / ì •ì§€</button>
              <button class="btn btn-primary btn-eval" disabled>âœ… Ã‰valuer ma prononciation / ë‚´ ë°œìŒ í™•ì¸</button>
            </div>
            <div class="mt-2"><canvas class="vu"></canvas></div>
            <div class="pronun-display mt-2 text-sm"></div>
          </div>

          <div class="mt-3">
            <span class="muted">RÃ©sultat / ê²°ê³¼:</span>
            <span class="score-pill"><i class="fa-solid fa-wave-square"></i> <span class="score-lbl">-</span></span>
            <span class="ok-wrap ml-2"></span>
          </div>
        `;
        holder.appendChild(block);

        // ì¬ìƒ ë²„íŠ¼
        const playBtn = block.querySelector('.playbtn');
        playBtn.addEventListener('click', ()=> playTTS(playBtn, text, ph.voice, spd));

        // ë°œìŒ í‰ê°€ mount
        const okWrap = block.querySelector('.ok-wrap');
        mountPronun(block, text, (res)=>{
          // í‰ê°€ ìˆ˜ì‹  â†’ ì ìˆ˜ ë°˜ì˜ + ì™„ë£Œ ë§ˆí‚¹
          let p = (typeof res?.accuracy==='number') ? Math.round(res.accuracy*100) : null;
          block.querySelector('.score-lbl').textContent = (p==null? '-' : p+'%');
          stageResults[stageIndex].done[idx]  = true;
          stageResults[stageIndex].scores[idx]= (p==null? 0 : p);
          okWrap.innerHTML = `<span class="ok-badge">âœ“ TerminÃ© / ì™„ë£Œ</span>`;
          updateStageFooter();
        });
      });

      updateStageFooter();
    }

    function updateStageFooter(){
      const doneCnt = stageResults[stageIndex].done.filter(Boolean).length;
      document.getElementById('stageProgress').textContent = `${doneCnt}/4 terminÃ©`;
      const nextBtn = document.getElementById('nextStageBtn');
      nextBtn.disabled = (doneCnt<4);
    }

    // ë‹¤ìŒ ë‹¨ê³„ / ë§ˆì§€ë§‰ ì™„ë£Œ ì‹œ ê²°ê³¼ ì „ì†¡
    document.addEventListener('DOMContentLoaded', ()=>{
      renderStage();

      document.getElementById('nextStageBtn').addEventListener('click', async ()=>{
        if(stageIndex < STAGES.length-1){
          stageIndex++;
          renderStage();
          if(stageIndex === STAGES.length-1){
            document.getElementById('nextStageBtn').textContent = 'Terminer le warm-up (ë§ˆì§€ë§‰ ë‹¨ê³„ ì™„ë£Œ)';
          }
        }else{
          // ëª¨ë“  ë‹¨ê³„ ë â†’ ê²°ê³¼ ì „ì†¡ + ì™„ë£Œ í‘œì‹œ
          try{
            await sendWarmupResults();
          }catch(_){}
          document.getElementById('nextStageBtn').disabled = true;
          document.getElementById('finalArea').classList.remove('hidden');
          window.scrollTo({ top: document.getElementById('finalArea').offsetTop - 40, behavior:'smooth' });
        }
      });
    });

    // ====== ê²°ê³¼ ì „ì†¡(ì„ ìƒë‹˜ì—ê²Œ ë©”ì¼) ======
    async function sendWarmupResults(){
      const questions = [];
      // ë‹¨ê³„ë³„ 4ê°œ â†’ ì´ 20 í•­ëª©
      STAGES.forEach((st, si)=>{
        PHRASES.forEach((ph, pi)=>{
          const idx = si*4 + pi + 1;
          const text = st.stripCommas? ph.text.replace(/,\s*/g,' ') : ph.text;
          const score = stageResults[si].scores[pi];
          questions.push({
            number: idx,
            type: 'warmup',
            fr: ph.title + ` (${st.label})`,
            ko: text,
            userAnswer: '',
            isCorrect: undefined,
            listenCount: undefined,
            pronunciation: (typeof score==='number') ? { accuracy: score/100, tags:['warmup'] } : null
          });
        });
      });

      const payload = {
        studentName: '(Warming-up anonyme)',
        startTime: new Date(Date.now() - 1000*60).toISOString(),
        endTime: new Date().toISOString(),
        totalTimeSeconds: 60,
        assignmentTitle: 'Warming-up 5Ã—5 (multi-vitesse)',
        assignmentTopic: 'Nombres natifs vs Hanja',
        assignmentSummary: [
          'Ã‰tapes: 0.7Ã— â†’ 1.0Ã— â†’ 1.2Ã— â†’ 1.5Ã— â†’ 1.5Ã— (sans virgules)',
          '4 groupes par Ã©tape: Natifs(1â€“5), Natifs(6â€“10), Hanja(1â€“5), Hanja(6â€“10)'
        ],
        questions
      };

      const res = await fetch(`${FN_BASE}/send-results`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      // ì‹¤íŒ¨í•˜ë”ë¼ë„ í˜ì´ì§€ íë¦„ì€ ìœ ì§€
      try{ const j = await res.json(); if(!res.ok || j?.ok===false) console.warn('send-results fail', j); }catch(_){}
    }
  </script>
</body>
</html>
