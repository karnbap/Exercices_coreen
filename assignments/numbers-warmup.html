<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice CorÃ©en â€“ Intro + MÃ©thode 5Ã—5</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- (ì„ íƒ) ê³µìš© ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="../assets/style.css"/>

  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .wrap{max-width:1000px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 15px -8px rgba(0,0,0,.08);padding:20px}
    .kicker{color:#64748b;letter-spacing:.02em}

    /* ì„¤ëª… ê°€ë…ì„± */
    .readable { line-height: 1.9; }
    .readable p { margin:.85rem 0; }
    .soft-divider { height:1px;margin:1.2rem 0;background:linear-gradient(to right, transparent, #e5e7eb, transparent); }

    /* ë²„íŠ¼ë“¤ */
    .btn{padding:.65rem 1rem;border-radius:.65rem;font-weight:600;transition:all .2s;border:none;cursor:pointer}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .playing{background:#059669 !important}

    /* ìŠ¤í”¼ë“œ ì¹© */
    .speed-chip{font-size:.9rem;border:1px solid #e5e7eb;background:#f8fafc;border-radius:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:.4rem}
    .speed-chip .dot{width:7px;height:7px;border-radius:50%;background:#94a3b8}
    .speed-chip b{font-weight:700}

    /* pronun ë°•ìŠ¤ */
    .pronun-box{border:1px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:12px}
    .pronun-box h5{font-size:.95rem;margin-bottom:.35rem;color:#1f2937}

    /* í•˜ë‹¨ ë©”ì´ë“œë°”ì´(ê³ ì • í•œ ê³³) */
    .madeby{position:fixed;right:14px;bottom:12px;font-size:.85rem;color:#94a3b8}
  </style>
</head>
<body class="bg-gray-50">

  <div class="wrap space-y-6">
    <!-- í—¤ë” -->
    <header class="text-center">
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 leading-tight">
        Exercice : Les Nombres CorÃ©ens ğŸ”¢
      </h1>
      <p class="kicker mt-1">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanja-corÃ©ens</p>
    </header>

    <!-- ê°„ë‹¨ ì„¤ëª… -->
    <section class="card readable">
      <h2 class="text-xl font-bold text-slate-900">ğŸ“˜ Pourquoi deux systÃ¨mes ? / ì™œ ë‘ ê°€ì§€ ìˆ«ì?</h2>
      <p><b>í•œì(Hanja)</b>ëŠ” <u>ê¸€ì(ë¬¸ì ì²´ê³„)</u>, <b>chinois</b>ëŠ” <u>ì–¸ì–´</u>ì˜ˆìš”. í•œêµ­ì–´ ìˆ«ìëŠ” <b>ìˆœìˆ˜ í•œêµ­ì–´(í•˜ë‚˜, ë‘˜â€¦)</b>ì™€ <b>í•œìì–´(ì¼, ì´â€¦)</b>ë¥¼ ëª¨ë‘ ì¨ìš”.</p>
      <ul class="list-disc list-inside">
        <li><b>Natifs</b> â†’ ëˆˆì•ì—ì„œ ì„¸ëŠ” ê²ƒ(ë‚˜ì´, ì‚¬ëŒ ìˆ˜, ì‚¬ë¬¼ ê°œìˆ˜ ë“±)</li>
        <li><b>Hanja-corÃ©ens</b> â†’ ë‹¬ë ¥Â·ì‹œê³„Â·ëˆì²˜ëŸ¼ <i>ì´ë¯¸ ì •í•´ì ¸ ì íŒ</i> ë‹¨ìœ„/ê°’(ë‚ ì§œ, ë¶„Â·ì´ˆ, ê¸ˆì•¡, í˜¸ìˆ˜ ë“±)</li>
      </ul>
      <div class="soft-divider"></div>
      <p>â±ï¸ ì˜ˆì™¸: <b>Heures(ì‹œ)</b>ëŠ” <b>natifs</b>, <b>Minutes(ë¶„)</b>ì€ <b>Hanja-corÃ©ens</b>ë¥¼ ì£¼ë¡œ ì”ë‹ˆë‹¤.</p>
    </section>

    <!-- MÃ©thode 5Ã—5 ì›Œë°ì—… -->
    <section id="warmup" class="card">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-bold text-slate-900">MÃ©thode 5Ã—5 ğŸ—£ï¸ / 5ê°œì”© í›ˆë ¨ë²•</h2>
          <p class="text-slate-600">Ã‰couter â†’ RÃ©pÃ©ter â†’ <b>Enregistrer & Ã‰valuer</b> / ë“£ê³  ë”°ë¼ ë§í•œ ë’¤ <b>ë…¹ìŒÂ·í‰ê°€</b></p>
        </div>
        <div class="text-sm text-slate-500">
          <span class="font-semibold">Quand vous voulez</span> / í•„ìš”í•  ë•Œ ì–¸ì œë“  ë“£ê¸°
        </div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-5">
        <!-- 4ê°œì˜ ê¸°ë³¸ êµ¬ê°„ì´ JSì—ì„œ ë Œë”ë§ë©ë‹ˆë‹¤ -->
        <div id="set-1" class="space-y-3"></div>
        <div id="set-2" class="space-y-3"></div>
        <div id="set-3" class="space-y-3"></div>
        <div id="set-4" class="space-y-3"></div>
      </div>

      <div class="mt-5 text-xs text-slate-500">
        â€» ê° ì¹¸ì€ <b>0.7Ã— â†’ 1.0Ã— â†’ 1.2Ã— â†’ 1.5Ã— â†’ 1.5Ã—(ì‰¼í‘œ ì œê±°)</b> ìˆœì„œë¡œ <u>ë“£ê³  â†’ ë…¹ìŒ â†’ ë°œìŒí‰ê°€</u>ë¥¼ ì—°ìŠµí•©ë‹ˆë‹¤.
      </div>
    </section>
  </div>

  <!-- ê¹”ë”í•œ í‘œê¸°: í•œ ê³³ë§Œ -->
  <div class="madeby">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ì „ì—­ ì„¤ì • -->
  <script>
    window.PONGDANG_TTS   = window.PONGDANG_TTS   || { provider:'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
  </script>

  <!-- ìœ í‹¸ & ë°œìŒ í‰ê°€ í´ë¼ì´ì–¸íŠ¸ & ì´ë¦„ ê²Œì´íŠ¸ -->
  <script src="../assets/student-gate.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    /* ====== ì¬ìƒ ê³µí†µ ====== */
    let currentAudio = null, currentBlobUrl = null, currentFetchAbort = null;
    let audioClickLocked = false, isPlayingOrFetching = false;
    let currentAudioMeta = { text:null, voice:null, speed:1 };
    let currentPlayBtn = null;

    function base64ToBlob(base64, mime='audio/mp3'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    function cleanupAudio(){
      try{ currentAudio?.pause(); }catch(_){}
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
      currentAudio=null; currentPlayBtn=null;
    }
    function btnToPlaying(btn, playing){
      if(!btn) return;
      if(playing){
        btn.classList.add('playing');
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause (ì¼ì‹œì •ì§€)';
      }else{
        btn.classList.remove('playing');
        btn.innerHTML = '<i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)';
      }
    }
    function safeAttr(s){ return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/\n/g," "); }

    async function playKo(text, btn, { speed=1.0, voice='alloy' } = {}){
      if(audioClickLocked || isPlayingOrFetching){
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.speed===speed){
          try{
            if(!currentAudio.paused){ currentAudio.pause(); btnToPlaying(btn,false); }
            else { await currentAudio.play(); btnToPlaying(btn,true); }
          }catch(_){}
        }
        return;
      }
      audioClickLocked = true; setTimeout(()=>audioClickLocked=false, 220);

      try{
        // ë™ì¼ ì»¨í…ì¸  â†’ í† ê¸€
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.speed===speed){
          if(!currentAudio.paused){ currentAudio.pause(); btnToPlaying(btn,false); }
          else { await currentAudio.play(); btnToPlaying(btn,true); }
          return;
        }

        isPlayingOrFetching = true;
        if(currentFetchAbort){ try{ currentFetchAbort.abort(); }catch(_){ } }
        if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } }

        const ac = new AbortController();
        currentFetchAbort = ac;

        const payload = { text, voice, speed };
        const res = await fetch(`${FN_BASE}/generate-audio`,{
          method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body:JSON.stringify(payload), signal: ac.signal
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(`generate-audio fail: ${res.status} ${t}`);
        }
        const data = await res.json();
        let srcUrl = null;
        if(data.audioBase64 || data.audioContent){
          const blob = base64ToBlob(data.audioBase64 || data.audioContent, data.mimeType||'audio/mpeg');
          srcUrl = URL.createObjectURL(blob); currentBlobUrl = srcUrl;
        }else if(data.audioUrl){ srcUrl = data.audioUrl; }
        else { throw new Error('Invalid TTS response'); }

        const audio = new Audio(srcUrl);
        currentAudio = audio;
        currentAudioMeta = { text, voice, speed };
        currentPlayBtn = btn;

        audio.addEventListener('playing', ()=> btnToPlaying(btn,true));
        audio.addEventListener('pause',   ()=> btnToPlaying(btn,false));
        audio.addEventListener('ended',   ()=> btnToPlaying(btn,false));
        audio.addEventListener('error',   ()=> btnToPlaying(btn,false));

        await audio.play();
      }catch(e){
        console.error(e);
        alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }finally{
        isPlayingOrFetching = false;
      }
    }

    /* ====== 5Ã—5 ë°ì´í„° ====== */
    const SETS = [
      { mountId:'set-1', title:'ìˆœìˆ˜ í•œêµ­ì–´ / Natifs (1â€“5)', phrase:'í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯', voice:'alloy' },
      { mountId:'set-2', title:'ìˆœìˆ˜ í•œêµ­ì–´ / Natifs (6â€“10)', phrase:'ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´', voice:'shimmer' },
      { mountId:'set-3', title:'í•œìì–´ / Hanja-corÃ©ens (1â€“5)', phrase:'ì¼, ì´, ì‚¼, ì‚¬, ì˜¤', voice:'alloy' },
      { mountId:'set-4', title:'í•œìì–´ / Hanja-corÃ©ens (6â€“10)', phrase:'ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­', voice:'alloy' }
    ];
    const SPEED_STEPS = [
      { label:'0.7Ã—', speed:0.7, strip:false },
      { label:'1.0Ã—', speed:1.0, strip:false },
      { label:'1.2Ã—', speed:1.2, strip:false },
      { label:'1.5Ã—', speed:1.5, strip:false },
      { label:'1.5Ã— (sans virgules / ì‰¼í‘œ ì—†ìŒ)', speed:1.5, strip:true }
    ];

    function stripCommasKo(s){ return s.replaceAll(',', ''); }

    function renderSet(container, meta){
      const block = document.createElement('div');
      block.className = 'p-4 rounded-xl border border-slate-200 bg-white/90 shadow-sm';
      block.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold text-slate-700">${meta.title}</div>
            <div class="text-slate-500 text-sm korean-font">${meta.phrase}</div>
          </div>
          <div class="hidden md:block text-xs text-slate-500">Ã‰couter â†’ RÃ©pÃ©ter â†’ <b>Enregistrer & Ã‰valuer</b></div>
        </div>
        <div class="mt-3 grid md:grid-cols-2 gap-3" data-steps></div>
      `;
      container.appendChild(block);

      const stepsWrap = block.querySelector('[data-steps]');
      SPEED_STEPS.forEach((st, idx) => {
        const refText = st.strip ? stripCommasKo(meta.phrase) : meta.phrase;
        const card = document.createElement('div');
        card.className = 'rounded-lg border border-slate-200 p-3 bg-slate-50';
        card.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="speed-chip"><span class="dot"></span> <b>${st.label}</b></div>
            <button class="btn btn-sound btn-play"><i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)</button>
          </div>
          <div class="mt-2 pronun-box">
            <h5>ğŸ¤ Enregistrer & Ã©valuer / ë…¹ìŒÂ·ë°œìŒ í‰ê°€</h5>
            <div class="text-xs text-slate-500 mb-1">RÃ©fÃ©rez-vous Ã &nbsp;<span class="korean-font font-semibold">${refText}</span></div>
            <div class="pronun-mount"></div>
          </div>
        `;
        stepsWrap.appendChild(card);

        // Play ë²„íŠ¼ ë™ì‘
        const playBtn = card.querySelector('.btn-play');
        playBtn.addEventListener('click', () => {
          playKo(refText, playBtn, { speed: st.speed, voice: meta.voice || 'alloy' });
        });

        // ë°œìŒ í‰ê°€ mount
        const mount = card.querySelector('.pronun-mount');
        if (window.Pronun && mount){
          try{
            Pronun.mount(mount, {
              getReferenceText: () => refText,
              onResult: (r) => {
                // í•„ìš” ì‹œ í›„ì²˜ë¦¬ ê°€ëŠ¥. (r.score, r.detail ë“±)
                // console.log('Pronun result', r);
              }
            });
          }catch(e){
            console.warn('Pronun.mount error', e);
          }
        }
      });
    }

    /* ====== ë¶€íŠ¸ìŠ¤íŠ¸ë© ====== */
    document.addEventListener('DOMContentLoaded', () => {
      // ì´ë¦„ ì…ë ¥ ê°€ë“œ(ìµœì´ˆ í•œ ë²ˆ)
      if (window.StudentGate) {
        StudentGate.init();
        StudentGate.requireBeforeInteraction(document);
      }

      // ì„¸íŠ¸ ë Œë”
      SETS.forEach((s) => {
        const host = document.getElementById(s.mountId);
        if (host) renderSet(host, s);
      });
    });
  </script>
</body>
</html>
