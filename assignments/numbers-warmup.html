<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CorÃ©en â€” Nombres | Explications + Warming up (5Ã—5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- (ì„ íƒ) í”„ë¡œì íŠ¸ ê³µìš© ìŠ¤íƒ€ì¼ì´ ìˆë‹¤ë©´ ìœ ì§€ -->
  <link rel="stylesheet" href="../assets/style.css">

  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .quiz-container{max-width:860px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -2px rgba(0,0,0,.04)}
    .btn{padding:.75rem 1.1rem;border-radius:.65rem;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .btn-ghost{background:transparent;color:#475569}
    .small-muted{ font-size:.9rem; color:#64748b; }
    .readable { line-height: 1.9; }
    .readable p { margin-top: 0.9rem; margin-bottom: 0.9rem; }
    .readable .kicker { font-size: .96rem; letter-spacing: .02em; color:#64748b; }
    .info-card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1.15rem 1.25rem; box-shadow:0 1px 2px rgba(16,24,40,.06); }
    .info-card h3 { font-weight:700; font-size:1.125rem; color:#0f172a; margin-bottom:.5rem; }
    .callout { background:#fef9c3; border:1px solid #fde68a; color:#92400e; padding:.9rem 1rem; border-radius:.85rem; }
    .soft-divider { height:1px; margin:1.35rem 0; background:linear-gradient(to right, transparent, #e5e7eb, transparent); }
    .table-soft th { background:#f8fafc; color:#0f172a; }
    .table-soft th, .table-soft td { padding:1rem; }
    .brand-tag{position:fixed;right:16px;bottom:12px;font-size:12px;color:#9ca3af}

    /* Warming up card */
    .wu-card{background:#fff;border:1px solid #e5e7eb;border-radius:0.9rem;padding:1rem}
    .wu-done{background:#ecfdf5;border:1px solid #a7f3d0}
    .wu-step-badge{font-size:.78rem;font-weight:700;padding:.25rem .5rem;border-radius:.4rem;background:#e2e8f0;color:#0f172a}
    .progress-dot{width:.6rem;height:.6rem;border-radius:9999px;background:#e5e7eb}
    .progress-dot.on{background:#22c55e}
    .hidden{display:none}
  </style>
</head>
<body class="bg-gray-50">

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ì„¤ëª… (ì›ë³¸ ë ˆì´ì•„ì›ƒ/ê³µë°±/ìˆœì„œ ê·¸ëŒ€ë¡œ ìœ ì§€)
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="min-h-screen flex flex-col items-center justify-center text-center p-6">
    <div class="max-w-3xl w-full mx-auto readable">
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-3 leading-tight">Exercice : Les Nombres CorÃ©ens ğŸ”¢</h1>
      <p class="kicker mb-6">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs vs í•œìì–´ / Hanja-corÃ©ens</p>

      <div class="grid md:grid-cols-2 gap-6 text-left">
        <div class="info-card">
          <h3>1ï¸âƒ£ Petite explication / ê°„ë‹¨ ì„¤ëª…</h3>
          <div class="callout">ğŸ‘‰ Â« í•œì = chinois(ì–¸ì–´) Â»ê°€ ì•„ë‹ˆì—ìš”! Hanja=ë¬¸ì ì²´ê³„, Chinois=ì–¸ì–´.</div>
          <ul class="list-disc list-inside mt-3 space-y-1.5">
            <li><strong>í•œì (Hanja)</strong> = systÃ¨me dâ€™Ã©criture</li>
            <li><strong>Chinois</strong> = langue</li>
          </ul>
        </div>
        <div class="info-card">
          <h3>2ï¸âƒ£ Deux systÃ¨mes / ë‘ ê°€ì§€ ìˆ«ì</h3>
          <p class="mb-2"><strong>ìˆœìˆ˜ í•œêµ­ì–´</strong> â†” <strong>í•œìì–´</strong></p>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
              <div class="font-semibold text-blue-900">Natifs</div>
              <div class="text-xl font-bold">í•˜ë‚˜, ë‘˜, ì…‹â€¦</div>
              <div class="small-muted">Ã‚ge, personnes, objetsâ€¦</div>
            </div>
            <div class="p-3 rounded-lg bg-green-50 border border-green-200">
              <div class="font-semibold text-green-900">Hanja-corÃ©ens</div>
              <div class="text-xl font-bold">ì¼, ì´, ì‚¼â€¦</div>
              <div class="small-muted">Dates, argent, minutesâ€¦</div>
            </div>
          </div>
        </div>
        <div class="info-card md:col-span-2">
          <h3>âš¡ Exception & Tendance</h3>
          <ul class="list-disc list-inside space-y-1.5">
            <li>Heures(ì‹œ) â†’ <b>natifs</b> Â· Minutes(ë¶„) â†’ <b>Hanja-corÃ©ens</b></li>
            <li>Â« 1 h = 60 min Â» ì²´ê³„ ì´í›„ ì‹œ=natifs / ë¶„=Hanja</li>
          </ul>
        </div>
        <div class="info-card md:col-span-2">
          <h3>âœ… RÃ©sumÃ© / ìš”ì•½</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse text-sm table-soft">
              <thead>
                <tr>
                  <th class="border border-slate-200">SystÃ¨me / ì²´ê³„</th>
                  <th class="border border-slate-200">Usage / ìš©ë„</th>
                  <th class="border border-slate-200">Exemples / ì˜ˆ</th>
                </tr>
              </thead>
              <tbody>
                <tr class="odd:bg-white even:bg-gray-50">
                  <td class="border border-slate-200 font-semibold">ìˆœìˆ˜ í•œêµ­ì–´ / Natifs</td>
                  <td class="border border-slate-200">Compter librement, classificateurs, durÃ©es libres</td>
                  <td class="border border-slate-200">
                    í•œ ë‹¬, ë‘ ë‹¬ / í•œ ê°œ, ë‘ ëª…, ì„¸ ì”, í•œ ê¶Œ / í•œ ì‹œ, ë‘ ì‹œ
                  </td>
                </tr>
                <tr class="odd:bg-white even:bg-gray-50">
                  <td class="border border-slate-200 font-semibold">í•œìì–´ / Hanja-corÃ©ens</td>
                  <td class="border border-slate-200">Valeurs Â« Ã©crites Â» (calendrier, montre, monnaieâ€¦)</td>
                  <td class="border border-slate-200">
                    1ì›”, 2ì›” / 10ë¶„, 30ì´ˆ / 2025ë…„ 9ì›” 7ì¼, 1,000ì› / 3ì¸µ, 302í˜¸
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="soft-divider"></div>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Warming up 5Ã—5 (ë“£ê¸° â†’ ë…¹ìŒ â†’ í‰ê°€)
       ë„¤ ê°œë¥¼ í•œ ë‹¨ê³„ë¡œ ë¬¶ê³ , ì™„ë£Œ ì‹œ ë‹¤ìŒ ë‹¨ê³„ ì˜¤í”ˆ
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="quiz-container">
    <div class="flex items-center justify-between flex-wrap gap-2 mb-2">
      <h2 class="text-3xl font-bold text-slate-800">MÃ©thode 5Ã—5 ğŸ—£ï¸ / 5ê°œì”© í›ˆë ¨ë²•</h2>
      <div class="text-sm text-slate-500">
        <span class="wu-step-badge">FR</span> Ã‰couter â†’ RÃ©pÃ©ter â†’ Enregistrer & Ã‰valuer
        <span class="mx-1">Â·</span>
        <span class="wu-step-badge">KR</span> ë“£ê¸° â†’ ë”°ë¼ ë§í•˜ê¸° â†’ ë…¹ìŒÂ·ë°œìŒí‰ê°€
      </div>
    </div>
    <p class="text-slate-600 mb-6">
      í•œ ë‹¨ê³„(stage)ëŠ” ì•„ë˜ <b>4ê°œ ë¬¶ìŒ</b>ì…ë‹ˆë‹¤. ë„¤ ê°œ ëª¨ë‘ <b>ë…¹ìŒ í›„ â€œë‚´ ë°œìŒ í‰ê°€(Ã‰valuer)â€</b>ë¥¼ ëˆ„ë¥´ë©´ <b>ë‹¤ìŒ ë‹¨ê³„</b>ê°€ ì—´ë¦½ë‹ˆë‹¤.
      <span class="block text-sm text-slate-500 mt-1">5ë‹¨ê³„: 0.7ë°°ì† â†’ 1.0 â†’ 1.2 â†’ 1.5 â†’ 1.5(ì‰¼í‘œ ì œê±°)</span>
    </p>

    <!-- ì§„í–‰ í‘œì‹œ -->
    <div id="global-progress" class="flex items-center gap-2 mb-6">
      <span class="text-xs font-semibold text-slate-500">Ã‰tapes / ë‹¨ê³„:</span>
      <div class="progress-dot on" data-dot="0"></div>
      <div class="progress-dot" data-dot="1"></div>
      <div class="progress-dot" data-dot="2"></div>
      <div class="progress-dot" data-dot="3"></div>
      <div class="progress-dot" data-dot="4"></div>
    </div>

    <!-- ìŠ¤í…Œì´ì§€ ì»¨í…Œì´ë„ˆë“¤: ì²˜ìŒì—” Stage 1ë§Œ í‘œì‹œ -->
    <div id="stages-wrap" class="space-y-8"></div>

    <!-- ëª¨ë“  ë‹¨ê³„ ì™„ë£Œì‹œ í‘œì‹œ -->
    <div id="finish-wrap" class="hidden mt-8 text-center">
      <div class="p-4 bg-white rounded-lg border mb-4">
        <div class="text-lg font-semibold">ğŸ‘ Warming up terminÃ© ! / ì›Œë°ì—… ì™„ë£Œ!</div>
        <div class="text-slate-600">ê²°ê³¼ë¥¼ ì„ ìƒë‹˜ê»˜ ë³´ë‚´ê³ , ë‹¤ìŒ ì—°ìŠµë¬¸ì œë¡œ ì´ë™í•  ìˆ˜ ìˆì–´ìš”.</div>
      </div>
      <button id="btn-send" class="btn btn-primary">ì™„ë£Œí•˜ê¸° Â· Envoyer les rÃ©sultats</button>
      <a href="./numbers-exercises.html" id="btn-next" class="btn btn-secondary ml-2 hidden">ë‹¤ìŒ ì—°ìŠµë¬¸ì œë¡œ ì´ë™</a>
    </div>
  </div>

  <div class="brand-tag">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ===== Config & ë¼ì´ë¸ŒëŸ¬ë¦¬ ===== -->
  <script>
    // TTS / Netlify functions base
    window.PONGDANG_TTS = window.PONGDANG_TTS || { provider: 'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';

    // Pronun í´ë¼ì´ì–¸íŠ¸ ì˜µì…˜: ì „ì‚¬/ìˆ«ìì¹˜í™˜ ìˆ¨ê¹€, FR/KR ë¼ë²¨
    window.PRONUN_OPTIONS = {
      hideTranscript: true,
      hideNumericSwap: true,
      labels: {
        title: "ğŸ¤ Enregistrer & Ã‰valuer / ë…¹ìŒí•˜ê³  í‰ê°€í•˜ê¸°",
        start: "ë…¹ìŒ ì‹œì‘ / DÃ©marrer",
        stop: "ì •ì§€ / ArrÃªter",
        eval: "ë‚´ ë°œìŒ í‰ê°€ / Ã‰valuer ma prononciation"
      }
    };
  </script>
  <!-- ë°œìŒí‰ê°€ ìœ í‹¸(í”„ë¡œì íŠ¸ ìì‚°) -->
  <script src="../assets/pronun-utils.js"></script>
  <script src="../assets/pronun-vowel-middleware.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    /* ====== ìƒìˆ˜/ë°ì´í„° ====== */
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    // 4ê°œ ë¬¶ìŒ(í…ìŠ¤íŠ¸ëŠ” ì‰¼í‘œ í¬í•¨ ë²„ì „)
    const BUNDLES = [
      { key:'natifs_1_5',  label:'Natifs (1â€“5)',  text:'í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯',   voice:'alloy'   },
      { key:'natifs_6_10', label:'Natifs (6â€“10)', text:'ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´', voice:'shimmer' },
      { key:'hanja_1_5',   label:'Hanja (1â€“5)',   text:'ì¼, ì´, ì‚¼, ì‚¬, ì˜¤',       voice:'alloy'   },
      { key:'hanja_6_10',  label:'Hanja (6â€“10)',  text:'ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­',       voice:'alloy'   },
    ];

    // 5ê°œ ë‹¨ê³„
    const STAGES = [
      { idx:0, title:'Ã‰tape 1 / 1ë‹¨ê³„', speed:0.7, stripCommas:false },
      { idx:1, title:'Ã‰tape 2 / 2ë‹¨ê³„', speed:1.0, stripCommas:false },
      { idx:2, title:'Ã‰tape 3 / 3ë‹¨ê³„', speed:1.2, stripCommas:false },
      { idx:3, title:'Ã‰tape 4 / 4ë‹¨ê³„', speed:1.5, stripCommas:false },
      { idx:4, title:'Ã‰tape 5 / 5ë‹¨ê³„ (sans virgules / ì‰¼í‘œ ì œê±°)', speed:1.5, stripCommas:true },
    ];

    // ì§„í–‰ ìƒíƒœ ì €ì¥: stageâ†’bundleâ†’done(í‰ê°€ì™„ë£Œ) + ê²°ê³¼
    const progress = {};
    STAGES.forEach(s => {
      progress[s.idx] = {};
      BUNDLES.forEach(b => progress[s.idx][b.key] = { done:false, result:null, recording:null });
    });

    /* ====== ì˜¤ë””ì˜¤(TTS) ====== */
    const VOICE_MAP = {
      openai: { default:'alloy', alloy:'alloy', shimmer:'verse' },
      google: { default:'ko-KR-Standard-A', alloy:'ko-KR-Standard-A', shimmer:'ko-KR-Standard-B' }
    };
    function mapVoice(provider, req){ const t = VOICE_MAP[provider]||{}; return t[req] || t.default || req; }
    function base64ToBlob(base64, mime='audio/mpeg'){
      const cleaned = base64.includes(',') ? base64.split(',')[1] : base64;
      const byteChars = atob(cleaned);
      const arr = new Uint8Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) arr[i]=byteChars.charCodeAt(i);
      return new Blob([arr],{type:mime});
    }
    let currentAudio=null, audioLock=false, aborter=null;
    async function playTTS(text, voice='alloy', speed=1.0, btn){
      if(audioLock){ if(currentAudio){ if(currentAudio.paused){ await currentAudio.play(); setBtnPlaying(btn,true);} else { currentAudio.pause(); setBtnPlaying(btn,false);} } return; }
      audioLock=true; setTimeout(()=>audioLock=false,200);
      try{
        if(currentAudio && currentAudio._meta === `${text}|${speed}|${voice}`){
          if(currentAudio.paused){ await currentAudio.play(); setBtnPlaying(btn,true);} else { currentAudio.pause(); setBtnPlaying(btn,false); }
          return;
        }
        if(aborter){ try{aborter.abort();}catch{} }
        if(currentAudio){ try{currentAudio.pause();}catch{} }
        aborter = new AbortController();
        const provider = (window.PONGDANG_TTS?.provider) || 'openai';
        const payload = { text, voice: mapVoice(provider, voice), provider, speed };
        const res = await fetch(`${FN_BASE}/generate-audio`, { method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'}, body:JSON.stringify(payload), signal:aborter.signal });
        if(!res.ok) throw new Error('TTS fail '+res.status);
        const data = await res.json();
        let src = null;
        if(data.audioBase64 || data.audioContent){
          const blob = base64ToBlob(data.audioBase64 || data.audioContent, data.mimeType || 'audio/mpeg');
          src = URL.createObjectURL(blob);
        } else if (data.audioUrl){ src = data.audioUrl; }
        const audio = new Audio(src); currentAudio = audio; audio._meta = `${text}|${speed}|${voice}`;
        audio.addEventListener('playing', ()=>setBtnPlaying(btn,true));
        audio.addEventListener('pause',   ()=>setBtnPlaying(btn,false));
        audio.addEventListener('ended',   ()=>setBtnPlaying(btn,false));
        await audio.play();
      }catch(e){ alert('ì˜¤ë””ì˜¤ ìƒì„±/ì¬ìƒì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); }
    }
    function setBtnPlaying(btn, on){ if(!btn) return; btn.innerHTML = on ? '<i class="fas fa-pause"></i> Pause' : '<i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)'; }

    /* ====== Pronun mount ====== */
    function mountPronun(container, refText, onAfterEvaluate){
      if(!(window.Pronun && container)) return;
      Pronun.mount(container, {
        getReferenceText: () => refText,
        isKoCorrect: () => true, // ì›Œë°ì—…ì€ ì •ë‹µ ì¼ì¹˜ ì²´í¬ ì—†ìŒ(ë°œìŒ í’ˆì§ˆë§Œ)
        onResult: (r) => {
          // r êµ¬ì¡°ëŠ” pronun-client.js ë°˜í™˜ê°’ì— ë”°ë¦„
          try{
            onAfterEvaluate?.(r);
          }catch(_){}
        }
      });
      // â€œì „ì‚¬/ìˆ«ìì¹˜í™˜â€ í…ìŠ¤íŠ¸ ë…¸ì¶œ ë°©ì§€(ì¼ë¶€ í´ë¼ì—ì„œ ìë™ ìˆ¨ê¹€ ì˜µì…˜ ë¯¸ì§€ì› ëŒ€ë¹„)
      scrubSensitive(container);
    }
    function scrubSensitive(root){
      const bad = ['ì „ì‚¬','transcription','transcrit','numeric'];
      const sweep = () => {
        root.querySelectorAll('*').forEach(node=>{
          node.childNodes?.forEach(ch=>{
            if(ch.nodeType===3){
              const t = (ch.textContent||'').toLowerCase();
              if(bad.some(k=>t.includes(k))) ch.textContent = '';
            }
          });
        });
      };
      sweep();
      new MutationObserver(sweep).observe(root, { childList:true, subtree:true });
    }

    /* ====== ìŠ¤í…Œì´ì§€ UI ìƒì„± ====== */
    function stripCommas(text){ return text.replace(/,\s*/g,' '); }

    function makeBundleCard(stage, bundle){
      const wrap = document.createElement('div');
      wrap.className = 'wu-card';
      wrap.id = `stage-${stage.idx}-${bundle.key}`;

      const text = stage.stripCommas ? stripCommas(bundle.text) : bundle.text;

      wrap.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="text-sm text-slate-500">${stage.title}</div>
            <div class="text-lg font-semibold">${bundle.label} <span class="text-slate-500">Â· ${text}</span></div>
            <div class="small-muted">Vitesse: ${stage.speed}x Â· ${stage.stripCommas ? 'sans virgules / ì‰¼í‘œ ì œê±°' : 'avec virgules / ì‰¼í‘œ í¬í•¨'}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-sound btn-play"><i class="fas fa-play"></i> Ã‰couter (ë“£ê¸°)</button>
            <span class="inline-flex items-center text-xs text-slate-500 gap-1">
              <i class="fa-solid fa-circle-info"></i> ë¨¼ì € ë“£ê³ , ì•„ë˜ì—ì„œ <b>ë…¹ìŒâ†’ë‚´ ë°œìŒ í‰ê°€</b>ë¥¼ ëˆ„ë¥´ì„¸ìš”
            </span>
          </div>
        </div>
        <div class="mt-3 p-3 rounded-lg border border-indigo-200 bg-indigo-50/60">
          <div class="text-sm text-slate-700 mb-2">ğŸ¤ Enregistrer & Ã‰valuer / ë…¹ìŒí•˜ê³  í‰ê°€í•˜ê¸°</div>
          <div class="pronun-host"></div>
          <div class="mt-2 text-sm text-slate-600 hidden status-line"></div>
        </div>
      `;

      // Play ë²„íŠ¼ ì—°ê²°
      wrap.querySelector('.btn-play').addEventListener('click', (e)=>{
        playTTS(text, bundle.voice, stage.speed, e.currentTarget);
      });

      // Pronun mount
      const host = wrap.querySelector('.pronun-host');
      const statusLine = wrap.querySelector('.status-line');
      mountPronun(host, text, (result)=>{
        // í‰ê°€ ì™„ë£Œë¡œ í‘œì‹œ
        progress[stage.idx][bundle.key].done = true;
        progress[stage.idx][bundle.key].result = result || null;
        // (ê°€ëŠ¥í•˜ë©´ ì˜¤ë””ì˜¤ base64ë„ ì €ì¥ â€” pronun-clientê°€ ì œê³µ ì‹œ)
        if(result?.audio?.base64){
          progress[stage.idx][bundle.key].recording = {
            base64: result.audio.base64,
            filename: `wu_stage${stage.idx+1}_${bundle.key}.webm`,
            mimeType: result.audio.mimeType || 'audio/webm',
            duration: result.audio.duration || null
          };
        }
        // UI ì—…ë°ì´íŠ¸
        wrap.classList.add('wu-done');
        statusLine.classList.remove('hidden');
        const p = Math.round((result?.accuracy || 0)*100);
        statusLine.innerHTML = `âœ… Ã‰valuÃ©: <b>${isFinite(p)?p:0}%</b> â€” ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•´ ì´ ë¬¶ìŒì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
        // ë‹¤ìŒ ë‹¨ê³„ ì˜¤í”ˆ ê²€ì‚¬
        checkStageUnlock(stage.idx);
      });

      return wrap;
    }

    function renderStage(stage){
      const wrap = document.createElement('section');
      wrap.id = `stage-${stage.idx}`;
      wrap.innerHTML = `
        <h3 class="text-xl font-bold text-slate-800 mb-3">${stage.title}</h3>
        <div class="space-y-4"></div>
      `;
      const list = wrap.querySelector('.space-y-4');
      BUNDLES.forEach(b => list.appendChild( makeBundleCard(stage, b) ));
      return wrap;
    }

    function checkStageUnlock(idx){
      const allDone = BUNDLES.every(b => progress[idx][b.key].done);
      if(!allDone) return;

      // ì§„í–‰ ì (on)
      const dot = document.querySelector(`.progress-dot[data-dot="${idx}"]`);
      dot?.classList.add('on');

      // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì˜¤í”ˆ
      const next = STAGES[idx+1];
      if(next){
        const nextEl = document.getElementById(`stage-${next.idx}`);
        if(nextEl) nextEl.classList.remove('hidden');
      }else{
        // ëª¨ë“  ìŠ¤í…Œì´ì§€ ì™„ë£Œ
        document.getElementById('finish-wrap')?.classList.remove('hidden');
      }
    }

    /* ====== ê²°ê³¼ ì „ì†¡ ====== */
    async function sendResults(){
      // ê²°ê³¼ í˜ì´ë¡œë“œ êµ¬ì„± (ê° bundleÃ—stageë¥¼ í•˜ë‚˜ì˜ "ë¬¸í•­"ì²˜ëŸ¼)
      const questions = [];
      STAGES.forEach(s=>{
        BUNDLES.forEach(b=>{
          const state = progress[s.idx][b.key];
          const text = s.stripCommas ? stripCommas(b.text) : b.text;
          const pronunciation = state.result ? {
            accuracy: state.result.accuracy || 0,
            tags: state.result.tags || [],
            friendly: state.result.friendly || []
          } : null;

          questions.push({
            number: `WU-${s.idx+1}-${b.key}`,
            type: 'warmup_pronun',
            fr: `${b.label} â€” ${s.title} â€” vitesse ${s.speed}x${s.stripCommas?' (sans virgules)':''}`,
            ko: text,
            userAnswer: '', // ì›Œë°ì—…ì€ í…ìŠ¤íŠ¸ ì •ë‹µ ì—†ìŒ
            isCorrect: true, // ì›Œë°ì—…: ì™„ë£Œ ê¸°ì¤€ì´ë¯€ë¡œ trueë¡œ ì²˜ë¦¬
            listenCount: 1,  // ìµœì†Œ 1íšŒ ë“£ê¸° ê°€ì •(ì§‘ê³„ í•„ìš” ì‹œ ì¡°ì •)
            hint1Count: 0,
            hint2Count: 0,
            pronunciation,
            recording: state.recording || null
          });
        });
      });

      const payload = {
        studentName: (document.getElementById('student-name')?.value || '').trim() || 'Ã‰lÃ¨ve',
        startTime: new Date().toISOString(), // í•„ìš” ì‹œ ë³„ë„ ì‹œì‘ì‹œê° ì €ì¥ ê°€ëŠ¥
        endTime: new Date().toISOString(),
        totalTimeSeconds: 0,
        assignmentTitle: 'Warming up 5Ã—5 â€“ Nombres corÃ©ens',
        assignmentTopic: 'Prononciation (vitesse 0.7â†’1.5)',
        assignmentSummary: [
          '4 paquets Ã— 5 Ã©tapes (0.7/1.0/1.2/1.5/1.5 sans virgules)',
          'Ã‰couter â†’ RÃ©pÃ©ter â†’ Enregistrer & Ã‰valuer'
        ],
        questions
      };

      try{
        const r = await fetch(`${FN_BASE}/send-results`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || j?.ok===false) throw new Error(j?.error || 'send-results failed');
        alert('ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! / EnvoyÃ© au professeur âœ”ï¸');
        document.getElementById('btn-next')?.classList.remove('hidden');
      }catch(e){
        console.error(e);
        alert('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    /* ====== ì´ˆê¸° ë Œë” ====== */
    document.addEventListener('DOMContentLoaded', ()=>{
      // ì´ë¦„ ì…ë ¥ì¹¸(ì„¤ëª… ì„¹ì…˜ ì•„ë˜ ê°„ë‹¨ ì…ë ¥) â€” í•„ìš”í•˜ë©´ ì¶”ê°€
      const nameBar = document.createElement('div');
      nameBar.className = 'quiz-container';
      nameBar.innerHTML = `
        <div class="max-w-3xl mx-auto">
          <label class="block text-sm font-semibold text-slate-700 mb-2">Nom de lâ€™Ã©lÃ¨ve (ì´ë¦„)</label>
          <div class="flex gap-2">
            <input id="student-name" class="flex-1 border-2 border-slate-300 rounded-lg p-3" placeholder="Ex. Camille / Lucas / ZoÃ©" />
            <button class="btn btn-ghost" onclick="document.getElementById('student-name').value = ''">Effacer</button>
          </div>
        </div>
      `;
      document.body.insertBefore(nameBar, document.querySelector('.quiz-container'));

      // ìŠ¤í…Œì´ì§€ ë Œë”
      const mount = document.getElementById('stages-wrap');
      STAGES.forEach((s, i)=>{
        const el = renderStage(s);
        if(i>0) el.classList.add('hidden'); // 1ë‹¨ê³„ë§Œ ì—´ê¸°
        mount.appendChild(el);
      });

      // ì™„ë£Œ ì „ì†¡ ë²„íŠ¼
      document.getElementById('btn-send')?.addEventListener('click', sendResults);
    });
  </script>
</body>
</html>
