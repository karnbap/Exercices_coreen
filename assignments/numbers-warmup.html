<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coréen — Nombres | Explications + Warming up</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Optional shared styles -->
  <link rel="stylesheet" href="../assets/style.css">

  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif; background:#f3f4f6;}
    .shell{max-width:1000px;margin:0 auto;padding:24px}
    .info-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;box-shadow:0 1px 2px rgba(16,24,40,.06)}
    .kicker{color:#64748b}
    .soft-divider{height:1px;margin:18px 0;background:linear-gradient(to right,transparent,#e5e7eb,transparent)}
    .btn{padding:.72rem 1.1rem;border-radius:.7rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-ghost{background:#e5e7eb;color:#374151}.btn-ghost:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .btn-next{background:#111827;color:#fff}.btn-next[disabled]{opacity:.5;cursor:not-allowed}
    .step-pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #e5e7eb;background:#fff;border-radius:9999px;padding:4px 10px;font-size:.85rem}
    .warm-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:16px}
    .warm-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .warm-title{font-weight:700;color:#111827}
    .warm-sub{color:#6b7280}
    .step-box{border:1px dashed #c7d2fe;background:#eef2ff;border-radius:12px;padding:12px;margin-top:12px}
    .result-chip{display:inline-flex;align-items:center;gap:6px;background:#ecfccb;color:#365314;border:1px solid #d9f99d;border-radius:9999px;padding:4px 10px;font-weight:600}
    .warn-chip{display:inline-flex;align-items:center;gap:6px;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:9999px;padding:4px 10px;font-weight:600}
    .brand-tag{position:fixed;right:16px;bottom:12px;font-size:12px;color:#9ca3af}
    .tiny{font-size:.82rem;color:#6b7280}
  </style>
</head>
<body>

  <!-- ======= Intro / Explications ======= -->
  <header class="shell">
    <div class="text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-2 leading-tight">Exercice : Les Nombres Coréens 🔢</h1>
      <p class="kicker mb-6">순수 한국어 / Natifs vs 한자어 / Hanja-coréens</p>
    </div>

    <div class="grid md:grid-cols-2 gap-5">
      <div class="info-card">
        <h3 class="font-bold text-lg mb-2">1️⃣ Petite explication / 간단 설명</h3>
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 text-yellow-900">
          👉 « 한자 = chinois(언어) »가 아니에요! Hanja = <b>문자 체계</b>, Chinois = <b>언어</b>.
        </div>
        <ul class="list-disc list-inside mt-3 space-y-1.5">
          <li><b>한자 (Hanja)</b> = système d’écriture</li>
          <li><b>Chinois</b> = langue</li>
        </ul>
      </div>

      <div class="info-card">
        <h3 class="font-bold text-lg mb-2">2️⃣ Deux systèmes / 두 가지 숫자</h3>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
            <div class="font-semibold text-blue-900">Natifs</div>
            <div class="text-xl font-bold">하나, 둘, 셋…</div>
            <div class="tiny">Âge, personnes, objets…</div>
          </div>
          <div class="p-3 rounded-lg bg-green-50 border border-green-200">
            <div class="font-semibold text-green-900">Hanja-coréens</div>
            <div class="text-xl font-bold">일, 이, 삼…</div>
            <div class="tiny">Dates, argent, minutes…</div>
          </div>
        </div>
      </div>

      <div class="info-card md:col-span-2">
        <h3 class="font-bold text-lg mb-2">⚡ Exception & Tendance</h3>
        <ul class="list-disc list-inside space-y-1.5">
          <li>Heures(시) → <b>natifs</b> · Minutes(분) → <b>Hanja-coréens</b></li>
          <li>« 1 h = 60 min » 체계 이후 : 시=natifs / 분=Hanja</li>
        </ul>
      </div>

      <div class="info-card md:col-span-2">
        <h3 class="font-bold text-lg mb-2">✅ Résumé / 요약</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse text-sm">
            <thead>
              <tr class="bg-slate-50">
                <th class="border border-slate-200 p-2">Système / 체계</th>
                <th class="border border-slate-200 p-2">Usage / 용도</th>
                <th class="border border-slate-200 p-2">Exemples / 예</th>
              </tr>
            </thead>
            <tbody>
              <tr class="odd:bg-white even:bg-gray-50">
                <td class="border border-slate-200 p-2 font-semibold">순수 한국어 / Natifs</td>
                <td class="border border-slate-200 p-2">Compter librement, classificateurs, durées libres</td>
                <td class="border border-slate-200 p-2">한 달, 두 달 / 한 개, 두 명, 세 잔, 한 권 / 한 시, 두 시</td>
              </tr>
              <tr class="odd:bg-white even:bg-gray-50">
                <td class="border border-slate-200 p-2 font-semibold">한자어 / Hanja-coréens</td>
                <td class="border border-slate-200 p-2">Valeurs « écrites » (calendrier, montre, monnaie…)</td>
                <td class="border border-slate-200 p-2">1월, 2월 / 10분, 30초 / 2025년 9월 7일, 1,000원 / 3층, 302호</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="soft-divider"></div>
  </header>

  <!-- ======= WARMING UP: Méthode 5×5 ======= -->
  <main class="shell">
    <div class="text-center mb-6">
      <h2 class="text-3xl font-bold text-slate-800 mb-2">Méthode 5×5 🗣️ / 5개씩 훈련법</h2>
      <p class="text-lg text-slate-600">Écouter → Répéter → <b>Enregistrer & Évaluer</b> / 듣고 따라 말한 뒤 <b>녹음·평가</b></p>
      <div class="tiny mt-2">Chaque item avance par étapes de vitesse: <b>0.7× → 1.0× → 1.2× → 1.5× → 1.5× (sans virgules)</b></div>
    </div>

    <!-- Cards (세로로 하나씩) -->
    <div id="warmup-list"></div>

    <!-- Finish -->
    <div class="text-center mt-8">
      <button id="finish-btn" class="btn btn-primary text-lg" disabled>✅ Terminer l’échauffement / 완료하기</button>
      <div id="finish-note" class="tiny mt-2 text-red-700">모든 항목의 마지막 단계까지 “내 발음 확인하기”를 해야 완료할 수 있어요.</div>
    </div>

    <!-- 결과 모달/영역 -->
    <div id="summary-panel" class="hidden mt-8">
      <div class="info-card">
        <h3 class="font-bold text-xl mb-2">Bilan de l’échauffement / 웜업 결과</h3>
        <div id="summary-body" class="space-y-2 text-sm"></div>
        <div class="flex gap-2 mt-4">
          <a href="./numbers-exercises.html" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Passer aux exercices (연습문제 시작)</a>
          <button class="btn btn-ghost" onclick="document.getElementById('summary-panel').classList.add('hidden')">Fermer</button>
        </div>
      </div>
    </div>
  </main>

  <div class="brand-tag">made by 성일, Pongdang · Lapeace29@gmail.com</div>

  <!-- Global config -->
  <script>
    window.PONGDANG_TTS   = window.PONGDANG_TTS   || { provider: 'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
    window.PRONUN_OPTIONS = { hideTranscript: true, hideNumericSwap: true }; // ‘전사’ 등 문구 숨김 옵션 힌트
  </script>

  <!-- Pronunciation client (VU 파형/평가) -->
  <script src="../assets/pronun-utils.js"></script>
  <script src="../assets/pronun-vowel-middleware.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    /* ========= Data ========= */
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

    const ITEMS = [
      { id:'wu1', title:'Natifs (1–5)',   sub:'하나, 둘, 셋, 넷, 다섯', voice:'alloy',  text:'하나, 둘, 셋, 넷, 다섯' },
      { id:'wu2', title:'Natifs (6–10)',  sub:'여섯, 일곱, 여덟, 아홉, 열', voice:'shimmer', text:'여섯, 일곱, 여덟, 아홉, 열' },
      { id:'wu3', title:'Hanja (1–5)',   sub:'일, 이, 삼, 사, 오', voice:'alloy', text:'일, 이, 삼, 사, 오' },
      { id:'wu4', title:'Hanja (6–10)',  sub:'육, 칠, 팔, 구, 십', voice:'alloy', text:'육, 칠, 팔, 구, 십' },
    ];

    const TRAIN_STEPS = [
      { key:'s0', label:'0.7×', speed:0.7, strip:false, desc:'Écouter (0.7×) → Répéter → Enregistrer' },
      { key:'s1', label:'1.0×', speed:1.0, strip:false, desc:'Écouter (1.0×) → Répéter → Enregistrer' },
      { key:'s2', label:'1.2×', speed:1.2, strip:false, desc:'Écouter (1.2×) → Répéter → Enregistrer' },
      { key:'s3', label:'1.5×', speed:1.5, strip:false, desc:'Écouter (1.5×) → Répéter → Enregistrer' },
      { key:'s4', label:'1.5×, sans virgules', speed:1.5, strip:true,  desc:'Écouter (1.5×, sans virgules) → Répéter → Enregistrer' },
    ];

    // 상태: 각 아이템별 현재 step index 및 step 결과
    const warmupState = ITEMS.map(item => ({
      id: item.id,
      stepIndex: 0,
      steps: TRAIN_STEPS.map(() => ({ result:null, verified:false, percent:null })),
    }));

    /* ========= Audio (TTS) ========= */
    const VOICE_MAP = {
      openai: { default: "alloy", alloy: "alloy", shimmer: "verse" },
      google: { default: "ko-KR-Standard-A", alloy: "ko-KR-Standard-A", shimmer: "ko-KR-Standard-B" }
    };
    const mapVoice=(p,v)=> (VOICE_MAP[p]||{})[v] || (VOICE_MAP[p]||{}).default || v;
    let currentAudio=null, currentBlobUrl=null, currentFetchAbort=null, audioBusy=false;

    function base64ToBlob(b64,mime='audio/mpeg'){
      const c=b64.includes(',')?b64.split(',')[1]:b64;
      const s=atob(c); const a=new Uint8Array(s.length);
      for(let i=0;i<s.length;i++) a[i]=s.charCodeAt(i);
      return new Blob([a],{type:mime});
    }
    function cleanupAudio(){
      if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } currentAudio=null; }
      if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl=null; }
    }
    function removeCommas(txt){ return String(txt).replace(/,\s*/g,' '); }

    async function playTTS(text, voice, speed, btn){
      if(audioBusy){ if(currentAudio){ try{ currentAudio.pause(); }catch(_){ } } return; }
      audioBusy=true;
      btn && (btn.disabled = true);
      try{
        cleanupAudio();
        currentFetchAbort?.abort?.();
        const ac=new AbortController(); currentFetchAbort=ac;

        const provider=(window.PONGDANG_TTS?.provider)||'openai';
        const payload={ text, voice: mapVoice(provider,voice), provider, speed };
        const res=await fetch(`${FN_BASE}/generate-audio`,{
          method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
          body:JSON.stringify(payload), signal:ac.signal
        });
        if(!res.ok){ throw new Error('TTS '+res.status); }
        const data=await res.json();

        let src=null;
        if(data.audioBase64||data.audioContent){
          const blob=base64ToBlob(data.audioBase64||data.audioContent,data.mimeType||'audio/mpeg');
          src=URL.createObjectURL(blob); currentBlobUrl=src;
        }else if(data.audioUrl){ src=data.audioUrl; }

        const audio=new Audio(src); currentAudio=audio;
        await audio.play();
        audio.addEventListener('ended', ()=>{ btn && (btn.disabled=false); });
      }catch(e){
        alert('오디오 재생 오류가 발생했습니다. 다시 시도해 주세요.');
        btn && (btn.disabled=false);
      }finally{
        audioBusy=false;
      }
    }

    /* ========= Pronun UI mount & helpers ========= */
    function scrubPronun(container){
      if(!container) return;
      const killWords=['전사','transcription','transcrit'];
      const sweep=()=>{
        container.querySelectorAll('*').forEach(n=>{
          n.childNodes?.forEach?.(c=>{
            if(c.nodeType===3 && killWords.some(k=>c.textContent?.toLowerCase().includes(k))){
              c.textContent='';
            }
          });
        });
      };
      sweep();
      new MutationObserver(sweep).observe(container,{childList:true,subtree:true});
    }

    function extractPercent(result){
      // pronun-client 결과에서 퍼센트 추정
      const cand = (
        result?.score?.overall ??
        result?.overall ??
        result?.accuracy ??
        result?.similarity ??
        result?.score
      );
      if(typeof cand === 'number'){
        if(cand<=1) return Math.round(cand*100);
        if(cand<=100) return Math.round(cand);
      }
      // 못 찾으면 100은 과하고 0은 허무하니 80으로 보수적 표기
      return 80;
    }

    /* ========= Render ========= */
    function renderWarmup(){
      const host = document.getElementById('warmup-list');
      host.innerHTML = '';

      ITEMS.forEach((item, idx)=>{
        const st = warmupState[idx];
        const stepIdx = st.stepIndex;
        const step = TRAIN_STEPS[stepIdx];

        const card = document.createElement('section');
        card.className = 'warm-card';

        const header = document.createElement('div');
        header.className = 'warm-head';
        header.innerHTML = `
          <div>
            <div class="warm-title">${item.title}</div>
            <div class="warm-sub tiny">${item.sub}</div>
          </div>
          <div class="step-pill"><i class="fas fa-bolt"></i> Étape ${stepIdx+1}/5 · ${step.label}</div>
        `;
        card.appendChild(header);

        // Step box
        const box = document.createElement('div');
        box.className = 'step-box';
        const displayText = step.strip ? removeCommas(item.text) : item.text;

        box.innerHTML = `
          <div class="mb-2 text-sm text-slate-700">
            <b>${step.label}</b> — ${step.desc}<br>
            <span class="tiny">FR: Appuie sur “Écouter”, répète à voix haute, puis enregistre et <b>clique “Vérifier ma prononciation”</b>.<br>
            KR: “듣기” → 따라 말하기 → <b>녹음</b> → <b>내 발음 확인하기</b>를 누르세요.</span>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <button class="btn btn-sound" id="${item.id}-listen"><i class="fas fa-play"></i> Écouter (듣기)</button>
            <span class="tiny text-slate-500">Texte KO: <b>${displayText}</b></span>
          </div>

          <!-- Pronun mount -->
          <div id="${item.id}-mount" class="mt-2"></div>

          <div class="mt-3 flex flex-wrap items-center gap-2">
            <button class="btn btn-ghost" id="${item.id}-check"><i class="fas fa-check-circle"></i> Vérifier ma prononciation / 내 발음 확인하기</button>
            <span id="${item.id}-score" class="tiny"></span>
          </div>

          <div class="mt-3">
            <button class="btn btn-next" id="${item.id}-next" disabled>Étape suivante (다음 속도)</button>
          </div>
        `;
        card.appendChild(box);

        // Past steps chips
        const doneWrap = document.createElement('div');
        doneWrap.className = 'mt-3 flex flex-wrap gap-2';
        st.steps.forEach((s, i)=>{
          if(i<stepIdx){
            const chip = document.createElement('span');
            chip.className = 'result-chip';
            const lab = TRAIN_STEPS[i]?.label || `v${i}`;
            chip.innerHTML = `<i class="fas fa-check"></i> ${lab}: ${s.percent ?? '--'}%`;
            doneWrap.appendChild(chip);
          }
        });
        if(doneWrap.childNodes.length) card.appendChild(doneWrap);

        host.appendChild(card);

        // Wire buttons
        document.getElementById(`${item.id}-listen`).onclick = (e)=> playTTS(displayText, item.voice, step.speed, e.currentTarget);

        // Mount Pronun UI (VU graph 내장)
        const mount = document.getElementById(`${item.id}-mount`);
        if(mount && window.Pronun){
          try{
            Pronun.mount(mount, {
              getReferenceText: () => displayText,
              isKoCorrect: () => true,
              onResult: (r) => {
                // 최신 결과 저장만 하고, '확인' 버튼을 눌러야 검증 완료로 처리
                st.steps[stepIdx].result = r;
                scrubPronun(mount);
              }
            });
            scrubPronun(mount);
          }catch(e){ console.warn('Pronun.mount error', e); }
        }

        // Verify button
        document.getElementById(`${item.id}-check`).onclick = ()=>{
          const r = st.steps[stepIdx].result;
          const scoreEl = document.getElementById(`${item.id}-score`);
          if(!r){
            scoreEl.innerHTML = `<span class="warn-chip"><i class="fas fa-triangle-exclamation"></i> D’abord, enregistre puis Arrêter!</span>`;
            return;
          }
          const pct = extractPercent(r);
          st.steps[stepIdx].percent = pct;
          st.steps[stepIdx].verified = true;
          scoreEl.innerHTML = `<span class="result-chip"><i class="fas fa-gauge-high"></i> ${pct}% · Bien fait!</span> <span class="tiny text-slate-500">FR/KR: Prononciation évaluée.</span>`;
          document.getElementById(`${item.id}-next`).disabled = false;
          // “완료” 버튼 사용 가능성 갱신
          updateFinishEnabled();
        };

        // Next step button
        document.getElementById(`${item.id}-next`).onclick = ()=>{
          // 현 단계 검증 체크
          if(!st.steps[stepIdx].verified) return;
          if(st.stepIndex < TRAIN_STEPS.length-1){
            st.stepIndex++;
            renderWarmup();
          }else{
            // 이 아이템은 전부 완료됨
            renderWarmup();
          }
        };
      });

      updateFinishEnabled();
    }

    function isAllDone(){
      return warmupState.every(st => st.stepIndex >= TRAIN_STEPS.length-1 && st.steps[TRAIN_STEPS.length-1].verified);
    }
    function updateFinishEnabled(){
      const done = isAllDone();
      const btn = document.getElementById('finish-btn');
      const note = document.getElementById('finish-note');
      btn.disabled = !done;
      note.style.display = done ? 'none' : 'block';
    }

    /* ========= Send results & summary ========= */
    async function sendWarmupResults(){
      const payload = {
        kind: 'warmup-5x5',
        createdAt: new Date().toISOString(),
        items: ITEMS.map((it, idx)=>({
          id: it.id,
          title: it.title,
          text: it.text,
          steps: warmupState[idx].steps.map((s, i)=>({
            label: TRAIN_STEPS[i].label,
            speed: TRAIN_STEPS[i].speed,
            stripped: TRAIN_STEPS[i].strip,
            percent: s.percent,
            verified: s.verified
          }))
        }))
      };
      try{
        const res = await fetch(`${FN_BASE}/send-results`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ studentName: '(warmup)', ...payload })
        });
        if(!res.ok){ throw new Error('send-results '+res.status); }
      }catch(e){
        console.warn('send-results failed', e);
      }
    }

    function showSummary(){
      const box = document.getElementById('summary-body');
      box.innerHTML = '';
      ITEMS.forEach((it, idx)=>{
        const row = document.createElement('div');
        const percents = warmupState[idx].steps.map(s=> s.percent ?? 0);
        const avg = Math.round( percents.reduce((a,b)=>a+b,0) / percents.length );
        const chips = warmupState[idx].steps.map((s,i)=>`<span class="result-chip"><i class="fas fa-check"></i> ${TRAIN_STEPS[i].label}: ${s.percent ?? '--'}%</span>`).join(' ');
        row.innerHTML = `
          <div class="font-semibold mb-1">${it.title} <span class="tiny text-slate-500">(${it.sub})</span></div>
          <div class="tiny mb-1">Moyenne / 평균: <b>${isNaN(avg)?'--':avg}%</b></div>
          <div class="flex flex-wrap gap-2">${chips}</div>
        `;
        box.appendChild(row);
      });
      document.getElementById('summary-panel').classList.remove('hidden');
    }

    /* ========= Init ========= */
    document.addEventListener('DOMContentLoaded', ()=>{
      renderWarmup();

      document.getElementById('finish-btn').onclick = async ()=>{
        if(!isAllDone()) return;
        await sendWarmupResults();
        showSummary();
      };
    });
  </script>
</body>
</html>
