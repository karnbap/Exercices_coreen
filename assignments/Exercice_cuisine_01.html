<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exercices d'Ã©coute en CorÃ©en (20 Questions)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Roboto','Noto Sans KR',sans-serif;background:#f0f2f5}
    .audio-btn{transition:all .3s ease}
    .audio-btn:hover{transform:scale(1.06);background:#4a5568}
    .audio-btn.loading{cursor:not-allowed;background:#a0aec0;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .box{transition:max-height .4s ease,opacity .3s ease;max-height:0;opacity:0;overflow:hidden}
    .box.show{max-height:220px;opacity:1}
    .particle-btn{transition:all .2s ease}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">
  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
    <header class="mb-6 border-b pb-4">
      <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 text-center">Exercices d'Ã©coute en CorÃ©en (ë“£ê¸° ì—°ìŠµ)</h1>
      <p class="text-gray-600 mt-2 text-center">20 questions. Utilisez ğŸ”Š pour Ã©couter. Appuyez sur <span class="font-semibold">Indice</span> si besoin. Ã€ la fin, cliquez <span class="font-semibold">Terminer / ëë‚´ê¸°</span> pour voir la note et envoyer au professeur.</p>

      <!-- Ã‰lÃ¨ve info -->
      <div class="mt-5 bg-yellow-50 rounded-xl p-4 grid gap-3 md:grid-cols-3">
        <input id="student_name" class="border rounded-lg p-2" placeholder="Nom de l'Ã©lÃ¨ve (optionnel)">
        <input id="student_email" class="border rounded-lg p-2" placeholder="Email de l'Ã©lÃ¨ve (optionnel)">
        <input id="teacher_email" class="border rounded-lg p-2" placeholder="Email du professeur (ignorÃ© si le serveur ne l'utilise pas)">
      </div>
    </header>

    <!-- Exercice 1 : ComplÃ©tez -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-4 text-gray-700 border-l-4 border-indigo-500 pl-4">Exercice 1 : ComplÃ©tez la phrase (ë¹ˆì¹¸ ì±„ìš°ê¸°)</h2>
      <div class="space-y-6">
        <!-- Q1 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">1. Ã‰coutez et complÃ©tez la question.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q1" data-text="í”„ë‘ìŠ¤ ì‚¬ëŒë“¤ì€ ë­ë¥¼ ìì£¼ ë¨¹ì–´ìš”?">ğŸ”Š</button>
            <p class="text-xl font-medium">í”„ë‘ìŠ¤ ì‚¬ëŒë“¤ì€
              <input type="text" id="q1_input" class="border-b-2 border-gray-300 focus:border-indigo-500 outline-none w-24 text-center bg-transparent">
              ìì£¼ ë¨¹ì–´ìš”?
            </p>
            <button class="hint-btn ml-auto bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded" data-target="q1_hint">Indice</button>
          </div>
          <div id="q1_hint" class="box mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Mot interrogatif Â« quoi Â» + particule objet (~ë¥¼).<br>KO) ì˜ë¬¸ì‚¬(ë¬´ì—‡) + ëª©ì ê²© ì¡°ì‚¬(~ë¥¼) ì¡°í•©ì„ ìƒê°í•´ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q2 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">2. Ã‰coutez et complÃ©tez la phrase nÃ©gative.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q2" data-text="ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚¬ì–´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì €ëŠ” ì¹œêµ¬ë¥¼
              <input type="text" id="q2_input" class="border-b-2 border-gray-300 focus:border-indigo-500 outline-none w-32 text-center bg-transparent">.
            </p>
            <button class="hint-btn ml-auto bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded" data-target="q2_hint">Indice</button>
          </div>
          <div id="q2_hint" class="box mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) NÃ©gation avec Â«Â ì•ˆÂ Â» + verbe au passÃ© poli (~ì•˜/ì—ˆì–´ìš”).<br>KO) ë¶€ì •í˜• <b>ì•ˆ + ë™ì‚¬</b> + ê³¼ê±° ì¡´ëŒ“ë§(~ì•˜/ì—ˆì–´ìš”) í˜•íƒœ.
          </div>
        </div>

        <!-- Q3 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">3. Ã‰coutez et complÃ©tez avec le nom.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q3" data-text="ì €ëŠ” ìŒ€ì„ ìì£¼ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì €ëŠ”
              <input type="text" id="q3_input" class="border-b-2 border-gray-300 focus:border-indigo-500 outline-none w-16 text-center bg-transparent">ì„ ìì£¼ ë¨¹ì–´ìš”.
            </p>
            <button class="hint-btn ml-auto bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded" data-target="q3_hint">Indice</button>
          </div>
          <div id="q3_hint" class="box mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Nom corÃ©en pour Â«Â rizÂ Â», 1 syllabe (aliment de base).<br>KO) í•œêµ­ì–´ë¡œ â€˜ìŒ€â€™ì„ ëœ»í•˜ëŠ” 1ìŒì ˆ ëª…ì‚¬ â€” ë°œìŒì„ ë– ì˜¬ë ¤ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q4 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">4. Ã‰coutez et complÃ©tez avec l'adverbe.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q4" data-text="í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼
              <input type="text" id="q4_input" class="border-b-2 border-gray-300 focus:border-indigo-500 outline-none w-20 text-center bg-transparent"> ë¨¹ì–´ìš”.
            </p>
            <button class="hint-btn ml-auto bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded" data-target="q4_hint">Indice</button>
          </div>
          <div id="q4_hint" class="box mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Adverbe de frÃ©quence signifiant Â«Â souventÂ Â», 2 syllabes.<br>KO) ë¹ˆë„ ë¶€ì‚¬, ì˜ë¯¸ëŠ” â€˜ìì£¼â€™, 2ìŒì ˆ â€” ì² ìë¥¼ ê¸°ì–µí•´ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q5 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">5. Ã‰coutez et complÃ©tez avec le verbe.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q5" data-text="ì €ëŠ” ì‹ë‹¹ì— ë“¤ì–´ê°€ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì €ëŠ” ì‹ë‹¹ì—
              <input type="text" id="q5_input" class="border-b-2 border-gray-300 focus:border-indigo-500 outline-none w-28 text-center bg-transparent">.
            </p>
            <button class="hint-btn ml-auto bg-indigo-500 hover:bg-indigo-600 text-white text-sm px-3 py-1.5 rounded" data-target="q5_hint">Indice</button>
          </div>
          <div id="q5_hint" class="box mt-3 p-3 bg-indigo-100 text-indigo-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Verbe de mouvement Â«Â entrerÂ Â», forme polie au prÃ©sent (~ì•„ìš”).<br>KO) ì´ë™ ë™ì‚¬ â€˜ë“¤ì–´ê°€ë‹¤â€™ì˜ í˜„ì¬ ì¡´ëŒ“ë§ í™œìš©(~ì•„ìš”)ì„ ë– ì˜¬ë¦¬ì„¸ìš”.
          </div>
        </div>
      </div>
    </section>

    <!-- Exercice 2 : Particules -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-4 text-gray-700 border-l-4 border-cyan-500 pl-4">Exercice 2 : Choisissez la bonne particule (ì¡°ì‚¬ ì„ íƒí•˜ê¸°)</h2>
      <div class="space-y-6">
        <!-- Q6 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">6. Ã‰coutez et choisissez la particule pour "et".</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q6" data-text="ê¹€ì¹˜ì™€ ë¼ì§€ê³ ê¸°ê°€ ë“¤ì–´ê°€ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ê¹€ì¹˜<span id="q6_blank" class="font-bold text-cyan-600">__</span> ë¼ì§€ê³ ê¸°ê°€ ë“¤ì–´ê°€ìš”.</p>
            <button class="hint-btn ml-auto bg-cyan-500 hover:bg-cyan-600 text-white text-sm px-3 py-1.5 rounded" data-target="q6_hint">Indice</button>
          </div>
          <div class="flex gap-4 mt-4" id="q6_options">
            <button onclick="checkParticle('q6','ì™€')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ì™€</button>
            <button onclick="checkParticle('q6','ê³¼')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ê³¼</button>
          </div>
          <div id="q6_hint" class="box mt-3 p-3 bg-cyan-100 text-cyan-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) AprÃ¨s voyelle â†’ Â«Â ì™€Â Â», aprÃ¨s consonne â†’ Â«Â ê³¼Â Â».<br>KO) ëª¨ìŒ ë’¤ì—ëŠ” â€˜ì™€â€™, ììŒ ë’¤ì—ëŠ” â€˜ê³¼â€™. ì•ë§ì˜ ë°›ì¹¨ ìœ ë¬´ë¥¼ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q7 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">7. Ã‰coutez et choisissez la particule de sujet.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q7" data-text="ì œ ì¹œêµ¬ê°€ ì˜í™”ë¥¼ ë´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì œ ì¹œêµ¬<span id="q7_blank" class="font-bold text-cyan-600">__</span> ì˜í™”ë¥¼ ë´ìš”.</p>
            <button class="hint-btn ml-auto bg-cyan-500 hover:bg-cyan-600 text-white text-sm px-3 py-1.5 rounded" data-target="q7_hint">Indice</button>
          </div>
          <div class="flex gap-4 mt-4" id="q7_options">
            <button onclick="checkParticle('q7','ë¥¼')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ë¥¼</button>
            <button onclick="checkParticle('q7','ê°€')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ê°€</button>
          </div>
          <div id="q7_hint" class="box mt-3 p-3 bg-cyan-100 text-cyan-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Particule du sujet Â«Â ì´/ê°€Â Â» (aprÃ¨s voyelle â†’ ê°€).<br>KO) ì£¼ì–´ í‘œì§€ â€˜ì´/ê°€â€™ â€” ëª¨ìŒ ë’¤ì—ëŠ” â€˜ê°€â€™. ì£¼ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          </div>
        </div>

        <!-- Q8 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">8. Ã‰coutez et choisissez la particule de thÃ¨me.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q8" data-text="í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">í•œêµ­ ì‚¬ëŒ<span id="q8_blank" class="font-bold text-cyan-600">__</span> ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”.</p>
            <button class="hint-btn ml-auto bg-cyan-500 hover:bg-cyan-600 text-white text-sm px-3 py-1.5 rounded" data-target="q8_hint">Indice</button>
          </div>
          <div class="flex gap-4 mt-4" id="q8_options">
            <button onclick="checkParticle('q8','ì€')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ì€</button>
            <button onclick="checkParticle('q8','ëŠ”')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ëŠ”</button>
          </div>
          <div id="q8_hint" class="box mt-3 p-3 bg-cyan-100 text-cyan-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) ThÃ¨me Â«Â ì€/ëŠ”Â Â» (aprÃ¨s consonne â†’ ì€).<br>KO) ì£¼ì œ í‘œì§€ â€˜ì€/ëŠ”â€™ â€” ììŒ ë’¤ì—ëŠ” â€˜ì€â€™. ì• ë‚±ë§ì˜ ë°›ì¹¨ í™•ì¸.
          </div>
        </div>

        <!-- Q9 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">9. Ã‰coutez et choisissez la particule d'objet (COD).</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q9" data-text="ì €ëŠ” ë°¥ì„ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì €ëŠ” ë°¥<span id="q9_blank" class="font-bold text-cyan-600">__</span> ë¨¹ì–´ìš”.</p>
            <button class="hint-btn ml-auto bg-cyan-500 hover:bg-cyan-600 text-white text-sm px-3 py-1.5 rounded" data-target="q9_hint">Indice</button>
          </div>
          <div class="flex gap-4 mt-4" id="q9_options">
            <button onclick="checkParticle('q9','ì„')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ì„</button>
            <button onclick="checkParticle('q9','ë¥¼')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ë¥¼</button>
          </div>
          <div id="q9_hint" class="box mt-3 p-3 bg-cyan-100 text-cyan-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Objet direct Â«Â ì„/ë¥¼Â Â» (aprÃ¨s consonne â†’ ì„, aprÃ¨s voyelle â†’ ë¥¼).<br>KO) ëª©ì ê²© ì¡°ì‚¬ â€˜ì„/ë¥¼â€™ â€” ììŒ ë’¤ â€˜ì„â€™, ëª¨ìŒ ë’¤ â€˜ë¥¼â€™. ì•ë§ í˜•íƒœë¥¼ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q10 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">10. Ã‰coutez et choisissez la particule de lieu/destination.</p>
          <div class="flex items-center gap-4">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q10" data-text="ì €ëŠ” ì§‘ì— ë“¤ì–´ê°€ìš”.">ğŸ”Š</button>
            <p class="text-xl font-medium">ì €ëŠ” ì§‘<span id="q10_blank" class="font-bold text-cyan-600">__</span> ë“¤ì–´ê°€ìš”.</p>
            <button class="hint-btn ml-auto bg-cyan-500 hover:bg-cyan-600 text-white text-sm px-3 py-1.5 rounded" data-target="q10_hint">Indice</button>
          </div>
          <div class="flex gap-4 mt-4" id="q10_options">
            <button onclick="checkParticle('q10','ì—')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ì—</button>
            <button onclick="checkParticle('q10','ì—ì„œ')" class="particle-btn flex-1 bg-gray-200 hover:bg-cyan-200 text-gray-800 font-bold py-2 px-4 rounded">ì—ì„œ</button>
          </div>
          <div id="q10_hint" class="box mt-3 p-3 bg-cyan-100 text-cyan-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Destination (mouvement) â†’ Â«Â ì—Â Â» ; lieu dâ€™action â†’ Â«Â ì—ì„œÂ Â».<br>KO) ì´ë™/ë„ì°©ì€ â€˜ì—â€™, í™œë™ ì¥ì†ŒëŠ” â€˜ì—ì„œâ€™. ë™ì‚¬ ì„±ê²©ì„ ë³´ì„¸ìš”.
          </div>
        </div>
      </div>
    </section>

    <!-- Exercice 3 : Vrai/Faux -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-4 text-gray-700 border-l-4 border-green-500 pl-4">Exercice 3 : Vrai ou Faux (O/X í€´ì¦ˆ)</h2>
      <div class="space-y-6">
        <!-- Q11 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">11. Ã‰coutez la question. L'affirmation est-elle la bonne traduction ?</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q11" data-text="ì˜ ë³´ì—¬ìš”?">ğŸ”Š</button>
            <p class="italic text-gray-600">Affirmation : "Tu me vois bien ?"</p>
            <button class="hint-btn ml-auto bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1.5 rounded" data-target="q11_hint">Indice</button>
          </div>
          <div class="flex gap-4" id="q11_options">
            <button onclick="checkTrueFalse('q11',true)" class="flex-1 bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded">Vrai (O)</button>
            <button onclick="checkTrueFalse('q11',false)" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-bold py-2 px-4 rounded">Faux (X)</button>
          </div>
          <div id="q11_hint" class="box mt-3 p-3 bg-green-100 text-green-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Â«Â bien voirÂ Â» correspond Ã  une tournure passive en corÃ©en.<br>KO) â€˜ì˜ ë³´ì´ë‹¤â€™ í‘œí˜„(ìˆ˜ë™í˜• ì˜ë¯¸)ì„ ë– ì˜¬ë ¤ ë³´ì„¸ìš”.
          </div>
        </div>

        <!-- Q12 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">12. Ã‰coutez la phrase. L'affirmation est-elle correcte ?</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q12" data-text="ì €ëŠ” ìŒ€ì„ ìì£¼ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="italic text-gray-600">Affirmation : "Je mange souvent des pÃ¢tes."</p>
            <button class="hint-btn ml-auto bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1.5 rounded" data-target="q12_hint">Indice</button>
          </div>
          <div class="flex gap-4" id="q12_options">
            <button onclick="checkTrueFalse('q12',true)" class="flex-1 bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded">Vrai (O)</button>
            <button onclick="checkTrueFalse('q12',false)" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-bold py-2 px-4 rounded">Faux (X)</button>
          </div>
          <div id="q12_hint" class="box mt-3 p-3 bg-green-100 text-green-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) On parle dâ€™un Â«Â grain/aliment de baseÂ Â» (riz), pas de pÃ¢tes.<br>KO) â€˜íŒŒìŠ¤íƒ€â€™ê°€ ì•„ë‹ˆë¼ í•œêµ­ì˜ ì£¼ì‹(ç±³)ì„ ê°€ë¦¬í‚¤ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤.
          </div>
        </div>

        <!-- Q13 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">13. Ã‰coutez la phrase. L'affirmation est-elle correcte ?</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q13" data-text="ì œ ì¹œêµ¬ê°€ ì¹œêµ¬ë“¤ì„ ì•ˆ ë§Œë‚¬ì–´ìš”.">ğŸ”Š</button>
            <p class="italic text-gray-600">Affirmation : "Mon ami a rencontrÃ© ses amis."</p>
            <button class="hint-btn ml-auto bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1.5 rounded" data-target="q13_hint">Indice</button>
          </div>
          <div class="flex gap-4" id="q13_options">
            <button onclick="checkTrueFalse('q13',true)" class="flex-1 bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded">Vrai (O)</button>
            <button onclick="checkTrueFalse('q13',false)" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-bold py-2 px-4 rounded">Faux (X)</button>
          </div>
          <div id="q13_hint" class="box mt-3 p-3 bg-green-100 text-green-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Faites attention Ã  la nÃ©gation (ì•ˆ + verbe).<br>KO) ë¶€ì • í‘œí˜„ â€˜ì•ˆ + ë™ì‚¬â€™ë¥¼ ì²´í¬í•˜ì„¸ìš”.
          </div>
        </div>

        <!-- Q14 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">14. Ã‰coutez la phrase. L'affirmation est-elle correcte ?</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q14" data-text="í”„ë‘ìŠ¤ ì‚¬ëŒë“¤ì€ ë°”ê²ŒíŠ¸ë¥¼ ê°€ë” ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <p class="italic text-gray-600">Affirmation : "Les FranÃ§ais mangent parfois de la baguette."</p>
            <button class="hint-btn ml-auto bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1.5 rounded" data-target="q14_hint">Indice</button>
          </div>
          <div class="flex gap-4" id="q14_options">
            <button onclick="checkTrueFalse('q14',true)" class="flex-1 bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded">Vrai (O)</button>
            <button onclick="checkTrueFalse('q14',false)" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-bold py-2 px-4 rounded">Faux (X)</button>
          </div>
          <div id="q14_hint" class="box mt-3 p-3 bg-green-100 text-green-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Adverbe qui signifie Â«Â parfoisÂ Â».<br>KO) â€˜ê°€ë”â€™ì„ ë– ì˜¬ë¦¬ê²Œ í•˜ëŠ” ì˜ë¯¸ â€” ë¹ˆë„ ë¶€ì‚¬ì…ë‹ˆë‹¤.
          </div>
        </div>

        <!-- Q15 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">15. Ã‰coutez la phrase. L'affirmation est-elle correcte ?</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q15" data-text="ì €ëŠ” ì§‘ì— ë“¤ì–´ê°€ìš”.">ğŸ”Š</button>
            <p class="italic text-gray-600">Affirmation : "J'entre dans un restaurant."</p>
            <button class="hint-btn ml-auto bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1.5 rounded" data-target="q15_hint">Indice</button>
          </div>
          <div class="flex gap-4" id="q15_options">
            <button onclick="checkTrueFalse('q15',true)" class="flex-1 bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 px-4 rounded">Vrai (O)</button>
            <button onclick="checkTrueFalse('q15',false)" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-bold py-2 px-4 rounded">Faux (X)</button>
          </div>
          <div id="q15_hint" class="box mt-3 p-3 bg-green-100 text-green-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Le lieu Ã©voquÃ© est un domicile (pas un commerce).<br>KO) ì¥ì†ŒëŠ” â€˜ê±°ì£¼ì§€(ì§‘)â€™ ìª½ ì˜ë¯¸ì…ë‹ˆë‹¤ â€” ì‹ë‹¹ê³¼ êµ¬ë¶„í•´ ë³´ì„¸ìš”.
          </div>
        </div>
      </div>
    </section>

    <!-- Exercice 4 : DictÃ©e & Combinaison -->
    <section>
      <h2 class="text-2xl font-bold mb-4 text-gray-700 border-l-4 border-purple-500 pl-4">Exercice 4 : DictÃ©e et Combinaison (ë°›ì•„ì“°ê¸° ë° ë¬¸ì¥ ì—°ê²°)</h2>
      <div class="space-y-6">
        <!-- Q16 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">16. <strong>DictÃ©e :</strong> Ã‰coutez et Ã©crivez la phrase complÃ¨te.</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q16" data-text="ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ì•ˆ ë´¤ì–´ìš”.">ğŸ”Š</button>
            <input type="text" id="q16_input" class="w-full p-2 border-2 border-gray-300 rounded-md focus:border-purple-500 outline-none" placeholder="Ã‰crivez ce que vous entendez...">
            <button class="hint-btn ml-auto bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded" data-target="q16_hint">Indice</button>
          </div>
          <div id="q16_hint" class="box mt-3 p-3 bg-purple-100 text-purple-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) SchÃ©ma: A ne pas V et B ne pas V (coordination).<br>KO) íŒ¨í„´: A <b>ì•ˆ V</b>í•˜ê³  B <b>ì•ˆ V</b>í–ˆì–´ìš” â€” ë¶€ì • ì—°ê²° êµ¬ì¡°.
          </div>
        </div>

        <!-- Q17 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">17. <strong>DictÃ©e :</strong> Ã‰coutez et Ã©crivez la phrase complÃ¨te.</p>
          <div class="flex items-center gap-4 mb-3">
            <button class="audio-btn bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl" data-audio-id="q17" data-text="ê¹€ì¹˜í•˜ê³  ë°¥ì„ ê°™ì´ ë¨¹ì–´ìš”.">ğŸ”Š</button>
            <input type="text" id="q17_input" class="w-full p-2 border-2 border-gray-300 rounded-md focus:border-purple-500 outline-none" placeholder="Ã‰crivez ce que vous entendez...">
            <button class="hint-btn ml-auto bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded" data-target="q17_hint">Indice</button>
          </div>
          <div id="q17_hint" class="box mt-3 p-3 bg-purple-100 text-purple-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Conjonction pour lier deux noms + adverbe Â«Â ensembleÂ Â».<br>KO) ëª…ì‚¬ì™€ ëª…ì‚¬ë¥¼ ì‡ëŠ” ì¡°ì‚¬ + â€˜í•¨ê»˜â€™ë¥¼ ëœ»í•˜ëŠ” ë¶€ì‚¬ ì‚¬ìš©.
          </div>
        </div>

        <!-- Q18 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">18. <strong>Combinaison (-ê³ ) :</strong> Combinez les deux phrases.</p>
          <div class="mb-3"><p class="text-xl font-medium">Phrase 1 : ë¼ì§€ê³ ê¸°ë¥¼ ëƒ„ë¹„ì— ë„£ì–´ìš”.<br>Phrase 2 : ë³¶ì•„ìš”.</p></div>
          <div class="flex items-center gap-3">
            <input type="text" id="q18_input" class="w-full p-2 border-2 border-gray-300 rounded-md focus:border-purple-500 outline-none" placeholder="Combinez les deux phrases ici...">
            <button class="hint-btn ml-auto bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded" data-target="q18_hint">Indice</button>
          </div>
          <div id="q18_hint" class="box mt-3 p-3 bg-purple-100 text-purple-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) Utilisez la liaison verbale Â«Â -ê³ Â Â» : V1-ê³  V2.<br>KO) ë™ì‚¬ ì—°ê²° ì–´ë¯¸ â€˜-ê³ â€™ë¡œ ë‘ ë™ì‘ì„ ìˆœì„œëŒ€ë¡œ ì—°ê²°í•˜ì„¸ìš”.
          </div>
        </div>

        <!-- Q19 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">19. <strong>Combinaison (-ê³ ) :</strong> Combinez les deux phrases.</p>
          <div class="mb-3"><p class="text-xl font-medium">Phrase 1 : ì €ëŠ” ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.<br>Phrase 2 : ì˜í™”ë¥¼ ë´ìš”.</p></div>
          <div class="flex items-center gap-3">
            <input type="text" id="q19_input" class="w-full p-2 border-2 border-gray-300 rounded-md focus:border-purple-500 outline-none" placeholder="Combinez les deux phrases ici...">
            <button class="hint-btn ml-auto bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded" data-target="q19_hint">Indice</button>
          </div>
          <div id="q19_hint" class="box mt-3 p-3 bg-purple-100 text-purple-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) MÃªme modÃ¨le : V1-ê³  V2 (rencontre â†’ ensuite regarder).<br>KO) ê°™ì€ íŒ¨í„´: V1-ê³  V2 â€” ë¨¼ì € ë§Œë‚˜ë‹¤, ê·¸ë‹¤ìŒ ë³´ë‹¤.
          </div>
        </div>

        <!-- Q20 -->
        <div class="bg-gray-50 p-5 rounded-lg shadow-sm">
          <p class="mb-3 text-lg">20. <strong>Combinaison (-ê³ ) :</strong> Combinez les deux phrases.</p>
          <div class="mb-3"><p class="text-xl font-medium">Phrase 1 : ì‹ë‹¹ì— ë“¤ì–´ê°€ìš”.<br>Phrase 2 : ê°™ì´ ë¨¹ì–´ìš”.</p></div>
          <div class="flex items-center gap-3">
            <input type="text" id="q20_input" class="w-full p-2 border-2 border-gray-300 rounded-md focus:border-purple-500 outline-none" placeholder="Combinez les deux phrases ici...">
            <button class="hint-btn ml-auto bg-purple-500 hover:bg-purple-600 text-white text-sm px-3 py-1.5 rounded" data-target="q20_hint">Indice</button>
          </div>
          <div id="q20_hint" class="box mt-3 p-3 bg-purple-100 text-purple-800 rounded-lg">
            <strong>Indice / íŒíŠ¸ :</strong> FR) EnchaÃ®nez lâ€™entrÃ©e puis lâ€™action Â«Â manger ensembleÂ Â» avec Â«Â -ê³ Â Â».<br>KO) â€˜ë“¤ì–´ê°€-â€™ ë‹¤ìŒ â€˜ê°™ì´ ë¨¹-â€™ì„ <b>-ê³ </b>ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•˜ì„¸ìš”.
          </div>
        </div>
      </div>
    </section>

    <!-- Action bar -->
    <div class="mt-8 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
      <div class="text-sm text-gray-500">Conseil: pour rejouer l'audio, rÃ©appuyez sur ğŸ”Š. Si le navigateur bloque la lecture, rÃ©essayez.</div>
      <div class="flex gap-2 justify-end">
        <button id="retryBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">RÃ©essayer</button>
        <button id="finishBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white">Terminer / ëë‚´ê¸°</button>
      </div>
    </div>

    <!-- Results Panel -->
    <section id="resultsPanel" class="hidden mt-8 border-t pt-6">
      <h3 class="text-2xl font-bold mb-3">RÃ©sultats</h3>
      <p class="mb-2">Score: <span id="scoreText" class="font-semibold"></span></p>
      <div id="wrongListWrap" class="mt-4"></div>
      <p id="sendStatus" class="mt-4 text-sm text-gray-600"></p>
    </section>
  </div>

  <script>
    /******************* CONFIG *******************/
    const DEFAULT_TEACHER_EMAIL = '';
    let START_TS = Date.now();
    const STATS = Object.create(null); // { q1: {listen:0, hint1:0, hint2:0}, ... }
    function ensureStats(q){ if(!STATS[q]) STATS[q] = { listen:0, hint1:0, hint2:0 }; return STATS[q]; }

    // RÃ©ponses officielles
    const CATALOG = {
      q1: { type:'text', accepts:['ë­ë¥¼','ë­˜'] },
      q2: { type:'text', accepts:['ì•ˆ ë§Œë‚¬ì–´ìš”','ì•ˆë§Œë‚¬ì–´ìš”'] },
      q3: { type:'text', accepts:['ìŒ€'] },
      q4: { type:'text', accepts:['ìì£¼'] },
      q5: { type:'text', accepts:['ë“¤ì–´ê°€ìš”'] },

      q6: { type:'choice', answer:'ì™€' },
      q7: { type:'choice', answer:'ê°€' },
      q8: { type:'choice', answer:'ì€' },
      q9: { type:'choice', answer:'ì„' },
      q10:{ type:'choice', answer:'ì—' },

      q11:{ type:'tf', answer:true },
      q12:{ type:'tf', answer:false },
      q13:{ type:'tf', answer:false },
      q14:{ type:'tf', answer:true },
      q15:{ type:'tf', answer:false },

      q16:{ type:'dict', accepts:['ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ì•ˆ ë´¤ì–´ìš”','ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ì•ˆ ë´¤ì–´ìš”.'] },
      q17:{ type:'dict', accepts:['ê¹€ì¹˜í•˜ê³  ë°¥ì„ ê°™ì´ ë¨¹ì–´ìš”','ê¹€ì¹˜í•˜ê³  ë°¥ì„ ê°™ì´ ë¨¹ì–´ìš”.'] },
      q18:{ type:'combine', accepts:['ë¼ì§€ê³ ê¸°ë¥¼ ëƒ„ë¹„ì— ë„£ê³  ë³¶ì•„ìš”','ë¼ì§€ê³ ê¸°ë¥¼ ëƒ„ë¹„ì— ë„£ê³  ë³¶ì•„ìš”.'] },
      q19:{ type:'combine', accepts:['ì €ëŠ” ì¹œêµ¬ë¥¼ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ë´ìš”','ì €ëŠ” ì¹œêµ¬ë¥¼ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ë´ìš”.'] },
      q20:{ type:'combine', accepts:['ì‹ë‹¹ì— ë“¤ì–´ê°€ê³  ê°™ì´ ë¨¹ì–´ìš”','ì‹ë‹¹ì— ë“¤ì–´ê°€ê³  ê°™ì´ ë¨¹ì–´ìš”.'] },
    };

    // ë¬¸í•­ í…ìŠ¤íŠ¸ (ì„œë²„ ë©”ì¼ í…Œì´ë¸”ìš©)
    const QUESTION_TEXTS = {
      q1:  { number:1,  fr:"Que mangent souvent les FranÃ§ais ?", ko:"í”„ë‘ìŠ¤ ì‚¬ëŒë“¤ì€ ë­ë¥¼ ìì£¼ ë¨¹ì–´ìš”?" },
      q2:  { number:2,  fr:"Je n'ai pas rencontrÃ© mes amis.", ko:"ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚¬ì–´ìš”." },
      q3:  { number:3,  fr:"Je mange souvent du riz.", ko:"ì €ëŠ” ìŒ€ì„ ìì£¼ ë¨¹ì–´ìš”." },
      q4:  { number:4,  fr:"Les CorÃ©ens mangent souvent du kimchiâ€‘jjigae.", ko:"í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”." },
      q5:  { number:5,  fr:"J'entre dans le restaurant.", ko:"ì €ëŠ” ì‹ë‹¹ì— ë“¤ì–´ê°€ìš”." },
      q6:  { number:6,  fr:"Il y a du kimchi et du porc dedans.", ko:"ê¹€ì¹˜ì™€ ë¼ì§€ê³ ê¸°ê°€ ë“¤ì–´ê°€ìš”." },
      q7:  { number:7,  fr:"Mon ami regarde un film.", ko:"ì œ ì¹œêµ¬ê°€ ì˜í™”ë¥¼ ë´ìš”." },
      q8:  { number:8,  fr:"Les CorÃ©ens mangent souvent du kimchiâ€‘jjigae.", ko:"í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”." },
      q9:  { number:9,  fr:"Je mange du riz.", ko:"ì €ëŠ” ë°¥ì„ ë¨¹ì–´ìš”." },
      q10: { number:10, fr:"J'entre Ã  la maison.", ko:"ì €ëŠ” ì§‘ì— ë“¤ì–´ê°€ìš”." },
      q11: { number:11, fr:"Tu me vois bienÂ ?", ko:"ì˜ ë³´ì—¬ìš”?" },
      q12: { number:12, fr:"Je mange souvent du riz.", ko:"ì €ëŠ” ìŒ€ì„ ìì£¼ ë¨¹ì–´ìš”." },
      q13: { number:13, fr:"Mon ami n'a pas rencontrÃ© ses amis.", ko:"ì œ ì¹œêµ¬ê°€ ì¹œêµ¬ë“¤ì„ ì•ˆ ë§Œë‚¬ì–´ìš”." },
      q14: { number:14, fr:"Les FranÃ§ais mangent parfois de la baguette.", ko:"í”„ë‘ìŠ¤ ì‚¬ëŒë“¤ì€ ë°”ê²ŒíŠ¸ë¥¼ ê°€ë” ë¨¹ì–´ìš”." },
      q15: { number:15, fr:"J'entre Ã  la maison.", ko:"ì €ëŠ” ì§‘ì— ë“¤ì–´ê°€ìš”." },
      q16: { number:16, fr:"Je n'ai pas rencontrÃ© mes amis et je n'ai pas regardÃ© de film.", ko:"ì €ëŠ” ì¹œêµ¬ë¥¼ ì•ˆ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ì•ˆ ë´¤ì–´ìš”." },
      q17: { number:17, fr:"Je mange le kimchi avec le riz.", ko:"ê¹€ì¹˜í•˜ê³  ë°¥ì„ ê°™ì´ ë¨¹ì–´ìš”." },
      q18: { number:18, fr:"Je mets le porc dans la casserole et je fais sauter.", ko:"ë¼ì§€ê³ ê¸°ë¥¼ ëƒ„ë¹„ì— ë„£ê³  ë³¶ì•„ìš”." },
      q19: { number:19, fr:"Je rencontre mes amis et je regarde un film.", ko:"ì €ëŠ” ì¹œêµ¬ë¥¼ ë§Œë‚˜ê³  ì˜í™”ë¥¼ ë´ìš”." },
      q20: { number:20, fr:"On entre au restaurant et on mange ensemble.", ko:"ì‹ë‹¹ì— ë“¤ì–´ê°€ê³  ê°™ì´ ë¨¹ì–´ìš”." }
    };

    // Ã‰tats pour QCM & V/F
    const userChoice = Object.create(null); // { q6: 'ì™€', q11: true, ... }

    /******************* AUDIO MANAGER (robuste) *******************/
    const audioState = { current:null, currentUrl:null, busyButtons:new Set(), controllers:new Map() };

    function safeResetButton(btn, html){ btn.classList.remove('loading'); btn.innerHTML = html; btn.disabled = false; audioState.busyButtons.delete(btn); }
    function stopAndCleanup(){ try{ if(audioState.current){ audioState.current.pause(); audioState.current.src=''; audioState.current.load(); audioState.current=null; } if(audioState.currentUrl){ URL.revokeObjectURL(audioState.currentUrl); audioState.currentUrl=null; } }catch(e){}
    }
    function base64ToArrayBuffer(b){ const bin=atob(b); const u=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++)u[i]=bin.charCodeAt(i); return u.buffer; }
    function pcmToWav(pcmData, rate){ const pcm16=new Int16Array(pcmData); const header=new ArrayBuffer(44); const v=new DataView(header); const w=(o,s)=>{ for(let i=0;i<s.length;i++) v.setUint8(o+i,s.charCodeAt(i)); };
      w(0,'RIFF'); v.setUint32(4,36+pcm16.byteLength,true); w(8,'WAVE'); w(12,'fmt '); v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
      v.setUint32(24,rate,true); v.setUint32(28,rate*2,true); v.setUint16(32,2,true); v.setUint16(34,16,true); w(36,'data'); v.setUint32(40,pcm16.byteLength,true);
      return new Blob([header, pcm16],{type:'audio/wav'}); }
    async function fetchWithTimeout(url, options={}, timeoutMs=15000){ const controller=new AbortController(); const id=setTimeout(()=>controller.abort(), timeoutMs); const res=await fetch(url,{...options, signal:controller.signal}); clearTimeout(id); return res; }

    async function generateAndPlayAudio(text, btn){
      if(audioState.busyButtons.has(btn)) return; audioState.busyButtons.add(btn);
      const html=btn.innerHTML; btn.classList.add('loading'); btn.disabled=true; btn.innerHTML='â€¦';
      stopAndCleanup();
      const id=btn.dataset.audioId || crypto.randomUUID(); const prev=audioState.controllers.get(id); if(prev) prev.abort(); const controller=new AbortController(); audioState.controllers.set(id, controller);
      try{
        const res=await fetchWithTimeout('/.netlify/functions/generate-audio',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text }), signal:controller.signal },15000);
        if(!res.ok){ let msg=`HTTP ${res.status}`; try{ const j=await res.json(); if(j?.error) msg=j.error; }catch{} throw new Error(msg); }
        const result=await res.json();
        let url=null; if(result.audioUrl){ url=result.audioUrl; } else if(result.audioData){ const mime=result.mimeType||'audio/wav;rate=24000'; const m=mime.match(/rate=(\d+)/); const rate=m?parseInt(m[1],10):24000; const wav=pcmToWav(base64ToArrayBuffer(result.audioData), rate); url=URL.createObjectURL(wav); } else { throw new Error('No audio payload'); }
        audioState.currentUrl=url; const a=new Audio(url); audioState.current=a; const fin=()=>safeResetButton(btn, html);
        a.addEventListener('ended',()=>{ fin(); stopAndCleanup(); },{once:true}); a.addEventListener('error',()=>{ fin(); stopAndCleanup(); },{once:true});
        try{ await a.play(); }catch(err){ fin(); stopAndCleanup(); alert('ë¸Œë¼ìš°ì €ê°€ ì¬ìƒì„ ë§‰ì•˜ìŠµë‹ˆë‹¤. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì£¼ì„¸ìš”.'); return; }
      }catch(e){ console.error(e); safeResetButton(btn, html); }
      finally{ audioState.controllers.delete(id); }
    }

    /******************* HINT / UI HELPERS *******************/
    function toggleBox(id){ const el=document.getElementById(id); if(el) el.classList.toggle('show'); }

    // ë°”ì¸ë”©: hints & audio
    document.addEventListener('DOMContentLoaded', ()=>{
      START_TS = Date.now();
      document.querySelectorAll('.audio-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const qId = btn.dataset.audioId || '';
          if (qId) { const s = ensureStats(qId); s.listen = (s.listen||0) + 1; }
          const text = btn.dataset.text || '';
          generateAndPlayAudio(text, btn);
        });
      });
      document.querySelectorAll('.hint-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.target;
          const qId = id ? id.replace('_hint','') : '';
          if (qId) { const s = ensureStats(qId); s.hint1 = (s.hint1||0) + 1; }
          toggleBox(id);
        });
      });
      window.addEventListener('pagehide', stopAndCleanup);
      window.addEventListener('beforeunload', stopAndCleanup);
    });

    /******************* QCM / TF handlers *******************/
    function checkParticle(qId, chosen){
      const expected = CATALOG[qId]?.answer;
      const options = document.getElementById(qId + '_options');
      const blank = document.getElementById(qId + '_blank');
      if(blank) blank.textContent = chosen;
      userChoice[qId] = chosen;
      const ok = chosen === expected;
      options?.querySelectorAll('button')?.forEach(btn=>{
        btn.disabled = true;
        if (btn.textContent === chosen) {
          btn.classList.remove('bg-gray-200','hover:bg-cyan-200');
          btn.classList.add(ok ? 'bg-green-500' : 'bg-red-500','text-white');
          if(blank) blank.classList.add(ok ? 'text-green-600' : 'text-red-600');
        } else {
          btn.classList.add('opacity-50');
        }
      });
    }

    function checkTrueFalse(qId, userChoseTrue){
      const expected = CATALOG[qId]?.answer; // boolean
      userChoice[qId] = !!userChoseTrue;
      const options = document.getElementById(qId + '_options');
      options?.querySelectorAll('button')?.forEach(btn=>{
        btn.disabled = true;
        const isVrai = btn.textContent.includes('Vrai');
        const isChosen = (isVrai && userChoseTrue) || (!isVrai && !userChoseTrue);
        const isCorrectBtn = (isVrai && expected===true) || (!isVrai && expected===false);
        if (isChosen && isCorrectBtn) btn.classList.add('ring-4','ring-green-500');
        else if (isChosen && !isCorrectBtn) btn.classList.add('ring-4','ring-red-500');
        else btn.classList.add('opacity-50');
      });
    }

    /******************* SCORING *******************/
    const normalizeKR = (s='') => s
      .normalize('NFKC')
      .replace(/[.,!?;:()ã€Šã€‹ã€ˆã€‰â€œâ€"â€™'Â·â€¦â€”â€“-]/g,' ')
      .replace(/\s+/g,' ')
      .trim();

    function scoreAll(){
      const details = [];

      // Text (q1-5)
      const textInputs = {
        q1: document.getElementById('q1_input')?.value || '',
        q2: document.getElementById('q2_input')?.value || '',
        q3: document.getElementById('q3_input')?.value || '',
        q4: document.getElementById('q4_input')?.value || '',
        q5: document.getElementById('q5_input')?.value || '',
      };
      for(const q of ['q1','q2','q3','q4','q5']){
        const got = normalizeKR(textInputs[q]);
        const accepts = (CATALOG[q].accepts||[]).map(normalizeKR);
        const ok = accepts.includes(got);
        details.push({ id:q, type:'text', ok, expected: accepts[0]||'', got });
      }

      // Choice (q6-10)
      for(const q of ['q6','q7','q8','q9','q10']){
        const chosen = userChoice[q];
        const expected = CATALOG[q].answer;
        const ok = chosen === expected;
        details.push({ id:q, type:'choice', ok, expected, got: chosen || '' });
      }

      // TF (q11-15)
      for(const q of ['q11','q12','q13','q14','q15']){
        const chosen = userChoice[q];
        const expected = CATALOG[q].answer;
        const ok = typeof chosen === 'boolean' ? (chosen === expected) : false;
        details.push({ id:q, type:'tf', ok, expected: expected ? 'Vrai' : 'Faux', got: typeof chosen==='boolean' ? (chosen?'Vrai':'Faux') : '' });
      }

      // Dict & Combine (q16-20)
      const longInputs = {
        q16: document.getElementById('q16_input')?.value || '',
        q17: document.getElementById('q17_input')?.value || '',
        q18: document.getElementById('q18_input')?.value || '',
        q19: document.getElementById('q19_input')?.value || '',
        q20: document.getElementById('q20_input')?.value || '',
      };
      for(const q of ['q16','q17','q18','q19','q20']){
        const got = normalizeKR(longInputs[q]);
        const accepts = (CATALOG[q].accepts||[]).map(normalizeKR);
        const ok = accepts.includes(got);
        details.push({ id:q, type:CATALOG[q].type, ok, expected: accepts[0]||'', got });
      }

      const correct = details.filter(d=>d.ok).length;
      const total = details.length;
      return { correct, total, details };
    }

    function renderResults(result){
      const panel = document.getElementById('resultsPanel');
      const scoreText = document.getElementById('scoreText');
      const wrap = document.getElementById('wrongListWrap');
      scoreText.textContent = `${result.correct} / ${result.total}`;
      const wrong = result.details.filter(d=>!d.ok);
      wrap.innerHTML = wrong.length
        ? `<h4 class="font-semibold mb-2">DÃ©tails des erreurs (${wrong.length})</h4>` +
          `<ul class="list-disc pl-6 space-y-1">`+
            wrong.map(d=>`<li><b>${d.id.toUpperCase()}</b> â€” Attendu: <span class="kbd bg-gray-100 px-1 rounded">${d.expected||'-'}</span> / Votre rÃ©ponse: <span class="kbd bg-gray-100 px-1 rounded">${d.got||'(vide)'}</span></li>`).join('')+
          `</ul>`
        : `<div class="p-3 rounded bg-green-50 text-green-700">Parfait ! Toutes les rÃ©ponses sont correctes ğŸ‘</div>`;
      panel.classList.remove('hidden');
      panel.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    /******************* FINISH (send to teacher) *******************/
    let submitted = false;
    async function sendResultsOnce(payload){
      const sendStatus = document.getElementById('sendStatus');
      sendStatus.textContent = '';
      const res = await fetch('/.netlify/functions/send-results', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'x-request-id': crypto.randomUUID() }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      sendStatus.textContent = 'ğŸ“§ RÃ©sultats envoyÃ©s au professeur.';
    }

    document.getElementById('finishBtn').addEventListener('click', async ()=>{
      if (submitted) return; submitted = true;
      const name = document.getElementById('student_name')?.value || '';
      const email = document.getElementById('student_email')?.value || '';

      const score = scoreAll();
      renderResults(score);

      // ì›ì‹œ ì…ë ¥ê°’ ìˆ˜ì§‘
      const textInputs = {
        q1: document.getElementById('q1_input')?.value || '',
        q2: document.getElementById('q2_input')?.value || '',
        q3: document.getElementById('q3_input')?.value || '',
        q4: document.getElementById('q4_input')?.value || '',
        q5: document.getElementById('q5_input')?.value || ''
      };
      const longInputs = {
        q16: document.getElementById('q16_input')?.value || '',
        q17: document.getElementById('q17_input')?.value || '',
        q18: document.getElementById('q18_input')?.value || '',
        q19: document.getElementById('q19_input')?.value || '',
        q20: document.getElementById('q20_input')?.value || ''
      };

      // ì„œë²„ ê¸°ëŒ€ ìŠ¤í‚¤ë§ˆì— ë§ì¶˜ questions[] ìƒì„±
      const questions = [];
      // q1-5 (text)
      for (const q of ['q1','q2','q3','q4','q5']){
        const det = score.details.find(d=>d.id===q);
        const t = QUESTION_TEXTS[q]; const s = STATS[q]||{};
        questions.push({ number: t?.number || q, fr: t?.fr||'', ko: t?.ko||'', userAnswer: textInputs[q]||'', isCorrect: !!(det&&det.ok), expected: det?.expected || '', listenCount: s.listen||0, hint1Count: s.hint1||0, hint2Count: s.hint2||0 });
      }
      // q6-10 (choice)
      for (const q of ['q6','q7','q8','q9','q10']){
        const det = score.details.find(d=>d.id===q);
        const t = QUESTION_TEXTS[q]; const s = STATS[q]||{};
        questions.push({ number: t?.number || q, fr: t?.fr||'', ko: t?.ko||'', userAnswer: userChoice[q]||'', isCorrect: !!(det&&det.ok), expected: det?.expected || '', listenCount: s.listen||0, hint1Count: s.hint1||0, hint2Count: s.hint2||0 });
      }
      // q11-15 (TF)
      for (const q of ['q11','q12','q13','q14','q15']){
        const det = score.details.find(d=>d.id===q);
        const t = QUESTION_TEXTS[q]; const s = STATS[q]||{};
        const chosen = userChoice[q];
        const ua = typeof chosen==='boolean' ? (chosen ? 'Vrai' : 'Faux') : '';
        questions.push({ number: t?.number || q, fr: t?.fr||'', ko: t?.ko||'', userAnswer: ua, isCorrect: !!(det&&det.ok), expected: det?.expected || '', listenCount: s.listen||0, hint1Count: s.hint1||0, hint2Count: s.hint2||0 });
      }
      // q16-20 (dict/combine)
      for (const q of ['q16','q17','q18','q19','q20']){
        const det = score.details.find(d=>d.id===q);
        const t = QUESTION_TEXTS[q]; const s = STATS[q]||{};
        questions.push({ number: t?.number || q, fr: t?.fr||'', ko: t?.ko||'', userAnswer: longInputs[q]||'', isCorrect: !!(det&&det.ok), expected: det?.expected || '', listenCount: s.listen||0, hint1Count: s.hint1||0, hint2Count: s.hint2||0 });
      }

      const now = Date.now();
      const payload = {
        studentName: name || 'Ã‰lÃ¨ve',
        studentEmail: email || '',
        startTime: new Date(START_TS).toISOString(),
        endTime: new Date(now).toISOString(),
        totalTimeSeconds: Math.round((now - START_TS)/1000),
        questions
      };

      try{ await sendResultsOnce(payload); }
      catch(e){ document.getElementById('sendStatus').textContent = 'âš ï¸ Envoi impossible: ' + e.message; }
      finally{ /* no re-enable to avoid double send */ }
    });

    document.getElementById('retryBtn').addEventListener('click', ()=>{
      // reset inputs
      ['q1','q2','q3','q4','q5','q16','q17','q18','q19','q20'].forEach(id=>{
        const el = document.getElementById(id + '_input'); if(el) el.value='';
      });
      // reset choices / TF UI
      Object.keys(userChoice).forEach(k=>delete userChoice[k]);
      for(const q of ['q6','q7','q8','q9','q10']){
        document.getElementById(q + '_blank')?.classList.remove('text-green-600','text-red-600');
        const opts = document.getElementById(q + '_options');
        opts?.querySelectorAll('button')?.forEach(btn=>{
          btn.disabled=false; btn.classList.remove('bg-green-500','bg-red-500','text-white','opacity-50');
        });
        document.getElementById(q + '_blank').textContent='__';
      }
      for(const q of ['q11','q12','q13','q14','q15']){
        const opts = document.getElementById(q + '_options');
        opts?.querySelectorAll('button')?.forEach(btn=>{
          btn.disabled=false; btn.classList.remove('ring-4','ring-green-500','ring-red-500','opacity-50');
        });
      }
      // hide results & close hints
      document.getElementById('resultsPanel')?.classList.add('hidden');
      document.querySelectorAll('.box.show')?.forEach(el=>el.classList.remove('show'));
      submitted = false;
    });
  </script>
</body>
</html>
