<!-- í•œê¸€ ì´ˆì„± ì¶”ì¶œ (íŒíŠ¸1) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ã‰coute & Parole | Exercice DÃ©taillÃ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/assets/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Simple focus states for accessibility */
    .btn:focus-visible, .input:focus-visible {
        outline: 2px solid #4f46e5;
        outline-offset: 2px;
    }
    /* ë…¹ìŒ UI ê°€ë…ì„± í–¥ìƒ(í˜ì´ì§€ ì „ìš©) */
    .pd-pill{border-radius:0.8rem;font-weight:700}
    .pd-start{background:#10b981!important;border-color:#10b981!important;color:#fff!important}
    .pd-stop{background:#fee2e2!important;border-color:#fecaca!important;color:#991b1b!important}
    .pd-eval{background:#2563eb!important;border-color:#2563eb!important;color:#fff!important}
    .pd-ripple{position:relative;overflow:hidden}
    .pd-ripple::after{
      content:'';position:absolute;inset:0;border-radius:inherit;opacity:0;border:2px solid rgba(37,99,235,.35);
      animation:pdPing 800ms ease-out 1
    }
    @keyframes pdPing{0%{opacity:1;transform:scale(.96)}100%{opacity:0;transform:scale(1.06)}}
    .pd-time{font-variant-numeric:tabular-nums;font-weight:800;color:#0f172a}
    .pd-time-badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:.5rem;background:#eef2ff;color:#3730a3}
  </style>
  <link rel="icon" href="/assets/favicon.ico">

</head>

<body class="bg-slate-100 text-slate-800 antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-lg shadow-sm">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3 text-sm text-slate-500">
          <span>made by ì„±ì¼, Pongdang</span>
          <a class="underline hover:text-indigo-600" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
        </div>
        <button class="btn flex items-center gap-2 bg-white border border-slate-300 text-slate-700 font-semibold rounded-lg px-4 py-2 text-sm hover:bg-slate-50 transition-colors" onclick="window.print()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
          Imprimer / ì¸ì‡„
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 space-y-6">
    <!-- Student Name Card -->
    <section class="bg-white p-6 rounded-xl shadow-md">
      <label for="student-name" class="block text-base font-medium mb-2 text-slate-700">Nom de lâ€™Ã©lÃ¨ve / í•™ìƒ ì´ë¦„</label>
      <input id="student-name" type="text" class="input w-full block border border-slate-300 rounded-lg py-2.5 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ex. Camille, Lucas, ZoÃ©"/>
      <p class="text-sm text-slate-500 mt-2">Tu as Ã©crit ton nom ? / ì´ë¦„ ì¼ë‚˜ìš”?</p>
    </section>

    <!-- Step 1 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
      <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Ã‰tape 1 â€” PrÃ©paration / ì¤€ë¹„ìš´ë™</h2>
        <p class="text-base text-slate-600">
          Ã‰coutez chaque segment, Ã©crivez la dictÃ©e en corÃ©en, traduisez en franÃ§ais, et enfin enregistrez votre voix.
          <br/>ê° ë¶€ë¶„ì„ ë“£ê³ , í•œêµ­ì–´ë¡œ ë°›ì•„ì“°ê³ , ë¶ˆì–´ë¡œ ëœ»ì„ ì“´ ë’¤, ë°œìŒì„ ë…¹ìŒí•˜ì„¸ìš”.
        </p>
      </div>
      <div id="step1" class="space-y-4 pt-2"></div>
    </section>

    <!-- Step 2 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
      <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Ã‰tape 2 â€” Lire en segments / ë¶€ë¶„ ì´ì–´ ì½ê¸°</h2>
        <p class="text-base text-slate-600">
          Ã‰coutez chaque segment puis enregistrez-vous. Essayez de parler Ã  une vitesse similaire Ã  celle de l'audio.
          <br/>ê° ë¶€ë¶„ì„ ë“£ê³  ë”°ë¼ ì½ìœ¼ë©° ë…¹ìŒí•˜ì„¸ìš”. ì›ë³¸ ì˜¤ë””ì˜¤ì™€ ë¹„ìŠ·í•œ ì†ë„ë¡œ ë§í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•˜ì„¸ìš”.
        </p>
      </div>
       <div id="step2-content" class="space-y-4 pt-2"></div>
    </section>

    <!-- Step 3 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
       <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Ã‰tape 3 â€” Phrase complÃ¨te / ì „ì²´ ë¬¸ì¥</h2>
        <p class="text-base text-slate-600">
            Maintenant, Ã©coutez et rÃ©pÃ©tez la phrase complÃ¨te.
            <br/>ì´ì œ ì „ì²´ ë¬¸ì¥ì„ ë“£ê³  ë”°ë¼ ì½ì–´ë³´ì„¸ìš”.
        </p>
      </div>
      <div id="step3-content" class="space-y-4 pt-2"></div>
    </section>

    <!-- Navigation Buttons -->
    <div class="flex items-center justify-between pt-4">
      <a href="/assignments/numbers-warmup.html" class="btn bg-white border border-slate-300 text-slate-700 font-semibold rounded-lg px-5 py-3 text-base hover:bg-slate-50 transition-colors">â† PrÃ©cÃ©dent / ì´ì „ ì—°ìŠµ</a>
<button id="finish-btn" class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Terminer / ëë‚´ê¸°</button>    </div>

    <!-- Footer -->
    <footer class="text-center text-sm text-slate-500 pt-8">
      made by ì„±ì¼, Pongdang Â· <a class="underline hover:text-indigo-600" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
    </footer>
  </main>

  <!-- Scripts -->
<script defer src="/assets/student-gate.js?v=1.1"></script>
<script defer src="/assets/pronun-client.js?v=4.8"></script>
<script defer src="/assets/scoring.js?v=1.0"></script>
<script defer src="/assets/results-compat.js?v=1.1"></script>


  <script>
  const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');
  const VOICES = ['alloy','verse','nova','shimmer']; // ë‚¨/ì—¬ ì„ì–´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ

  // --- Data for Exercises ---
  const STEP1_DATA = [
    { ko:"ì‹œê°„ì´ ì—†ì–´ì„œ", fr:"Comme je nâ€™avais pas de temps" },
    { ko:"íšŒì˜ë¥¼ ì¤€ë¹„í•˜ë“ ì§€ ìˆ™ì œë¥¼ í•˜ë“ ì§€", fr:"soit prÃ©parer la rÃ©union, soit faire mes devoirs" },
    { ko:"í•œ ê°€ì§€ë§Œ ê³¨ë¼ì•¼ í–ˆì–´ìš”.", fr:"je devais choisir une seule chose" },
    { ko:"ì–´ì©” ìˆ˜ ì—†ì—ˆì–´ìš”.", fr:"je nâ€™avais pas le choix" }
  ];

  const STEP2_DATA = [
    { ko: "ì‹œê°„ì´ ì—†ì–´ì„œ íšŒì˜ë¥¼ ì¤€ë¹„í•˜ë“ ì§€ ìˆ™ì œë¥¼ í•˜ë“ ì§€" },
    { ko: "í•œ ê°€ì§€ë§Œ ê³¨ë¼ì•¼ í–ˆì–´ìš”. ì–´ì©” ìˆ˜ ì—†ì—ˆì–´ìš”." }
  ];

  const STEP3_TEXT = "ì‹œê°„ì´ ì—†ì–´ì„œ íšŒì˜ë¥¼ ì¤€ë¹„í•˜ë“ ì§€ ìˆ™ì œë¥¼ í•˜ë“ ì§€ í•œ ê°€ì§€ë§Œ ê³¨ë¼ì•¼ í–ˆì–´ìš”. ì–´ì©” ìˆ˜ ì—†ì—ˆì–´ìš”.";
// â¬‡ï¸ Ã‰tape 1 ì§€ì‹œë¬¸(ë¶ˆ/í•œ) + íŒíŠ¸ ìœ í‹¸
const STEP1_INSTRUCTION_FR = "Ã‰coutez chaque segment, Ã©crivez la dictÃ©e en corÃ©en, traduisez en franÃ§ais, et enfin enregistrez votre voix.";
const STEP1_INSTRUCTION_KO = "ê° ë¶€ë¶„ì„ ë“£ê³ , í•œêµ­ì–´ë¡œ ë°›ì•„ì“°ê³ , ë¶ˆì–´ë¡œ ëœ»ì„ ì“´ ë’¤, ë°œìŒì„ ë…¹ìŒí•˜ì„¸ìš”.";


  // --- Helper Functions ---
  function h(tag, attrs={}, ...kids){
    const el = document.createElement(tag);
    for(const k in attrs){
      if (k === 'class') el.className = attrs[k];
      else el.setAttribute(k, attrs[k]);
    }
    kids.forEach(c => {
        if (typeof c === 'string' || typeof c === 'number') el.appendChild(document.createTextNode(c));
        else if (c) el.appendChild(c);
    });
    return el;
  }

  // ì „ì—­: ì¬ìƒ ê¸¸ì´ ìºì‹œ(ë¬¸ì¥ë³„)
  window.AUDIO_DUR = window.AUDIO_DUR || new Map();
  async function tts(text, btn, voice='alloy'){


    btn.disabled = true;
    const originalContent = btn.innerHTML;
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Traitement...</span>`;
    
    try{
      const r = await fetch(FN_BASE + '/generate-audio', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, voice, speed:1.0 })
      });
      const j = await r.json();
      const b64 = j.audioBase64 || j.audioContent;
      if(!b64) throw new Error('No audio data received');
      const src = URL.createObjectURL(base64ToBlob(b64, j.mimeType||'audio/mpeg'));
     const a = new Audio(src);
a.addEventListener('loadedmetadata', ()=>{
  const d = Number(a.duration || 0);
  const dur = d > 0 ? d : Number(j.durationEstimateSec || 0);

  window.AUDIO_DUR.set(text, dur);

  // â¬‡ï¸ ì½˜ì†” ì¶œë ¥
  console.log(`[TTS] "${text}" ì˜¤ë””ì˜¤ ê¸¸ì´ = ${dur.toFixed(2)} s`);

  // â¬‡ï¸ í™”ë©´ì—ë„ ì¶œë ¥ (ë“£ê¸° ë²„íŠ¼ ë°”ë¡œ ì•„ë˜)
  let info = btn.nextElementSibling;
  if (!info || !info.classList.contains('audio-length-info')) {
    info = document.createElement('div');
    info.className = 'audio-length-info text-sm text-slate-500 mt-1';
    btn.insertAdjacentElement('afterend', info);
  }
  info.textContent = `â± ê¸¸ì´: ${dur.toFixed(2)}ì´ˆ`;
}, { once:true });

a.addEventListener('ended', ()=> URL.revokeObjectURL(src), {once:true});
await a.play();

    }catch(err){ 
        console.error('TTS Error:', err);
        alert('Audio indisponible. Veuillez rÃ©essayer.'); 
    }
    finally{ 
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
  }

  function base64ToBlob(base64, mime){
    const clean = base64.includes(',')? base64.split(',')[1] : base64;
    const bin = atob(clean);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr],{type:mime||'audio/mpeg'});
  }

function mountPronun(box, getRef){
  const holder = h('div');
  box.appendChild(holder);
  holder.dataset.refText = String((getRef && getRef()) || '');


  // ë¯¸ë¦¬ë³´ê¸°/ìƒŒë“œë°•ìŠ¤ ëŒ€ë¹„ í”Œë ˆì´ìŠ¤í™€ë”
  const placeholder = h('button', {class:'btn w-full flex items-center justify-center gap-2 bg-slate-200 text-slate-600 font-semibold rounded-lg px-4 py-2.5 text-base cursor-not-allowed'}, 'ğŸ™ ë…¹ìŒ (ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” ë¹„í™œì„±)');
  box.appendChild(placeholder);

  const mountReal = ()=>{
    try{
      placeholder.remove();
   Pronun.mount(holder, {
  ui: 'classic',
  getReferenceText: ()=> String(getRef()||''),
 onResult: (res)=> {
   // â¬‡â¬‡ ì¶”ê°€: í…œí¬ë§Œìœ¼ë¡œ íŒ¨ë„í‹° ê³„ì‚°(í…ìŠ¤íŠ¸ ì¸ì‹ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
function tempoOnlyPenalty(refSec, recSec){
  if (!refSec || !recSec) return { pen:0, reason:'â€”' };
  const r = recSec / refSec;
  let pen=0, reason='';
  if (r >= 1.8){ pen=20; reason='TrÃ¨s lent / ë„ˆë¬´ ëŠë¦¼'; }
  else if (r >= 1.5){ pen=12; reason='Lent / ëŠë¦¼'; }
  else if (r <= 0.60){ pen=12; reason='Trop rapide / ë„ˆë¬´ ë¹ ë¦„'; }
  else if (r <= 0.75){ pen=6;  reason='Rapide / ë¹ ë¦„'; }
  else { pen=0; reason='Vitesse correcte / ì ì ˆí•œ ì†ë„'; }
  return { pen, reason };
}

  try{
    const ref = String(getRef() || '');

    // â‘  ê¸°ì¤€ ì˜¤ë””ì˜¤ ê¸¸ì´(ì´ˆ) â€” ì—†ìœ¼ë©´ 0
    const refDur = Number((window.AUDIO_DUR && window.AUDIO_DUR.get(ref)) || 0);

    // â‘¡ ì‚¬ìš©ì ë…¹ìŒ ê¸¸ì´(ì´ˆ) â€” res.durationSec ìš°ì„ , ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ ê°’
    let recDur = Math.max(...cand, 0);
    const cand = [
  Number(holder.dataset.lastRecSec || 0),
  Number(res?.durationSec || 0)
].filter(n => Number.isFinite(n) && n > 0);


    const hyp = String(res?.text || res?.hyp || '');

    // ë””ë²„ê·¸ ë¡œê·¸
    console.log('[TempoDBG]', { ref, refDur, recDur, hyp });
if (ref && !hyp && refDur > 0 && recDur > 0){
  const t = tempoOnlyPenalty(refDur, recDur);
  holder.dataset.tempoPenalty = String(t.pen);
  holder.dataset.tempoReason  = t.reason;
  // í™”ë©´ ì¶œë ¥ì€ ìƒëµ(ë³´ì´ì§€ ì•Šê²Œ). ì ìˆ˜ë§Œ ë‚´ë¶€ì— ë³´ì¡´.
  holder.dataset.lastScore = String(Math.max(0, 100 - t.pen));
  return;
}


    if (ref && hyp) {
      const g = Scoring.gradeKO(ref, hyp, {
        tempo: { mode:'normal', refDurationSec: refDur, userDurationSec: recDur }
      });

      holder.dataset.lastScore    = String(g.score);
      holder.dataset.tempoPenalty = String(g.tempoPenalty || 0);
      holder.dataset.tempoReason  = g.tempoReason || '';

      // í™”ë©´ í‘œì‹œ(í•­ìƒ ë³´ì´ê²Œ). ê¸°ì¡´ ì„¤ëª… ì¤„ì´ ì—¬ëŸ¬ ê°œ ìƒê¸°ì§€ ì•Šë„ë¡ ì¬ì‚¬ìš©
      const badge = holder.querySelector('.pd-time-badge');
      if (badge){
        let extra = badge.nextElementSibling;
        const wantClass = 'pd-tempo-extra';
        if (!extra || !extra.classList || !extra.classList.contains(wantClass)) {
          extra = document.createElement('div');
          extra.className = `mt-1 text-xs text-slate-600 ${wantClass}`;
          badge.after(extra);
        }
const p = g.tempoPenalty || 0;
const reason = g.tempoReason || 'â€”';
const bonus  = Number(g.tempoBonus || 0);
const bucket = g.tempoBucketScore;
const praise = g.tempoPraise || '';
extra.textContent =
  `Tempo â–¶ ref ${refDur.toFixed(2)} s / vous ${recDur.toFixed(2)} s â†’ -${p} (${reason})` +
  `${bucket ? ` Â· ğŸ… ${bucket}${bonus ? `(+${bonus})` : ''}` : ''}` +
  `${praise ? ` Â· ${praise}` : ''}`;

      }

      holder.dispatchEvent(new CustomEvent('kobito:graded', {
        bubbles:true,
        detail:{score:g.score, base:g.baseScore, tempoPenalty:g.tempoPenalty, refDur, recDur, ref, hyp}
      }));
    }
  }catch(e){ console.warn('gradeKO(tempo) failed', e); }
}

});


      // === í˜ì´ì§€ ë ˆë²¨ ê¾¸ë¯¸ê¸°: ë¼ë²¨/ì´í™íŠ¸/ì‹œê°„ í‘œì‹œ ===
      decoratePronunBox(holder);
    }catch(e){ console.warn('Pronun component failed to mount:', e); }
  };

  if (window.Pronun){
    mountReal();
  } else {
    const iv = setInterval(()=>{ if(window.Pronun){ clearInterval(iv); clearTimeout(to); mountReal(); } }, 200);
    const to = setTimeout(()=> clearInterval(iv), 5000);
  }

  function decoratePronunBox(root){
    const btns = root.querySelectorAll('button');
    if (!btns || btns.length < 2) return;

    let bStart=null, bStop=null, bEval=null;
    btns.forEach(b=>{
      const t=(b.textContent||'').toLowerCase();
      if(!bStart && (t.includes('dÃ©marrer')||t.includes('start')||t.includes('ì‹œì‘'))) bStart=b;
      else if(!bStop && (t.includes('stop')||t.includes('ë©ˆì¶¤'))) bStop=b;
      else if(!bEval && (t.includes('Ã©valuer')||t.includes('evaluate')||t.includes('í‰ê°€'))) bEval=b;
    });

    if (bStart){ bStart.classList.add('pd-pill','pd-start'); bStart.textContent='â–¶ DÃ©marrer Â· ì‹œì‘'; }
    if (bStop ){ bStop .classList.add('pd-pill','pd-stop' ); bStop .textContent='â–  Stop Â· ë©ˆì¶¤'; }
    if (bEval ){ bEval .classList.add('pd-pill','pd-eval' ); bEval .textContent='âœ“ Ã‰valuer Â· í‰ê°€'; }

 

    // í´ë¦­ ì´í™íŠ¸
    function ripple(el){ el.classList.remove('pd-ripple'); void el.offsetWidth; el.classList.add('pd-ripple'); }
      if (bStart){ bStart.addEventListener('click', ()=>{ ripple(bStart); }); }
  if (bStop ){ bStop .addEventListener('click', ()=>{ ripple(bStop ); }); }
  if (bEval ){ bEval .addEventListener('click', ()=>{ ripple(bEval ); }); }
 
  }
}

  const listenIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>`;

  // --- Render Functions ---
 function renderStep1(){
  const host = document.getElementById('step1');
  if (!host) return;
  host.innerHTML = '';
  
  STEP1_DATA.forEach((q, idx)=>{
    // í—¤ë”: Q ë²ˆí˜¸ + ì§€ì‹œë¬¸(ë¶ˆ/í•œ) â€” í•œêµ­ì–´ ë¬¸ì¥ì€ í—¤ë”ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
    const head = h('div', {class:'flex items-start gap-3'},
      h('div', {class:'flex-shrink-0 bg-slate-100 text-indigo-600 font-bold w-8 h-8 rounded-full flex items-center justify-center'}, `Q${idx+1}`),
      h('div', {class:'space-y-1'},
        h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'}, STEP1_INSTRUCTION_FR),
        h('p', {class:'text-sm text-slate-600'}, STEP1_INSTRUCTION_KO)
      )
    );

    // ë“£ê¸° ë²„íŠ¼
const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
    btn.innerHTML = `${listenIcon} <span>Ã‰couter / ë“£ê¸°</span>`;
    const voice = VOICES[idx % VOICES.length];
    btn.addEventListener('click', ()=> tts(q.ko, btn, voice));

    // ì…ë ¥ë€
    const inpKo = h('input', {class:'input w-full block border border-slate-300 rounded-lg py-2 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition', placeholder:'ë°›ì•„ì“°ê¸°: í•œêµ­ì–´ë¡œ ì ê¸°'});
    const inpFr = h('input', {class:'input w-full block border border-slate-300 rounded-lg py-2 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition', placeholder:'Sens (FR): ì˜ë¯¸(ë¶ˆì–´)'});

    // íŒíŠ¸(ë„ì›€ë§) â€” Aidez-moi / Au secours (ê³µìš© ìœ í‹¸ ì‚¬ìš©: í† ê¸€)
    const [hintRow, hintBox] = mkHintRow({ ko: q.ko, fr: q.fr });


    // ë°œìŒ ìœ„ì ¯
    const pbox = h('div', {class:'mt-2'});
    mountPronun(pbox, ()=> q.ko);

    // ì¹´ë“œ ì¡°ë¦½
    const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'}, head, btn, inpKo, inpFr, hintRow, hintBox, pbox);
    host.appendChild(card);
  });
}


  function renderStep2() {
    const host = document.getElementById('step2-content');
    if (!host) return;
    host.innerHTML = '';

    STEP2_DATA.forEach((q, idx) => {
      // â¬‡ï¸ í•œêµ­ì–´ ì›ë¬¸ì€ í—¤ë”ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ(ê°ì¶¤)
    const head = h('div', {class:'space-y-1'},
      h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'},
        `Ã‰coutez chaque segment puis enregistrez-vous. Essayez de parler Ã  une vitesse similaire Ã  celle de l'audio.`),
      h('p', {class:'text-sm text-slate-600'},
        'ê° ë¶€ë¶„ì„ ë“£ê³  ë°”ë¡œ ë”°ë¼ ì½ìœ¼ë©° ë…¹ìŒí•˜ì„¸ìš”. ì›ë³¸ê³¼ ë¹„ìŠ·í•œ ì†ë„ë¡œ ë§í•´ìš”.')
    );


const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
      btn.innerHTML = `${listenIcon} <span>Ã‰couter / ë“£ê¸° (Partie ${idx+1})</span>`;
      const voice = VOICES[(idx+1) % VOICES.length];
      btn.addEventListener('click', () => tts(q.ko, btn, voice));

      // â¬‡ï¸ íŒíŠ¸(Aidez-moi / Au secours) â€” í† ê¸€
      const [hintRow, hintWrap] = mkHintRow({ ko: q.ko, fr: '' });

      // â¬‡ï¸ ë°œìŒ ë…¹ìŒ ìœ„ì ¯ (ë¬¸ì¥ í…ìŠ¤íŠ¸ëŠ” ë‚´ë¶€ refë¡œë§Œ ì‚¬ìš©)
      const pbox = h('div', {class:'mt-2'});
      mountPronun(pbox, () => q.ko);

      const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'},
        head, btn, hintRow, hintWrap, pbox
      );
      host.appendChild(card);
    });
  }


   function renderStep3() {
    const host = document.getElementById('step3-content');
    if (!host) return;
    host.innerHTML = '';

    const head = h('div', {class:'space-y-1'},
      h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'},
        'Maintenant, Ã©coutez et rÃ©pÃ©tez la phrase complÃ¨te.'),
      h('p', {class:'text-sm text-slate-600'},
        'ì´ì œ ì „ì²´ ë¬¸ì¥ì„ ë“£ê³  ë°”ë¡œ ë”°ë¼ ì½ìœ¼ë©´ì„œ ë…¹ìŒí•˜ì„¸ìš”.')
    );

const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
    btn.innerHTML = `${listenIcon} <span>Ã‰couter la phrase complÃ¨te / ì „ì²´ ë¬¸ì¥ ë“£ê¸°</span>`;
    const voice = VOICES[2];
    btn.addEventListener('click', () => tts(STEP3_TEXT, btn, voice));

    // â¬‡ï¸ íŒíŠ¸(Aidez-moi / Au secours) â€” í† ê¸€
    const [hintRow, hintWrap] = mkHintRow({ ko: STEP3_TEXT, fr: '' });

    const pbox = h('div', {class:'mt-2'});
    mountPronun(pbox, () => STEP3_TEXT);

    const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'},
      head, btn, hintRow, hintWrap, pbox
    );
    host.appendChild(card);
  }


    // --- DOM Ready ---
  document.addEventListener('DOMContentLoaded', ()=>{
    // ê³µìš© ìœ í‹¸/ìœ„ì ¯ ë¡œë“œ ëŒ€ê¸°
    const waitFor = (key, ms=5000) => new Promise((resolve, reject)=>{
      const t0 = performance.now();
      const iv = setInterval(()=>{
        if (window[key]) { clearInterval(iv); resolve(true); }
        if (performance.now()-t0 > ms) { clearInterval(iv); reject(new Error(key+' timeout')); }
      }, 100);
    });

    (async () => {
      try {
        // StudentGate( mkHintRow / choseongInitials / partialKo / keyFrWords ) ëŒ€ê¸°
        await waitFor('mkHintRow');
        // Pronun ìœ„ì ¯ ëŒ€ê¸° (ë²„íŠ¼ ë ˆì´ë¸”/íƒ€ì´ë¨¸ ê¾¸ë¯¸ê¸° ìœ„í•´)
        await waitFor('Pronun');

        window.StudentGate?.init?.();
        renderStep1();
        renderStep2();
        renderStep3();

const finishBtn = document.getElementById('finish-btn');
if (finishBtn) {
  document.addEventListener('student-ready', ()=>{ finishBtn.disabled = false; });

  // === ì§‘ê³„ ìƒíƒœ ===
  // ì§ˆë¬¸ë³„ í´ë¦­/íŒíŠ¸/í‰ê°€ ê²°ê³¼ ëˆ„ì 
  const Track = (window._kobito ||= {
    startTime: window._startTime || new Date().toISOString(),
    listen: new Map(),   // text -> count
    hint1:  new Map(),   // text -> count
    hint2:  new Map(),   // text -> count
    evals:  new Map(),   // text -> {score, duration, transcript}
    inputs: new Map()    // text -> {ko, fr}
  });

  // ë“£ê¸° ë²„íŠ¼ ì¹´ìš´íŠ¸: tts() ë‚´ë¶€ì—ì„œ í˜¸ì¶œ ì§€ì  ì¶”ê°€
  const _origTTS = tts;
  window.tts = async (text, btn, voice) => {
    const k = String(text||'');
    Track.listen.set(k, (Track.listen.get(k)||0)+1);
    return _origTTS(text, btn, voice);
  };

  // íŒíŠ¸ ì‚¬ìš© ì¹´ìš´íŠ¸: student-gate ì „ì—­ í† ê¸€ ì´ë²¤íŠ¸ í™œìš©
  // (ë²„íŠ¼ì— ë”°ë¼ detail.type === 'hint1' | 'hint2')
  document.addEventListener('hint-used', (e)=>{
    const card = e.target.closest('.p-4');
    const ref  = card?.querySelector('.pd-time-badge') ? (card.querySelector('.pd-time-badge').closest('[data-ref-text]')?.dataset.refText || '') : '';
    // ref ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ, ë²„íŠ¼ ìœ„ í…ìŠ¤íŠ¸ ì˜ì—­ì—ì„œ KO ë¬¸ì¥ì„ ì°¾ëŠ” ê°„ë‹¨ í´ë°±
    const btn = e.target.closest('.btn');
    const guess = btn?.nextElementSibling?.textContent || '';
    const key = ref || guess || '';
    if (!key) return;
    if (e.detail?.type === 'hint1') Track.hint1.set(key, (Track.hint1.get(key)||0)+1);
    if (e.detail?.type === 'hint2') Track.hint2.set(key, (Track.hint2.get(key)||0)+1);
  }, true);

  // ì…ë ¥ ê°’ ìŠ¤ëƒ…ìƒ·(Ã‰tape 1)
  function snapshotInputs(){
    document.querySelectorAll('#step1 .p-4').forEach(card=>{
      const btn = card.querySelector('.btn.btn-primary');
      const ko  = card.querySelector('input[placeholder^="ë°›ì•„ì“°ê¸°"]')?.value||'';
      const fr  = card.querySelector('input[placeholder^="Sens"]')?.value||'';
      const key = btn ? btn.textContent.includes('Ã‰couter') ? (STEP1_DATA[Array.from(card.parentNode.children).indexOf(card)]?.ko||'') : '' : '';
      if (key) Track.inputs.set(key, { ko, fr });
    });
  }

  // Pronun ê²°ê³¼ ìˆ˜ì§‘: mountPronunì—ì„œ onResultë¡œ ì „ë‹¬ë¨
  // (ì´ë¯¸ í˜ì´ì§€ ìƒë‹¨ mountPronunì—ì„œ holder.dispatchEvent('kobito:graded', detail) ë°œìƒ)
  document.addEventListener('kobito:graded', (e)=>{
    const { ref, hyp, score, refDur, recDur } = e.detail||{};
    if (!ref) return;
    Track.evals.set(ref, {
      score: Number(score||0),
      duration: Number(recDur||0),
      transcript: String(hyp||'')
    });
  });

finishBtn.addEventListener('click', async () => {
  try {
    // â‘  Ã‰tape 1 ì…ë ¥ ìŠ¤ëƒ…ìƒ· ë°˜ì˜
    snapshotInputs();

    // â‘¡ ê²°ê³¼ í˜ì´ë¡œë“œ êµ¬ì„±(ìš”êµ¬ëœ ìŠ¤í‚¤ë§ˆ)
    const studentName = (window.StudentGate?.getName?.() || document.getElementById('student-name')?.value || '').trim();
    const startTime   = window._startTime || new Date().toISOString();
    const endTime     = new Date().toISOString();
    const totalTimeSeconds = Math.max(1, Math.round((Date.now() - (window._startMs || Date.now())) / 1000));

    // KO ë¬¸ì¥ í‚¤ ëª©ë¡(1â†’2â†’3)
    const keys = [
      ...STEP1_DATA.map(x => x.ko),
      ...STEP2_DATA.map(x => x.ko),
      STEP3_TEXT
    ].filter(Boolean);

    // Ã‰tape 1ì˜ ë¶ˆì–´ ëœ» ë§¤í•‘
    const frMap = Object.fromEntries(STEP1_DATA.map(x => [x.ko, x.fr || '']));

    const questions = keys.map((k, i) => {
      const inp = window._kobito?.inputs?.get(k) || { ko: '', fr: '' };
      const ev  = window._kobito?.evals?.get(k)  || { score: 0, duration: 0, transcript: '' };
      return {
        number: i + 1,
        ko: k,
        fr: frMap[k] || '',
        userAnswer: String(inp.ko || ''),
        isCorrect: Number(ev.score || 0) >= 60,
        listenCount: Number(window._kobito?.listen?.get(k) || 0),
        hint1Count:  Number(window._kobito?.hint1?.get(k)  || 0),
        hint2Count:  Number(window._kobito?.hint2?.get(k)  || 0),
        recording: {
          base64: "",
          filename: "rec.webm",
          mimeType: "audio/webm",
          duration: Number(ev.duration || 0)
        },
        asrTranscript: String(ev.transcript || ''),
        pronunScore: Number(ev.score || 0)
      };
    });

    const payload = {
      studentName, startTime, endTime, totalTimeSeconds, questions
    };

    // â‘¢ ì „ì†¡ (ë¡œì»¬ í´ë°±ì€ results-compat.jsê°€ ì²˜ë¦¬)
    await window.sendResults(payload);

    // â‘£ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = '/results.html';
  } catch (e) {
    console.warn('sendResults failed, opening results viewer via stash', e);
    window.location.href = '/results.html';
  }
});


} // â† if (finishBtn) ë¸”ë¡ ë‹«í˜


      } catch(e){
        console.warn('[init-wait]', e);
        // ê·¸ë˜ë„ í•™ìƒì´ í˜ì´ì§€ë¥¼ ì“¸ ìˆ˜ ìˆê²Œ ìµœì†Œ ë Œë” ì‹œë„
        renderStep1();
        renderStep2();
        renderStep3();
      }
    })();
  });

  </script>
</body>
</html>
