<!-- 한글 초성 추출 (힌트1) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Écoute & Parole | Exercice Détaillé</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/assets/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Simple focus states for accessibility */
    .btn:focus-visible, .input:focus-visible {
        outline: 2px solid #4f46e5;
        outline-offset: 2px;
    }
    /* 녹음 UI 가독성 향상(페이지 전용) */
    .pd-pill{border-radius:0.8rem;font-weight:700}
    .pd-start{background:#10b981!important;border-color:#10b981!important;color:#fff!important}
    .pd-stop{background:#fee2e2!important;border-color:#fecaca!important;color:#991b1b!important}
    .pd-eval{background:#2563eb!important;border-color:#2563eb!important;color:#fff!important}
    .pd-ripple{position:relative;overflow:hidden}
    .pd-ripple::after{
      content:'';position:absolute;inset:0;border-radius:inherit;opacity:0;border:2px solid rgba(37,99,235,.35);
      animation:pdPing 800ms ease-out 1
    }
    @keyframes pdPing{0%{opacity:1;transform:scale(.96)}100%{opacity:0;transform:scale(1.06)}}
    .pd-time{font-variant-numeric:tabular-nums;font-weight:800;color:#0f172a}
    .pd-time-badge{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border-radius:.5rem;background:#eef2ff;color:#3730a3}
  </style>
  <link rel="icon" href="/assets/favicon.ico">

</head>

<body class="bg-slate-100 text-slate-800 antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-lg shadow-sm">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3 text-sm text-slate-500">
          <span>made by 성일, Pongdang</span>
          <a class="underline hover:text-indigo-600" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
        </div>
        <button class="btn flex items-center gap-2 bg-white border border-slate-300 text-slate-700 font-semibold rounded-lg px-4 py-2 text-sm hover:bg-slate-50 transition-colors" onclick="window.print()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
          Imprimer / 인쇄
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 space-y-6">
    <!-- Student Name Card -->
    <section class="bg-white p-6 rounded-xl shadow-md">
      <label for="student-name" class="block text-base font-medium mb-2 text-slate-700">Nom de l’élève / 학생 이름</label>
      <input id="student-name" type="text" class="input w-full block border border-slate-300 rounded-lg py-2.5 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ex. Camille, Lucas, Zoé"/>
      <p class="text-sm text-slate-500 mt-2">Tu as écrit ton nom ? / 이름 썼나요?</p>
    </section>

    <!-- Step 1 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
      <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Étape 1 — Préparation / 준비운동</h2>
        <p class="text-base text-slate-600">
          Écoutez chaque segment, écrivez la dictée en coréen, traduisez en français, et enfin enregistrez votre voix.
          <br/>각 부분을 듣고, 한국어로 받아쓰고, 불어로 뜻을 쓴 뒤, 발음을 녹음하세요.
        </p>
      </div>
      <div id="step1" class="space-y-4 pt-2"></div>
    </section>

    <!-- Step 2 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
      <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Étape 2 — Lire en segments / 부분 이어 읽기</h2>
        <p class="text-base text-slate-600">
          Écoutez chaque segment puis enregistrez-vous. Essayez de parler à une vitesse similaire à celle de l'audio.
          <br/>각 부분을 듣고 따라 읽으며 녹음하세요. 원본 오디오와 비슷한 속도로 말하는 것을 목표로 하세요.
        </p>
      </div>
       <div id="step2-content" class="space-y-4 pt-2"></div>
    </section>

    <!-- Step 3 Card -->
    <section class="bg-white p-6 rounded-xl shadow-md space-y-4">
       <div class="space-y-1">
        <h2 class="text-xl font-bold text-slate-900">Étape 3 — Phrase complète / 전체 문장</h2>
        <p class="text-base text-slate-600">
            Maintenant, écoutez et répétez la phrase complète.
            <br/>이제 전체 문장을 듣고 따라 읽어보세요.
        </p>
      </div>
      <div id="step3-content" class="space-y-4 pt-2"></div>
    </section>

    <!-- Navigation Buttons -->
    <div class="flex items-center justify-between pt-4">
      <a href="/assignments/numbers-warmup.html" class="btn bg-white border border-slate-300 text-slate-700 font-semibold rounded-lg px-5 py-3 text-base hover:bg-slate-50 transition-colors">← Précédent / 이전 연습</a>
<button id="finish-btn" class="btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Terminer / 끝내기</button>    </div>

    <!-- Footer -->
    <footer class="text-center text-sm text-slate-500 pt-8">
      made by 성일, Pongdang · <a class="underline hover:text-indigo-600" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
    </footer>
  </main>

  <!-- Scripts -->
<script defer src="/assets/student-gate.js?v=1.1"></script>
<script defer src="/assets/pronun-client.js?v=4.8"></script>
<script defer src="/assets/scoring.js?v=1.0"></script>
<script defer src="/assets/results-compat.js?v=1.1"></script>


  <script>
  const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');
  const VOICES = ['alloy','verse','nova','shimmer']; // 남/여 섞어서 자연스럽게

  // --- Data for Exercises ---
  const STEP1_DATA = [
    { ko:"시간이 없어서", fr:"Comme je n’avais pas de temps" },
    { ko:"회의를 준비하든지 숙제를 하든지", fr:"soit préparer la réunion, soit faire mes devoirs" },
    { ko:"한 가지만 골라야 했어요.", fr:"je devais choisir une seule chose" },
    { ko:"어쩔 수 없었어요.", fr:"je n’avais pas le choix" }
  ];

  const STEP2_DATA = [
    { ko: "시간이 없어서 회의를 준비하든지 숙제를 하든지" },
    { ko: "한 가지만 골라야 했어요. 어쩔 수 없었어요." }
  ];

  const STEP3_TEXT = "시간이 없어서 회의를 준비하든지 숙제를 하든지 한 가지만 골라야 했어요. 어쩔 수 없었어요.";
// ⬇️ Étape 1 지시문(불/한) + 힌트 유틸
const STEP1_INSTRUCTION_FR = "Écoutez chaque segment, écrivez la dictée en coréen, traduisez en français, et enfin enregistrez votre voix.";
const STEP1_INSTRUCTION_KO = "각 부분을 듣고, 한국어로 받아쓰고, 불어로 뜻을 쓴 뒤, 발음을 녹음하세요.";


  // --- Helper Functions ---
  function h(tag, attrs={}, ...kids){
    const el = document.createElement(tag);
    for(const k in attrs){
      if (k === 'class') el.className = attrs[k];
      else el.setAttribute(k, attrs[k]);
    }
    kids.forEach(c => {
        if (typeof c === 'string' || typeof c === 'number') el.appendChild(document.createTextNode(c));
        else if (c) el.appendChild(c);
    });
    return el;
  }

  // 전역: 재생 길이 캐시(문장별)
  window.AUDIO_DUR = window.AUDIO_DUR || new Map();
  async function tts(text, btn, voice='alloy'){


    btn.disabled = true;
    const originalContent = btn.innerHTML;
    btn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Traitement...</span>`;
    
    try{
      const r = await fetch(FN_BASE + '/generate-audio', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text, voice, speed:1.0 })
      });
      const j = await r.json();
      const b64 = j.audioBase64 || j.audioContent;
      if(!b64) throw new Error('No audio data received');
      const src = URL.createObjectURL(base64ToBlob(b64, j.mimeType||'audio/mpeg'));
     const a = new Audio(src);
a.addEventListener('loadedmetadata', ()=>{
  const d = Number(a.duration || 0);
  const dur = d > 0 ? d : Number(j.durationEstimateSec || 0);

  window.AUDIO_DUR.set(text, dur);

  // ⬇️ 콘솔 출력
  console.log(`[TTS] "${text}" 오디오 길이 = ${dur.toFixed(2)} s`);

  // ⬇️ 화면에도 출력 (듣기 버튼 바로 아래)
  let info = btn.nextElementSibling;
  if (!info || !info.classList.contains('audio-length-info')) {
    info = document.createElement('div');
    info.className = 'audio-length-info text-sm text-slate-500 mt-1';
    btn.insertAdjacentElement('afterend', info);
  }
  info.textContent = `⏱ 길이: ${dur.toFixed(2)}초`;
}, { once:true });

a.addEventListener('ended', ()=> URL.revokeObjectURL(src), {once:true});
await a.play();

    }catch(err){ 
        console.error('TTS Error:', err);
        alert('Audio indisponible. Veuillez réessayer.'); 
    }
    finally{ 
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
  }

  function base64ToBlob(base64, mime){
    const clean = base64.includes(',')? base64.split(',')[1] : base64;
    const bin = atob(clean);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr],{type:mime||'audio/mpeg'});
  }

function mountPronun(box, getRef){
  const holder = h('div');
  box.appendChild(holder);
  holder.dataset.refText = String((getRef && getRef()) || '');


  // 미리보기/샌드박스 대비 플레이스홀더
  const placeholder = h('button', {class:'btn w-full flex items-center justify-center gap-2 bg-slate-200 text-slate-600 font-semibold rounded-lg px-4 py-2.5 text-base cursor-not-allowed'}, '🎙 녹음 (미리보기에서는 비활성)');
  box.appendChild(placeholder);

  const mountReal = ()=>{
    try{
      placeholder.remove();
   Pronun.mount(holder, {
  ui: 'classic',
  getReferenceText: ()=> String(getRef()||''),
 onResult: (res)=> {
   // ⬇⬇ 추가: 템포만으로 패널티 계산(텍스트 인식 실패 시 사용)
function tempoOnlyPenalty(refSec, recSec){
  if (!refSec || !recSec) return { pen:0, reason:'—' };
  const r = recSec / refSec;
  let pen=0, reason='';
  if (r >= 1.8){ pen=20; reason='Très lent / 너무 느림'; }
  else if (r >= 1.5){ pen=12; reason='Lent / 느림'; }
  else if (r <= 0.60){ pen=12; reason='Trop rapide / 너무 빠름'; }
  else if (r <= 0.75){ pen=6;  reason='Rapide / 빠름'; }
  else { pen=0; reason='Vitesse correcte / 적절한 속도'; }
  return { pen, reason };
}

  try{
    const ref = String(getRef() || '');

    // ① 기준 오디오 길이(초) — 없으면 0
    const refDur = Number((window.AUDIO_DUR && window.AUDIO_DUR.get(ref)) || 0);

    // ② 사용자 녹음 길이(초) — res.durationSec 우선, 없으면 타이머 값
    let recDur = Math.max(...cand, 0);
    const cand = [
  Number(holder.dataset.lastRecSec || 0),
  Number(res?.durationSec || 0)
].filter(n => Number.isFinite(n) && n > 0);


    const hyp = String(res?.text || res?.hyp || '');

    // 디버그 로그
    console.log('[TempoDBG]', { ref, refDur, recDur, hyp });
if (ref && !hyp && refDur > 0 && recDur > 0){
  const t = tempoOnlyPenalty(refDur, recDur);
  holder.dataset.tempoPenalty = String(t.pen);
  holder.dataset.tempoReason  = t.reason;
  // 화면 출력은 생략(보이지 않게). 점수만 내부에 보존.
  holder.dataset.lastScore = String(Math.max(0, 100 - t.pen));
  return;
}


    if (ref && hyp) {
      const g = Scoring.gradeKO(ref, hyp, {
        tempo: { mode:'normal', refDurationSec: refDur, userDurationSec: recDur }
      });

      holder.dataset.lastScore    = String(g.score);
      holder.dataset.tempoPenalty = String(g.tempoPenalty || 0);
      holder.dataset.tempoReason  = g.tempoReason || '';

      // 화면 표시(항상 보이게). 기존 설명 줄이 여러 개 생기지 않도록 재사용
      const badge = holder.querySelector('.pd-time-badge');
      if (badge){
        let extra = badge.nextElementSibling;
        const wantClass = 'pd-tempo-extra';
        if (!extra || !extra.classList || !extra.classList.contains(wantClass)) {
          extra = document.createElement('div');
          extra.className = `mt-1 text-xs text-slate-600 ${wantClass}`;
          badge.after(extra);
        }
const p = g.tempoPenalty || 0;
const reason = g.tempoReason || '—';
const bonus  = Number(g.tempoBonus || 0);
const bucket = g.tempoBucketScore;
const praise = g.tempoPraise || '';
extra.textContent =
  `Tempo ▶ ref ${refDur.toFixed(2)} s / vous ${recDur.toFixed(2)} s → -${p} (${reason})` +
  `${bucket ? ` · 🏅 ${bucket}${bonus ? `(+${bonus})` : ''}` : ''}` +
  `${praise ? ` · ${praise}` : ''}`;

      }

      holder.dispatchEvent(new CustomEvent('kobito:graded', {
        bubbles:true,
        detail:{score:g.score, base:g.baseScore, tempoPenalty:g.tempoPenalty, refDur, recDur, ref, hyp}
      }));
    }
  }catch(e){ console.warn('gradeKO(tempo) failed', e); }
}

});


      // === 페이지 레벨 꾸미기: 라벨/이펙트/시간 표시 ===
      decoratePronunBox(holder);
    }catch(e){ console.warn('Pronun component failed to mount:', e); }
  };

  if (window.Pronun){
    mountReal();
  } else {
    const iv = setInterval(()=>{ if(window.Pronun){ clearInterval(iv); clearTimeout(to); mountReal(); } }, 200);
    const to = setTimeout(()=> clearInterval(iv), 5000);
  }

  function decoratePronunBox(root){
    const btns = root.querySelectorAll('button');
    if (!btns || btns.length < 2) return;

    let bStart=null, bStop=null, bEval=null;
    btns.forEach(b=>{
      const t=(b.textContent||'').toLowerCase();
      if(!bStart && (t.includes('démarrer')||t.includes('start')||t.includes('시작'))) bStart=b;
      else if(!bStop && (t.includes('stop')||t.includes('멈춤'))) bStop=b;
      else if(!bEval && (t.includes('évaluer')||t.includes('evaluate')||t.includes('평가'))) bEval=b;
    });

    if (bStart){ bStart.classList.add('pd-pill','pd-start'); bStart.textContent='▶ Démarrer · 시작'; }
    if (bStop ){ bStop .classList.add('pd-pill','pd-stop' ); bStop .textContent='■ Stop · 멈춤'; }
    if (bEval ){ bEval .classList.add('pd-pill','pd-eval' ); bEval .textContent='✓ Évaluer · 평가'; }

 

    // 클릭 이펙트
    function ripple(el){ el.classList.remove('pd-ripple'); void el.offsetWidth; el.classList.add('pd-ripple'); }
      if (bStart){ bStart.addEventListener('click', ()=>{ ripple(bStart); }); }
  if (bStop ){ bStop .addEventListener('click', ()=>{ ripple(bStop ); }); }
  if (bEval ){ bEval .addEventListener('click', ()=>{ ripple(bEval ); }); }
 
  }
}

  const listenIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>`;

  // --- Render Functions ---
 function renderStep1(){
  const host = document.getElementById('step1');
  if (!host) return;
  host.innerHTML = '';
  
  STEP1_DATA.forEach((q, idx)=>{
    // 헤더: Q 번호 + 지시문(불/한) — 한국어 문장은 헤더에 표시하지 않음
    const head = h('div', {class:'flex items-start gap-3'},
      h('div', {class:'flex-shrink-0 bg-slate-100 text-indigo-600 font-bold w-8 h-8 rounded-full flex items-center justify-center'}, `Q${idx+1}`),
      h('div', {class:'space-y-1'},
        h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'}, STEP1_INSTRUCTION_FR),
        h('p', {class:'text-sm text-slate-600'}, STEP1_INSTRUCTION_KO)
      )
    );

    // 듣기 버튼
const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
    btn.innerHTML = `${listenIcon} <span>Écouter / 듣기</span>`;
    const voice = VOICES[idx % VOICES.length];
    btn.addEventListener('click', ()=> tts(q.ko, btn, voice));

    // 입력란
    const inpKo = h('input', {class:'input w-full block border border-slate-300 rounded-lg py-2 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition', placeholder:'받아쓰기: 한국어로 적기'});
    const inpFr = h('input', {class:'input w-full block border border-slate-300 rounded-lg py-2 px-3 text-base placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition', placeholder:'Sens (FR): 의미(불어)'});

    // 힌트(도움말) — Aidez-moi / Au secours (공용 유틸 사용: 토글)
    const [hintRow, hintBox] = mkHintRow({ ko: q.ko, fr: q.fr });


    // 발음 위젯
    const pbox = h('div', {class:'mt-2'});
    mountPronun(pbox, ()=> q.ko);

    // 카드 조립
    const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'}, head, btn, inpKo, inpFr, hintRow, hintBox, pbox);
    host.appendChild(card);
  });
}


  function renderStep2() {
    const host = document.getElementById('step2-content');
    if (!host) return;
    host.innerHTML = '';

    STEP2_DATA.forEach((q, idx) => {
      // ⬇️ 한국어 원문은 헤더에 표시하지 않음(감춤)
    const head = h('div', {class:'space-y-1'},
      h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'},
        `Écoutez chaque segment puis enregistrez-vous. Essayez de parler à une vitesse similaire à celle de l'audio.`),
      h('p', {class:'text-sm text-slate-600'},
        '각 부분을 듣고 바로 따라 읽으며 녹음하세요. 원본과 비슷한 속도로 말해요.')
    );


const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
      btn.innerHTML = `${listenIcon} <span>Écouter / 듣기 (Partie ${idx+1})</span>`;
      const voice = VOICES[(idx+1) % VOICES.length];
      btn.addEventListener('click', () => tts(q.ko, btn, voice));

      // ⬇️ 힌트(Aidez-moi / Au secours) — 토글
      const [hintRow, hintWrap] = mkHintRow({ ko: q.ko, fr: '' });

      // ⬇️ 발음 녹음 위젯 (문장 텍스트는 내부 ref로만 사용)
      const pbox = h('div', {class:'mt-2'});
      mountPronun(pbox, () => q.ko);

      const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'},
        head, btn, hintRow, hintWrap, pbox
      );
      host.appendChild(card);
    });
  }


   function renderStep3() {
    const host = document.getElementById('step3-content');
    if (!host) return;
    host.innerHTML = '';

    const head = h('div', {class:'space-y-1'},
      h('p', {class:'text-sm sm:text-base text-slate-800 font-semibold'},
        'Maintenant, écoutez et répétez la phrase complète.'),
      h('p', {class:'text-sm text-slate-600'},
        '이제 전체 문장을 듣고 바로 따라 읽으면서 녹음하세요.')
    );

const btn = h('button', {class:'btn btn-primary w-full flex items-center justify-center gap-2 font-semibold rounded-lg px-4 py-2.5 text-base transition-colors'});
    btn.innerHTML = `${listenIcon} <span>Écouter la phrase complète / 전체 문장 듣기</span>`;
    const voice = VOICES[2];
    btn.addEventListener('click', () => tts(STEP3_TEXT, btn, voice));

    // ⬇️ 힌트(Aidez-moi / Au secours) — 토글
    const [hintRow, hintWrap] = mkHintRow({ ko: STEP3_TEXT, fr: '' });

    const pbox = h('div', {class:'mt-2'});
    mountPronun(pbox, () => STEP3_TEXT);

    const card = h('div', {class:'p-4 rounded-lg border border-slate-200 bg-slate-50/50 space-y-3'},
      head, btn, hintRow, hintWrap, pbox
    );
    host.appendChild(card);
  }


    // --- DOM Ready ---
  document.addEventListener('DOMContentLoaded', ()=>{
    // 공용 유틸/위젯 로드 대기
    const waitFor = (key, ms=5000) => new Promise((resolve, reject)=>{
      const t0 = performance.now();
      const iv = setInterval(()=>{
        if (window[key]) { clearInterval(iv); resolve(true); }
        if (performance.now()-t0 > ms) { clearInterval(iv); reject(new Error(key+' timeout')); }
      }, 100);
    });

    (async () => {
      try {
        // StudentGate( mkHintRow / choseongInitials / partialKo / keyFrWords ) 대기
        await waitFor('mkHintRow');
        // Pronun 위젯 대기 (버튼 레이블/타이머 꾸미기 위해)
        await waitFor('Pronun');

        window.StudentGate?.init?.();
        renderStep1();
        renderStep2();
        renderStep3();

const finishBtn = document.getElementById('finish-btn');
if (finishBtn) {
  document.addEventListener('student-ready', ()=>{ finishBtn.disabled = false; });

  // === 집계 상태 ===
  // 질문별 클릭/힌트/평가 결과 누적
  const Track = (window._kobito ||= {
    startTime: window._startTime || new Date().toISOString(),
    listen: new Map(),   // text -> count
    hint1:  new Map(),   // text -> count
    hint2:  new Map(),   // text -> count
    evals:  new Map(),   // text -> {score, duration, transcript}
    inputs: new Map()    // text -> {ko, fr}
  });

  // 듣기 버튼 카운트: tts() 내부에서 호출 지점 추가
  const _origTTS = tts;
  window.tts = async (text, btn, voice) => {
    const k = String(text||'');
    Track.listen.set(k, (Track.listen.get(k)||0)+1);
    return _origTTS(text, btn, voice);
  };

  // 힌트 사용 카운트: student-gate 전역 토글 이벤트 활용
  // (버튼에 따라 detail.type === 'hint1' | 'hint2')
  document.addEventListener('hint-used', (e)=>{
    const card = e.target.closest('.p-4');
    const ref  = card?.querySelector('.pd-time-badge') ? (card.querySelector('.pd-time-badge').closest('[data-ref-text]')?.dataset.refText || '') : '';
    // ref 추출 실패 시, 버튼 위 텍스트 영역에서 KO 문장을 찾는 간단 폴백
    const btn = e.target.closest('.btn');
    const guess = btn?.nextElementSibling?.textContent || '';
    const key = ref || guess || '';
    if (!key) return;
    if (e.detail?.type === 'hint1') Track.hint1.set(key, (Track.hint1.get(key)||0)+1);
    if (e.detail?.type === 'hint2') Track.hint2.set(key, (Track.hint2.get(key)||0)+1);
  }, true);

  // 입력 값 스냅샷(Étape 1)
  function snapshotInputs(){
    document.querySelectorAll('#step1 .p-4').forEach(card=>{
      const btn = card.querySelector('.btn.btn-primary');
      const ko  = card.querySelector('input[placeholder^="받아쓰기"]')?.value||'';
      const fr  = card.querySelector('input[placeholder^="Sens"]')?.value||'';
      const key = btn ? btn.textContent.includes('Écouter') ? (STEP1_DATA[Array.from(card.parentNode.children).indexOf(card)]?.ko||'') : '' : '';
      if (key) Track.inputs.set(key, { ko, fr });
    });
  }

  // Pronun 결과 수집: mountPronun에서 onResult로 전달됨
  // (이미 페이지 상단 mountPronun에서 holder.dispatchEvent('kobito:graded', detail) 발생)
  document.addEventListener('kobito:graded', (e)=>{
    const { ref, hyp, score, refDur, recDur } = e.detail||{};
    if (!ref) return;
    Track.evals.set(ref, {
      score: Number(score||0),
      duration: Number(recDur||0),
      transcript: String(hyp||'')
    });
  });

finishBtn.addEventListener('click', async () => {
  try {
    // ① Étape 1 입력 스냅샷 반영
    snapshotInputs();

    // ② 결과 페이로드 구성(요구된 스키마)
    const studentName = (window.StudentGate?.getName?.() || document.getElementById('student-name')?.value || '').trim();
    const startTime   = window._startTime || new Date().toISOString();
    const endTime     = new Date().toISOString();
    const totalTimeSeconds = Math.max(1, Math.round((Date.now() - (window._startMs || Date.now())) / 1000));

    // KO 문장 키 목록(1→2→3)
    const keys = [
      ...STEP1_DATA.map(x => x.ko),
      ...STEP2_DATA.map(x => x.ko),
      STEP3_TEXT
    ].filter(Boolean);

    // Étape 1의 불어 뜻 매핑
    const frMap = Object.fromEntries(STEP1_DATA.map(x => [x.ko, x.fr || '']));

    const questions = keys.map((k, i) => {
      const inp = window._kobito?.inputs?.get(k) || { ko: '', fr: '' };
      const ev  = window._kobito?.evals?.get(k)  || { score: 0, duration: 0, transcript: '' };
      return {
        number: i + 1,
        ko: k,
        fr: frMap[k] || '',
        userAnswer: String(inp.ko || ''),
        isCorrect: Number(ev.score || 0) >= 60,
        listenCount: Number(window._kobito?.listen?.get(k) || 0),
        hint1Count:  Number(window._kobito?.hint1?.get(k)  || 0),
        hint2Count:  Number(window._kobito?.hint2?.get(k)  || 0),
        recording: {
          base64: "",
          filename: "rec.webm",
          mimeType: "audio/webm",
          duration: Number(ev.duration || 0)
        },
        asrTranscript: String(ev.transcript || ''),
        pronunScore: Number(ev.score || 0)
      };
    });

    const payload = {
      studentName, startTime, endTime, totalTimeSeconds, questions
    };

    // ③ 전송 (로컬 폴백은 results-compat.js가 처리)
    await window.sendResults(payload);

    // ④ 결과 페이지로 이동
    window.location.href = '/results.html';
  } catch (e) {
    console.warn('sendResults failed, opening results viewer via stash', e);
    window.location.href = '/results.html';
  }
});


} // ← if (finishBtn) 블록 닫힘


      } catch(e){
        console.warn('[init-wait]', e);
        // 그래도 학생이 페이지를 쓸 수 있게 최소 렌더 시도
        renderStep1();
        renderStep2();
        renderStep3();
      }
    })();
  });

  </script>
</body>
</html>
