<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice d'Ã©coute en corÃ©en - Dialogue de mariage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }

        .gowun-dodum {
            font-family: 'Gowun Dodum', sans-serif;
        }

        .task-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .task-card:hover {
            transform: translateY(-5px);
        }

        .audio-btn {
            transition: background-color 0.3s, transform 0.2s;
        }

        .audio-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .audio-btn:disabled {
            cursor: not-allowed;
            background-color: #9ca3af;
        }

        .result-box {
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .result-perfect {
            background-color: #e0fbe0;
            border: 1px solid #5cb85c;
            color: #3d8b3d;
        }

        .result-good {
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #3c763d;
        }

        .result-ok {
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            color: #8a6d3b;
        }

        .result-bad {
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            color: #a94442;
        }
        
        .hint-content {
            background-color: #f9fafb;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Exercice d'Ã©coute ğŸ§</h1>
            <p class="text-slate-600 mt-2 text-lg">Dialogue de mariage (ì´ˆë³´ììš©)</p>
        </header>

        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8 rounded-md" role="alert">
            <p class="font-bold">Instructions</p>
            <p>1. Cliquez sur le bouton <i class="fas fa-play"></i> pour Ã©couter la phrase.</p>
            <p>2. Ã‰crivez ce que vous entendez en corÃ©en.</p>
            <p>3. Utilisez les boutons d'indice si vous avez besoin d'aide.</p>
            <p>4. Traduisez la phrase en franÃ§ais pour vÃ©rifier votre comprÃ©hension.</p>
            <p>5. Cliquez sur "VÃ©rifier" pour voir votre score et la correction.</p>
        </div>

        <div id="exercise-container" class="space-y-6">
            <!-- Les questions seront injectÃ©es ici par JavaScript -->
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">ì˜¤ë¥˜ ë°œìƒ</h3>
            <p id="error-message" class="text-slate-700 mb-6"></p>
            <button onclick="closeErrorModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                í™•ì¸
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const questions = [
            { id: 1, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì§„ì˜ì•„!', koreanAnswer: 'ì§„ì˜ì•„!', frenchAnswer: 'Jinyoung !', initialConsonants: 'ã…ˆã…‡ã…‡!', vocabulary: [{ kor: '-ì•„/ì•¼', fr: 'Suffixe vocatif (pour appeler quelqu\'un)' }] },
            { id: 2, speaker: 'ì§„ì˜ (ğŸ‘©)', audioText: 'ì–´! ìˆ˜ì •ì•„, ì™”ì–´?', koreanAnswer: 'ì–´! ìˆ˜ì •ì•„, ì™”ì–´?', frenchAnswer: 'Oh ! Sujeong, tu es lÃ  ?', initialConsonants: 'ã…‡! ã……ã…ˆã…‡, ã…‡ã…‡?', vocabulary: [{ kor: 'ì˜¤ë‹¤', fr: 'venir' }, { kor: 'ì™”ì–´?', fr: 'tu es venu(e) ? (passÃ© informel)' }] },
            { id: 3, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì‘. ì˜¤ëŠ˜ ë„ˆë¬´ ì˜ˆì˜ë‹¤. ì²œì‚¬ ê°™ì•„. ê²°í˜¼ ì •ë§ ì¶•í•˜í•´!', koreanAnswer: 'ì‘. ì˜¤ëŠ˜ ë„ˆë¬´ ì˜ˆì˜ë‹¤. ì²œì‚¬ ê°™ì•„. ê²°í˜¼ ì •ë§ ì¶•í•˜í•´!', frenchAnswer: 'Oui. Tu es si jolie aujourd\'hui. On dirait un ange. Vraiment fÃ©licitations pour ton mariage !', initialConsonants: 'ã…‡. ã…‡ã„´ ã„´ã… ã…‡ã…ƒã„·. ã…Šã…… ã„±ã…‡. ã„±ã… ã…ˆã… ã…Šã…‹ã…!', vocabulary: [{ kor: 'ì˜¤ëŠ˜', fr: 'aujourd\'hui' }, { kor: 'ë„ˆë¬´', fr: 'trÃ¨s' }, { kor: 'ì˜ˆì˜ë‹¤', fr: 'Ãªtre joli(e)' }, { kor: 'ì²œì‚¬', fr: 'ange' }, { kor: 'ê°™ë‹¤', fr: 'ressembler Ã , Ãªtre comme' }, { kor: 'ê²°í˜¼', fr: 'mariage' }, { kor: 'ì •ë§', fr: 'vraiment' }, { kor: 'ì¶•í•˜í•˜ë‹¤', fr: 'fÃ©liciter' }] },
            { id: 4, speaker: 'ì§„ì˜ (ğŸ‘©)', audioText: 'ê³ ë§ˆì›Œ. ê·¸ëŸ°ë° ë‚˜ ì§€ê¸ˆ ë„ˆë¬´ ê¸´ì¥ë¼.', koreanAnswer: 'ê³ ë§ˆì›Œ. ê·¸ëŸ°ë° ë‚˜ ì§€ê¸ˆ ë„ˆë¬´ ê¸´ì¥ë¼.', frenchAnswer: 'Merci. Mais je suis si nerveuse maintenant.', initialConsonants: 'ã„±ã…ã…‡. ã„±ã„¹ã„· ã„´ ã…ˆã„± ã„´ã… ã„±ã…ˆã„·.', vocabulary: [{ kor: 'ê³ ë§™ë‹¤', fr: 'remercier' }, { kor: 'ê·¸ëŸ°ë°', fr: 'mais, cependant' }, { kor: 'ë‚˜', fr: 'je/moi (informel)' }, { kor: 'ì§€ê¸ˆ', fr: 'maintenant' }, { kor: 'ê¸´ì¥ë˜ë‹¤', fr: 'Ãªtre nerveux/tendu' }] },
            { id: 5, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì •ë§? ê¸´ì¥í•˜ì§€ ë§ˆ.', koreanAnswer: 'ì •ë§? ê¸´ì¥í•˜ì§€ ë§ˆ.', frenchAnswer: 'Vraiment ? Ne sois pas nerveuse.', initialConsonants: 'ã…ˆã…? ã„±ã…ˆã…ã…ˆ ã….', vocabulary: [{ kor: '-ì§€ ë§ˆ', fr: 'ne... pas (impÃ©ratif nÃ©gatif)' }] },
            { id: 6, speaker: 'ì§„ì˜ (ğŸ‘©)', audioText: 'ì‘. ì•Œê² ì–´. ê·¼ë° í˜¼ì ì™”ì–´?', koreanAnswer: 'ì‘. ì•Œê² ì–´. ê·¼ë° í˜¼ì ì™”ì–´?', frenchAnswer: 'Oui, d\'accord. Mais tu es venue seule ?', initialConsonants: 'ã…‡. ã…‡ã„±ã…‡. ã„±ã„· ã…ã…ˆ ã…‡ã…‡?', vocabulary: [{ kor: 'ì•Œê² ì–´', fr: 'd\'accord, compris' }, { kor: 'ê·¼ë°', fr: 'mais, au fait (contraction de ê·¸ëŸ°ë°)' }, { kor: 'í˜¼ì', fr: 'seul(e)' }] },
            { id: 7, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì€ì§„ì´ëŠ” ì˜¤ê³  ìˆì–´. ê³§ ë„ì°©í•  ê±°ì•¼.', koreanAnswer: 'ì€ì§„ì´ëŠ” ì˜¤ê³  ìˆì–´. ê³§ ë„ì°©í•  ê±°ì•¼.', frenchAnswer: 'Eunjin est en route. Elle arrivera bientÃ´t.', initialConsonants: 'ã…‡ã…ˆã…‡ã„´ ã…‡ã„± ã…‡ã…‡. ã„± ã„·ã…Šã… ã„±ã…‡.', vocabulary: [{ kor: 'ì˜¤ê³  ìˆë‹¤', fr: 'Ãªtre en train de venir' }, { kor: 'ê³§', fr: 'bientÃ´t' }, { kor: 'ë„ì°©í•˜ë‹¤', fr: 'arriver' }, { kor: '-(ìœ¼)ã„¹ ê±°ì•¼', fr: 'futur (promesse, intention)' }] },
            { id: 8, speaker: 'ì§„ì˜ (ğŸ‘©)', audioText: 'ê·¸ë ‡êµ¬ë‚˜.', koreanAnswer: 'ê·¸ë ‡êµ¬ë‚˜.', frenchAnswer: 'Ah, je vois.', initialConsonants: 'ã„±ã„¹ã„±ã„´.', vocabulary: [{ kor: 'ê·¸ë ‡êµ¬ë‚˜', fr: 'Ah, c\'est donc Ã§a / Je vois' }] },
            { id: 9, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì, ê²°í˜¼ ì„ ë¬¼ì´ì•¼.', koreanAnswer: 'ì, ê²°í˜¼ ì„ ë¬¼ì´ì•¼.', frenchAnswer: 'Tiens, c\'est un cadeau de mariage.', initialConsonants: 'ã…ˆ, ã„±ã… ã……ã…ã…‡ã…‡.', vocabulary: [{ kor: 'ì', fr: 'Tiens !' }, { kor: 'ì„ ë¬¼', fr: 'cadeau' }, { kor: '-ì´ì•¼', fr: 'c\'est... (informel)' }] },
            { id: 10, speaker: 'ì§„ì˜ (ğŸ‘©)', audioText: 'ì •ë§? ê³ ë§ˆì›Œ. ì´ê²Œ ë­ì•¼?', koreanAnswer: 'ì •ë§? ê³ ë§ˆì›Œ. ì´ê²Œ ë­ì•¼?', frenchAnswer: 'Vraiment ? Merci. Qu\'est-ce que c\'est ?', initialConsonants: 'ã…ˆã…? ã„±ã…ã…‡. ã…‡ã„± ã…ã…‡?', vocabulary: [{ kor: 'ì´ê²Œ', fr: 'ceci (contraction de ì´ê²ƒì´)' }, { kor: 'ë­', fr: 'quoi' }] },
            { id: 11, speaker: 'ìˆ˜ì • (ğŸ‘©)', audioText: 'ì»¤í”Œ í‹°ì•¼. ì‹ í˜¼ì—¬í–‰ ê°€ì„œ ì‹ ë‘í•˜ê³  ê°™ì´ ì…ì–´.', koreanAnswer: 'ì»¤í”Œ í‹°ì•¼. ì‹ í˜¼ì—¬í–‰ ê°€ì„œ ì‹ ë‘í•˜ê³  ê°™ì´ ì…ì–´.', frenchAnswer: 'C\'est un t-shirt de couple. Porte-le avec ton mari pendant votre lune de miel.', initialConsonants: 'ã…‹ã… ã…Œã…‡. ã……ã…ã…‡ã… ã„±ã…… ã……ã„¹ã…ã„± ã„±ã…‡ ã…‡ã…‡.', vocabulary: [{ kor: 'ì»¤í”Œ í‹°', fr: 't-shirt de couple' }, { kor: 'ì‹ í˜¼ì—¬í–‰', fr: 'voyage de noces' }, { kor: 'ê°€ì„œ', fr: 'aller et puis...' }, { kor: 'ì‹ ë‘', fr: 'le mariÃ©, son mari' }, { kor: 'ê°™ì´', fr: 'ensemble' }, { kor: 'ì…ë‹¤', fr: 'porter (un vÃªtement)' }] }
        ];

        // --- Levenshtein Distance Function for scoring ---
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // --- Modal Functions ---
        function showErrorModal(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        // --- Core Functions ---
        const exerciseContainer = document.getElementById('exercise-container');

        async function playAudio(id) {
            const question = questions.find(q => q.id === id);
            const button = document.getElementById(`audio-btn-${id}`);
            const icon = button.querySelector('i');

            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: question.audioText,
                        speaker: question.speaker.includes('ìˆ˜ì •') ? 'female' : 'male'
                    }),
                });

                // --- Improved Error Handling ---
                // First, get the raw text of the response to analyze it.
                const responseText = await response.text();
                let data;

                try {
                    // Try to parse the text as JSON.
                    data = JSON.parse(responseText);
                } catch (e) {
                    // If parsing fails, the response was not valid JSON (e.g., an HTML error page).
                    console.error("La rÃ©ponse du serveur n'est pas un JSON valide:", responseText);
                    throw new Error(`RÃ©ponse inattendue du serveur. Le serveur a peut-Ãªtre renvoyÃ© une erreur HTML.`);
                }

                // Now, check if the response status was OK.
                if (!response.ok) {
                    // Use the message from the parsed JSON if available.
                    const errorMessage = data.message || response.statusText;
                    throw new Error(`Erreur du serveur (${response.status}): ${errorMessage}`);
                }

                // Finally, check if the valid JSON contains the audioUrl.
                if (data && data.audioUrl) {
                    const audio = new Audio(data.audioUrl);
                    audio.play();
                    audio.onended = () => {
                        button.disabled = false;
                        icon.className = 'fas fa-play';
                    };
                    audio.onerror = () => {
                        throw new Error("Impossible de charger ou lire le fichier audio depuis l'URL fournie.");
                    }
                } else {
                    // The response was JSON but didn't have the expected URL.
                    console.error("RÃ©ponse JSON reÃ§ue mais sans audioUrl:", data);
                    throw new Error("L'URL de l'audio n'a pas Ã©tÃ© reÃ§ue dans la rÃ©ponse du serveur.");
                }
            } catch (error) {
                console.error("Erreur lors de la lecture de l'audio:", error);
                showErrorModal(error.message || "Une erreur inconnue est survenue lors de la gÃ©nÃ©ration de l'audio.");
                button.disabled = false;
                icon.className = 'fas fa-play';
            }
        }
        
        function renderQuestions() {
            let content = '';
            questions.forEach(q => {
                content += `
                    <div id="card-${q.id}" class="task-card p-5">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-slate-700">Question ${q.id} <span class="text-base font-normal text-slate-500">${q.speaker}</span></h3>
                            <button onclick="playAudio(${q.id})" id="audio-btn-${q.id}" class="audio-btn bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label for="korean-input-${q.id}" class="block text-sm font-medium text-slate-600 mb-1">Ã‰crivez en corÃ©en :</label>
                                <input type="text" id="korean-input-${q.id}" class="gowun-dodum w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent" placeholder="ë“¤ë¦¬ëŠ” ëŒ€ë¡œ ì ì–´ë³´ì„¸ìš”...">
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="showHint(${q.id}, 'consonants')" class="text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 py-1 px-3 rounded-full">Indice 1 (ì´ˆì„±)</button>
                                <button onclick="showHint(${q.id}, 'vocab')" class="text-sm bg-amber-200 hover:bg-amber-300 text-amber-800 py-1 px-3 rounded-full">Indice 2 (Vocabulaire)</button>
                            </div>
                            <div id="hint-box-${q.id}" class="hidden"></div>
                            <div>
                                <label for="french-input-${q.id}" class="block text-sm font-medium text-slate-600 mb-1">Traduisez en franÃ§ais :</label>
                                <input type="text" id="french-input-${q.id}" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-transparent" placeholder="í•œêµ­ì–´ ë¬¸ì¥ì„ ë²ˆì—­í•´ ë³´ì„¸ìš”...">
                            </div>
                        </div>
                        <div class="mt-4 text-right">
                            <button onclick="checkAnswer(${q.id})" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
                                VÃ©rifier
                            </button>
                        </div>
                        <div id="result-box-${q.id}" class="result-box hidden"></div>
                    </div>
                `;
            });
            exerciseContainer.innerHTML = content;
        }

        function showHint(id, type) {
            const question = questions.find(q => q.id === id);
            const hintBox = document.getElementById(`hint-box-${id}`);
            let hintContent = '';

            if (type === 'consonants') {
                hintContent = `<p class="text-slate-700 font-mono text-lg">${question.initialConsonants}</p>`;
            } else if (type === 'vocab') {
                hintContent = '<ul class="list-disc list-inside space-y-1">';
                question.vocabulary.forEach(v => {
                    hintContent += `<li><strong class="gowun-dodum">${v.kor}</strong>: ${v.fr}</li>`;
                });
                hintContent += '</ul>';
            }
            
            hintBox.innerHTML = `<div class="hint-content">${hintContent}</div>`;
            hintBox.classList.remove('hidden');
        }

        function checkAnswer(id) {
            const question = questions.find(q => q.id === id);
            const koreanInput = document.getElementById(`korean-input-${q.id}`).value.trim();
            const resultBox = document.getElementById(`result-box-${q.id}`);

            const cleanAnswer = str => str.replace(/[.,!?\s]/g, '');
            const userAnswerClean = cleanAnswer(koreanInput);
            const correctAnswerClean = cleanAnswer(question.koreanAnswer);

            const distance = levenshtein(userAnswerClean, correctAnswerClean);
            const maxLength = Math.max(userAnswerClean.length, correctAnswerClean.length);
            const score = maxLength === 0 ? 100 : (1 - distance / maxLength) * 100;

            let resultHTML = '';
            let resultClass = '';

            if (score === 100) {
                resultClass = 'result-perfect';
                resultHTML = '<p class="font-bold text-xl">ì™„ë²½í•´ìš”! ğŸ‘‘ğŸ‰ğŸ‘ (Parfait !)</p>';
            } else if (score >= 80) {
                resultClass = 'result-good';
                resultHTML = '<p class="font-bold text-lg">ì˜í–ˆì–´ìš”! ğŸ‰ğŸ‘ (Bien jouÃ© !)</p>';
            } else if (score >= 60) {
                resultClass = 'result-ok';
                resultHTML = '<p class="font-bold">ê½¤ ì˜í–ˆì–´ìš”. ğŸ‘ (Assez bien fait.)</p>';
            } else {
                resultClass = 'result-bad';
                resultHTML = '<p class="font-bold">ë•¡! í‹€ë ¸ì–´ìš”! (Bip ! Faux !)</p>';
            }

            if (score < 100) {
                resultHTML += `
                    <div class="mt-2 text-left text-sm">
                        <p><strong>Votre rÃ©ponse :</strong> <span class="gowun-dodum">${koreanInput || "<em>(vide)</em>"}</span></p>
                        <p><strong>RÃ©ponse correcte :</strong> <span class="gowun-dodum">${question.koreanAnswer}</span></p>
                    </div>
                `;
            }
            
            resultHTML += `<hr class="my-2"><p class="text-left text-sm"><strong>Traduction :</strong> ${question.frenchAnswer}</p>`;

            resultBox.innerHTML = resultHTML;
            resultBox.className = `result-box ${resultClass}`;
            resultBox.classList.remove('hidden');
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', renderQuestions);
    </script>
</body>

</html>
