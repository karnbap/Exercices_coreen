<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice d'√©coute en cor√©en - Dialogue de mariage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }

        .gowun-dodum {
            font-family: 'Gowun Dodum', sans-serif;
        }

        .task-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .task-card:hover {
            transform: translateY(-5px);
        }

        .audio-btn {
            transition: background-color 0.3s, transform 0.2s;
        }

        .audio-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .audio-btn:disabled {
            cursor: not-allowed;
            background-color: #9ca3af;
        }

        .result-box {
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .result-perfect {
            background-color: #e0fbe0;
            border: 1px solid #5cb85c;
            color: #3d8b3d;
        }

        .result-good {
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #3c763d;
        }

        .result-ok {
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            color: #8a6d3b;
        }

        .result-bad {
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            color: #a94442;
        }
        
        .hint-content {
            background-color: #f9fafb;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-800">Exercice d'√©coute üéß</h1>
            <p class="text-slate-600 mt-2 text-lg">Dialogue de mariage (Ï¥àÎ≥¥ÏûêÏö©)</p>
        </header>

        <!-- Student Info Section -->
        <div class="bg-white p-5 rounded-lg shadow-md mb-8">
            <label for="student-name" class="block text-lg font-bold text-slate-700 mb-2">Entrez votre nom :</label>
            <input type="text" id="student-name" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400" placeholder="Ex: C√©dric">
        </div>

        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8 rounded-md" role="alert">
            <p class="font-bold">Instructions</p>
            <p>1. Entrez votre nom ci-dessus pour commencer.</p>
            <p>2. Cliquez sur <i class="fas fa-play"></i> pour √©couter, puis √©crivez et traduisez la phrase.</p>
            <p>3. Quand vous avez termin√©, cliquez sur le bouton "Terminer et envoyer les r√©sultats" en bas de la page.</p>
        </div>

        <div id="exercise-container" class="space-y-6">
            <!-- Les questions seront inject√©es ici par JavaScript -->
        </div>

        <!-- Finish Button -->
        <div class="mt-10 text-center">
            <button id="finish-btn" onclick="sendResults()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed">
                <i class="fas fa-paper-plane mr-2"></i> Terminer et envoyer les r√©sultats
            </button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-slate-700 mb-6"></p>
            <button onclick="closeModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                ÌôïÏù∏
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const questions = [
            { id: 1, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'ÏßÑÏòÅÏïÑ!', koreanAnswer: 'ÏßÑÏòÅÏïÑ!', frenchAnswer: 'Jinyoung !', initialConsonants: '„Öà„Öá„Öá!', vocabulary: [{ kor: '-ÏïÑ/Ïïº', fr: 'Suffixe vocatif (pour appeler quelqu\'un)' }] },
            { id: 2, speaker: 'ÏßÑÏòÅ (üë©)', audioText: 'Ïñ¥! ÏàòÏ†ïÏïÑ, ÏôîÏñ¥?', koreanAnswer: 'Ïñ¥! ÏàòÏ†ïÏïÑ, ÏôîÏñ¥?', frenchAnswer: 'Oh ! Sujeong, tu es l√† ?', initialConsonants: '„Öá! „ÖÖ„Öà„Öá, „Öá„Öá?', vocabulary: [{ kor: 'Ïò§Îã§', fr: 'venir' }, { kor: 'ÏôîÏñ¥?', fr: 'tu es venu(e) ? (pass√© informel)' }] },
            { id: 3, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'Ïùë. Ïò§Îäò ÎÑàÎ¨¥ ÏòàÏÅòÎã§. Ï≤úÏÇ¨ Í∞ôÏïÑ. Í≤∞Ìòº Ï†ïÎßê Ï∂ïÌïòÌï¥!', koreanAnswer: 'Ïùë. Ïò§Îäò ÎÑàÎ¨¥ ÏòàÏÅòÎã§. Ï≤úÏÇ¨ Í∞ôÏïÑ. Í≤∞Ìòº Ï†ïÎßê Ï∂ïÌïòÌï¥!', frenchAnswer: 'Oui. Tu es si jolie aujourd\'hui. On dirait un ange. Vraiment f√©licitations pour ton mariage !', initialConsonants: '„Öá. „Öá„Ñ¥ „Ñ¥„ÖÅ „Öá„ÖÉ„Ñ∑. „Öä„ÖÖ „Ñ±„Öá. „Ñ±„Öé „Öà„ÖÅ „Öä„Öã„Öé!', vocabulary: [{ kor: 'Ïò§Îäò', fr: 'aujourd\'hui' }, { kor: 'ÎÑàÎ¨¥', fr: 'tr√®s' }, { kor: 'ÏòàÏÅòÎã§', fr: '√™tre joli(e)' }, { kor: 'Ï≤úÏÇ¨', fr: 'ange' }, { kor: 'Í∞ôÎã§', fr: 'ressembler √†, √™tre comme' }, { kor: 'Í≤∞Ìòº', fr: 'mariage' }, { kor: 'Ï†ïÎßê', fr: 'vraiment' }, { kor: 'Ï∂ïÌïòÌïòÎã§', fr: 'f√©liciter' }] },
            { id: 4, speaker: 'ÏßÑÏòÅ (üë©)', audioText: 'Í≥†ÎßàÏõå. Í∑∏Îü∞Îç∞ ÎÇò ÏßÄÍ∏à ÎÑàÎ¨¥ Í∏¥Ïû•Îèº.', koreanAnswer: 'Í≥†ÎßàÏõå. Í∑∏Îü∞Îç∞ ÎÇò ÏßÄÍ∏à ÎÑàÎ¨¥ Í∏¥Ïû•Îèº.', frenchAnswer: 'Merci. Mais je suis si nerveuse maintenant.', initialConsonants: '„Ñ±„ÖÅ„Öá. „Ñ±„Ñπ„Ñ∑ „Ñ¥ „Öà„Ñ± „Ñ¥„ÖÅ „Ñ±„Öà„Ñ∑.', vocabulary: [{ kor: 'Í≥†ÎßôÎã§', fr: 'remercier' }, { kor: 'Í∑∏Îü∞Îç∞', fr: 'mais, cependant' }, { kor: 'ÎÇò', fr: 'je/moi (informel)' }, { kor: 'ÏßÄÍ∏à', fr: 'maintenant' }, { kor: 'Í∏¥Ïû•ÎêòÎã§', fr: '√™tre nerveux/tendu' }] },
            { id: 5, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'Ï†ïÎßê? Í∏¥Ïû•ÌïòÏßÄ Îßà.', koreanAnswer: 'Ï†ïÎßê? Í∏¥Ïû•ÌïòÏßÄ Îßà.', frenchAnswer: 'Vraiment ? Ne sois pas nerveuse.', initialConsonants: '„Öà„ÖÅ? „Ñ±„Öà„Öé„Öà „ÖÅ.', vocabulary: [{ kor: '-ÏßÄ Îßà', fr: 'ne... pas (imp√©ratif n√©gatif)' }] },
            { id: 6, speaker: 'ÏßÑÏòÅ (üë©)', audioText: 'Ïùë. ÏïåÍ≤†Ïñ¥. Í∑ºÎç∞ ÌòºÏûê ÏôîÏñ¥?', koreanAnswer: 'Ïùë. ÏïåÍ≤†Ïñ¥. Í∑ºÎç∞ ÌòºÏûê ÏôîÏñ¥?', frenchAnswer: 'Oui, d\'accord. Mais tu es venue seule ?', initialConsonants: '„Öá. „Öá„Ñ±„Öá. „Ñ±„Ñ∑ „Öé„Öà „Öá„Öá?', vocabulary: [{ kor: 'ÏïåÍ≤†Ïñ¥', fr: 'd\'accord, compris' }, { kor: 'Í∑ºÎç∞', fr: 'mais, au fait (contraction de Í∑∏Îü∞Îç∞)' }, { kor: 'ÌòºÏûê', fr: 'seul(e)' }] },
            { id: 7, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'ÏùÄÏßÑÏù¥Îäî Ïò§Í≥† ÏûàÏñ¥. Í≥ß ÎèÑÏ∞©Ìï† Í±∞Ïïº.', koreanAnswer: 'ÏùÄÏßÑÏù¥Îäî Ïò§Í≥† ÏûàÏñ¥. Í≥ß ÎèÑÏ∞©Ìï† Í±∞Ïïº.', frenchAnswer: 'Eunjin est en route. Elle arrivera bient√¥t.', initialConsonants: '„Öá„Öà„Öá„Ñ¥ „Öá„Ñ± „Öá„Öá. „Ñ± „Ñ∑„Öä„Öé „Ñ±„Öá.', vocabulary: [{ kor: 'Ïò§Í≥† ÏûàÎã§', fr: '√™tre en train de venir' }, { kor: 'Í≥ß', fr: 'bient√¥t' }, { kor: 'ÎèÑÏ∞©ÌïòÎã§', fr: 'arriver' }, { kor: '-(Ïúº)„Ñπ Í±∞Ïïº', fr: 'futur (promesse, intention)' }] },
            { id: 8, speaker: 'ÏßÑÏòÅ (üë©)', audioText: 'Í∑∏Î†áÍµ¨ÎÇò.', koreanAnswer: 'Í∑∏Î†áÍµ¨ÎÇò.', frenchAnswer: 'Ah, je vois.', initialConsonants: '„Ñ±„Ñπ„Ñ±„Ñ¥.', vocabulary: [{ kor: 'Í∑∏Î†áÍµ¨ÎÇò', fr: 'Ah, c\'est donc √ßa / Je vois' }] },
            { id: 9, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'Ïûê, Í≤∞Ìòº ÏÑ†Î¨ºÏù¥Ïïº.', koreanAnswer: 'Ïûê, Í≤∞Ìòº ÏÑ†Î¨ºÏù¥Ïïº.', frenchAnswer: 'Tiens, c\'est un cadeau de mariage.', initialConsonants: '„Öà, „Ñ±„Öé „ÖÖ„ÖÅ„Öá„Öá.', vocabulary: [{ kor: 'Ïûê', fr: 'Tiens !' }, { kor: 'ÏÑ†Î¨º', fr: 'cadeau' }, { kor: '-Ïù¥Ïïº', fr: 'c\'est... (informel)' }] },
            { id: 10, speaker: 'ÏßÑÏòÅ (üë©)', audioText: 'Ï†ïÎßê? Í≥†ÎßàÏõå. Ïù¥Í≤å Î≠êÏïº?', koreanAnswer: 'Ï†ïÎßê? Í≥†ÎßàÏõå. Ïù¥Í≤å Î≠êÏïº?', frenchAnswer: 'Vraiment ? Merci. Qu\'est-ce que c\'est ?', initialConsonants: '„Öà„ÖÅ? „Ñ±„ÖÅ„Öá. „Öá„Ñ± „ÖÅ„Öá?', vocabulary: [{ kor: 'Ïù¥Í≤å', fr: 'ceci (contraction de Ïù¥Í≤ÉÏù¥)' }, { kor: 'Î≠ê', fr: 'quoi' }] },
            { id: 11, speaker: 'ÏàòÏ†ï (üë©)', audioText: 'Ïª§Ìîå Ìã∞Ïïº. Ïã†ÌòºÏó¨Ìñâ Í∞ÄÏÑú Ïã†ÎûëÌïòÍ≥† Í∞ôÏù¥ ÏûÖÏñ¥.', koreanAnswer: 'Ïª§Ìîå Ìã∞Ïïº. Ïã†ÌòºÏó¨Ìñâ Í∞ÄÏÑú Ïã†ÎûëÌïòÍ≥† Í∞ôÏù¥ ÏûÖÏñ¥.', frenchAnswer: 'C\'est un t-shirt de couple. Porte-le avec ton mari pendant votre lune de miel.', initialConsonants: '„Öã„Öç „Öå„Öá. „ÖÖ„Öé„Öá„Öé „Ñ±„ÖÖ „ÖÖ„Ñπ„Öé„Ñ± „Ñ±„Öá „Öá„Öá.', vocabulary: [{ kor: 'Ïª§Ìîå Ìã∞', fr: 't-shirt de couple' }, { kor: 'Ïã†ÌòºÏó¨Ìñâ', fr: 'voyage de noces' }, { kor: 'Í∞ÄÏÑú', fr: 'aller et puis...' }, { kor: 'Ïã†Îûë', fr: 'le mari√©, son mari' }, { kor: 'Í∞ôÏù¥', fr: 'ensemble' }, { kor: 'ÏûÖÎã§', fr: 'porter (un v√™tement)' }] }
        ];

        // --- Student Data Tracking ---
        let studentData = {
            studentName: '',
            startTime: null,
            questions: questions.map(q => ({
                id: q.id,
                questionText: q.koreanAnswer,
                listenCount: 0,
                mistakeCount: 0,
                userAnswer: '',
                isCorrect: null
            }))
        };
        let isTestStarted = false;

        function startTestIfNeeded() {
            if (isTestStarted) return;
            const studentName = document.getElementById('student-name').value.trim();
            if (!studentName) {
                showModal('Attention !', 'Veuillez entrer votre nom avant de commencer.');
                throw new Error("Student name is required.");
            }
            isTestStarted = true;
            studentData.studentName = studentName;
            studentData.startTime = new Date();
            console.log(`Test started for ${studentName}`);
        }

        // --- Levenshtein Distance Function for scoring ---
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // --- Modal Functions ---
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // Use innerHTML to render potential HTML in message
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // --- Core Functions ---
        const exerciseContainer = document.getElementById('exercise-container');

        // --- [MODIFIED] Audio Playback Function ---
        async function playAudio(id) {
            try {
                startTestIfNeeded();
            } catch (e) {
                return; // Stop if name is not entered
            }
            
            const questionData = studentData.questions.find(q => q.id === id);
            questionData.listenCount++;

            const question = questions.find(q => q.id === id);
            const button = document.getElementById(`audio-btn-${id}`);
            const icon = button.querySelector('i');

            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: question.audioText }),
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`R√©ponse inattendue du serveur: ${responseText}`);
                }

                if (!response.ok) {
                    throw new Error(`Erreur du serveur (${response.status}): ${data.error || 'Erreur inconnue'}`);
                }

                if (data && data.audioData && data.mimeType) {
                    // The API returns raw PCM data. We need to wrap it in a WAV container to play it in the browser.
                    const sampleRateMatch = data.mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) {
                        throw new Error("Le format audio (sample rate) est manquant dans la r√©ponse.");
                    }
                    const sampleRate = parseInt(sampleRateMatch[1], 10);

                    const pcmData = base64ToArrayBuffer(data.audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        button.disabled = false;
                        icon.className = 'fas fa-play';
                        URL.revokeObjectURL(audioUrl); // Clean up memory
                    };
                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        throw new Error("Impossible de lire le fichier audio g√©n√©r√©.");
                    }
                } else {
                    throw new Error("Les donn√©es audio (audioData) ou le type MIME (mimeType) n'ont pas √©t√© trouv√©s dans la r√©ponse du serveur.");
                }
            } catch (error) {
                console.error("Erreur Audio:", error);
                showModal('Erreur Audio', error.message);
                button.disabled = false;
                icon.className = 'fas fa-play';
            }
        }

        // --- [NEW] Helper functions to create a playable WAV file ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // 16 for PCM
            view.setUint16(20, 1, true); // Audio format 1 for PCM
            view.setUint16(22, 1, true); // Number of channels 1 for mono
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, sampleRate * 2, true); // Byte rate
            view.setUint16(32, 2, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample
            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            return new Blob([view, pcm16], { type: 'audio/wav' });
        }
        
        function renderQuestions() {
            exerciseContainer.innerHTML = questions.map(q => `
                <div id="card-${q.id}" class="task-card p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-slate-700">Question ${q.id} <span class="text-base font-normal text-slate-500">${q.speaker}</span></h3>
                        <button onclick="playAudio(${q.id})" id="audio-btn-${q.id}" class="audio-btn bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl"><i class="fas fa-play"></i></button>
                    </div>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="korean-input-${q.id}" class="block text-sm font-medium text-slate-600 mb-1">√âcrivez en cor√©en :</label>
                            <input type="text" id="korean-input-${q.id}" class="gowun-dodum w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400" placeholder="Îì§Î¶¨Îäî ÎåÄÎ°ú Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî...">
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showHint(${q.id}, 'consonants')" class="text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 py-1 px-3 rounded-full">Indice 1 (Ï¥àÏÑ±)</button>
                            <button onclick="showHint(${q.id}, 'vocab')" class="text-sm bg-amber-200 hover:bg-amber-300 text-amber-800 py-1 px-3 rounded-full">Indice 2 (Vocabulaire)</button>
                        </div>
                        <div id="hint-box-${q.id}" class="hidden"></div>
                        <div>
                            <label for="french-input-${q.id}" class="block text-sm font-medium text-slate-600 mb-1">Traduisez en fran√ßais :</label>
                            <input type="text" id="french-input-${q.id}" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-400" placeholder="ÌïúÍµ≠Ïñ¥ Î¨∏Ïû•ÏùÑ Î≤àÏó≠Ìï¥ Î≥¥ÏÑ∏Ïöî...">
                        </div>
                    </div>
                    <div class="mt-4 text-right">
                        <button onclick="checkAnswer(${q.id})" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">V√©rifier</button>
                    </div>
                    <div id="result-box-${q.id}" class="result-box hidden"></div>
                </div>
            `).join('');
        }

        function showHint(id, type) {
            try { startTestIfNeeded(); } catch (e) { return; }
            const question = questions.find(q => q.id === id);
            const hintBox = document.getElementById(`hint-box-${id}`);
            let hintContent = '';
            if (type === 'consonants') {
                hintContent = `<p class="text-slate-700 font-mono text-lg">${question.initialConsonants}</p>`;
            } else if (type === 'vocab') {
                hintContent = '<ul class="list-disc list-inside space-y-1">';
                question.vocabulary.forEach(v => { hintContent += `<li><strong class="gowun-dodum">${v.kor}</strong>: ${v.fr}</li>`; });
                hintContent += '</ul>';
            }
            hintBox.innerHTML = `<div class="hint-content">${hintContent}</div>`;
            hintBox.classList.remove('hidden');
        }

        function checkAnswer(id) {
            try { startTestIfNeeded(); } catch (e) { return; }
            
            const question = questions.find(q => q.id === id);
            const questionData = studentData.questions.find(q => q.id === id);
            const koreanInput = document.getElementById(`korean-input-${id}`).value.trim();
            const resultBox = document.getElementById(`result-box-${id}`);

            questionData.userAnswer = koreanInput;

            const cleanAnswer = str => str.replace(/[.,!?\s]/g, '');
            const userAnswerClean = cleanAnswer(koreanInput);
            const correctAnswerClean = cleanAnswer(question.koreanAnswer);

            const distance = levenshtein(userAnswerClean, correctAnswerClean);
            const maxLength = Math.max(userAnswerClean.length, correctAnswerClean.length);
            const score = maxLength === 0 && userAnswerClean.length === 0 ? 100 : (1 - distance / maxLength) * 100;

            let resultHTML = '';
            let resultClass = '';

            if (score === 100) {
                resultClass = 'result-perfect';
                resultHTML = '<p class="font-bold text-xl">ÏôÑÎ≤ΩÌï¥Ïöî! üëëüéâüëç (Parfait !)</p>';
                if (questionData.isCorrect === null) {
                    questionData.isCorrect = true;
                }
            } else {
                if(questionData.isCorrect === null) { // Count mistakes only on the first wrong try
                    questionData.mistakeCount++;
                }
                questionData.isCorrect = false;

                if (score >= 80) {
                    resultClass = 'result-good';
                    resultHTML = '<p class="font-bold text-lg">ÏûòÌñàÏñ¥Ïöî! üéâüëç (Bien jou√© !)</p>';
                } else if (score >= 60) {
                    resultClass = 'result-ok';
                    resultHTML = '<p class="font-bold">ÍΩ§ ÏûòÌñàÏñ¥Ïöî. üëç (Assez bien fait.)</p>';
                } else {
                    resultClass = 'result-bad';
                    resultHTML = '<p class="font-bold">Îï°! ÌãÄÎ†∏Ïñ¥Ïöî! (Bip ! Faux !)</p>';
                }
            }

            if (score < 100) {
                resultHTML += `
                    <div class="mt-2 text-left text-sm">
                        <p><strong>Votre r√©ponse :</strong> <span class="gowun-dodum">${koreanInput || "<em>(vide)</em>"}</span></p>
                        <p><strong>R√©ponse correcte :</strong> <span class="gowun-dodum">${question.koreanAnswer}</span></p>
                    </div>
                `;
            }
            resultHTML += `<hr class="my-2"><p class="text-left text-sm"><strong>Traduction :</strong> ${question.frenchAnswer}</p>`;
            resultBox.innerHTML = resultHTML;
            resultBox.className = `result-box ${resultClass}`;
            resultBox.classList.remove('hidden');
        }

        async function sendResults() {
            if (!isTestStarted) {
                showModal('Attention !', 'Veuillez entrer votre nom et r√©pondre √† au moins une question avant d\'envoyer les r√©sultats.');
                return;
            }

            const finishBtn = document.getElementById('finish-btn');
            finishBtn.disabled = true;
            finishBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Envoi en cours...';

            // Update all answers before sending
            questions.forEach(q => {
                const koreanInput = document.getElementById(`korean-input-${q.id}`).value.trim();
                const studentAnswerData = studentData.questions.find(sd => sd.id === q.id);
                if (studentAnswerData) {
                    studentAnswerData.userAnswer = koreanInput;
                }
            });

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Une erreur est survenue lors de l\'envoi des r√©sultats.');
                }

                showModal('Succ√®s !', 'Vos r√©sultats ont √©t√© envoy√©s avec succ√®s. Merci !');
            } catch (error) {
                console.error('Failed to send results:', error);
                showModal('Erreur', `Impossible d'envoyer les r√©sultats. Veuillez r√©essayer plus tard. (${error.message})`);
            } finally {
                finishBtn.disabled = false;
                finishBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Terminer et envoyer les r√©sultats';
            }
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', renderQuestions);
    </script>
</body>

</html>
