<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice : Conjugaison AvancÃ©e (ì‹¬í™” ë™ì‚¬ ë³€í™”)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/style.css">
    <style>
        /* Base styles for option buttons */
        .option-btn {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .option-btn.selected {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            transform: scale(1.05);
            border-color: #2563eb; /* bg-blue-700 */
        }
        .option-btn.correct {
            background-color: #22c55e; /* bg-green-500 */
            color: white;
        }
        .option-btn.incorrect {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
        }

        /* Page visibility */
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }

        /* Enhanced button styles */
        .control-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem; /* 8px */
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .control-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .control-button:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Specific button colors */
        .listen-button { background-color: #3b82f6; } /* bg-blue-500 */
        .listen-button:hover { background-color: #2563eb; } /* bg-blue-600 */
        
        .record-button { background-color: #ef4444; } /* bg-red-500 */
        .record-button:hover { background-color: #dc2626; } /* bg-red-600 */

        .stop-button { background-color: #4b5563; } /* bg-gray-600 */
        .stop-button:hover { background-color: #1f2937; } /* bg-gray-800 */

        .hint-button { background-color: #f59e0b; color: #422006;} /* bg-amber-500 */
        .hint-button:hover { background-color: #d97706; } /* bg-amber-600 */

        .nav-button { background-color: #6b7280; } /* bg-gray-500 */
        .nav-button:hover { background-color: #4b5563; } /* bg-gray-600 */
        
        .finish-button { background-color: #22c55e; } /* bg-green-500 */
        .finish-button:hover { background-color: #16a34a; } /* bg-green-600 */
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Exercice de Conjugaison AvancÃ©e ğŸš€</h1>
                <p class="text-gray-600">ì‹¬í™” ë™ì‚¬ ë³€í™” ì—°ìŠµ</p>
            </div>
            <div class="text-right">
                <button onclick="window.print()" class="control-button print-button">
                    <i class="fas fa-print"></i> <span class="hidden sm:inline">Imprimer | í”„ë¦°íŠ¸</span>
                </button>
                 <div class="made-by-text">Made by ì„±ì¼, Pongdang</div>
            </div>
        </header>

        <!-- Student Name Input -->
        <div id="name-section" class="mb-8 text-center">
            <input type="text" id="student-name" class="w-full max-w-md p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition" placeholder="Entrez votre nom (ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”)">
            <button id="start-btn" class="w-full max-w-md mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                Commencer l'exercice (ì—°ìŠµ ì‹œì‘)
            </button>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="hidden">
            <!-- Explanation 1: Basics -->
            <div id="page-explanation-1" class="page-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Rappel 1 : Les bases ! (ê¸°ì´ˆ ë³µìŠµ!)</h2>
                <p class="mb-2">En corÃ©en, la forme d'un verbe change selon le <strong>temps</strong> et le <strong>niveau de politesse</strong>.</p>
                <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li><strong>Infinitif (ë™ì‚¬ ì›í˜•)</strong> : La forme de base du dictionnaire, se termine toujours par <code class="bg-gray-200 rounded px-1">ë‹¤</code>. Ex: <code class="bg-gray-200 rounded px-1">ë¨¹ë‹¤</code> (manger).</li>
                    <li><strong>Radical (ì–´ê°„)</strong> : La partie du verbe sans le <code class="bg-gray-200 rounded px-1">ë‹¤</code>. Ex: <code class="bg-gray-200 rounded px-1">ë¨¹</code>.</li>
                    <li><strong>Niveaux de politesse (ë†’ì„ë§)</strong>:
                        <ul class="list-disc list-inside ml-6 mt-1">
                            <li><strong>Formel (ê²©ì‹ì²´)</strong> : <code class="bg-gray-200 rounded px-1">-(ìŠ¤)ã…‚ë‹ˆë‹¤</code>. Pour les situations trÃ¨s formelles.</li>
                            <li><strong>Standard (í•´ìš”ì²´)</strong> : <code class="bg-gray-200 rounded px-1">-ì•„/ì–´/í•´ìš”</code>. Le plus courant !</li>
                            <li><strong>Informel (ë°˜ë§)</strong> : <code class="bg-gray-200 rounded px-1">-ì•„/ì–´</code>. Avec les amis trÃ¨s proches.</li>
                        </ul>
                    </li>
                </ul>
                <p class="mt-4">Maintenant, un petit exercice sur ces bases !</p>
            </div>

            <!-- Explanation 2: Tenses -->
            <div id="page-explanation-2" class="page-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Rappel 2 : Comment former les temps ? (ì‹œì œ ë§Œë“¤ê¸°)</h2>
                <p class="mb-3">Pour conjuguer, on attache une terminaison au <strong>radical</strong> du verbe.</p>
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-lg text-blue-600">PrÃ©sent (í˜„ì¬í˜•) : -ì•„ìš” / -ì–´ìš” / -í•´ìš”</h3>
                        <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>ã…</strong> ou <strong>ã…—</strong> â†’ <code class="bg-gray-200 rounded px-1">ì•„ìš”</code> (Ex: ê°€ë‹¤ â†’ ê°€ + ì•„ìš” = ê°€ìš”)</li>
                            <li>Radical avec <strong>autres voyelles</strong> â†’ <code class="bg-gray-200 rounded px-1">ì–´ìš”</code> (Ex: ë¨¹ë‹¤ â†’ ë¨¹ + ì–´ìš” = ë¨¹ì–´ìš”)</li>
                            <li>Verbes en <strong>í•˜ë‹¤</strong> â†’ <code class="bg-gray-200 rounded px-1">í•´ìš”</code> (Ex: ê³µë¶€í•˜ë‹¤ â†’ ê³µë¶€í•´ìš”)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-green-600">PassÃ© (ê³¼ê±°í˜•) : -ì•˜ì–´ìš” / -ì—ˆì–´ìš” / -í–ˆì–´ìš”</h3>
                         <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>ã…</strong> ou <strong>ã…—</strong> â†’ <code class="bg-gray-200 rounded px-1">ì•˜ì–´ìš”</code> (Ex: ë³´ë‹¤ â†’ ë³´ + ì•˜ì–´ìš” = ë´¤ì–´ìš”)</li>
                            <li>Radical avec <strong>autres voyelles</strong> â†’ <code class="bg-gray-200 rounded px-1">ì—ˆì–´ìš”</code> (Ex: ì½ë‹¤ â†’ ì½ + ì—ˆì–´ìš” = ì½ì—ˆì–´ìš”)</li>
                            <li>Verbes en <strong>í•˜ë‹¤</strong> â†’ <code class="bg-gray-200 rounded px-1">í–ˆì–´ìš”</code> (Ex: ì¼í•˜ë‹¤ â†’ ì¼í–ˆì–´ìš”)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-purple-600">Futur (ë¯¸ë˜í˜•) : -(ìœ¼)ã„¹ ê±°ì˜ˆìš”</h3>
                         <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>consonne finale (ë°›ì¹¨)</strong> â†’ <code class="bg-gray-200 rounded px-1">ì„ ê±°ì˜ˆìš”</code> (Ex: ë§Œë“¤ë‹¤ â†’ ë§Œë“¤ + ê±°ì˜ˆìš” = ë§Œë“¤ ê±°ì˜ˆìš”)</li>
                            <li>Radical <strong>sans consonne finale</strong> â†’ <code class="bg-gray-200 rounded px-1">ã„¹ ê±°ì˜ˆìš”</code> (Ex: ìë‹¤ â†’ ì + ã„¹ ê±°ì˜ˆìš” = ì˜ ê±°ì˜ˆìš”)</li>
                        </ul>
                    </div>
                </div>
                 <p class="mt-4">Passons aux exercices sur les temps !</p>
            </div>

            <!-- Quiz Parts will be dynamically rendered here -->
            <div id="quiz-parts-container"></div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between items-center">
                <button id="prev-btn" class="control-button nav-button">
                    <i class="fas fa-arrow-left"></i> PrÃ©cÃ©dent (ì´ì „)
                </button>
                <span id="progress-text" class="text-gray-600 font-semibold"></span>
                <button id="next-btn" class="control-button nav-button">
                    Suivant (ë‹¤ìŒ) <i class="fas fa-arrow-right"></i>
                </button>
                <button id="finish-btn" class="control-button finish-button hidden">
                    Terminer (ëë‚´ê¸°) <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </main>
        
        <footer class="mt-8 text-center">
            <a href="/index.html" class="text-blue-500 hover:underline">
                <i class="fas fa-arrow-left"></i> Retour Ã  la liste (ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°)
            </a>
            <div class="made-by-text mt-4">Made by ì„±ì¼, Pongdang</div>
        </footer>
    </div>
    
    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full text-center transform transition-all scale-95">
            <h2 class="text-3xl font-bold mb-4" id="result-title">Bravo !</h2>
            <p class="text-lg mb-6" id="result-message"></p>
            <button onclick="location.reload()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                Recommencer (ë‹¤ì‹œí•˜ê¸°)
            </button>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            studentName: '',
            startTime: null,
            endTime: null,
            currentPageIndex: 0,
            pages: [], // Will hold the sequence of explanations and quizzes
            parts: [], // Will hold the quiz data
            isSubmitting: false,
        };

        // --- Verb Data ---
        const verbs = [
            { inf: 'ë¨¹ë‹¤', p: 'ë¨¹ì–´ìš”', pa: 'ë¨¹ì—ˆì–´ìš”', f: 'ë¨¹ì„ ê±°ì˜ˆìš”', l: 'ë¨¹ì–´', fml: 'ë¨¹ìŠµë‹ˆë‹¤', fr: 'manger', rule: { tense: 'other_vowel', future: 'batchim' } },
            { inf: 'ê°€ë‹¤', p: 'ê°€ìš”', pa: 'ê°”ì–´ìš”', f: 'ê°ˆ ê±°ì˜ˆìš”', l: 'ê°€', fml: 'ê°‘ë‹ˆë‹¤', fr: 'aller', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: 'í•˜ë‹¤', p: 'í•´ìš”', pa: 'í–ˆì–´ìš”', f: 'í•  ê±°ì˜ˆìš”', l: 'í•´', fml: 'í•©ë‹ˆë‹¤', fr: 'faire', rule: { tense: 'hada', future: 'no_batchim' } },
            { inf: 'ë³´ë‹¤', p: 'ë´ìš”', pa: 'ë´¤ì–´ìš”', f: 'ë³¼ ê±°ì˜ˆìš”', l: 'ë´', fml: 'ë´…ë‹ˆë‹¤', fr: 'voir', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: 'ë§ˆì‹œë‹¤', p: 'ë§ˆì…”ìš”', pa: 'ë§ˆì…¨ì–´ìš”', f: 'ë§ˆì‹¤ ê±°ì˜ˆìš”', l: 'ë§ˆì…”', fml: 'ë§ˆì‹­ë‹ˆë‹¤', fr: 'boire', rule: { tense: 'other_vowel', future: 'no_batchim' } },
            { inf: 'ì½ë‹¤', p: 'ì½ì–´ìš”', pa: 'ì½ì—ˆì–´ìš”', f: 'ì½ì„ ê±°ì˜ˆìš”', l: 'ì½ì–´', fml: 'ì½ìŠµë‹ˆë‹¤', fr: 'lire', rule: { tense: 'other_vowel', future: 'batchim' } },
            { inf: 'ë§Œë“¤ë‹¤', p: 'ë§Œë“¤ì–´ìš”', pa: 'ë§Œë“¤ì—ˆì–´ìš”', f: 'ë§Œë“¤ ê±°ì˜ˆìš”', l: 'ë§Œë“¤ì–´', fml: 'ë§Œë“­ë‹ˆë‹¤', fr: 'fabriquer', rule: { tense: 'other_vowel', future: 'rieul_batchim' } },
            { inf: 'ë“£ë‹¤', p: 'ë“¤ì–´ìš”', pa: 'ë“¤ì—ˆì–´ìš”', f: 'ë“¤ì„ ê±°ì˜ˆìš”', l: 'ë“¤ì–´', fml: 'ë“£ìŠµë‹ˆë‹¤', fr: 'Ã©couter', rule: { tense: 'irregular_d', future: 'batchim' } },
            { inf: 'ê±·ë‹¤', p: 'ê±¸ì–´ìš”', pa: 'ê±¸ì—ˆì–´ìš”', f: 'ê±¸ì„ ê±°ì˜ˆìš”', l: 'ê±¸ì–´', fml: 'ê±·ìŠµë‹ˆë‹¤', fr: 'marcher', rule: { tense: 'irregular_d', future: 'batchim' } },
            { inf: 'ìë‹¤', p: 'ììš”', pa: 'ì¤ì–´ìš”', f: 'ì˜ ê±°ì˜ˆìš”', l: 'ì', fml: 'ì¡ë‹ˆë‹¤', fr: 'dormir', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: 'ì‚¬ë‹¤', p: 'ì‚¬ìš”', pa: 'ìƒ€ì–´ìš”', f: 'ì‚´ ê±°ì˜ˆìš”', l: 'ì‚¬', fml: 'ì‚½ë‹ˆë‹¤', fr: 'acheter', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: 'ì¼í•˜ë‹¤', p: 'ì¼í•´ìš”', pa: 'ì¼í–ˆì–´ìš”', f: 'ì¼í•  ê±°ì˜ˆìš”', l: 'ì¼í•´', fml: 'ì¼í•©ë‹ˆë‹¤', fr: 'travailler', rule: { tense: 'hada', future: 'no_batchim' } },
        ];

        // --- DOM Elements ---
        const nameSection = document.getElementById('name-section');
        const mainContent = document.getElementById('main-content');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressText = document.getElementById('progress-text');
        const quizContainer = document.getElementById('quiz-parts-container');
        
        const placeholders = ["LÃ©a Dupont", "CÃ©dric Martin", "ChloÃ© Dubois", "Lucas Bernard"];

        // --- Utility Functions ---
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

        // --- Quiz Generation ---
        function generateQuiz() {
            state.parts = [];
            // Part 1: Infinitif vs ConjuguÃ©
            const p1Verbs = shuffleArray([...verbs]).slice(0, 5);
            const p1Questions = p1Verbs.map(v => {
                const word = Math.random() > 0.5 ? v.inf : v.p;
                return { question: word, options: ['Infinitif (ë™ì‚¬ ì›í˜•)', 'ConjuguÃ© (ë³€í˜• ë™ì‚¬)'], answer: word.endsWith('ë‹¤') ? 'Infinitif (ë™ì‚¬ ì›í˜•)' : 'ConjuguÃ© (ë³€í˜• ë™ì‚¬)', userAnswer: null };
            });
            state.parts.push({ title: 'Infinitif ou ConjuguÃ© ?', type: 'mcq', questions: p1Questions });

            // Part 2: Niveaux de politesse
            const p2Verbs = shuffleArray([...verbs]).slice(0, 5);
            const p2Questions = p2Verbs.map(v => {
                const forms = [{ form: v.fml, answer: 'Formel (ê²©ì‹ì²´)' }, { form: v.p, answer: 'Standard (í•´ìš”ì²´)' }, { form: v.l, answer: 'Informel (ë°˜ë§)' }];
                const chosen = forms[Math.floor(Math.random() * forms.length)];
                return { question: chosen.form, options: ['Formel (ê²©ì‹ì²´)', 'Standard (í•´ìš”ì²´)', 'Informel (ë°˜ë§)'], answer: chosen.answer, userAnswer: null };
            });
            state.parts.push({ title: 'Quel niveau de politesse ?', type: 'mcq', questions: p2Questions });

            // Part 3-5: Tenses MCQ
            ['p', 'pa', 'f'].forEach(tense => {
                const partVerbs = shuffleArray([...verbs]).slice(0, 5);
                const questions = partVerbs.map(v => {
                    const correctAnswer = v[tense];
                    let options = [correctAnswer];
                    shuffleArray(verbs).forEach(verb => { if (options.length < 4 && !options.includes(verb[tense])) options.push(verb[tense]); });
                    return { question: `${v.inf} (${v.fr})`, options: shuffleArray(options), answer: correctAnswer, userAnswer: null };
                });
                const title = tense === 'p' ? 'PrÃ©sent (í˜„ì¬)' : tense === 'pa' ? 'PassÃ© (ê³¼ê±°)' : 'Futur (ë¯¸ë˜)';
                state.parts.push({ title: `Conjugaison : ${title}`, type: 'mcq', questions });
            });
            
            // Part 6: Present/Past Fill-in-the-blank
            const p6Verbs = shuffleArray([...verbs]).slice(0, 10);
            const p6Questions = p6Verbs.map(v => {
                const isPast = Math.random() > 0.5;
                return { verb: v, tense: isPast ? 'passÃ©' : 'prÃ©sent', answer: isPast ? v.pa : v.p, userAnswer: '' };
            });
            state.parts.push({ title: 'Ã‰cris la bonne forme (PrÃ©sent/PassÃ©)', type: 'fib', questions: p6Questions });

            // Part 7: Future Fill-in-the-blank
            const p7Verbs = shuffleArray([...verbs]).slice(0, 10);
            const p7Questions = p7Verbs.map(v => ({ verb: v, tense: 'futur', answer: v.f, userAnswer: '' }));
            state.parts.push({ title: 'Ã‰cris la bonne forme (Futur)', type: 'fib', questions: p7Questions });
            
            // Part 8: Listening
            const sentences = [
                { s: 'ì €ëŠ” ë§¤ì¼ ìš´ë™í•´ìš”.', t: 'PrÃ©sent (í˜„ì¬)', fr: 'Je fais du sport tous les jours.'},
                { s: 'ì–´ì œ ì˜í™”ë¥¼ ë´¤ì–´ìš”.', t: 'PassÃ© (ê³¼ê±°)', fr: 'Hier, j\'ai regardÃ© un film.'},
                { s: 'ë‚´ì¼ ì¹œêµ¬ë¥¼ ë§Œë‚  ê±°ì˜ˆìš”.', t: 'Futur (ë¯¸ë˜)', fr: 'Demain, je vais rencontrer un(e) ami(e).'},
                { s: 'í•™ìƒì€ ì±…ì„ ì½ìŠµë‹ˆë‹¤.', t: 'PrÃ©sent (í˜„ì¬)', fr: 'L\'Ã©tudiant lit un livre.'},
                { s: 'ìš°ë¦¬ëŠ” ìŒì•…ì„ ë“¤ì—ˆì–´ìš”.', t: 'PassÃ© (ê³¼ê±°)', fr: 'Nous avons Ã©coutÃ© de la musique.'},
                { s: 'ê³ ì–‘ì´ê°€ ììš”.', t: 'PrÃ©sent (í˜„ì¬)', fr: 'Le chat dort.'},
                { s: 'ì €ëŠ” ê¹€ì¹˜ë¥¼ ë§Œë“¤ ê±°ì˜ˆìš”.', t: 'Futur (ë¯¸ë˜)', fr: 'Je vais faire du kimchi.'},
                { s: 'ë™ìƒì´ ê³µì›ì— ê°”ì–´ìš”.', t: 'PassÃ© (ê³¼ê±°)', fr: 'Mon petit frÃ¨re/sÅ“ur est allÃ©(e) au parc.'}
            ];
            const p8Questions = shuffleArray(sentences).slice(0, 6).map(sent => ({ sentence: sent.s, tense: sent.t, fr: sent.fr, userTense: null, userDictation: '', recording: null, userSelfDictation: '', listenCount: 0, hint1Count: 0 }));
            state.parts.push({ title: 'Ã‰coute et Ã©cris !', type: 'listening', questions: p8Questions });

            // Build the page sequence
            state.pages = [
                { type: 'explanation', id: 'page-explanation-1' },
                { type: 'quiz', partIndex: 0 },
                { type: 'quiz', partIndex: 1 },
                { type: 'explanation', id: 'page-explanation-2' },
                { type: 'quiz', partIndex: 2 },
                { type: 'quiz', partIndex: 3 },
                { type: 'quiz', partIndex: 4 },
                { type: 'quiz', partIndex: 5 },
                { type: 'quiz', partIndex: 6 },
                { type: 'quiz', partIndex: 7 },
            ];
        }

        // --- Rendering ---
        function renderQuiz() {
            quizContainer.innerHTML = '';
            state.parts.forEach((part, partIndex) => {
                const partEl = document.createElement('div');
                partEl.id = `part-${partIndex}`;
                partEl.className = 'page-container bg-white p-6 rounded-lg shadow-md';
                
                let questionsHtml = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Partie ${partIndex + 1} : ${part.title}</h2>`;
                
                part.questions.forEach((q, qIndex) => {
                    questionsHtml += `<div class="mb-6 border-t pt-4">`;
                    if (part.type === 'mcq') {
                        questionsHtml += `<p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> "${q.question}"</p><div class="grid grid-cols-2 gap-3">`;
                        q.options.forEach(opt => { questionsHtml += `<button class="option-btn p-3 border rounded-lg bg-gray-100 hover:bg-gray-200" onclick="selectAnswer(${partIndex}, ${qIndex}, this)">${opt}</button>`; });
                        questionsHtml += `</div>`;
                    } else if (part.type === 'fib') {
                        const questionText = `Le verbe <span class="font-bold">${q.verb.inf} (${q.verb.fr})</span> au <span class="font-bold">${q.tense}</span> ?`;
                        questionsHtml += `<div class="flex items-center justify-between">
                                            <p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> ${questionText}</p>`;
                        if (qIndex < 5) { // Add hint button for first 5 questions
                            questionsHtml += `<button class="control-button hint-button text-sm" onclick="showFibHint(${partIndex}, ${qIndex})">Aide ğŸ™</button>`;
                        }
                        questionsHtml += `</div>
                                        <div id="hint-box-${partIndex}-${qIndex}" class="mb-2 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg hidden"></div>
                                        <input type="text" class="w-full p-2 border-2 rounded-lg" onchange="updateAnswer(${partIndex}, ${qIndex}, this.value)">`;
                    } else if (part.type === 'listening') {
                        questionsHtml += `<p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> Ã‰coutez bien et rÃ©pondez.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <button class="control-button listen-button" onclick="playAudio(this, '${q.sentence}'); state.parts[${partIndex}].questions[${qIndex}].listenCount++"><i class="fas fa-volume-high"></i> Ã‰couter</button>
                                <button class="control-button hint-button" onclick="showListeningHint(${partIndex}, ${qIndex})">Aide ğŸ™</button>
                            </div>
                            <div id="hint-box-${partIndex}-${qIndex}" class="mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg hidden"></div>
                            <p class="font-semibold mt-4 mb-2">1. C'est du prÃ©sent, passÃ© ou futur ?</p>
                            <div class="grid grid-cols-3 gap-3">${['PrÃ©sent (í˜„ì¬)', 'PassÃ© (ê³¼ê±°)', 'Futur (ë¯¸ë˜)'].map(t => `<button class="option-btn p-2 border rounded-lg bg-gray-100 hover:bg-gray-200" onclick="selectTense(${partIndex}, ${qIndex}, this, '${t}')">${t}</button>`).join('')}</div>
                            <p class="font-semibold mt-4 mb-2">2. Ã‰crivez la phrase (ë°›ì•„ì“°ê¸°)</p>
                            <textarea class="w-full p-2 border-2 rounded-lg" rows="2" onchange="updateDictation(${partIndex}, ${qIndex}, this.value)"></textarea>
                            <p class="font-semibold mt-4 mb-2">3. Enregistrez votre voix (ëª©ì†Œë¦¬ ë…¹ìŒ - non notÃ©)</p>
                            <div id="recorder-${partIndex}-${qIndex}"></div>
                            <p class="font-semibold mt-4 mb-2">4. Ã‰crivez ce que vous entendez de votre voix (ë‹¤ì‹œ ë°›ì•„ì“°ê¸° - non notÃ©)</p>
                            <textarea class="w-full p-2 border-2 rounded-lg" rows="2" onchange="updateSelfDictation(${partIndex}, ${qIndex}, this.value)"></textarea>`;
                    }
                    questionsHtml += `</div>`;
                });
                partEl.innerHTML = questionsHtml;
                quizContainer.appendChild(partEl);
            });
        }

        function updateView() {
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            
            const currentPage = state.pages[state.currentPageIndex];
            if (currentPage.type === 'explanation') {
                document.getElementById(currentPage.id).classList.add('active');
            } else if (currentPage.type === 'quiz') {
                const partEl = document.getElementById(`part-${currentPage.partIndex}`);
                partEl.classList.add('active');
                if (state.parts[currentPage.partIndex].type === 'listening') {
                    state.parts[currentPage.partIndex].questions.forEach((q, qIndex) => {
                        setupRecorder(currentPage.partIndex, qIndex);
                    });
                }
            }
            
            progressText.textContent = `Ã‰tape ${state.currentPageIndex + 1} / ${state.pages.length}`;
            prevBtn.disabled = state.currentPageIndex === 0;
            nextBtn.classList.toggle('hidden', state.currentPageIndex === state.pages.length - 1);
            finishBtn.classList.toggle('hidden', state.currentPageIndex !== state.pages.length - 1);
        }

        // --- Event Handlers & Logic ---
        function initializeExercise() {
            state.startTime = new Date().toISOString();
            state.studentName = studentNameInput.value.trim();
            if (!state.studentName) { alert("Veuillez entrer votre nom. (ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.)"); return; }
            nameSection.classList.add('hidden');
            mainContent.classList.remove('hidden');
            generateQuiz();
            renderQuiz();
            updateView();
        }

        function navigate(direction) {
            state.currentPageIndex += direction;
            updateView();
        }

        function selectAnswer(partIndex, qIndex, btnEl) {
            state.parts[partIndex].questions[qIndex].userAnswer = btnEl.textContent;
            btnEl.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
        }
        
        function selectTense(partIndex, qIndex, btnEl, tense) {
            state.parts[partIndex].questions[qIndex].userTense = tense;
            btnEl.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
        }

        function updateAnswer(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userAnswer = value.trim(); }
        function updateDictation(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userDictation = value.trim(); }
        function updateSelfDictation(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userSelfDictation = value.trim(); }

        function showListeningHint(partIndex, qIndex) {
            const question = state.parts[partIndex].questions[qIndex];
            question.hint1Count++;
            const hintText = `<strong>Indice (íŒíŠ¸) :</strong> C'est une phrase sur "${question.fr}"`;
            const hintBox = document.getElementById(`hint-box-${partIndex}-${qIndex}`);
            hintBox.innerHTML = hintText;
            hintBox.classList.remove('hidden');
        }

        function showFibHint(partIndex, qIndex) {
            const q = state.parts[partIndex].questions[qIndex];
            const verb = q.verb;
            const tense = q.tense;
            let hintText = '';

            if (tense === 'prÃ©sent' || tense === 'passÃ©') {
                const presentEnding = '<strong>-ì•„ìš”</strong>';
                const pastEnding = '<strong>-ì•˜ì–´ìš”</strong>';
                const presentOtherEnding = '<strong>-ì–´ìš”</strong>';
                const pastOtherEnding = '<strong>-ì—ˆì–´ìš”</strong>';
                const presentHadaEnding = '<strong>í•´ìš”</strong>';
                const pastHadaEnding = '<strong>í–ˆì–´ìš”</strong>';

                switch (verb.rule.tense) {
                    case 'a_o_vowel':
                        hintText = `La derniÃ¨re voyelle du radical est un <strong>ã…</strong> ou un <strong>ã…—</strong>. Il faut donc utiliser ${tense === 'prÃ©sent' ? presentEnding : pastEnding}.<br>(ì–´ê°„ì˜ ë§ˆì§€ë§‰ ëª¨ìŒì´ <strong>ã…/ã…—</strong>ë¼ì„œ ${tense === 'prÃ©sent' ? presentEnding : pastEnding}ë¥¼ ë¶™ì—¬ìš”.)`;
                        break;
                    case 'other_vowel':
                        hintText = `La derniÃ¨re voyelle du radical n'est <strong>ni ã…, ni ã…—</strong>. Il faut donc utiliser ${tense === 'prÃ©sent' ? presentOtherEnding : pastOtherEnding}.<br>(ì–´ê°„ì˜ ë§ˆì§€ë§‰ ëª¨ìŒì´ <strong>ã…/ã…—</strong>ê°€ ì•„ë‹ˆë¼ì„œ ${tense === 'prÃ©sent' ? presentOtherEnding : pastOtherEnding}ë¥¼ ë¶™ì—¬ìš”.)`;
                        break;
                    case 'hada':
                        hintText = `C'est un verbe qui se termine par <strong>í•˜ë‹¤</strong>. Il se transforme toujours en ${tense === 'prÃ©sent' ? presentHadaEnding : pastHadaEnding}.<br>(<strong>í•˜ë‹¤</strong> ë™ì‚¬ëŠ” í•­ìƒ ${tense === 'prÃ©sent' ? presentHadaEnding : pastHadaEnding}ë¡œ ë°”ë€Œì–´ìš”.)`;
                        break;
                    case 'irregular_d':
                        hintText = `Attention, c'est un verbe irrÃ©gulier ! Le <strong>ã„·</strong> final du radical se transforme en <strong>ã„¹</strong> devant une voyelle.<br>(ë¶ˆê·œì¹™ ë™ì‚¬ ì£¼ì˜! ì–´ê°„ì˜ ë§ˆì§€ë§‰ <strong>ã„·</strong>ì´ ëª¨ìŒ ì•ì—ì„œ <strong>ã„¹</strong>ë¡œ ë°”ë€Œì–´ìš”.)`;
                        break;
                }
            } else if (tense === 'futur') {
                switch (verb.rule.future) {
                    case 'batchim':
                        hintText = `Le radical se termine par une consonne finale (ë°›ì¹¨). Il faut donc ajouter <strong>-ì„ ê±°ì˜ˆìš”</strong>.<br>(ì–´ê°„ì´ ë°›ì¹¨ìœ¼ë¡œ ëë‚˜ìš”. ê·¸ë˜ì„œ <strong>-ì„ ê±°ì˜ˆìš”</strong>ë¥¼ ë¶™ì—¬ìš”.)`;
                        break;
                    case 'no_batchim':
                        hintText = `Le radical se termine par une voyelle (pas de ë°›ì¹¨). Il faut donc ajouter <strong>-ã„¹ ê±°ì˜ˆìš”</strong>.<br>(ì–´ê°„ì´ ëª¨ìŒìœ¼ë¡œ ëë‚˜ìš” (ë°›ì¹¨ ì—†ìŒ). ê·¸ë˜ì„œ <strong>-ã„¹ ê±°ì˜ˆìš”</strong>ë¥¼ ë¶™ì—¬ìš”.)`;
                        break;
                    case 'rieul_batchim':
                        hintText = `Attention, cas spÃ©cial ! Le radical se termine dÃ©jÃ  par <strong>ã„¹</strong>. Il suffit d'ajouter <strong>-ê±°ì˜ˆìš”</strong> directement.<br>(íŠ¹ë³„ ê·œì¹™ ì£¼ì˜! ì–´ê°„ì´ ì´ë¯¸ <strong>ã„¹</strong>ë¡œ ëë‚˜ìš”. ë°”ë¡œ ë’¤ì— <strong>-ê±°ì˜ˆìš”</strong>ë§Œ ë¶™ì´ë©´ ë¼ìš”.)`;
                        break;
                }
            }

            const hintBox = document.getElementById(`hint-box-${partIndex}-${qIndex}`);
            hintBox.innerHTML = hintText;
            hintBox.classList.remove('hidden');
        }


        // --- Audio & Recording ---
        async function playAudio(buttonEl, text) {
            buttonEl.disabled = true;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: Math.random() > 0.5 ? 'man' : 'woman'
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Audio generation failed');
                }

                const { audioData, mimeType } = await response.json();
                const audioBlob = new Blob([Uint8Array.from(atob(audioData), c => c.charCodeAt(0))], { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                audio.onended = () => {
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = '<i class="fas fa-volume-high"></i> Ã‰couter';
                };

            } catch (error) {
                console.error('Error playing audio:', error);
                alert("DÃ©solÃ©, une erreur est survenue lors de la lecture de l'audio. (ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)");
                buttonEl.disabled = false;
                buttonEl.innerHTML = '<i class="fas fa-volume-high"></i> Ã‰couter';
            }
        }

        let mediaRecorder;
        let audioChunks = [];

        function setupRecorder(partIndex, qIndex) {
            const container = document.getElementById(`recorder-${partIndex}-${qIndex}`);
            if (!container || container.innerHTML !== '') return;
            container.innerHTML = `<div class="flex items-center gap-4">
                    <button id="record-btn-${partIndex}-${qIndex}" class="control-button record-button"><i class="fas fa-microphone"></i> Enregistrer</button>
                    <button id="stop-btn-${partIndex}-${qIndex}" class="control-button stop-button hidden"><i class="fas fa-stop"></i> ArrÃªter</button>
                    <div id="audio-playback-${partIndex}-${qIndex}"></div></div>`;
            const recordBtn = document.getElementById(`record-btn-${partIndex}-${qIndex}`);
            const stopBtn = document.getElementById(`stop-btn-${partIndex}-${qIndex}`);
            
            recordBtn.onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start(); audioChunks = [];
                    recordBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
                    mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("Impossible d'accÃ©der au microphone. Veuillez vÃ©rifier les autorisations. (ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.)");
                }
            };
            stopBtn.onclick = () => {
                mediaRecorder.stop();
                recordBtn.classList.remove('hidden'); stopBtn.classList.add('hidden');
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById(`audio-playback-${partIndex}-${qIndex}`).innerHTML = `<audio controls src="${audioUrl}"></audio>`;
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => { state.parts[partIndex].questions[qIndex].recording = { base64: reader.result.split(',')[1], filename: `rec_${state.studentName}_p${partIndex}_q${qIndex}.webm`, mimeType: 'audio/webm' }; };
                });
            };
        }

        // --- Submission & Results ---
        function checkAnswers() {
            let totalCorrect = 0, totalQuestions = 0;
            state.parts.forEach(part => {
                part.questions.forEach(q => {
                    if (part.type === 'listening') {
                        totalQuestions += 2;
                        if (q.userTense === q.tense) totalCorrect++;
                        if (q.userDictation.replace(/\s|[.?]/g, '') === q.sentence.replace(/\s|[.?]/g, '')) totalCorrect++;
                    } else {
                        totalQuestions++;
                        if (q.userAnswer && q.answer && q.userAnswer.replace(/\s/g, '') === q.answer.replace(/\s/g, '')) totalCorrect++;
                    }
                });
            });
            return { totalCorrect, totalQuestions };
        }

        async function submitResults() {
            if (state.isSubmitting) return;
            state.isSubmitting = true;
            const { totalCorrect, totalQuestions } = checkAnswers();
            state.endTime = new Date().toISOString();
            const totalTimeSeconds = (new Date(state.endTime) - new Date(state.startTime)) / 1000;
            const payload = { studentName: state.studentName, startTime: state.startTime, endTime: state.endTime, totalTimeSeconds, score: { totalCorrect, totalQuestions }, parts: state.parts };
            
            try {
                await fetch('/.netlify/functions/send-results', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                showResultModal(totalCorrect, totalQuestions);
            } catch (error) {
                console.error("Failed to send results:", error);
                alert("Une erreur est survenue lors de l'envoi des rÃ©sultats. (ê²°ê³¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)");
            } finally {
                state.isSubmitting = false;
            }
        }

        function showResultModal(correct, total) {
            const score = total > 0 ? (correct / total) * 100 : 100;
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const message = document.getElementById('result-message');
            if (score === 100) { title.textContent = "Parfait absolu ! ï¿½ğŸ‰"; message.textContent = "GÃ©nie confirmÃ© !"; }
            else if (score >= 80) { title.textContent = "TrÃ¨s bien jouÃ© ! ğŸ‘"; message.textContent = "Presque un maÃ®tre !"; }
            else if (score >= 60) { title.textContent = "Pas mal du tout ! ğŸ˜"; message.textContent = "Encore un petit effort !"; }
            else { title.textContent = "Allez, on repart ! â˜•ğŸ’ª"; message.textContent = "Un petit cafÃ© et on continue !"; }
            message.innerHTML += `<br>Votre score : ${correct} / ${total}`;
            modal.classList.remove('hidden');
            modal.querySelector('div').classList.add('scale-100');
        }

        // --- Init ---
        startBtn.addEventListener('click', initializeExercise);
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));
        finishBtn.addEventListener('click', submitResults);
        window.onload = () => { studentNameInput.placeholder = `Ex) ${placeholders[Math.floor(Math.random() * placeholders.length)]}`; };
    </script>
</body>
</html>
ï¿½
