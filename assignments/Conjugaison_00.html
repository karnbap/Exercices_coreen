<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice : Conjugaison Avancée (심화 동사 변화)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/style.css">
    <style>
        /* Base styles for option buttons */
        .option-btn {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .option-btn.selected {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            transform: scale(1.05);
            border-color: #2563eb; /* bg-blue-700 */
        }
        .option-btn.correct {
            background-color: #22c55e; /* bg-green-500 */
            color: white;
        }
        .option-btn.incorrect {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
        }

        /* Page visibility */
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }

        /* Enhanced button styles */
        .control-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* 8px */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem; /* 8px */
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .control-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .control-button:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Specific button colors */
        .listen-button { background-color: #3b82f6; } /* bg-blue-500 */
        .listen-button:hover { background-color: #2563eb; } /* bg-blue-600 */
        
        .record-button { background-color: #ef4444; } /* bg-red-500 */
        .record-button:hover { background-color: #dc2626; } /* bg-red-600 */

        .stop-button { background-color: #4b5563; } /* bg-gray-600 */
        .stop-button:hover { background-color: #1f2937; } /* bg-gray-800 */

        .hint-button { background-color: #f59e0b; color: #422006;} /* bg-amber-500 */
        .hint-button:hover { background-color: #d97706; } /* bg-amber-600 */

        .nav-button { background-color: #6b7280; } /* bg-gray-500 */
        .nav-button:hover { background-color: #4b5563; } /* bg-gray-600 */
        
        .finish-button { background-color: #22c55e; } /* bg-green-500 */
        .finish-button:hover { background-color: #16a34a; } /* bg-green-600 */
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="max-w-4xl mx-auto p-4 sm:p-8">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Exercice de Conjugaison Avancée 🚀</h1>
                <p class="text-gray-600">심화 동사 변화 연습</p>
            </div>
            <div class="text-right">
                <button onclick="window.print()" class="control-button print-button">
                    <i class="fas fa-print"></i> <span class="hidden sm:inline">Imprimer | 프린트</span>
                </button>
                 <div class="made-by-text">Made by 성일, Pongdang</div>
            </div>
        </header>

        <!-- Student Name Input -->
        <div id="name-section" class="mb-8 text-center">
            <input type="text" id="student-name" class="w-full max-w-md p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition" placeholder="Entrez votre nom (이름을 입력하세요)">
            <button id="start-btn" class="w-full max-w-md mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                Commencer l'exercice (연습 시작)
            </button>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="hidden">
            <!-- Explanation 1: Basics -->
            <div id="page-explanation-1" class="page-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Rappel 1 : Les bases ! (기초 복습!)</h2>
                <p class="mb-2">En coréen, la forme d'un verbe change selon le <strong>temps</strong> et le <strong>niveau de politesse</strong>.</p>
                <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li><strong>Infinitif (동사 원형)</strong> : La forme de base du dictionnaire, se termine toujours par <code class="bg-gray-200 rounded px-1">다</code>. Ex: <code class="bg-gray-200 rounded px-1">먹다</code> (manger).</li>
                    <li><strong>Radical (어간)</strong> : La partie du verbe sans le <code class="bg-gray-200 rounded px-1">다</code>. Ex: <code class="bg-gray-200 rounded px-1">먹</code>.</li>
                    <li><strong>Niveaux de politesse (높임말)</strong>:
                        <ul class="list-disc list-inside ml-6 mt-1">
                            <li><strong>Formel (격식체)</strong> : <code class="bg-gray-200 rounded px-1">-(스)ㅂ니다</code>. Pour les situations très formelles.</li>
                            <li><strong>Standard (해요체)</strong> : <code class="bg-gray-200 rounded px-1">-아/어/해요</code>. Le plus courant !</li>
                            <li><strong>Informel (반말)</strong> : <code class="bg-gray-200 rounded px-1">-아/어</code>. Avec les amis très proches.</li>
                        </ul>
                    </li>
                </ul>
                <p class="mt-4">Maintenant, un petit exercice sur ces bases !</p>
            </div>

            <!-- Explanation 2: Tenses -->
            <div id="page-explanation-2" class="page-container bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Rappel 2 : Comment former les temps ? (시제 만들기)</h2>
                <p class="mb-3">Pour conjuguer, on attache une terminaison au <strong>radical</strong> du verbe.</p>
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-lg text-blue-600">Présent (현재형) : -아요 / -어요 / -해요</h3>
                        <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>ㅏ</strong> ou <strong>ㅗ</strong> → <code class="bg-gray-200 rounded px-1">아요</code> (Ex: 가다 → 가 + 아요 = 가요)</li>
                            <li>Radical avec <strong>autres voyelles</strong> → <code class="bg-gray-200 rounded px-1">어요</code> (Ex: 먹다 → 먹 + 어요 = 먹어요)</li>
                            <li>Verbes en <strong>하다</strong> → <code class="bg-gray-200 rounded px-1">해요</code> (Ex: 공부하다 → 공부해요)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-green-600">Passé (과거형) : -았어요 / -었어요 / -했어요</h3>
                         <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>ㅏ</strong> ou <strong>ㅗ</strong> → <code class="bg-gray-200 rounded px-1">았어요</code> (Ex: 보다 → 보 + 았어요 = 봤어요)</li>
                            <li>Radical avec <strong>autres voyelles</strong> → <code class="bg-gray-200 rounded px-1">었어요</code> (Ex: 읽다 → 읽 + 었어요 = 읽었어요)</li>
                            <li>Verbes en <strong>하다</strong> → <code class="bg-gray-200 rounded px-1">했어요</code> (Ex: 일하다 → 일했어요)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-purple-600">Futur (미래형) : -(으)ㄹ 거예요</h3>
                         <ul class="list-disc list-inside ml-4 text-gray-600">
                            <li>Radical avec <strong>consonne finale (받침)</strong> → <code class="bg-gray-200 rounded px-1">을 거예요</code> (Ex: 만들다 → 만들 + 거예요 = 만들 거예요)</li>
                            <li>Radical <strong>sans consonne finale</strong> → <code class="bg-gray-200 rounded px-1">ㄹ 거예요</code> (Ex: 자다 → 자 + ㄹ 거예요 = 잘 거예요)</li>
                        </ul>
                    </div>
                </div>
                 <p class="mt-4">Passons aux exercices sur les temps !</p>
            </div>

            <!-- Quiz Parts will be dynamically rendered here -->
            <div id="quiz-parts-container"></div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between items-center">
                <button id="prev-btn" class="control-button nav-button">
                    <i class="fas fa-arrow-left"></i> Précédent (이전)
                </button>
                <span id="progress-text" class="text-gray-600 font-semibold"></span>
                <button id="next-btn" class="control-button nav-button">
                    Suivant (다음) <i class="fas fa-arrow-right"></i>
                </button>
                <button id="finish-btn" class="control-button finish-button hidden">
                    Terminer (끝내기) <i class="fas fa-check-circle"></i>
                </button>
            </div>
        </main>
        
        <footer class="mt-8 text-center">
            <a href="/index.html" class="text-blue-500 hover:underline">
                <i class="fas fa-arrow-left"></i> Retour à la liste (목록으로 돌아가기)
            </a>
            <div class="made-by-text mt-4">Made by 성일, Pongdang</div>
        </footer>
    </div>
    
    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full text-center transform transition-all scale-95">
            <h2 class="text-3xl font-bold mb-4" id="result-title">Bravo !</h2>
            <p class="text-lg mb-6" id="result-message"></p>
            <button onclick="location.reload()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-105">
                Recommencer (다시하기)
            </button>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            studentName: '',
            startTime: null,
            endTime: null,
            currentPageIndex: 0,
            pages: [], // Will hold the sequence of explanations and quizzes
            parts: [], // Will hold the quiz data
            isSubmitting: false,
        };

        // --- Verb Data ---
        const verbs = [
            { inf: '먹다', p: '먹어요', pa: '먹었어요', f: '먹을 거예요', l: '먹어', fml: '먹습니다', fr: 'manger', rule: { tense: 'other_vowel', future: 'batchim' } },
            { inf: '가다', p: '가요', pa: '갔어요', f: '갈 거예요', l: '가', fml: '갑니다', fr: 'aller', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: '하다', p: '해요', pa: '했어요', f: '할 거예요', l: '해', fml: '합니다', fr: 'faire', rule: { tense: 'hada', future: 'no_batchim' } },
            { inf: '보다', p: '봐요', pa: '봤어요', f: '볼 거예요', l: '봐', fml: '봅니다', fr: 'voir', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: '마시다', p: '마셔요', pa: '마셨어요', f: '마실 거예요', l: '마셔', fml: '마십니다', fr: 'boire', rule: { tense: 'other_vowel', future: 'no_batchim' } },
            { inf: '읽다', p: '읽어요', pa: '읽었어요', f: '읽을 거예요', l: '읽어', fml: '읽습니다', fr: 'lire', rule: { tense: 'other_vowel', future: 'batchim' } },
            { inf: '만들다', p: '만들어요', pa: '만들었어요', f: '만들 거예요', l: '만들어', fml: '만듭니다', fr: 'fabriquer', rule: { tense: 'other_vowel', future: 'rieul_batchim' } },
            { inf: '듣다', p: '들어요', pa: '들었어요', f: '들을 거예요', l: '들어', fml: '듣습니다', fr: 'écouter', rule: { tense: 'irregular_d', future: 'batchim' } },
            { inf: '걷다', p: '걸어요', pa: '걸었어요', f: '걸을 거예요', l: '걸어', fml: '걷습니다', fr: 'marcher', rule: { tense: 'irregular_d', future: 'batchim' } },
            { inf: '자다', p: '자요', pa: '잤어요', f: '잘 거예요', l: '자', fml: '잡니다', fr: 'dormir', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: '사다', p: '사요', pa: '샀어요', f: '살 거예요', l: '사', fml: '삽니다', fr: 'acheter', rule: { tense: 'a_o_vowel', future: 'no_batchim' } },
            { inf: '일하다', p: '일해요', pa: '일했어요', f: '일할 거예요', l: '일해', fml: '일합니다', fr: 'travailler', rule: { tense: 'hada', future: 'no_batchim' } },
        ];

        // --- DOM Elements ---
        const nameSection = document.getElementById('name-section');
        const mainContent = document.getElementById('main-content');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('student-name');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressText = document.getElementById('progress-text');
        const quizContainer = document.getElementById('quiz-parts-container');
        
        const placeholders = ["Léa Dupont", "Cédric Martin", "Chloé Dubois", "Lucas Bernard"];

        // --- Utility Functions ---
        const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

        // --- Quiz Generation ---
        function generateQuiz() {
            state.parts = [];
            // Part 1: Infinitif vs Conjugué
            const p1Verbs = shuffleArray([...verbs]).slice(0, 5);
            const p1Questions = p1Verbs.map(v => {
                const word = Math.random() > 0.5 ? v.inf : v.p;
                return { question: word, options: ['Infinitif (동사 원형)', 'Conjugué (변형 동사)'], answer: word.endsWith('다') ? 'Infinitif (동사 원형)' : 'Conjugué (변형 동사)', userAnswer: null };
            });
            state.parts.push({ title: 'Infinitif ou Conjugué ?', type: 'mcq', questions: p1Questions });

            // Part 2: Niveaux de politesse
            const p2Verbs = shuffleArray([...verbs]).slice(0, 5);
            const p2Questions = p2Verbs.map(v => {
                const forms = [{ form: v.fml, answer: 'Formel (격식체)' }, { form: v.p, answer: 'Standard (해요체)' }, { form: v.l, answer: 'Informel (반말)' }];
                const chosen = forms[Math.floor(Math.random() * forms.length)];
                return { question: chosen.form, options: ['Formel (격식체)', 'Standard (해요체)', 'Informel (반말)'], answer: chosen.answer, userAnswer: null };
            });
            state.parts.push({ title: 'Quel niveau de politesse ?', type: 'mcq', questions: p2Questions });

            // Part 3-5: Tenses MCQ
            ['p', 'pa', 'f'].forEach(tense => {
                const partVerbs = shuffleArray([...verbs]).slice(0, 5);
                const questions = partVerbs.map(v => {
                    const correctAnswer = v[tense];
                    let options = [correctAnswer];
                    shuffleArray(verbs).forEach(verb => { if (options.length < 4 && !options.includes(verb[tense])) options.push(verb[tense]); });
                    return { question: `${v.inf} (${v.fr})`, options: shuffleArray(options), answer: correctAnswer, userAnswer: null };
                });
                const title = tense === 'p' ? 'Présent (현재)' : tense === 'pa' ? 'Passé (과거)' : 'Futur (미래)';
                state.parts.push({ title: `Conjugaison : ${title}`, type: 'mcq', questions });
            });
            
            // Part 6: Present/Past Fill-in-the-blank
            const p6Verbs = shuffleArray([...verbs]).slice(0, 10);
            const p6Questions = p6Verbs.map(v => {
                const isPast = Math.random() > 0.5;
                return { verb: v, tense: isPast ? 'passé' : 'présent', answer: isPast ? v.pa : v.p, userAnswer: '' };
            });
            state.parts.push({ title: 'Écris la bonne forme (Présent/Passé)', type: 'fib', questions: p6Questions });

            // Part 7: Future Fill-in-the-blank
            const p7Verbs = shuffleArray([...verbs]).slice(0, 10);
            const p7Questions = p7Verbs.map(v => ({ verb: v, tense: 'futur', answer: v.f, userAnswer: '' }));
            state.parts.push({ title: 'Écris la bonne forme (Futur)', type: 'fib', questions: p7Questions });
            
            // Part 8: Listening
            const sentences = [
                { s: '저는 매일 운동해요.', t: 'Présent (현재)', fr: 'Je fais du sport tous les jours.'},
                { s: '어제 영화를 봤어요.', t: 'Passé (과거)', fr: 'Hier, j\'ai regardé un film.'},
                { s: '내일 친구를 만날 거예요.', t: 'Futur (미래)', fr: 'Demain, je vais rencontrer un(e) ami(e).'},
                { s: '학생은 책을 읽습니다.', t: 'Présent (현재)', fr: 'L\'étudiant lit un livre.'},
                { s: '우리는 음악을 들었어요.', t: 'Passé (과거)', fr: 'Nous avons écouté de la musique.'},
                { s: '고양이가 자요.', t: 'Présent (현재)', fr: 'Le chat dort.'},
                { s: '저는 김치를 만들 거예요.', t: 'Futur (미래)', fr: 'Je vais faire du kimchi.'},
                { s: '동생이 공원에 갔어요.', t: 'Passé (과거)', fr: 'Mon petit frère/sœur est allé(e) au parc.'}
            ];
            const p8Questions = shuffleArray(sentences).slice(0, 6).map(sent => ({ sentence: sent.s, tense: sent.t, fr: sent.fr, userTense: null, userDictation: '', recording: null, userSelfDictation: '', listenCount: 0, hint1Count: 0 }));
            state.parts.push({ title: 'Écoute et écris !', type: 'listening', questions: p8Questions });

            // Build the page sequence
            state.pages = [
                { type: 'explanation', id: 'page-explanation-1' },
                { type: 'quiz', partIndex: 0 },
                { type: 'quiz', partIndex: 1 },
                { type: 'explanation', id: 'page-explanation-2' },
                { type: 'quiz', partIndex: 2 },
                { type: 'quiz', partIndex: 3 },
                { type: 'quiz', partIndex: 4 },
                { type: 'quiz', partIndex: 5 },
                { type: 'quiz', partIndex: 6 },
                { type: 'quiz', partIndex: 7 },
            ];
        }

        // --- Rendering ---
        function renderQuiz() {
            quizContainer.innerHTML = '';
            state.parts.forEach((part, partIndex) => {
                const partEl = document.createElement('div');
                partEl.id = `part-${partIndex}`;
                partEl.className = 'page-container bg-white p-6 rounded-lg shadow-md';
                
                let questionsHtml = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Partie ${partIndex + 1} : ${part.title}</h2>`;
                
                part.questions.forEach((q, qIndex) => {
                    questionsHtml += `<div class="mb-6 border-t pt-4">`;
                    if (part.type === 'mcq') {
                        questionsHtml += `<p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> "${q.question}"</p><div class="grid grid-cols-2 gap-3">`;
                        q.options.forEach(opt => { questionsHtml += `<button class="option-btn p-3 border rounded-lg bg-gray-100 hover:bg-gray-200" onclick="selectAnswer(${partIndex}, ${qIndex}, this)">${opt}</button>`; });
                        questionsHtml += `</div>`;
                    } else if (part.type === 'fib') {
                        const questionText = `Le verbe <span class="font-bold">${q.verb.inf} (${q.verb.fr})</span> au <span class="font-bold">${q.tense}</span> ?`;
                        questionsHtml += `<div class="flex items-center justify-between">
                                            <p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> ${questionText}</p>`;
                        if (qIndex < 5) { // Add hint button for first 5 questions
                            questionsHtml += `<button class="control-button hint-button text-sm" onclick="showFibHint(${partIndex}, ${qIndex})">Aide 🙏</button>`;
                        }
                        questionsHtml += `</div>
                                        <div id="hint-box-${partIndex}-${qIndex}" class="mb-2 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg hidden"></div>
                                        <input type="text" class="w-full p-2 border-2 rounded-lg" onchange="updateAnswer(${partIndex}, ${qIndex}, this.value)">`;
                    } else if (part.type === 'listening') {
                        questionsHtml += `<p class="text-lg mb-3"><strong>Q${qIndex + 1}:</strong> Écoutez bien et répondez.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <button class="control-button listen-button" onclick="playAudio(this, '${q.sentence}'); state.parts[${partIndex}].questions[${qIndex}].listenCount++"><i class="fas fa-volume-high"></i> Écouter</button>
                                <button class="control-button hint-button" onclick="showListeningHint(${partIndex}, ${qIndex})">Aide 🙏</button>
                            </div>
                            <div id="hint-box-${partIndex}-${qIndex}" class="mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg hidden"></div>
                            <p class="font-semibold mt-4 mb-2">1. C'est du présent, passé ou futur ?</p>
                            <div class="grid grid-cols-3 gap-3">${['Présent (현재)', 'Passé (과거)', 'Futur (미래)'].map(t => `<button class="option-btn p-2 border rounded-lg bg-gray-100 hover:bg-gray-200" onclick="selectTense(${partIndex}, ${qIndex}, this, '${t}')">${t}</button>`).join('')}</div>
                            <p class="font-semibold mt-4 mb-2">2. Écrivez la phrase (받아쓰기)</p>
                            <textarea class="w-full p-2 border-2 rounded-lg" rows="2" onchange="updateDictation(${partIndex}, ${qIndex}, this.value)"></textarea>
                            <p class="font-semibold mt-4 mb-2">3. Enregistrez votre voix (목소리 녹음 - non noté)</p>
                            <div id="recorder-${partIndex}-${qIndex}"></div>
                            <p class="font-semibold mt-4 mb-2">4. Écrivez ce que vous entendez de votre voix (다시 받아쓰기 - non noté)</p>
                            <textarea class="w-full p-2 border-2 rounded-lg" rows="2" onchange="updateSelfDictation(${partIndex}, ${qIndex}, this.value)"></textarea>`;
                    }
                    questionsHtml += `</div>`;
                });
                partEl.innerHTML = questionsHtml;
                quizContainer.appendChild(partEl);
            });
        }

        function updateView() {
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            
            const currentPage = state.pages[state.currentPageIndex];
            if (currentPage.type === 'explanation') {
                document.getElementById(currentPage.id).classList.add('active');
            } else if (currentPage.type === 'quiz') {
                const partEl = document.getElementById(`part-${currentPage.partIndex}`);
                partEl.classList.add('active');
                if (state.parts[currentPage.partIndex].type === 'listening') {
                    state.parts[currentPage.partIndex].questions.forEach((q, qIndex) => {
                        setupRecorder(currentPage.partIndex, qIndex);
                    });
                }
            }
            
            progressText.textContent = `Étape ${state.currentPageIndex + 1} / ${state.pages.length}`;
            prevBtn.disabled = state.currentPageIndex === 0;
            nextBtn.classList.toggle('hidden', state.currentPageIndex === state.pages.length - 1);
            finishBtn.classList.toggle('hidden', state.currentPageIndex !== state.pages.length - 1);
        }

        // --- Event Handlers & Logic ---
        function initializeExercise() {
            state.startTime = new Date().toISOString();
            state.studentName = studentNameInput.value.trim();
            if (!state.studentName) { alert("Veuillez entrer votre nom. (이름을 입력해주세요.)"); return; }
            nameSection.classList.add('hidden');
            mainContent.classList.remove('hidden');
            generateQuiz();
            renderQuiz();
            updateView();
        }

        function navigate(direction) {
            state.currentPageIndex += direction;
            updateView();
        }

        function selectAnswer(partIndex, qIndex, btnEl) {
            state.parts[partIndex].questions[qIndex].userAnswer = btnEl.textContent;
            btnEl.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
        }
        
        function selectTense(partIndex, qIndex, btnEl, tense) {
            state.parts[partIndex].questions[qIndex].userTense = tense;
            btnEl.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btnEl.classList.add('selected');
        }

        function updateAnswer(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userAnswer = value.trim(); }
        function updateDictation(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userDictation = value.trim(); }
        function updateSelfDictation(partIndex, qIndex, value) { state.parts[partIndex].questions[qIndex].userSelfDictation = value.trim(); }

        function showListeningHint(partIndex, qIndex) {
            const question = state.parts[partIndex].questions[qIndex];
            question.hint1Count++;
            const hintText = `<strong>Indice (힌트) :</strong> C'est une phrase sur "${question.fr}"`;
            const hintBox = document.getElementById(`hint-box-${partIndex}-${qIndex}`);
            hintBox.innerHTML = hintText;
            hintBox.classList.remove('hidden');
        }

        function showFibHint(partIndex, qIndex) {
            const q = state.parts[partIndex].questions[qIndex];
            const verb = q.verb;
            const tense = q.tense;
            let hintText = '';

            if (tense === 'présent' || tense === 'passé') {
                const presentEnding = '<strong>-아요</strong>';
                const pastEnding = '<strong>-았어요</strong>';
                const presentOtherEnding = '<strong>-어요</strong>';
                const pastOtherEnding = '<strong>-었어요</strong>';
                const presentHadaEnding = '<strong>해요</strong>';
                const pastHadaEnding = '<strong>했어요</strong>';

                switch (verb.rule.tense) {
                    case 'a_o_vowel':
                        hintText = `La dernière voyelle du radical est un <strong>ㅏ</strong> ou un <strong>ㅗ</strong>. Il faut donc utiliser ${tense === 'présent' ? presentEnding : pastEnding}.<br>(어간의 마지막 모음이 <strong>ㅏ/ㅗ</strong>라서 ${tense === 'présent' ? presentEnding : pastEnding}를 붙여요.)`;
                        break;
                    case 'other_vowel':
                        hintText = `La dernière voyelle du radical n'est <strong>ni ㅏ, ni ㅗ</strong>. Il faut donc utiliser ${tense === 'présent' ? presentOtherEnding : pastOtherEnding}.<br>(어간의 마지막 모음이 <strong>ㅏ/ㅗ</strong>가 아니라서 ${tense === 'présent' ? presentOtherEnding : pastOtherEnding}를 붙여요.)`;
                        break;
                    case 'hada':
                        hintText = `C'est un verbe qui se termine par <strong>하다</strong>. Il se transforme toujours en ${tense === 'présent' ? presentHadaEnding : pastHadaEnding}.<br>(<strong>하다</strong> 동사는 항상 ${tense === 'présent' ? presentHadaEnding : pastHadaEnding}로 바뀌어요.)`;
                        break;
                    case 'irregular_d':
                        hintText = `Attention, c'est un verbe irrégulier ! Le <strong>ㄷ</strong> final du radical se transforme en <strong>ㄹ</strong> devant une voyelle.<br>(불규칙 동사 주의! 어간의 마지막 <strong>ㄷ</strong>이 모음 앞에서 <strong>ㄹ</strong>로 바뀌어요.)`;
                        break;
                }
            } else if (tense === 'futur') {
                switch (verb.rule.future) {
                    case 'batchim':
                        hintText = `Le radical se termine par une consonne finale (받침). Il faut donc ajouter <strong>-을 거예요</strong>.<br>(어간이 받침으로 끝나요. 그래서 <strong>-을 거예요</strong>를 붙여요.)`;
                        break;
                    case 'no_batchim':
                        hintText = `Le radical se termine par une voyelle (pas de 받침). Il faut donc ajouter <strong>-ㄹ 거예요</strong>.<br>(어간이 모음으로 끝나요 (받침 없음). 그래서 <strong>-ㄹ 거예요</strong>를 붙여요.)`;
                        break;
                    case 'rieul_batchim':
                        hintText = `Attention, cas spécial ! Le radical se termine déjà par <strong>ㄹ</strong>. Il suffit d'ajouter <strong>-거예요</strong> directement.<br>(특별 규칙 주의! 어간이 이미 <strong>ㄹ</strong>로 끝나요. 바로 뒤에 <strong>-거예요</strong>만 붙이면 돼요.)`;
                        break;
                }
            }

            const hintBox = document.getElementById(`hint-box-${partIndex}-${qIndex}`);
            hintBox.innerHTML = hintText;
            hintBox.classList.remove('hidden');
        }


        // --- Audio & Recording ---
        async function playAudio(buttonEl, text) {
            buttonEl.disabled = true;
            buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: Math.random() > 0.5 ? 'man' : 'woman'
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Audio generation failed');
                }

                const { audioData, mimeType } = await response.json();
                const audioBlob = new Blob([Uint8Array.from(atob(audioData), c => c.charCodeAt(0))], { type: mimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                audio.onended = () => {
                    buttonEl.disabled = false;
                    buttonEl.innerHTML = '<i class="fas fa-volume-high"></i> Écouter';
                };

            } catch (error) {
                console.error('Error playing audio:', error);
                alert("Désolé, une erreur est survenue lors de la lecture de l'audio. (오디오 재생 중 오류가 발생했습니다.)");
                buttonEl.disabled = false;
                buttonEl.innerHTML = '<i class="fas fa-volume-high"></i> Écouter';
            }
        }

        let mediaRecorder;
        let audioChunks = [];

        function setupRecorder(partIndex, qIndex) {
            const container = document.getElementById(`recorder-${partIndex}-${qIndex}`);
            if (!container || container.innerHTML !== '') return;
            container.innerHTML = `<div class="flex items-center gap-4">
                    <button id="record-btn-${partIndex}-${qIndex}" class="control-button record-button"><i class="fas fa-microphone"></i> Enregistrer</button>
                    <button id="stop-btn-${partIndex}-${qIndex}" class="control-button stop-button hidden"><i class="fas fa-stop"></i> Arrêter</button>
                    <div id="audio-playback-${partIndex}-${qIndex}"></div></div>`;
            const recordBtn = document.getElementById(`record-btn-${partIndex}-${qIndex}`);
            const stopBtn = document.getElementById(`stop-btn-${partIndex}-${qIndex}`);
            
            recordBtn.onclick = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start(); audioChunks = [];
                    recordBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
                    mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("Impossible d'accéder au microphone. Veuillez vérifier les autorisations. (마이크에 접근할 수 없습니다. 권한을 확인해주세요.)");
                }
            };
            stopBtn.onclick = () => {
                mediaRecorder.stop();
                recordBtn.classList.remove('hidden'); stopBtn.classList.add('hidden');
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById(`audio-playback-${partIndex}-${qIndex}`).innerHTML = `<audio controls src="${audioUrl}"></audio>`;
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => { state.parts[partIndex].questions[qIndex].recording = { base64: reader.result.split(',')[1], filename: `rec_${state.studentName}_p${partIndex}_q${qIndex}.webm`, mimeType: 'audio/webm' }; };
                });
            };
        }

        // --- Submission & Results ---
        function checkAnswers() {
            let totalCorrect = 0, totalQuestions = 0;
            state.parts.forEach(part => {
                part.questions.forEach(q => {
                    if (part.type === 'listening') {
                        totalQuestions += 2;
                        if (q.userTense === q.tense) totalCorrect++;
                        if (q.userDictation.replace(/\s|[.?]/g, '') === q.sentence.replace(/\s|[.?]/g, '')) totalCorrect++;
                    } else {
                        totalQuestions++;
                        if (q.userAnswer && q.answer && q.userAnswer.replace(/\s/g, '') === q.answer.replace(/\s/g, '')) totalCorrect++;
                    }
                });
            });
            return { totalCorrect, totalQuestions };
        }

        async function submitResults() {
            if (state.isSubmitting) return;
            state.isSubmitting = true;
            const { totalCorrect, totalQuestions } = checkAnswers();
            state.endTime = new Date().toISOString();
            const totalTimeSeconds = (new Date(state.endTime) - new Date(state.startTime)) / 1000;
            const payload = { studentName: state.studentName, startTime: state.startTime, endTime: state.endTime, totalTimeSeconds, score: { totalCorrect, totalQuestions }, parts: state.parts };
            
            try {
                await fetch('/.netlify/functions/send-results', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                showResultModal(totalCorrect, totalQuestions);
            } catch (error) {
                console.error("Failed to send results:", error);
                alert("Une erreur est survenue lors de l'envoi des résultats. (결과 전송 중 오류가 발생했습니다.)");
            } finally {
                state.isSubmitting = false;
            }
        }

        function showResultModal(correct, total) {
            const score = total > 0 ? (correct / total) * 100 : 100;
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('result-title');
            const message = document.getElementById('result-message');
            if (score === 100) { title.textContent = "Parfait absolu ! �🎉"; message.textContent = "Génie confirmé !"; }
            else if (score >= 80) { title.textContent = "Très bien joué ! 👍"; message.textContent = "Presque un maître !"; }
            else if (score >= 60) { title.textContent = "Pas mal du tout ! 😎"; message.textContent = "Encore un petit effort !"; }
            else { title.textContent = "Allez, on repart ! ☕💪"; message.textContent = "Un petit café et on continue !"; }
            message.innerHTML += `<br>Votre score : ${correct} / ${total}`;
            modal.classList.remove('hidden');
            modal.querySelector('div').classList.add('scale-100');
        }

        // --- Init ---
        startBtn.addEventListener('click', initializeExercise);
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));
        finishBtn.addEventListener('click', submitResults);
        window.onload = () => { studentNameInput.placeholder = `Ex) ${placeholders[Math.floor(Math.random() * placeholders.length)]}`; };
    </script>
</body>
</html>
�
