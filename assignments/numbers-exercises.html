<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CorÃ©en â€” Nombres | Exercices (1â€“20)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body{font-family:'Poppins','Noto Sans KR',sans-serif;}
    .quiz-container{max-width:860px;margin:2rem auto;padding:2rem;background:#f9fafb;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.08),0 4px 6px -2px rgba(0,0,0,.04)}
    .progress-bar{width:100%;height:10px;background:#e5e7eb;border-radius:5px;overflow:hidden}
    .progress-bar-inner{height:100%;background:#3b82f6;transition:width .3s ease-in-out}
    .question-title{font-size:1.35rem;font-weight:700;color:#1f2937;margin-bottom:.25rem}
    .question-text{font-size:1.05rem;color:#4b5563;margin-bottom:1.25rem;line-height:1.7}
    .btn{padding:.75rem 1.25rem;border-radius:.65rem;font-weight:600;cursor:pointer;transition:all .2s;border:none}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover{background:#d1d5db}
    .btn-sound{background:#10b981;color:#fff}.btn-sound:hover{background:#059669}
    .choice-btn{display:block;width:100%;text-align:left;padding:1rem;margin-bottom:.75rem;background:#fff;border:1px solid #e5e7eb;border-radius:.65rem;font-size:1.05rem}
    .choice-btn.selected{background:#bfdbfe;border-color:#3b82f6;font-weight:600}
    .input-field{width:100%;padding:.75rem 1rem;border:1px solid #d1d5db;border-radius:.65rem;font-size:1.05rem}
    .hidden{display:none}.disabled{opacity:.5;cursor:not-allowed}
    .brand-tag{position:fixed;right:16px;bottom:12px;font-size:12px;color:#9ca3af}
  </style>
</head>
<body class="bg-gray-50">

  <!-- ì‹œì‘ í™”ë©´: ì´ë¦„ ì…ë ¥ -->
  <div id="start-screen" class="min-h-[60vh] flex flex-col items-center justify-center text-center p-6">
    <div class="w-full max-w-sm mx-auto">
      <h1 class="text-3xl font-extrabold text-slate-900 mb-3">Exercices 1â€“20</h1>
      <input id="student-name" class="w-full p-3 text-center border-2 border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Quel est ton nom ? (ì´ë¦„ì´ ë­ì˜ˆìš”?)">
      <button id="start-btn" class="mt-4 w-full btn btn-primary text-lg">Commencer (ì‹œì‘)</button>
      <div class="text-sm text-slate-500 mt-4">
        Besoin dâ€™un rappel ? â†’ <a class="text-blue-600 underline" href="./numbers-warmup.html">MÃ©thode 5Ã—5 & explications</a>
      </div>
    </div>
  </div>

  <!-- í€´ì¦ˆ -->
  <div id="quiz-screen" class="quiz-container hidden">
    <div class="flex justify-between items-center mb-4">
      <span id="progress-text" class="text-sm font-semibold text-gray-600"></span>
      <button id="print-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-print"></i> Imprimer / í”„ë¦°íŠ¸</button>
    </div>
    <div class="progress-bar mb-6"><div id="progress-bar-inner" class="progress-bar-inner"></div></div>

    <!-- MÃ©thode 5Ã—5 ìƒë‹¨ë°” (bilingue, 1.2ë°°ì†) -->
    <div id="sticky-55" class="sticky top-0 z-30 -mx-4 sm:-mx-6 -mt-2 mb-4 hidden">
      <div class="p-3 rounded-lg bg-white/90 backdrop-blur border border-slate-200 shadow-sm flex flex-wrap gap-2 items-center justify-between">
        <span class="text-sm font-semibold text-slate-700">
          MÃ©thode 5Ã—5 â€” <span class="underline">Ã€ tout moment</span> / <span class="underline">í•„ìš”í•  ë•Œ ì–¸ì œë“  ë“£ê¸°</span>
        </span>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-sound" onclick="playAudio('í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯','alloy',{speed:1.2})"><i class="fas fa-play"></i> 1â€“5 natifs</button>
          <button class="btn btn-sound" onclick="playAudio('ì—¬ì„¯, ì¼ê³±, ì—¬ëŸ, ì•„í™‰, ì—´','shimmer',{speed:1.2})"><i class="fas fa-play"></i> 6â€“10 natifs</button>
          <button class="btn btn-sound" onclick="playAudio('ì¼, ì´, ì‚¼, ì‚¬, ì˜¤','alloy',{speed:1.2})"><i class="fas fa-play"></i> 1â€“5 Hanja</button>
          <button class="btn btn-sound" onclick="playAudio('ìœ¡, ì¹ , íŒ”, êµ¬, ì‹­','alloy',{speed:1.2})"><i class="fas fa-play"></i> 6â€“10 Hanja</button>
        </div>
      </div>
    </div>

    <div id="question-area"></div>

    <div id="navigation-btns" class="mt-8 flex justify-between items-center">
      <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> PrÃ©cÃ©dent (ì´ì „)</button>
      <button id="next-btn" class="btn btn-primary">Suivant (ë‹¤ìŒ) <i class="fas fa-arrow-right"></i></button>
      <button id="finish-btn" class="btn btn-primary hidden">Terminer ! (ëë‚´ê¸°!)</button>
    </div>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result-screen" class="quiz-container hidden text-center">
    <h2 class="text-3xl font-bold text-slate-800 mb-4">RÃ©sultats</h2>
    <div id="result-feedback" class="text-2xl font-semibold mb-6"></div>
    <p class="text-slate-600 mb-2">Score : <span id="final-score" class="font-bold"></span></p>
    <p class="text-slate-600 mb-6">Temps : <span id="total-time" class="font-bold"></span> s</p>
    <div id="review-section">
      <h3 class="text-xl font-bold text-slate-700 mt-8 mb-4">RÃ©vision / ì˜¤ë‹µë…¸íŠ¸</h3>
      <div id="review-content" class="text-left space-y-4"></div>
    </div>
    <div class="mt-8">
      <a class="btn btn-secondary" href="./numbers-warmup.html"><i class="fas fa-arrow-left"></i> Revenir (ëŒì•„ê°€ê¸°)</a>
    </div>
  </div>

  <!-- ì˜¤ë¥˜ ëª¨ë‹¬ -->
  <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 class="text-xl font-bold text-red-600 mb-2">Oops ! / ì˜¤ë¥˜ ë°œìƒ</h3>
      <p id="error-message" class="text-gray-700 mb-4"></p>
      <button id="close-error-modal-btn" class="btn btn-primary w-full mt-4">OK</button>
    </div>
  </div>

  <div class="brand-tag">made by ì„±ì¼, Pongdang Â· Lapeace29@gmail.com</div>

  <!-- ê¸°ë³¸ ì„¤ì •/ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    window.PONGDANG_TTS = window.PONGDANG_TTS || { provider: 'openai' };
    window.PONGDANG_FN_BASE = window.PONGDANG_FN_BASE || '/.netlify/functions';
    window.PONGDANG_SEND_AUDIO = false;
    window.PRONUN_OPTIONS = { hideTranscript: true, hideNumericSwap: true };
  </script>
  <script src="../assets/grading-criteria.js"></script>
  <script src="../assets/pronun-utils.js"></script>
  <script src="../assets/pronun-vowel-middleware.js"></script>
  <script src="../assets/pronun-client.js"></script>

  <script>
    const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');
    let studentName="", currentQuestionIndex=0, questions=[], startTime, endTime;
    let currentAudio=null,currentFetchAbort=null,currentBlobUrl=null,isPlayingOrFetching=false,audioClickLocked=false,isLooping=false;
    let currentAudioMeta={text:null,voice:null}, currentAudioUI={playBtn:null,loopBtn:null};

    // ------- utils -------
    function showErrorModal(msg){ document.getElementById('error-message').textContent=msg; document.getElementById('error-modal').classList.remove('hidden'); }
    function safeAttr(s){return String(s||"").replace(/\\/g,"\\\\").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/\n/g," ");}

    const VOICE_MAP={openai:{default:"alloy",alloy:"alloy",shimmer:"verse"},google:{default:"ko-KR-Standard-A",alloy:"ko-KR-Standard-A",shimmer:"ko-KR-Standard-B"}};
    const mapVoice=(p,v)=> (VOICE_MAP[p]||{} )[v] || (VOICE_MAP[p]||{}).default || v;
    function base64ToBlob(b64,mime='audio/mpeg'){const c=b64.includes(',')?b64.split(',')[1]:b64;const s=atob(c);const a=new Uint8Array(s.length);for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i);return new Blob([a],{type:mime});}
    function updatePlayButtonUI(isPlaying){const btn=currentAudioUI.playBtn;if(!btn)return;btn.innerHTML=isPlaying?'<i class="fas fa-pause"></i> Pause':'<i class="fas fa-play"></i> Ã‰couter';}
    function updateLoopButtonUI(){const b=currentAudioUI.loopBtn;if(!b)return;b.innerHTML=isLooping?'<i class="fas fa-redo"></i> RÃ©pÃ©ter On':'<i class="fas fa-redo"></i> RÃ©pÃ©ter Off';}

    async function playAudio(text,voice='alloy',opts={}){
      if(audioClickLocked||isPlayingOrFetching){
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice){
          try{ if(currentAudio.paused){ await currentAudio.play(); updatePlayButtonUI(true);} else { currentAudio.pause(); updatePlayButtonUI(false);} }catch(_){}
        } return;
      }
      audioClickLocked=true; setTimeout(()=>audioClickLocked=false,220);
      try{
        if(currentAudio && currentAudioMeta.text===text && currentAudioMeta.voice===voice && currentAudio.src){
          if(currentAudio.paused){ await currentAudio.play(); updatePlayButtonUI(true);} else { currentAudio.pause(); updatePlayButtonUI(false);} return;
        }
        isPlayingOrFetching=true;
        if(currentFetchAbort){ try{currentFetchAbort.abort();}catch(_){} }
        if(currentAudio){ try{currentAudio.pause();}catch(_){} }
        const ac=new AbortController(); currentFetchAbort=ac;
        const primary=(window.PONGDANG_TTS?.provider)||'openai';
        const payload={ text, voice: mapVoice(primary,voice), provider: primary, speed:(opts.speed ?? opts.speakingRate) };
        const res=await fetch(`${FN_BASE}/generate-audio`,{method:'POST',headers:{'Content-Type':'application/json','Cache-Control':'no-store'},body:JSON.stringify(payload),signal:ac.signal});
        if(!res.ok){ throw new Error('TTS '+res.status); }
        const data=await res.json();
        let src=null;
        if(data.audioBase64||data.audioContent){ const blob=base64ToBlob(data.audioBase64||data.audioContent,data.mimeType||'audio/mpeg'); src=URL.createObjectURL(blob); currentBlobUrl=src; }
        else if(data.audioUrl){ src=data.audioUrl; }
        const audio=new Audio(src); currentAudio=audio; currentAudioMeta={text,voice}; audio.loop=isLooping;
        audio.addEventListener('playing',()=>updatePlayButtonUI(true));
        audio.addEventListener('pause',()=>updatePlayButtonUI(false));
        audio.addEventListener('ended',()=>updatePlayButtonUI(false));
        await audio.play();
      }catch(e){ showErrorModal('ì˜¤ë””ì˜¤ ìƒì„±/ì¬ìƒ ì˜¤ë¥˜'); }
      finally{ isPlayingOrFetching=false; }
    }
    function onPlayPause(text,voice,btn,opts){ currentAudioUI.playBtn=btn; updatePlayButtonUI(currentAudio && !currentAudio.paused); return playAudio(text,voice,opts); }
    function onStop(){ if(!currentAudio) return; try{currentAudio.pause(); currentAudio.currentTime=0;}catch(_){ } updatePlayButtonUI(false); }
    function onToggleLoop(btn){ currentAudioUI.loopBtn=btn; isLooping=!isLooping; if(currentAudio){ currentAudio.loop=isLooping;} updateLoopButtonUI(); }
    function toggleSticky55(show){ document.getElementById('sticky-55')?.classList.toggle('hidden',!show); }

    // ----- ë¬¸ì œ ì„¸íŠ¸ -----
    const TYPE_TITLES={ choice:'Choix / ì„ íƒ', fr_prompt_ko:'FranÃ§ais â†’ í•œêµ­ì–´ / ë¶ˆâ†’í•œ', dictation:'DictÃ©e / ë°›ì•„ì“°ê¸°' };

    function getQuestions(){
      // 1â€“5: ì„ íƒí˜•
      const choiceData=[
        { context:"Pour la date '1ì¼', on dit :", options:["ì¼ì¼","í•˜ë‚˜ì¼"], answer:"ì¼ì¼" },
        { context:"Pour l'heure '1ì‹œ', on dit :", options:["í•œ ì‹œ","ì¼ ì‹œ"], answer:"í•œ ì‹œ" },
        { context:"Pour l'Ã¢ge '3ì‚´', on dit :", options:["ì„¸ ì‚´","ì‚¼ ì‚´"], answer:"ì„¸ ì‚´" },
        { context:"Pour l'argent '10 euro', on dit :", options:["ì‹­ ìœ ë¡œ","ì—´ ìœ ë¡œ"], answer:"ì‹­ ìœ ë¡œ" },
        { context:"Pour 30 minutes (30ë¶„), on dit :", options:["ì‚¼ì‹­ ë¶„","ì„œë¥¸ ë¶„"], answer:"ì‚¼ì‹­ ë¶„" }
      ];
      const frPromptKoData=[
        { fr:"Quelle heure est-il ?", audio:"ëª‡ ì‹œì˜ˆìš”?", frGuide:"Ex. Il est 3 h.", ko:"ì„¸ ì‹œì˜ˆìš”.", acceptedKo:["3ì‹œì˜ˆìš”","ì„¸ì‹œì˜ˆìš”","ì§€ê¸ˆì€ ì„¸ ì‹œì˜ˆìš”.","ì„¸ ì‹œì…ë‹ˆë‹¤."], voice:"alloy", pronunRequired:false },
        { fr:"Quelle est la date (jour du mois) ?", audio:"ì˜¤ëŠ˜ ë©°ì¹ ì´ì—ìš”?", frGuide:"Ex. Nous sommes le 10.", ko:"ì‹­ì¼ì´ì—ìš”.", acceptedKo:["10ì¼ì´ì—ìš”","ì˜¤ëŠ˜ì€ ì‹­ì¼ì´ì—ìš”","ì˜¤ëŠ˜ ì‹­ì¼ì´ì—ìš”"], voice:"shimmer", pronunRequired:false },
        { fr:"Combien Ã§a coÃ»te ?", audio:"ì–¼ë§ˆì˜ˆìš”?", frGuide:"Ex. Câ€™est 10 euros.", ko:"ì‹­ ìœ ë¡œì˜ˆìš”.", acceptedKo:["10ìœ ë¡œì˜ˆìš”","ì‹­ìœ ë¡œì˜ˆìš”","ì—´ ìœ ë¡œì˜ˆìš”"], voice:"alloy", pronunRequired:false },
        { fr:"Combien de personnes ?", audio:"ëª‡ ëª…ì´ì—ìš”?", frGuide:"Ex. Ils sont huit.", ko:"ì—¬ëŸ ëª…ì´ì—ìš”.", acceptedKo:["8ëª…ì´ì—ìš”","ì—¬ëŸëª…ì´ì—ìš”"], voice:"nova", pronunRequired:false },
        { fr:"Combien de minutes ?", audio:"ëª‡ ë¶„ì´ì—ìš”?", frGuide:"Ex. 30 minutes.", ko:"ì‚¼ì‹­ ë¶„ì´ì—ìš”.", acceptedKo:["30ë¶„ì´ì—ìš”","ì„œë¥¸ ë¶„ì´ì—ìš”"], voice:"echo", pronunRequired:false },
        // 11â€“15: ë°œìŒ ê²€ì‚¬ í•„ìˆ˜
        { fr:"Ã€ quelle heure est le rendez-vous ?", audio:"ì•½ì†ì´ ëª‡ ì‹œì˜ˆìš”?", frGuide:"Ex. Ã€ 4 h.", ko:"ë„¤ ì‹œì˜ˆìš”.", acceptedKo:["4ì‹œì˜ˆìš”","ë„¤ì‹œì˜ˆìš”"], voice:"fable", pronunRequired:true },
        { fr:"Quel jour du mois est lâ€™examen ?", audio:"ì‹œí—˜ì´ ë©°ì¹ ì´ì—ìš”?", frGuide:"Ex. Le 15.", ko:"ì‹­ì˜¤ì¼ì´ì—ìš”.", acceptedKo:["15ì¼ì´ì—ìš”"], voice:"alloy", pronunRequired:true },
        { fr:"Combien ce livre coÃ»te-t-il ?", audio:"ì´ ì±…ì€ ì–¼ë§ˆì˜ˆìš”?", frGuide:"Ex. 12 euros.", ko:"ì‹­ì´ ìœ ë¡œì˜ˆìš”.", acceptedKo:["12ìœ ë¡œì˜ˆìš”","ì‹­ì´ìœ ë¡œì˜ˆìš”"], voice:"shimmer", pronunRequired:true },
        { fr:"Combien de tasses de cafÃ© ?", audio:"ì»¤í”¼ ëª‡ ì”ì´ì—ìš”?", frGuide:"Ex. Trois.", ko:"ì„¸ ì”ì´ì—ìš”.", acceptedKo:["3ì”ì´ì—ìš”","ì„¸ì”ì´ì—ìš”"], voice:"alloy", pronunRequired:true },
        { fr:"Combien de secondes ?", audio:"ëª‡ ì´ˆì˜ˆìš”?", frGuide:"Ex. Dix secondes.", ko:"ì‹­ ì´ˆì˜ˆìš”.", acceptedKo:["10ì´ˆì˜ˆìš”","ì‹­ì´ˆì˜ˆìš”"], voice:"nova", pronunRequired:true }
      ];
      const dictationData=[
        { ko:"ì§€ê¸ˆ ëª‡ ì‹œì˜ˆìš”?", fr:"Quelle heure est-il ?", frAnswerGuide:"Ex. Il est 3 h.", voice:"shimmer" },
        { ko:"ì˜¤ëŠ˜ ë©°ì¹ ì´ì—ìš”?", fr:"Quelle est la date (jour du mois) ?", frAnswerGuide:"Ex. Nous sommes le 10.", voice:"nova" },
        { ko:"ì´ ì±…ì€ ì–¼ë§ˆì˜ˆìš”?", fr:"Combien coÃ»te ce livre ?", frAnswerGuide:"Ex. Câ€™est 12 euros.", voice:"alloy" },
        { ko:"í•™ìƒ ëª‡ ëª…ì´ì—ìš”?", fr:"Combien de personnes/Ã©lÃ¨ves ?", frAnswerGuide:"Ex. Ils sont huit.", voice:"echo" },
        { ko:"ëª‡ ë¶„ì´ì—ìš”?", fr:"Combien de minutes ?", frAnswerGuide:"Ex. 30 minutes.", voice:"fable" }
      ];

      const choice = choiceData.map((q,i)=>({ number:i+1,type:'choice',typeLabel:TYPE_TITLES.choice,context:q.context,answer:q.answer,options:[...q.options].sort(()=>Math.random()-0.5),userAnswer:null,isCorrect:null,listenCount:0,pronunRequired:false,pronunChecked:true }));
      const frPromptKo = frPromptKoData.map((q,i)=>({ number:choice.length+i+1,type:'fr_prompt_ko',typeLabel:TYPE_TITLES.fr_prompt_ko,fr:q.fr,audioText:q.audio,frGuide:q.frGuide,ko:q.ko,acceptedKo:q.acceptedKo||[],voice:q.voice||'alloy',userAnswer:"",isCorrect:null,listenCount:0,pronunRequired:!!q.pronunRequired,pronunChecked:!q.pronunRequired,recording:null,pronunciationFeedback:null }));
      const dictation = dictationData.map((q,i)=>({ number:choice.length+frPromptKo.length+i+1,type:'dictation',typeLabel:TYPE_TITLES.dictation,ko:q.ko,fr:q.fr,frAnswerGuide:q.frAnswerGuide,voice:q.voice,userAnswer:{ko:"",replyKo:""},isCorrect:null,listenCount:0,pronunRequired:true,pronunChecked:false,recording:null,pronunciationFeedback:null }));

      return [...choice, ...frPromptKo, ...dictation];
    }

    // ----- ë Œë”ë§ -----
    function renderQuestion(){
      const q=questions[currentQuestionIndex];
      const area=document.getElementById('question-area');
      const typeBadge = `<span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-800 text-white">${q.typeLabel}</span>`;
      let html = `<div class="flex items-center gap-2 mb-1">${typeBadge}<span class="text-sm text-slate-500">Q${q.number}</span></div>`;

      if(q.type==='choice'){
        html += `<h2 class="question-title">${q.context}</h2><p class="question-text">Choisissez la bonne rÃ©ponse. / ì•Œë§ì€ ë‹µì„ ê³ ë¥´ì„¸ìš”.</p>`;
        q.options.forEach(opt=>{ html+=`<button class="choice-btn ${q.userAnswer===opt?'selected':''}" onclick="selectChoiceAnswer('${opt}')">${opt}</button>`; });
      }
      else if(q.type==='fr_prompt_ko'){
        html += `<h2 class="question-title">${q.fr}</h2>
          <p class="question-text">ğŸ‡°ğŸ‡· Audio (KO) â†’ RÃ©ponse en corÃ©en. / ì˜¤ë””ì˜¤ ë“£ê³  í•œêµ­ì–´ë¡œë§Œ ë‹µí•˜ì„¸ìš”.</p>
          <div class="flex gap-2 mb-3">
            <button class="btn btn-sound flex-1" onclick="onPlayPause('${safeAttr(q.audioText)}','${q.voice||'alloy'}', this)"><i class="fas fa-play"></i> Ã‰couter</button>
            <button class="btn btn-secondary" onclick="onStop()"><i class="fas fa-square"></i> Stop</button>
            <button class="btn btn-secondary" onclick="onToggleLoop(this)"><i class="fas fa-redo"></i> RÃ©pÃ©ter Off</button>
          </div>
          <div class="p-3 bg-white rounded border mb-3 text-sm text-slate-600"><span class="font-medium">Guide (FR)</span> : ${q.frGuide}</div>
          <label class="block mb-1 font-semibold">RÃ©ponse (KO):</label>
          <input class="input-field input-ko" value="${q.userAnswer||''}" oninput="updateTranslateAnswer(this.value)" placeholder="ì˜ˆ: ${q.ko}">
        `;
        if(q.pronunRequired){
          html += `<div id="pronun-card" class="mt-4 p-4 rounded-lg border border-indigo-200 bg-indigo-50/60">
            <div class="text-sm text-slate-700 mb-2">ğŸ¤ Enregistrer & tester la prononciation / ë…¹ìŒí•´ì„œ ë°œìŒ ì‹œí—˜í•´ë³´ê¸°</div>
            <div class="pronun-display mt-2 text-sm"></div>
          </div>`;
        }
      }
      else if(q.type==='dictation'){
        html += `
          <div class="text-sm text-slate-600 bg-slate-50 border border-slate-200 rounded-md p-2 mb-3">
            <b>Question ${q.number}</b> â€” Ã‰coutez â†’ <b>1)</b> DictÃ©e(ë°›ì•„ì“°ê¸°) <b>2)</b> RÃ©ponse KO(ëŒ€ë‹µ) <b>3)</b> Enregistrez & vÃ©rifiez(ë°œìŒ)
          </div>
          <div class="space-y-4">
            <div class="flex gap-2">
              <button class="btn btn-sound flex-1" onclick="onPlayPause('${safeAttr(q.ko)}','${q.voice}', this)"><i class="fas fa-play"></i> Ã‰couter</button>
              <button class="btn btn-secondary" onclick="onStop()"><i class="fas fa-square"></i> Stop</button>
              <button class="btn btn-secondary" onclick="onToggleLoop(this)"><i class="fas fa-redo"></i> RÃ©pÃ©ter Off</button>
            </div>

            <div>
              <label class="block mb-1 font-semibold">1) DictÃ©e / ë°›ì•„ì“°ê¸°</label>
              <input class="input-field" value="${q.userAnswer.ko||''}" oninput="updateDictationAnswer('ko',this.value)" placeholder="(ì˜¤ë””ì˜¤ ê·¸ëŒ€ë¡œ ì ê¸°)">
            </div>

            <div>
              <label class="block mb-1 font-semibold">2) RÃ©ponse (KO) / í•œêµ­ì–´ë¡œ ëŒ€ë‹µ</label>
              <input class="input-field input-reply-ko" value="${q.userAnswer.replyKo||''}" oninput="updateDictationAnswer('replyKo',this.value)" placeholder="ì˜ˆ: ë„¤ ì‹œì˜ˆìš” / ì‹­ìœ ë¡œì˜ˆìš”">
              <div class="text-xs text-slate-500 mt-1">Ex (FR) : ${q.frAnswerGuide||''}</div>
            </div>

            <div id="pronun-card" class="mt-2 p-4 rounded-lg border border-indigo-200 bg-indigo-50/60">
              <div class="text-sm text-slate-700 mb-2">3) ğŸ¤ Enregistrez & vÃ©rifiez / ë…¹ìŒÂ·ë°œìŒ í™•ì¸</div>
              <div class="pronun-display mt-2 text-sm"></div>
            </div>
          </div>`;
      }

      area.innerHTML=html;

      // ë°œìŒì‹œí—˜(í•„ìˆ˜ êµ¬ê°„: 11â€“15, 16â€“20)
      if ((q.type==='fr_prompt_ko' && q.pronunRequired) || (q.type==='dictation')){
        const card=document.getElementById('pronun-card');
        if(card && window.Pronun){
          Pronun.mount(card,{
            getReferenceText:()=> (q.type==='dictation' ? (document.querySelector('#question-area .input-reply-ko')?.value||'') : q.ko),
            isKoCorrect:()=>true,
            onResult:(r)=>{ q.pronunChecked=true; q.pronunciationFeedback=r; updateNavigation(); }
          });
          // â€œì „ì‚¬/Transcriptionâ€ ë¥˜ ë¬¸êµ¬ ì œê±°
          const killWords=['ì „ì‚¬','transcription','transcrit'];
          const mo=new MutationObserver(()=>{
            card.querySelectorAll('*').forEach(n=>{
              n.childNodes?.forEach(c=>{
                if(c.nodeType===3 && killWords.some(k=>c.textContent?.toLowerCase().includes(k))) c.textContent='';
              });
            });
          });
          mo.observe(card,{childList:true,subtree:true});
        }
      }

      toggleSticky55((q.number||0) >= 6);
      updateNavigation();
    }

    // ----- ë„¤ë¹„/ê²€ì¦ -----
    function isNextAllowed(){
      const q=questions[currentQuestionIndex];
      if(!q) return true;
      if(q.type==='choice'){ return !!q.userAnswer; }
      if(q.type==='fr_prompt_ko'){
        if(!q.userAnswer || !q.userAnswer.trim()) return false;
        if(q.pronunRequired && !q.pronunChecked) return false;
        return true;
      }
      if(q.type==='dictation'){
        if(!(q.userAnswer.ko && q.userAnswer.replyKo)) return false;
        if(!q.pronunChecked) return false;
        return true;
      }
      return true;
    }
    function updateNavigation(){
      const prev=document.getElementById('prev-btn');
      const next=document.getElementById('next-btn');
      const finish=document.getElementById('finish-btn');
      prev.classList.toggle('disabled', currentQuestionIndex===0);
      next.classList.toggle('hidden', currentQuestionIndex===questions.length-1);
      finish.classList.toggle('hidden', currentQuestionIndex<questions.length-1);
      const allow=isNextAllowed(); next.disabled=!allow; next.classList.toggle('disabled',!allow);
      const pb=document.getElementById('progress-bar-inner'); if(pb){ pb.style.width=((currentQuestionIndex+1)/questions.length*100)+'%'; }
      const pt=document.getElementById('progress-text'); if(pt){ pt.textContent=`Question ${currentQuestionIndex+1} / ${questions.length}`; }
    }

    // ----- ë‹µ ì—…ë°ì´íŠ¸ -----
    function selectChoiceAnswer(a){ questions[currentQuestionIndex].userAnswer=a; updateNavigation(); }
    function updateTranslateAnswer(v){ questions[currentQuestionIndex].userAnswer=v; updateNavigation(); }
    function updateDictationAnswer(k,v){ questions[currentQuestionIndex].userAnswer[k]=v; updateNavigation(); }

    // ----- ì±„ì /ê²°ê³¼ -----
    function stripKo(s){ return String(s||'').replace(/\s/g,'').replace(/[.,!?]/g,''); }
    function checkAnswers(){
      questions.forEach(q=>{
        if(q.type==='choice') q.isCorrect = q.userAnswer===q.answer;
        else if(q.type==='fr_prompt_ko'){ const c=[q.ko,...(q.acceptedKo||[])]; q.isCorrect=c.some(ans=>stripKo(q.userAnswer)===stripKo(ans)); }
        else if(q.type==='dictation'){ q.isCorrect=!!((q.userAnswer.ko||'').trim() && (q.userAnswer.replyKo||'').trim()); }
      });
    }
    async function sendResults(){
      endTime=new Date();
      const payload={
        studentName,startTime:startTime.toISOString(),endTime:endTime.toISOString(),
        totalTimeSeconds:Math.round((endTime-startTime)/1000),
        questions:questions.map(q=>({ number:q.number,type:q.type,fr:q.fr||q.context||'',ko:q.ko||'',userAnswer:q.userAnswer,isCorrect:q.isCorrect,pronun:q.pronunciationFeedback||null }))
      };
      try{ await fetch(`${FN_BASE}/send-results`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); }catch(_){}
    }
    function feedback(score){
      if(score>=90) return {fr:"Excellent !",ko:"ì™„ë²½í•´ìš”!",cls:"text-green-600"};
      if(score>=70) return {fr:"TrÃ¨s bien !",ko:"ì•„ì£¼ ì¢‹ì•„ìš”!",cls:"text-emerald-600"};
      if(score>=50) return {fr:"Pas mal !",ko:"ë‚˜ì˜ì§€ ì•Šì•„ìš”!",cls:"text-yellow-600"};
      return {fr:"Courage !",ko:"ê´œì°®ì•„ìš”!",cls:"text-orange-600"};
    }
    function showResults(){
      checkAnswers(); sendResults();
      const correct=questions.filter(q=>q.isCorrect).length, score=Math.round(correct/questions.length*100), time=Math.round((new Date()-startTime)/1000);
      const fb=feedback(score);
      document.getElementById('final-score').textContent=score+"/100";
      document.getElementById('total-time').textContent=time;
      const rf=document.getElementById('result-feedback'); rf.className='text-2xl font-semibold mb-6 '+fb.cls; rf.textContent=`${fb.fr} / ${fb.ko}`;
      const review=document.getElementById('review-content'); review.innerHTML='';
      questions.forEach(q=>{ if(!q.isCorrect){ const ua=(q.type==='dictation'?`${q.userAnswer.ko||''} | ${q.userAnswer.replyKo||''}`:q.userAnswer||''); const div=document.createElement('div'); div.className='p-3 bg-white rounded border'; div.innerHTML=`<div class='text-sm text-gray-500 mb-1'>Q${q.number} (${q.type})</div><div class='font-semibold mb-1'>${(q.fr||q.context||'')}</div><div class='text-green-700'>âœ… ${q.ko||q.answer||''}</div><div class='text-red-700'>âŒ ${ua||'(vide)'}</div>`; review.appendChild(div);} });
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
    }

    // ----- í”Œë¡œìš° -----
    function startQuiz(){
      studentName=document.getElementById('student-name').value.trim();
      if(!studentName){ showErrorModal("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
      startTime=new Date(); questions=getQuestions(); currentQuestionIndex=0;
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      renderQuestion(); updateNavigation();
    }
    function nextQuestion(){ if(currentQuestionIndex<questions.length-1){ currentQuestionIndex++; renderQuestion(); } }
    function prevQuestion(){ if(currentQuestionIndex>0){ currentQuestionIndex--; renderQuestion(); } }

    document.addEventListener('DOMContentLoaded',()=>{
      const byId=(id,fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',fn); };
      byId('start-btn', startQuiz);
      byId('next-btn', ()=>{ if(isNextAllowed()) nextQuestion(); updateNavigation(); });
      byId('prev-btn', ()=>{ prevQuestion(); updateNavigation(); });
      byId('finish-btn', showResults);
      byId('print-btn', ()=>window.print());
      byId('close-error-modal-btn', ()=>document.getElementById('error-modal').classList.add('hidden'));
    });
  </script>
</body>
</html>
