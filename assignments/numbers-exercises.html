// assets/quiz-numbers.js
// Nombres ì¢…í•© í€´ì¦ˆ: ì„ íƒ(5) â†’ ë¶ˆâ†’í•œ(10) â†’ ë°›ì•„ì“°ê¸°(5)
// - ì´ë¦„ ì²´í¬, ìƒë‹¨ ì¸ì‡„, Sticky 5Ã—5, íŒíŠ¸(ì´ˆì„±/ë¶€ë¶„ëœ»)
// - ì˜¤ë””ì˜¤ base64â†’Blobâ†’URL ì¬ìƒ(ë©”ëª¨ë¦¬ ì •ë¦¬)
// - ì˜¤ë‹µ ì‹œ ì¹´ë“œ í”ë“¤ë¦¼ + ë¶ˆì–´ ì•ˆë‚´, ì •ë‹µ ì‹œ ì§„í–‰ í—ˆìš©
// - ë°œìŒ ë…¹ìŒ/í‰ê°€: warmup UI ê·¸ëŒ€ë¡œ ì‚¬ìš©(ui:'warmup')
// - ëë‚´ê¸° ì‹œ ê²°ê³¼ ì €ì¥ + ì „ì†¡

(function(){
  'use strict';

  const FN_BASE = (window.PONGDANG_FN_BASE || '/.netlify/functions');

  // ===== ìƒíƒœ =====
  const S = {
    start: Date.now(),
    name: '',
    idx: 0,
    qs: [],
    audio: { el:null, url:null, btn:null, fetching:false, lock:false, ac:null },
  };

  // ===== ìœ í‹¸ =====
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const strip = s => String(s||'').replace(/\s/g,'');
  const base64ToBlob = (b64, mime='audio/mpeg')=>{
    const clean = b64.includes(',') ? b64.split(',')[1] : b64;
    const bin = atob(clean); const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr],{type:mime});
  };
  const fmtSecs = t => `${Math.max(0, Math.round(t/1000))} s`;
  const esc = s => String(s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

  // ===== ì˜¤ë””ì˜¤ =====
  async function playAudio(text, voice='alloy', opts={}){
    const btn = opts._btn || null;
    if (S.audio.lock || S.audio.fetching) {
      if (S.audio.el && S.audio.btn===btn){
        try{
          if (!S.audio.el.paused) { S.audio.el.pause(); markBtn(btn,false); }
          else { await S.audio.el.play(); markBtn(btn,true); }
        }catch(_){}
      }
      return;
    }
    S.audio.lock = true; setTimeout(()=>S.audio.lock=false, 220);

    try{
      cleanupAudio();

      S.audio.fetching = true;
      const ac = new AbortController(); S.audio.ac = ac;
      const res = await fetch(`${FN_BASE}/generate-audio`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Cache-Control':'no-store'},
        body: JSON.stringify({ text, voice, speed:(opts.speed??1.0) }),
        signal: ac.signal
      });
      if(!res.ok) throw new Error(`TTS ${res.status}`);
      const data = await res.json();

      let srcUrl = null;
      if(data.audioBase64 || data.audioContent){
        const blob = base64ToBlob(data.audioBase64||data.audioContent, data.mimeType||'audio/mpeg');
        srcUrl = URL.createObjectURL(blob);
      }else if(data.audioUrl){ srcUrl = data.audioUrl; }
      else { throw new Error('Invalid TTS response'); }

      const audio = new Audio(srcUrl);
      S.audio.el = audio; S.audio.url = srcUrl; S.audio.btn = btn;

      audio.addEventListener('playing', ()=> markBtn(btn,true));
      audio.addEventListener('pause',   ()=> markBtn(btn,false));
      audio.addEventListener('ended',   ()=> markBtn(btn,false));
      audio.addEventListener('error',   ()=> markBtn(btn,false));

      const q = S.qs[S.idx]; if(q) q.listenCount = (q.listenCount||0)+1;

      await audio.play();
    }catch(e){
      console.error(e);
      alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    }finally{
      S.audio.fetching = false;
    }
  }
  function stopAudio(){
    if(!S.audio.el) return;
    try { S.audio.el.pause(); S.audio.el.currentTime = 0; } catch(_){}
    markBtn(S.audio.btn,false);
  }
  function cleanupAudio(){
    try{ if(S.audio.el) S.audio.el.pause(); }catch(_){}
    if(S.audio.url){ URL.revokeObjectURL(S.audio.url); }
    S.audio = { el:null, url:null, btn:null, fetching:false, lock:false, ac:null };
  }
  function markBtn(btn, playing){
    if(!btn) return;
    btn.classList.toggle('playing', playing);
    btn.textContent = playing ? 'Pause (ì¼ì‹œì •ì§€)' : 'Ã‰couter (ë“£ê¸°)';
  }

  // ===== ë¬¸ì œ ì„¸íŠ¸ =====
  function getQuestions(){
    // 1â€“5 ì„ íƒ(ê°œë…)
    const choiceData = [
      { context:"Pour la date '1ì¼', on dit :", options:["ì¼ì¼","í•˜ë‚˜ì¼"], answer:"ì¼ì¼", hints:{choseong:"ã…‡ã…‡", part:"date: â€˜~ì¼â€™ (Hanja)"} },
      { context:"Pour l'heure '1ì‹œ', on dit :", options:["í•œ ì‹œ","ì¼ ì‹œ"], answer:"í•œ ì‹œ", hints:{choseong:"ã… ã……", part:"heure: natif + ì‹œ"} },
      { context:"Pour l'Ã¢ge '3ì‚´', on dit :", options:["ì„¸ ì‚´","ì‚¼ ì‚´"], answer:"ì„¸ ì‚´", hints:{choseong:"ã…… ã……", part:"Ã¢ge: natif + ì‚´"} },
      { context:"Pour l'argent '10 euro', on dit :", options:["ì‹­ ìœ ë¡œ","ì—´ ìœ ë¡œ"], answer:"ì‹­ ìœ ë¡œ", hints:{choseong:"ã…… ã…‡ã„¹", part:"argent: sino + ìœ ë¡œ"} },
      { context:"Pour 30 minutes (30ë¶„), on dit :", options:["ì‚¼ì‹­ ë¶„","ì„œë¥¸ ë¶„"], answer:"ì‚¼ì‹­ ë¶„", hints:{choseong:"ã……ã…… ã…‚", part:"minutes: sino + ë¶„"} },
    ];

    // 6â€“15 ë¶ˆâ†’í•œ
    const frKo = [
      { fr:"Quelle heure est-il ?", audio:"ëª‡ ì‹œì˜ˆìš”?", frGuide:"Ex. Il est 3 h.", ko:"ì„¸ ì‹œì˜ˆìš”.", accepted:["3ì‹œì˜ˆìš”","ì„¸ì‹œì˜ˆìš”","ì§€ê¸ˆì€ ì„¸ ì‹œì˜ˆìš”.","ì„¸ ì‹œì…ë‹ˆë‹¤."], voice:"alloy", hints:{choseong:"ã…… ã……ã…‡ã…‡", part:"â€˜~ì‹œì˜ˆìš”â€™(câ€™est ~h)"} },
      { fr:"Quel jour du mois ?", audio:"ë©°ì¹ ì´ì—ìš”?", frGuide:"Ex. Le 10.", ko:"ì‹­ì¼ì´ì—ìš”.", accepted:["10ì¼ì´ì—ìš”","ì˜¤ëŠ˜ì€ ì‹­ì¼ì´ì—ìš”","ì˜¤ëŠ˜ ì‹­ì¼ì´ì—ìš”"], voice:"shimmer", hints:{choseong:"ã……ã…‡ã…‡ã…‡", part:"date: sino + ì¼"} },
      { fr:"Combien Ã§a coÃ»te ?", audio:"ì–¼ë§ˆì˜ˆìš”?", frGuide:"Ex. 10 euros.", ko:"ì‹­ ìœ ë¡œì˜ˆìš”.", accepted:["10ìœ ë¡œì˜ˆìš”","ì‹­ìœ ë¡œì˜ˆìš”","ì—´ ìœ ë¡œì˜ˆìš”"], voice:"alloy", hints:{choseong:"ã…… ã…‡ã„¹ã…‡ã…‡", part:"prix: sino + ìœ ë¡œ"} },
      { fr:"Combien de personnes ?", audio:"ëª‡ ëª…ì´ì—ìš”?", frGuide:"Ex. Huit.", ko:"ì—¬ëŸ ëª…ì´ì—ìš”.", accepted:["8ëª…ì´ì—ìš”","ì—¬ëŸëª…ì´ì—ìš”"], voice:"nova", hints:{choseong:"ã…‡ã„·  ã…ã…‡ã…‡ã…‡", part:"compter personnes: natif + ëª…"} },
      { fr:"Combien de minutes ?", audio:"ëª‡ ë¶„ì´ì—ìš”?", frGuide:"Ex. 30.", ko:"ì‚¼ì‹­ ë¶„ì´ì—ìš”.", accepted:["30ë¶„ì´ì—ìš”","ì„œë¥¸ ë¶„ì´ì—ìš”"], voice:"echo", hints:{choseong:"ã……ã…… ã…‚ã…‡ã…‡ã…‡", part:"minutes: sino + ë¶„"} },

      { fr:"Ã€ quelle heure est le rendez-vous ?", audio:"ì•½ì†ì´ ëª‡ ì‹œì˜ˆìš”?", frGuide:"Ex. 4 h.", ko:"ë„¤ ì‹œì˜ˆìš”.", accepted:["4ì‹œì˜ˆìš”","ë„¤ì‹œì˜ˆìš”"], voice:"fable", hints:{choseong:"ã„´ ã……ã…‡ã…‡", part:"heure: natif + ì‹œ"} },
      { fr:"Quel jour du mois ?", audio:"ë©°ì¹ ì´ì—ìš”?", frGuide:"Ex. 15.", ko:"ì‹­ì˜¤ì¼ì´ì—ìš”.", accepted:["15ì¼ì´ì—ìš”"], voice:"alloy", hints:{choseong:"ã……ã…‡ã…‡ã…‡ã…‡", part:"date: sino + ì¼"} },
      { fr:"Combien Ã§a coÃ»te ?", audio:"ì–¼ë§ˆì˜ˆìš”?", frGuide:"Ex. 12 euros.", ko:"ì‹­ì´ ìœ ë¡œì˜ˆìš”.", accepted:["12ìœ ë¡œì˜ˆìš”","ì‹­ì´ìœ ë¡œì˜ˆìš”"], voice:"shimmer", hints:{choseong:"ã……ã…‡ ã…‡ã„¹ã…‡ã…‡", part:"prix: sino + ìœ ë¡œ"} },
      { fr:"Combien de tasses de cafÃ© ?", audio:"ì»¤í”¼ ëª‡ ì”ì´ì—ìš”?", frGuide:"Ex. Trois.", ko:"ì„¸ ì”ì´ì—ìš”.", accepted:["3ì”ì´ì—ìš”","ì„¸ì”ì´ì—ìš”"], voice:"alloy", hints:{choseong:"ã……  ã…ˆã…‡ã…‡ã…‡", part:"compter tasses: natif + ì”"} },
      { fr:"Combien de secondes ?", audio:"ëª‡ ì´ˆì˜ˆìš”?", frGuide:"Ex. Dix secondes.", ko:"ì‹­ ì´ˆì˜ˆìš”.", accepted:["10ì´ˆì˜ˆìš”","ì‹­ì´ˆì˜ˆìš”"], voice:"nova", hints:{choseong:"ã…… ã…Šã…‡ã…‡", part:"secondes: sino + ì´ˆ"} },
    ];

    // 16â€“20 ë°›ì•„ì“°ê¸°
    const dictee = [
      { ko:"ì§€ê¸ˆ ëª‡ ì‹œì˜ˆìš”?", fr:"Quelle heure est-il ?", guide:"Ex. Il est 3 h.", voice:"shimmer", hints:{choseong:"ã…ˆã„±  ã… ã……ã…‡ã…‡?", part:"â€˜ëª‡ ì‹œâ€™ â†’ heure"} },
      { ko:"ì˜¤ëŠ˜ ë©°ì¹ ì´ì—ìš”?", fr:"Quel jour du mois est-on ?", guide:"Ex. Le 10.", voice:"nova", hints:{choseong:"ã…‡ã„´  ã…ã…Šã„¹ã…‡ã…‡?", part:"â€˜ë©°ì¹ â€™ â†’ date (jour)"} },
      { ko:"ì–¼ë§ˆì˜ˆìš”?", fr:"Combien Ã§a coÃ»te ?", guide:"Ex. 12 euros.", voice:"alloy", hints:{choseong:"ã…‡ã„¹ã… ã…‡ã…‡?", part:"prix"} },
      { ko:"ëª‡ ëª…ì´ì—ìš”?", fr:"Combien de personnes ?", guide:"Ex. Huit.", voice:"echo", hints:{choseong:"ã…  ã…ã…‡ã…‡ã…‡?", part:"compter personnes"} },
      { ko:"ì§€ê¸ˆ ëª‡ ì‹œ ëª‡ ë¶„ì´ì—ìš”?", fr:"Quelle heure et quelle minute est-il ?", guide:"Ex. 2 h 30.", voice:"fable", hints:{choseong:"ã…ˆã„±  ã… ã……  ã… ã…‚ã„´ã…‡ã…‡?", part:"heure + minutes"} },
    ];

    const choice = choiceData.map((q,i)=>({
      number:i+1, type:'choice', context:q.context, options:q.options, answer:q.answer,
      hints:q.hints, userAnswer:null, isCorrect:null,
      listenCount:0, hint1Count:0, hint2Count:0,
      pronunRequired:true, pronunAttempted:false
    }));

    const fr_prompt_ko = frKo.map((q,i)=>({
      number: choice.length + i + 1, type:'fr_prompt_ko',
      fr:q.fr, audioText:q.audio, frGuide:q.frGuide, ko:q.ko,
      accepted:q.accepted||[], voice:q.voice||'alloy', hints:q.hints,
      userAnswer:"", textChecked:false, textCorrect:null, isCorrect:null,
      listenCount:0, hint1Count:0, hint2Count:0,
      pronunRequired:true, pronunAttempted:false
    }));

    const dictation = dictee.map((q,i)=>({
      number: choice.length + fr_prompt_ko.length + i + 1, type:'dictation',
      ko:q.ko, fr:q.fr, frAnswerGuide:q.guide, voice:q.voice, hints:q.hints,
      userAnswer:{ko:"", replyKo:""}, isCorrect:null,
      listenCount:0, hint1Count:0, hint2Count:0,
      pronunRequired:true, pronunAttempted:false
    }));

    return [...choice, ...fr_prompt_ko, ...dictation];
  }

  // ===== ë Œë” =====
  function render(){
    const q = S.qs[S.idx]; if(!q) return;

    // Sticky 5Ã—5: Q6ë¶€í„°
    $('#sticky55')?.classList.toggle('hidden', q.number < 6);

    $('#progressText').textContent = `Question ${q.number} / ${S.qs.length}`;
    $('#progressBar').style.width = `${Math.round((S.idx / S.qs.length)*100)}%`;

    // ë¬¸í•­ ì¹´ë“œ
    const host = $('#qArea');
    host.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'card';
    host.appendChild(card);

    // ë°°ì§€
    const head = document.createElement('div');
    head.className = 'flex items-center gap-2 mb-1';
    head.innerHTML = `<span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-800 text-white">${label(q.type)}</span><span class="text-sm text-slate-500">Q${q.number}/${S.qs.length}</span>`;
    card.appendChild(head);

    // íƒ€ì…ë³„ ë Œë”
    if(q.type==='choice'){
      const h2 = document.createElement('h2');
      h2.className = 'text-lg font-semibold mb-1';
      h2.textContent = q.context;
      card.appendChild(h2);

      const p = document.createElement('p');
      p.className = 'text-sm text-slate-600 mb-2';
      p.textContent = 'Choisissez la bonne rÃ©ponse. / ì•Œë§ì€ ë‹µì„ ê³ ë¥´ì„¸ìš”.';
      card.appendChild(p);

      const wrap = document.createElement('div');
      wrap.className = 'choices';
      card.appendChild(wrap);

      const fb = document.createElement('div');
      fb.id = 'qFeedback';
      fb.className = 'feedback';
      card.appendChild(fb);

      q.options.forEach((label, idx) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'choice-btn';
        b.textContent = label;
        b.addEventListener('click', () => {
          q.userAnswer = label;
          q.isCorrect  = (label === q.answer);

          // ë¦¬ì…‹
          $$('.choice-btn', card).forEach(x=>x.classList.remove('is-correct','is-wrong'));
          if(q.isCorrect){
            b.classList.add('is-correct');
            fb.className = 'feedback good';
            fb.textContent = 'âœ… Correct ! Tu peux passer Ã  la suite. / ì •ë‹µ! ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ìš”.';
            q.pronunAttempted = false; // ì •ë‹µ í›„ ë°œìŒ ì‹œë„í•´ì•¼ ë‹¤ìŒ í™œì„±í™”
          }else{
            b.classList.add('is-wrong');
            fb.className = 'feedback bad';
            fb.textContent = "âŒ Mauvaise rÃ©ponse. Relis bien et choisis de nouveau. / ì˜¤ë‹µì´ì—ìš”. ë‹¤ì‹œ ê³¨ë¼ì£¼ì„¸ìš”.";
            card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
            q.pronunAttempted = false;
          }
          updateNav();
          // ì •ë‹µì´ë©´ ë°œìŒ ìœ„ì ¯ ë…¸ì¶œ
          renderPronunIfNeeded(card, q);
        });
        wrap.appendChild(b);
      });

      // ì •ë‹µ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ìœ„ì ¯ ë³´ì´ê¸°
      renderPronunIfNeeded(card, q);
    }

    if(q.type==='fr_prompt_ko'){
      const h2 = document.createElement('h2');
      h2.className = 'text-lg font-semibold mb-1';
      h2.textContent = q.fr;
      card.appendChild(h2);

      const controls = document.createElement('div');
      controls.className = 'flex gap-2 mb-2';
      controls.innerHTML = `
        <button class="btn btn-primary flex-1" id="btnListen">Ã‰couter (ë“£ê¸°)</button>
        <button class="btn" id="btnStop">â–  Stop</button>
      `;
      card.appendChild(controls);
      $('#btnListen', controls).addEventListener('click', e=>playAudio(q.audioText, q.voice, {_btn:e.currentTarget}));
      $('#btnStop', controls).addEventListener('click', stopAudio);

      const guide = document.createElement('div');
      guide.className = 'p-3 bg-white rounded border mb-3 text-sm text-slate-700';
      guide.innerHTML = `<span class="font-medium">Guide (FR)</span> : ${esc(q.frGuide)}`;
      card.appendChild(guide);

      card.insertAdjacentHTML('beforeend', hintBoxHTML(q));

      const lab = document.createElement('label');
      lab.className='block mb-1 font-semibold';
      lab.textContent='RÃ©ponse en corÃ©en (í•œêµ­ì–´):';
      card.appendChild(lab);

      const row = document.createElement('div');
      row.className='flex gap-2';
      row.innerHTML = `
        <input id="inpKO" class="input-field flex-1" value="${esc(q.userAnswer||'')}" placeholder="Ex. ${esc(q.ko)}">
        <button class="btn btn-primary" id="btnCheck">VÃ©rifier / ì •ë‹µ í™•ì¸</button>
      `;
      card.appendChild(row);
      $('#inpKO', row).addEventListener('input', (e)=>onTextInput(e.target.value));
      $('#btnCheck', row).addEventListener('click', checkText);

      if(q.textChecked){
        const ok = q.textCorrect===true;
        const res = document.createElement('div');
        res.className = `mt-3 ${ok?'text-emerald-700':'text-rose-700'} font-semibold`;
        res.innerHTML = ok
          ? 'âœ… Correct ! ë§ì•˜ìŠµë‹ˆë‹¤!'
          : `âŒ Incorrect. í‹€ë ¸ìŠµë‹ˆë‹¤. <span class="ml-2 text-slate-700">RÃ©ponse (KO) / ì •ë‹µ: <b>${esc(q.ko)}</b></span>`;
        card.appendChild(res);
        renderPronun(card, q); // ì •ì˜¤ ìƒê´€ ì—†ì´ ë°œìŒ ì‹œë„ í•„ìš”
      }
    }

    if(q.type==='dictation'){
      const h2 = document.createElement('h2');
      h2.className = 'text-lg font-semibold mb-1';
      h2.textContent = 'DictÃ©e + RÃ©ponse / ë°›ì•„ì“°ê¸° + ëŒ€ë‹µ';
      card.appendChild(h2);

      const controls = document.createElement('div');
      controls.className = 'flex gap-2 mb-2';
      controls.innerHTML = `
        <button class="btn btn-primary flex-1" id="btnListen">Ã‰couter (ë“£ê¸°)</button>
        <button class="btn" id="btnStop">â–  Stop</button>
      `;
      card.appendChild(controls);
      $('#btnListen', controls).addEventListener('click', e=>playAudio(q.ko, q.voice, {_btn:e.currentTarget}));
      $('#btnStop', controls).addEventListener('click', stopAudio);

      card.insertAdjacentHTML('beforeend', hintBoxHTML(q));

      const box = document.createElement('div');
      box.className = 'space-y-3';
      box.innerHTML = `
        <div>
          <label class="block mb-1 font-semibold">1) DictÃ©e (ë°›ì•„ì“°ê¸°)</label>
          <input class="input-field" id="dicKO" value="${esc(q.userAnswer.ko||'')}" placeholder="(Ã‰coutez et Ã©crivez tel quel / ê·¸ëŒ€ë¡œ ì ê¸°)">
        </div>
        <div>
          <label class="block mb-1 font-semibold">2) RÃ©ponse (í•œêµ­ì–´ ëŒ€ë‹µ)</label>
          <input class="input-field input-reply-ko" id="dicReply" value="${esc(q.userAnswer.replyKo||'')}" placeholder="Ex. ë„¤ ì‹œì˜ˆìš” / 10ìœ ë¡œì˜ˆìš” â€¦">
          <div class="text-xs text-slate-500 mt-1">Ex (FR) : ${esc(q.frAnswerGuide||'')}</div>
        </div>
      `;
      card.appendChild(box);
      $('#dicKO', box).addEventListener('input', e=>updateDictee('ko', e.target.value));
      $('#dicReply', box).addEventListener('input', e=>updateDictee('replyKo', e.target.value));

      renderPronun(card, q, '(2) votre rÃ©ponse / ë‹¹ì‹ ì˜ ëŒ€ë‹µ');
    }

    updateNav();
  }

  function label(t){
    return (t==='choice'?'Choix / ì„ íƒ': t==='fr_prompt_ko'?'FranÃ§ais â†’ í•œêµ­ì–´ / ë¶ˆâ†’í•œ':'DictÃ©e + RÃ©ponse / ë°›ì•„ì“°ê¸° + ëŒ€ë‹µ');
  }

  function hintBoxHTML(q){
    return `
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <button class="btn btn-outline" onclick="Quiz.showHint(1)">ğŸ™ Aidez-moi (íŒíŠ¸1: ì´ˆì„±)</button>
        <button class="btn btn-outline" onclick="Quiz.showHint(2)">ğŸ¦º Au secours (íŒíŠ¸2: ë¶€ë¶„ëœ»)</button>
        <span class="text-xs text-slate-500">H1: ${q.hint1Count||0} Â· H2: ${q.hint2Count||0}</span>
      </div>
      <div id="hintArea" class="text-sm text-slate-700"></div>
    `;
  }

  // ----- ë°œìŒ ìœ„ì ¯ -----
  function renderPronunIfNeeded(card, q){
    if(q.type==='choice' && q.userAnswer === q.answer){
      renderPronun(card, q, q.answer);
    }
  }
  function renderPronun(card, q, ref){
    const wrap = document.createElement('div');
    wrap.className = 'pronun-card mt-3';
    wrap.innerHTML = `
      <div class="pronun-title">ğŸ¤ Enregistrer & tester / ë…¹ìŒÂ·ë°œìŒ í‰ê°€</div>
      <div class="text-xs text-slate-600 mb-1">RÃ©fÃ©rence (KO): <span class="font-semibold">${esc(ref || refTextResolver(q))}</span></div>
      <div id="pronunMount"></div>
    `;
    card.appendChild(wrap);

    const mount = $('#pronunMount', wrap);
    if(mount && window.Pronun){
      try{
        Pronun.mount(mount, {
          ui: 'warmup', // ì›œì—…ê³¼ ë™ì¼ UI
          getReferenceText: ()=> refTextResolver(q, ref),
          onStart: ()=>{}, // í•„ìš” ì‹œ ì‚¬ìš©
          onStop:  ()=>{ q.pronunAttempted = true; updateNav(); },
          onResult:()=>{ q.pronunAttempted = true; updateNav(); }
        });
      }catch(e){ console.warn('Pronun.mount', e); }
    }
  }
  function refTextResolver(q, refOverride){
    if(refOverride) return String(refOverride||'');
    if(q.type==='choice') return q.answer;
    if(q.type==='fr_prompt_ko') return q.ko;
    if(q.type==='dictation') return ($('.input-reply-ko')?.value||'');
    return '';
  }

  // ===== ìƒí˜¸ì‘ìš© =====
  function onTextInput(v){
    const q=S.qs[S.idx];
    q.userAnswer=v;
    q.textChecked=false; q.textCorrect=null; q.pronunAttempted=false;
    updateNav();
  }
  function checkText(){
    const q=S.qs[S.idx];
    if(q.type!=='fr_prompt_ko') return;
    const v = (q.userAnswer||'').trim();
    if(!v) return;
    const cands = [q.ko, ...(q.accepted||[])];
    q.textCorrect = cands.some(ans=> strip(v)===strip(ans));
    q.textChecked = true;
    q.isCorrect = q.textCorrect;
    q.pronunAttempted=false;
    render();
  }
  function updateDictee(part,val){
    const q=S.qs[S.idx];
    q.userAnswer[part]=val;
    updateNav();
  }
  function showHint(n){
    const q=S.qs[S.idx]; if(!q||!q.hints) return;
    if(n===1){ q.hint1Count=(q.hint1Count||0)+1; $('#hintArea').textContent = `ì´ˆì„±: ${q.hints.choseong||'-'}`; }
    else     { q.hint2Count=(q.hint2Count||0)+1; $('#hintArea').textContent = `Indice (FR): ${q.hints.part||'-'}`; }
    updateNav();
  }

  // ë‹¤ìŒ ë²„íŠ¼ í—ˆìš©: â€œë°œìŒ 1íšŒ ì‹œë„â€ ê·œì¹™ í¬í•¨
  function isNextAllowed(){
    const q=S.qs[S.idx]; if(!q) return false;
    if(q.pronunRequired && !q.pronunAttempted) return false;

    if(q.type==='choice'){
      return !!q.userAnswer && q.userAnswer === q.answer;
    }else if(q.type==='fr_prompt_ko'){
      return !!q.userAnswer && q.textChecked===true;
    }else if(q.type==='dictation'){
      return !!q.userAnswer.ko && !!q.userAnswer.replyKo;
    }
    return false;
  }
  function updateNav(){
    $('#btnPrev').disabled = (S.idx<=0);
    const canNext = isNextAllowed();
    $('#btnNext').disabled = !canNext;
    const isLast = (S.idx===S.qs.length-1);
    $('#btnFinish').classList.toggle('hidden', !isLast);
    $('#btnFinish').disabled = !isLast ? true : false;
  }

  // ===== ì œì¶œ/ì €ì¥ =====
  async function finish(){
    const end = Date.now();
    const name = $('#studentName').value?.trim() || 'Ã‰lÃ¨ve';
    const payload = {
      studentName: name,
      startTime: new Date(S.start).toISOString(),
      endTime: new Date(end).toISOString(),
      totalTimeSeconds: Math.round((end - S.start)/1000),
      questions: S.qs.map(q=>({
        number:q.number,
        ko: q.type==='fr_prompt_ko' ? q.ko : (q.type==='dictation'? q.ko : q.context),
        fr: q.type==='fr_prompt_ko' ? q.fr : (q.type==='dictation'? q.fr : ''),
        userAnswer: q.type==='dictation' ? JSON.stringify(q.userAnswer) : (q.userAnswer||''),
        isCorrect: !!q.isCorrect,
        listenCount: q.listenCount||0,
        hint1Count: q.hint1Count||0,
        hint2Count: q.hint2Count||0
      }))
    };

    // ë¡œì»¬ ì €ì¥ + ì „ì†¡
    try{ localStorage.setItem('pongdang:lastResults', JSON.stringify(payload)); }catch(_){}
    try{
      await SendResults.sendResults(payload);
      alert('RÃ©sultats envoyÃ©s / ê²°ê³¼ ì „ì†¡ ì™„ë£Œ');
      $('#finalRow') && ($('#finalRow').textContent = `Score final : â€” Â· Temps total : ${fmtSecs(end - S.start)}`);
    }catch(e){
      alert('Envoi Ã©chouÃ©. / ì „ì†¡ ì‹¤íŒ¨');
    }
  }

  // ===== ë„¤ì„ê²Œì´íŠ¸ & ì´ˆê¸°í™” =====
  function requireName(){
    const v = $('#studentName').value?.trim();
    if(!v){ alert('ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”. / Ã‰cris ton nom dâ€™abord.'); return false; }
    S.name = v; return true;
  }

  // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  $('#btnPrev').addEventListener('click', ()=>{ if(S.idx>0){ S.idx--; render(); } });
  $('#btnNext').addEventListener('click', ()=>{
    if(!requireName()) return;
    if(isNextAllowed() && S.idx<S.qs.length-1){ S.idx++; render(); }
  });
  $('#btnFinish').addEventListener('click', ()=>{ if(!requireName()) return; finish(); });
  // í˜¸í™˜(ì´ì „ HTMLì— ìˆì„ ìˆ˜ ìˆëŠ” ë²„íŠ¼)
  $('#btnFinish2') && $('#btnFinish2').addEventListener('click', ()=>{ if(!requireName()) return; finish(); });
  window.addEventListener('beforeunload', cleanupAudio);

  // ì‹œì‘
  S.qs = getQuestions();
  render();

  // ì™¸ë¶€ì—ì„œ ì“°ëŠ” í•¨ìˆ˜ export
  window.Quiz = {
    playAudio, stopAudio,
    onTextInput, checkText, updateDictee, showHint
  };
})();
