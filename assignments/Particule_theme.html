<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice CorÃ©en: Particule de Contraste ì€/ëŠ”</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .made-by { font-size: 0.8rem; color: #888; text-align: center; padding: 15px; }
        .question-card { scroll-margin-top: 80px; }
        .correct { border: 2px solid #22c55e; background-color: #f0fdf4; }
        .incorrect { border: 2px solid #ef4444; background-color: #fef2f2; }
        [type="radio"]:checked { background-image: url("data:image/svg+xml,%3csvg viewBox='0' 0 16 16' fill='%234f46e5' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e"); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="made-by">Made by ì„±ì¼, Pongdang</div>

    <div class="max-w-4xl mx-auto p-5">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-700">Exercice: La particule de Contraste ì€/ëŠ”</h1>
                <p class="text-slate-500">ì—°ìŠµë¬¸ì œ: ëŒ€ì¡°/ë¹„êµë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì¡°ì‚¬ 'ì€/ëŠ”'</p>
            </div>
            <button onclick="window.print()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                Imprimer / í”„ë¦°íŠ¸
            </button>
        </header>

        <!-- Student Info -->
        <div id="student-info" class="mb-8 bg-white p-6 rounded-xl shadow-md">
            <label for="studentName" class="block text-lg font-semibold mb-2">Entrez votre nom / ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label>
            <input type="text" id="studentName" class="w-full p-3 border rounded-lg" placeholder="">
            <button id="start-btn" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg text-lg font-bold hover:bg-indigo-700 transition">Commencer l'exercice (ì‹œì‘)</button>
        </div>

        <!-- Main Content -->
        <main id="quiz-content" class="hidden">
            
            <!-- Explanation -->
            <div class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-6 rounded-lg mb-8 space-y-6">
                <div>
                    <h2 class="text-2xl font-bold mb-3">ğŸ§ Qu'est-ce qu'une particule ? (ì¡°ì‚¬?)</h2>
                    <p>En corÃ©en, une particule est un petit mot qui se colle Ã  un nom pour indiquer son rÃ´le dans la phrase (sujet, objet, lieu, etc.). C'est super important !</p>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-2">C'est quoi un "ë°›ì¹¨" ? (batchim)</h3>
                    <p class="p-4 bg-white rounded-md">
                        Le <strong>ë°›ì¹¨</strong> (batchim) est la <strong>consonne finale</strong> d'une syllabe. C'est elle qui dÃ©cide quelle particule utiliser !<br>
                        - Ex: <span class="font-bold text-blue-600">ì±…</span> (chaek) â†’ la syllabe se termine par la consonne <span class="font-bold text-red-600">ã„±</span> (k). Il y a un ë°›ì¹¨.<br>
                        - Ex: <span class="font-bold text-blue-600">ì €</span> (jeo) â†’ la syllabe se termine par la voyelle <span class="font-bold text-red-600">ã…“</span> (eo). Il n'y a pas de ë°›ì¹¨.
                    </p>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-2">â­ La particule de Contraste et ThÃ¨me : ì€/ëŠ”</h3>
                    <p><strong>C'est le point le plus important !</strong><br>
                    La particule <strong>ì€/ëŠ”</strong> ne sert pas seulement Ã  indiquer le thÃ¨me. Son rÃ´le principal est de mettre en avant un nom pour le <strong>comparer</strong> ou le <strong>contraster</strong> avec d'autres Ã©lÃ©ments (qui peuvent Ãªtre sous-entendus).</p>
                     <ul class="list-disc list-inside space-y-1 mt-2">
                        <li>On utilise <strong>ì€</strong> aprÃ¨s un nom avec ë°›ì¹¨ (consonne finale). Ex: ì‚¬ëŒ<span class="text-red-600 font-bold">ì€</span>.</li>
                        <li>On utilise <strong>ëŠ”</strong> aprÃ¨s un nom sans ë°›ì¹¨ (voyelle finale). Ex: ì €<span class="text-red-600 font-bold">ëŠ”</span>.</li>
                    </ul>
                </div>

                <div>
                     <h3 class="text-xl font-bold mb-2">âš ï¸ ì€/ëŠ” vs ì´/ê°€ (Sujet)</h3>
                     <p class="p-4 bg-white rounded-md">
                        <strong>ì´/ê°€</strong> : Identifie le sujet. C'est lui et personne d'autre. RÃ©pond Ã  "qui ?" ou "quoi ?".<br>
                        <span class="text-gray-600">Ex: <strong>í´<span class="text-blue-600">ì´</span></strong> ì™”ì–´ìš”. (<strong>Paul</strong> est venu. â†’ C'est Paul qui est venu, on l'identifie.)</span><br><br>
                        <strong>ì€/ëŠ”</strong> : Met le sujet en contraste. <br>
                        <span class="text-gray-600">Ex: ë‹¤ë¥¸ ì‚¬ëŒë“¤ì€ ì•ˆ ì™”ì–´ìš”. í•˜ì§€ë§Œ <strong>í´<span class="text-red-600">ì€</span></strong> ì™”ì–´ìš”. (Les autres ne sont pas venus. Mais <strong>Paul</strong>, lui, il est venu.)</span>
                     </p>
                </div>
                 <div>
                     <h3 class="text-xl font-bold mb-2">âš ï¸ ì€/ëŠ” vs ì„/ë¥¼ (Objet)</h3>
                     <p class="p-4 bg-white rounded-md">
                        <strong>ì„/ë¥¼</strong> : Marque simplement l'objet de l'action.<br>
                        <span class="text-gray-600">Ex: ì €ëŠ” <strong>ë¹µ<span class="text-blue-600">ì„</span></strong> ë¨¹ì—ˆì–´ìš”. (J'ai mangÃ© du pain. â†’ Simple constat.)</span><br><br>
                        <strong>ì€/ëŠ”</strong> : Met l'objet en contraste avec d'autres objets possibles.<br>
                        <span class="text-gray-600">Ex: ì €ëŠ” <strong>ë¹µ<span class="text-red-600">ì€</span></strong> ë¨¹ì—ˆì–´ìš”. (J'ai mangÃ© du pain [<em>...mais pas le cafÃ©, ni le jus d'orange</em>].)</span>
                     </p>
                </div>
            </div>

            <form id="quiz-form"></form>

            <div class="mt-8 flex justify-between items-center">
                <a href="/" class="text-indigo-600 hover:underline">â† Exercices prÃ©cÃ©dents (ì´ì „)</a>
            </div>
        </main>
        
        <!-- Results -->
        <div id="results" class="hidden mt-8 text-center bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold mb-4">RÃ©sultats / ê²°ê³¼</h2>
            <div id="result-message" class="text-2xl font-semibold p-6 rounded-lg mb-4"></div>
            <p class="text-lg">Votre score : <span id="score" class="font-bold"></span>%</p>
            <p class="text-slate-600">Temps total : <span id="total-time"></span> secondes.</p>
            
            <!-- AI Feedback Section -->
            <div id="ai-feedback-container" class="mt-8 text-left hidden">
                <h3 class="text-2xl font-bold mb-4 text-center">ğŸ¤– AI ë§ì¶¤ ì„¤ëª… / AI-Powered Feedback</h3>
                <div id="ai-feedback-loader" class="text-center p-4">
                    <div class="loader"></div>
                    <p class="mt-2 text-slate-500">ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”! (Analyse en cours...)</p>
                </div>
                <div id="ai-feedback-content" class="hidden p-5 bg-purple-50 border-l-4 border-purple-500 rounded-lg">
                    <!-- AI content will be inserted here -->
                </div>
                 <div id="ai-feedback-perfect" class="hidden p-5 bg-green-50 border-l-4 border-green-500 rounded-lg">
                    <p class="text-green-800">ğŸ‰ <strong>ë§Œì ì´ì—ìš”! (Score parfait !)</strong><br>ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë²½í•˜ê²Œ ì´í•´í–ˆì–´ìš”. ì¶”ê°€ ì„¤ëª…ì´ í•„ìš” ì—†ë„¤ìš”! (Vous avez tout compris. Aucune explication supplÃ©mentaire n'est nÃ©cessaire !)</p>
                </div>
            </div>
            
            <button id="restart-btn" class="mt-8 bg-indigo-600 text-white py-3 px-8 rounded-lg text-lg font-bold hover:bg-indigo-700 transition">Recommencer (ë‹¤ì‹œí•˜ê¸°)</button>
        </div>
    </div>

    <div class="made-by">Made by ì„±ì¼, Pongdang</div>

<script>
    // --- DATA ARRAYS (for random questions) ---
    const namePlaceholders = ['Super CÃ©dou', 'Championne Julie', 'GÃ©nie Martin', 'As de CorÃ©en Sophie', 'LÃ©gende Alex'];
    const subjectsVowel = [{ko: 'ì €', fr: 'Je/Moi'}, {ko: 'ëˆ„ë‚˜', fr: 'Grande soeur'}, {ko: 'ë‚˜ë¬´', fr: 'Arbre'}, {ko: 'í•™êµ', fr: 'Ã‰cole'}, {ko: 'ì˜ì', fr: 'Chaise'}, {ko: 'ë§ˆë¦¬', fr:'Marie'}, {ko: 'ì–´ë¨¸ë‹ˆ', fr:'MÃ¨re'}];
    const subjectsConsonant = [{ko: 'ì´ ì‚¬ëŒ', fr: 'Cette personne'}, {ko: 'ê°€ë°©', fr: 'Sac'}, {ko: 'ì˜¤ëŠ˜', fr: 'Aujourd\'hui'}, {ko: 'ì„ ìƒë‹˜', fr: 'Professeur'}, {ko: 'í´', fr: 'Paul'}, {ko: 'ì±…', fr: 'Livre'}, {ko: 'ë™ìƒ', fr: 'Petit frÃ¨re/soeur'}];
    const foodVowel = [{ko: 'ê¹€ì¹˜ì°Œê°œ', fr: 'RagoÃ»t de kimchi'}, {ko: 'ëœì¥ì°Œê°œ', fr: 'RagoÃ»t de soja'}, {ko: 'í”¼ì', fr: 'Pizza'}, {ko: 'ìš°ìœ ', fr: 'Lait'}, {ko: 'ì»¤í”¼', fr:'CafÃ©'}];
    const foodConsonant = [{ko: 'ë¹„ë¹”ë°¥', fr: 'Bibimbap'}, {ko: 'ë¶ˆê³ ê¸°', fr: 'Bulgogi'}, {ko: 'ë¹µ', fr: 'Pain'}, {ko: 'ë¼ë©´', fr: 'Ramen'}, {ko: 'ê¹€ë°¥', fr: 'Kimbap'}];
    
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // --- GLOBAL VARIABLES ---
    let studentName = '', startTime, endTime, currentSectionIndex = 0, questions = [], userAnswers = [];

    // --- DOM ELEMENTS ---
    const studentInfoDiv = document.getElementById('student-info');
    const studentNameInput = document.getElementById('studentName');
    const quizContentDiv = document.getElementById('quiz-content');
    const resultsDiv = document.getElementById('results');
    const startBtn = document.getElementById('start-btn');
    const quizForm = document.getElementById('quiz-form');
    const restartBtn = document.getElementById('restart-btn');
    const aiFeedbackContainer = document.getElementById('ai-feedback-container');
    const aiFeedbackLoader = document.getElementById('ai-feedback-loader');
    const aiFeedbackContent = document.getElementById('ai-feedback-content');
    const aiFeedbackPerfect = document.getElementById('ai-feedback-perfect');

    // --- FUNCTIONS ---
    function generateQuestions() {
        const items = {};
        const selectUnique = (arr, key) => {
            let item;
            do { item = getRandomItem(arr); } while (Object.values(items).includes(item));
            items[key] = item;
            return item;
        };

        const fv1 = selectUnique(foodVowel, 'fv1');
        const c2 = selectUnique(subjectsConsonant, 'c2');

        return [
            // === PARTIE 1: CHOIX DE BASE (5 questions) ===
            { section: 'Partie 1: Choisir ì€ ou ëŠ” (ê¸°ì´ˆ ë¬¸ì œ)', ko: `ì €___ í•™ìƒì´ì—ìš”.`, fr: `Moi, je suis Ã©tudiant(e).`, options: ['ì€', 'ëŠ”'], answer: 'ëŠ”', vocab: [{ko:'ì €', fr:'Moi/Je'}, {ko:'í•™ìƒ', fr:'Ã©tudiant(e)'}] },
            { section: 'Partie 1: Choisir ì€ ou ëŠ” (ê¸°ì´ˆ ë¬¸ì œ)', ko: `ì˜¤ëŠ˜___ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.`, fr: `Aujourd'hui, le temps est beau. (en contraste avec hier/demain)`, options: ['ì€', 'ëŠ”'], answer: 'ì€', vocab: [{ko:'ì˜¤ëŠ˜', fr:'Aujourd\'hui'}, {ko:'ë‚ ì”¨', fr:'temps/mÃ©tÃ©o'}, {ko:'ì¢‹ë‹¤', fr:'Ãªtre bon'}] },
            { section: 'Partie 1: Choisir ì€ ou ëŠ” (ê¸°ì´ˆ ë¬¸ì œ)', ko: `ì´ ${fv1.ko}___ ë§›ìˆì–´ìš”.`, fr: `Ce ${fv1.fr} est dÃ©licieux.`, options: ['ì€', 'ëŠ”'], answer: 'ëŠ”', vocab: [{ko:'ì´', fr:'Ce/Cette'}, {ko: fv1.ko, fr: fv1.fr}, {ko:'ë§›ìˆë‹¤', fr:'Ãªtre dÃ©licieux'}] },
            { section: 'Partie 1: Choisir ì€ ou ëŠ” (ê¸°ì´ˆ ë¬¸ì œ)', ko: `ì œ ${c2.ko}___ í•œêµ­ ì‚¬ëŒì´ì—ìš”.`, fr: `Mon/Ma ${c2.fr} est corÃ©en(ne).`, options: ['ì€', 'ëŠ”'], answer: 'ì€', vocab: [{ko:'ì œ', fr:'Mon/Ma'}, {ko: c2.ko, fr: c2.fr}, {ko:'í•œêµ­ ì‚¬ëŒ', fr:'personne corÃ©enne'}] },
            { section: 'Partie 1: Choisir ì€ ou ëŠ” (ê¸°ì´ˆ ë¬¸ì œ)', ko: `ì–´ì œ___ ì •ë§ ë”ì› ì–´ìš”.`, fr: `Hier, il faisait vraiment chaud.`, options: ['ì€', 'ëŠ”'], answer: 'ëŠ”', vocab: [{ko:'ì–´ì œ', fr:'Hier'}, {ko:'ì •ë§', fr:'vraiment'}, {ko:'ë¥ë‹¤', fr:'faire chaud'}] },
            
            // === PARTIE 2: COMPARAISON AVEC ì´/ê°€ (5 questions) ===
            { section: 'Partie 2: ì€/ëŠ” (Contraste) vs ì´/ê°€ (Identification)', ko: 'A: <strong>ëˆ„ê°€</strong> ë§ˆë¦¬ì˜ˆìš”? (Qui est Marie?)<br>B: ì € ì‚¬ëŒ___ ë§ˆë¦¬ì˜ˆìš”.', fr: 'B: C\'est cette personne-lÃ , Marie.', options: ['ì€', 'ì´'], answer: 'ì´', explanation: 'On rÃ©pond Ã  "ëˆ„ê°€" (Qui?), donc on identifie le sujet. On utilise "ì´/ê°€".', vocab: [{ko:'ëˆ„ê°€', fr:'Qui'}, {ko:'ì € ì‚¬ëŒ', fr:'cette personne-lÃ '}, {ko:'ë§ˆë¦¬', fr:'Marie'}] },
            { section: 'Partie 2: ì€/ëŠ” (Contraste) vs ì´/ê°€ (Identification)', ko: 'ì €ëŠ” ê°œë¥¼ ì¢‹ì•„í•´ìš”. í•˜ì§€ë§Œ ê³ ì–‘ì´___ ë¬´ì„œì›Œìš”.', fr: 'J\'aime les chiens. Mais les chats, j\'en ai peur.', options: ['ëŠ”', 'ê°€'], answer: 'ëŠ”', explanation: 'On met "les chats" en contraste avec "les chiens". C\'est le rÃ´le parfait pour "ì€/ëŠ”".', vocab: [{ko:'ì €', fr:'Je'}, {ko:'ê°œ', fr:'chien'}, {ko:'ì¢‹ì•„í•˜ë‹¤', fr:'aimer'}, {ko:'í•˜ì§€ë§Œ', fr:'mais'}, {ko:'ê³ ì–‘ì´', fr:'chat'}, {ko:'ë¬´ì„­ë‹¤', fr:'avoir peur de'}] },
            { section: 'Partie 2: ì€/ëŠ” (Contraste) vs ì´/ê°€ (Identification)', ko: 'A: <strong>ë­ê°€</strong> ë§›ìˆì–´ìš”? (Qu\'est-ce qui est bon?)<br>B: ê¹€ë°¥___ ë§›ìˆì–´ìš”.', fr: 'B: Le kimbap est bon.', options: ['ì€', 'ì´'], answer: 'ì´', explanation: 'On rÃ©pond Ã  "ë­ê°€" (Quoi?), donc on identifie "le kimbap" comme la chose qui est bonne. On utilise "ì´/ê°€".', vocab: [{ko:'ë­ê°€', fr:'Quoi'}, {ko:'ê¹€ë°¥', fr:'Kimbap'}, {ko:'ë§›ìˆë‹¤', fr:'Ãªtre dÃ©licieux'}] },
            { section: 'Partie 2: ì€/ëŠ” (Contraste) vs ì´/ê°€ (Identification)', ko: 'ì´ ì‹ë‹¹___ ë¹„ì‹¸ì§€ë§Œ ì •ë§ ë§›ìˆì–´ìš”.', fr: 'Ce restaurant est cher, mais vraiment dÃ©licieux.', options: ['ì€', 'ì´'], answer: 'ì€', explanation: 'On contraste deux aspects du restaurant ("cher" vs "dÃ©licieux"). "ì€/ëŠ”" est idÃ©al pour Ã§a.', vocab: [{ko:'ì´', fr:'Ce/Cette'}, {ko:'ì‹ë‹¹', fr:'restaurant'}, {ko:'ë¹„ì‹¸ë‹¤', fr:'Ãªtre cher'}, {ko:'-ì§€ë§Œ', fr:'mais'}, {ko:'ë§›ìˆë‹¤', fr:'Ãªtre dÃ©licieux'}] },
            { section: 'Partie 2: ì€/ëŠ” (Contraste) vs ì´/ê°€ (Identification)', ko: 'ì˜›ë‚  ì˜›ì ì—, ê³µì£¼ë‹˜___ ì‚´ì•˜ì–´ìš”.', fr: 'Il Ã©tait une fois, une princesse vivait...', options: ['ì€', 'ì´'], answer: 'ì´', explanation: 'Pour introduire un nouveau personnage pour la premiÃ¨re fois dans une histoire, on utilise "ì´/ê°€".', vocab: [{ko:'ì˜›ë‚  ì˜›ì ì—', fr:'Il Ã©tait une fois'}, {ko:'ê³µì£¼ë‹˜', fr:'princesse'}, {ko:'ì‚´ë‹¤', fr:'vivre'}] },

            // === PARTIE 3: COMPARAISON AVEC ì„/ë¥¼ (5 questions) ===
            { section: 'Partie 3: ì€/ëŠ” (Contraste) vs ì„/ë¥¼ (Objet simple)', ko: 'ì €ëŠ” ë§¤ì¼ ì•„ì¹¨ ì£¼ìŠ¤___ ë§ˆì…”ìš”.', fr: 'Je bois du jus tous les matins. (Simple fait)', options: ['ëŠ”', 'ë¥¼'], answer: 'ë¥¼', explanation: '"ë¥¼" marque simplement "jus" comme l\'objet du verbe "boire".', vocab: [{ko:'ì €', fr:'Je'}, {ko:'ë§¤ì¼ ì•„ì¹¨', fr:'chaque matin'}, {ko:'ì£¼ìŠ¤', fr:'jus'}, {ko:'ë§ˆì‹œë‹¤', fr:'boire'}] },
            { section: 'Partie 3: ì€/ëŠ” (Contraste) vs ì„/ë¥¼ (Objet simple)', ko: 'ì €ëŠ” ì£¼ìŠ¤___ ì•ˆ ë§ˆì…”ìš”. ë³´í†µ ë¬¼ì„ ë§ˆì…”ìš”.', fr: 'Je ne bois pas de jus. D\'habitude, je bois de l\'eau.', options: ['ëŠ”', 'ë¥¼'], answer: 'ëŠ”', explanation: 'On met "jus" en contraste direct avec "eau". "ëŠ”" est parfait pour souligner ce choix.', vocab: [{ko:'ì£¼ìŠ¤', fr:'jus'}, {ko:'ì•ˆ', fr:'ne...pas'}, {ko:'ë§ˆì‹œë‹¤', fr:'boire'}, {ko:'ë³´í†µ', fr:'d\'habitude'}, {ko:'ë¬¼', fr:'eau'}] },
            { section: 'Partie 3: ì€/ëŠ” (Contraste) vs ì„/ë¥¼ (Objet simple)', ko: 'ì–´ì œ ì¹œêµ¬___ ë§Œë‚¬ì–´ìš”.', fr: 'Hier, j\'ai vu un(e) ami(e). (Simple action)', options: ['ëŠ”', 'ë¥¼'], answer: 'ë¥¼', explanation: 'C\'est une phrase simple sur l\'action de rencontrer un ami. "ë¥¼" est le plus naturel.', vocab: [{ko:'ì–´ì œ', fr:'Hier'}, {ko:'ì¹œêµ¬', fr:'ami(e)'}, {ko:'ë§Œë‚˜ë‹¤', fr:'rencontrer'}] },
            { section: 'Partie 3: ì€/ëŠ” (Contraste) vs ì„/ë¥¼ (Objet simple)', ko: 'ì˜í™”___ ë´¤ì§€ë§Œ, ì±…ì€ ëª» ì½ì—ˆì–´ìš”.', fr: 'J\'ai vu le film, mais je n\'ai pas pu lire le livre.', options: ['ëŠ”', 'ë¥¼'], answer: 'ëŠ”', explanation: 'On compare explicitement l\'action sur "le film" et "le livre". "ëŠ”" est nÃ©cessaire pour marquer ce contraste.', vocab: [{ko:'ì˜í™”', fr:'film'}, {ko:'ë³´ë‹¤', fr:'voir'}, {ko:'ì±…', fr:'livre'}, {ko:'ëª»', fr:'ne pas pouvoir'}, {ko:'ì½ë‹¤', fr:'lire'}] },
            { section: 'Partie 3: ì€/ëŠ” (Contraste) vs ì„/ë¥¼ (Objet simple)', ko: 'ê³ ê¸°___ ì˜ ë¨¹ì§€ë§Œ, ìƒì„ ì€ ì•ˆ ì¢‹ì•„í•´ìš”.', fr: 'Je mange bien de la viande, mais je n\'aime pas le poisson.', options: ['ëŠ”', 'ë¥¼'], answer: 'ëŠ”', explanation: 'On met "la viande" en opposition avec "le poisson". Le contraste est la clÃ©.', vocab: [{ko:'ê³ ê¸°', fr:'viande'}, {ko:'ì˜ ë¨¹ë‹¤', fr:'bien manger'}, {ko:'ìƒì„ ', fr:'poisson'}, {ko:'ì•ˆ ì¢‹ì•„í•˜ë‹¤', fr:'ne pas aimer'}] },
            
            // === PARTIE 4: Ã‰CRITURE (5 questions) ===
            { section: 'Partie 4: Construire la phrase (ë¬¸ì¥ ë§Œë“¤ê¸°)', type: 'writing', ko: 'Situation : La CorÃ©e (í•œêµ­) est petite. La Chine (ì¤‘êµ­) est grande.', fr: 'Ã‰crivez une phrase sur la CorÃ©e en la contrastant avec la Chine.', answer: 'í•œêµ­ì€ ì‘ì•„ìš”', vocab: [{ko:'í•œêµ­', fr:'CorÃ©e'}, {ko:'ì‘ë‹¤', fr:'Ãªtre petit'}, {ko:'ì¤‘êµ­', fr:'Chine'}, {ko:'í¬ë‹¤', fr:'Ãªtre grand'}] },
            { section: 'Partie 4: Construire la phrase (ë¬¸ì¥ ë§Œë“¤ê¸°)', type: 'writing', ko: 'Situation : Vous Ã©tudiez le corÃ©en (í•œêµ­ì–´), mais pas le japonais (ì¼ë³¸ì–´).', fr: 'Ã‰crivez une phrase qui exprime cela, en commenÃ§ant par "í•œêµ­ì–´ëŠ”".', answer: 'í•œêµ­ì–´ëŠ” ë°°ìš°ì§€ë§Œ ì¼ë³¸ì–´ëŠ” ì•ˆ ë°°ì›Œìš”', vocab: [{ko:'í•œêµ­ì–´', fr:'corÃ©en'}, {ko:'ë°°ìš°ë‹¤', fr:'apprendre'}, {ko:'ì¼ë³¸ì–´', fr:'japonais'}] },
            { section: 'Partie 4: Construire la phrase (ë¬¸ì¥ ë§Œë“¤ê¸°)', type: 'writing', ko: 'Situation : Vous avez achetÃ© les pommes (ì‚¬ê³¼), mais vous n\'avez pas achetÃ© les bananes (ë°”ë‚˜ë‚˜).', fr: 'Ã‰crivez une phrase pour dire "J\'ai achetÃ© les pommes (mais...)"', answer: 'ì‚¬ê³¼ëŠ” ìƒ€ì–´ìš”', vocab: [{ko:'ì‚¬ê³¼', fr:'pomme'}, {ko:'ì‚¬ë‹¤', fr:'acheter'}, {ko:'ë°”ë‚˜ë‚˜', fr:'banane'}] },
            { section: 'Partie 4: Construire la phrase (ë¬¸ì¥ ë§Œë“¤ê¸°)', type: 'writing', ko: 'Situation : L\'Ã©tÃ© (ì—¬ë¦„) est chaud. L\'hiver (ê²¨ìš¸) est froid.', fr: 'Ã‰crivez une phrase sur l\'Ã©tÃ© en le contrastant avec l\'hiver.', answer: 'ì—¬ë¦„ì€ ë”ì›Œìš”', vocab: [{ko:'ì—¬ë¦„', fr:'Ã©tÃ©'}, {ko:'ë¥ë‹¤', fr:'faire chaud'}, {ko:'ê²¨ìš¸', fr:'hiver'}, {ko:'ì¶¥ë‹¤', fr:'faire froid'}] },
            { section: 'Partie 4: Construire la phrase (ë¬¸ì¥ ë§Œë“¤ê¸°)', type: 'writing', ko: 'Situation : Le bus (ë²„ìŠ¤) est lent. Le mÃ©tro (ì§€í•˜ì² ) est rapide.', fr: 'Comparez les deux en commenÃ§ant par "ë²„ìŠ¤ëŠ”".', answer: 'ë²„ìŠ¤ëŠ” ëŠë¦¬ì§€ë§Œ ì§€í•˜ì² ì€ ë¹¨ë¼ìš”', vocab: [{ko:'ë²„ìŠ¤', fr:'bus'}, {ko:'ëŠë¦¬ë‹¤', fr:'Ãªtre lent'}, {ko:'ì§€í•˜ì² ', fr:'mÃ©tro'}, {ko:'ë¹ ë¥´ë‹¤', fr:'Ãªtre rapide'}] }
        ];
    }

    function startQuiz() {
        studentName = studentNameInput.value.trim();
        if (studentName === '') {
            alert('Veuillez entrer votre nom. / ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        startTime = new Date();
        studentInfoDiv.classList.add('hidden');
        quizContentDiv.classList.remove('hidden');
        renderQuestions();
        showSection(0);
    }

    function renderQuestions() {
        const sections = [...new Set(questions.map(q => q.section))];

        let formHtml = '';
        sections.forEach((sectionTitle, sectionIndex) => {
            formHtml += `<div id="section-${sectionIndex}" class="section-wrapper" style="display: none;">
                <h2 class="text-2xl font-bold mt-8 mb-4 border-b-2 pb-2 border-indigo-200">${sectionTitle}</h2>`;
            
            questions.forEach((q, questionIndex) => {
                if (q.section === sectionTitle) {
                    let questionHtml = `<div id="q-${questionIndex}" class="question-card bg-white p-6 rounded-xl shadow-md mb-6">
                        <p class="text-lg font-semibold mb-1"><span class="text-indigo-600">Question ${questionIndex + 1}:</span> ${q.ko}</p>
                        <p class="text-slate-500 mb-4">${q.fr || ''}</p>`;
                    
                    if (q.vocab && q.vocab.length > 0) {
                        questionHtml += `<div class="mt-4 p-3 bg-slate-100 rounded-md text-sm">
                            <h4 class="font-bold text-slate-600 mb-1">Vocabulaire (ë‹¨ì–´)</h4>
                            <ul class="flex flex-wrap gap-x-4 gap-y-1">`;
                        q.vocab.forEach(v => {
                            questionHtml += `<li><span class="font-semibold text-indigo-700">${v.ko}</span>: ${v.fr}</li>`;
                        });
                        questionHtml += `</ul></div>`;
                    }

                    if (q.type === 'writing') {
                        questionHtml += `<textarea id="q${questionIndex}-input" rows="3" class="w-full p-2 border rounded-lg mt-4" placeholder="Ã‰crivez votre phrase ici..."></textarea>`;
                    } else {
                        questionHtml += `<div id="options-${questionIndex}" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">`;
                        q.options.forEach(option => {
                            questionHtml += `<label class="p-4 border rounded-lg cursor-pointer hover:bg-indigo-50 transition">
                                <input type="radio" name="q${questionIndex}" value="${option}" class="mr-3 accent-indigo-600">
                                <span>${option}</span>
                            </label>`;
                        });
                        questionHtml += `</div>`;
                    }
                    questionHtml += `<div id="feedback-${questionIndex}" class="mt-3 text-sm"></div>
                        <div class="mt-4"><a href="#" onclick="showHint(${questionIndex}); return false;" class="text-sm text-blue-600 hover:underline">Aidez moi ! ğŸ™ (ë„ì™€ì£¼ì„¸ìš”!)</a></div>
                    </div>`;
                    formHtml += questionHtml;
                }
            });

            formHtml += `<div class="mt-6 flex justify-end items-center space-x-3">`;
            if (sectionIndex > 0) {
                formHtml += `<button type="button" onclick="navigate(-1)" class="bg-slate-300 text-slate-700 px-5 py-2 rounded-lg hover:bg-slate-400 transition">Partie PrÃ©cÃ©dente (ì´ì „)</button>`;
            }
            if (sectionIndex < sections.length - 1) {
                formHtml += `<button type="button" onclick="navigate(1)" class="bg-indigo-500 text-white px-5 py-2 rounded-lg hover:bg-indigo-600 transition">Partie Suivante (ë‹¤ìŒ)</button>`;
            } else {
                formHtml += `<button type="button" id="finish-btn-final" class="bg-green-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-green-700 transition">Terminer (ëë‚´ê¸°)</button>`;
            }
            formHtml += `</div></div>`;
        });

        quizForm.innerHTML = formHtml;
        document.getElementById('finish-btn-final').addEventListener('click', finishQuiz);
    }

    function showHint(index) {
        const q = questions[index];
        const feedbackDiv = document.getElementById(`feedback-${index}`);
        let hintText = "ğŸ›Ÿ Au secours ! (ì‚´ë ¤ì£¼ì„¸ìš”!)<br>";
        if (q.explanation) {
            hintText += q.explanation;
        } else {
            if(q.section.includes('Partie 1')) hintText += "Le mot se termine par une voyelle (sans ë°›ì¹¨) -> ëŠ”, par une consonne (avec ë°›ì¹¨) -> ì€.";
            else hintText += "Est-ce qu'on identifie quelque chose (ì´/ê°€) ou on compare/contraste (ì€/ëŠ”) ?";
        }
        feedbackDiv.innerHTML = `<p class="mt-2 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">${hintText}</p>`;
    }

    function showSection(index) {
        document.querySelectorAll('.section-wrapper').forEach(card => card.style.display = 'none');
        const targetSection = document.getElementById(`section-${index}`);
        if (targetSection) {
            targetSection.style.display = 'block';
            targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    function navigate(direction) {
        const sections = [...new Set(questions.map(q => q.section))];
        const currentSectionTitle = sections[currentSectionIndex];
        questions.forEach((q, index) => {
            if (q.section === currentSectionTitle) {
                saveAnswer(index);
            }
        });

        currentSectionIndex += direction;
        showSection(currentSectionIndex);
    }

    function saveAnswer(index) {
        const q = questions[index];
        if (q.type === 'writing') {
            const input = document.getElementById(`q${index}-input`);
            userAnswers[index] = input ? input.value : null;
        } else {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            userAnswers[index] = selected ? selected.value : null;
        }
    }

    async function getAIFeedback(incorrectAnswersData) {
        const apiKey = ""; // Canvas will provide this
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const systemPrompt = `Vous Ãªtes un professeur de corÃ©en sympathique et encourageant pour des dÃ©butants francophones.
Analysez les erreurs suivantes de l'Ã©tudiant sur les particules corÃ©ennes ì€/ëŠ”, ì´/ê°€, ì„/ë¥¼.
Identifiez la principale faiblesse ou le point de confusion de l'Ã©tudiant.
Fournissez une explication concise et simple en franÃ§ais, suivie de la mÃªme explication en corÃ©en.
Utilisez un langage trÃ¨s simple et des exemples clairs pour aider l'Ã©tudiant Ã  comprendre la nuance.
Commencez par une analyse gÃ©nÃ©rale, puis donnez un ou deux exemples corrigÃ©s.
Soyez positif et encourageant. Adressez-vous directement Ã  l'Ã©tudiant.`;

        const userQuery = `Voici les erreurs de l'Ã©tudiant. Analysez-les et donnez une explication personnalisÃ©e :\n\n${JSON.stringify(incorrectAnswersData, null, 2)}`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            const result = await response.json();
            const feedbackText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            aiFeedbackLoader.classList.add('hidden');
            if (feedbackText) {
                aiFeedbackContent.innerHTML = feedbackText.replace(/\n/g, '<br>');
                aiFeedbackContent.classList.remove('hidden');
            } else {
                 aiFeedbackContent.innerHTML = "DÃ©solÃ©, une erreur est survenue lors de l'analyse. (ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.)";
                 aiFeedbackContent.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error fetching AI feedback:", error);
            aiFeedbackLoader.classList.add('hidden');
            aiFeedbackContent.innerHTML = "DÃ©solÃ©, impossible de contacter le service d'analyse. (ë¶„ì„ ì„œë¹„ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)";
            aiFeedbackContent.classList.remove('hidden');
        }
    }

    function finishQuiz() {
        // Save answers for the final section before finishing
        const sections = [...new Set(questions.map(q => q.section))];
        const lastSectionTitle = sections[currentSectionIndex];
        questions.forEach((q, index) => {
            if (q.section === lastSectionTitle) {
                saveAnswer(index);
            }
        });

        endTime = new Date();
        quizContentDiv.classList.add('hidden');
        resultsDiv.classList.remove('hidden');

        let correctCount = 0;
        const incorrectAnswersForAI = [];
        const questionsPayload = questions.map((q, i) => {
            const userAnswer = userAnswers[i] || "";
            let isCorrect = false;

            const feedbackContainer = document.getElementById(`feedback-${i}`);
            
            if (q.type === 'writing') {
                 isCorrect = userAnswer.replace(/\s/g, '').includes(q.answer.replace(/\s/g, ''));
                 const input = document.getElementById(`q${i}-input`);
                 input.disabled = true;
                 input.classList.add(isCorrect ? 'correct' : 'incorrect');
                 if(!isCorrect) feedbackContainer.innerHTML = `<p class="mt-2 text-green-700">Oups, petit couac ğŸ˜… â†’ comme Ã§a, câ€™est parfait !<br>Exemple de rÃ©ponse : <strong>${q.answer}</strong></p>`;
            } else {
                const optionsContainer = document.getElementById(`options-${i}`);
                isCorrect = userAnswer === q.answer;
                optionsContainer.querySelectorAll('label').forEach(label => {
                    const radio = label.querySelector('input');
                    if (radio.value === q.answer) {
                        label.classList.add('correct');
                    } else if (radio.checked) {
                        label.classList.add('incorrect');
                    }
                    radio.disabled = true;
                });
                if(!isCorrect && q.explanation) {
                    feedbackContainer.innerHTML = `<p class="mt-2 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md">ğŸ’¡ <strong>Astuce :</strong> ${q.explanation}</p>`;
                }
            }
            if (isCorrect) {
                correctCount++;
            } else {
                incorrectAnswersForAI.push({
                    question_fr: q.fr,
                    question_ko: q.ko.replace(/<[^>]*>?/gm, ''), // remove html tags
                    student_answer: userAnswer,
                    correct_answer: q.answer,
                    question_type: q.section
                });
            }
            
            return { number: i + 1, ko: q.ko.replace(/<br>|<strong>|<\/strong>/g, ''), fr: q.fr, userAnswer: userAnswer, isCorrect: isCorrect };
        });

        const score = (correctCount / questions.length) * 100;
        document.getElementById('score').innerText = score.toFixed(0);
        const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
        document.getElementById('total-time').innerText = totalTimeSeconds;
        
        const resultMessageDiv = document.getElementById('result-message');
        let message, frMessage, bgColor;
        if (score === 100) { [frMessage, message, bgColor] = ["Parfait absolu ! ğŸ‘‘ğŸ‰ GÃ©nie confirmÃ© !", "ì™„ë²½ ê·¸ ìì²´! ğŸ‘‘ğŸ‰ ì²œì¬ ì¸ì¦!", 'bg-green-100 text-green-800']; }
        else if (score >= 80) { [frMessage, message, bgColor] = ["TrÃ¨s bien jouÃ© ! ğŸ‘ Presque un maÃ®tre !", "ì•„ì£¼ ì˜í–ˆì–´ìš”! ğŸ‘ ì´ ì •ë„ë©´ ê±°ì˜ ë§ˆìŠ¤í„°!", 'bg-blue-100 text-blue-800']; }
        else if (score >= 60) { [frMessage, message, bgColor] = ["Pas mal du tout ! ğŸ˜ Encore un petit effort et câ€™est le top !", "ê½¤ ì˜í–ˆì–´ìš”! ğŸ˜ ì¡°ê¸ˆë§Œ ë” ê°€ë©´ ìµœê³ !", 'bg-yellow-100 text-yellow-800']; }
        else { [frMessage, message, bgColor] = ["Allez, un petit cafÃ© et on repart ! â˜•ğŸ’ª", "ì, ì»¤í”¼ í•œ ì” í•˜ê³  ë‹¤ì‹œ ê°€ì! â˜•ğŸ’ª", 'bg-red-100 text-red-800']; }
        resultMessageDiv.innerHTML = `${frMessage}<br>${message}`;
        resultMessageDiv.className = `text-2xl font-semibold p-6 rounded-lg mb-4 ${bgColor}`;

        // AI Feedback logic
        aiFeedbackContainer.classList.remove('hidden');
        if(incorrectAnswersForAI.length > 0) {
            aiFeedbackLoader.classList.remove('hidden');
            aiFeedbackContent.classList.add('hidden');
            getAIFeedback(incorrectAnswersForAI);
        } else {
            aiFeedbackLoader.classList.add('hidden');
            aiFeedbackPerfect.classList.remove('hidden');
        }

        quizContentDiv.classList.add('hidden'); // Hide original questions
        // Or show them with answers
        // quizContentDiv.classList.remove('hidden');
        // document.querySelectorAll('.section-wrapper').forEach(card => card.style.display = 'block');
        resultsDiv.scrollIntoView({ behavior: 'smooth' });
        
        // const finalNav = document.getElementById('finish-btn-final').parentElement;
        // if(finalNav) finalNav.classList.add('hidden');

        const payload = { studentName, startTime: startTime.toISOString(), endTime: endTime.toISOString(), totalTimeSeconds, questions: questionsPayload };
        fetch('/.netlify/functions/send-results', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        }).catch(error => console.error("Error sending results:", error));
    }
    
    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        studentNameInput.placeholder = getRandomItem(namePlaceholders);
        questions = generateQuestions();
        userAnswers = new Array(questions.length).fill(null);
        currentSectionIndex = 0;
    });
    
    startBtn.addEventListener('click', startQuiz);
    restartBtn.addEventListener('click', () => window.location.reload());
</script>
</body>
</html>

