<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국어 듣기 연습 – 08/08/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EmailJS SDK -->
    <script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>

    <style>
      /* (기존 스타일 유지) */
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- 학생 정보 입력 -->
        <div id="student-gate" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-2xl font-bold text-blue-600 mb-4">
                듣기 평가에 오신 것을 환영합니다!
            </h1>
            <p class="text-slate-600 mb-6">
                이름이나 학번을 입력해주세요.
            </p>
            <input type="text" id="student-id-input"
                   class="w-full max-w-sm mx-auto p-3 border-2 border-slate-300 rounded-lg text-center"
                   placeholder="예: Cédou">
            <button onclick="startTest()"
                    class="mt-6 w-full max-w-sm mx-auto btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                테스트 시작!
            </button>
        </div>

        <!-- 테스트 콘텐츠 -->
        <div id="test-content" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">한국어 듣고 받아쓰기 ✍️</h1>
                <p class="text-slate-500 mt-2">08/08/2025</p>
            </header>

            <div class="flex justify-center gap-4 mb-8">
                <button onclick="window.print()"
                        class="btn btn-action flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-print"></i> 인쇄하기
                </button>
                <button onclick="finishTest()"
                        class="btn bg-red-500 hover:bg-red-600 text-white flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-paper-plane"></i> 끝내기
                </button>
            </div>

            <main id="tasks-list" class="space-y-6"></main>

            <div id="final-message" class="hidden mt-8 bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg text-center"></div>
        </div>
    </div>

    <script>
    // ------------ EmailJS 초기화 ------------
    (function(){
      emailjs.init('YOUR_EMAILJS_USER_ID'); // ← EmailJS 대시보드에서 발급된 user ID
    })();

    // ------------ 데이터 & 질문 목록 ------------
    let studentData = { studentId: null, startTime: null, endTime: null, questions: [] };
    let testStarted = false;
    const teacherEmail = "votre.email@professeur.fr";

    const questions = [
      /* 기존 질문 배열 그대로 사용 */
      { id: 1, korean: "잘 들려요?", french: "Tu m’entends bien ?", voice: "female" },
      /* ... 총 18개 ... */
    ];

    // 화면에 문제들 렌더링
    const tasksList = document.getElementById('tasks-list');
    questions.forEach(q => {
      studentData.questions.push({ id: q.id, playCount: 0, wrongAttempts: 0 });
      const div = document.createElement('div');
      div.className = 'task-container bg-white p-5 rounded-xl border border-slate-200';
      div.id = `task-${q.id}`;
      div.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-slate-700">Exercice ${q.id}</h2>
          <button onclick="playAudio(${q.id})"
                  class="btn btn-audio w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-md">
            <i class="fas fa-play"></i>
          </button>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block mb-1 font-semibold">한국어 답</label>
            <input type="text" id="korean-input-${q.id}" oninput="checkAndStartTimer()"
                   class="w-full p-3 border-2 rounded-lg" placeholder="여기에 입력...">
          </div>
          <div>
            <label class="block mb-1 font-semibold">프랑스어 번역</label>
            <input type="text" id="french-input-${q.id}" oninput="checkAndStartTimer()"
                   class="w-full p-3 border-2 rounded-lg" placeholder="Écrivez ici...">
          </div>
        </div>
        <div class="flex gap-3 mt-4">
          <button onclick="checkAnswer(${q.id})"
                  class="btn btn-check py-2 px-4 rounded-lg font-bold">
            <i class="fas fa-check mr-2"></i>정답 확인
          </button>
        </div>
        <div id="result-box-${q.id}" class="mt-4 p-4 rounded-lg hidden"></div>
      `;
      tasksList.appendChild(div);
    });

    // ------------ 타이머 시작 ------------
    function checkAndStartTimer(){
      if (!testStarted) {
        studentData.startTime = new Date();
        testStarted = true;
      }
    }

    // ------------ Audio 재생 ------------
    let currentAudio = null;
    async function playAudio(id) {
      checkAndStartTimer();
      const stat = studentData.questions.find(x=>x.id===id);
      stat.playCount++;

      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      try {
        const question = questions.find(x=>x.id===id);
        const res = await fetch(`/.netlify/functions/generate-audio`, {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: question.korean, voice: question.voice })
        });
        if (!res.ok) throw new Error(res.statusText);
        const buffer = await res.arrayBuffer();
        const blob = new Blob([buffer], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        await currentAudio.play();
      } catch(e) {
        console.error(e);
        alert("오디오 재생 실패");
      }
    }

    // ------------ 정답 확인 ------------
    function checkAnswer(id) {
      checkAndStartTimer();
      const q = questions.find(x=>x.id===id);
      const korIn = document.getElementById(`korean-input-${id}`).value.trim();
      const frIn  = document.getElementById(`french-input-${id}`).value.trim();
      const korOk = korIn.replace(/[\.\?\!,]/g,'') === q.korean.replace(/[\.\?\!,]/g,'');
      const frOk  = frIn.toLowerCase().replace(/[\.\?\!',]/g,'') === q.french.toLowerCase().replace(/[\.\?\!',]/g,'');
      if (!(korOk && frOk)) {
        studentData.questions.find(x=>x.id===id).wrongAttempts++;
      }
      const box = document.getElementById(`result-box-${id}`);
      if (korOk && frOk) {
        box.className = 'mt-4 p-4 rounded-lg bg-green-100 border-l-4 border-green-500 text-green-700';
        box.innerHTML = `정답입니다!<br>🇰🇷 ${q.korean}<br>🇫🇷 ${q.french}`;
      } else {
        box.className = 'mt-4 p-4 rounded-lg bg-red-100 border-l-4 border-red-500 text-red-700';
        box.innerHTML = `틀렸습니다!<br>
                         🇰🇷 당신: ${korIn || '(미입력)'}<br>정답: ${q.korean}<br>
                         🇫🇷 당신: ${frIn || '(미입력)'}<br>정답: ${q.french}`;
      }
      box.classList.remove('hidden');
    }

    // ------------ 종료 & 결과 전송 ------------
    function finishTest() {
      if (!testStarted) return alert("테스트를 먼저 시작하세요!");
      studentData.endTime = new Date();
      const duration = Math.round((studentData.endTime - studentData.startTime)/60000);

      // 1) 학생에게 결과 보여주기
      let html = `<h2 class="font-bold text-xl mb-4">테스트 결과</h2>
                  <p>학번/이름: <strong>${studentData.studentId}</strong></p>
                  <p>소요 시간: <strong>${duration}분</strong></p>
                  <hr class="my-4">
                  <table class="w-full text-left">
                    <thead><tr><th>문제</th><th>들은 횟수</th><th>틀린 횟수</th></tr></thead>
                    <tbody>`;
      studentData.questions.forEach(s=> {
        html += `<tr>
                   <td>${s.id}</td>
                   <td>${s.playCount}</td>
                   <td>${s.wrongAttempts}</td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      const fm = document.getElementById('final-message');
      fm.innerHTML = html;
      fm.classList.remove('hidden');

      // 2) EmailJS로 선생님께 전송
      const templateParams = {
        teacher_email: teacherEmail,
        student_id:    studentData.studentId,
        date:          new Date().toLocaleDateString('fr-FR'),
        duration:      `${duration}분`,
        details:       JSON.stringify(studentData.questions)
      };
      emailjs.send('YOUR_SERVICE_ID','YOUR_TEMPLATE_ID', templateParams)
        .then(_=> console.log('Email sent'))
        .catch(err=> console.error('EmailJS error:', err));
    }
    </script>
</body>
</html>
