<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ì—°ìŠµ ë¬¸ì œ | Exercice de CorÃ©en</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }
        /* í…Œë§ˆ ìƒ‰ìƒ */
        .theme-bg-primary { background-color: #0033a0; }
        .theme-text-primary { color: #0033a0; }
        .theme-bg-secondary { background-color: #ffd700; }
        .theme-text-secondary { color: #ffd700; }
        .theme-border-primary { border-color: #0033a0; }
        .theme-border-secondary { border-color: #ffd700; }

        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .selected {
            border: 3px solid #ffd700 !important;
            transform: scale(1.05);
        }
        .correct-match {
            background-color: #c8e6c9 !important;
            border-color: #4caf50 !important;
            pointer-events: none;
        }
        .incorrect-match {
            animation: shake 0.5s;
            background-color: #ffcdd2 !important;
            border-color: #f44336 !important;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .quiz-section {
            display: none;
        }
        .active-section {
            display: block;
        }
        #result-message .icon {
            font-size: 4rem;
        }
        
        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #printable-area {
            display: none;
        }

        @media print {
            body > #app-container, .no-print {
                display: none;
            }
            #printable-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <header class="theme-bg-primary text-white p-6 text-center">
            <h1 class="text-3xl font-bold">LeÃ§on de CorÃ©en Interactive ğŸ‡°ğŸ‡·ğŸ‡«ğŸ‡·</h1>
            <p class="mt-2 text-lg">í•œêµ­ì–´ ì‹¤ë ¥ì„ í‚¤ì›Œë³´ì•„ìš”! (AmÃ©liorons notre corÃ©en !)</p>
        </header>

        <main class="p-4 sm:p-8">
            <!-- 1. ì´ë¦„ ì…ë ¥ í™”ë©´ -->
            <div id="welcome-screen" class="text-center active-section">
                <h2 class="text-2xl font-bold theme-text-primary mb-4">Bienvenue ! ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</h2>
                <form id="name-form">
                    <input type="text" id="student-name" placeholder="Ex: CÃ©dric" class="w-full max-w-sm mx-auto p-3 border-2 theme-border-primary rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-yellow-400" required>
                    <button type="submit" class="mt-4 w-full max-w-sm mx-auto theme-bg-secondary text-blue-900 font-bold py-3 px-6 rounded-lg text-lg hover:bg-yellow-500 transition-colors">
                        í•™ìŠµ ì‹œì‘! (Commencer)
                    </button>
                </form>
            </div>

            <!-- Ã‰tape 0: PrÃ©paration -->
            <div id="preparation-step" class="quiz-section">
                <h2 class="text-2xl font-bold theme-text-primary mb-2 text-center">Ã‰tape 0: PrÃ©paration (ì¤€ë¹„ í•™ìŠµ)</h2>
                <p class="text-slate-600 mb-6 text-center">Lisez les phrases et mÃ©morisez le vocabulaire. Vous pouvez imprimer cette liste.</p>
                <div id="preparation-list" class="space-y-4 max-h-96 overflow-y-auto p-4 bg-slate-50 rounded-lg border">
                    <!-- í•™ìŠµ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ì—­ -->
                </div>
                <div class="mt-8 flex justify-center gap-4 no-print">
                    <button onclick="printPreparationSheet()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ–¨ï¸ Imprimer cette feuille
                    </button>
                    <button onclick="switchSection('matching-game')" class="theme-bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-800 transition-colors">
                        Commencer l'exercice â†’
                    </button>
                </div>
            </div>

            <!-- Ã‰tape 1: ë‹¨ì–´ ì§ ë§ì¶”ê¸° -->
            <div id="matching-game" class="quiz-section text-center">
                <h2 class="text-2xl font-bold theme-text-primary mb-2">Ã‰tape 1: Associez les mots ! (ë‹¨ì–´ ì§ ë§ì¶”ê¸°)</h2>
                <p class="text-slate-600 mb-6">Cliquez sur un mot en franÃ§ais, puis sur sa traduction en corÃ©en.</p>
                <div id="matching-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="french-list"></div>
                    <div id="korean-list"></div>
                </div>
                <div class="mt-8 flex justify-center gap-4 no-print">
                    <button onclick="switchSection('preparation-step')" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                        â† Ã‰tape prÃ©cÃ©dente
                    </button>
                    <button onclick="initMatchingGame()" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                        ğŸ”„ MÃ©langer les cartes
                    </button>
                    <button onclick="startDictation()" class="theme-bg-primary text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-800 transition-colors">
                        Ã‰tape suivante â†’
                    </button>
                </div>
            </div>

            <!-- Ã‰tape 2: ë°›ì•„ì“°ê¸° -->
            <div id="dictation-game" class="quiz-section">
                <h2 class="text-2xl font-bold theme-text-primary mb-2 text-center">Ã‰tape 2: DictÃ©e ! (ë°›ì•„ì“°ê¸°)</h2>
                <p class="text-slate-600 mb-6 text-center">Ã‰coutez la phrase et Ã©crivez-la en corÃ©en.</p>
                <div id="dictation-container" class="space-y-6">
                    <!-- ë¬¸ì œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ì—­ -->
                </div>
                <div class="text-center mt-8 flex justify-center gap-4 no-print">
                     <button onclick="switchSection('matching-game')" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                        â† Ã‰tape prÃ©cÃ©dente
                    </button>
                    <button onclick="showResults()" class="theme-bg-secondary text-blue-900 font-bold py-3 px-8 rounded-lg hover:bg-yellow-500 transition-colors">
                        Terminer et voir les rÃ©sultats
                    </button>
                </div>
            </div>

            <!-- 4. ê²°ê³¼ í™”ë©´ -->
            <div id="results-screen" class="quiz-section text-center">
                <h2 class="text-2xl font-bold theme-text-primary mb-4">RÃ©sultats du test (í…ŒìŠ¤íŠ¸ ê²°ê³¼)</h2>
                <div id="result-message" class="mb-6 p-6 rounded-lg">
                    <!-- ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ -->
                </div>
                <div id="detailed-results" class="text-left bg-slate-50 p-4 rounded-lg">
                    <!-- ìƒì„¸ ê²°ê³¼ í‘œì‹œ -->
                </div>
                <div class="mt-8 flex flex-wrap justify-center gap-4 no-print">
                    <button onclick="sendResultsByEmail()" id="send-email-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">
                        ğŸ“§ Envoyer les rÃ©sultats par e-mail
                    </button>
                    <button onclick="printQuiz()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ–¨ï¸ Imprimer les exercices
                    </button>
                    <button onclick="location.reload()" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">
                        ğŸ”„ Recommencer
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ì¸ì‡„ìš© ì˜ì—­ -->
    <div id="printable-area"></div>


    <script>
        // --- ë°ì´í„° ì„¤ì • ---
        const matchingData = [
            { id: 1, fr: "Entendre", ko: "ë“¤ë¦¬ë‹¤" }, { id: 2, fr: "Voir", ko: "ë³´ì´ë‹¤" }, { id: 3, fr: "Oui", ko: "ë„¤" }, { id: 4, fr: "Non", ko: "ì•„ë‹ˆìš”" }, { id: 5, fr: "Comprendre", ko: "ì´í•´í•˜ë‹¤" }, { id: 6, fr: "Se souvenir", ko: "ê¸°ì–µë‚˜ë‹¤" }, { id: 7, fr: "Semaine", ko: "ì£¼" }, { id: 8, fr: "Prochain(e)", ko: "ë‹¤ìŒ" }, { id: 9, fr: "Comment", ko: "ì–´ë–»ê²Œ" }, { id: 10, fr: "CorÃ©en", ko: "í•œêµ­ì–´" }, { id: 11, fr: "FranÃ§ais", ko: "í”„ë‘ìŠ¤ì–´" }, { id: 12, fr: "Bon travail", ko: "ìˆ˜ê³ í–ˆì–´ìš”" }, { id: 13, fr: "Au revoir (l'autre reste)", ko: "ì•ˆë…•íˆ ê³„ì„¸ìš”" }, { id: 14, fr: "Au revoir (l'autre part)", ko: "ì•ˆë…•íˆ ê°€ì„¸ìš”" },
        ];
        const dictationData = [
            { id: 1, fr: "Tu mâ€™entends bien ?", ko: "ì˜ ë“¤ë ¤ìš”?", initial: "ã…ˆ ã„·ã„¹ã…‡?", hint: "entendre: ë“¤ë¦¬ë‹¤", voice: "FEMALE" }, { id: 2, fr: "Tu me vois bien ?", ko: "ì˜ ë³´ì—¬ìš”?", initial: "ã…ˆ ã…‚ã…‡ã…‡?", hint: "voir: ë³´ì´ë‹¤", voice: "MALE" }, { id: 3, fr: "Oui, je tâ€™entends bien.", ko: "ë„¤, ì˜ ë“¤ë ¤ìš”.", initial: "ã„´, ã…ˆ ã„·ã„¹ã…‡.", hint: "oui: ë„¤", voice: "FEMALE" }, { id: 4, fr: "Oui, je te vois bien.", ko: "ë„¤, ì˜ ë³´ì—¬ìš”.", initial: "ã„´, ã…ˆ ã…‚ã…‡ã…‡.", hint: "oui: ë„¤", voice: "Puck" }, { id: 5, fr: "Non, je ne tâ€™entends pas.", ko: "ì•„ë‹ˆìš”, ì•ˆ ë“¤ë ¤ìš”.", initial: "ã…‡ã„´ã…‡, ã…‡ ã„·ã„¹ã…‡.", hint: "non: ì•„ë‹ˆìš”", voice: "FEMALE" }, { id: 6, fr: "Non, je ne te vois pas.", ko: "ì•„ë‹ˆìš”, ì•ˆ ë³´ì—¬ìš”.", initial: "ã…‡ã„´ã…‡, ã…‡ ã…‚ã…‡ã…‡.", hint: "non: ì•„ë‹ˆìš”", voice: "MALE" }, { id: 7, fr: "J'ai compris.", ko: "ì´í•´í–ˆì–´ìš”.", initial: "ã…‡ã…ã…ã…‡ã…‡.", hint: "comprendre: ì´í•´í•˜ë‹¤", voice: "FEMALE" }, { id: 8, fr: "Je n'ai pas compris.", ko: "ì´í•´ ëª»í–ˆì–´ìš”.", initial: "ã…‡ã… ã…ã…ã…‡ã…‡.", hint: "ne pas pouvoir: ëª»í•˜ë‹¤", voice: "MALE" }, { id: 9, fr: "Tu peux rÃ©pÃ©ter, s'il te plaÃ®t ?", ko: "í•œë²ˆ ë” ë§í•´ì£¼ì„¸ìš”.", initial: "ã…ã…‚ ã„· ã…ã…ã…ˆã……ã…‡.", hint: "une fois de plus: í•œë²ˆ ë”", voice: "FEMALE" }, { id: 10, fr: "Je me souviens.", ko: "ê¸°ì–µë‚˜ìš”.", initial: "ã„±ã…‡ã„´ã…‡.", hint: "se souvenir: ê¸°ì–µë‚˜ë‹¤", voice: "MALE" }, { id: 11, fr: "Je ne me souviens pas.", ko: "ê¸°ì–µ ì•ˆë‚˜ìš”.", initial: "ã„±ã…‡ ã…‡ã„´ã…‡.", hint: "ne pas se souvenir: ê¸°ì–µ ì•ˆë‚˜ë‹¤", voice: "FEMALE" }, { id: 12, fr: "Comment dit-on Ã§a en corÃ©en ?", ko: "í•œêµ­ì–´ë¡œ ì–´ë–»ê²Œ ë§í•´ìš”?", initial: "ã…ã„±ã…‡ã„¹ ã…‡ã„¸ã… ã…ã…ã…‡?", hint: "comment: ì–´ë–»ê²Œ", voice: "MALE" }, { id: 13, fr: "Comment dit-on Ã§a en franÃ§ais ?", ko: "í”„ë‘ìŠ¤ì–´ë¡œ ì–´ë–»ê²Œ ë§í•´ìš”?", initial: "ã…ã„¹ã……ã…‡ã„¹ ã…‡ã„¸ã… ã…ã…ã…‡?", hint: "franÃ§ais: í”„ë‘ìŠ¤ì–´", voice: "FEMALE" }, { id: 14, fr: "Passe une bonne semaine.", ko: "ì¢‹ì€ í•œ ì£¼ ë³´ë‚´ì„¸ìš”.", initial: "ã…ˆã…‡ ã… ã…ˆ ã…‚ã„´ã……ã…‡.", hint: "semaine: ì£¼", voice: "MALE" }, { id: 15, fr: "On se voit la semaine prochaine !", ko: "ë‹¤ìŒ ì£¼ì— ë´ìš”!", initial: "ã„·ã…‡ ã…ˆã…‡ ã…‚ã…‡!", hint: "prochaine: ë‹¤ìŒ", voice: "FEMALE" }, { id: 16, fr: "Au revoir (quand l'autre reste)", ko: "ì•ˆë…•íˆ ê³„ì„¸ìš”.", initial: "ã…‡ã„´ã… ã„±ã……ã…‡.", hint: "rester: ê³„ì‹œë‹¤", voice: "MALE" }, { id: 17, fr: "Au revoir (quand l'autre part)", ko: "ì•ˆë…•íˆ ê°€ì„¸ìš”.", initial: "ã…‡ã„´ã… ã„±ã……ã…‡.", hint: "partir: ê°€ì‹œë‹¤", voice: "FEMALE" }, { id: 18, fr: "Vous avez bien travaillÃ© / Bon travail !", ko: "ìˆ˜ê³ í•˜ì…¨ì–´ìš”!", initial: "ã……ã„±ã…ã……ã…‡ã…‡!", hint: "travailler dur: ìˆ˜ê³ í•˜ë‹¤", voice: "MALE" }
        ];

        // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
        let studentName = '';
        let currentSection = 'welcome-screen';
        let selectedFrench = null;
        let selectedKorean = null;
        let correctMatches = 0;
        let userAnswers = {};
        let trackingData = {
            studentName: '',
            startTime: null, 
            endTime: null, 
            totalTimeSeconds: 0, 
            dictationDetails: {}
        };
        const audioCache = {};
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let currentRecordingId = null;


        // --- DOM ìš”ì†Œ ---
        const nameForm = document.getElementById('name-form');
        const studentNameInput = document.getElementById('student-name');

        // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.addEventListener('DOMContentLoaded', () => {
            nameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                studentName = studentNameInput.value.trim();
                if (studentName) {
                    trackingData.studentName = studentName;
                    trackingData.startTime = new Date();
                    initPreparationStep();
                    initMatchingGame();
                    switchSection('preparation-step');
                }
            });
        });

        // --- ì„¹ì…˜ ì „í™˜ í•¨ìˆ˜ ---
        function switchSection(sectionId) {
            document.getElementById(currentSection).classList.remove('active-section');
            document.getElementById(sectionId).classList.add('active-section');
            currentSection = sectionId;
        }
        
        // --- Ã‰tape 0: ì¤€ë¹„ ë‹¨ê³„ ë¡œì§ ---
        function initPreparationStep() {
            const listContainer = document.getElementById('preparation-list');
            listContainer.innerHTML = '';
            let contentHTML = '';
            dictationData.forEach((item, index) => {
                contentHTML += `
                    <div class="p-3 border-b">
                        <p class="font-semibold text-slate-800">${index + 1}. ${item.fr}</p>
                        <p class="text-lg text-blue-700">${item.ko}</p>
                        <p class="text-sm text-slate-500 mt-1">Vocabulaire: ${item.hint}</p>
                    </div>`;
            });
            listContainer.innerHTML = contentHTML;
        }

        function printPreparationSheet() {
            const printableArea = document.getElementById('printable-area');
            let html = `<h1 style="font-family: sans-serif; color: #0033a0; text-align: center;">Fiche de PrÃ©paration pour ${studentName}</h1>`;
            html += `<div style="font-family: sans-serif; margin-top: 20px;">`;
            dictationData.forEach((item, index) => {
                html += `
                    <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <p style="font-size: 16px;"><strong>${index + 1}. ${item.fr}</strong></p>
                        <p style="font-size: 18px; color: #0033a0;">${item.ko}</p>
                        <p style="font-size: 14px; color: #555;"><em>Vocabulaire:</em> ${item.hint}</p>
                    </div>`;
            });
            html += `</div>`;
            printableArea.innerHTML = html;
            window.print();
        }

        // --- ì§ ë§ì¶”ê¸° ê²Œì„ ë¡œì§ ---
        function initMatchingGame() {
            const frenchList = document.getElementById('french-list');
            const koreanList = document.getElementById('korean-list');
            frenchList.innerHTML = '';
            koreanList.innerHTML = '';
            correctMatches = 0;
            selectedFrench = null;
            selectedKorean = null;
            const shuffledFrench = [...matchingData].sort(() => Math.random() - 0.5);
            const shuffledKorean = [...matchingData].sort(() => Math.random() - 0.5);
            shuffledFrench.forEach(item => {
                const frCard = createCard(item.fr, 'fr', item.id);
                frCard.addEventListener('click', () => selectCard(frCard, 'fr', item.id));
                frenchList.appendChild(frCard);
            });
            shuffledKorean.forEach(item => {
                const koCard = createCard(item.ko, 'ko', item.id);
                koCard.addEventListener('click', () => selectCard(koCard, 'ko', item.id));
                koreanList.appendChild(koCard);
            });
        }
        function createCard(text, type, id) {
            const card = document.createElement('div');
            card.className = 'card p-4 border-2 theme-border-primary rounded-lg bg-white text-lg';
            card.textContent = text;
            card.dataset.type = type;
            card.dataset.id = id;
            return card;
        }
        function selectCard(card, type, id) {
            if (card.classList.contains('correct-match')) return;
            if (type === 'fr') {
                if (selectedFrench) selectedFrench.classList.remove('selected');
                selectedFrench = card;
                card.classList.add('selected');
            } else {
                if (selectedKorean) selectedKorean.classList.remove('selected');
                selectedKorean = card;
                card.classList.add('selected');
            }
            if (selectedFrench && selectedKorean) checkMatch();
        }
        function checkMatch() {
            const isMatch = selectedFrench.dataset.id === selectedKorean.dataset.id;
            if (isMatch) {
                selectedFrench.classList.add('correct-match');
                selectedKorean.classList.add('correct-match');
                selectedFrench.classList.remove('selected');
                selectedKorean.classList.remove('selected');
                correctMatches++;
            } else {
                selectedFrench.classList.add('incorrect-match');
                selectedKorean.classList.add('incorrect-match');
                setTimeout(() => {
                    selectedFrench.classList.remove('incorrect-match', 'selected');
                    selectedKorean.classList.remove('incorrect-match', 'selected');
                }, 500);
            }
            selectedFrench = null;
            selectedKorean = null;
            if (correctMatches === matchingData.length) {
                setTimeout(() => alert('Bravo ! Vous avez trouvÃ© tous les mots ! On passe Ã  la dictÃ©e.'), 300);
            }
        }
        
        // --- ë°›ì•„ì“°ê¸° ê²Œì„ ë¡œì§ ---
        function startDictation() {
            initDictationGame();
            switchSection('dictation-game');
        }
        function initDictationGame() {
            const container = document.getElementById('dictation-container');
            container.innerHTML = '';
            dictationData.forEach((item, index) => {
                if (!trackingData.dictationDetails[item.id]) {
                    trackingData.dictationDetails[item.id] = { 
                        question: item.ko, 
                        plays: 0, 
                        mistakeCount: 0, 
                        recording: { base64: null, duration: 0, sentence: item.ko }
                    };
                }
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-5 border-2 theme-border-primary rounded-lg bg-slate-50';
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold mb-3 text-slate-700">${index + 1}. ${item.fr}</p>
                    <div class="flex items-center gap-4 flex-wrap">
                        <button onclick="playAudio('${item.ko}', ${item.id}, '${item.voice}')" class="theme-bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-800 transition-colors">ğŸ”Š Ã‰couter</button>
                        <input type="text" id="answer-${item.id}" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-yellow-400 focus:outline-none" placeholder="Ã‰crivez en corÃ©en ici...">
                    </div>
                    <div class="mt-3 flex gap-2 flex-wrap">
                        <button onclick="showHint('hint-initial-${item.id}')" class="text-sm bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300">ğŸ’¡ Indice 1 (ì´ˆì„±)</button>
                        <button onclick="showHint('hint-word-${item.id}')" class="text-sm bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300">ğŸ’¡ Indice 2 (Mot-clÃ©)</button>
                        <button id="record-btn-${item.id}" onclick="toggleRecording(${item.id})" class="text-sm bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">ğŸ¤ Enregistrer</button>
                        <p id="record-status-${item.id}" class="text-sm text-slate-600 self-center"></p>
                    </div>
                    <p id="hint-initial-${item.id}" class="hidden mt-2 text-blue-600">${item.initial}</p>
                    <p id="hint-word-${item.id}" class="hidden mt-2 text-blue-600">${item.hint}</p>`;
                
                const input = questionDiv.querySelector(`#answer-${item.id}`);
                input.addEventListener('change', () => {
                    const userAnswer = input.value.trim().replace(/[.,!?]/g, '');
                    const correctAnswer = item.ko.replace(/[.,!?]/g, '');
                    if (userAnswer && userAnswer !== correctAnswer) {
                        trackingData.dictationDetails[item.id].mistakeCount++;
                    }
                });

                container.appendChild(questionDiv);
            });
        }

        // --- ì˜¤ë””ì˜¤ ì¬ìƒ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            return new Blob([view, pcm16], { type: 'audio/wav' });
        }

        async function playAudio(text, id, voice) {
            trackingData.dictationDetails[id].plays++;
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ğŸ”Š Chargement...';

            if (audioCache[text]) {
                const audio = new Audio(audioCache[text]);
                audio.play();
                audio.onended = () => {
                    button.disabled = false;
                    button.textContent = 'ğŸ”Š Ã‰couter';
                };
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, voice: voice })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(`Erreur du serveur (${response.status}): ${errorData.error || 'Erreur inconnue'}`);
                }
                
                const result = await response.json();
                const audioData = result?.audioData;
                const mimeType = result?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioCache[text] = audioUrl;

                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    console.error("RÃ©ponse invalide du serveur:", result);
                    throw new Error("Les donnÃ©es audio (audioData) ou le type MIME (mimeType) n'ont pas Ã©tÃ© trouvÃ©s dans la rÃ©ponse.");
                }
            } catch (error) {
                console.error("Erreur de lecture audio:", error);
                alert("DÃ©solÃ©, impossible de jouer l'audio. " + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'ğŸ”Š Ã‰couter';
            }
        }

        // --- ë…¹ìŒ ê¸°ëŠ¥ ---
        async function toggleRecording(id) {
            const recordBtn = document.getElementById(`record-btn-${id}`);
            const statusEl = document.getElementById(`record-status-${id}`);

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordBtn.textContent = 'ğŸ¤ Enregistrer';
                statusEl.textContent = 'Traitement...';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    currentRecordingId = id;

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64String = reader.result.split(',')[1];
                            const duration = Math.round((new Date() - recordingStartTime) / 1000);
                            trackingData.dictationDetails[id].recording.base64 = base64String;
                            trackingData.dictationDetails[id].recording.duration = duration;
                            statusEl.textContent = `EnregistrÃ© (${duration}s) ğŸ‘`;
                        };
                        stream.getTracks().forEach(track => track.stop()); // Stop microphone access
                    };
                    
                    recordingStartTime = new Date();
                    mediaRecorder.start();
                    recordBtn.textContent = 'â–  ArrÃªter';
                    statusEl.textContent = 'Enregistrement...';

                } catch (err) {
                    console.error("Erreur d'enregistrement:", err);
                    statusEl.textContent = "AccÃ¨s micro refusÃ©.";
                    alert("L'accÃ¨s au microphone est nÃ©cessaire pour enregistrer.");
                }
            }
        }


        function showHint(hintId) {
            document.getElementById(hintId).classList.toggle('hidden');
        }

        // --- ê²°ê³¼ ì²˜ë¦¬ ë¡œì§ ---
        function showResults() {
            trackingData.endTime = new Date();
            trackingData.totalTimeSeconds = Math.round((trackingData.endTime - trackingData.startTime) / 1000);
            let score = 0;
            let detailedResultsHTML = '<h3 class="text-xl font-bold mb-3 theme-text-primary">Correction dÃ©taillÃ©e de la dictÃ©e</h3><ul class="space-y-3">';
            
            dictationData.forEach(item => {
                const userAnswer = document.getElementById(`answer-${item.id}`).value.trim().replace(/[.,!?]/g, '');
                const correctAnswer = item.ko.replace(/[.,!?]/g, '');
                userAnswers[item.id] = userAnswer;
                
                const isCorrect = userAnswer === correctAnswer;
                if (isCorrect) {
                    score++;
                }

                detailedResultsHTML += `
                    <li class="${isCorrect ? 'text-green-700' : 'text-red-700'}">
                        <strong>${item.fr}</strong><br>
                        ${isCorrect ? `âœ”ï¸ Votre rÃ©ponse : ${userAnswer || "<i>(vide)</i>"}` : `âŒ Votre rÃ©ponse : <span class="line-through">${userAnswer || "<i>(vide)</i>"}</span><br>RÃ©ponse correcte : <strong class="text-black">${item.ko}</strong>`}<br>
                        <small class="text-slate-500">Ã‰coutÃ© ${trackingData.dictationDetails[item.id].plays} fois, ${trackingData.dictationDetails[item.id].mistakeCount} erreur(s)</small>
                    </li>`;
            });
            detailedResultsHTML += '</ul>';

            const percentage = Math.round((score / dictationData.length) * 100);
            const resultMessage = document.getElementById('result-message');
            let messageHTML = '';
            if (percentage === 100) {
                messageHTML = `<div class="bg-green-100 border-l-4 border-green-500 p-4"><p class="icon">ğŸ‘‘ğŸ‰ğŸ‘</p><h3 class="text-2xl font-bold text-green-800">ì™„ë²½í•´ìš”!! (Parfait !!)</h3></div>`;
                confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
            } else if (percentage >= 80) {
                messageHTML = `<div class="bg-blue-100 border-l-4 border-blue-500 p-4"><p class="icon">ğŸ‰ğŸ‘</p><h3 class="text-2xl font-bold text-blue-800">ì˜í–ˆì–´ìš”!! (Bien jouÃ© !!)</h3></div>`;
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else if (percentage >= 60) {
                messageHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 p-4"><p class="icon">ğŸ‘</p><h3 class="text-2xl font-bold text-yellow-800">ì´í•´ í•  ìˆ˜ ìˆì–´ìš”. ê½¤ ì˜í–ˆì–´ìš”. (C'est comprÃ©hensible. Assez bien.)</h3></div>`;
            } else {
                messageHTML = `<div class="bg-red-100 border-l-4 border-red-500 p-4"><p class="icon">ğŸ˜­</p><h3 class="text-2xl font-bold text-red-800">ë•¡!! í‹€ë ¸ì–´ìš”!! (Bip !! Incorrect !!)</h3></div>`;
            }
            resultMessage.innerHTML = messageHTML;
            document.getElementById('detailed-results').innerHTML = detailedResultsHTML;
            switchSection('results-screen');
        }

        // --- ì´ë©”ì¼ ë° ì¸ì‡„ ê¸°ëŠ¥ ---
        async function sendResultsByEmail() {
            const btn = document.getElementById('send-email-btn');
            btn.disabled = true;
            btn.textContent = 'Envoi en cours...';
            try {
                // trackingData ê°ì²´ ì „ì²´ë¥¼ ì „ì†¡
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(trackingData)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Une erreur est survenue.');
                }
                const result = await response.json();
                alert(result.message || 'RÃ©sultats envoyÃ©s avec succÃ¨s !');
                btn.textContent = 'âœ… EnvoyÃ© !';
            } catch (error) {
                console.error("Erreur lors de l'envoi de l'e-mail:", error);
                alert("Une erreur s'est produite lors de l'envoi des rÃ©sultats. " + error.message);
                btn.disabled = false;
                btn.textContent = 'ğŸ“§ Envoyer les rÃ©sultats par e-mail';
            }
        }

        function printQuiz() {
            const printableArea = document.getElementById('printable-area');
            let html = `<h1 style="font-family: sans-serif; color: #0033a0; text-align: center;">Exercices de CorÃ©en pour ${studentName}</h1>`;
            html += `<h2 style="font-family: sans-serif; color: #0033a0; margin-top: 30px;">Fiche de RÃ©vision - Phrases ComplÃ¨tes</h2>`;
            html += `<div style="font-family: sans-serif; margin-top: 10px;">`;
            dictationData.forEach((item, index) => {
                html += `
                    <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                        <p style="font-size: 16px;"><strong>${index + 1}. ${item.fr}</strong></p>
                        <p style="font-size: 18px; color: #0033a0;">${item.ko}</p>
                    </div>`;
            });
            html += `</div>`;
            html += `<h2 style="font-family: sans-serif; color: #0033a0; margin-top: 30px; page-break-before: always;">Vocabulaire</h2>`;
            html += `<table style="width: 100%; border-collapse: collapse; font-family: sans-serif;"><thead><tr style="background-color: #f0f4f8;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">FranÃ§ais</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">CorÃ©en</th></tr></thead><tbody>`;
            matchingData.forEach(item => {
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${item.fr}</td><td style="padding: 8px; border: 1px solid #ddd;">${item.ko}</td></tr>`;
            });
            html += `</tbody></table>`;
            if (Object.keys(userAnswers).length > 0) {
                html += `<h2 style="font-family: sans-serif; color: #0033a0; margin-top: 30px; page-break-before: always;">RÃ©sultats de la DictÃ©e</h2>`;
                html += `<div style="font-family: sans-serif; margin-top: 10px;">`;
                dictationData.forEach((item, index) => {
                    const userAnswer = userAnswers[item.id] || "<i>(Pas de rÃ©ponse)</i>";
                    const isCorrect = userAnswer.replace(/[.,!?]/g, '') === item.ko.replace(/[.,!?]/g, '');
                    html += `
                        <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background-color: ${isCorrect ? '#f0fff0' : '#fff0f0'};">
                            <p><strong>Question ${index + 1}:</strong> ${item.fr}</p>
                            <p><strong>RÃ©ponse correcte:</strong> ${item.ko}</p>
                            <p style="color: ${isCorrect ? 'green' : 'red'};"><strong>Votre rÃ©ponse:</strong> ${userAnswer}</p>
                        </div>`;
                });
                html += `</div>`;
            }
            printableArea.innerHTML = html;
            window.print();
        }

    </script>
</body>
</html>
