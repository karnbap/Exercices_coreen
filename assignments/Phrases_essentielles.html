<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ë“£ê¸° ì—°ìŠµ â€“ 08/08/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- EmailJS SDK -->
    <script src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>

    <style>
      /* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- í•™ìƒ ì •ë³´ ì…ë ¥ -->
        <div id="student-gate" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-2xl font-bold text-blue-600 mb-4">
                ë“£ê¸° í‰ê°€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!
            </h1>
            <p class="text-slate-600 mb-6">
                ì´ë¦„ì´ë‚˜ í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
            <input type="text" id="student-id-input"
                   class="w-full max-w-sm mx-auto p-3 border-2 border-slate-300 rounded-lg text-center"
                   placeholder="ì˜ˆ: CÃ©dou">
            <button onclick="startTest()"
                    class="mt-6 w-full max-w-sm mx-auto btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                í…ŒìŠ¤íŠ¸ ì‹œì‘!
            </button>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì½˜í…ì¸  -->
        <div id="test-content" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">í•œêµ­ì–´ ë“£ê³  ë°›ì•„ì“°ê¸° âœï¸</h1>
                <p class="text-slate-500 mt-2">08/08/2025</p>
            </header>

            <div class="flex justify-center gap-4 mb-8">
                <button onclick="window.print()"
                        class="btn btn-action flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-print"></i> ì¸ì‡„í•˜ê¸°
                </button>
                <button onclick="finishTest()"
                        class="btn bg-red-500 hover:bg-red-600 text-white flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-paper-plane"></i> ëë‚´ê¸°
                </button>
            </div>

            <main id="tasks-list" class="space-y-6"></main>

            <div id="final-message" class="hidden mt-8 bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg text-center"></div>
        </div>
    </div>

    <script>
    // ------------ EmailJS ì´ˆê¸°í™” ------------
    (function(){
      emailjs.init('YOUR_EMAILJS_USER_ID'); // â† EmailJS ëŒ€ì‹œë³´ë“œì—ì„œ ë°œê¸‰ëœ user ID
    })();

    // ------------ ë°ì´í„° & ì§ˆë¬¸ ëª©ë¡ ------------
    let studentData = { studentId: null, startTime: null, endTime: null, questions: [] };
    let testStarted = false;
    const teacherEmail = "votre.email@professeur.fr";

    const questions = [
      /* ê¸°ì¡´ ì§ˆë¬¸ ë°°ì—´ ê·¸ëŒ€ë¡œ ì‚¬ìš© */
      { id: 1, korean: "ì˜ ë“¤ë ¤ìš”?", french: "Tu mâ€™entends bien ?", voice: "female" },
      /* ... ì´ 18ê°œ ... */
    ];

    // í™”ë©´ì— ë¬¸ì œë“¤ ë Œë”ë§
    const tasksList = document.getElementById('tasks-list');
    questions.forEach(q => {
      studentData.questions.push({ id: q.id, playCount: 0, wrongAttempts: 0 });
      const div = document.createElement('div');
      div.className = 'task-container bg-white p-5 rounded-xl border border-slate-200';
      div.id = `task-${q.id}`;
      div.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold text-slate-700">Exercice ${q.id}</h2>
          <button onclick="playAudio(${q.id})"
                  class="btn btn-audio w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-md">
            <i class="fas fa-play"></i>
          </button>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block mb-1 font-semibold">í•œêµ­ì–´ ë‹µ</label>
            <input type="text" id="korean-input-${q.id}" oninput="checkAndStartTimer()"
                   class="w-full p-3 border-2 rounded-lg" placeholder="ì—¬ê¸°ì— ì…ë ¥...">
          </div>
          <div>
            <label class="block mb-1 font-semibold">í”„ë‘ìŠ¤ì–´ ë²ˆì—­</label>
            <input type="text" id="french-input-${q.id}" oninput="checkAndStartTimer()"
                   class="w-full p-3 border-2 rounded-lg" placeholder="Ã‰crivez ici...">
          </div>
        </div>
        <div class="flex gap-3 mt-4">
          <button onclick="checkAnswer(${q.id})"
                  class="btn btn-check py-2 px-4 rounded-lg font-bold">
            <i class="fas fa-check mr-2"></i>ì •ë‹µ í™•ì¸
          </button>
        </div>
        <div id="result-box-${q.id}" class="mt-4 p-4 rounded-lg hidden"></div>
      `;
      tasksList.appendChild(div);
    });

    // ------------ íƒ€ì´ë¨¸ ì‹œì‘ ------------
    function checkAndStartTimer(){
      if (!testStarted) {
        studentData.startTime = new Date();
        testStarted = true;
      }
    }

    // ------------ Audio ì¬ìƒ ------------
    let currentAudio = null;
    async function playAudio(id) {
      checkAndStartTimer();
      const stat = studentData.questions.find(x=>x.id===id);
      stat.playCount++;

      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      try {
        const question = questions.find(x=>x.id===id);
        const res = await fetch(`/.netlify/functions/generate-audio`, {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: question.korean, voice: question.voice })
        });
        if (!res.ok) throw new Error(res.statusText);
        const buffer = await res.arrayBuffer();
        const blob = new Blob([buffer], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        await currentAudio.play();
      } catch(e) {
        console.error(e);
        alert("ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨");
      }
    }

    // ------------ ì •ë‹µ í™•ì¸ ------------
    function checkAnswer(id) {
      checkAndStartTimer();
      const q = questions.find(x=>x.id===id);
      const korIn = document.getElementById(`korean-input-${id}`).value.trim();
      const frIn  = document.getElementById(`french-input-${id}`).value.trim();
      const korOk = korIn.replace(/[\.\?\!,]/g,'') === q.korean.replace(/[\.\?\!,]/g,'');
      const frOk  = frIn.toLowerCase().replace(/[\.\?\!',]/g,'') === q.french.toLowerCase().replace(/[\.\?\!',]/g,'');
      if (!(korOk && frOk)) {
        studentData.questions.find(x=>x.id===id).wrongAttempts++;
      }
      const box = document.getElementById(`result-box-${id}`);
      if (korOk && frOk) {
        box.className = 'mt-4 p-4 rounded-lg bg-green-100 border-l-4 border-green-500 text-green-700';
        box.innerHTML = `ì •ë‹µì…ë‹ˆë‹¤!<br>ğŸ‡°ğŸ‡· ${q.korean}<br>ğŸ‡«ğŸ‡· ${q.french}`;
      } else {
        box.className = 'mt-4 p-4 rounded-lg bg-red-100 border-l-4 border-red-500 text-red-700';
        box.innerHTML = `í‹€ë ¸ìŠµë‹ˆë‹¤!<br>
                         ğŸ‡°ğŸ‡· ë‹¹ì‹ : ${korIn || '(ë¯¸ì…ë ¥)'}<br>ì •ë‹µ: ${q.korean}<br>
                         ğŸ‡«ğŸ‡· ë‹¹ì‹ : ${frIn || '(ë¯¸ì…ë ¥)'}<br>ì •ë‹µ: ${q.french}`;
      }
      box.classList.remove('hidden');
    }

    // ------------ ì¢…ë£Œ & ê²°ê³¼ ì „ì†¡ ------------
    function finishTest() {
      if (!testStarted) return alert("í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì‹œì‘í•˜ì„¸ìš”!");
      studentData.endTime = new Date();
      const duration = Math.round((studentData.endTime - studentData.startTime)/60000);

      // 1) í•™ìƒì—ê²Œ ê²°ê³¼ ë³´ì—¬ì£¼ê¸°
      let html = `<h2 class="font-bold text-xl mb-4">í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
                  <p>í•™ë²ˆ/ì´ë¦„: <strong>${studentData.studentId}</strong></p>
                  <p>ì†Œìš” ì‹œê°„: <strong>${duration}ë¶„</strong></p>
                  <hr class="my-4">
                  <table class="w-full text-left">
                    <thead><tr><th>ë¬¸ì œ</th><th>ë“¤ì€ íšŸìˆ˜</th><th>í‹€ë¦° íšŸìˆ˜</th></tr></thead>
                    <tbody>`;
      studentData.questions.forEach(s=> {
        html += `<tr>
                   <td>${s.id}</td>
                   <td>${s.playCount}</td>
                   <td>${s.wrongAttempts}</td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      const fm = document.getElementById('final-message');
      fm.innerHTML = html;
      fm.classList.remove('hidden');

      // 2) EmailJSë¡œ ì„ ìƒë‹˜ê»˜ ì „ì†¡
      const templateParams = {
        teacher_email: teacherEmail,
        student_id:    studentData.studentId,
        date:          new Date().toLocaleDateString('fr-FR'),
        duration:      `${duration}ë¶„`,
        details:       JSON.stringify(studentData.questions)
      };
      emailjs.send('YOUR_SERVICE_ID','YOUR_TEMPLATE_ID', templateParams)
        .then(_=> console.log('Email sent'))
        .catch(err=> console.error('EmailJS error:', err));
    }
    </script>
</body>
</html>
