<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국어 듣기 연습 (Exercice d'écoute coréen) - 08/08/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }
        .task-container {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .hint {
            background-color: #e0f2fe;
            border-left: 4px solid #38bdf8;
            color: #0c4a6e;
        }
        .correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #4ade80;
            color: #166534;
        }
        .wrong-answer {
            background-color: #fee2e2;
            border-left: 4px solid #f87171;
            color: #991b1b;
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-audio { background-color: #60a5fa; color: white; }
        .btn-hint { background-color: #fbbf24; color: #422006; }
        .btn-check { background-color: #34d399; color: white; }
        .btn-action { background-color: #a78bfa; color: white; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            animation: confetti-fall 3s linear forwards;
            top: -20px;
        }
        @keyframes confetti-fall {
            from { transform: translateY(0) rotate(0deg); }
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* 인쇄용 스타일 */
        @media print {
            body {
                background-color: white;
                font-size: 12pt;
            }
            #student-gate, .btn, #action-buttons, .hint, .result-box, #french-input-container, #final-message {
                display: none !important;
            }
            .task-container {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            .korean-input-print {
                border-bottom: 1px solid #000 !important;
                border: none;
                height: 2em;
            }
            header h1 {
                font-size: 18pt;
            }
            header p, h2 {
                font-size: 14pt;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- 학생 정보 입력 섹션 -->
        <div id="student-gate" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-2xl font-bold text-blue-600 mb-4">듣기 평가에 오신 것을 환영합니다! / Bienvenue au test d'écoute !</h1>
            <p class="text-slate-600 mb-6">시작하기 전에 이름이나 학번을 입력해주세요. / Veuillez entrer votre nom ou votre numéro d'étudiant avant de commencer.</p>
            <input type="text" id="student-id-input" class="w-full max-w-sm mx-auto p-3 border-2 border-slate-300 rounded-lg text-center" placeholder="예: Cédou">
            <button onclick="startTest()" class="mt-6 w-full max-w-sm mx-auto btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                테스트 시작! / Commencer le test !
            </button>
        </div>

        <!-- 테스트 콘텐츠 (초기에는 숨김) -->
        <div id="test-content" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">한국어 듣고 받아쓰기 ✍️</h1>
                <p class="text-slate-500 mt-2">Exercice d'écoute et de dictée en coréen (08/08/2025)</p>
            </header>

            <!-- 컨트롤 버튼 (인쇄, 종료) -->
            <div id="action-buttons" class="flex justify-center gap-4 mb-8">
                 <button onclick="window.print()" class="btn btn-action flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-print"></i> 인쇄하기 / Imprimer
                </button>
                <button onclick="finishTest()" class="btn bg-red-500 hover:bg-red-600 text-white flex items-center gap-2 py-2 px-4 rounded-lg">
                    <i class="fas fa-paper-plane"></i> 끝내고 결과 보내기 / Terminer et envoyer
                </button>
            </div>

            <main id="tasks-list" class="space-y-6">
                <!-- Les exercices seront injectés ici par JavaScript -->
            </main>

            <div id="final-message" class="hidden mt-8 bg-green-100 border-l-4 border-green-500 text-green-700 p-6 rounded-lg text-center">
                <h2 class="font-bold text-2xl">수고하셨습니다! / Excellent travail ! 🥳</h2>
                <p class="mt-2">테스트 결과가 선생님께 발송되도록 이메일 앱이 열릴 거예요. '보내기' 버튼을 눌러주세요! / Votre application de messagerie va s'ouvrir. Veuillez cliquer sur 'Envoyer' !</p>
            </div>
        </div>
    </div>

    <script>
        // --- 학생 데이터 추적을 위한 설정 ---
        let studentData = {
            studentId: null,
            startTime: null,
            endTime: null,
            questions: []
        };
        let testStarted = false;
        const teacherEmail = "votre.email@professeur.fr"; // 여기에 선생님 이메일 주소를 입력하세요.

        const questions = [
            { id: 1, korean: "잘 들려요?", french: "Tu m’entends bien ?", initials: "ㅈ ㄷㄹㅇ?", hint: "들리다: être entendu", voice: "female" },
            { id: 2, korean: "잘 보여요?", french: "Tu me vois bien ?", initials: "ㅈ ㅂㅇㅇ?", hint: "보이다: être vu", voice: "male" },
            { id: 3, korean: "네, 잘 들려요.", french: "Oui, je t’entends bien.", initials: "ㄴ, ㅈ ㄷㄹㅇ.", hint: "네: oui", voice: "female" },
            { id: 4, korean: "네, 잘 보여요.", french: "Oui, je te vois bien.", initials: "ㄴ, ㅈ ㅂㅇㅇ.", hint: "네: oui", voice: "male" },
            { id: 5, korean: "잘 들리고 잘 보여요?", french: "Tu m'entends bien et tu me vois bien ?", initials: "ㅈ ㄷㄹㄱ ㅈ ㅂㅇㅇ?", hint: "그리고: et", voice: "female" },
            { id: 6, korean: "아니요, 안 들려요.", french: "Non, je ne t’entends pas.", initials: "ㅇㄴㅇ, ㅇ ㄷㄹㅇ.", hint: "아니요: non", voice: "male" },
            { id: 7, korean: "아니요, 안 보여요.", french: "Non, je ne te vois pas.", initials: "ㅇㄴㅇ, ㅇ ㅂㅇㅇ.", hint: "아니요: non", voice: "female" },
            { id: 8, korean: "이해했어요.", french: "J'ai compris.", initials: "ㅇㅎㅎㅇㅇ.", hint: "이해하다: comprendre", voice: "male" },
            { id: 9, korean: "이해 못했어요.", french: "Je n'ai pas compris.", initials: "ㅇㅎ ㅁㅎㅇㅇ.", hint: "못: ne pas pouvoir", voice: "female" },
            { id: 10, korean: "한번 더 말해주세요.", french: "Pouvez-vous répéter, s'il vous plaît ?", initials: "ㅎㅂ ㄷ ㅁㅎㅈㅅㅇ.", hint: "한번 더: encore une fois", voice: "male" },
            { id: 11, korean: "기억나요.", french: "Je me souviens.", initials: "ㄱㅇㄴㅇ.", hint: "기억나다: se souvenir", voice: "female" },
            { id: 12, korean: "기억 안나요.", french: "Je ne me souviens pas.", initials: "ㄱㅇ ㅇㄴㅇ.", hint: "안: particule de négation", voice: "male" },
            { id: 13, korean: "한국어로 어떻게 말해요?", french: "Comment on dit ça en coréen ?", initials: "ㅎㄱㅇㄹ ㅇㄸㅎ ㅁㅎㅇ?", hint: "어떻게: comment", voice: "female" },
            { id: 14, korean: "프랑스어로 어떻게 말해요?", french: "Comment on dit ça en français ?", initials: "ㅍㄹㅅㅇㄹ ㅇㄸㅎ ㅁㅎㅇ?", hint: "프랑스어: français", voice: "male" },
            { id: 15, korean: "좋은 한 주 보내세요.", french: "Passez une bonne semaine.", initials: "ㅈㅇ ㅎ ㅈ ㅂㄴㅅㅇ.", hint: "보내다: passer, envoyer", voice: "female" },
            { id: 16, korean: "다음 주에 봐요.", french: "On se voit la semaine prochaine !", initials: "ㄷㅇ ㅈㅇ ㅂㅇ.", hint: "다음 주: la semaine prochaine", voice: "male" },
            { id: 17, korean: "안녕히 계세요.", french: "Au revoir (quand l'autre reste)", initials: "ㅇㄴㅎ ㄱㅅㅇ.", hint: "계시다: rester (honorifique)", voice: "female" },
            { id: 18, korean: "안녕히 가세요.", french: "Au revoir (quand l'autre part)", initials: "ㅇㄴㅎ ㄱㅅㅇ.", hint: "가시다: partir (honorifique)", voice: "male" }
        ];

        // --- 테스트 시작 및 데이터 초기화 ---
        function startTest() {
            const studentId = document.getElementById('student-id-input').value;
            if (!studentId.trim()) {
                alert("이름이나 학번을 입력해주세요! / Veuillez entrer votre nom ou votre numéro d'étudiant !");
                return;
            }
            studentData.studentId = studentId.trim();

            questions.forEach(q => {
                studentData.questions.push({
                    id: q.id,
                    playCount: 0,
                    wrongAttempts: 0
                });
            });

            document.getElementById('student-gate').classList.add('hidden');
            document.getElementById('test-content').classList.remove('hidden');
        }
        
        function checkAndStartTimer() {
            if (studentData.studentId && !testStarted) {
                studentData.startTime = new Date();
                testStarted = true;
            }
        }

        const tasksList = document.getElementById('tasks-list');
        questions.forEach(q => {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-container bg-white p-5 rounded-xl border border-slate-200';
            taskElement.id = `task-${q.id}`;
            taskElement.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-slate-700">Exercice ${q.id}</h2>
                    <div class="flex items-center gap-2">
                        <div id="loader-${q.id}" class="loader"></div>
                        <button onclick="playAudio(${q.id})" class="btn btn-audio w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-md">
                            <i class="fas fa-play"></i>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="korean-input-${q.id}" class="block mb-1 font-semibold text-slate-600">Réponse en coréen (한국어 답)</label>
                        <input type="text" id="korean-input-${q.id}" oninput="checkAndStartTimer()" class="w-full p-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition korean-input-print" placeholder="여기에 입력하세요... / Écrivez ici...">
                    </div>
                    <div id="french-input-container">
                        <label for="french-input-${q.id}" class="block mb-1 font-semibold text-slate-600">Traduction en français (프랑스어 번역)</label>
                        <input type="text" id="french-input-${q.id}" oninput="checkAndStartTimer()" class="w-full p-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" placeholder="Écrivez ici...">
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mt-4">
                    <button onclick="showHint(${q.id}, 'initials')" class="btn btn-hint flex-grow sm:flex-grow-0 py-2 px-4 rounded-lg shadow-sm"><i class="far fa-lightbulb mr-2"></i>Indice 1 (초성)</button>
                    <button onclick="showHint(${q.id}, 'hint')" class="btn btn-hint flex-grow sm:flex-grow-0 py-2 px-4 rounded-lg shadow-sm"><i class="far fa-lightbulb mr-2"></i>Indice 2 (단어 뜻)</button>
                    <button onclick="checkAnswer(${q.id})" class="btn btn-check flex-grow sm:flex-grow-0 py-2 px-4 rounded-lg shadow-sm font-bold"><i class="fas fa-check mr-2"></i>정답 확인 / Vérifier</button>
                </div>
                <div id="hint-box-${q.id}" class="mt-4 p-3 rounded-lg hint hidden"></div>
                <div id="result-box-${q.id}" class="mt-4 p-4 rounded-lg hidden"></div>
            `;
            tasksList.appendChild(taskElement);
        });
        
        let currentAudio = null;
        async function playAudio(id) {
            checkAndStartTimer();
            const stat = studentData.questions.find(q => q.id === id);
            if (stat) stat.playCount++;

            const question = questions.find(q => q.id === id);
            const loader = document.getElementById(`loader-${id}`);
            const buttonIcon = document.querySelector(`#task-${id} .btn-audio i`);
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                document.querySelectorAll('.btn-audio i').forEach(icon => icon.className = 'fas fa-play');
            }
            loader.style.display = 'block';
            buttonIcon.style.display = 'none';
            try {
                const response = await fetch(`/.netlify/functions/generate-audio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: question.korean, voice: question.voice })
                });
                if (!response.ok) throw new Error(`Audio generation failed: ${response.statusText}`);
                const data = await response.json();
                const audioBlob = new Blob([new Uint8Array(atob(data.audioContent).split("").map(char => char.charCodeAt(0)))], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);
                currentAudio.play();
                buttonIcon.className = 'fas fa-pause';
                currentAudio.onended = () => { buttonIcon.className = 'fas fa-play'; };
            } catch (error) {
                console.error('Error playing audio:', error);
                alert("음성 재생 중 오류가 발생했습니다. / Désolé, une erreur s'est produite lors de la lecture du son.");
                buttonIcon.className = 'fas fa-play';
            } finally {
                loader.style.display = 'none';
                if(buttonIcon.className !== 'fas fa-pause') buttonIcon.style.display = 'block';
                currentAudio.addEventListener('play', () => {
                    buttonIcon.className = 'fas fa-pause';
                    buttonIcon.style.display = 'block';
                    loader.style.display = 'none';
                });
                currentAudio.addEventListener('pause', () => { buttonIcon.className = 'fas fa-play'; });
            }
        }

        function showHint(id, type) {
            checkAndStartTimer();
            const question = questions.find(q => q.id === id);
            const hintBox = document.getElementById(`hint-box-${id}`);
            if (type === 'initials') {
                hintBox.innerHTML = `<strong>💡 Indice 1 (초성):</strong> ${question.initials}`;
            } else {
                hintBox.innerHTML = `<strong>💡 Indice 2 (단어 뜻 / Mot-clé):</strong> ${question.hint}`;
            }
            hintBox.classList.remove('hidden');
        }
        
        function launchConfetti() {
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#c084fc'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function checkAnswer(id) {
            checkAndStartTimer();
            const question = questions.find(q => q.id === id);
            const koreanInput = document.getElementById(`korean-input-${id}`).value.trim();
            const frenchInput = document.getElementById(`french-input-${id}`).value.trim();
            const resultBox = document.getElementById(`result-box-${id}`);
            const cleanKoreanAnswer = question.korean.replace(/[.?!,]/g, '');
            const cleanKoreanInput = koreanInput.replace(/[.?!,]/g, '');
            const cleanFrenchAnswer = question.french.toLowerCase().replace(/[.?!,']/g, '');
            const cleanFrenchInput = frenchInput.toLowerCase().replace(/[.?!,']/g, '');
            let koreanCorrect = cleanKoreanInput === cleanKoreanAnswer;
            let frenchCorrect = cleanFrenchInput === cleanFrenchAnswer;

            if (!koreanCorrect || !frenchCorrect) {
                const stat = studentData.questions.find(q => q.id === id);
                if (stat) stat.wrongAttempts++;
            }

            let resultHTML = '';
            let resultClass = '';
            if (koreanCorrect && frenchCorrect) {
                resultHTML = `<div class="font-bold text-lg mb-2">완벽해요!! 🥳👑👍 (Parfait !!)</div><div>Coréen: ${question.korean}</div><div>Français: ${question.french}</div>`;
                resultClass = 'correct-answer';
                launchConfetti();
            } else {
                resultHTML = `<div class="font-bold text-lg mb-2">땡!! 틀렸어요!! 😭 (Bip !! Faux !!)</div>${getCorrectionHTML(koreanInput, question.korean, frenchInput, question.french)}`;
                resultClass = 'wrong-answer';
            }
            resultBox.innerHTML = resultHTML;
            resultBox.className = `mt-4 p-4 rounded-lg ${resultClass}`;
            resultBox.classList.remove('hidden');
        }

        function getCorrectionHTML(koreanInput, koreanAnswer, frenchInput, frenchAnswer) {
            let koreanCorrection = koreanInput.replace(/[.?!,]/g, '') === koreanAnswer.replace(/[.?!,]/g, '') ? `<div class="text-green-700">🇰🇷 답안 (Votre réponse) : ${koreanInput} ✔️</div>` : `<div class="text-red-700">🇰🇷 답안 (Votre réponse) : ${koreanInput} ❌</div><div class="text-slate-600">정답 (Réponse correcte) : ${koreanAnswer}</div>`;
            let frenchCorrection = frenchInput.toLowerCase().replace(/[.?!,']/g, '') === frenchAnswer.toLowerCase().replace(/[.?!,']/g, '') ? `<div class="text-green-700 mt-2">🇫🇷 답안 (Votre réponse) : ${frenchInput} ✔️</div>` : `<div class="text-red-700 mt-2">🇫🇷 답안 (Votre réponse) : ${frenchInput} ❌</div><div class="text-slate-600">정답 (Réponse correcte) : ${frenchAnswer}</div>`;
            return `${koreanCorrection}${frenchCorrection}`;
        }

        function finishTest() {
            if (!testStarted) {
                alert("테스트를 시작한 후에 결과를 보낼 수 있습니다. / Vous ne pouvez envoyer les résultats qu'après avoir commencé le test.");
                return;
            }
            studentData.endTime = new Date();
            const duration = Math.round((studentData.endTime - studentData.startTime) / 60000);

            const subject = `Résultats du test de coréen pour ${studentData.studentId}`;
            
            let body = `
                <h1>한국어 듣기 평가 결과 / Résultats du test de coréen</h1>
                <p><strong>학생 / Étudiant(e):</strong> ${studentData.studentId}</p>
                <p><strong>날짜 / Date:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
                <p><strong>총 소요 시간 / Temps total:</strong> ${duration} minute(s)</p>
                <hr>
                <h2>문제별 상세 결과 / Détails par question:</h2>
                <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th>문제 / Question</th>
                            <th>듣기 횟수 / Nb. d'écoutes</th>
                            <th>오답 횟수 / Nb. d'erreurs</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            studentData.questions.forEach(stat => {
                const questionText = questions.find(q => q.id === stat.id).korean;
                body += `
                    <tr>
                        <td>${stat.id}. ${questionText}</td>
                        <td style="text-align: center;">${stat.playCount}</td>
                        <td style="text-align: center;">${stat.wrongAttempts}</td>
                    </tr>
                `;
            });

            body += `
                    </tbody>
                </table>
            `;

            const mailtoLink = `mailto:${teacherEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            document.getElementById('final-message').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('hidden');

            window.location.href = mailtoLink;
        }
    </script>
</body>
</html>
