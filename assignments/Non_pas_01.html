<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연습: 부정 표현 | Exercice : Négation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Custom animation for fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .form-input {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: var(--royal-blue);
            box-shadow: 0 0 0 2px rgba(0, 71, 171, 0.5);
        }
        .step-section { display: none; }
        .step-section.active { display: block; }
        .choice-btn.selected {
            background-color: var(--royal-blue);
            color: white;
        }
    </style>
</head>

<body class="bg-slate-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">부정 표현 연습 🇰🇷</h1>
                <p class="text-slate-500">Exercice sur les expressions de négation</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="printButton" class="control-button" title="프린트 | Imprimer">
                    <i class="fas fa-print"></i>
                </button>
                <a href="/index.html" class="control-button" title="이전 연습문제 | Exercices précédents">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </header>

        <!-- Explanation Section -->
        <div class="bg-white p-5 rounded-xl shadow-md mb-6">
            <div class="w-full text-left flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-sky-700">오늘의 문법! | La grammaire du jour ! 📘</h2>
            </div>
            <div class="mt-4 border-t pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Part 1 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">1. “mais pas” → <span class="text-blue-600">~지만 ~아니에요</span></h3>
                        <p class="text-sm text-slate-500 mt-1">A는 좋아하지만, B는 아니다'처럼 단순한 대조를 나타낼 때 사용해요.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">Utilisé pour une opposition simple, comme "J'aime A, mais pas B."</p>
                    </div>
                    <!-- Part 2 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">2. “Ce n’est pas A mais B” → <span class="text-green-600">~이/가 아니라</span></h3>
                        <p class="text-sm text-slate-500 mt-1">'A가 아니라 B다'처럼 잘못된 정보를 바로잡거나 강조할 때 써요.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">Utilisé pour corriger une idée ou insister sur une précision : "Ce n'est pas A, mais B."</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Name Input -->
        <div id="student-name-section" class="bg-white p-8 rounded-xl shadow-md text-center">
            <h2 class="text-2xl font-semibold text-slate-700 mb-2">🚀 퀴즈를 시작할 준비가 됐나요?</h2>
            <p class="text-slate-500 mb-6">Prêt(e) à commencer le quiz ?</p>
            <div class="max-w-sm mx-auto">
                <label for="studentName" class="block text-left font-medium text-slate-600 mb-1">먼저 이름을 입력해주세요.</label>
                <input type="text" id="studentName" class="w-full form-input" placeholder="예) 세두 | Ex) Cédou">
                <button id="start-quiz-btn" class="main-button w-full mt-4">시작! | C'est parti !</button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="hidden">
            <!-- Step 1: Simple Choice -->
            <section id="step-1" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Étape 1: 선택하기 (10 questions)</h2>
                <div id="step-1-questions" class="space-y-6"></div>
            </section>
            <!-- Step 2: Word Input -->
            <section id="step-2" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Étape 2: 단어 입력하기 (10 questions)</h2>
                <div id="step-2-questions" class="space-y-6"></div>
            </section>
            <!-- Step 3: Sentence Writing -->
            <section id="step-3" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Étape 3: 문장 완성하고 녹음하기 (10 questions)</h2>
                <div id="step-3-questions" class="space-y-6"></div>
            </section>

            <!-- Navigation -->
            <div id="navigation-controls" class="flex justify-between items-center mt-6">
                <button id="prev-btn" class="nav-button"><i class="fas fa-arrow-left mr-2"></i> 이전 단계</button>
                <div id="progress-indicator" class="text-slate-600 font-medium"></div>
                <button id="next-btn" class="nav-button">다음 단계 <i class="fas fa-arrow-right ml-2"></i></button>
                <button id="finish-btn" class="main-button hidden">끝내기 & 결과 보기</button>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-slate-400">
            <p>Made by 성일, Pondant, Laon with 💖</p>
        </footer>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
        <div id="results-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl text-center transform scale-95 transition-transform duration-300">
            <!-- Results will be injected here -->
        </div>
    </div>

    <script src="../assets/grading-criteria.js"></script>
    <script type="module">
        // --- DOM Elements ---
        const studentNameSection = document.getElementById('student-name-section');
        const studentNameInput = document.getElementById('studentName');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizContainer = document.getElementById('quiz-container');
        const navigationControls = document.getElementById('navigation-controls');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const printButton = document.getElementById('printButton');
        const resultsModal = document.getElementById('results-modal');
        const resultsContent = document.getElementById('results-content');
        const steps = document.querySelectorAll('.step-section');

        // --- State Management ---
        let studentName = '';
        let currentStep = 0;
        let questions = [];
        let startTime, endTime;
        let mediaRecorder;
        let audioChunks = [];
        
        // --- Helper Functions ---
        function getCho(str) {
            const cho = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
            let result = "";
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    result += cho[Math.floor(code / 588)];
                } else {
                    result += str.charAt(i);
                }
            }
            return result;
        }

        // --- Question Data Pool ---
        const choicePool = [
            { fr: "J'aime les chiens, mais pas les chats.", ko_template: "강아지는 좋아하___ 고양이는 아니에요.", choices: ["지만", "아니라"], answer: "지만" },
            { fr: "Ce n'est pas du café, c'est du thé.", ko_template: "이건 커피가 ___ 차예요.", choices: ["지만", "아니라"], answer: "아니라" },
            { fr: "Je suis étudiant, mais pas professeur.", ko_template: "저는 학생이___ 선생님은 아니에요.", choices: ["지만", "아니라"], answer: "지만" },
            { fr: "Ce n'est pas un livre, c'est un cahier.", ko_template: "이것은 책이 ___ 공책이에요.", choices: ["지만", "아니라"], answer: "아니라" },
            { fr: "Le film est amusant, mais pas le livre.", ko_template: "영화는 재미있___ 책은 아니에요.", choices: ["지만", "아니라"], answer: "지만" },
            { fr: "Ce n'est pas aujourd'hui, c'est demain.", ko_template: "오늘이 ___ 내일이에요.", choices: ["지만", "아니라"], answer: "아니라" },
            { fr: "Il est grand, mais pas fort.", ko_template: "키는 크___ 힘은 세지 않아요.", choices: ["지만", "아니라"], answer: "지만" },
            { fr: "Ce n'est pas une pomme, c'est une poire.", ko_template: "이건 사과가 ___ 배예요.", choices: ["지만", "아니라"], answer: "아니라" },
            { fr: "J'ai de l'argent, mais pas le temps.", ko_template: "돈은 있___ 시간은 없어요.", choices: ["지만", "아니라"], answer: "지만" },
            { fr: "Ce n'est pas la Corée, c'est le Japon.", ko_template: "여기는 한국이 ___ 일본이에요.", choices: ["지만", "아니라"], answer: "아니라" },
        ];

        const inputPool = [
            { fr: "Je suis coréen, mais pas japonais.", ko_template: "한국 사람이___ 일본 사람은 아니에요.", answer: "지만" },
            { fr: "Ce n'est pas de l'eau, c'est du jus.", ko_template: "물이 ___ 주스예요.", answer: "아니라" },
            { fr: "Je parle coréen, mais pas anglais.", ko_template: "한국어는 하___ 영어는 못해요.", answer: "지만" },
            { fr: "Ce n'est pas l'été, c'est l'hiver.", ko_template: "여름이 ___ 겨울이에요.", answer: "아니라" },
            { fr: "J'ai étudié, mais ce n'était pas difficile.", ko_template: "공부했___ 어렵지는 않았어요.", answer: "지만" },
            { fr: "Ce n'est pas un bus, c'est le métro.", ko_template: "버스가 ___ 지하철이에요.", answer: "아니라" },
            { fr: "C'est cher, mais pas délicieux.", ko_template: "비싸___ 맛있지는 않아요.", answer: "지만" },
            { fr: "Ce n'est pas un crayon, c'est un stylo.", ko_template: "연필이 ___ 펜이에요.", answer: "아니라" },
            { fr: "J'ai vu le film, mais pas le drama.", ko_template: "영화는 봤___ 드라마는 못 봤어요.", answer: "지만" },
            { fr: "Ce n'est pas mon sac, c'est celui de mon ami.", ko_template: "제 가방이 ___ 친구 가방이에요.", answer: "아니라" },
        ];
        
        const sentenceWritingPool = [
            { fr: "J'aime le café, mais pas le thé.", ko: "커피는 좋아하지만 차는 아니에요.", vocab: { '커피': 'café', '차': 'thé', '좋아하다': 'aimer' } },
            { fr: "Ce n’est pas une pomme, mais une orange que je veux.", ko: "사과가 아니라 오렌지를 원해요.", vocab: { '사과': 'pomme', '오렌지': 'orange', '원하다': 'vouloir' } },
            { fr: "Ce n’est pas que je me repose, je suis en train de travailler.", ko: "쉬는 게 아니에요, 일하는 중이에요.", vocab: { '쉬다': 'se reposer', '일하다': 'travailler' } },
            { fr: "Il vient souvent, mais pas aujourd’hui.", ko: "자주는 오지만 오늘은 아니에요.", vocab: { '자주': 'souvent', '오늘': "aujourd'hui", '오다': 'venir' } },
            { fr: "J'aime l'été, mais pas l'hiver.", ko: "여름은 좋아하지만 겨울은 아니에요.", vocab: { '여름': 'été', '겨울': 'hiver' } },
            { fr: "Ce n’est pas un livre, mais un cahier que je veux.", ko: "책이 아니라 공책을 원해요.", vocab: { '책': 'livre', '공책': 'cahier' } },
            { fr: "Ce n’est pas que je m'amuse, je suis en train d'étudier.", ko: "노는 게 아니에요, 공부하는 중이에요.", vocab: { '놀다': 's\'amuser', '공부하다': 'étudier' } },
            { fr: "Il est venu hier, mais pas aujourd'hui.", ko: "어제는 왔지만 오늘은 아니에요.", vocab: { '어제': 'hier', '오늘': "aujourd'hui" } },
            { fr: "J'aime les chiens, mais pas les chats.", ko: "강아지는 좋아하지만 고양이는 아니에요.", vocab: { '강아지': 'chien', '고양이': 'chat' } },
            { fr: "Ce n’est pas de l'eau, mais du jus que je veux.", ko: "물이 아니라 주스를 원해요.", vocab: { '물': 'eau', '주스': 'jus' } }
        ];

        // --- Functions ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            questions = [];
            
            shuffleArray(choicePool);
            choicePool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'choice', userAnswer: '', isCorrect: false }));

            shuffleArray(inputPool);
            inputPool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'input', userAnswer: '', isCorrect: false }));

            shuffleArray(sentenceWritingPool);
            sentenceWritingPool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'sentence', userAnswer: '', userDictation: '', isCorrect: false, recording: null, listenCount: 0, hint1Count: 0, hint2Count: 0 }));

            questions.forEach((q, i) => q.number = i + 1);
        }

        function renderStep(stepIndex) {
            const questionsPerStep = 10;
            const start = stepIndex * questionsPerStep;
            const end = start + questionsPerStep;
            const stepQuestions = questions.slice(start, end);
            
            const container = document.getElementById(`step-${stepIndex + 1}-questions`);
            container.innerHTML = '';

            stepQuestions.forEach((q) => {
                let questionHTML = `<div class="bg-white p-6 rounded-xl shadow-md mb-4">`;
                
                if (q.type === 'choice') {
                    questionHTML += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <p class="text-lg font-mono text-slate-800 mb-4">${q.ko_template.replace('___', '<span class="font-bold text-red-500">___</span>')}</p>
                        <div class="flex space-x-2" data-question-number="${q.number}">
                            ${q.choices.map(choice => `<button class="choice-btn nav-button flex-1" data-answer="${choice}">${choice}</button>`).join('')}
                        </div>
                    `;
                } else if (q.type === 'input') {
                    questionHTML += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <div class="flex items-center space-x-2">
                            <p class="text-lg font-mono text-slate-800">${q.ko_template.split('___')[0]}</p>
                            <input type="text" class="form-input w-24 text-center text-lg" data-question-number="${q.number}" value="${q.userAnswer || ''}">
                            <p class="text-lg font-mono text-slate-800">${q.ko_template.split('___')[1]}</p>
                        </div>
                    `;
                } else if (q.type === 'sentence') {
                     questionHTML += `
                        <div class="mb-4">
                            <p class="text-sm text-slate-500">Question ${q.number} / ${questions.length}</p>
                            <p class="text-lg font-medium text-slate-800 mt-1" lang="fr">${q.fr}</p>
                        </div>
                        <div class="flex items-center space-x-3 mb-4">
                            <button class="control-button" onclick="playAudio(${q.number - 1})"><i class="fas fa-volume-up"></i> 듣기</button>
                            <button class="control-button" onclick="showHint1(${q.number - 1})"><i class="fas fa-lightbulb"></i> 힌트 1</button>
                            <button class="control-button" onclick="showHint2(${q.number - 1})"><i class="fas fa-book"></i> 힌트 2</button>
                        </div>
                        <div id="hint-display-${q.number}" class="my-3 text-blue-600 font-semibold"></div>
                        <div class="mt-4">
                            <label for="korean-answer-${q.number}" class="block text-sm font-medium text-slate-600 mb-1">한국어 답안 | Réponse en coréen :</label>
                            <input type="text" id="korean-answer-${q.number}" class="form-input" value="${q.userAnswer || ''}" placeholder="여기에 한국어 문장을 입력하세요...">
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-slate-600 mb-1">발음 녹음 | Enregistrer la prononciation :</label>
                            <div class="flex items-center space-x-2">
                                <button id="record-btn-${q.number}" class="control-button record-button" onclick="toggleRecording(${q.number - 1})"><i class="fas fa-microphone"></i> 녹음 시작</button>
                                <span id="record-status-${q.number}" class="text-sm text-slate-500"></span>
                            </div>
                        </div>
                        <div id="recording-playback-section-${q.number}" class="hidden mt-4 p-4 bg-slate-100 rounded-lg">
                            <label class="block text-sm font-medium text-slate-600 mb-2">녹음 다시 듣기 | Réécouter votre enregistrement :</label>
                            <audio id="audio-playback-${q.number}" controls class="w-full"></audio>
                        </div>
                    `;
                }
                questionHTML += `</div>`;
                container.innerHTML += questionHTML;
            });

            // Add event listeners for the current step
            if (stepIndex === 0) { // Choice
                container.querySelectorAll('.choice-btn').forEach(btn => {
                    const qNumber = parseInt(btn.parentElement.dataset.questionNumber);
                    const question = questions[qNumber - 1];
                    if (question.userAnswer === btn.dataset.answer) {
                        btn.classList.add('selected');
                    }
                    btn.addEventListener('click', (e) => {
                        question.userAnswer = e.currentTarget.dataset.answer;
                        e.currentTarget.parentElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                    });
                });
            } else if (stepIndex === 1) { // Input
                container.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const qNumber = parseInt(e.currentTarget.dataset.questionNumber);
                        questions[qNumber - 1].userAnswer = e.currentTarget.value;
                    });
                });
            } else if (stepIndex === 2) { // Sentence
                container.querySelectorAll('input').forEach(input => {
                    const qNumber = parseInt(input.id.split('-')[2]);
                    input.addEventListener('input', (e) => {
                        questions[qNumber - 1].userAnswer = e.currentTarget.value;
                    });
                });
            }
        }
        
        function showStep(index) {
            currentStep = index;
            steps.forEach((step, i) => {
                step.classList.toggle('active', i === index);
            });
            renderStep(index);
            updateNavigation();
        }

        function updateNavigation() {
            progressIndicator.textContent = `Étape ${currentStep + 1} / 3`;
            prevBtn.disabled = currentStep === 0;
            nextBtn.classList.toggle('hidden', currentStep === 2);
            finishBtn.classList.toggle('hidden', currentStep !== 2);
        }

        async function playAudio(index) {
            const q = questions[index];
            q.listenCount++;
            const button = document.querySelector(`[onclick="playAudio(${index})"]`);
            if(!button) return;
            const icon = button.querySelector('i');
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-spinner', 'fa-spin');
            button.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: q.ko, voice: 'woman' }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const { audioData, mimeType } = await response.json();
                if (!audioData) throw new Error("No audio data received from server.");

                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                await audio.play();
                audio.onended = () => {
                    icon.classList.remove('fa-spinner', 'fa-spin');
                    icon.classList.add('fa-volume-up');
                    button.disabled = false;
                };
            } catch (error) {
                console.error('Error playing audio:', error);
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-volume-up');
                button.disabled = false;
            }
        }
        
        window.playAudio = playAudio;

        function showHint1(index) {
            const q = questions[index];
            q.hint1Count++;
            document.getElementById(`hint-display-${q.number}`).textContent = getCho(q.ko);
        }
        window.showHint1 = showHint1;

        function showHint2(index) {
            const q = questions[index];
            q.hint2Count++;
            const vocabHtml = Object.entries(q.vocab)
                .map(([k, v]) => `<li><span class="font-semibold">${k}</span>: ${v}</li>`)
                .join('');
            document.getElementById(`hint-display-${q.number}`).innerHTML = `<ul class="list-disc list-inside">${vocabHtml}</ul>`;
        }
        window.showHint2 = showHint2;
        
        function toggleRecording(index) {
            const q = questions[index];
            const recordBtn = document.getElementById(`record-btn-${q.number}`);
            const recordStatus = document.getElementById(`record-status-${q.number}`);
            const icon = recordBtn.querySelector('i');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        mediaRecorder.start();
                        audioChunks = [];
                        
                        icon.classList.replace('fa-microphone', 'fa-stop-circle');
                        recordBtn.innerHTML = `<i class="fas fa-stop-circle"></i> 녹음 중지`;
                        recordStatus.textContent = '녹음 중...';

                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener("stop", () => {
                            icon.classList.replace('fa-stop-circle', 'fa-microphone');
                            recordBtn.innerHTML = `<i class="fas fa-microphone"></i> 녹음 시작`;
                            recordStatus.textContent = '녹음 완료!';

                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const playbackSection = document.getElementById(`recording-playback-section-${q.number}`);
                            const audioPlayer = document.getElementById(`audio-playback-${q.number}`);
                            if (playbackSection && audioPlayer) {
                                audioPlayer.src = audioUrl;
                                playbackSection.classList.remove('hidden');
                            }

                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = function() {
                                q.recording = {
                                    base64: reader.result.split(',')[1],
                                    filename: `recording_${studentName.replace(/\s/g, '_')}_q${q.number}.webm`,
                                    mimeType: 'audio/webm',
                                };
                            };
                            stream.getTracks().forEach(track => track.stop());
                        });
                    }).catch(err => {
                        console.error("Error accessing microphone:", err);
                        recordStatus.textContent = "마이크 접근 오류";
                    });
            }
        }
        window.toggleRecording = toggleRecording;

        function checkAnswers() {
            questions.forEach(q => {
                if (q.type === 'choice' || q.type === 'input') {
                    q.isCorrect = q.userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                } else if (q.type === 'sentence') {
                    const cleanedUserAnswer = q.userAnswer.replace(/[.,\s]/g, '');
                    const cleanedCorrectAnswer = q.ko.replace(/[.,\s]/g, '');
                    q.isCorrect = cleanedUserAnswer === cleanedCorrectAnswer;
                }
            });
        }

        function showResults() {
            endTime = new Date();
            checkAnswers();
            const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
            const correctCount = questions.filter(q => q.isCorrect).length;
            const score = Math.round((correctCount / questions.length) * 100);
            
            const gradingResult = getGradingMessage(score);

            let resultsHtml = `
                <h2 class="text-3xl font-bold text-slate-800 mb-2">${gradingResult.ko}</h2>
                <p class="text-lg text-slate-600 mb-4">${gradingResult.fr}</p>
                <p class="text-2xl font-semibold text-sky-600 mb-6">
                    총점: ${correctCount} / ${questions.length} (${gradingResult.score}%)
                </p>
                <div class="text-left max-h-60 overflow-y-auto pr-2">
            `;

            questions.forEach((q) => {
                resultsHtml += `
                    <div class="p-3 rounded-lg mb-3 ${q.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                        <p class="font-semibold text-slate-700">Q${q.number}: ${q.fr}</p>
                        <p class="text-sm ${q.isCorrect ? 'text-green-700' : 'text-red-700'}">
                            <i class="fas ${q.isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            당신의 답: ${q.userAnswer || "답변 없음"}
                        </p>
                        ${!q.isCorrect ? `<p class="text-sm text-blue-700"><span class="font-bold">${comparisonMessage.ko}</span><br>${q.type === 'sentence' ? q.ko : q.answer}</p>` : ''}
                    </div>
                `;
            });

            resultsHtml += `
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="retry-btn" class="main-button">다시하기 | Recommencer</button>
                    <button id="close-results-btn" class="nav-button">닫기 | Fermer</button>
                </div>
            `;

            resultsContent.innerHTML = resultsHtml;
            resultsModal.classList.remove('hidden');
            resultsModal.classList.add('flex');
            setTimeout(() => resultsContent.classList.add('scale-100'), 10);

            document.getElementById('retry-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
                resetQuiz();
            });
            document.getElementById('close-results-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
            });

            sendResults(totalTimeSeconds);
        }

        async function sendResults(totalTimeSeconds) {
            const payload = {
                studentName,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                totalTimeSeconds,
                questions,
            };

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error('Failed to send results');
                }
                console.log('Results sent successfully.');
            } catch (error) {
                console.error('Error sending results:', error);
            }
        }
        
        function resetQuiz() {
            studentNameSection.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            navigationControls.classList.add('hidden');
            currentQuestionIndex = 0;
            studentNameInput.value = '';
            studentName = '';
        }

        // --- Event Listeners & Initializers ---
        
        startQuizBtn.addEventListener('click', () => {
            studentName = studentNameInput.value.trim();
            if (studentName) {
                startTime = new Date();
                studentNameSection.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                navigationControls.classList.add('flex');
                generateQuestions();
                showStep(0);
            } else {
                alert('이름을 입력해주세요. | Veuillez entrer votre nom.');
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentStep < 2) {
                showStep(currentStep + 1);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                showStep(currentStep - 1);
            }
        });

        finishBtn.addEventListener('click', showResults);
        
        printButton.addEventListener('click', () => window.print());

    </script>
</body>

</html>
