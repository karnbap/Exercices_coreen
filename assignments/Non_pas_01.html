<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ìŠµ: ë¶€ì • í‘œí˜„ | Exercice : NÃ©gation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Custom animation for fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .form-input {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .form-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: var(--royal-blue);
            box-shadow: 0 0 0 2px rgba(0, 71, 171, 0.5);
        }
        .step-section { display: none; }
        .step-section.active { display: block; }
        .choice-btn.selected {
            background-color: var(--royal-blue);
            color: white;
        }
    </style>
</head>

<body class="bg-slate-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ë¶€ì • í‘œí˜„ ì—°ìŠµ ğŸ‡°ğŸ‡·</h1>
                <p class="text-slate-500">Exercice sur les expressions de nÃ©gation</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="printButton" class="control-button" title="í”„ë¦°íŠ¸ | Imprimer">
                    <i class="fas fa-print"></i>
                </button>
                <a href="/index.html" class="control-button" title="ì´ì „ ì—°ìŠµë¬¸ì œ | Exercices prÃ©cÃ©dents">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </header>

        <!-- Explanation Section -->
        <div class="bg-white p-5 rounded-xl shadow-md mb-6">
            <div class="w-full text-left flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-sky-700">ì˜¤ëŠ˜ì˜ ë¬¸ë²•! | La grammaire du jour ! ğŸ“˜</h2>
            </div>
            <div class="mt-4 border-t pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Part 1 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">1. â€œmais pasâ€ â†’ <span class="text-blue-600">~ì§€ë§Œ ~ì•„ë‹ˆì—ìš”</span></h3>
                        <p class="text-sm text-slate-500 mt-1">AëŠ” ì¢‹ì•„í•˜ì§€ë§Œ, BëŠ” ì•„ë‹ˆë‹¤'ì²˜ëŸ¼ ë‹¨ìˆœí•œ ëŒ€ì¡°ë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•´ìš”.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">UtilisÃ© pour une opposition simple, comme "J'aime A, mais pas B."</p>
                    </div>
                    <!-- Part 2 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">2. â€œCe nâ€™est pas A mais Bâ€ â†’ <span class="text-green-600">~ì´/ê°€ ì•„ë‹ˆë¼</span></h3>
                        <p class="text-sm text-slate-500 mt-1">'Aê°€ ì•„ë‹ˆë¼ Bë‹¤'ì²˜ëŸ¼ ì˜ëª»ëœ ì •ë³´ë¥¼ ë°”ë¡œì¡ê±°ë‚˜ ê°•ì¡°í•  ë•Œ ì¨ìš”.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">UtilisÃ© pour corriger une idÃ©e ou insister sur une prÃ©cision : "Ce n'est pas A, mais B."</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Name Input -->
        <div id="student-name-section" class="bg-white p-8 rounded-xl shadow-md text-center">
            <h2 class="text-2xl font-semibold text-slate-700 mb-2">ğŸš€ í€´ì¦ˆë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ëë‚˜ìš”?</h2>
            <p class="text-slate-500 mb-6">PrÃªt(e) Ã  commencer le quiz ?</p>
            <div class="max-w-sm mx-auto">
                <label for="studentName" class="block text-left font-medium text-slate-600 mb-1">ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</label>
                <input type="text" id="studentName" class="w-full form-input" placeholder="ì˜ˆ) ì„¸ë‘ | Ex) CÃ©dou">
                <button id="start-quiz-btn" class="main-button w-full mt-4">ì‹œì‘! | C'est parti !</button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="hidden">
            <!-- Step 1: Simple Choice -->
            <section id="step-1" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Ã‰tape 1: ì„ íƒí•˜ê¸° (10 questions)</h2>
                <div id="step-1-questions" class="space-y-6"></div>
            </section>
            <!-- Step 2: Word Input -->
            <section id="step-2" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Ã‰tape 2: ë‹¨ì–´ ì…ë ¥í•˜ê¸° (10 questions)</h2>
                <div id="step-2-questions" class="space-y-6"></div>
            </section>
            <!-- Step 3: Sentence Writing -->
            <section id="step-3" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">Ã‰tape 3: ë¬¸ì¥ ì™„ì„±í•˜ê³  ë…¹ìŒí•˜ê¸° (10 questions)</h2>
                <div id="step-3-questions" class="space-y-6"></div>
            </section>

            <!-- Navigation -->
            <div id="navigation-controls" class="flex justify-between items-center mt-6">
                <button id="prev-btn" class="nav-button"><i class="fas fa-arrow-left mr-2"></i> ì´ì „ ë‹¨ê³„</button>
                <div id="progress-indicator" class="text-slate-600 font-medium"></div>
                <button id="next-btn" class="nav-button">ë‹¤ìŒ ë‹¨ê³„ <i class="fas fa-arrow-right ml-2"></i></button>
                <button id="finish-btn" class="main-button hidden">ëë‚´ê¸° & ê²°ê³¼ ë³´ê¸°</button>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-slate-400">
            <p>Made by ì„±ì¼, Pondant, Laon with ğŸ’–</p>
        </footer>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
        <div id="results-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl text-center transform scale-95 transition-transform duration-300">
            <!-- Results will be injected here -->
        </div>
    </div>

    <script src="../assets/grading-criteria.js"></script>
    <script type="module">
        // --- DOM Elements ---
        const studentNameSection = document.getElementById('student-name-section');
        const studentNameInput = document.getElementById('studentName');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizContainer = document.getElementById('quiz-container');
        const navigationControls = document.getElementById('navigation-controls');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const printButton = document.getElementById('printButton');
        const resultsModal = document.getElementById('results-modal');
        const resultsContent = document.getElementById('results-content');
        const steps = document.querySelectorAll('.step-section');

        // --- State Management ---
        let studentName = '';
        let currentStep = 0;
        let questions = [];
        let startTime, endTime;
        let mediaRecorder;
        let audioChunks = [];
        
        // --- Helper Functions ---
        function getCho(str) {
            const cho = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            let result = "";
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    result += cho[Math.floor(code / 588)];
                } else {
                    result += str.charAt(i);
                }
            }
            return result;
        }

        // --- Question Data Pool ---
        const choicePool = [
            { fr: "J'aime les chiens, mais pas les chats.", ko_template: "ê°•ì•„ì§€ëŠ” ì¢‹ì•„í•˜___ ê³ ì–‘ì´ëŠ” ì•„ë‹ˆì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas du cafÃ©, c'est du thÃ©.", ko_template: "ì´ê±´ ì»¤í”¼ê°€ ___ ì°¨ì˜ˆìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì•„ë‹ˆë¼" },
            { fr: "Je suis Ã©tudiant, mais pas professeur.", ko_template: "ì €ëŠ” í•™ìƒì´___ ì„ ìƒë‹˜ì€ ì•„ë‹ˆì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas un livre, c'est un cahier.", ko_template: "ì´ê²ƒì€ ì±…ì´ ___ ê³µì±…ì´ì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì•„ë‹ˆë¼" },
            { fr: "Le film est amusant, mais pas le livre.", ko_template: "ì˜í™”ëŠ” ì¬ë¯¸ìˆ___ ì±…ì€ ì•„ë‹ˆì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas aujourd'hui, c'est demain.", ko_template: "ì˜¤ëŠ˜ì´ ___ ë‚´ì¼ì´ì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì•„ë‹ˆë¼" },
            { fr: "Il est grand, mais pas fort.", ko_template: "í‚¤ëŠ” í¬___ í˜ì€ ì„¸ì§€ ì•Šì•„ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas une pomme, c'est une poire.", ko_template: "ì´ê±´ ì‚¬ê³¼ê°€ ___ ë°°ì˜ˆìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì•„ë‹ˆë¼" },
            { fr: "J'ai de l'argent, mais pas le temps.", ko_template: "ëˆì€ ìˆ___ ì‹œê°„ì€ ì—†ì–´ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas la CorÃ©e, c'est le Japon.", ko_template: "ì—¬ê¸°ëŠ” í•œêµ­ì´ ___ ì¼ë³¸ì´ì—ìš”.", choices: ["ì§€ë§Œ", "ì•„ë‹ˆë¼"], answer: "ì•„ë‹ˆë¼" },
        ];

        const inputPool = [
            { fr: "Je suis corÃ©en, mais pas japonais.", ko_template: "í•œêµ­ ì‚¬ëŒì´___ ì¼ë³¸ ì‚¬ëŒì€ ì•„ë‹ˆì—ìš”.", answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas de l'eau, c'est du jus.", ko_template: "ë¬¼ì´ ___ ì£¼ìŠ¤ì˜ˆìš”.", answer: "ì•„ë‹ˆë¼" },
            { fr: "Je parle corÃ©en, mais pas anglais.", ko_template: "í•œêµ­ì–´ëŠ” í•˜___ ì˜ì–´ëŠ” ëª»í•´ìš”.", answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas l'Ã©tÃ©, c'est l'hiver.", ko_template: "ì—¬ë¦„ì´ ___ ê²¨ìš¸ì´ì—ìš”.", answer: "ì•„ë‹ˆë¼" },
            { fr: "J'ai Ã©tudiÃ©, mais ce n'Ã©tait pas difficile.", ko_template: "ê³µë¶€í–ˆ___ ì–´ë µì§€ëŠ” ì•Šì•˜ì–´ìš”.", answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas un bus, c'est le mÃ©tro.", ko_template: "ë²„ìŠ¤ê°€ ___ ì§€í•˜ì² ì´ì—ìš”.", answer: "ì•„ë‹ˆë¼" },
            { fr: "C'est cher, mais pas dÃ©licieux.", ko_template: "ë¹„ì‹¸___ ë§›ìˆì§€ëŠ” ì•Šì•„ìš”.", answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas un crayon, c'est un stylo.", ko_template: "ì—°í•„ì´ ___ íœì´ì—ìš”.", answer: "ì•„ë‹ˆë¼" },
            { fr: "J'ai vu le film, mais pas le drama.", ko_template: "ì˜í™”ëŠ” ë´¤___ ë“œë¼ë§ˆëŠ” ëª» ë´¤ì–´ìš”.", answer: "ì§€ë§Œ" },
            { fr: "Ce n'est pas mon sac, c'est celui de mon ami.", ko_template: "ì œ ê°€ë°©ì´ ___ ì¹œêµ¬ ê°€ë°©ì´ì—ìš”.", answer: "ì•„ë‹ˆë¼" },
        ];
        
        const sentenceWritingPool = [
            { fr: "J'aime le cafÃ©, mais pas le thÃ©.", ko: "ì»¤í”¼ëŠ” ì¢‹ì•„í•˜ì§€ë§Œ ì°¨ëŠ” ì•„ë‹ˆì—ìš”.", vocab: { 'ì»¤í”¼': 'cafÃ©', 'ì°¨': 'thÃ©', 'ì¢‹ì•„í•˜ë‹¤': 'aimer' } },
            { fr: "Ce nâ€™est pas une pomme, mais une orange que je veux.", ko: "ì‚¬ê³¼ê°€ ì•„ë‹ˆë¼ ì˜¤ë Œì§€ë¥¼ ì›í•´ìš”.", vocab: { 'ì‚¬ê³¼': 'pomme', 'ì˜¤ë Œì§€': 'orange', 'ì›í•˜ë‹¤': 'vouloir' } },
            { fr: "Ce nâ€™est pas que je me repose, je suis en train de travailler.", ko: "ì‰¬ëŠ” ê²Œ ì•„ë‹ˆì—ìš”, ì¼í•˜ëŠ” ì¤‘ì´ì—ìš”.", vocab: { 'ì‰¬ë‹¤': 'se reposer', 'ì¼í•˜ë‹¤': 'travailler' } },
            { fr: "Il vient souvent, mais pas aujourdâ€™hui.", ko: "ìì£¼ëŠ” ì˜¤ì§€ë§Œ ì˜¤ëŠ˜ì€ ì•„ë‹ˆì—ìš”.", vocab: { 'ìì£¼': 'souvent', 'ì˜¤ëŠ˜': "aujourd'hui", 'ì˜¤ë‹¤': 'venir' } },
            { fr: "J'aime l'Ã©tÃ©, mais pas l'hiver.", ko: "ì—¬ë¦„ì€ ì¢‹ì•„í•˜ì§€ë§Œ ê²¨ìš¸ì€ ì•„ë‹ˆì—ìš”.", vocab: { 'ì—¬ë¦„': 'Ã©tÃ©', 'ê²¨ìš¸': 'hiver' } },
            { fr: "Ce nâ€™est pas un livre, mais un cahier que je veux.", ko: "ì±…ì´ ì•„ë‹ˆë¼ ê³µì±…ì„ ì›í•´ìš”.", vocab: { 'ì±…': 'livre', 'ê³µì±…': 'cahier' } },
            { fr: "Ce nâ€™est pas que je m'amuse, je suis en train d'Ã©tudier.", ko: "ë…¸ëŠ” ê²Œ ì•„ë‹ˆì—ìš”, ê³µë¶€í•˜ëŠ” ì¤‘ì´ì—ìš”.", vocab: { 'ë†€ë‹¤': 's\'amuser', 'ê³µë¶€í•˜ë‹¤': 'Ã©tudier' } },
            { fr: "Il est venu hier, mais pas aujourd'hui.", ko: "ì–´ì œëŠ” ì™”ì§€ë§Œ ì˜¤ëŠ˜ì€ ì•„ë‹ˆì—ìš”.", vocab: { 'ì–´ì œ': 'hier', 'ì˜¤ëŠ˜': "aujourd'hui" } },
            { fr: "J'aime les chiens, mais pas les chats.", ko: "ê°•ì•„ì§€ëŠ” ì¢‹ì•„í•˜ì§€ë§Œ ê³ ì–‘ì´ëŠ” ì•„ë‹ˆì—ìš”.", vocab: { 'ê°•ì•„ì§€': 'chien', 'ê³ ì–‘ì´': 'chat' } },
            { fr: "Ce nâ€™est pas de l'eau, mais du jus que je veux.", ko: "ë¬¼ì´ ì•„ë‹ˆë¼ ì£¼ìŠ¤ë¥¼ ì›í•´ìš”.", vocab: { 'ë¬¼': 'eau', 'ì£¼ìŠ¤': 'jus' } }
        ];

        // --- Functions ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            questions = [];
            
            shuffleArray(choicePool);
            choicePool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'choice', userAnswer: '', isCorrect: false }));

            shuffleArray(inputPool);
            inputPool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'input', userAnswer: '', isCorrect: false }));

            shuffleArray(sentenceWritingPool);
            sentenceWritingPool.slice(0, 10).forEach(q => questions.push({ ...q, type: 'sentence', userAnswer: '', userDictation: '', isCorrect: false, recording: null, listenCount: 0, hint1Count: 0, hint2Count: 0 }));

            questions.forEach((q, i) => q.number = i + 1);
        }

        function renderStep(stepIndex) {
            const questionsPerStep = 10;
            const start = stepIndex * questionsPerStep;
            const end = start + questionsPerStep;
            const stepQuestions = questions.slice(start, end);
            
            const container = document.getElementById(`step-${stepIndex + 1}-questions`);
            container.innerHTML = '';

            stepQuestions.forEach((q) => {
                let questionHTML = `<div class="bg-white p-6 rounded-xl shadow-md mb-4">`;
                
                if (q.type === 'choice') {
                    questionHTML += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <p class="text-lg font-mono text-slate-800 mb-4">${q.ko_template.replace('___', '<span class="font-bold text-red-500">___</span>')}</p>
                        <div class="flex space-x-2" data-question-number="${q.number}">
                            ${q.choices.map(choice => `<button class="choice-btn nav-button flex-1" data-answer="${choice}">${choice}</button>`).join('')}
                        </div>
                    `;
                } else if (q.type === 'input') {
                    questionHTML += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <div class="flex items-center space-x-2">
                            <p class="text-lg font-mono text-slate-800">${q.ko_template.split('___')[0]}</p>
                            <input type="text" class="form-input w-24 text-center text-lg" data-question-number="${q.number}" value="${q.userAnswer || ''}">
                            <p class="text-lg font-mono text-slate-800">${q.ko_template.split('___')[1]}</p>
                        </div>
                    `;
                } else if (q.type === 'sentence') {
                     questionHTML += `
                        <div class="mb-4">
                            <p class="text-sm text-slate-500">Question ${q.number} / ${questions.length}</p>
                            <p class="text-lg font-medium text-slate-800 mt-1" lang="fr">${q.fr}</p>
                        </div>
                        <div class="flex items-center space-x-3 mb-4">
                            <button class="control-button" onclick="playAudio(${q.number - 1})"><i class="fas fa-volume-up"></i> ë“£ê¸°</button>
                            <button class="control-button" onclick="showHint1(${q.number - 1})"><i class="fas fa-lightbulb"></i> íŒíŠ¸ 1</button>
                            <button class="control-button" onclick="showHint2(${q.number - 1})"><i class="fas fa-book"></i> íŒíŠ¸ 2</button>
                        </div>
                        <div id="hint-display-${q.number}" class="my-3 text-blue-600 font-semibold"></div>
                        <div class="mt-4">
                            <label for="korean-answer-${q.number}" class="block text-sm font-medium text-slate-600 mb-1">í•œêµ­ì–´ ë‹µì•ˆ | RÃ©ponse en corÃ©en :</label>
                            <input type="text" id="korean-answer-${q.number}" class="form-input" value="${q.userAnswer || ''}" placeholder="ì—¬ê¸°ì— í•œêµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-slate-600 mb-1">ë°œìŒ ë…¹ìŒ | Enregistrer la prononciation :</label>
                            <div class="flex items-center space-x-2">
                                <button id="record-btn-${q.number}" class="control-button record-button" onclick="toggleRecording(${q.number - 1})"><i class="fas fa-microphone"></i> ë…¹ìŒ ì‹œì‘</button>
                                <span id="record-status-${q.number}" class="text-sm text-slate-500"></span>
                            </div>
                        </div>
                        <div id="recording-playback-section-${q.number}" class="hidden mt-4 p-4 bg-slate-100 rounded-lg">
                            <label class="block text-sm font-medium text-slate-600 mb-2">ë…¹ìŒ ë‹¤ì‹œ ë“£ê¸° | RÃ©Ã©couter votre enregistrement :</label>
                            <audio id="audio-playback-${q.number}" controls class="w-full"></audio>
                        </div>
                    `;
                }
                questionHTML += `</div>`;
                container.innerHTML += questionHTML;
            });

            // Add event listeners for the current step
            if (stepIndex === 0) { // Choice
                container.querySelectorAll('.choice-btn').forEach(btn => {
                    const qNumber = parseInt(btn.parentElement.dataset.questionNumber);
                    const question = questions[qNumber - 1];
                    if (question.userAnswer === btn.dataset.answer) {
                        btn.classList.add('selected');
                    }
                    btn.addEventListener('click', (e) => {
                        question.userAnswer = e.currentTarget.dataset.answer;
                        e.currentTarget.parentElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                    });
                });
            } else if (stepIndex === 1) { // Input
                container.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const qNumber = parseInt(e.currentTarget.dataset.questionNumber);
                        questions[qNumber - 1].userAnswer = e.currentTarget.value;
                    });
                });
            } else if (stepIndex === 2) { // Sentence
                container.querySelectorAll('input').forEach(input => {
                    const qNumber = parseInt(input.id.split('-')[2]);
                    input.addEventListener('input', (e) => {
                        questions[qNumber - 1].userAnswer = e.currentTarget.value;
                    });
                });
            }
        }
        
        function showStep(index) {
            currentStep = index;
            steps.forEach((step, i) => {
                step.classList.toggle('active', i === index);
            });
            renderStep(index);
            updateNavigation();
        }

        function updateNavigation() {
            progressIndicator.textContent = `Ã‰tape ${currentStep + 1} / 3`;
            prevBtn.disabled = currentStep === 0;
            nextBtn.classList.toggle('hidden', currentStep === 2);
            finishBtn.classList.toggle('hidden', currentStep !== 2);
        }

        async function playAudio(index) {
            const q = questions[index];
            q.listenCount++;
            const button = document.querySelector(`[onclick="playAudio(${index})"]`);
            if(!button) return;
            const icon = button.querySelector('i');
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-spinner', 'fa-spin');
            button.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: q.ko, voice: 'woman' }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const { audioData, mimeType } = await response.json();
                if (!audioData) throw new Error("No audio data received from server.");

                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                await audio.play();
                audio.onended = () => {
                    icon.classList.remove('fa-spinner', 'fa-spin');
                    icon.classList.add('fa-volume-up');
                    button.disabled = false;
                };
            } catch (error) {
                console.error('Error playing audio:', error);
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-volume-up');
                button.disabled = false;
            }
        }
        
        window.playAudio = playAudio;

        function showHint1(index) {
            const q = questions[index];
            q.hint1Count++;
            document.getElementById(`hint-display-${q.number}`).textContent = getCho(q.ko);
        }
        window.showHint1 = showHint1;

        function showHint2(index) {
            const q = questions[index];
            q.hint2Count++;
            const vocabHtml = Object.entries(q.vocab)
                .map(([k, v]) => `<li><span class="font-semibold">${k}</span>: ${v}</li>`)
                .join('');
            document.getElementById(`hint-display-${q.number}`).innerHTML = `<ul class="list-disc list-inside">${vocabHtml}</ul>`;
        }
        window.showHint2 = showHint2;
        
        function toggleRecording(index) {
            const q = questions[index];
            const recordBtn = document.getElementById(`record-btn-${q.number}`);
            const recordStatus = document.getElementById(`record-status-${q.number}`);
            const icon = recordBtn.querySelector('i');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        mediaRecorder.start();
                        audioChunks = [];
                        
                        icon.classList.replace('fa-microphone', 'fa-stop-circle');
                        recordBtn.innerHTML = `<i class="fas fa-stop-circle"></i> ë…¹ìŒ ì¤‘ì§€`;
                        recordStatus.textContent = 'ë…¹ìŒ ì¤‘...';

                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener("stop", () => {
                            icon.classList.replace('fa-stop-circle', 'fa-microphone');
                            recordBtn.innerHTML = `<i class="fas fa-microphone"></i> ë…¹ìŒ ì‹œì‘`;
                            recordStatus.textContent = 'ë…¹ìŒ ì™„ë£Œ!';

                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const playbackSection = document.getElementById(`recording-playback-section-${q.number}`);
                            const audioPlayer = document.getElementById(`audio-playback-${q.number}`);
                            if (playbackSection && audioPlayer) {
                                audioPlayer.src = audioUrl;
                                playbackSection.classList.remove('hidden');
                            }

                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = function() {
                                q.recording = {
                                    base64: reader.result.split(',')[1],
                                    filename: `recording_${studentName.replace(/\s/g, '_')}_q${q.number}.webm`,
                                    mimeType: 'audio/webm',
                                };
                            };
                            stream.getTracks().forEach(track => track.stop());
                        });
                    }).catch(err => {
                        console.error("Error accessing microphone:", err);
                        recordStatus.textContent = "ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜";
                    });
            }
        }
        window.toggleRecording = toggleRecording;

        function checkAnswers() {
            questions.forEach(q => {
                if (q.type === 'choice' || q.type === 'input') {
                    q.isCorrect = q.userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase();
                } else if (q.type === 'sentence') {
                    const cleanedUserAnswer = q.userAnswer.replace(/[.,\s]/g, '');
                    const cleanedCorrectAnswer = q.ko.replace(/[.,\s]/g, '');
                    q.isCorrect = cleanedUserAnswer === cleanedCorrectAnswer;
                }
            });
        }

        function showResults() {
            endTime = new Date();
            checkAnswers();
            const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
            const correctCount = questions.filter(q => q.isCorrect).length;
            const score = Math.round((correctCount / questions.length) * 100);
            
            const gradingResult = getGradingMessage(score);

            let resultsHtml = `
                <h2 class="text-3xl font-bold text-slate-800 mb-2">${gradingResult.ko}</h2>
                <p class="text-lg text-slate-600 mb-4">${gradingResult.fr}</p>
                <p class="text-2xl font-semibold text-sky-600 mb-6">
                    ì´ì : ${correctCount} / ${questions.length} (${gradingResult.score}%)
                </p>
                <div class="text-left max-h-60 overflow-y-auto pr-2">
            `;

            questions.forEach((q) => {
                resultsHtml += `
                    <div class="p-3 rounded-lg mb-3 ${q.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                        <p class="font-semibold text-slate-700">Q${q.number}: ${q.fr}</p>
                        <p class="text-sm ${q.isCorrect ? 'text-green-700' : 'text-red-700'}">
                            <i class="fas ${q.isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ë‹¹ì‹ ì˜ ë‹µ: ${q.userAnswer || "ë‹µë³€ ì—†ìŒ"}
                        </p>
                        ${!q.isCorrect ? `<p class="text-sm text-blue-700"><span class="font-bold">${comparisonMessage.ko}</span><br>${q.type === 'sentence' ? q.ko : q.answer}</p>` : ''}
                    </div>
                `;
            });

            resultsHtml += `
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="retry-btn" class="main-button">ë‹¤ì‹œí•˜ê¸° | Recommencer</button>
                    <button id="close-results-btn" class="nav-button">ë‹«ê¸° | Fermer</button>
                </div>
            `;

            resultsContent.innerHTML = resultsHtml;
            resultsModal.classList.remove('hidden');
            resultsModal.classList.add('flex');
            setTimeout(() => resultsContent.classList.add('scale-100'), 10);

            document.getElementById('retry-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
                resetQuiz();
            });
            document.getElementById('close-results-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
            });

            sendResults(totalTimeSeconds);
        }

        async function sendResults(totalTimeSeconds) {
            const payload = {
                studentName,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                totalTimeSeconds,
                questions,
            };

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error('Failed to send results');
                }
                console.log('Results sent successfully.');
            } catch (error) {
                console.error('Error sending results:', error);
            }
        }
        
        function resetQuiz() {
            studentNameSection.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            navigationControls.classList.add('hidden');
            currentQuestionIndex = 0;
            studentNameInput.value = '';
            studentName = '';
        }

        // --- Event Listeners & Initializers ---
        
        startQuizBtn.addEventListener('click', () => {
            studentName = studentNameInput.value.trim();
            if (studentName) {
                startTime = new Date();
                studentNameSection.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                navigationControls.classList.add('flex');
                generateQuestions();
                showStep(0);
            } else {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. | Veuillez entrer votre nom.');
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentStep < 2) {
                showStep(currentStep + 1);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) {
                showStep(currentStep - 1);
            }
        });

        finishBtn.addEventListener('click', showResults);
        
        printButton.addEventListener('click', () => window.print());

    </script>
</body>

</html>
