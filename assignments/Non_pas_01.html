<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>부정 표현 연습 | Exercice : Négation</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Site styles (optional) -->
    <link rel="stylesheet" href="../assets/style.css" />

    <!-- Readable, modern fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <style>
        /* Base font stack: high readability for KR/FR */
        body { font-family: 'Noto Sans KR','Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue','Noto Sans','Apple SD Gothic Neo',sans-serif; }

        /* Subtle entrance animation */
        @keyframes fadeIn { from { opacity:0; transform: translateY(-8px);} to { opacity:1; transform: translateY(0);} }
        .animate-fade-in { animation: fadeIn 0.45s ease-out forwards; }

        /* Inputs */
        .form-input {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            width: 100%;
            font-size: 1rem;
        }
        .form-input:focus {
            outline: none;
            border-color: #0047ab; /* royal blue */
            box-shadow: 0 0 0 3px rgba(0,71,171,0.28);
        }

        /* Sections */
        .step-section { display: none; }
        .step-section.active { display: block; }

        /* Buttons */
        .control-button, .main-button, .nav-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem 1.2rem;             /* Bigger touch target */
            font-size: 1rem;                      /* Legible size */
            font-weight: 600;
            border-radius: 1rem;                  /* Softer corners */
            transition: box-shadow .15s ease, transform .05s ease, background .15s ease;
            border: 1px solid #cbd5e1;
            background-color: #fff;
            color: #0f172a;
        }
        .control-button:hover, .nav-button:hover { background-color:#f1f5f9; box-shadow: 0 2px 10px rgba(2,6,23,.06); }
        .control-button:active, .nav-button:active, .main-button:active { transform: translateY(1px); }
        .control-button:focus-visible, .nav-button:focus-visible, .main-button:focus-visible { box-shadow: 0 0 0 4px rgba(0,71,171,.25); outline: none; }

        .main-button { background-color:#0ea5e9; border-color:#0ea5e9; color:white; }
        .main-button:hover { background-color:#0284c7; border-color:#0284c7; }

        /* Choice buttons */
        .choice-btn { padding: 0.85rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.9rem; font-weight: 600; }
        .choice-btn.selected { background-color:#0047ab; color: white; }

        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal-backdrop.show { display: flex; }
        .modal-card { background: #fff; border-radius: 1rem; box-shadow: 0 20px 40px rgba(2,6,23,.2); width: 100%; max-width: 42rem; padding: 2rem; transform: scale(.96); transition: transform .2s; }
        .modal-card.zoom { transform: scale(1); }
    </style>
</head>

<body class="bg-slate-50">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">부정 표현 연습 | Exercice : Négation</h1>
                <p class="text-slate-500">한국어 부정 표현 연습 | Exercices sur la négation</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="printButton" class="control-button" title="인쇄 | Imprimer" aria-label="인쇄 | Imprimer">
                    <i class="fas fa-print"></i>
                </button>
                <a href="/index.html" class="control-button" title="이전 | Précédent" aria-label="이전 | Précédent">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </header>

        <!-- Explanation Section -->
        <div class="bg-white p-5 rounded-xl shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-sky-700 mb-4">오늘의 문법 | Grammaire du jour 📘</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-slate-700">1. “mais pas” → <span class="text-blue-600">~지만 ~아니에요</span></h3>
                    <p class="text-sm text-slate-500 mt-1">A는 좋아하지만 B는 아니에요. | J’aime A, mais pas B.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-slate-700">2. “Ce n’est pas A mais B” → <span class="text-green-600">~이/가 아니라</span></h3>
                    <p class="text-sm text-slate-500 mt-1">A가 아니라 B예요. | Ce n’est pas A, mais B.</p>
                </div>
            </div>
        </div>

        <!-- Student Name Input -->
        <div id="student-name-section" class="bg-white p-8 rounded-xl shadow-md text-center">
            <h2 class="text-2xl font-semibold text-slate-700 mb-2">🚀 시작할 준비됐나요? | Prêt(e) ?</h2>
            <p class="text-slate-500 mb-6">이름을 입력하면 시작할 수 있어요. | Entrez votre nom pour commencer.</p>
            <div class="max-w-sm mx-auto">
                <label for="studentName" class="block text-left font-medium text-slate-600 mb-1">이름 | Nom</label>
                <input type="text" id="studentName" class="form-input" placeholder="예: 세두 | Ex: Cédou" />
            <button id="start-quiz-btn" type="button" class="main-button w-full mt-4">
              시작! | C’est parti !
            </button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="hidden">
            <section id="step-1" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">1단계 | Étape 1 : 선택 (10문제)</h2>
                <div id="step-1-questions" class="space-y-6"></div>
            </section>
            <section id="step-2" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">2단계 | Étape 2 : 입력 (10문제)</h2>
                <div id="step-2-questions" class="space-y-6"></div>
            </section>
            <section id="step-3" class="step-section">
                <h2 class="text-2xl font-semibold text-slate-700 mb-4">3단계 | Étape 3 : 듣고 쓰고 녹음 (10문제)</h2>
                <div id="step-3-questions" class="space-y-6"></div>
            </section>

            <!-- Navigation -->
            <div id="navigation-controls" class="flex justify-between items-center mt-6">
                <button id="prev-btn" class="nav-button" aria-label="이전 | Précédent"><i class="fas fa-arrow-left mr-2"></i> 이전 | Précédent</button>
                <div id="progress-indicator" class="text-slate-600 font-medium" aria-live="polite">단계 | Étape 1 / 3</div>
                <button id="next-btn" class="nav-button" aria-label="다음 | Suivant">다음 | Suivant <i class="fas fa-arrow-right ml-2"></i></button>
                <button id="finish-btn" class="main-button hidden" aria-label="결과 보기 | Résultats">결과 보기 | Résultats</button>
            </div>
        </div>
        
        <!-- Results Modal -->
        <div id="results-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="results-title">
            <div id="results-card" class="modal-card" tabindex="-1">
                <div id="results-content"><!-- injected --></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-sm text-slate-400">
            <p>Made by 성일, Pondant, Laon with 💖</p>
        </footer>
    </div>

    <!-- App Script -->
    <script type="module">
        // -------------------- DOM --------------------
        const studentNameSection = document.getElementById('student-name-section');
        const studentNameInput   = document.getElementById('studentName');
        const startQuizBtn       = document.getElementById('start-quiz-btn');
        const quizContainer      = document.getElementById('quiz-container');
        const navigationControls = document.getElementById('navigation-controls');
        const prevBtn            = document.getElementById('prev-btn');
        const nextBtn            = document.getElementById('next-btn');
        const finishBtn          = document.getElementById('finish-btn');
        const progressIndicator  = document.getElementById('progress-indicator');
        const printButton        = document.getElementById('printButton');
        const resultsModal       = document.getElementById('results-modal');
        const resultsCard        = document.getElementById('results-card');
        const resultsContent     = document.getElementById('results-content');
        const steps              = document.querySelectorAll('.step-section');

        // -------------------- State --------------------
        let studentName = '';
        let currentStep = 0; // 0,1,2
        let questions   = [];
        let startTime, endTime;
        let mediaRecorder; let audioChunks = [];

        // -------------------- Helpers --------------------
        function getCho(str='') {
            const cho = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
            let result = '';
            for (let i=0;i<str.length;i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code>-1 && code<11172) result += cho[Math.floor(code/588)]; else result += str[i];
            }
            return result;
        }
        const cleanText = (s='') => s.replace(/[.,\s]/g,'').toLowerCase();

        // -------------------- Data Pools --------------------
        const choicePool = [
            { fr: "J'aime les chiens, mais pas les chats.", ko_template: "강아지는 좋아하___ 고양이는 아니에요.", choices: ["지만","아니라"], answer: "지만" },
            { fr: "Ce n'est pas du café, c'est du thé.",       ko_template: "이건 커피가 ___ 차예요.",            choices: ["지만","아니라"], answer: "아니라" },
            { fr: "Je suis étudiant, mais pas professeur.",     ko_template: "저는 학생이___ 선생님은 아니에요.",      choices: ["지만","아니라"], answer: "지만" },
            { fr: "Ce n'est pas un livre, c'est un cahier.",    ko_template: "이것은 책이 ___ 공책이에요.",          choices: ["지만","아니라"], answer: "아니라" },
            { fr: "Le film est amusant, mais pas le livre.",    ko_template: "영화는 재미있___ 책은 아니에요.",        choices: ["지만","아니라"], answer: "지만" },
            { fr: "Ce n'est pas aujourd'hui, c'est demain.",    ko_template: "오늘이 ___ 내일이에요.",                choices: ["지만","아니라"], answer: "아니라" },
            { fr: "Il est grand, mais pas fort.",               ko_template: "키는 크___ 힘은 세지 않아요.",            choices: ["지만","아니라"], answer: "지만" },
            { fr: "Ce n'est pas une pomme, c'est une poire.",   ko_template: "이건 사과가 ___ 배예요.",               choices: ["지만","아니라"], answer: "아니라" },
            { fr: "J'ai de l'argent, mais pas le temps.",       ko_template: "돈은 있___ 시간은 없어요.",              choices: ["지만","아니라"], answer: "지만" },
            { fr: "Ce n'est pas la Corée, c'est le Japon.",     ko_template: "여기는 한국이 ___ 일본이에요.",            choices: ["지만","아니라"], answer: "아니라" },
        ];

        const inputPool = [
            { fr: "Je suis coréen, mais pas japonais.",         ko_template: "한국 사람이___ 일본 사람은 아니에요.",      answer: "지만" },
            { fr: "Ce n'est pas de l'eau, c'est du jus.",       ko_template: "물이 ___ 주스예요.",                      answer: "아니라" },
            { fr: "Je parle coréen, mais pas anglais.",         ko_template: "한국어는 하___ 영어는 못해요.",              answer: "지만" },
            { fr: "Ce n'est pas l'été, c'est l'hiver.",         ko_template: "여름이 ___ 겨울이에요.",                  answer: "아니라" },
            { fr: "J'ai étudié, mais ce n'était pas difficile.", ko_template: "공부했___ 어렵지는 않았어요.",              answer: "지만" },
            { fr: "Ce n'est pas un bus, c'est le métro.",       ko_template: "버스가 ___ 지하철이에요.",                  answer: "아니라" },
            { fr: "C'est cher, mais pas délicieux.",            ko_template: "비싸___ 맛있지는 않아요.",                  answer: "지만" },
            { fr: "Ce n'est pas un crayon, c'est un stylo.",    ko_template: "연필이 ___ 펜이에요.",                    answer: "아니라" },
            { fr: "J'ai vu le film, mais pas le drama.",        ko_template: "영화는 봤___ 드라마는 못 봤어요.",          answer: "지만" },
            { fr: "Ce n'est pas mon sac, c'est celui de mon ami.", ko_template: "제 가방이 ___ 친구 가방이에요.",       answer: "아니라" },
        ];

        const sentenceWritingPool = [
            { fr: "J'aime le café, mais pas le thé.",                                       ko: "커피는 좋아하지만 차는 아니에요.",                 vocab: { '커피':'café','차':'thé','좋아하다':'aimer' } },
            { fr: "Ce n’est pas une pomme, mais une orange que je veux.",                   ko: "사과가 아니라 오렌지를 원해요.",                   vocab: { '사과':'pomme','오렌지':'orange','원하다':'vouloir' } },
            { fr: "Ce n’est pas que je me repose, je suis en train de travailler.",         ko: "쉬는 게 아니에요, 일하는 중이에요.",                 vocab: { '쉬다':'se reposer','일하다':'travailler' } },
            { fr: "Il vient souvent, mais pas aujourd’hui.",                                ko: "자주는 오지만 오늘은 아니에요.",                   vocab: { '자주':'souvent','오늘':"aujourd'hui",'오다':'venir' } },
            { fr: "J'aime l'été, mais pas l'hiver.",                                        ko: "여름은 좋아하지만 겨울은 아니에요.",               vocab: { '여름':'été','겨울':'hiver' } },
            { fr: "Ce n’est pas un livre, mais un cahier que je veux.",                      ko: "책이 아니라 공책을 원해요.",                       vocab: { '책':'livre','공책':'cahier' } },
            { fr: "Ce n’est pas que je m'amuse, je suis en train d'étudier.",               ko: "노는 게 아니에요, 공부하는 중이에요.",               vocab: { '놀다':"s'amuser",'공부하다':'étudier' } },
            { fr: "Il est venu hier, mais pas aujourd'hui.",                                 ko: "어제는 왔지만 오늘은 아니에요.",                     vocab: { '어제':'hier','오늘':"aujourd'hui" } },
            { fr: "J'aime les chiens, mais pas les chats.",                                  ko: "강아지는 좋아하지만 고양이는 아니에요.",             vocab: { '강아지':'chien','고양이':'chat' } },
            { fr: "Ce n’est pas de l'eau, mais du jus que je veux.",                         ko: "물이 아니라 주스를 원해요.",                         vocab: { '물':'eau','주스':'jus' } },
        ];

        // -------------------- Core --------------------
        function shuffleArray(arr) {
            for (let i=arr.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function generateQuestions() {
            questions = [];
            const c = [...choicePool]; shuffleArray(c); c.slice(0,10).forEach(q => questions.push({ ...q, type:'choice', userAnswer:'', isCorrect:false }));
            const i = [...inputPool];  shuffleArray(i); i.slice(0,10).forEach(q => questions.push({ ...q, type:'input',  userAnswer:'', isCorrect:false }));
            const s = [...sentenceWritingPool]; shuffleArray(s); s.slice(0,10).forEach(q => questions.push({ ...q, type:'sentence', userDictation:'', userTranslation:'', userSelfDictation:'', isCorrect:false, recording:null, listenCount:0, hint1Count:0, hint2Count:0 }));
            questions.forEach((q,idx)=> q.number = idx+1);
        }

        function renderStep(stepIndex){
            const perStep = 10; const start = stepIndex*perStep; const end = start+perStep; const stepQuestions = questions.slice(start,end);
            const container = document.getElementById(`step-${stepIndex+1}-questions`);
            container.innerHTML = '';

            stepQuestions.forEach(q=>{
                let html = `<div class="bg-white p-6 rounded-xl shadow-md mb-4 animate-fade-in">`;
                if(q.type==='choice'){
                    html += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <p class="text-lg font-mono text-slate-800 mb-4">${q.ko_template.replace('___', '<span class="font-bold text-red-500">___</span>')}</p>
                        <div class="grid grid-cols-2 gap-2" data-question-number="${q.number}">
                            ${q.choices.map(ch => `<button class="choice-btn" data-answer="${ch}">${ch}</button>`).join('')}
                        </div>`;
                } else if(q.type==='input'){
                    const [a,b] = q.ko_template.split('___');
                    html += `
                        <p class="font-semibold text-slate-700 mb-2">Q${q.number}. ${q.fr}</p>
                        <div class="flex items-center flex-wrap gap-2">
                            <span class="text-lg font-mono text-slate-800">${a}</span>
                            <input type="text" class="form-input w-28 text-center text-lg" data-question-number="${q.number}" value="${q.userAnswer||''}" placeholder="정답 | Réponse" />
                            <span class="text-lg font-mono text-slate-800">${b}</span>
                        </div>`;
                } else if(q.type==='sentence'){
                    html += `
                        <p class="font-semibold text-slate-700 mb-4">Q${q.number}. 듣고, 쓰고, 녹음 | Écoutez, écrivez et enregistrez</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">1. 듣고 받아쓰기 (Écouter et faire une dictée)</label>
                                <div class="flex items-center gap-2 mb-2">
                                    <button class="control-button" onclick="playAudio(${q.number-1})"><i class="fas fa-volume-up"></i> 듣기 | Écouter</button>
                                    <button class="control-button" onclick="showHint1(${q.number-1})"><i class="fas fa-lightbulb"></i> 초성 | Consonnes initiales</button>
                                    <button class="control-button" onclick="showHint2(${q.number-1})"><i class="fas fa-book"></i> 단어 | Vocabulaire</button>
                                </div>
                                <div id="hint-display-${q.number}" class="my-2 text-blue-600 font-semibold"></div>
                                <input type="text" id="dictation-input-${q.number}" class="form-input" value="${q.userDictation||''}" placeholder="들은 내용을 한국어로 쓰세요 | Écrivez ce que vous entendez en coréen" />
                            </div>

                            <div>
                                <label for="translation-input-${q.number}" class="block text-sm font-medium text-slate-600 mb-1">2. 불어로 번역 | Traduisez en français</label>
                                <input type="text" id="translation-input-${q.number}" class="form-input" value="${q.userTranslation||''}" placeholder="불어로 번역... | Traduisez en français..." />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">3. 발음 녹음하고 듣기 | Enregistrez et écoutez</label>
                                <div class="flex items-center gap-2">
                                    <button id="record-btn-${q.number}" class="control-button record-button" onclick="toggleRecording(${q.number-1})"><i class="fas fa-microphone"></i> 녹음 | Enregistrer</button>
                                    <span id="record-status-${q.number}" class="text-sm text-slate-500"></span>
                                </div>
                                <audio id="audio-playback-${q.number}" controls class="w-full mt-2 hidden"></audio>
                            </div>

                            <div>
                                <label for="self-dictation-input-${q.number}" class="block text-sm font-medium text-slate-600 mb-1">4. 자기 녹음 듣고 받아쓰기 | Faire une dictée avec votre enregistrement</label>
                                <input type="text" id="self-dictation-input-${q.number}" class="form-input" value="${q.userSelfDictation||''}" placeholder="자신의 녹음을 듣고 쓰세요 | Écrivez ce que vous entendez de votre enregistrement" />
                            </div>
                        </div>`;
                }
                html += `</div>`;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Wire up listeners for the step
            if(stepIndex===0){
                container.querySelectorAll('.choice-btn').forEach(btn=>{
                    const qNumber = parseInt(btn.parentElement.dataset.questionNumber || btn.closest('[data-question-number]')?.dataset.questionNumber);
                    const q = questions[qNumber-1];
                    if(q.userAnswer===btn.dataset.answer) btn.classList.add('selected');
                    btn.addEventListener('click', e=>{
                        q.userAnswer = e.currentTarget.dataset.answer;
                        e.currentTarget.closest('[data-question-number]').querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                    });
                });
            } else if(stepIndex===1){
                container.querySelectorAll('input[data-question-number]').forEach(input=>{
                    input.addEventListener('input', e=>{
                        const n = parseInt(e.currentTarget.dataset.questionNumber); questions[n-1].userAnswer = e.currentTarget.value;
                    });
                });
            } else if(stepIndex===2){
                stepQuestions.forEach(q=>{
                    document.getElementById(`dictation-input-${q.number}`).addEventListener('input', e=> q.userDictation = e.target.value);
                    document.getElementById(`translation-input-${q.number}`).addEventListener('input', e=> q.userTranslation = e.target.value);
                    document.getElementById(`self-dictation-input-${q.number}`).addEventListener('input', e=> q.userSelfDictation = e.target.value);
                });
            }
        }

        function showStep(index){
            currentStep = index;
            steps.forEach((s,i)=> s.classList.toggle('active', i===index));
            renderStep(index);
            updateNavigation();
        }

        function updateNavigation(){
            progressIndicator.textContent = `단계 | Étape ${currentStep+1} / 3`;
            prevBtn.disabled = currentStep===0;
            nextBtn.classList.toggle('hidden', currentStep===2);
            finishBtn.classList.toggle('hidden', currentStep!==2);
        }

        // -------------------- Audio (TTS) --------------------
        async function playAudio(index){
            const q = questions[index];
            q.listenCount++;
            const button = document.querySelector(`[onclick="playAudio(${index})"]`);
            if(!button) return;
            const icon = button.querySelector('i');
            icon.classList.replace('fa-volume-up','fa-spinner'); icon.classList.add('fa-spin'); button.disabled = true;
            try {
                const res = await fetch('/.netlify/functions/generate-audio', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: q.ko, voice: 'woman' })
                });
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const { audioData, mimeType } = await res.json();
                if(!audioData) throw new Error('No audio data');
                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                await audio.play();
                audio.onended = ()=>{ icon.classList.replace('fa-spinner','fa-volume-up'); icon.classList.remove('fa-spin'); button.disabled = false; };
            } catch(err){
                console.error('TTS error:', err);
                icon.classList.replace('fa-spinner','fa-volume-up'); icon.classList.remove('fa-spin'); button.disabled = false;
            }
        }
        window.playAudio = playAudio;

        // -------------------- Hints --------------------
        function showHint1(index){ const q = questions[index]; q.hint1Count++; document.getElementById(`hint-display-${q.number}`).textContent = getCho(q.ko); }
        function showHint2(index){ const q = questions[index]; q.hint2Count++; const html = Object.entries(q.vocab).map(([k,v])=>`<li><b>${k}</b>: ${v}</li>`).join(''); document.getElementById(`hint-display-${q.number}`).innerHTML = `<ul class="list-disc list-inside">${html}</ul>`; }
        window.showHint1 = showHint1; window.showHint2 = showHint2;

        // -------------------- Recording --------------------
        function toggleRecording(index){
            const q = questions[index];
            const btn = document.getElementById(`record-btn-${q.number}`);
            const status = document.getElementById(`record-status-${q.number}`);
            const icon = btn.querySelector('i');
            if(mediaRecorder && mediaRecorder.state==='recording'){
                mediaRecorder.stop();
            } else {
                navigator.mediaDevices.getUserMedia({ audio:true }).then(stream=>{
                    mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm' });
                    mediaRecorder.start();
                    audioChunks = [];
                    icon.classList.replace('fa-microphone','fa-stop-circle');
                    btn.innerHTML = `<i class="fas fa-stop-circle"></i> 녹음 중지 | Arrêter`;
                    status.textContent = '녹음 중... | Enregistrement en cours...';
                    mediaRecorder.addEventListener('dataavailable', e=> audioChunks.push(e.data));
                    mediaRecorder.addEventListener('stop', ()=>{
                        icon.classList.replace('fa-stop-circle','fa-microphone');
                        btn.innerHTML = `<i class="fas fa-microphone"></i> 녹음 | Enregistrer`;
                        status.textContent = '녹음 완료! | Enregistrement terminé !';
                        const blob = new Blob(audioChunks, { type:'audio/webm' });
                        const url  = URL.createObjectURL(blob);
                        const player = document.getElementById(`audio-playback-${q.number}`);
                        player.src = url; player.classList.remove('hidden');
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = ()=>{ q.recording = { base64: reader.result.split(',')[1], filename: `recording_${studentName.replace(/\s/g,'_')}_q${q.number}.webm`, mimeType: 'audio/webm' }; };
                        stream.getTracks().forEach(t=>t.stop());
                    });
                }).catch(err => { console.error('Mic error:', err); status.textContent = '마이크 사용이 차단되었습니다 | Micro non disponible'; }
            }
        }
        window.toggleRecording = toggleRecording;

        // -------------------- Grading --------------------
        function checkAnswers(){
            questions.forEach(q=>{
                if(q.type==='choice' || q.type==='input'){
                    q.isCorrect = cleanText(q.userAnswer) === cleanText(q.answer);
                } else if(q.type==='sentence'){
                    const ok1 = cleanText(q.userDictation)  === cleanText(q.ko);
                    const ok2 = cleanText(q.userTranslation)=== cleanText(q.fr);
                    q.isCorrect = ok1 && ok2;
                }
            });
        }
        function getGradingMessage(score){
            if(score>=90) return { score, ko:'아주 잘했어요! 훌륭해요 💯', fr:"Excellent travail !" };
            if(score>=75) return { score, ko:'잘했어요! 조금만 더 연습해요 👍', fr:"Bien joué ! Encore un peu de pratique." };
            if(score>=60) return { score, ko:'괜찮아요! 핵심을 다시 복습해요 🙂', fr:"Pas mal ! Revoyez l'essentiel." };
            return { score, ko:'천천히 다시 해봐요. 할 수 있어요! 💪', fr:"Courage ! Reprenez calmement, vous pouvez le faire." };
        }

        function showResults(){
            endTime = new Date(); checkAnswers();
            const totalTime = Math.round((endTime - startTime)/1000);
            const correct    = questions.filter(q=>q.isCorrect).length;
            const score      = Math.round((correct/questions.length)*100);
            const msg        = getGradingMessage(score);

            let html = `
                <h2 id="results-title" class="text-3xl font-bold text-slate-800 mb-2">${msg.ko}</h2>
                <p class="text-lg text-slate-600 mb-4">${msg.fr}</p>
                <p class="text-2xl font-semibold text-sky-600 mb-6">총점 | Score : ${correct} / ${questions.length} (${score}%)</p>
                <div class="text-left max-h-72 overflow-y-auto pr-2">
            `;
            questions.forEach(q=>{
                const your = q.userAnswer || q.userDictation || '답변 없음 | Aucune réponse';
                const correction = q.isCorrect ? '' : `<p class="text-sm text-blue-700"><b>정답 | Réponse</b><br>${q.answer || q.ko}</p>`;
                html += `
                    <div class="p-3 rounded-lg mb-3 ${q.isCorrect?'bg-green-50':'bg-red-50'}">
                        <p class="font-semibold text-slate-700">Q${q.number}: ${q.fr}</p>
                        <p class="text-sm ${q.isCorrect?'text-green-700':'text-red-700'}">
                            <i class="fas ${q.isCorrect?'fa-check-circle':'fa-times-circle'}"></i>
                            당신의 답 | Votre réponse : ${your}
                        </p>
                        ${correction}
                    </div>`;
            });
            html += `</div>
                <div class="mt-6 flex justify-center gap-3">
                    <button id="retry-btn" class="main-button">다시하기 | Recommencer</button>
                    <button id="close-results-btn" class="nav-button">닫기 | Fermer</button>
                </div>`;

            resultsContent.innerHTML = html;
            resultsModal.classList.add('show');
            setTimeout(()=> resultsCard.classList.add('zoom'), 10);

            document.getElementById('retry-btn').addEventListener('click', ()=>{ resultsModal.classList.remove('show'); resultsCard.classList.remove('zoom'); resetQuiz(); });
            document.getElementById('close-results-btn').addEventListener('click', ()=>{ resultsModal.classList.remove('show'); resultsCard.classList.remove('zoom'); });

            sendResults(totalTime);
        }

        async function sendResults(totalTimeSeconds){
            const payload = { studentName, startTime: startTime.toISOString(), endTime: endTime.toISOString(), totalTimeSeconds, questions };
            try {
                const res = await fetch('/.netlify/functions/send-results', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error('Failed to send results');
                console.log('Results sent.');
            } catch(err){ console.error('Error sending results:', err); }
        }

        function resetQuiz(){
            studentNameSection.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            navigationControls.classList.add('hidden');
            currentStep = 0; studentNameInput.value=''; studentName='';
        }

        // -------------------- Events --------------------
        startQuizBtn.addEventListener('click', ()=>{
            studentName = (studentNameInput.value||'').trim();
            if(studentName){
                startTime = new Date();
                studentNameSection.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                navigationControls.classList.add('flex');
                generateQuestions();
                showStep(0);
            } else {
                alert('이름을 입력하세요 | Veuillez entrer votre nom');
            }
        });
        nextBtn.addEventListener('click', ()=>{ if(currentStep<2) showStep(currentStep+1); });
        prevBtn.addEventListener('click', ()=>{ if(currentStep>0) showStep(currentStep-1); });
        finishBtn.addEventListener('click', showResults);
        printButton.addEventListener('click', ()=> window.print());
 <script>
  (function () {
    const btn   = document.getElementById('start-quiz-btn');
    const input = document.getElementById('studentName');
    const nameBox = document.getElementById('student-name-section');
    const quiz    = document.getElementById('quiz-container');
    const nav     = document.getElementById('navigation-controls');
    if (!btn) return;

    // 항상 활성화
    btn.removeAttribute('disabled');
    btn.type = 'button';

    // 클릭 핸들러 (모듈이 깨져도 동작)
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const name = (input && input.value ? input.value : '').trim();
      if (!name) {
        alert('이름을 입력하세요 | Veuillez entrer votre nom');
        return;
      }
      if (nameBox) nameBox.classList.add('hidden');
      if (quiz)    quiz.classList.remove('hidden');
      if (nav) { nav.classList.remove('hidden'); nav.classList.add('flex'); }

      // 모듈 함수가 있으면 사용해서 바로 1단계 렌더링
      try {
        if (window.generateQuestions) generateQuestions();
        if (window.showStep) showStep(0);
      } catch (_) { /* 무시 */ }
    });
  })();
</script>

</body>


</html>
