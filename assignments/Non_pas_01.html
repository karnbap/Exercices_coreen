<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°ìŠµ: ë¶€ì • í‘œí˜„ | Exercice : NÃ©gation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        /* Custom animation for fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ë¶€ì • í‘œí˜„ ì—°ìŠµ ğŸ‡°ğŸ‡·</h1>
                <p class="text-slate-500">Exercice sur les expressions de nÃ©gation</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="printButton" class="control-button" title="í”„ë¦°íŠ¸ | Imprimer">
                    <i class="fas fa-print"></i>
                </button>
                <a href="/index.html" class="control-button" title="ì´ì „ ì—°ìŠµë¬¸ì œ | Exercices prÃ©cÃ©dents">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </header>

        <!-- Explanation Section -->
        <div class="bg-white p-5 rounded-xl shadow-md mb-6">
            <button id="toggle-explanation" class="w-full text-left flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-sky-700">ì˜¤ëŠ˜ì˜ ë¬¸ë²•! | La grammaire du jour ! ğŸ“˜</h2>
                <i id="explanation-icon" class="fas fa-chevron-down transition-transform"></i>
            </button>
            <div id="explanation-content" class="explanation-content mt-4 border-t pt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Part 1 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">1. â€œmais pasâ€ â†’ <span class="text-blue-600">~ì§€ë§Œ ~ì•„ë‹ˆì—ìš”</span></h3>
                        <p class="text-sm text-slate-500 mt-1">AëŠ” ì¢‹ì•„í•˜ì§€ë§Œ, BëŠ” ì•„ë‹ˆë‹¤'ì²˜ëŸ¼ ë‹¨ìˆœí•œ ëŒ€ì¡°ë¥¼ ë‚˜íƒ€ë‚¼ ë•Œ ì‚¬ìš©í•´ìš”.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">UtilisÃ© pour une opposition simple, comme "J'aime A, mais pas B."</p>
                        <div class="mt-3 bg-slate-100 p-3 rounded-lg">
                            <p class="font-mono">ì»¤í”¼ëŠ” ì¢‹ì•„í•˜ì§€ë§Œ ì°¨ëŠ” ì•„ë‹ˆì—ìš”.</p>
                            <p class="text-sm text-slate-600 fr">â†’ Jâ€™aime le cafÃ©, mais pas le thÃ©.</p>
                            <p class="font-mono mt-2">ê·¸ëŠ” ìì£¼ ì˜¤ì§€ë§Œ ì˜¤ëŠ˜ì€ ì•„ë‹ˆì—ìš”.</p>
                            <p class="text-sm text-slate-600 fr">â†’ Il vient souvent, mais pas aujourdâ€™hui.</p>
                        </div>
                    </div>
                    <!-- Part 2 -->
                    <div>
                        <h3 class="font-bold text-lg text-slate-700">2. â€œCe nâ€™est pas A mais Bâ€ â†’ <span class="text-green-600">~ì´/ê°€ ì•„ë‹ˆì—ìš”, ~ëŠ” ê²ƒì´ ì•„ë‹ˆì—ìš”</span></h3>
                        <p class="text-sm text-slate-500 mt-1">'Aê°€ ì•„ë‹ˆë¼ Bë‹¤'ì²˜ëŸ¼ ì˜ëª»ëœ ì •ë³´ë¥¼ ë°”ë¡œì¡ê±°ë‚˜ ê°•ì¡°í•  ë•Œ ì¨ìš”.</p>
                        <p class="text-sm text-slate-500 mt-1 fr">UtilisÃ© pour corriger une idÃ©e ou insister sur une prÃ©cision : "Ce n'est pas A, mais B."</p>
                        <div class="mt-3 bg-slate-100 p-3 rounded-lg">
                            <p class="font-mono">ì»¤í”¼ê°€ ì•„ë‹ˆë¼ ì°¨ë¥¼ ì¢‹ì•„í•´ìš”.</p>
                            <p class="text-sm text-slate-600 fr">â†’ Ce nâ€™est pas le cafÃ©, mais le thÃ© que jâ€™aime.</p>
                            <p class="font-mono mt-2">ì‰¬ëŠ” ê²Œ ì•„ë‹ˆì—ìš”, ì¼í•˜ëŠ” ì¤‘ì´ì—ìš”.</p>
                            <p class="text-sm text-slate-600 fr">â†’ Ce nâ€™est pas que je me repose, je suis en train de travailler.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Name Input -->
        <div id="student-name-section" class="bg-white p-6 rounded-xl shadow-md text-center">
            <label for="studentName" class="text-lg font-medium text-slate-700">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” | Entrez votre nom :</label>
            <input type="text" id="studentName" class="mt-2 w-full max-w-sm mx-auto form-input" placeholder="í•™ìƒ ì´ë¦„ | Nom de l'Ã©tudiant">
            <button id="start-quiz-btn" class="main-button mt-4">í€´ì¦ˆ ì‹œì‘! | Commencer !</button>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="hidden">
            <!-- Quiz content will be injected here -->
        </div>

        <!-- Navigation -->
        <div id="navigation-controls" class="hidden justify-between items-center mt-6">
            <button id="prev-btn" class="nav-button"><i class="fas fa-arrow-left mr-2"></i> ì´ì „ | PrÃ©cÃ©dent</button>
            <div id="progress-indicator" class="text-slate-600 font-medium"></div>
            <button id="next-btn" class="nav-button">ë‹¤ìŒ | Suivant <i class="fas fa-arrow-right ml-2"></i></button>
            <button id="finish-btn" class="main-button hidden">ëë‚´ê¸° | Terminer</button>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
        <div id="results-content" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl text-center transform scale-95 transition-transform duration-300">
            <!-- Results will be injected here -->
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const studentNameSection = document.getElementById('student-name-section');
        const studentNameInput = document.getElementById('studentName');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizContainer = document.getElementById('quiz-container');
        const navigationControls = document.getElementById('navigation-controls');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const printButton = document.getElementById('printButton');
        const resultsModal = document.getElementById('results-modal');
        const resultsContent = document.getElementById('results-content');
        const toggleExplanationBtn = document.getElementById('toggle-explanation');
        const explanationContent = document.getElementById('explanation-content');
        const explanationIcon = document.getElementById('explanation-icon');

        // --- State Management ---
        let studentName = '';
        let currentQuestionIndex = 0;
        let questions = [];
        let userAnswers = [];
        let startTime, endTime;
        let mediaRecorder;
        let audioChunks = [];
        
        // --- Helper Functions (Previously Imported) ---
        function getCho(str) {
            const cho = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            let result = "";
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) {
                    result += cho[Math.floor(code / 588)];
                } else {
                    result += str.charAt(i);
                }
            }
            return result;
        }

        function gradingCriteria(score) {
            if (score >= 90) {
                return {
                    title: { ko: "ì •ë§ ëŒ€ë‹¨í•´ìš”!", fr: "Excellent travail !" },
                    color: "text-green-600"
                };
            } else if (score >= 70) {
                return {
                    title: { ko: "ì•„ì£¼ ì˜í–ˆì–´ìš”!", fr: "TrÃ¨s bien !" },
                    color: "text-blue-600"
                };
            } else if (score >= 50) {
                return {
                    title: { ko: "ì¢‹ì•„ìš”, ì¡°ê¸ˆë§Œ ë”!", fr: "Bien, encore un effort !" },
                    color: "text-yellow-600"
                };
            } else {
                return {
                    title: { ko: "ë‹¤ì‹œ í•œë²ˆ í•´ë³¼ê¹Œìš”?", fr: "On essaie encore ?" },
                    color: "text-red-600"
                };
            }
        }


        // --- Question Data Pool ---
        const questionPool = [
            {
                type: 'ì§€ë§Œ_ì•„ë‹ˆì—ìš”',
                fr_prompt_template: "J'aime [FR_A], mais pas [FR_B].",
                ko_pattern_template: "[KO_A] ì¢‹ì•„í•˜ì§€ë§Œ [KO_B] ì•„ë‹ˆì—ìš”.",
                pool: [
                    { KO_A: 'ì»¤í”¼ëŠ”', KO_B: 'ì°¨ëŠ”', FR_A: 'le cafÃ©', FR_B: 'le thÃ©', vocab: { 'ì»¤í”¼': 'cafÃ©', 'ì°¨': 'thÃ©', 'ì¢‹ì•„í•˜ë‹¤': 'aimer' } },
                    { KO_A: 'ì—¬ë¦„ì€', KO_B: 'ê²¨ìš¸ì€', FR_A: "l'Ã©tÃ©", FR_B: "l'hiver", vocab: { 'ì—¬ë¦„': 'Ã©tÃ©', 'ê²¨ìš¸': 'hiver' } },
                    { KO_A: 'ê°•ì•„ì§€ëŠ”', KO_B: 'ê³ ì–‘ì´ëŠ”', FR_A: 'les chiens', FR_B: 'les chats', vocab: { 'ê°•ì•„ì§€': 'chien', 'ê³ ì–‘ì´': 'chat' } },
                ]
            },
            {
                type: 'ì´/ê°€_ì•„ë‹ˆë¼',
                fr_prompt_template: "Ce nâ€™est pas [FR_A], mais [FR_B] que je veux.",
                ko_pattern_template: "[KO_A] ì•„ë‹ˆë¼ [KO_B] ì›í•´ìš”.",
                pool: [
                    { KO_A: 'ì‚¬ê³¼ê°€', KO_B: 'ì˜¤ë Œì§€ë¥¼', FR_A: 'une pomme', FR_B: 'une orange', vocab: { 'ì‚¬ê³¼': 'pomme', 'ì˜¤ë Œì§€': 'orange', 'ì›í•˜ë‹¤': 'vouloir' } },
                    { KO_A: 'ì±…ì´', KO_B: 'ê³µì±…ì„', FR_A: 'un livre', FR_B: 'un cahier', vocab: { 'ì±…': 'livre', 'ê³µì±…': 'cahier' } },
                    { KO_A: 'ë¬¼ì´', KO_B: 'ì£¼ìŠ¤ë¥¼', FR_A: "de l'eau", FR_B: 'du jus', vocab: { 'ë¬¼': 'eau', 'ì£¼ìŠ¤': 'jus' } }
                ]
            },
            {
                type: 'ëŠ”_ê²ƒì´_ì•„ë‹ˆì—ìš”',
                fr_prompt_template: "Ce nâ€™est pas que je [FR_A], je suis en train de [FR_B].",
                ko_pattern_template: "[KO_A] ê²Œ ì•„ë‹ˆì—ìš”, [KO_B] ì¤‘ì´ì—ìš”.",
                pool: [
                    { KO_A: 'ì‰¬ëŠ”', KO_B: 'ì¼í•˜ëŠ”', FR_A: 'me repose', FR_B: 'travailler', vocab: { 'ì‰¬ë‹¤': 'se reposer', 'ì¼í•˜ë‹¤': 'travailler' } },
                    { KO_A: 'ë…¸ëŠ”', KO_B: 'ê³µë¶€í•˜ëŠ”', FR_A: "m'amuse", FR_B: 'Ã©tudier', vocab: { 'ë†€ë‹¤': 's\'amuser', 'ê³µë¶€í•˜ë‹¤': 'Ã©tudier' } },
                    { KO_A: 'ìëŠ”', KO_B: 'ìƒê°í•˜ëŠ”', FR_A: 'dors', FR_B: 'rÃ©flÃ©chir', vocab: { 'ìë‹¤': 'dormir', 'ìƒê°í•˜ë‹¤': 'penser' } }
                ]
            },
            {
                type: 'ì§€ë§Œ_ì•„ë‹ˆì—ìš”',
                fr_prompt_template: "Il/Elle vient [FR_A], mais pas [FR_B].",
                ko_pattern_template: "[KO_A] ì˜¤ì§€ë§Œ [KO_B] ì•„ë‹ˆì—ìš”.",
                pool: [
                    { KO_A: 'ìì£¼ëŠ”', KO_B: 'ì˜¤ëŠ˜ì€', FR_A: 'souvent', FR_B: "aujourd'hui", vocab: { 'ìì£¼': 'souvent', 'ì˜¤ëŠ˜': "aujourd'hui", 'ì˜¤ë‹¤': 'venir' } },
                    { KO_A: 'ì–´ì œëŠ”', KO_B: 'ì˜¤ëŠ˜ì€', FR_A: 'hier', FR_B: "aujourd'hui", vocab: { 'ì–´ì œ': 'hier', 'ì˜¤ëŠ˜': "aujourd'hui" } },
                ]
            }
        ];

        // --- Functions ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateQuestions() {
            questions = questionPool.map((q, index) => {
                shuffleArray(q.pool);
                const item = q.pool[0];
                const fr = q.fr_prompt_template.replace('[FR_A]', item.FR_A).replace('[FR_B]', item.FR_B);
                const ko = q.ko_pattern_template.replace('[KO_A]', item.KO_A).replace('[KO_B]', item.KO_B);
                return {
                    number: index + 1,
                    fr: fr,
                    ko: ko,
                    vocab: item.vocab,
                    userAnswer: '',
                    userDictation: '', // Add field for dictation
                    isCorrect: false,
                    listenCount: 0,
                    hint1Count: 0,
                    hint2Count: 0,
                    recording: null
                };
            });
            userAnswers = new Array(questions.length).fill('');
        }

        function renderQuestion(index) {
            const q = questions[index];
            quizContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md animate-fade-in">
                    <div class="mb-4">
                        <p class="text-sm text-slate-500">Question ${q.number} / ${questions.length}</p>
                        <p class="text-lg font-medium text-slate-800 mt-1" lang="fr">${q.fr}</p>
                    </div>

                    <div class="flex items-center space-x-3 mb-4">
                        <button class="control-button" id="play-audio-btn" title="Ã‰couter"><i class="fas fa-volume-up"></i> ë“£ê¸°</button>
                        <button class="control-button" id="hint1-btn" title="Indice 1: Consonnes initiales"><i class="fas fa-lightbulb"></i> íŒíŠ¸ 1</button>
                        <button class="control-button" id="hint2-btn" title="Indice 2: Vocabulaire"><i class="fas fa-book"></i> íŒíŠ¸ 2</button>
                    </div>
                    
                    <div id="hint-display" class="my-3 text-blue-600 font-semibold"></div>

                    <div class="mt-4">
                        <label for="korean-answer" class="block text-sm font-medium text-slate-600 mb-1">í•œêµ­ì–´ ë‹µì•ˆ | RÃ©ponse en corÃ©en :</label>
                        <input type="text" id="korean-answer" class="form-input" value="${userAnswers[index] || ''}" placeholder="ì—¬ê¸°ì— í•œêµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-slate-600 mb-1">ë°œìŒ ë…¹ìŒ | Enregistrer la prononciation :</label>
                        <div class="flex items-center space-x-2">
                            <button id="record-btn" class="control-button record-button"><i class="fas fa-microphone"></i> ë…¹ìŒ ì‹œì‘</button>
                            <span id="record-status" class="text-sm text-slate-500"></span>
                        </div>
                    </div>

                    <!-- Recording Playback & Dictation Section -->
                    <div id="recording-playback-section" class="hidden mt-4 p-4 bg-slate-100 rounded-lg">
                        <label class="block text-sm font-medium text-slate-600 mb-2">ë…¹ìŒ ë‹¤ì‹œ ë“£ê¸° | RÃ©Ã©couter votre enregistrement :</label>
                        <audio id="audio-playback" controls class="w-full"></audio>
                        <div class="mt-4">
                            <label for="dictation-input" class="block text-sm font-medium text-slate-600 mb-1">ë“¤ì€ ë‚´ìš© ë°›ì•„ì“°ê¸° | DictÃ©e de ce que vous avez entendu :</label>
                            <input type="text" id="dictation-input" class="form-input" value="${q.userDictation || ''}" placeholder="ë…¹ìŒì„ ë“£ê³  ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”...">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('korean-answer').addEventListener('input', (e) => {
                userAnswers[index] = e.target.value;
            });
            
            document.getElementById('dictation-input').addEventListener('input', (e) => {
                questions[index].userDictation = e.target.value;
            });

            document.getElementById('play-audio-btn').addEventListener('click', () => {
                playAudio(q.ko, 'woman');
                q.listenCount++;
            });

            document.getElementById('hint1-btn').addEventListener('click', () => {
                document.getElementById('hint-display').textContent = getCho(q.ko);
                q.hint1Count++;
            });

            document.getElementById('hint2-btn').addEventListener('click', () => {
                const vocabHtml = Object.entries(q.vocab)
                    .map(([k, v]) => `<li><span class="font-semibold">${k}</span>: ${v}</li>`)
                    .join('');
                document.getElementById('hint-display').innerHTML = `<ul class="list-disc list-inside">${vocabHtml}</ul>`;
                q.hint2Count++;
            });

            document.getElementById('record-btn').addEventListener('click', toggleRecording);

            updateNavigation(index);
        }

        function updateNavigation(index) {
            progressIndicator.textContent = `${index + 1} / ${questions.length}`;
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === questions.length - 1;
            nextBtn.classList.toggle('hidden', index === questions.length - 1);
            finishBtn.classList.toggle('hidden', index !== questions.length - 1);
        }

        // âœ… ìˆ˜ì •ë¨: ì„œë²„ ì‘ë‹µì— ë§ê²Œ ë°ì´í„° ì²˜ë¦¬ ë°©ì‹ ë³€ê²½
        async function playAudio(text, voice) {
            const button = document.getElementById('play-audio-btn');
            if(!button) return;
            const icon = button.querySelector('i');
            icon.classList.remove('fa-volume-up');
            icon.classList.add('fa-spinner', 'fa-spin');
            button.disabled = true;

            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                // ì„œë²„ëŠ” { audioData, mimeType }ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
                const { audioData, mimeType } = await response.json();
                if (!audioData) {
                    throw new Error("No audio data received from server.");
                }

                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                audio.play();
                audio.onended = () => {
                    icon.classList.remove('fa-spinner', 'fa-spin');
                    icon.classList.add('fa-volume-up');
                    button.disabled = false;
                };
            } catch (error) {
                console.error('Error playing audio:', error);
                icon.classList.remove('fa-spinner', 'fa-spin');
                icon.classList.add('fa-volume-up');
                button.disabled = false;
            }
        }
        
        function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const recordStatus = document.getElementById('record-status');
            const icon = recordBtn.querySelector('i');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                icon.classList.remove('fa-stop-circle');
                icon.classList.add('fa-microphone');
                recordBtn.innerHTML = `<i class="fas fa-microphone"></i> ë…¹ìŒ ì‹œì‘`;
                recordStatus.textContent = 'ë…¹ìŒ ì™„ë£Œ! | Enregistrement terminÃ© !';
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        mediaRecorder.start();
                        audioChunks = [];
                        
                        icon.classList.remove('fa-microphone');
                        icon.classList.add('fa-stop-circle');
                        recordBtn.innerHTML = `<i class="fas fa-stop-circle"></i> ë…¹ìŒ ì¤‘ì§€`;
                        recordStatus.textContent = 'ë…¹ìŒ ì¤‘... | Enregistrement...';

                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener("stop", () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            
                            // For playback
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const playbackSection = document.getElementById('recording-playback-section');
                            const audioPlayer = document.getElementById('audio-playback');
                            if (playbackSection && audioPlayer) {
                                audioPlayer.src = audioUrl;
                                playbackSection.classList.remove('hidden');
                            }

                            // For sending results
                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = function() {
                                const base64String = reader.result.split(',')[1];
                                questions[currentQuestionIndex].recording = {
                                    base64: base64String,
                                    filename: `recording_${studentName.replace(/\s/g, '_')}_q${currentQuestionIndex + 1}.webm`,
                                    mimeType: 'audio/webm',
                                };
                            };
                            stream.getTracks().forEach(track => track.stop());
                        });
                    }).catch(err => {
                        console.error("Error accessing microphone:", err);
                        recordStatus.textContent = "ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜";
                    });
            }
        }

        function showResults() {
            endTime = new Date();
            const totalTimeSeconds = Math.round((endTime - startTime) / 1000);
            let correctCount = 0;

            questions.forEach((q, i) => {
                const cleanedUserAnswer = userAnswers[i].replace(/[.,\s]/g, '');
                const cleanedCorrectAnswer = q.ko.replace(/[.,\s]/g, '');
                if (cleanedUserAnswer === cleanedCorrectAnswer) {
                    q.isCorrect = true;
                    correctCount++;
                }
                q.userAnswer = userAnswers[i];
            });

            const score = (correctCount / questions.length) * 100;
            const feedback = gradingCriteria(score);

            let resultsHtml = `
                <h2 class="text-3xl font-bold text-slate-800 mb-2">${feedback.title.ko}</h2>
                <p class="text-lg text-slate-600 mb-4">${feedback.title.fr}</p>
                <p class="text-2xl font-semibold ${feedback.color} mb-6">${correctCount} / ${questions.length} (${score.toFixed(0)}%)</p>
                <div class="text-left max-h-60 overflow-y-auto pr-2">
            `;

            questions.forEach((q, i) => {
                resultsHtml += `
                    <div class="p-3 rounded-lg mb-3 ${q.isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                        <p class="font-semibold text-slate-700">Q${i + 1}: ${q.fr}</p>
                        <p class="text-sm ${q.isCorrect ? 'text-green-700' : 'text-red-700'}">
                            <i class="fas ${q.isCorrect ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ë‹¹ì‹ ì˜ ë‹µ: ${q.userAnswer || "ë‹µë³€ ì—†ìŒ"}
                        </p>
                        ${!q.isCorrect ? `<p class="text-sm text-blue-700"><span class="font-bold">ì—¬ê¸°ëŠ” ì‚´ì§ ì‚ë— ğŸ˜… â†’ ì´ë ‡ê²Œ í•˜ë©´ ì™„ë²½!</span><br>${q.ko}</p>` : ''}
                        <p class="text-sm text-slate-500 mt-1 border-t pt-1">
                            <i class="fas fa-keyboard"></i>
                            ë°›ì•„ì“°ê¸°: ${q.userDictation || "ì…ë ¥ ì—†ìŒ"}
                        </p>
                    </div>
                `;
            });

            resultsHtml += `
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="retry-btn" class="main-button">ë‹¤ì‹œí•˜ê¸° | Recommencer</button>
                    <button id="close-results-btn" class="nav-button">ë‹«ê¸° | Fermer</button>
                </div>
            `;

            resultsContent.innerHTML = resultsHtml;
            resultsModal.classList.remove('hidden');
            resultsModal.classList.add('flex');
            setTimeout(() => resultsContent.classList.add('scale-100'), 10);

            document.getElementById('retry-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
                resetQuiz();
            });
            document.getElementById('close-results-btn').addEventListener('click', () => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('flex');
                resultsContent.classList.remove('scale-100');
            });

            sendResults(totalTimeSeconds);
        }

        async function sendResults(totalTimeSeconds) {
            const payload = {
                studentName,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                totalTimeSeconds,
                questions,
            };

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    throw new Error('Failed to send results');
                }
                console.log('Results sent successfully.');
            } catch (error) {
                console.error('Error sending results:', error);
            }
        }
        
        function resetQuiz() {
            studentNameSection.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            navigationControls.classList.add('hidden');
            currentQuestionIndex = 0;
            studentNameInput.value = '';
            studentName = '';
        }

        // --- Event Listeners & Initializers ---
        
        // Open explanation section by default on page load
        window.addEventListener('load', () => {
            explanationContent.style.maxHeight = explanationContent.scrollHeight + "px";
            explanationIcon.classList.add('rotate-180');
        });

        startQuizBtn.addEventListener('click', () => {
            studentName = studentNameInput.value.trim();
            if (studentName) {
                startTime = new Date();
                studentNameSection.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                navigationControls.classList.add('flex');
                generateQuestions();
                renderQuestion(currentQuestionIndex);
            } else {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. | Veuillez entrer votre nom.');
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
            }
        });

        finishBtn.addEventListener('click', showResults);
        
        printButton.addEventListener('click', () => window.print());

        toggleExplanationBtn.addEventListener('click', () => {
            if (explanationContent.style.maxHeight) {
                explanationContent.style.maxHeight = null;
                explanationIcon.classList.remove('rotate-180');
            } else {
                explanationContent.style.maxHeight = explanationContent.scrollHeight + "px";
                explanationIcon.classList.add('rotate-180');
            }
        });
    </script>
</body>

</html>
