<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice de DictÃ©e : Comme en CorÃ©en</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#f3f4f6}
    .korean-font{font-family:'Gowun Dodum',sans-serif}
    .card{background:#fff;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / .1),0 2px 4px -2px rgb(0 0 0 / .1)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.6rem 1.2rem;border-radius:.75rem;font-weight:600;text-align:center;cursor:pointer;transition:all .2s;border:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover:not(:disabled){background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover:not(:disabled){background:#d1d5db}
    .btn-hint{background:#fefce8;color:#a16207;padding:.4rem .8rem;font-size:.875rem;border:1px solid #fde047}.btn-hint:hover:not(:disabled){background:#fef08a}
    .dictation-card{padding:1.5rem;border:1px solid #e5e7eb;border-radius:1rem;margin-bottom:1.5rem;background:#fff}
    .feedback{padding:1rem;border-radius:.75rem;margin-top:1rem;font-size:.95rem}
    .feedback.correct{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .feedback.incorrect{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
    .small-muted{font-size:.875rem;color:#6b7280}
    .made-by-top,.made-by-bottom{text-align:center}
    .pill{display:inline-block;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem}
    .pill-green{background:#e7f8ee;color:#0a7a3b;border:1px solid #9be4b8}
    .pill-red{background:#fde8e8;color:#9b1c1c;border:1px solid #f7b4b4}
    .row-gap{row-gap:.5rem}
    .spinner{width:18px;height:18px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media print {.no-print{display:none!important}}
    .btn-rec-recording{ background:#ef4444 !important; color:#fff !important; }
    .dot-rec{ width:10px;height:10px;border-radius:9999px;background:#ef4444;display:inline-block;animation:blink 1s infinite; }
    @keyframes blink { 50%{ opacity:.2 } }
  </style>
</head>
<body class="text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-3xl">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-2">DictÃ©e : Comme en CorÃ©en ğŸ§</h1>
      <p class="text-lg text-slate-600">Ã‰coutez â†’ Ã‰crivez en corÃ©en â†’ Traduisez en franÃ§ais â†’ Enregistrez votre prononciation.</p>
      <div class="mt-4 flex flex-wrap items-center justify-center gap-3 no-print">
        <button type="button" class="btn btn-secondary" onclick="window.print()" aria-label="Imprimer la page">ğŸ–¨ï¸ Imprimer / í˜ì´ì§€ ì¸ì‡„</button>
      </div>
      <div class="made-by-top mt-3 text-sm text-slate-500">
        made by <b>ì„±ì¼, Pongdang</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
      </div>
    </header>

    <section class="card mb-8 no-print">
      <label class="block font-semibold mb-2">Nom de l'Ã©tudiant / í•™ìƒ ì´ë¦„</label>
      <input id="student-name" type="text" class="w-full p-3 border-2 rounded-lg focus:border-indigo-500"
             placeholder="Ex. Camille, NoÃ©, ChloÃ©..." />
      <p class="small-muted mt-2">
        DÃ¨s le dÃ©but, nous enregistrons : votre nom, le nombre dâ€™Ã©coutes/indices/essais, et vos scores de prononciation.
        / ì‹œì‘í•˜ë©´ ì´ë¦„, ë“£ê¸°Â·íŒíŠ¸Â·ì‹œë„ íšŸìˆ˜, ë°œìŒ ì ìˆ˜ê¹Œì§€ ê¸°ë¡ë¼ìš”.
      </p>
    </section>

    <section id="explanations" class="mb-10 card">
      <h2 class="text-2xl font-bold mb-3 text-slate-700">Rappel : La RÃ¨gle d'Or ğŸ”‘</h2>
      <div class="space-y-2 text-slate-700">
        <p>ğŸ™‹â€â™€ï¸ <strong class="korean-font text-green-600">ê°™ì•„ìš”</strong> : â€œ~ì™€/ê³¼ ê°™ë‹¤â€ (ê°„ë‹¨ ë¹„êµ).</p>
        <p>âœï¸ <strong class="korean-font text-purple-600">ê°™ì€</strong> : ëª…ì‚¬ ìˆ˜ì‹(â€œ~ê°™ì€ + ëª…ì‚¬â€).</p>
        <p>ğŸƒâ€â™‚ï¸ <strong class="korean-font text-blue-600">ì²˜ëŸ¼ / ê°™ì´</strong> : ë™ì‘ ë¹„êµ(ë™ì‚¬ì™€ í•¨ê»˜). <span class="small-muted">ê°™ì´ëŠ” â€˜í•¨ê»˜â€™ ì˜ë¯¸ë„ ìˆì–´ìš”.</span></p>
      </div>
    </section>

    <section id="dictation-exercises"></section>

    <section class="mt-8 flex flex-wrap items-center gap-3 no-print">
      <button type="button" class="btn btn-secondary" id="restart-btn">â†º RÃ©essayer / ë‹¤ì‹œí•˜ê¸°</button>
      <button type="button" class="btn btn-primary" id="finish-btn">âœ… Terminer / ëë‚´ê¸°</button>
    </section>

    <div class="made-by-bottom mt-6 text-sm text-slate-500">
      made by <b>ì„±ì¼, Pongdang</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
    </div>
  </div>

  <script>
    const exercises = [
      { sentence: "ì²œì‚¬ ê°™ì•„ìš”.", translation: "Elle est comme un ange.", hint1: "ã…Šã…… ã„±ã…‡ã…‡", hint2: "ì²œì‚¬ = ange", voice: "Kore" },
      { sentence: "ì´ê±´ ê¿ˆ ê°™ì•„ìš”.", translation: "Ceci est comme un rÃªve.", hint1: "ã…‡ã„± ã„² ã„±ã…‡ã…‡", hint2: "ê¿ˆ = rÃªve", voice: "Puck" },
      { sentence: "ê°€ì¡± ê°™ì€ ì¹œêµ¬ì˜ˆìš”.", translation: "C'est une amie comme ma famille.", hint1: "ã„±ã…ˆ ã„±ã…‡ ã…Šã„±ã…‡ã…‡", hint2: "ê°€ì¡± = famille", voice: "Charon" },
      { sentence: "ë°”ë‹¤ ê°™ì€ ë„“ì€ ë§ˆìŒ.", translation: "Un coeur large comme la mer.", hint1: "ã…‚ã„· ã„±ã…‡ ã„´ã…‡ ã…ã…‡", hint2: "ë°”ë‹¤ = mer, ë„“ì€ = large", voice: "alloy" },
      { sentence: "ì†Œì²˜ëŸ¼ ë¨¹ì–´ìš”.", translation: "Il/Elle mange comme une vache.", hint1: "ã……ã…Šã„¹ ã…ã…‡ã…‡", hint2: "ì†Œ = vache", voice: "Fenrir" },
      { sentence: "ê·¸ ì‚¬ëŒì€ ë°”ëŒì²˜ëŸ¼ ë‹¬ë ¤ìš”.", translation: "Il court comme le vent.", hint1: "ã„±ã„´ ã…‚ã„¹ã…Šã„¹ ã„·ã„¹ã…‡", hint2: "ë°”ëŒ = vent", voice: "Orus" },
      { sentence: "ê°€ìˆ˜ê°™ì´ ë…¸ë˜ë¥¼ ì˜í•´ìš”.", translation: "Il/Elle chante bien comme un(e) chanteur(se).", hint1: "ã„±ã……ã„±ã…‡ ã„´ã„¹ã„¹ ã…ˆã…ã…‡", hint2: "ê°€ìˆ˜ = chanteur/chanteuse", voice: "Aoede" },
      { sentence: "ë¡œë´‡ê°™ì´ ê±¸ì–´ìš”.", translation: "Il/Elle marche comme un robot.", hint1: "ã„¹ã…‚ã„±ã…‡ ã„±ã…‡ã…‡", hint2: "ë¡œë´‡ = robot", voice: "Callirrhoe" },
      { sentence: "ì¹œêµ¬ë‘ ê°™ì´ ê°”ì–´ìš”.", translation: "Je suis allÃ©(e) avec mon ami(e).", hint1: "ã…Šã„±ã„¹ ã„±ã…‡ ã„±ã…‡ã…‡", hint2: "ê°™ì´ = â€˜ensembleâ€™", voice: "Zephyr" },
      { sentence: "ë³„ì²˜ëŸ¼ ì¶¤ì„ ì¶°ìš”.", translation: "Il/Elle danse comme une Ã©toile.", hint1: "ã…‚ã…Šã„¹ ã…Šã…‡ ã…Šã…‡", hint2: "ë³„ = Ã©toile", voice: "Enceladus" },
      { sentence: "ì˜¤ëŠ˜ì€ ì–´ì œ ê°™ì•„ìš”.", translation: "Aujourd'hui est comme hier.", hint1: "ã…‡ã„´ã…‡ ã…‡ã…ˆ ã„±ã…‡ã…‡", hint2: "ì–´ì œ = hier", voice: "Iapetus" },
      { sentence: "ê·¸ ì‚¬ëŒì€ ë°°ìš° ê°™ì•„ìš”.", translation: "Cette personne est comme un(e) acteur/actrice.", hint1: "ã„± ã……ã„¹ã…‡ ã…‚ã…‡ ã„±ã…‡ã…‡", hint2: "ë°°ìš° = acteur/actrice", voice: "Umbriel" },
      { sentence: "ì–¼ìŒ ê°™ì€ ì†.", translation: "Une main (froide) comme la glace.", hint1: "ã…‡ã…‡ ã„±ã…‡ ã……", hint2: "ì–¼ìŒ = glace", voice: "Despina" },
      { sentence: "ì„¤íƒ• ê°™ì€ ëª©ì†Œë¦¬.", translation: "Une voix (douce) comme le sucre.", hint1: "ã……ã…Œ ã„±ã…‡ ã…ã……ã„¹", hint2: "ì„¤íƒ• = sucre", voice: "Erinome" },
      { sentence: "ì¸í˜• ê°™ì€ ì•„ì´.", translation: "Un enfant comme une poupÃ©e.", hint1: "ã…‡ã… ã„±ã…‡ ã…‡ã…‡", hint2: "ì¸í˜• = poupÃ©e", voice: "Algenib" },
      { sentence: "ë¬¼ì²˜ëŸ¼ ëˆì„ ì¨ìš”.", translation: "Il/Elle dÃ©pense de l'argent comme de l'eau.", hint1: "ã…ã…Šã„¹ ã„·ã…‡ ã…†ã…‡", hint2: "ë¬¼ = eau", voice: "Rasalgethi" },
      { sentence: "ê±°ë¶ì´ì²˜ëŸ¼ ëŠë ¤ìš”.", translation: "Il/Elle est lent(e) comme une tortue.", hint1: "ã„±ã…‚ã…‡ã…Šã„¹ ã„´ã„¹ã…‡", hint2: "ê±°ë¶ì´ = tortue", voice: "Laomedeia" },
      { sentence: "ì „ë¬¸ê°€ì²˜ëŸ¼ ë§í•´ìš”.", translation: "Il/Elle parle comme un expert.", hint1: "ã…ˆã…ã„±ã…Šã„¹ ã…ã…ã…‡", hint2: "ì „ë¬¸ê°€ = expert", voice: "Achernar" },
      { sentence: "ì•„ê¸°ê°™ì´ ììš”.", translation: "Il/Elle dort comme un bÃ©bÃ©.", hint1: "ã…‡ã„±ã„±ã…‡ ã…ˆã…‡", hint2: "ì•„ê¸° = bÃ©bÃ©", voice: "Alnilam" },
      { sentence: "ì˜í™”ë°°ìš°ì²˜ëŸ¼ ì˜ìƒê²¼ì–´ìš”.", translation: "Il est beau comme un acteur de cinÃ©ma.", hint1: "ã…‡ã…ã…‚ã…‡ã…Šã„¹ ã…ˆã……ã„±ã…‡ã…‡", hint2: "ì˜í™”ë°°ìš° = acteur de cinÃ©ma", voice: "Schedar" }
    ];

    const audioCache = {};
    const recState = [];
    const exState = exercises.map(()=>({
      listenCount:0, hint1Count:0, hint2Count:0, attempts:0,
      koCorrect:false, frCorrect:false, pronunciation:null
    }));

    function base64ToBlob(base64, mimeType="audio/wav"){
      const bin=atob(base64); const len=bin.length; const bytes=new Uint8Array(len);
      for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i);
      return new Blob([bytes],{type:mimeType});
    }
    function blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(r.result.split(',')[1]);
        r.onerror=reject; r.readAsDataURL(blob);
      });
    }
    function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
    function normalizeHangul(s){
      return (s||'').normalize('NFC')
        .replace(/[.,!?~'"â€œâ€â€˜â€™:;()\[\]{}Â·â€¦]/g,'').replace(/\s+/g,'').replace(/[A-Za-z]/g,'');
    }
    function levenshtein(a,b){
      const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
      const dp=Array.from({length:m+1},(_,i)=>Array.from({length:n+1},(_,j)=>i? (j?0:j):i));
      for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){
        const cost=a[i-1]===b[j-1]?0:1;
        dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost);
      }
      return dp[m][n];
    }
    function styleHint(raw){
      const hasJeoneun=/(ì €ëŠ”|ì „)/.test(raw), hasNaneun=/(ë‚˜ëŠ”|ë‚œ)/.test(raw), politeEnd=/(ìš”|ë‹ˆë‹¤)[\s.]*$/.test(raw);
      if(hasJeoneun && !politeEnd) return "â€œì €ëŠ”/ì „â€ì„ ì¼ìœ¼ë©´ ë¬¸ì¥ ëì„ -ìš”/-(ìŠ¤)ã…‚ë‹ˆë‹¤ í˜•íƒœë¡œ ë§ì¶°ìš”.";
      if(hasNaneun && politeEnd) return "â€œë‚˜ëŠ”/ë‚œâ€ì„ ì¼ìœ¼ë©´ ë°˜ë§ë¡œ ëë‚´ìš”. -ìš”/-(ìŠ¤)ã…‚ë‹ˆë‹¤ëŠ” ì“°ì§€ ì•Šì•„ìš”.";
      return '';
    }

    async function getAudio(text, voice, button, index){
      try{
        button.disabled=true; button.innerHTML='<span class="spinner"></span>';
        if(audioCache[text] instanceof Blob){
          const url=URL.createObjectURL(audioCache[text]); const audio=new Audio(url);
          audio.onended=()=>URL.revokeObjectURL(url); exState[index].listenCount++; await audio.play(); return;
        }
        const res=await fetch('/.netlify/functions/generate-audio',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text,voice})
        });
        if(!res.ok) throw new Error('TTS API '+res.status);
        const {audioData,mimeType}=await res.json();
        if(!audioData || !mimeType || !mimeType.startsWith('audio/')) throw new Error('Invalid audio payload');
        const blob=base64ToBlob(audioData,mimeType); audioCache[text]=blob;
        const url=URL.createObjectURL(blob); const audio=new Audio(url);
        audio.onended=()=>URL.revokeObjectURL(url); exState[index].listenCount++; await audio.play();
      }catch(err){
        console.error(err); alert("DÃ©solÃ©, une erreur audio.");
        fetch('/.netlify/functions/log-error',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({functionName:'getAudio',error:String(err),pageUrl:location.href})}).catch(()=>{});
      }finally{
        button.disabled=false;
        button.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>`;
      }
    }

    function showHint(index, type){
      const hintDisplay=document.querySelectorAll('.hint-display')[index];
      const ex=exercises[index];
      if(type===1){
        hintDisplay.innerHTML=`<p class="text-sm text-amber-700 korean-font"><strong>ğŸ™ Aidez-moi (ì´ˆì„±) :</strong> ${ex.hint1}</p>`;
        document.querySelectorAll('.hint1-btn')[index].disabled=true; exState[index].hint1Count++;
      }else{
        const prev=hintDisplay.querySelector('p:first-child')?.outerHTML||'';
        hintDisplay.innerHTML=prev+`<p class="text-sm text-amber-700 korean-font mt-1"><strong>ğŸ¦º Au secours (ë‹¨ì–´) :</strong> ${ex.hint2}</p>`;
        document.querySelectorAll('.hint2-btn')[index].disabled=true; exState[index].hint2Count++;
      }
    }

    function gradeBoth(index){
      const card=document.querySelectorAll('.dictation-card')[index];
      const koInput=card.querySelector('.input-ko');
      const frInput=card.querySelector('.input-fr');
      const feedback=card.querySelector('.feedback-display');
      const rawKO=koInput.value||''; const rawFR=frInput.value||'';
      const styleMsg=styleHint(rawKO);
      const romanWarn=/[A-Za-z]/.test(rawKO) ? "í•œê¸€ ë°œìŒ í‘œê¸° ë¡œë§ˆìëŠ” ì“°ì§€ ë§ˆì„¸ìš”. (ga, teun ë“±)" : "";

      const userK=normalizeHangul(rawKO); const corrK=normalizeHangul(exercises[index].sentence);
      let koCorrect = userK===corrK || userK.includes(corrK) || corrK.includes(userK);
      if(!koCorrect){ const d=levenshtein(userK,corrK), th=Math.max(1,Math.floor(corrK.length*0.1)); if(d<=th) koCorrect=true; }

      const userF=(rawFR||'').trim().toLowerCase().replace(/[.,!?;:()]/g,'').replace(/\s+/g,' ');
      const corrF=(exercises[index].translation||'').trim().toLowerCase().replace(/[.,!?;:()]/g,'').replace(/\s+/g,' ');
      let frCorrect = userF===corrF;
      if(!frCorrect){ const d=levenshtein(userF,corrF), th=Math.max(1,Math.floor(corrF.length*0.1)); if(d<=th) frCorrect=true; }

      exState[index].attempts++; exState[index].koCorrect=koCorrect; exState[index].frCorrect=frCorrect;

      const tags=[]; if(romanWarn) tags.push(`âš ï¸ ${romanWarn}`); if(styleMsg) tags.push(`ğŸ’¡ ${styleMsg}`);
      const koPill = koCorrect ? `<span class="pill pill-green">KO âœ“</span>` : `<span class="pill pill-red">KO âœ—</span>`;
      const frPill = frCorrect ? `<span class="pill pill-green">FR âœ“</span>` : `<span class="pill pill-red">FR âœ—</span>`;

      const ok = koCorrect && frCorrect;
      feedback.innerHTML = ok ? `
        <div class="feedback correct">
          <strong class="text-lg">ğŸ¥³ TrÃ¨s bien ! (ë‘ í•­ëª© ëª¨ë‘ OK)</strong>
          <div class="mt-1 flex gap-2">${koPill}${frPill}</div>
          <p class="korean-font mt-1"><strong>ì •ë‹µ(í•œ):</strong> ${exercises[index].sentence}</p>
          <p><strong>Traduction (FR):</strong> ${exercises[index].translation}</p>
          ${tags.length?`<p class="small-muted mt-1">${tags.join(' Â· ')}</p>`:''}
        </div>
      ` : `
        <div class="feedback incorrect">
          <strong class="text-lg">ğŸ™‚ ê±°ì˜ ë‹¤ ì™”ì–´ìš”. ë‹¤ì‹œ ì‹œë„!</strong>
          <div class="mt-1 flex gap-2">${koPill}${frPill}</div>
          <p class="korean-font mt-1"><strong>ë‚´ ë‹µ(í•œ):</strong> ${escapeHtml(rawKO)}</p>
          <p><strong>Ma rÃ©ponse (FR):</strong> ${escapeHtml(rawFR)}</p>
          <p class="korean-font"><strong>ì •ë‹µ(í•œ):</strong> ${exercises[index].sentence}</p>
          <p><strong>Traduction (FR):</strong> ${exercises[index].translation}</p>
          ${tags.length?`<p class="small-muted mt-1">${tags.join(' Â· ')}</p>`:''}
        </div>
      `;
    }

    async function startRecord(index){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        const rec=new MediaRecorder(stream,{mimeType:'audio/webm'});

        const card=document.querySelectorAll('.dictation-card')[index];
        const btnStart=card.querySelector('.btn-rec-start');
        const btnStop=card.querySelector('.btn-rec-stop');
        const canvas=card.querySelector('.vu-canvas');
        const ctx=canvas.getContext('2d');

        const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const src=audioCtx.createMediaStreamSource(stream);
        const analyser=audioCtx.createAnalyser();
        analyser.fftSize=1024; const data=new Uint8Array(analyser.fftSize);
        src.connect(analyser);

        recState[index]={recorder:rec,chunks:[],startAt:Date.now(),stream,audioCtx,analyser,vuCanvas:canvas,rafId:null};

        btnStart.classList.add('btn-rec-recording');
        btnStart.innerHTML='ğŸ”´ Enregistrementâ€¦ / ë…¹ìŒ ì¤‘ <span class="dot-rec"></span>';
        btnStart.disabled=true; btnStop.disabled=false;

        const draw=()=>{
          analyser.getByteTimeDomainData(data);
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.beginPath();
          for(let x=0;x<canvas.width;x++){
            const i=Math.floor(x/canvas.width*data.length);
            const y=(data[i]/255)*canvas.height;
            if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.strokeStyle='#2563eb'; ctx.lineWidth=2; ctx.stroke();
          recState[index].rafId=requestAnimationFrame(draw);
        };
        draw();

        rec.ondataavailable=e=>{ if(e.data.size>0) recState[index].chunks.push(e.data); };
        rec.onstop=()=>{ /* cleanup handled in stopAndAnalyze */ };
        rec.start();

      }catch(err){
        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•´ìš” / Autorisez le micro.');
        console.error(err);
      }
    }

    async function stopAndAnalyze(index){
      const state=recState[index];
      if(!state || !state.recorder) return;

      const {recorder,stream,audioCtx,analyser,vuCanvas,rafId,startAt,chunks}=state;
      const card=document.querySelectorAll('.dictation-card')[index];
      const btnStart=card.querySelector('.btn-rec-start');
      const btnStop=card.querySelector('.btn-rec-stop');
      const area=card.querySelector('.pronun-display');
      const ctx=vuCanvas.getContext('2d');

      btnStop.disabled=true;
      area.innerHTML = `<div class="small-muted">â³ Analyse de la prononciation... / ë°œìŒ ë¶„ì„ ì¤‘...</div>`;

      recorder.onstop = async ()=>{
        try{
          if(rafId) cancelAnimationFrame(rafId);
          analyser.disconnect(); stream.getTracks().forEach(t=>t.stop());
          try{ await audioCtx.close(); }catch(_){}

          ctx.clearRect(0,0,vuCanvas.width,vuCanvas.height);

          const blob=new Blob(chunks,{type:'audio/webm'});
          const base64=await blobToBase64(blob);
          const correct=exercises[index].sentence;
          const durationSec=Math.max(0,Math.round((Date.now()-startAt)/1000));

          const res=await fetch('/.netlify/functions/analyze-pronunciation',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              referenceText: correct,
              audio:{ base64, mimeType:'audio/webm', filename:`rec_${index+1}.webm`, duration:durationSec }
            })
          });
          if(!res.ok) throw new Error('STT '+res.status);
          const data=await res.json();

          exState[index].pronunciation={
            accuracy:data.accuracy,
            confusionTags:data.confusionTags||[],
            transcript:data.transcript,
            audio:{ base64, mimeType:'audio/webm', filename:`rec_${index+1}.webm`, duration:durationSec }
          };

          const pct=Math.round((data.accuracy||0)*100);
          const tags=(data.confusionTags||[]).length? ` Â· Confusions dÃ©tectÃ©es / í˜¼ë™: ${data.confusionTags.join(', ')}`:'';
          const pill = pct>=85
            ? `<div class="pill pill-green">PrÃ©cision de prononciation ${pct}% / ë°œìŒ ì •í™•ë„ ${pct}%</div>`
            : `<div class="pill pill-red">PrÃ©cision de prononciation ${pct}% / ë°œìŒ ì •í™•ë„ ${pct}%</div>`;
          area.innerHTML = `${pill}<div class="small-muted mt-1">${tags}</div>`;

        }catch(err){
          console.error(err);
          area.innerHTML=`<div class="pill pill-red">Ã‰chec de l'analyse / ë¶„ì„ ì‹¤íŒ¨</div>`;
          fetch('/.netlify/functions/log-error',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({functionName:'analyze-pronunciation', error:String(err), pageUrl:location.href, index})}).catch(()=>{});
        }finally{
          recState[index]=null;
          btnStart.classList.remove('btn-rec-recording');
          btnStart.innerHTML='ğŸ™ï¸ Enregistrer / ë…¹ìŒ';
          btnStart.disabled=false; btnStop.disabled=false;
        }
      };
      recorder.stop();
    }

    function renderExercises(){
      const container=document.getElementById('dictation-exercises');
      container.innerHTML='';
      exercises.forEach((ex,index)=>{
        const el=document.createElement('div');
        el.className='dictation-card';
        el.innerHTML=`
          <div class="flex items-center gap-4">
            <span class="text-2xl font-bold text-indigo-500">${index+1}</span>
            <button data-sentence="${ex.sentence}" data-voice="${ex.voice}" class="btn btn-primary play-btn" aria-label="Lire l'audio de la phrase ${index+1}">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>
            </button>
            <div class="text-sm text-slate-500">
              Ã‰couter / ë“£ê¸° â†’ KO(í•œê¸€) â†’ FR(ë¶ˆì–´) â†’ ğŸ™ï¸ ë…¹ìŒ
            </div>
          </div>

          <div class="mt-3 ml-12 grid gap-3">
            <input type="text" class="input-ko korean-font text-lg p-2 border-2 border-slate-300 rounded-lg w-full focus:border-indigo-500" placeholder="Ã‰crivez ici (í•œê¸€ë¡œ)"/>
            <input type="text" class="input-fr text-lg p-2 border-2 border-slate-300 rounded-lg w-full focus:border-indigo-500" placeholder="Traduction en franÃ§ais / ë¶ˆì–´ë¡œ ë²ˆì—­"/>
            <div class="flex items-center gap-2 row-gap">
              <button class="btn btn-hint hint1-btn">ğŸ™ Aidez-moi (ì´ˆì„±)</button>
              <button class="btn btn-hint hint2-btn">ğŸ¦º Au secours (ë‹¨ì–´)</button>
              <button class="btn btn-secondary check-btn">VÃ©rifier (ì •ë‹µ í™•ì¸)</button>
            </div>
            <div class="hint-display"></div>
            <div class="feedback-display"></div>

            <div class="mt-3 flex flex-wrap items-center gap-2 no-print">
              <button class="btn btn-primary btn-rec-start">ğŸ™ï¸ Enregistrer / ë…¹ìŒ</button>
              <button class="btn btn-secondary btn-rec-stop" disabled>â¹ï¸ ArrÃªter & Analyser / ì •ì§€Â·ë¶„ì„</button>
              <canvas class="vu-canvas" width="160" height="24" style="background:#f1f5f9;border-radius:6px"></canvas>
              <div class="pronun-display small-muted"></div>
            </div>
          </div>
        `;
        container.appendChild(el);
      });
      addEvents();
    }

    function addEvents(){
      document.querySelectorAll('.play-btn').forEach((btn,i)=>{
        btn.addEventListener('click',e=>{
          const b=e.currentTarget; getAudio(b.dataset.sentence,b.dataset.voice,b,i);
        });
      });
      document.querySelectorAll('.hint1-btn').forEach((btn,i)=>btn.addEventListener('click',()=>showHint(i,1)));
      document.querySelectorAll('.hint2-btn').forEach((btn,i)=>btn.addEventListener('click',()=>showHint(i,2)));
      document.querySelectorAll('.check-btn').forEach((btn,i)=>btn.addEventListener('click',()=>gradeBoth(i)));
      document.querySelectorAll('.btn-rec-start').forEach((btn,i)=>btn.addEventListener('click',()=>startRecord(i)));
      document.querySelectorAll('.btn-rec-stop').forEach((btn,i)=>btn.addEventListener('click',()=>stopAndAnalyze(i)));
      document.querySelectorAll('.input-ko,.input-fr').forEach((inp,i)=>{ inp.addEventListener('keydown',e=>{ if(e.key==='Enter') gradeBoth(i); }); });
    }

    document.getElementById('restart-btn').addEventListener('click',()=>{
      document.querySelectorAll('.input-ko,.input-fr').forEach(i=>i.value='');
      document.querySelectorAll('.hint-display,.feedback-display,.pronun-display').forEach(d=>d.innerHTML='');
      document.querySelectorAll('.hint1-btn,.hint2-btn').forEach(b=>b.disabled=false);
      for(const s of exState) Object.assign(s,{listenCount:0,hint1Count:0,hint2Count:0,attempts:0,koCorrect:false,frCorrect:false,pronunciation:null});
    });

    document.getElementById('finish-btn').addEventListener('click',async()=>{
      const name=(document.getElementById('student-name').value||'').trim()||'N/A';
      const total=exercises.length*2;
      const got=exState.reduce((acc,s)=>acc+(s.koCorrect?1:0)+(s.frCorrect?1:0),0);
      const score=Math.round((got/total)*100);
      const pronuArr=exState.filter(s=>s.pronunciation);
      const avgPronun = (pronuArr.reduce((a,s)=>a+(s.pronunciation.accuracy||0),0) / Math.max(1,pronuArr.length))*100;
      alert(`ì´ì : ${score}/100 (í•œêµ­ì–´+ë¶ˆì–´)\nMoyenne de prononciation: ${isFinite(avgPronun)?Math.round(avgPronun):0}%`);

      try{
        const payload={
          studentName:name,
          startTime: window._startTime || new Date().toISOString(),
          endTime: new Date().toISOString(),
          totalTimeSeconds: Math.round(((Date.now())-(window._startMs||Date.now()))/1000),
          questions: exercises.map((ex,i)=>{
            const card=document.querySelectorAll('.dictation-card')[i];
            const ko=card.querySelector('.input-ko').value||'';
            const fr=card.querySelector('.input-fr').value||'';
            const pron=exState[i].pronunciation;
            return {
              number:i+1, ko: ex.sentence, fr: ex.translation,
              userAnswer: ko, userAnswerFr: fr,
              isCorrect: exState[i].koCorrect && exState[i].frCorrect,
              isCorrectKo: exState[i].koCorrect, isCorrectFr: exState[i].frCorrect,
              listenCount: exState[i].listenCount, hint1Count: exState[i].hint1Count, hint2Count: exState[i].hint2Count,
              pronunciation: pron ? {
                accuracy: pron.accuracy, confusionTags: pron.confusionTags, transcript: pron.transcript
              } : null,
              recording: pron ? {
                base64: pron.audio.base64, filename: pron.audio.filename, mimeType: pron.audio.mimeType, duration: pron.audio.duration
              } : null
            };
          })
        };
        await fetch('/.netlify/functions/send-results',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      }catch(err){
        console.error(err);
        fetch('/.netlify/functions/log-error',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({functionName:'finish-send-results',error:String(err),pageUrl:location.href})}).catch(()=>{});
      }
    });

    window._startTime=new Date().toISOString();
    window._startMs=Date.now();
    renderExercises();
  </script>
</body>
</html>
