<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercice de DictÃ©e : Comme en CorÃ©en</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <script defer src="/assets/student-gate.js"></script>
  <script defer src="/assets/grading-criteria.js"></script>

  <!-- âœ… ì±„ì  ê³µìš© ëª¨ë“ˆ (ì „ì—­ ë˜ëŠ” ESM ì–´ëŠ ìª½ì´ë“  ë¡œë”ê°€ ë³´ê°•) -->
  <script defer src="/assets/answer-judge.js"></script>

  <!-- ë°œìŒ ë¶„ì„(ì„ íƒ) -->
  <script defer src="/assets/pronun-utils.js"></script>
  <script defer src="/assets/pronun-vowel-middleware.js"></script>
  <script defer src="/assets/pronun-client.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#f3f4f6}
    .korean-font{font-family:'Gowun Dodum',sans-serif}
    .card{background:#fff;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 /.1),0 2px 4px -2px rgb(0 0 0 /.1)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.6rem 1.2rem;border-radius:.75rem;font-weight:600;text-align:center;cursor:pointer;transition:all .2s;border:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover:not(:disabled){background:#2563eb}
    .btn-secondary{background:#e5e7eb;color:#374151}.btn-secondary:hover:not(:disabled){background:#d1d5db}
    .btn-hint{background:#fefce8;color:#a16207;padding:.4rem .8rem;font-size:.875rem;border:1px solid #fde047}.btn-hint:hover:not(:disabled){background:#fef08a}
    .dictation-card{padding:1.5rem;border:1px solid #e5e7eb;border-radius:1rem;margin-bottom:1.5rem;background:#fff}
    .feedback{padding:1rem;border-radius:.75rem;margin-top:1rem;font-size:.95rem}
    .feedback.correct{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .feedback.incorrect{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
    .small-muted{font-size:.875rem;color:#6b7280}
    .pill{display:inline-block;border-radius:9999px;padding:.25rem .6rem;font-size:.8rem}
    .pill-green{background:#e7f8ee;color:#0a7a3b;border:1px solid #9be4b8}
    .pill-red{background:#fde8e8;color:#9b1c1c;border:1px solid #f7b4b4}
    .spinner{width:18px;height:18px;border:3px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media print {.no-print{display:none!important}}
  </style>
</head>
<body class="text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-3xl">
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-2">DictÃ©e : Comme en CorÃ©en ğŸ§</h1>
      <p class="text-lg text-slate-600">Ã‰coutez â†’ Ã‰crivez en corÃ©en â†’ Traduisez en franÃ§ais â†’ Enregistrez votre prononciation.</p>
      <div class="mt-4 flex flex-wrap items-center justify-center gap-3 no-print">
        <button type="button" class="btn btn-secondary" onclick="window.print()" aria-label="Imprimer la page">ğŸ–¨ï¸ Imprimer / í˜ì´ì§€ ì¸ì‡„</button>
      </div>
      <div class="mt-3 text-sm text-slate-500 text-center">
        made by <b>ì„±ì¼, Pongdang</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
      </div>
    </header>

    <section class="card mb-8 no-print">
      <label class="block font-semibold mb-2">Nom de l'Ã©tudiant / í•™ìƒ ì´ë¦„</label>
      <input id="student-name" type="text" class="w-full p-3 border-2 rounded-lg focus:border-indigo-500" placeholder="Ex. Camille, NoÃ©, ChloÃ©..." />
      <p class="small-muted mt-2">
        Nous enregistrons : votre nom, le nombre dâ€™Ã©coutes/indices/essais, et vos scores de prononciation. /
        ì‹œì‘í•˜ë©´ ì´ë¦„, ë“£ê¸°Â·íŒíŠ¸Â·ì‹œë„ íšŸìˆ˜, ë°œìŒ ì ìˆ˜ê¹Œì§€ ê¸°ë¡ë¼ìš”.
      </p>
    </section>

    <section id="explanations" class="mb-10 card">
      <h2 class="text-2xl font-bold mb-3 text-slate-700">â€œCommeâ€ â€” Je dÃ©cris quoi ? / ë¬´ì—‡ì„ â€˜ì²˜ëŸ¼/ê°™ì´/ê°™ë‹¤â€™ë¡œ ë§í•˜ë‚˜ìš”?</h2>
      <div class="space-y-3 text-slate-700">
        <p class="text-slate-600">
          <strong>Commeâ€¦</strong> dÃ©crit <u>quoi</u> ? â†’
          <span class="inline-block bg-indigo-50 px-2 py-0.5 rounded">un verbe (une action)</span>
          ou <span class="inline-block bg-indigo-50 px-2 py-0.5 rounded">un nom</span>
          ou <span class="inline-block bg-indigo-50 px-2 py-0.5 rounded">le verbe â€œÃªtreâ€</span> ?
        </p>
        <ul class="list-disc pl-6 space-y-1">
          <li><span class="font-semibold">nom + comme</span> â†’ <span class="korean-font">ëª…ì‚¬ + ì²˜ëŸ¼/ê°™ì´</span></li>
          <li><span class="font-semibold">Ãªtre + comme</span> â†’ <span class="korean-font">~ì™€/ê³¼ ê°™ë‹¤</span></li>
          <li><span class="font-semibold">verbe/adj + comme</span> â†’ <span class="korean-font">ë™ì‚¬ + ì²˜ëŸ¼/ê°™ì´</span></li>
        </ul>
      </div>
    </section>

    <section id="dictation-exercises"></section>

    <section class="mt-8 flex flex-wrap items-center gap-3 no-print">
      <button type="button" class="btn btn-secondary" id="restart-btn">â†º RÃ©essayer / ë‹¤ì‹œí•˜ê¸°</button>
      <button type="button" class="btn btn-primary" id="finish-btn">âœ… Terminer / ëë‚´ê¸°</button>
    </section>

    <div class="mt-6 text-sm text-slate-500 text-center">
      made by <b>ì„±ì¼, Pongdang</b> Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
    </div>
  </div>

  <script>
  // ---------- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë³´ê°• ë¡œë” (ESM/ì „ì—­ ë‘˜ ë‹¤ ì»¤ë²„) ----------
  async function ensureLibs() {
    if (!window.AnswerJudge) {
      try {
        const m = await import('/assets/answer-judge.js?v=' + Date.now());
        window.AnswerJudge = window.AnswerJudge || m.default || m.AnswerJudge || m;
      } catch (e) { console.warn('AnswerJudge import fail:', e); }
    }
    if (!window.Pronun) {
      try {
        const m = await import('/assets/pronun-client.js?v=' + Date.now());
        window.Pronun = window.Pronun || m.default || m.Pronun || m;
      } catch (e) { console.warn('Pronun import fail:', e); }
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // ---- ì´ë¦„ ë™ê¸°í™” ----
    (window.StudentGate||={init(){},requireBeforeInteraction(){},getName(){return''},setName(){}}).init();
    StudentGate.requireBeforeInteraction(document);
    const $name = document.getElementById('student-name');
    const syncName = () => { $name.value = StudentGate.getName() || ''; };
    document.addEventListener('student-ready', syncName);
    $name.addEventListener('change', e => {
      const v = String(e.target.value||'').trim();
      if (v) StudentGate.setName(v);
    });

    // ---- ë©”íƒ€ ----
    const ASSIGNMENT_META = {
      assignmentTitle: "DictÃ©e â€“ Comme en corÃ©en",
      assignmentTopic: "ê°™ì•„ìš” / ê°™ì€ / ì²˜ëŸ¼ / ê°™ì´",
      assignmentSummary: [
        "Comparaison de deux noms: Ãªtre comme (ê°™ì•„ìš”)",
        "Nom + ê°™ì€ (qui est comme â€¦)",
        "Comparer une action: verbe + ì²˜ëŸ¼/ê°™ì´ (Â« ê°™ì´ Â» = ensemble)"
      ]
    };

    // ---- ë¬¸í•­ ----
    const exercises = [
      { sentence: "ì²œì‚¬ ê°™ì•„ìš”.", translation: "Elle est comme un ange.", hint1:"ã…Šã…… ã„±ã…‡ã…‡", hint2:"ì²œì‚¬ = ange", voice:"alloy" },
      { sentence: "ì´ê±´ ê¿ˆ ê°™ì•„ìš”.", translation: "Ceci est comme un rÃªve.", hint1:"ã…‡ã„± ã„² ã„±ã…‡ã…‡", hint2:"ê¿ˆ = rÃªve", voice:"Puck" },
      { sentence: "ê°€ì¡± ê°™ì€ ì¹œêµ¬ì˜ˆìš”.", translation: "C'est une amie comme ma famille.", hint1:"ã„±ã…ˆ ã„±ã…‡ ã…Šã„±ã…‡ã…‡", hint2:"ê°€ì¡± = famille", voice:"Charon" },
      { sentence: "ë°”ë‹¤ ê°™ì€ ë„“ì€ ë§ˆìŒ.", translation: "Un coeur large comme la mer.", hint1:"ã…‚ã„· ã„±ã…‡ ã„´ã…‡ ã…ã…‡", hint2:"ë°”ë‹¤ = mer", voice:"alloy" },
      { sentence: "ì†Œì²˜ëŸ¼ ë¨¹ì–´ìš”.", translation: "Il/Elle mange comme une vache.", hint1:"ã……ã…Šã„¹ ã…ã…‡ã…‡", hint2:"ì†Œ = vache", voice:"Fenrir" },
      { sentence: "ê·¸ ì‚¬ëŒì€ ë°”ëŒì²˜ëŸ¼ ë‹¬ë ¤ìš”.", translation: "Il court comme le vent.", hint1:"ã„±ã„´ ã…‚ã„¹ã…Šã„¹ ã„·ã„¹ã…‡", hint2:"ë°”ëŒ = vent", voice:"Orus" },
      { sentence: "ê°€ìˆ˜ê°™ì´ ë…¸ë˜ë¥¼ ì˜í•´ìš”.", translation: "Il/Elle chante bien comme un(e) chanteur(se).", hint1:"ã„±ã……ã„±ã…‡ ã„´ã„¹ã„¹ ã…ˆã…ã…‡", hint2:"ê°€ìˆ˜ = chanteur", voice:"Aoede" },
      { sentence: "ë¡œë´‡ê°™ì´ ê±¸ì–´ìš”.", translation: "Il/Elle marche comme un robot.", hint1:"ã„¹ã…‚ã„±ã…‡ ã„±ã…‡ã…‡", hint2:"ë¡œë´‡ = robot", voice:"Callirrhoe" },
      { sentence: "ì¹œêµ¬ë‘ ê°™ì´ ê°”ì–´ìš”.", translation: "Je suis allÃ©(e) avec mon ami(e).", hint1:"ã…Šã„±ã„¹ ã„±ã…‡ ã„±ã…‡ã…‡", hint2:"ê°™ì´ = ensemble", voice:"Zephyr" },
      { sentence: "ë³„ì²˜ëŸ¼ ì¶¤ì„ ì¶°ìš”.", translation: "Il/Elle danse comme une Ã©toile.", hint1:"ã…‚ã…Šã„¹ ã…Šã…‡ ã…Šã…‡", hint2:"ë³„ = Ã©toile", voice:"Enceladus" },
      { sentence: "ì˜¤ëŠ˜ì€ ì–´ì œ ê°™ì•„ìš”.", translation: "Aujourd'hui est comme hier.", hint1:"ã…‡ã„´ã…‡ ã…‡ã…ˆ ã„±ã…‡ã…‡", hint2:"ì–´ì œ = hier", voice:"Iapetus" },
      { sentence: "ê·¸ ì‚¬ëŒì€ ë°°ìš° ê°™ì•„ìš”.", translation: "Cette personne est comme un(e) acteur/actrice.", hint1:"ã„± ã……ã„¹ã…‡ ã…‚ã…‡ ã„±ã…‡ã…‡", hint2:"ë°°ìš° = acteur", voice:"Umbriel" },
      { sentence: "ì–¼ìŒ ê°™ì€ ì†.", translation: "Une main (froide) comme la glace.", hint1:"ã…‡ã…‡ ã„±ã…‡ ã……", hint2:"ì–¼ìŒ = glace", voice:"Despina" },
      { sentence: "ì„¤íƒ• ê°™ì€ ëª©ì†Œë¦¬.", translation: "Une voix (douce) comme le sucre.", hint1:"ã……ã…Œ ã„±ã…‡ ã…ã……ã„¹", hint2:"ì„¤íƒ• = sucre", voice:"Erinome" },
      { sentence: "ì¸í˜• ê°™ì€ ì•„ì´.", translation: "Un enfant comme une poupÃ©e.", hint1:"ã…‡ã… ã„±ã…‡ ã…‡ã…‡", hint2:"ì¸í˜• = poupÃ©e", voice:"Algenib" },
      { sentence: "ë¬¼ì²˜ëŸ¼ ëˆì„ ì¨ìš”.", translation: "Il/Elle dÃ©pense de l'argent comme de l'eau.", hint1:"ã…ã…Šã„¹ ã„·ã…‡ ã…†ã…‡", hint2:"ë¬¼ = eau", voice:"Rasalgethi" },
      { sentence: "ê±°ë¶ì´ì²˜ëŸ¼ ëŠë ¤ìš”.", translation: "Il/Elle est lent(e) comme une tortue.", hint1:"ã„±ã…‚ã…‡ã…Šã„¹ ã„´ã„¹ã…‡", hint2:"ê±°ë¶ì´ = tortue", voice:"Laomedeia" },
      { sentence: "ì „ë¬¸ê°€ì²˜ëŸ¼ ë§í•´ìš”.", translation: "Il/Elle parle comme un expert.", hint1:"ã…ˆã…ã„±ã…Šã„¹ ã…ã…ã…‡", hint2:"ì „ë¬¸ê°€ = expert", voice:"Achernar" },
      { sentence: "ì•„ê¸°ê°™ì´ ììš”.", translation: "Il/Elle dort comme un bÃ©bÃ©.", hint1:"ã…‡ã„±ã„±ã…‡ ã…ˆã…‡", hint2:"ì•„ê¸° = bÃ©bÃ©", voice:"Alnilam" },
      { sentence: "ì˜í™”ë°°ìš°ì²˜ëŸ¼ ì˜ìƒê²¼ì–´ìš”.", translation: "Il est beau comme un acteur de cinÃ©ma.", hint1:"ã…‡ã…ã…‚ã…‡ã…Šã„¹ ã…ˆã……ã„±ã…‡ã…‡", hint2:"ì˜í™”ë°°ìš° = acteur de cinÃ©ma", voice:"Schedar" }
    ];

    // ---- ìƒíƒœ/ì˜¤ë””ì˜¤ ----
    const audioCache = {};
    const exState = exercises.map(() => ({
      listenCount:0, hint1Count:0, hint2Count:0, attempts:0,
      koCorrect:false, frCorrect:false, pronunciation:null
    }));

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function base64ToBlob(base64, mime="audio/wav") {
      const bin = atob(base64); const len = bin.length; const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      return new Blob([bytes], { type: mime });
    }

    async function playAudio(text, voice, btn, idx){
      try{
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
        const key = `${voice}|${text}`;
        if (audioCache[key] instanceof Blob){
          const url = URL.createObjectURL(audioCache[key]);
          const a = new Audio(url);
          a.onended = () => URL.revokeObjectURL(url);
          exState[idx].listenCount++; await a.play(); return;
        }
        const res = await fetch('/.netlify/functions/generate-audio', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text, voice })
        });
        if(!res.ok) throw new Error('TTS '+res.status);
        const { audioData, mimeType } = await res.json();
        const blob = base64ToBlob(audioData, mimeType||'audio/wav');
        audioCache[key] = blob;
        const url = URL.createObjectURL(blob);
        const a = new Audio(url);
        a.onended = () => URL.revokeObjectURL(url);
        exState[idx].listenCount++; await a.play();
      }catch(e){
        console.error(e);
        alert('DÃ©solÃ©, une erreur audio.');
        fetch('/.netlify/functions/log-error',{method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ functionName:'getAudio', error:String(e), pageUrl:location.href })}).catch(()=>{});
      }finally{
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”Š';
      }
    }

    function styleHint(raw){
      const hasJeoneun = /(ì €ëŠ”|ì „)/.test(raw), hasNaneun = /(ë‚˜ëŠ”|ë‚œ)/.test(raw);
      const politeEnd = /(ìš”|ë‹ˆë‹¤)[\s.]*$/.test(raw);
      if(hasJeoneun && !politeEnd) return "â€œì €ëŠ”/ì „â€ì„ ì¼ìœ¼ë©´ ë¬¸ì¥ ëì„ -ìš”/-(ìŠ¤)ã…‚ë‹ˆë‹¤ë¡œ.";
      if(hasNaneun && politeEnd) return "â€œë‚˜ëŠ”/ë‚œâ€ì„ ì¼ìœ¼ë©´ ë°˜ë§(-ì•„/ì–´)ë¡œ ëë‚´ìš”.";
      return '';
    }

    function gradeBoth(index){
      if (!window.AnswerJudge) { alert('ì±„ì  ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨'); return; }
      const card = document.querySelectorAll('.dictation-card')[index];
      const koInput = card.querySelector('.input-ko');
      const frInput = card.querySelector('.input-fr');
      const feedback = card.querySelector('.feedback-display');

      const rawKO = koInput.value || '';
      const rawFR = frInput.value || '';

      // ë°›ì•„ì“°ê¸°: ë¶€ë¶„ í¬í•¨ í—ˆìš© âŒ (ìëª¨/ë°›ì¹¨ ë‹¤ë¥´ë©´ ì¦‰ì‹œ ì˜¤ë‹µ, ê³µë°±Â·êµ¬ë‘ì  â‰¤5% í—ˆìš©)
      const koRes = AnswerJudge.gradeKO(exercises[index].sentence, rawKO, { allowSubstring:false });

      // FR: ì•…ì„¼íŠ¸/êµ¬ë‘ì  ë¬´ì‹œ, ì˜ë¯¸ 90% ë˜ëŠ” ì˜¤íƒ€ â‰¤15%, ë¹ˆ ë‹µ âŒ
      const frRes = AnswerJudge.gradeFR(exercises[index].translation, rawFR);

      exState[index].attempts++;
      exState[index].koCorrect = koRes.isCorrect;
      exState[index].frCorrect = frRes.isCorrect;

      const romanWarn = /[A-Za-z]/.test(rawKO) ? "í•œê¸€ ë°œìŒ í‘œê¸° ë¡œë§ˆìëŠ” ì“°ì§€ ë§ˆì„¸ìš”.(ga, teun ë“±)" : "";
      const styleMsg = styleHint(rawKO);

      const tags = [];
      if (romanWarn) tags.push(`âš ï¸ ${romanWarn}`);
      if (styleMsg)  tags.push(`ğŸ’¡ ${styleMsg}`);
      if (koRes.note) tags.push(`KO: ${koRes.note}`);
      if (frRes.note) tags.push(`FR: ${frRes.note}`);

      const koPill = koRes.isCorrect ? `<span class="pill pill-green">KO âœ“</span>` : `<span class="pill pill-red">KO âœ—</span>`;
      const frPill = frRes.isCorrect ? `<span class="pill pill-green">FR âœ“</span>` : `<span class="pill pill-red">FR âœ—</span>`;

      const ok = koRes.isCorrect && frRes.isCorrect;
      feedback.innerHTML = ok ? `
        <div class="feedback correct">
          <strong class="text-lg">ğŸ‰ Super ! ì˜í–ˆì–´ìš”!</strong>
          <div class="mt-1 flex gap-2">${koPill}${frPill}</div>
          <p class="korean-font mt-1"><strong>ì •ë‹µ(í•œ):</strong> ${exercises[index].sentence}</p>
          <p><strong>Traduction (FR):</strong> ${exercises[index].translation}</p>
          ${tags.length?`<p class="small-muted mt-1">${tags.join(' Â· ')}</p>`:''}
        </div>
      ` : `
        <div class="feedback incorrect">
          <strong class="text-lg">ğŸ‘ ê±°ì˜ ë§ì•˜ì–´ìš”! í•œ ë²ˆë§Œ ë”! / Presque rÃ©ussiÂ·e ! RÃ©essaie ğŸ˜‰</strong>
          <div class="mt-1 flex gap-2">${koPill}${frPill}</div>
          <p class="korean-font mt-1"><strong>ë‚´ ë‹µ(í•œ):</strong> ${escapeHtml(rawKO)}</p>
          <p><strong>Ma rÃ©ponse (FR):</strong> ${escapeHtml(rawFR)}</p>
          <p class="korean-font"><strong>ì •ë‹µ(í•œ):</strong> ${exercises[index].sentence}</p>
          <p><strong>Traduction (FR):</strong> ${exercises[index].translation}</p>
          ${tags.length?`<p class="small-muted mt-1">${tags.join(' Â· ')}</p>`:''}
        </div>
      `;
    }

    // âœ… ì•ˆì „ ë Œë”(ì˜¤ë¥˜ ì¡ì•„ì„œ í‘œì‹œ + ì—ëŸ¬ ë©”ì¼ë§)
    function renderExercises(){
      const $wrap = document.getElementById('dictation-exercises');
      try{
        $wrap.innerHTML = '';
        exercises.forEach((ex, i) => {
          const el = document.createElement('div');
          el.className = 'dictation-card';
          el.innerHTML = `
            <div class="flex items-center gap-4">
              <span class="text-2xl font-bold text-indigo-500">${i+1}</span>
              <button type="button" class="btn btn-primary play-btn" data-voice="${ex.voice}" data-text="${ex.sentence}" aria-label="Lire l'audio ${i+1}">ğŸ”Š</button>
              <div class="text-sm text-slate-500">Ã‰couter / ë“£ê¸° â†’ KO(í•œê¸€) â†’ FR(ë¶ˆì–´)</div>
            </div>

            <div class="mt-3 ml-12 grid gap-3">
              <input type="text" class="input-ko korean-font text-lg p-2 border-2 border-slate-300 rounded-lg w-full focus:border-indigo-500" placeholder="Ã‰crivez ici (í•œê¸€ë¡œ)"/>
              <input type="text" class="input-fr text-lg p-2 border-2 border-slate-300 rounded-lg w-full focus:border-indigo-500" placeholder="Traduction en franÃ§ais / ë¶ˆì–´ë¡œ ë²ˆì—­"/>
              <div class="flex items-center gap-2">
                <button type="button" class="btn btn-hint hint1-btn">ğŸ™ Aidez-moi (ì´ˆì„±)</button>
                <button type="button" class="btn btn-hint hint2-btn">ğŸ¦º Au secours (ë‹¨ì–´)</button>
                <button type="button" class="btn btn-secondary check-btn">VÃ©rifier (ì •ë‹µ í™•ì¸)</button>
              </div>
              <div class="hint-display"></div>
              <div class="feedback-display"></div>
              <div class="pronun-display small-muted"></div>
            </div>
          `;
          $wrap.appendChild(el);
        });

        document.querySelectorAll('.play-btn').forEach((btn, i) => {
          btn.addEventListener('click', e => {
            const b = e.currentTarget;
            playAudio(b.dataset.text, b.dataset.voice, b, i);
          });
        });
        document.querySelectorAll('.hint1-btn').forEach((btn,i)=>btn.addEventListener('click',()=>{
          document.querySelectorAll('.hint-display')[i].innerHTML =
            `<p class="text-sm text-amber-700 korean-font"><strong>ğŸ™ Aidez-moi (ì´ˆì„±):</strong> ${exercises[i].hint1}</p>`;
          exState[i].hint1Count++;
          btn.disabled = true;
        }));
        document.querySelectorAll('.hint2-btn').forEach((btn,i)=>btn.addEventListener('click',()=>{
          const box = document.querySelectorAll('.hint-display')[i];
          const prev = box.querySelector('p')?.outerHTML || '';
          box.innerHTML = prev + `<p class="text-sm text-amber-700 korean-font mt-1"><strong>ğŸ¦º Au secours (ë‹¨ì–´):</strong> ${exercises[i].hint2}</p>`;
          exState[i].hint2Count++;
          btn.disabled = true;
        }));
        document.querySelectorAll('.check-btn').forEach((btn,i)=>btn.addEventListener('click',()=>gradeBoth(i)));
        document.querySelectorAll('.input-ko,.input-fr').forEach((inp,i)=>{
          inp.addEventListener('keydown',e=>{ if(e.key==='Enter') gradeBoth(i); });
        });

        if (window.Pronun && typeof Pronun.mount === 'function') {
          document.querySelectorAll('.dictation-card').forEach((cardEl, i) => {
            Pronun.mount(cardEl, {
              getReferenceText: () => exercises[i].sentence,
              isKoCorrect: () => exState[i].koCorrect,
              onResult: ({ accuracy, transcript, friendly }) => {
                exState[i].pronunciation = { accuracy, transcript: transcript||'', friendly: friendly||[] };
              }
            });
          });
        }
      } catch (err){
        console.error(err);
        $wrap.innerHTML = `
          <div class="card bg-red-50 border border-red-200 text-red-700">
            ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ë¡œ ë¬¸í•­ì„ í‘œì‹œí•˜ì§€ ëª»í–ˆì–´ìš”. ì½˜ì†”(DevTools)ì„ ì—´ì–´ ì—ëŸ¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.
          </div>`;
        fetch('/.netlify/functions/log-error', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ functionName:'renderExercises', error:String(err), pageUrl:location.href })
        }).catch(()=>{});
      }
    }

    // ë‹¤ì‹œí•˜ê¸°
    document.getElementById('restart-btn').addEventListener('click',()=>{
      document.querySelectorAll('.input-ko,.input-fr').forEach(i=>i.value='');
      document.querySelectorAll('.hint-display,.feedback-display,.pronun-display').forEach(d => { d.innerHTML = ''; });
      document.querySelectorAll('.btn-hint').forEach(b=>b.disabled=false);
      exState.forEach(s => Object.assign(s, { listenCount:0, hint1Count:0, hint2Count:0, attempts:0, koCorrect:false, frCorrect:false, pronunciation:null }));
    });

    // ëë‚´ê¸°(ì´ì ì€ KO+FR í‰ê· ë§Œ, ë°œìŒì€ í‘œì‹œì—ë§Œ ì‚¬ìš©)
    document.getElementById('finish-btn').addEventListener('click', async () => {
      const name = (StudentGate?.getName?.() || document.getElementById('student-name').value || '').trim() || 'N/A';

      const totalQ = exercises.length;
      const koCorrectCount = exState.filter(s => s.koCorrect).length;
      const frCorrectCount = exState.filter(s => s.frCorrect).length;
      const koScore = Math.round((koCorrectCount / Math.max(1,totalQ)) * 100);
      const frScore = Math.round((frCorrectCount / Math.max(1,totalQ)) * 100);

      const pronItems = exState.map(s => s.pronunciation?.accuracy).filter(x => typeof x === 'number' && isFinite(x));
      const pronScore = Math.round((pronItems.reduce((a,b)=>a+b,0) / Math.max(1,pronItems.length)) * 100);

      const overall = Math.round((koScore + frScore) / 2); // âœ… ë°œìŒ ë¯¸ë°˜ì˜
      const gm = (window.Grading?.getGradingMessage) ? window.Grading.getGradingMessage(overall) : null;

      alert(`${gm ? gm.emoji+' '+gm.fr+' / '+gm.ko+'\n' : ''}`
        + `ì´ì : ${overall}/100 (KO+FR)\n`
        + `í•œê¸€ ë°›ì•„ì“°ê¸°: ${koScore}/100\n`
        + `ë¶ˆì–´ ë²ˆì—­: ${frScore}/100\n`
        + `ë°œìŒ: ${isFinite(pronScore)?pronScore:0}/100`);

      try {
        const payload = {
          studentName: name,
          startTime: window._startTime || new Date().toISOString(),
          endTime: new Date().toISOString(),
          totalTimeSeconds: Math.round(((Date.now()) - (window._startMs || Date.now())) / 1000),
          assignmentTitle: ASSIGNMENT_META.assignmentTitle,
          assignmentTopic: ASSIGNMENT_META.assignmentTopic,
          assignmentSummary: ASSIGNMENT_META.assignmentSummary,
          gradingMessage: gm,
          categoryScores: { ko: koScore, fr: frScore, pron: pronScore, overall },
          questions: exercises.map((ex,i)=>{
            const card = document.querySelectorAll('.dictation-card')[i];
            return {
              number: i+1, ko: ex.sentence, fr: ex.translation,
              userAnswer: card.querySelector('.input-ko').value || '',
              userAnswerFr: card.querySelector('.input-fr').value || '',
              isCorrect: exState[i].koCorrect && exState[i].frCorrect,
              isCorrectKo: exState[i].koCorrect,
              isCorrectFr: exState[i].frCorrect,
              listenCount: exState[i].listenCount,
              hint1Count: exState[i].hint1Count,
              hint2Count: exState[i].hint2Count,
              pronunciation: exState[i].pronunciation || null,
              recording: null
            };
          })
        };
        const resp = await fetch('/.netlify/functions/send-results', {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        let j = {}; try { j = await resp.json(); } catch {}
        if (!resp.ok || j.ok === false) {
          alert("âš ï¸ ì „ì†¡ ì‹¤íŒ¨ / Envoi Ã©chouÃ©.");
          fetch('/.netlify/functions/log-error', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ functionName:'send-results', error:`HTTP ${resp.status} ${resp.statusText} | ${JSON.stringify(j)}`, pageUrl:location.href })
          }).catch(()=>{});
        } else {
          alert("âœ… ê²°ê³¼ê°€ ë©”ì¼ë¡œ ì „ì†¡ëì–´ìš” ! / RÃ©sultats envoyÃ©s par e-mail !");
        }
      } catch (err) {
        console.error(err);
        fetch('/.netlify/functions/log-error', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ functionName:'finish-send-results', error:String(err), pageUrl:location.href })
        }).catch(()=>{});
      }
    });

    // init
    window._startTime = new Date().toISOString();
    window._startMs = Date.now();

    // âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨í•´ë„ ë Œë”ëŠ” ê°•í–‰
    try { await ensureLibs(); } catch(e){ console.warn('ensureLibs failed', e); }
    renderExercises();
  });
  </script>
</body>
</html>
