<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>OpenAI ë³´ì´ìŠ¤ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui, sans-serif; max-width:720px; margin:40px auto; padding:0 16px;}
    label{display:block; margin:14px 0 6px;}
    input,select,textarea,button{font-size:16px; padding:10px; width:100%;}
    button{cursor:pointer;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hint{color:#666; font-size:14px;}
    .error{color:#c00; margin-top:10px;}
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ OpenAI ë³´ì´ìŠ¤ ê°„ë‹¨ í…ŒìŠ¤íŠ¸</h1>
  <p class="hint">â€» ê¸°ì¡´ ì—°ìŠµë¬¸ì œì™€ ì™„ì „íˆ ë¶„ë¦¬ëœ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì…ë‹ˆë‹¤.</p>

  <label>ë³´ì´ìŠ¤</label>
  <select id="voice">
    <option>alloy</option>
    <option>shimmer</option>
    <option>nova</option>
    <option>echo</option>
    <option>fable</option>
  </select>

  <div class="row">
    <div>
      <label>ì†ë„ (0.5 ~ 2.0)</label>
      <input id="speed" type="number" value="1.0" step="0.1" min="0.5" max="2.0">
    </div>
    <div>
      <label>ìƒ˜í”Œ ë¬¸ì¥ ê¸¸ì´</label>
      <select id="preset">
        <option value="short">ì§§ê²Œ</option>
        <option value="medium" selected>ë³´í†µ</option>
        <option value="long">ê¸¸ê²Œ</option>
      </select>
    </div>
  </div>

  <label>í…ìŠ¤íŠ¸(ìˆ˜ì • ê°€ëŠ¥)</label>
  <textarea id="text" rows="4">ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ì€ ìˆ«ìë¥¼ ë°°ì›Œë´…ì‹œë‹¤. í•˜ë‚˜, ë‘˜, ì…‹, ë„·â€”ì²œì²œíˆ ë”°ë¼ ì½ì–´ ë³´ì„¸ìš”.</textarea>

  <button id="play">ì¬ìƒ â–¶</button>
  <div id="msg" class="error"></div>
  <audio id="player" controls style="margin-top:12px; width:100%; display:none;"></audio>

  <script>
    const voiceEl = document.getElementById('voice');
    const speedEl = document.getElementById('speed');
    const presetEl = document.getElementById('preset');
    const textEl  = document.getElementById('text');
    const btn     = document.getElementById('play');
    const player  = document.getElementById('player');
    const msg     = document.getElementById('msg');

    const samples = {
      short:  'ì•ˆë…•í•˜ì„¸ìš”. ë°˜ê°‘ìŠµë‹ˆë‹¤.',
      medium: 'ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ì€ ìˆ«ìë¥¼ ë°°ì›Œë´…ì‹œë‹¤. í•˜ë‚˜, ë‘˜, ì…‹, ë„·â€”ì²œì²œíˆ ë”°ë¼ ì½ì–´ ë³´ì„¸ìš”.',
      long:   'ì•ˆë…•í•˜ì„¸ìš”, ì˜¤ëŠ˜ì€ í•œêµ­ì–´ ìˆ«ìë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë“£ê³  ë”°ë¼ í•˜ëŠ” ì—°ìŠµì„ í•´ ë´…ì‹œë‹¤. ë¨¼ì € í•˜ë‚˜, ë‘˜, ì…‹, ë„·, ë‹¤ì„¯â€”í˜¸í¡ì„ ê°€ë‹¤ë“¬ê³ , ë˜ë°•ë˜ë°• ì†Œë¦¬ ë‚´ì–´ ì½ì–´ ë³´ì„¸ìš”.'
    };

    presetEl.addEventListener('change', () => {
      textEl.value = samples[presetEl.value];
    });

    let lock = false;
    btn.addEventListener('click', async () => {
      if (lock) return;
      lock = true; setTimeout(()=>lock=false, 600); // ê³¼ë„í•œ ì—°íƒ€ ë°©ì§€

      msg.textContent = '';
      player.style.display = 'none';
      player.pause();
      player.src = '';

      try {
        const payload = {
          text: textEl.value.trim(),
          voice: voiceEl.value,
          speed: Number(speedEl.value) || 1.0
        };

        const res = await fetch('/.netlify/functions/tts-openai', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({ error:{ message:'Invalid JSON' }}));
        if (data?.error) throw new Error(data.error.message || 'TTS error');

        const b64 = data.audioBase64;
        const mime = data.mimeType || 'audio/mpeg';
        const blob = b64ToBlob(b64, mime);
        const url  = URL.createObjectURL(blob);

        player.src = url;
        player.style.display = 'block';
        await player.play().catch(()=>{ /* ì²« ì¬ìƒ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ */ });

      } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜: ' + (e.message || e);
      }
    });

    function b64ToBlob(base64, mime='audio/mpeg'){
      const byteChars = atob(base64);
      const arr = new Uint8Array(byteChars.length);
      for (let i=0; i<byteChars.length; i++) arr[i] = byteChars.charCodeAt(i);
      return new Blob([arr], { type: mime });
    }
  </script>
</body>
</html>
