<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercices de Coréen : Écoute et Écriture pour Cédou</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .bg-gradient-header {
            background-image: linear-gradient(to right, #FF7E5F, #FEB47B);
        }
        .btn-hint-1 {
            background-color: #FACC15;
            color: #854D0E;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .btn-hint-1:hover {
            background-color: #EAB308;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-hint-2 {
            background-color: #34D399;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .btn-hint-2:hover {
            background-color: #10B981;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-check {
            background-color: #3B82F6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .btn-check:hover {
            background-color: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .input-text {
            border-color: #D1D5DB;
            border-width: 1px;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            width: 100%;
        }
        .result-box {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            transition: all 0.3s ease-in-out;
        }
        .result-correct {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .result-incorrect {
            background-color: #FEE2E2;
            color: #991B1B;
        }
        .question-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-10 px-4">
    <div class="max-w-2xl w-full">
        <header class="bg-gradient-header rounded-t-xl text-white p-8 mb-6 text-center">
            <h1 class="text-3xl font-bold">✨ Exercices de Coréen (Débutant) ✨</h1>
            <p class="mt-2 text-lg">Écoutez, écrivez et mémorisez les mots et phrases de base. 🇰🇷</p>
        </header>
        
        <div id="quiz-container" class="space-y-6">
            <!-- Les questions seront affichées ici -->
        </div>

        <div id="results-summary" class="mt-8 p-6 bg-white rounded-xl shadow-lg hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800">🎉 Exercice terminé ! 🎉</h2>
            <p class="mt-2 text-center text-gray-600">Vous avez obtenu <span id="score" class="font-bold text-blue-500 text-xl">0</span> sur 50 questions !</p>
            <div class="mt-4 text-center">
                <button onclick="resetQuiz()" class="btn-hint-2 px-6 py-2">Recommencer</button>
            </div>
        </div>
        
    </div>

    <script>
        // Netlify 환경 변수에서 API 키를 가져오거나, 로컬 환경에서는 빈 문자열로 둡니다.
        // Netlify에서 빌드할 때, 환경 변수 이름을 "GEMINI_API_KEY"로 설정해주세요.
        const apiKey = typeof process !== 'undefined' ? process.env.GEMINI_API_KEY : "";

        // Logique du lecteur audio personnalisé
        const playAudio = async (text) => {
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (sampleRateMatch) {
                        const sampleRate = parseInt(sampleRateMatch[1], 10);
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        const audio = new Audio(audioUrl);
                        audio.play();
                    } else {
                        console.error('Sample rate not found in mimeType:', mimeType);
                    }
                } else {
                    console.error('Invalid audio data received:', result);
                }
            } catch (error) {
                console.error('Error during audio generation:', error);
            }
        };

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16Array
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // bits per sample

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.byteLength, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        const questions = [
            // Mots 1-10: Nouveaux mots
            { type: 'mot', audioText: "더", hintFr: "plus / encore une fois", hintKrInitial: "ㄷ", answer: "더" },
            { type: 'mot', audioText: "저", hintFr: "Je (formel)", hintKrInitial: "ㅈ", answer: "저" },
            { type: 'mot', audioText: "반찬", hintFr: "accompagnements", hintKrInitial: "ㅂㅊ", answer: "반찬" },
            { type: 'mot', audioText: "주세요", hintFr: "donnez-moi", hintKrInitial: "ㅈㅅㅇ", answer: "주세요" },
            { type: 'mot', audioText: "괜찮아요", hintFr: "Ça va / C'est bon", hintKrInitial: "ㄱㅊㅇㅇ", answer: "괜찮아요" },
            { type: 'mot', audioText: "맛있어요", hintFr: "C'est délicieux", hintKrInitial: "ㅁㅇㅆㅇ", answer: "맛있어요" },
            { type: 'mot', audioText: "물", hintFr: "Eau", hintKrInitial: "ㅁ", answer: "물" },
            { type: 'mot', audioText: "맥주", hintFr: "Bière", hintKrInitial: "ㅁㅉ", answer: "맥주" },
            { type: 'mot', audioText: "소주", hintFr: "Soju (alcool coréen)", hintKrInitial: "ㅅㅈ", answer: "소주" },
            { type: 'mot', audioText: "메뉴판", hintFr: "Menu", hintKrInitial: "ㅁㄴㅍ", answer: "메뉴판" },
            
            // Phrases 1-10: Nouvelles phrases
            { type: 'phrase', audioText: "반찬 좀 더 주세요", hintFr: "Donnez-moi un peu plus d'accompagnements", hintKrInitial: "ㅂㅊ ㅈ ㄷ ㅈㅅㅇ", answer: "반찬 좀 더 주세요" },
            { type: 'phrase', audioText: "이름이 뭐예요?", hintFr: "Quel est votre nom ?", hintKrInitial: "ㅇㄹㅇ ㅁㅇㅇ?", answer: "이름이 뭐예요?" },
            { type: 'phrase', audioText: "저는 Cédric이라고 해요", hintFr: "Je m'appelle Cédric", hintKrInitial: "ㅈㄴ ㅅㄷㄹㅇㄹㄱ ㅎㅇ", answer: "저는 Cédric이라고 해요" },
            { type: 'phrase', audioText: "어디에 살아요?", hintFr: "Où habitez-vous ?", hintKrInitial: "ㅇㄷㅇ ㅅㄹㅇ?", answer: "어디에 살아요?" },
            { type: 'phrase', audioText: "이거 주세요", hintFr: "Donnez-moi ça svp", hintKrInitial: "ㅇㄱ ㅈㅅㅇ", answer: "이거 주세요" },
            { type: 'phrase', audioText: "그거 얼마예요?", hintFr: "Ça coûte combien ?!", hintKrInitial: "ㄱㄱ ㅇㅁㅇㅇ?", answer: "그거 얼마예요?" },
            { type: 'phrase', audioText: "화장실 어디예요?", hintFr: "Où sont les toilettes ?", hintKrInitial: "ㅎㅈㅅ ㅇㄷㅇㅇ?", answer: "화장실 어디예요?" },
            { type: 'phrase', audioText: "안녕히 가세요", hintFr: "Au revoir (à une personne qui part)", hintKrInitial: "ㅇㄴㅎ ㄱㅅㅇ", answer: "안녕히 가세요" },
            { type: 'phrase', audioText: "안녕히 계세요", hintFr: "Au revoir (à une personne qui reste)", hintKrInitial: "ㅇㄴㅎ ㄱㅅㅇ", answer: "안녕히 계세요" },
            { type: 'phrase', audioText: "친구", hintFr: "ami(e) du même âge", hintKrInitial: "ㅊㄱ", answer: "친구" },
            
            // Mots 11-20: Nombres et vocabulaire
            { type: 'mot', audioText: "하나", hintFr: "1", hintKrInitial: "ㅎㄴ", answer: "하나" },
            { type: 'mot', audioText: "둘", hintFr: "2", hintKrInitial: "ㄷ", answer: "둘" },
            { type: 'mot', audioText: "셋", hintFr: "3", hintKrInitial: "ㅅ", answer: "셋" },
            { type: 'mot', audioText: "넷", hintFr: "4", hintKrInitial: "ㄴ", answer: "넷" },
            { type: 'mot', audioText: "다섯", hintFr: "5", hintKrInitial: "ㄷㅅ", answer: "다섯" },
            { type: 'mot', audioText: "여섯", hintFr: "6", hintKrInitial: "ㅇㅅ", answer: "여섯" },
            { type: 'mot', audioText: "일곱", hintFr: "7", hintKrInitial: "ㅇㄱ", answer: "일곱" },
            { type: 'mot', audioText: "여덟", hintFr: "8", hintKrInitial: "ㅇㄷ", answer: "여덟" },
            { type: 'mot', audioText: "아홉", hintFr: "9", hintKrInitial: "ㅇㅎ", answer: "아홉" },
            { type: 'mot', audioText: "열", hintFr: "10", hintKrInitial: "ㅇ", answer: "열" },

            // Phrases 11-20: Voyager en Corée
            { type: 'phrase', audioText: "이거 얼마예요?", hintFr: "Ça coûte combien ?", hintKrInitial: "ㅇㄱ ㅇㅁㅇㅇ?", answer: "이거 얼마예요?" },
            { type: 'phrase', audioText: "잠시만요", hintFr: "Un instant s'il vous plaît", hintKrInitial: "ㅈㅅㅁㅇ", answer: "잠시만요" },
            { type: 'phrase', audioText: "고구마 주세요", hintFr: "Donnez-moi une patate douce (고구마)", hintKrInitial: "ㄱㄱㅁ ㅈㅅㅇ", answer: "고구마 주세요" },
            { type: 'phrase', audioText: "어디로 가요?", hintFr: "Où allez-vous ?", hintKrInitial: "ㅇㄷㄹ ㄱㅇ?", answer: "어디로 가요?" },
            { type: 'phrase', audioText: "감사합니다", hintFr: "Merci", hintKrInitial: "ㄱㅅㅎㄴㄷ", answer: "감사합니다" },
            { type: 'phrase', audioText: "죄송합니다", hintFr: "Désolé(e) (très poli)", hintKrInitial: "ㅈㅅㅎㄴㄷ", answer: "죄송합니다" },
            { type: 'phrase', audioText: "괜찮아요", hintFr: "Ça va", hintKrInitial: "ㄱㅊㅇㅇ", answer: "괜찮아요" },
            { type: 'phrase', audioText: "메뉴판 주세요", hintFr: "Donnez-moi le menu", hintKrInitial: "ㅁㄴㅍ ㅈㅅㅇ", answer: "메뉴판 주세요" },
            { type: 'phrase', audioText: "물 주세요", hintFr: "Donnez-moi de l'eau", hintKrInitial: "ㅁ ㅈㅅㅇ", answer: "물 주세요" },
            { type: 'phrase', audioText: "맛있어요!", hintFr: "C'est délicieux !", hintKrInitial: "ㅁㅇㅆㅇ!", answer: "맛있어요!" },

            // Mots 21-30: Divers
            { type: 'mot', audioText: "김치", hintFr: "Kimchi", hintKrInitial: "ㄱㅊ", answer: "김치" },
            { type: 'mot', audioText: "밥", hintFr: "Riz cuit", hintKrInitial: "ㅂ", answer: "밥" },
            { type: 'mot', audioText: "국", hintFr: "Soupe", hintKrInitial: "ㄱ", answer: "국" },
            { type: 'mot', audioText: "집", hintFr: "Maison", hintKrInitial: "ㅈ", answer: "집" },
            { type: 'mot', audioText: "친구", hintFr: "Ami", hintKrInitial: "ㅊㄱ", answer: "친구" },
            { type: 'mot', audioText: "선생님", hintFr: "Professeur", hintKrInitial: "ㅅㅅㄴ", answer: "선생님" },
            { type: 'mot', audioText: "학생", hintFr: "Étudiant", hintKrInitial: "ㅎㅅ", answer: "학생" },
            { type: 'mot', audioText: "학교", hintFr: "École", hintKrInitial: "ㅎㄱ", answer: "학교" },
            { type: 'mot', audioText: "사과", hintFr: "Pomme", hintKrInitial: "ㅅㄱ", answer: "사과" },
            { type: 'mot', audioText: "바나나", hintFr: "Banane", hintKrInitial: "ㅂㄴㄴ", answer: "바나나" }
        ];

        let score = 0;
        const quizContainer = document.getElementById('quiz-container');

        const renderQuiz = () => {
            quizContainer.innerHTML = '';
            let motCounter = 0;
            let phraseCounter = 0;

            questions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card mb-4';

                let questionLabel = '';
                if (q.type === 'phrase') {
                    phraseCounter++;
                    questionLabel = `Phrase ${phraseCounter}`;
                } else {
                    motCounter++;
                    questionLabel = `Mot ${motCounter}`;
                }
                
                questionCard.innerHTML = `
                    <div class="flex flex-col space-y-4">
                        <p class="text-sm text-gray-500 font-medium mb-1">${questionLabel}</p>
                        <p class="text-gray-700 text-lg">
                            ${q.hintFr}
                        </p>
                        <div class="flex items-center space-x-2">
                            <button class="btn-hint-1" id="hint-initial-${index}" onclick="showHintInitial(${index})">
                                Indice (consonne initiales)
                            </button>
                            <button class="btn-hint-2" id="hint-audio-${index}" onclick="playAudio('${q.audioText}')">
                                🔊 Indice (Écouter)
                            </button>
                        </div>
                        <p id="initial-text-${index}" class="text-xl text-gray-700 font-bold hidden mt-2"></p>
                        <input type="text" id="answer-${index}" class="input-text" placeholder="Écrivez la réponse ici en coréen..." onkeydown="handleEnter(event, ${index})">
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="checkAnswer(${index})" class="btn-check">
                            Vérifier
                        </button>
                    </div>
                    <div id="result-box-${index}" class="result-box hidden mt-4"></div>
                `;
                quizContainer.appendChild(questionCard);
            });
        };

        const showHintInitial = (index) => {
            const initialTextElement = document.getElementById(`initial-text-${index}`);
            initialTextElement.innerText = questions[index].hintKrInitial;
            initialTextElement.classList.remove('hidden');
        };

        const checkAnswer = (index) => {
            const q = questions[index];
            const resultBox = document.getElementById(`result-box-${index}`);
            const inputElement = document.getElementById(`answer-${index}`);
            const userAnswer = inputElement.value;
            const checkButton = document.querySelector(`#quiz-container .question-card:nth-child(${index + 1}) .btn-check`);

            // Nettoyer la réponse를 위해 불필요한 문장 부호와 공백을 제거합니다.
            const cleanedUserAnswer = userAnswer.trim().replace(/[.,!?]/g, '');
            const cleanedCorrectAnswer = q.answer.trim().replace(/[.,!?]/g, '');

            if (cleanedUserAnswer.toLowerCase() === cleanedCorrectAnswer.toLowerCase()) {
                resultBox.className = 'result-box result-correct';
                resultBox.innerText = `✅ C'est la bonne réponse ! La réponse est "${q.answer}".`;
                score++;
            } else {
                resultBox.className = 'result-box result-incorrect';
                resultBox.innerText = `❌ Ce n'est pas la bonne réponse. La réponse est "${q.answer}".`;
            }
            resultBox.classList.remove('hidden');

            // 정답 확인 버튼은 한번 누르면 사라집니다.
            checkButton.classList.add('hidden');
        };

        const handleEnter = (event, index) => {
            if (event.key === 'Enter') {
                checkAnswer(index);
            }
        };

        const showSummary = () => {
            const summaryContainer = document.getElementById('results-summary');
            const scoreElement = document.getElementById('score');
            
            quizContainer.classList.add('hidden');
            summaryContainer.classList.remove('hidden');
            scoreElement.innerText = score;
        };

        const resetQuiz = () => {
            score = 0;
            document.getElementById('results-summary').classList.add('hidden');
            quizContainer.classList.remove('hidden');
            renderQuiz();
        };

        window.onload = () => {
            renderQuiz();
        };
    </script>
</body>
</html>
