<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•œêµ­ì–´ ì‹¤ë ¥ í…ŒìŠ¤íŠ¸ (Test de niveau de corÃ©en) Â· A0â€“A1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',sans-serif}
    .creator-stamp{font-size:.9rem;color:#7a7a7a;text-align:center;padding:16px 0}
    .task-container{max-width:900px;margin:1.2rem auto;padding:1.5rem;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .section{display:none;margin-bottom:2rem;padding:1.25rem;border:1px solid #e2e8f0;border-radius:12px}
    .section.active{display:block}
    .btn-action{transition:all .2s}
    .btn-action:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .progress-bar-container{width:100%;background:#e5e7eb;border-radius:999px;margin:1rem 0 1.25rem}
    .progress-bar{height:18px;width:0%;background:#2563eb;border-radius:999px;transition:width .5s;text-align:center;color:#fff;font-weight:700;font-size:.8rem}
    .vocab-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .vocab-card{padding:1rem;border:2px solid #cbd5e1;border-radius:10px;cursor:pointer;transition:all .15s;text-align:center;font-size:1.05rem;background:#fff}
    .vocab-card.selected{background:#dbeafe;border-color:#3b82f6}
    .vocab-card.correct{background:#d1fae5;border-color:#10b981;cursor:default;opacity:.7}
    .vocab-card.incorrect{background:#fee2e2;border-color:#ef4444}
    .recording-dot{width:10px;height:10px;background:red;border-radius:999px;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(.95);box-shadow:0 0 0 0 rgba(255,82,82,.6)}70%{transform:scale(1);box-shadow:0 0 0 10px rgba(255,82,82,0)}100%{transform:scale(.95);box-shadow:0 0 0 0 rgba(255,82,82,0)}}
  </style>
</head>
<body class="bg-gray-50">

  <!-- ìƒë‹¨: ì¸ì‡„ ë²„íŠ¼ + í¬ë ˆë”§ -->
  <div class="creator-stamp top flex items-center justify-center gap-3">
    <button id="print-btn" class="btn-action bg-white border border-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-100">
      ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸° / Imprimer cette page
    </button>
    <span>made by <strong>ì„±ì¼, Pondant</strong> Â· <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a></span>
  </div>

  <div class="task-container">
    <!-- í—¤ë” -->
    <div class="text-center mb-4">
      <h1 class="text-3xl font-extrabold text-gray-800">í•œêµ­ì–´ ë ˆë²¨ í…ŒìŠ¤íŠ¸ â±ï¸</h1>
      <h2 class="text-xl font-semibold text-blue-600">A0â€“A1 Â· Niveau dÃ©butant</h2>
      <p class="text-gray-600 mt-2">
        5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ë¡œ í˜„ì¬ ì‹¤ë ¥ì„ ë¹ ë¥´ê²Œ í™•ì¸í•´ìš”. <br>
        Bienvenue ! Faisons un test en 5 Ã©tapes pour voir oÃ¹ tu en es en corÃ©en.
      </p>
    </div>

    <!-- ì§„í–‰ë¥  ë°” -->
    <div class="progress-bar-container">
      <div id="progress-bar" class="progress-bar">0%</div>
    </div>

    <!-- 0ë‹¨ê³„: ì‹œì‘ -->
    <section id="stage-0" class="section active text-center">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</h2>
      <p class="mb-5">ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•´ ì£¼ì„¸ìš” !</p>
      <div class="max-w-md mx-auto">
        <label for="studentName" class="block text-lg font-semibold text-gray-700 mb-2">ì´ë¦„ / Nom</label>
        <input id="studentName" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ) ë°©íƒ„ì†Œë…„ë‹¨ RM">
      </div>
      <button id="start-btn" class="mt-4 btn-action bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-indigo-700">
        ì‹œì‘! (Commencer !)
      </button>
    </section>

    <!-- 1ë‹¨ê³„: ë“£ê³  ì½ê¸° -->
    <section id="stage-1" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">1ë‹¨ê³„: ë“£ê³  ì½ê¸° (Ã‰tape 1 : Ã‰couter et lire)</h2>
      <p class="mb-4">ë¬¸ì¥ì„ ë“£ê³  ë”°ë¼ì„œ ì½ìœ¼ë©° ë…¹ìŒí•˜ì„¸ìš”. <br>Ã‰coutez, puis lisez Ã  voix haute en vous enregistrant.</p>
      <div id="listen-read-tasks" class="space-y-5"></div>
    </section>

    <!-- 2ë‹¨ê³„: í˜¼ì ì½ê¸° -->
    <section id="stage-2" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">2ë‹¨ê³„: í˜¼ì ì½ê¸° (Ã‰tape 2 : Lire seul)</h2>
      <p class="mb-4">ë¬¸ì¥ì„ ë³´ê³  ì†Œë¦¬ ë‚´ì–´ ì½ìœ¼ë©° ë…¹ìŒí•˜ì„¸ìš”. <br>Lisez la phrase Ã  voix haute en vous enregistrant.</p>
      <div id="read-alone-tasks" class="space-y-5"></div>
    </section>

    <!-- 3ë‹¨ê³„: ì–´íœ˜ -->
    <section id="stage-3" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">3ë‹¨ê³„: ì–´íœ˜ í…ŒìŠ¤íŠ¸ (Ã‰tape 3 : Vocabulaire)</h2>
      <p class="mb-3">í•œêµ­ì–´â€“í”„ë‘ìŠ¤ì–´ ë‹¨ì–´ë¥¼ ì§ì§€ìœ¼ì„¸ìš” ! <br>Associez les mots corÃ©ens et franÃ§ais !</p>
      <p class="text-lg font-bold mb-3">ë§ì¶˜ ê°œìˆ˜ / Bonnes rÃ©ponses: <span id="vocab-score">0</span> / 15</p>
      <div id="vocab-game" class="vocab-grid"></div>
    </section>

    <!-- 4ë‹¨ê³„: ì´í•´ë ¥ -->
    <section id="stage-4" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">4ë‹¨ê³„: ì´í•´ë ¥ (Ã‰tape 4 : ComprÃ©hension)</h2>
      <p class="mb-4">ë¬¸ì¥ì„ ì½ê³  í”„ë‘ìŠ¤ì–´ë¡œ ì¨ ë³´ì„¸ìš”. <br>Lisez la phrase et Ã©crivez ce que vous avez compris (FR).</p>
      <div id="comprehension-tasks" class="space-y-5"></div>
    </section>

    <!-- 5ë‹¨ê³„: ë“£ê³  ë§í•˜ê¸° -->
    <section id="stage-5" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">5ë‹¨ê³„: ë“£ê³  ë§í•˜ê¸° (Ã‰tape 5 : Ã‰couter et parler)</h2>
      <p class="mb-4">ì§ˆë¬¸ì„ ë“£ê³  ë°›ì•„ì“°ê¸° â†’ ë²ˆì—­ â†’ í•œêµ­ì–´ë¡œ ëŒ€ë‹µì„ ë…¹ìŒí•˜ì„¸ìš”. <br>
        Ã‰coutez la question â†’ dictÃ©e (KR) â†’ traduction (FR) â†’ rÃ©pondez en corÃ©en (enregistrement).
      </p>
      <div id="listen-speak-tasks" class="space-y-7"></div>
    </section>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="flex flex-col sm:flex-row gap-3 mt-6">
      <button id="prev-btn" class="btn-action bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 hidden">ì´ì „ (PrÃ©cÃ©dent)</button>
      <button id="next-btn" class="btn-action bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 hidden">ë‹¤ìŒ (Suivant)</button>
      <button id="finish-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-700 hidden">
        ì œì¶œí•˜ê³  ì¢…ë£Œ (Terminer)
      </button>
    </div>
  </div>

  <!-- í•˜ë‹¨: ì´ì „ ì—°ìŠµë¬¸ì œ ë²„íŠ¼ + í¬ë ˆë”§ -->
  <div class="creator-stamp bottom flex items-center justify-center gap-3">
    <a href="./Test_A0_A1.html" class="btn-action bg-white border border-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-100">
      â¬…ï¸ ì²« í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸° Â· Retour Ã  la premiÃ¨re page
    </a>
    <span>made by <strong>ì„±ì¼, Pondant</strong> Â· <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a></span>
  </div>

  <script type="module">
    // ===== í…ŒìŠ¤íŠ¸ ë°ì´í„° =====
    const testData = {
      listenRead: [
        { id:'lr1', ko:'ì´ê²ƒì€ ì‚¬ê³¼ì…ë‹ˆë‹¤.', fr:"C'est une pomme." },
        { id:'lr2', ko:'ì €ëŠ” í•™ìƒì…ë‹ˆë‹¤.', fr:"Je suis Ã©tudiant(e)." },
        { id:'lr3', ko:'ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.', fr:"Il fait beau aujourd'hui." },
        { id:'lr4', ko:'í•œêµ­ì–´ë¥¼ ê³µë¶€í•´ìš”.', fr:"J'Ã©tudie le corÃ©en." },
        { id:'lr5', ko:'ì£¼ë§ì— ë­ í–ˆì–´ìš”?', fr:"Qu'as-tu fait ce week-end ?" }
      ],
      readAlone: [
        { id:'ra1', ko:'ì €ëŠ” ì•„ì¹¨ì„ ë¨¹ì–´ìš”.', fr:"Je prends le petit-dÃ©jeuner." },
        { id:'ra2', ko:'ê³ ì–‘ì´ê°€ ê·€ì—¬ì›Œìš”.', fr:"Le chat est mignon." },
        { id:'ra3', ko:'ì§€ê¸ˆ ëª‡ ì‹œì˜ˆìš”?', fr:"Quelle heure est-il ?" },
        { id:'ra4', ko:'ê°€ë°© ì•ˆì— ì±…ì´ ìˆì–´ìš”.', fr:"Il y a un livre dans le sac." },
        { id:'ra5', ko:'ë‚´ì¼ ì˜í™” ë³´ëŸ¬ ê°ˆê¹Œìš”?', fr:"On va voir un film demain ?" }
      ],
      vocabulary: [
        { id:1, ko:'í•™êµ', fr:'Ã‰cole' }, { id:2, ko:'ì¹œêµ¬', fr:'Ami(e)' },
        { id:3, ko:'ë¬¼', fr:'Eau' }, { id:4, ko:'ë°¥', fr:'Riz/Repas' },
        { id:5, ko:"ì˜¤ëŠ˜", fr:"Aujourd'hui" }, { id:6, ko:'ë‚´ì¼', fr:'Demain' },
        { id:7, ko:'ê°€ë‹¤', fr:'Aller' }, { id:8, ko:'ë³´ë‹¤', fr:'Voir/Regarder' },
        { id:9, ko:'ë¨¹ë‹¤', fr:'Manger' }, { id:10, ko:'í•˜ë‹¤', fr:'Faire' },
        { id:11, ko:'í¬ë‹¤', fr:'Grand(e)' }, { id:12, ko:'ì‘ë‹¤', fr:'Petit(e)' },
        { id:13, ko:'ìˆë‹¤', fr:'Avoir/ÃŠtre (lÃ )' }, { id:14, ko:'ì—†ë‹¤', fr:"Ne pas avoir / ne pas Ãªtre (lÃ )" },
        { id:15, ko:'ê°ì‚¬í•©ë‹ˆë‹¤', fr:'Merci' }
      ],
      comprehension: [
        { id:'c1', ko:'ì €ëŠ” ë§¤ì¼ ìš´ë™í•´ìš”.', fr:"Je fais de l'exercice tous les jours." },
        { id:'c2', ko:'ì´ ë²„ìŠ¤ëŠ” ì–´ë””ë¡œ ê°€ìš”?', fr:"OÃ¹ va ce bus ?" },
        { id:'c3', ko:'ì§€ê¸ˆ ë¹„ê°€ ì™€ìš”.', fr:"Il pleut maintenant." },
        { id:'c4', ko:'ë„ì„œê´€ì€ ì €ìª½ì´ì—ìš”.', fr:"La bibliothÃ¨que est par lÃ -bas." },
        { id:'c5', ko:'ìƒì¼ ì¶•í•˜í•´ìš”!', fr:"Joyeux anniversaire !" },
        { id:'c6', ko:'ë„ˆë¬´ í”¼ê³¤í•´ì„œ ìê³  ì‹¶ì–´ìš”.', fr:"Je suis trÃ¨s fatiguÃ©(e) et je veux dormir." },
        { id:'c7', ko:'ì´ ìŒì‹ì€ ì¡°ê¸ˆ ë§¤ì›Œìš”.', fr:"Ce plat est un peu Ã©picÃ©." },
        { id:'c8', ko:'ì €ëŠ” ê°•ì•„ì§€ë¥¼ ë” ì¢‹ì•„í•´ìš”.', fr:"Je prÃ©fÃ¨re les chiens." },
        { id:'c9', ko:'ì§€í•˜ì² ì—­ê¹Œì§€ ê±¸ì–´ì„œ 10ë¶„ ê±¸ë ¤ìš”.', fr:"Ã‡a prend 10 minutes Ã  pied jusqu'Ã  la station de mÃ©tro." },
        { id:'c10', ko:'ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”.', fr:"On se revoit la prochaine fois." }
      ],
      listenSpeak: [
        { id:'ls1', ko:'ì´ë¦„ì´ ë­ì˜ˆìš”?', fr:"Comment vous appelez-vous ?" },
        { id:'ls2', ko:'ì–´ë””ì—ì„œ ì™”ì–´ìš”?', fr:"D'oÃ¹ venez-vous ?" },
        { id:'ls3', ko:'ì·¨ë¯¸ê°€ ë­ì˜ˆìš”?', fr:"Quel est votre loisir ?" },
        { id:'ls4', ko:'ë¬´ìŠ¨ ìŒì‹ì„ ì¢‹ì•„í•´ìš”?', fr:"Quel genre de nourriture aimez-vous ?" },
        { id:'ls5', ko:'ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë•Œìš”?', fr:"Comment vous sentez-vous aujourd'hui ?" },
        { id:'ls6', ko:'ëª‡ ì‚´ì´ì—ìš”?', fr:"Quel Ã¢ge avez-vous ?" },
        { id:'ls7', ko:'ì§ì—…ì´ ë­ì˜ˆìš”?', fr:"Quel est votre mÃ©tier ?" },
        { id:'ls8', ko:'í•œêµ­ì–´ ê³µë¶€ëŠ” ì¬ë¯¸ìˆì–´ìš”?', fr:"Est-ce que l'Ã©tude du corÃ©en est amusante ?" },
        { id:'ls9', ko:'ì£¼ë§ì— ë³´í†µ ë­ í•´ìš”?', fr:"Que faites-vous habituellement le week-end ?" },
        { id:'ls10', ko:'ë‚´ì¼ ê°™ì´ ì˜í™” ë³¼ê¹Œìš”?', fr:"Et si on allait voir un film demain ?" }
      ]
    };

    // ===== ìƒíƒœ Â· ì „ì—­ =====
    let currentStage = 0;
    const totalStages = 5;
    const studentData = { recordings:{} };
    let startTime;
    let finishInProgress = false;

    const counters = { listen:{}, hint1:{}, hint2:{} };
    const ensureCounter = (obj, key) => { if (!obj[key]) obj[key]=0; };

    // ===== DOM ì°¸ì¡° =====
    const progressBar = document.getElementById('progress-bar');
    const sections = document.querySelectorAll('.section');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    const startBtn = document.getElementById('start-btn');
    const studentNameInput = document.getElementById('studentName');

    // ===== ìœ í‹¸ =====
    function base64ToBlob(base64, mimeType){
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) byteNumbers[i]=byteChars.charCodeAt(i);
      return new Blob([new Uint8Array(byteNumbers)], { type:mimeType });
    }

    // ===== ì´ˆê¸°í™” =====
    function initializeTest(){
      const placeholders = ["ë§Œìˆ˜ë¥´","ë¹Œ ê²Œì´ì¸ ","ì¼ë¡  ë¨¸ìŠ¤í¬","ìŠˆí¼ìŠ¤íƒ€ ì´ì¬ìš©","ë°©íƒ„ì†Œë…„ë‹¨ RM","ë§ˆë¦¬","ì¤„ë¦¬","ì†Œí”¼","ë¤¼ì‹œ"];
      studentNameInput.placeholder = `ì˜ˆ) ${placeholders[Math.floor(Math.random()*placeholders.length)]}`;

      // Stage 1
      const listenReadContainer = document.getElementById('listen-read-tasks');
      testData.listenRead.forEach((task,i)=>{
        listenReadContainer.insertAdjacentHTML('beforeend', createRecordingTaskHTML(task.id, i+1, task.ko, true));
      });

      // Stage 2
      const readAloneContainer = document.getElementById('read-alone-tasks');
      testData.readAlone.forEach((task,i)=>{
        readAloneContainer.insertAdjacentHTML('beforeend', createRecordingTaskHTML(task.id, i+1, task.ko, false));
      });

      // Stage 3
      initializeVocabGame();

      // Stage 4
      const comp = document.getElementById('comprehension-tasks');
      testData.comprehension.forEach((task,i)=>{
        comp.insertAdjacentHTML('beforeend', `
          <div class="p-4 border rounded-lg" data-task-id="${task.id}">
            <p class="text-lg font-semibold mb-2">${i+1}. ${task.ko}</p>
            <input id="comprehension-input-${task.id}" type="text" class="w-full p-2 border rounded-md" placeholder="FranÃ§ais...">
          </div>
        `);
      });

      // Stage 5
      const lsWrap = document.getElementById('listen-speak-tasks');
      testData.listenSpeak.forEach((task,i)=>{
        lsWrap.insertAdjacentHTML('beforeend', `
          <div class="p-4 border rounded-lg bg-gray-50" data-task-id="${task.id}">
            <p class="text-lg font-bold mb-3">Question ${i+1}</p>
            <div class="space-y-4">
              <div>
                <label class="block font-semibold mb-1">a) Ã‰coutez et Ã©crivez (ë“£ê³  ë°›ì•„ì“°ê¸°)</label>
                <div class="flex items-center gap-2">
                  <button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-id="${task.id}" data-text="${task.ko}">ğŸ”Š Ã‰couter</button>
                  <input type="text" id="ls-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="CorÃ©en...">
                </div>
              </div>
              <div>
                <label class="block font-semibold mb-1">b) Traduisez (ë¶ˆì–´ë¡œ ë²ˆì—­)</label>
                <input type="text" id="ls-translation-${task.id}" class="w-full p-2 border rounded-md" placeholder="FranÃ§ais...">
              </div>
              <div>
                <label class="block font-semibold mb-1">c) RÃ©pondez en corÃ©en (í•œêµ­ì–´ë¡œ ë‹µë³€ ë…¹ìŒ)</label>
                ${createRecordingTaskHTML(task.id+'-answer', null, '', false)}
              </div>
              <div>
                <label class="block font-semibold mb-1">d) Ã‰coutez votre enregistrement et Ã©crivez (ìê¸° ë…¹ìŒ ë“£ê³  ë°›ì•„ì“°ê¸°)</label>
                <input type="text" id="ls-self-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="CorÃ©en...">
              </div>
            </div>
          </div>
        `);
      });

      addEventListeners();
    }

    function createRecordingTaskHTML(id, number, sentence, includePlayBtn){
      return `
        <div class="p-4 border rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4" data-task-id="${id}">
          <div class="flex-grow">${number ? `<p class="text-lg font-semibold">${number}. ${sentence}</p>` : ''}</div>
          <div class="flex items-center gap-2">
            ${includePlayBtn ? `<button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-id="${id}" data-text="${sentence}">ğŸ”Š</button>` : ''}
            <button class="record-btn btn-action bg-green-500 text-white py-2 px-4 rounded-lg flex items-center gap-1" data-id="${id}">
              <span class="icon">ğŸ¤</span><span class="text hidden sm:inline"> ë…¹ìŒ</span>
            </button>
            <div class="recording-status hidden items-center gap-2 text-red-500">
              <div class="recording-dot"></div>
            </div>
            <audio controls class="hidden w-40 h-10" id="audio-${id}"></audio>
          </div>
        </div>
      `;
    }

    // ===== ì–´íœ˜ ê²Œì„ =====
    function initializeVocabGame(){
      const game = document.getElementById('vocab-game');
      const scoreEl = document.getElementById('vocab-score');
      let score = 0, selectedKo=null, selectedFr=null, lock=false;

      const korean = [...testData.vocabulary];
      const french = [...testData.vocabulary].sort(()=>Math.random()-.5);

      const koCol = document.createElement('div'); koCol.className='flex flex-col gap-2';
      const frCol = document.createElement('div'); frCol.className='flex flex-col gap-2';

      korean.forEach(w=>{
        const b=document.createElement('button');
        b.className='vocab-card'; b.textContent=w.ko; b.dataset.id=w.id; b.dataset.lang='ko';
        koCol.appendChild(b);
      });
      french.forEach(w=>{
        const b=document.createElement('button');
        b.className='vocab-card'; b.textContent=w.fr; b.dataset.id=w.id; b.dataset.lang='fr';
        frCol.appendChild(b);
      });

      game.append(koCol,frCol);

      game.addEventListener('click', e=>{
        if (lock) return;
        const t=e.target;
        if (!t.classList.contains('vocab-card') || t.classList.contains('correct')) return;

        if (t.dataset.lang==='ko'){
          if (selectedKo) selectedKo.classList.remove('selected');
          selectedKo=t; selectedKo.classList.add('selected');
        } else {
          if (selectedFr) selectedFr.classList.remove('selected');
          selectedFr=t; selectedFr.classList.add('selected');
        }

        if (selectedKo && selectedFr){
          lock=true;
          if (selectedKo.dataset.id===selectedFr.dataset.id){
            score++; scoreEl.textContent=score;
            selectedKo.classList.add('correct'); selectedFr.classList.add('correct');
            selectedKo.classList.remove('selected'); selectedFr.classList.remove('selected');
            selectedKo=null; selectedFr=null; lock=false;
            if (score===testData.vocabulary.length){
              setTimeout(()=>alert('ì–´íœ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! (Test de vocabulaire terminÃ© !)'),200);
            }
          } else {
            selectedKo.classList.add('incorrect'); selectedFr.classList.add('incorrect');
            setTimeout(()=>{
              selectedKo.classList.remove('selected','incorrect');
              selectedFr.classList.remove('selected','incorrect');
              selectedKo=null; selectedFr=null; lock=false;
            },700);
          }
        }
      });
    }

    // ===== ì´ë²¤íŠ¸ =====
    function addEventListeners(){
      // ë™ì  ë²„íŠ¼ ìœ„ì„
      document.body.addEventListener('click', (e)=>{
        const playBtn = e.target.closest('.play-audio-btn');
        const recBtn  = e.target.closest('.record-btn');
        if (playBtn) playAudio(playBtn.dataset.text, playBtn);
        if (recBtn)  toggleRecording(recBtn);
      });

      document.getElementById('print-btn')?.addEventListener('click', ()=>window.print());
    }

    // ===== ì˜¤ë””ì˜¤ ì¬ìƒ (ì•ˆì •í˜•) =====
    const playAudio = async (text, button)=>{
      const originalHTML = button.innerHTML;
      const taskEl = button.closest('[data-task-id]');
      const taskId = taskEl?.getAttribute('data-task-id') || button.dataset.id || text;

      button.disabled = true;
      button.innerHTML = 'ğŸ”Š...';
      try{
        const res = await fetch('/.netlify/functions/generate-audio',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text })
        });
        if (!res.ok) throw new Error(`TTS ${res.status} ${res.statusText}`);
        const { audioData, mimeType } = await res.json();

        const blob = base64ToBlob(audioData, mimeType || 'audio/mp3');
        const url  = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();

        if (taskId){ ensureCounter(counters.listen, taskId); counters.listen[taskId]+=1; }

        audio.onended = ()=>{ URL.revokeObjectURL(url); button.disabled=false; button.innerHTML=originalHTML; };
        audio.onerror = ()=>{ URL.revokeObjectURL(url); button.disabled=false; button.innerHTML=originalHTML; alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); };
      }catch(err){
        console.error(err);
        button.disabled=false; button.innerHTML=originalHTML;
        alert('ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    };

    // ===== ë…¹ìŒ =====
    const mediaRecorders = {};
    const audioChunks = {};
    async function toggleRecording(button){
      const id = button.dataset.id;
      const statusDiv = button.nextElementSibling;
      const audioEl = document.getElementById(`audio-${id}`);

      if (!mediaRecorders[id] || mediaRecorders[id].state==='inactive'){
        try{
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          const options = { mimeType:'audio/webm' };
          mediaRecorders[id] = new MediaRecorder(stream, options);
          audioChunks[id] = [];
          let startedAt = 0;

          mediaRecorders[id].ondataavailable = e => audioChunks[id].push(e.data);
          mediaRecorders[id].onstop = ()=>{
            const duration = Math.round((Date.now()-startedAt)/1000);
            const blob = new Blob(audioChunks[id], { type:options.mimeType });
            const url = URL.createObjectURL(blob);
            audioEl.src = url;
            audioEl.classList.remove('hidden');

            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = ()=>{
              studentData.recordings[id] = {
                base64: (reader.result||'').split(',')[1] || '',
                filename: `recording_${id}.webm`,
                mimeType: options.mimeType,
                duration
              };
            };
          };

          startedAt = Date.now();
          mediaRecorders[id].start();
          button.querySelector('.icon').textContent='â¹ï¸';
          button.querySelector('.text').textContent=' ì¤‘ì§€';
          button.classList.replace('bg-green-500','bg-red-500');
          statusDiv.classList.remove('hidden');

        }catch(err){
          alert("ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. (L'accÃ¨s au microphone est requis.)");
        }
      } else {
        mediaRecorders[id].stop();
        button.querySelector('.icon').textContent='ğŸ¤';
        button.querySelector('.text').textContent=' ë…¹ìŒ';
        button.classList.replace('bg-red-500','bg-green-500');
        statusDiv.classList.add('hidden');
      }
    }

    // ===== ë„¤ë¹„ê²Œì´ì…˜ =====
    function updateStage(newStage){
      if (newStage<0 || newStage>totalStages+1) return;
      currentStage = newStage;

      sections.forEach(s=>s.classList.remove('active'));
      document.getElementById(`stage-${currentStage}`)?.classList.add('active');

      const progress = (currentStage>0) ? ((currentStage-1)/totalStages)*100 : 0;
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${Math.round(progress)}%`;

      prevBtn.classList.toggle('hidden', currentStage<=1);
      nextBtn.classList.toggle('hidden', currentStage>=totalStages || currentStage===0);
      finishBtn.classList.toggle('hidden', currentStage!==totalStages);
    }

    startBtn.addEventListener('click', ()=>{
      const name = studentNameInput.value.trim();
      if (!name){
        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom !)');
        studentNameInput.focus(); return;
      }
      studentData.name = name;
      startTime = new Date();
      updateStage(1);
    });

    nextBtn.addEventListener('click', ()=>updateStage(currentStage+1));
    prevBtn.addEventListener('click', ()=>updateStage(currentStage-1));

    // ===== ê²°ê³¼ ì§‘ê³„ =====
    function collectAllData(){
      const questions = [];
      let qNum = 1;

      // Stage 1 & 2
      [...testData.listenRead, ...testData.readAlone].forEach(task=>{
        questions.push({
          number: qNum++,
          ko: task.ko,
          fr: task.fr,
          userAnswer: '',
          isCorrect: null,
          listenCount: counters.listen[task.id] || 0,
          hint1Count: counters.hint1[task.id] || 0,
          hint2Count: counters.hint2[task.id] || 0,
          recording: studentData.recordings[task.id] || null
        });
      });

      // Stage 3
      const vocabScore = parseInt(document.getElementById('vocab-score').textContent,10) || 0;
      questions.push({
        number: qNum++,
        ko: 'ì–´íœ˜ ì§ì§“ê¸° ê²Œì„',
        fr: "Jeu d'association de vocabulaire",
        userAnswer: `Score: ${vocabScore} / ${testData.vocabulary.length}`,
        isCorrect: vocabScore === testData.vocabulary.length,
        listenCount: 0, hint1Count: 0, hint2Count: 0
      });

      // Stage 4
      testData.comprehension.forEach(task=>{
        const ans = document.getElementById(`comprehension-input-${task.id}`).value || '';
        questions.push({
          number: qNum++,
          ko: task.ko,
          fr: `(Question de comprÃ©hension) ${task.fr}`,
          userAnswer: ans,
          isCorrect: null,
          listenCount: 0, hint1Count: 0, hint2Count: 0
        });
      });

      // Stage 5
      testData.listenSpeak.forEach(task=>{
        const dictation = document.getElementById(`ls-dictation-${task.id}`).value || '';
        const translation = document.getElementById(`ls-translation-${task.id}`).value || '';
        const selfDictation = document.getElementById(`ls-self-dictation-${task.id}`).value || '';
        questions.push({
          number: qNum++,
          ko: `(ì§ˆë¬¸) ${task.ko}`,
          fr: `(Question) ${task.fr}`,
          userAnswer: JSON.stringify({ dictation, translation, selfDictation }),
          isCorrect: null,
          listenCount: counters.listen[task.id] || 0,
          hint1Count: counters.hint1[task.id] || 0,
          hint2Count: counters.hint2[task.id] || 0,
          recording: studentData.recordings[task.id+'-answer'] || null
        });
      });

      return questions;
    }

    // ===== ì œì¶œ/ì „ì†¡ =====
    finishBtn.addEventListener('click', async ()=>{
      if (finishInProgress) return; // ì´ì¤‘ ë°©ì§€
      finishInProgress = true;
      finishBtn.disabled = true;
      finishBtn.textContent = 'ê²°ê³¼ë¥¼ ì „ì†¡í•˜ëŠ” ì¤‘...';

      const questions = collectAllData();
      const endTime = new Date();

      const payload = {
        studentName: studentData.name,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        totalTimeSeconds: Math.round((endTime - startTime)/1000),
        questions
      };

      try{
        const res = await fetch('/.netlify/functions/send-results',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Server responded with an error');

        // âœ… í•™ìƒì—ê²ŒëŠ” ì ìˆ˜/ì„¸ë¶€ë‚´ìš© ë¯¸í‘œì‹œ â€” ê°„ë‹¨ ë©”ì‹œì§€ë§Œ
        const resultHTML = `
          <div class="task-container text-center">
            <h1 class="text-3xl font-bold text-green-600 mb-6">âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ</h1>
            <p class="text-lg text-gray-800 leading-relaxed">
              ìˆ˜ê³ í•˜ì…¨ì–´ìš”! ìì„¸í•œ í”¼ë“œë°±ì€ ì‹œë²”ìˆ˜ì—…ì—ì„œ ë“œë¦´ê²Œìš”. <br/>
              <span class="text-blue-700 text-base">
                (Merci pour vos efforts ! Le feedback dÃ©taillÃ© sera donnÃ© pendant le cours dâ€™essai.)
              </span>
            </p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
              <a href="/assignments/" class="w-full sm:w-auto text-center bg-white border border-gray-300 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-100">
                â¬…ï¸ ì´ì „ ì—°ìŠµë¬¸ì œë¡œ ê°€ê¸°
              </a>
              <button id="print-result-btn" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-100">
                ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸° / Imprimer
              </button>
            </div>
            <div class="creator-stamp" style="margin-top:24px">
              made by <strong>ì„±ì¼, Pondant</strong> Â· <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
            </div>
          </div>
          <script>
            document.getElementById('print-result-btn')?.addEventListener('click', ()=>window.print());
          <\/script>
        `;
        document.body.innerHTML = resultHTML;

      }catch(err){
        console.error('ê²°ê³¼ ì „ì†¡ ì‹¤íŒ¨:', err);
        alert('ê²°ê³¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
        finishBtn.disabled=false;
        finishBtn.textContent='ì œì¶œí•˜ê³  ì¢…ë£Œ (Terminer)';
        finishInProgress = false;
      }
    });

    // ===== ì‹œì‘ =====
    initializeTest();
  </script>
</body>
</html>
