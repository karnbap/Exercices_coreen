<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>한국어 실력 테스트 (Test de niveau de coréen) · A0–A1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',sans-serif}
    .creator-stamp{font-size:.9rem;color:#7a7a7a;text-align:center;padding:16px 0}
    .task-container{max-width:900px;margin:1.2rem auto;padding:1.5rem;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
    .section{display:none;margin-bottom:2rem;padding:1.25rem;border:1px solid #e2e8f0;border-radius:12px}
    .section.active{display:block}
    .btn-action{transition:all .2s}
    .btn-action:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .progress-bar-container{width:100%;background:#e5e7eb;border-radius:999px;margin:1rem 0 1.25rem}
    .progress-bar{height:18px;width:0%;background:#2563eb;border-radius:999px;transition:width .5s;text-align:center;color:#fff;font-weight:700;font-size:.8rem}
    .vocab-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .vocab-card{padding:1rem;border:2px solid #cbd5e1;border-radius:10px;cursor:pointer;transition:all .15s;text-align:center;font-size:1.05rem;background:#fff}
    .vocab-card.selected{background:#dbeafe;border-color:#3b82f6}
    .vocab-card.correct{background:#d1fae5;border-color:#10b981;cursor:default;opacity:.7}
    .vocab-card.incorrect{background:#fee2e2;border-color:#ef4444}
    .recording-dot{width:10px;height:10px;background:red;border-radius:999px;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(.95);box-shadow:0 0 0 0 rgba(255,82,82,.6)}70%{transform:scale(1);box-shadow:0 0 0 10px rgba(255,82,82,0)}100%{transform:scale(.95);box-shadow:0 0 0 0 rgba(255,82,82,0)}}
  </style>
</head>
<body class="bg-gray-50">

  <!-- 상단: 인쇄 버튼 + 크레딧 -->
  <div class="creator-stamp top flex items-center justify-center gap-3">
    <button id="print-btn" class="btn-action bg-white border border-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-100">
      🖨️ 인쇄하기 / Imprimer cette page
    </button>
    <span>made by <strong>성일, Pondant</strong> · <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a></span>
  </div>

  <div class="task-container">
    <!-- 헤더 -->
    <div class="text-center mb-4">
      <h1 class="text-3xl font-extrabold text-gray-800">한국어 레벨 테스트 ⏱️</h1>
      <h2 class="text-xl font-semibold text-blue-600">A0–A1 · Niveau débutant</h2>
      <p class="text-gray-600 mt-2">
        5단계 테스트로 현재 실력을 빠르게 확인해요. <br>
        Bienvenue ! Faisons un test en 5 étapes pour voir où tu en es en coréen.
      </p>
    </div>

    <!-- 진행률 바 -->
    <div class="progress-bar-container">
      <div id="progress-bar" class="progress-bar">0%</div>
    </div>

    <!-- 0단계: 시작 -->
    <section id="stage-0" class="section active text-center">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">테스트 시작하기</h2>
      <p class="mb-5">이름을 입력하고 시작해 주세요 !</p>
      <div class="max-w-md mx-auto">
        <label for="studentName" class="block text-lg font-semibold text-gray-700 mb-2">이름 / Nom</label>
        <input id="studentName" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="예) 방탄소년단 RM">
      </div>
      <button id="start-btn" class="mt-4 btn-action bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-indigo-700">
        시작! (Commencer !)
      </button>
    </section>

    <!-- 1단계: 듣고 읽기 -->
    <section id="stage-1" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">1단계: 듣고 읽기 (Étape 1 : Écouter et lire)</h2>
      <p class="mb-4">문장을 듣고 따라서 읽으며 녹음하세요. <br>Écoutez, puis lisez à voix haute en vous enregistrant.</p>
      <div id="listen-read-tasks" class="space-y-5"></div>
    </section>

    <!-- 2단계: 혼자 읽기 -->
    <section id="stage-2" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">2단계: 혼자 읽기 (Étape 2 : Lire seul)</h2>
      <p class="mb-4">문장을 보고 소리 내어 읽으며 녹음하세요. <br>Lisez la phrase à voix haute en vous enregistrant.</p>
      <div id="read-alone-tasks" class="space-y-5"></div>
    </section>

    <!-- 3단계: 어휘 -->
    <section id="stage-3" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">3단계: 어휘 테스트 (Étape 3 : Vocabulaire)</h2>
      <p class="mb-3">한국어–프랑스어 단어를 짝지으세요 ! <br>Associez les mots coréens et français !</p>
      <p class="text-lg font-bold mb-3">맞춘 개수 / Bonnes réponses: <span id="vocab-score">0</span> / 15</p>
      <div id="vocab-game" class="vocab-grid"></div>
    </section>

    <!-- 4단계: 이해력 -->
    <section id="stage-4" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">4단계: 이해력 (Étape 4 : Compréhension)</h2>
      <p class="mb-4">문장을 읽고 프랑스어로 써 보세요. <br>Lisez la phrase et écrivez ce que vous avez compris (FR).</p>
      <div id="comprehension-tasks" class="space-y-5"></div>
    </section>

    <!-- 5단계: 듣고 말하기 -->
    <section id="stage-5" class="section">
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">5단계: 듣고 말하기 (Étape 5 : Écouter et parler)</h2>
      <p class="mb-4">질문을 듣고 받아쓰기 → 번역 → 한국어로 대답을 녹음하세요. <br>
        Écoutez la question → dictée (KR) → traduction (FR) → répondez en coréen (enregistrement).
      </p>
      <div id="listen-speak-tasks" class="space-y-7"></div>
    </section>

    <!-- 네비게이션 -->
    <div class="flex flex-col sm:flex-row gap-3 mt-6">
      <button id="prev-btn" class="btn-action bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 hidden">이전 (Précédent)</button>
      <button id="next-btn" class="btn-action bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 hidden">다음 (Suivant)</button>
      <button id="finish-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg hover:bg-green-700 hidden">
        제출하고 종료 (Terminer)
      </button>
    </div>
  </div>

  <!-- 하단: 이전 연습문제 버튼 + 크레딧 -->
  <div class="creator-stamp bottom flex items-center justify-center gap-3">
    <a href="./Test_A0_A1.html" class="btn-action bg-white border border-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-100">
      ⬅️ 첫 페이지로 돌아가기 · Retour à la première page
    </a>
    <span>made by <strong>성일, Pondant</strong> · <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a></span>
  </div>

  <script type="module">
    // ===== 테스트 데이터 =====
    const testData = {
      listenRead: [
        { id:'lr1', ko:'이것은 사과입니다.', fr:"C'est une pomme." },
        { id:'lr2', ko:'저는 학생입니다.', fr:"Je suis étudiant(e)." },
        { id:'lr3', ko:'오늘 날씨가 좋아요.', fr:"Il fait beau aujourd'hui." },
        { id:'lr4', ko:'한국어를 공부해요.', fr:"J'étudie le coréen." },
        { id:'lr5', ko:'주말에 뭐 했어요?', fr:"Qu'as-tu fait ce week-end ?" }
      ],
      readAlone: [
        { id:'ra1', ko:'저는 아침을 먹어요.', fr:"Je prends le petit-déjeuner." },
        { id:'ra2', ko:'고양이가 귀여워요.', fr:"Le chat est mignon." },
        { id:'ra3', ko:'지금 몇 시예요?', fr:"Quelle heure est-il ?" },
        { id:'ra4', ko:'가방 안에 책이 있어요.', fr:"Il y a un livre dans le sac." },
        { id:'ra5', ko:'내일 영화 보러 갈까요?', fr:"On va voir un film demain ?" }
      ],
      vocabulary: [
        { id:1, ko:'학교', fr:'École' }, { id:2, ko:'친구', fr:'Ami(e)' },
        { id:3, ko:'물', fr:'Eau' }, { id:4, ko:'밥', fr:'Riz/Repas' },
        { id:5, ko:"오늘", fr:"Aujourd'hui" }, { id:6, ko:'내일', fr:'Demain' },
        { id:7, ko:'가다', fr:'Aller' }, { id:8, ko:'보다', fr:'Voir/Regarder' },
        { id:9, ko:'먹다', fr:'Manger' }, { id:10, ko:'하다', fr:'Faire' },
        { id:11, ko:'크다', fr:'Grand(e)' }, { id:12, ko:'작다', fr:'Petit(e)' },
        { id:13, ko:'있다', fr:'Avoir/Être (là)' }, { id:14, ko:'없다', fr:"Ne pas avoir / ne pas être (là)" },
        { id:15, ko:'감사합니다', fr:'Merci' }
      ],
      comprehension: [
        { id:'c1', ko:'저는 매일 운동해요.', fr:"Je fais de l'exercice tous les jours." },
        { id:'c2', ko:'이 버스는 어디로 가요?', fr:"Où va ce bus ?" },
        { id:'c3', ko:'지금 비가 와요.', fr:"Il pleut maintenant." },
        { id:'c4', ko:'도서관은 저쪽이에요.', fr:"La bibliothèque est par là-bas." },
        { id:'c5', ko:'생일 축하해요!', fr:"Joyeux anniversaire !" },
        { id:'c6', ko:'너무 피곤해서 자고 싶어요.', fr:"Je suis très fatigué(e) et je veux dormir." },
        { id:'c7', ko:'이 음식은 조금 매워요.', fr:"Ce plat est un peu épicé." },
        { id:'c8', ko:'저는 강아지를 더 좋아해요.', fr:"Je préfère les chiens." },
        { id:'c9', ko:'지하철역까지 걸어서 10분 걸려요.', fr:"Ça prend 10 minutes à pied jusqu'à la station de métro." },
        { id:'c10', ko:'다음에 또 만나요.', fr:"On se revoit la prochaine fois." }
      ],
      listenSpeak: [
        { id:'ls1', ko:'이름이 뭐예요?', fr:"Comment vous appelez-vous ?" },
        { id:'ls2', ko:'어디에서 왔어요?', fr:"D'où venez-vous ?" },
        { id:'ls3', ko:'취미가 뭐예요?', fr:"Quel est votre loisir ?" },
        { id:'ls4', ko:'무슨 음식을 좋아해요?', fr:"Quel genre de nourriture aimez-vous ?" },
        { id:'ls5', ko:'오늘 기분이 어때요?', fr:"Comment vous sentez-vous aujourd'hui ?" },
        { id:'ls6', ko:'몇 살이에요?', fr:"Quel âge avez-vous ?" },
        { id:'ls7', ko:'직업이 뭐예요?', fr:"Quel est votre métier ?" },
        { id:'ls8', ko:'한국어 공부는 재미있어요?', fr:"Est-ce que l'étude du coréen est amusante ?" },
        { id:'ls9', ko:'주말에 보통 뭐 해요?', fr:"Que faites-vous habituellement le week-end ?" },
        { id:'ls10', ko:'내일 같이 영화 볼까요?', fr:"Et si on allait voir un film demain ?" }
      ]
    };

    // ===== 상태 · 전역 =====
    let currentStage = 0;
    const totalStages = 5;
    const studentData = { recordings:{} };
    let startTime;
    let finishInProgress = false;

    const counters = { listen:{}, hint1:{}, hint2:{} };
    const ensureCounter = (obj, key) => { if (!obj[key]) obj[key]=0; };

    // ===== DOM 참조 =====
    const progressBar = document.getElementById('progress-bar');
    const sections = document.querySelectorAll('.section');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    const startBtn = document.getElementById('start-btn');
    const studentNameInput = document.getElementById('studentName');

    // ===== 유틸 =====
    function base64ToBlob(base64, mimeType){
      const byteChars = atob(base64);
      const byteNumbers = new Array(byteChars.length);
      for(let i=0;i<byteChars.length;i++) byteNumbers[i]=byteChars.charCodeAt(i);
      return new Blob([new Uint8Array(byteNumbers)], { type:mimeType });
    }

    // ===== 초기화 =====
    function initializeTest(){
      const placeholders = ["만수르","빌 게이츠","일론 머스크","슈퍼스타 이재용","방탄소년단 RM","마리","줄리","소피","뤼시"];
      studentNameInput.placeholder = `예) ${placeholders[Math.floor(Math.random()*placeholders.length)]}`;

      // Stage 1
      const listenReadContainer = document.getElementById('listen-read-tasks');
      testData.listenRead.forEach((task,i)=>{
        listenReadContainer.insertAdjacentHTML('beforeend', createRecordingTaskHTML(task.id, i+1, task.ko, true));
      });

      // Stage 2
      const readAloneContainer = document.getElementById('read-alone-tasks');
      testData.readAlone.forEach((task,i)=>{
        readAloneContainer.insertAdjacentHTML('beforeend', createRecordingTaskHTML(task.id, i+1, task.ko, false));
      });

      // Stage 3
      initializeVocabGame();

      // Stage 4
      const comp = document.getElementById('comprehension-tasks');
      testData.comprehension.forEach((task,i)=>{
        comp.insertAdjacentHTML('beforeend', `
          <div class="p-4 border rounded-lg" data-task-id="${task.id}">
            <p class="text-lg font-semibold mb-2">${i+1}. ${task.ko}</p>
            <input id="comprehension-input-${task.id}" type="text" class="w-full p-2 border rounded-md" placeholder="Français...">
          </div>
        `);
      });

      // Stage 5
      const lsWrap = document.getElementById('listen-speak-tasks');
      testData.listenSpeak.forEach((task,i)=>{
        lsWrap.insertAdjacentHTML('beforeend', `
          <div class="p-4 border rounded-lg bg-gray-50" data-task-id="${task.id}">
            <p class="text-lg font-bold mb-3">Question ${i+1}</p>
            <div class="space-y-4">
              <div>
                <label class="block font-semibold mb-1">a) Écoutez et écrivez (듣고 받아쓰기)</label>
                <div class="flex items-center gap-2">
                  <button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-id="${task.id}" data-text="${task.ko}">🔊 Écouter</button>
                  <input type="text" id="ls-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="Coréen...">
                </div>
              </div>
              <div>
                <label class="block font-semibold mb-1">b) Traduisez (불어로 번역)</label>
                <input type="text" id="ls-translation-${task.id}" class="w-full p-2 border rounded-md" placeholder="Français...">
              </div>
              <div>
                <label class="block font-semibold mb-1">c) Répondez en coréen (한국어로 답변 녹음)</label>
                ${createRecordingTaskHTML(task.id+'-answer', null, '', false)}
              </div>
              <div>
                <label class="block font-semibold mb-1">d) Écoutez votre enregistrement et écrivez (자기 녹음 듣고 받아쓰기)</label>
                <input type="text" id="ls-self-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="Coréen...">
              </div>
            </div>
          </div>
        `);
      });

      addEventListeners();
    }

    function createRecordingTaskHTML(id, number, sentence, includePlayBtn){
      return `
        <div class="p-4 border rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4" data-task-id="${id}">
          <div class="flex-grow">${number ? `<p class="text-lg font-semibold">${number}. ${sentence}</p>` : ''}</div>
          <div class="flex items-center gap-2">
            ${includePlayBtn ? `<button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-id="${id}" data-text="${sentence}">🔊</button>` : ''}
            <button class="record-btn btn-action bg-green-500 text-white py-2 px-4 rounded-lg flex items-center gap-1" data-id="${id}">
              <span class="icon">🎤</span><span class="text hidden sm:inline"> 녹음</span>
            </button>
            <div class="recording-status hidden items-center gap-2 text-red-500">
              <div class="recording-dot"></div>
            </div>
            <audio controls class="hidden w-40 h-10" id="audio-${id}"></audio>
          </div>
        </div>
      `;
    }

    // ===== 어휘 게임 =====
    function initializeVocabGame(){
      const game = document.getElementById('vocab-game');
      const scoreEl = document.getElementById('vocab-score');
      let score = 0, selectedKo=null, selectedFr=null, lock=false;

      const korean = [...testData.vocabulary];
      const french = [...testData.vocabulary].sort(()=>Math.random()-.5);

      const koCol = document.createElement('div'); koCol.className='flex flex-col gap-2';
      const frCol = document.createElement('div'); frCol.className='flex flex-col gap-2';

      korean.forEach(w=>{
        const b=document.createElement('button');
        b.className='vocab-card'; b.textContent=w.ko; b.dataset.id=w.id; b.dataset.lang='ko';
        koCol.appendChild(b);
      });
      french.forEach(w=>{
        const b=document.createElement('button');
        b.className='vocab-card'; b.textContent=w.fr; b.dataset.id=w.id; b.dataset.lang='fr';
        frCol.appendChild(b);
      });

      game.append(koCol,frCol);

      game.addEventListener('click', e=>{
        if (lock) return;
        const t=e.target;
        if (!t.classList.contains('vocab-card') || t.classList.contains('correct')) return;

        if (t.dataset.lang==='ko'){
          if (selectedKo) selectedKo.classList.remove('selected');
          selectedKo=t; selectedKo.classList.add('selected');
        } else {
          if (selectedFr) selectedFr.classList.remove('selected');
          selectedFr=t; selectedFr.classList.add('selected');
        }

        if (selectedKo && selectedFr){
          lock=true;
          if (selectedKo.dataset.id===selectedFr.dataset.id){
            score++; scoreEl.textContent=score;
            selectedKo.classList.add('correct'); selectedFr.classList.add('correct');
            selectedKo.classList.remove('selected'); selectedFr.classList.remove('selected');
            selectedKo=null; selectedFr=null; lock=false;
            if (score===testData.vocabulary.length){
              setTimeout(()=>alert('어휘 테스트 완료! (Test de vocabulaire terminé !)'),200);
            }
          } else {
            selectedKo.classList.add('incorrect'); selectedFr.classList.add('incorrect');
            setTimeout(()=>{
              selectedKo.classList.remove('selected','incorrect');
              selectedFr.classList.remove('selected','incorrect');
              selectedKo=null; selectedFr=null; lock=false;
            },700);
          }
        }
      });
    }

    // ===== 이벤트 =====
    function addEventListeners(){
      // 동적 버튼 위임
      document.body.addEventListener('click', (e)=>{
        const playBtn = e.target.closest('.play-audio-btn');
        const recBtn  = e.target.closest('.record-btn');
        if (playBtn) playAudio(playBtn.dataset.text, playBtn);
        if (recBtn)  toggleRecording(recBtn);
      });

      document.getElementById('print-btn')?.addEventListener('click', ()=>window.print());
    }

    // ===== 오디오 재생 (안정형) =====
    const playAudio = async (text, button)=>{
      const originalHTML = button.innerHTML;
      const taskEl = button.closest('[data-task-id]');
      const taskId = taskEl?.getAttribute('data-task-id') || button.dataset.id || text;

      button.disabled = true;
      button.innerHTML = '🔊...';
      try{
        const res = await fetch('/.netlify/functions/generate-audio',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text })
        });
        if (!res.ok) throw new Error(`TTS ${res.status} ${res.statusText}`);
        const { audioData, mimeType } = await res.json();

        const blob = base64ToBlob(audioData, mimeType || 'audio/mp3');
        const url  = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();

        if (taskId){ ensureCounter(counters.listen, taskId); counters.listen[taskId]+=1; }

        audio.onended = ()=>{ URL.revokeObjectURL(url); button.disabled=false; button.innerHTML=originalHTML; };
        audio.onerror = ()=>{ URL.revokeObjectURL(url); button.disabled=false; button.innerHTML=originalHTML; alert('오디오 재생 오류가 발생했습니다.'); };
      }catch(err){
        console.error(err);
        button.disabled=false; button.innerHTML=originalHTML;
        alert('오디오를 재생할 수 없습니다. 잠시 후 다시 시도해 주세요.');
      }
    };

    // ===== 녹음 =====
    const mediaRecorders = {};
    const audioChunks = {};
    async function toggleRecording(button){
      const id = button.dataset.id;
      const statusDiv = button.nextElementSibling;
      const audioEl = document.getElementById(`audio-${id}`);

      if (!mediaRecorders[id] || mediaRecorders[id].state==='inactive'){
        try{
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          const options = { mimeType:'audio/webm' };
          mediaRecorders[id] = new MediaRecorder(stream, options);
          audioChunks[id] = [];
          let startedAt = 0;

          mediaRecorders[id].ondataavailable = e => audioChunks[id].push(e.data);
          mediaRecorders[id].onstop = ()=>{
            const duration = Math.round((Date.now()-startedAt)/1000);
            const blob = new Blob(audioChunks[id], { type:options.mimeType });
            const url = URL.createObjectURL(blob);
            audioEl.src = url;
            audioEl.classList.remove('hidden');

            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = ()=>{
              studentData.recordings[id] = {
                base64: (reader.result||'').split(',')[1] || '',
                filename: `recording_${id}.webm`,
                mimeType: options.mimeType,
                duration
              };
            };
          };

          startedAt = Date.now();
          mediaRecorders[id].start();
          button.querySelector('.icon').textContent='⏹️';
          button.querySelector('.text').textContent=' 중지';
          button.classList.replace('bg-green-500','bg-red-500');
          statusDiv.classList.remove('hidden');

        }catch(err){
          alert("마이크 접근 권한이 필요합니다. (L'accès au microphone est requis.)");
        }
      } else {
        mediaRecorders[id].stop();
        button.querySelector('.icon').textContent='🎤';
        button.querySelector('.text').textContent=' 녹음';
        button.classList.replace('bg-red-500','bg-green-500');
        statusDiv.classList.add('hidden');
      }
    }

    // ===== 네비게이션 =====
    function updateStage(newStage){
      if (newStage<0 || newStage>totalStages+1) return;
      currentStage = newStage;

      sections.forEach(s=>s.classList.remove('active'));
      document.getElementById(`stage-${currentStage}`)?.classList.add('active');

      const progress = (currentStage>0) ? ((currentStage-1)/totalStages)*100 : 0;
      progressBar.style.width = `${progress}%`;
      progressBar.textContent = `${Math.round(progress)}%`;

      prevBtn.classList.toggle('hidden', currentStage<=1);
      nextBtn.classList.toggle('hidden', currentStage>=totalStages || currentStage===0);
      finishBtn.classList.toggle('hidden', currentStage!==totalStages);
    }

    startBtn.addEventListener('click', ()=>{
      const name = studentNameInput.value.trim();
      if (!name){
        alert('이름을 입력해주세요! (Veuillez entrer votre nom !)');
        studentNameInput.focus(); return;
      }
      studentData.name = name;
      startTime = new Date();
      updateStage(1);
    });

    nextBtn.addEventListener('click', ()=>updateStage(currentStage+1));
    prevBtn.addEventListener('click', ()=>updateStage(currentStage-1));

    // ===== 결과 집계 =====
    function collectAllData(){
      const questions = [];
      let qNum = 1;

      // Stage 1 & 2
      [...testData.listenRead, ...testData.readAlone].forEach(task=>{
        questions.push({
          number: qNum++,
          ko: task.ko,
          fr: task.fr,
          userAnswer: '',
          isCorrect: null,
          listenCount: counters.listen[task.id] || 0,
          hint1Count: counters.hint1[task.id] || 0,
          hint2Count: counters.hint2[task.id] || 0,
          recording: studentData.recordings[task.id] || null
        });
      });

      // Stage 3
      const vocabScore = parseInt(document.getElementById('vocab-score').textContent,10) || 0;
      questions.push({
        number: qNum++,
        ko: '어휘 짝짓기 게임',
        fr: "Jeu d'association de vocabulaire",
        userAnswer: `Score: ${vocabScore} / ${testData.vocabulary.length}`,
        isCorrect: vocabScore === testData.vocabulary.length,
        listenCount: 0, hint1Count: 0, hint2Count: 0
      });

      // Stage 4
      testData.comprehension.forEach(task=>{
        const ans = document.getElementById(`comprehension-input-${task.id}`).value || '';
        questions.push({
          number: qNum++,
          ko: task.ko,
          fr: `(Question de compréhension) ${task.fr}`,
          userAnswer: ans,
          isCorrect: null,
          listenCount: 0, hint1Count: 0, hint2Count: 0
        });
      });

      // Stage 5
      testData.listenSpeak.forEach(task=>{
        const dictation = document.getElementById(`ls-dictation-${task.id}`).value || '';
        const translation = document.getElementById(`ls-translation-${task.id}`).value || '';
        const selfDictation = document.getElementById(`ls-self-dictation-${task.id}`).value || '';
        questions.push({
          number: qNum++,
          ko: `(질문) ${task.ko}`,
          fr: `(Question) ${task.fr}`,
          userAnswer: JSON.stringify({ dictation, translation, selfDictation }),
          isCorrect: null,
          listenCount: counters.listen[task.id] || 0,
          hint1Count: counters.hint1[task.id] || 0,
          hint2Count: counters.hint2[task.id] || 0,
          recording: studentData.recordings[task.id+'-answer'] || null
        });
      });

      return questions;
    }

    // ===== 제출/전송 =====
    finishBtn.addEventListener('click', async ()=>{
      if (finishInProgress) return; // 이중 방지
      finishInProgress = true;
      finishBtn.disabled = true;
      finishBtn.textContent = '결과를 전송하는 중...';

      const questions = collectAllData();
      const endTime = new Date();

      const payload = {
        studentName: studentData.name,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        totalTimeSeconds: Math.round((endTime - startTime)/1000),
        questions
      };

      try{
        const res = await fetch('/.netlify/functions/send-results',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Server responded with an error');

        // ✅ 학생에게는 점수/세부내용 미표시 — 간단 메시지만
        const resultHTML = `
          <div class="task-container text-center">
            <h1 class="text-3xl font-bold text-green-600 mb-6">✅ 테스트 완료</h1>
            <p class="text-lg text-gray-800 leading-relaxed">
              수고하셨어요! 자세한 피드백은 시범수업에서 드릴게요. <br/>
              <span class="text-blue-700 text-base">
                (Merci pour vos efforts ! Le feedback détaillé sera donné pendant le cours d’essai.)
              </span>
            </p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
              <a href="/assignments/" class="w-full sm:w-auto text-center bg-white border border-gray-300 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-100">
                ⬅️ 이전 연습문제로 가기
              </a>
              <button id="print-result-btn" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-100">
                🖨️ 인쇄하기 / Imprimer
              </button>
            </div>
            <div class="creator-stamp" style="margin-top:24px">
              made by <strong>성일, Pondant</strong> · <a class="underline" href="mailto:Lapeace29@gmail.com">Lapeace29@gmail.com</a>
            </div>
          </div>
          <script>
            document.getElementById('print-result-btn')?.addEventListener('click', ()=>window.print());
          <\/script>
        `;
        document.body.innerHTML = resultHTML;

      }catch(err){
        console.error('결과 전송 실패:', err);
        alert('결과 전송에 실패했습니다. 인터넷 연결을 확인하고 다시 시도해 주세요.');
        finishBtn.disabled=false;
        finishBtn.textContent='제출하고 종료 (Terminer)';
        finishInProgress = false;
      }
    });

    // ===== 시작 =====
    initializeTest();
  </script>
</body>
</html>
