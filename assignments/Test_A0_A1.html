<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ì–´ ì‹¤ë ¥ í…ŒìŠ¤íŠ¸ (Test de niveau de corÃ©en)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .creator-stamp {
            font-size: 0.8rem;
            color: #aaa;
            text-align: center;
            padding: 20px 0;
        }

        .task-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none; /* ê° ë‹¨ê³„ëŠ” ì²˜ìŒì— ìˆ¨ê¹€ */
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
        }
        .section.active {
            display: block; /* í˜„ì¬ ë‹¨ê³„ë§Œ ë³´ì„ */
        }

        .btn-action {
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .progress-bar {
            height: 20px;
            width: 0%;
            background-color: #4a90e2;
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        /* ì–´íœ˜ ê²Œì„ ìŠ¤íƒ€ì¼ */
        .vocab-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .vocab-card {
            padding: 1rem;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-size: 1.1rem;
        }
        .vocab-card.selected {
            background-color: #bfdbfe;
            border-color: #3b82f6;
        }
        .vocab-card.correct {
            background-color: #d1fae5;
            border-color: #10b981;
            cursor: default;
            opacity: 0.7;
        }
        .vocab-card.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
    </style>
</head>

<body class="bg-gray-50">

    <div class="creator-stamp top">Made by ì„±ì¼, Pondant, Laon</div>

    <div class="task-container">
        <!-- í—¤ë” -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">í•œêµ­ì–´ ë ˆë²¨ í…ŒìŠ¤íŠ¸ â±ï¸</h1>
            <h2 class="text-xl font-semibold text-blue-600">A0-A1 Niveau DÃ©butant</h2>
            <p class="text-gray-600 mt-2">ìƒˆë¡œìš´ ì‹œì‘ì„ ì‘ì›í•´ìš”! 5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ í˜„ì¬ ì‹¤ë ¥ì„ í™•ì¸í•´ ë³´ì„¸ìš”. <br>Bienvenue ! Faisons un test en 5 Ã©tapes pour voir oÃ¹ tu en es en corÃ©en.</p>
        </div>
        
        <!-- ì§„í–‰ë¥  ë°” -->
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>

        <!-- 0ë‹¨ê³„: ì‹œì‘ í™”ë©´ -->
        <div id="stage-0" class="section active text-center">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°</h2>
            <p class="mb-6">ì´ë¦„ì„ ì…ë ¥í•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”!</p>
            <div class="mb-4">
                <label for="studentName" class="block text-lg font-semibold text-gray-700 mb-2">ì´ë¦„ / Nom</label>
                <input type="text" id="studentName" class="w-full max-w-md mx-auto p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ) ìŠˆí¼ìŠ¤íƒ€ ì´ì¬ìš©">
            </div>
            <button id="start-btn" class="btn-action bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-indigo-700">ì‹œì‘! (Commencer !)</button>
        </div>

        <!-- 1ë‹¨ê³„: ë“£ê³  ì½ê¸° -->
        <div id="stage-1" class="section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">1ë‹¨ê³„: ë“£ê³  ì½ê¸° (Ã‰tape 1 : Ã‰couter et lire)</h2>
            <p class="mb-4">ë¬¸ì¥ì„ ë“£ê³ , ë”°ë¼ì„œ ì½ìœ¼ë©° ë…¹ìŒí•´ ì£¼ì„¸ìš”. <br>Ã‰coutez la phrase, puis lisez-la Ã  voix haute en vous enregistrant.</p>
            <div id="listen-read-tasks" class="space-y-6"></div>
        </div>

        <!-- 2ë‹¨ê³„: í˜¼ì ì½ê¸° -->
        <div id="stage-2" class="section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">2ë‹¨ê³„: í˜¼ì ì½ê¸° (Ã‰tape 2 : Lire seul)</h2>
            <p class="mb-4">ì•„ë˜ ë¬¸ì¥ì„ ë³´ê³  ì†Œë¦¬ ë‚´ì–´ ì½ìœ¼ë©° ë…¹ìŒí•´ ì£¼ì„¸ìš”. <br>Lisez la phrase ci-dessous Ã  voix haute en vous enregistrant.</p>
            <div id="read-alone-tasks" class="space-y-6"></div>
        </div>

        <!-- 3ë‹¨ê³„: ì–´íœ˜ í…ŒìŠ¤íŠ¸ -->
        <div id="stage-3" class="section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">3ë‹¨ê³„: ì–´íœ˜ í…ŒìŠ¤íŠ¸ (Ã‰tape 3 : Test de vocabulaire)</h2>
            <p class="mb-4">ì—°ê´€ëœ í•œêµ­ì–´ì™€ í”„ë‘ìŠ¤ì–´ ë‹¨ì–´ë¥¼ ì§ì§€ì–´ ë³´ì„¸ìš”! <br>Associez les mots corÃ©ens et franÃ§ais qui vont ensemble !</p>
            <p class="text-lg font-bold mb-4">ë§ì¶˜ ê°œìˆ˜ rÃ©ponse correcte : <span id="vocab-score">0</span> / 15</p>
            <div id="vocab-game" class="vocab-grid"></div>
        </div>

        <!-- 4ë‹¨ê³„: ì´í•´ë ¥ í…ŒìŠ¤íŠ¸ -->
        <div id="stage-4" class="section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">4ë‹¨ê³„: ì´í•´ë ¥ í…ŒìŠ¤íŠ¸ (Ã‰tape 4 : Test de comprÃ©hension)</h2>
            <p class="mb-4">ë¬¸ì¥ì„ ì½ê³  ì´í•´í•œ ëŒ€ë¡œ í”„ë‘ìŠ¤ì–´ë¡œ ì¨ë³´ì„¸ìš”. <br>Lisez la phrase et Ã©crivez ce que vous avez compris en franÃ§ais.</p>
            <div id="comprehension-tasks" class="space-y-6"></div>
        </div>

        <!-- 5ë‹¨ê³„: ë“£ê³  ë§í•˜ê¸° -->
        <div id="stage-5" class="section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">5ë‹¨ê³„: ë“£ê³  ë§í•˜ê¸° (Ã‰tape 5 : Ã‰couter et parler)</h2>
            <p class="mb-4">ì§ˆë¬¸ì„ ë“£ê³ , ë°›ì•„ì“°ê³ , ë²ˆì—­í•œ í›„, í•œêµ­ì–´ë¡œ ëŒ€ë‹µì„ ë…¹ìŒí•´ ë³´ì„¸ìš”. <br>Ã‰coutez la question, Ã©crivez-la, traduisez-la, puis enregistrez votre rÃ©ponse en corÃ©en.</p>
            <div id="listen-speak-tasks" class="space-y-8"></div>
        </div>
        
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="flex justify-between mt-8">
            <button id="prev-btn" class="btn-action bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 hidden">ì´ì „ (PrÃ©cÃ©dent)</button>
            <button id="next-btn" class="btn-action bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 hidden">ë‹¤ìŒ (Suivant)</button>
            <button id="finish-btn" class="w-full bg-green-600 text-white font-bold py-4 px-4 rounded-lg text-lg hover:bg-green-700 hidden">
                ì œì¶œí•˜ê³  ê²°ê³¼ í™•ì¸í•˜ê¸° (Terminer et voir les rÃ©sultats)
            </button>
        </div>
    </div>

    <div class="creator-stamp bottom">Made by ì„±ì¼, Pondant, Laon</div>

    <script type="module">
        // --- í…ŒìŠ¤íŠ¸ ë°ì´í„° ---
        const testData = {
            listenRead: [
                { id: 'lr1', ko: 'ì´ê²ƒì€ ì‚¬ê³¼ì…ë‹ˆë‹¤.', fr: "C'est une pomme." },
                { id: 'lr2', ko: 'ì €ëŠ” í•™ìƒì…ë‹ˆë‹¤.', fr: "Je suis Ã©tudiant(e)." },
                { id: 'lr3', ko: 'ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ì•„ìš”.', fr: "Il fait beau aujourd'hui." },
                { id: 'lr4', ko: 'í•œêµ­ì–´ë¥¼ ê³µë¶€í•´ìš”.', fr: "J'Ã©tudie le corÃ©en." },
                { id: 'lr5', ko: 'ì£¼ë§ì— ë­ í–ˆì–´ìš”?', fr: "Qu'as-tu fait ce week-end ?" }
            ],
            readAlone: [
                { id: 'ra1', ko: 'ì €ëŠ” ì•„ì¹¨ì„ ë¨¹ì–´ìš”.', fr: "Je prends le petit-dÃ©jeuner." },
                { id: 'ra2', ko: 'ê³ ì–‘ì´ê°€ ê·€ì—¬ì›Œìš”.', fr: "Le chat est mignon." },
                { id: 'ra3', ko: 'ì§€ê¸ˆ ëª‡ ì‹œì˜ˆìš”?', fr: "Quelle heure est-il ?" },
                { id: 'ra4', ko: 'ê°€ë°© ì•ˆì— ì±…ì´ ìˆì–´ìš”.', fr: "Il y a un livre dans le sac." },
                { id: 'ra5', ko: 'ë‚´ì¼ ì˜í™” ë³´ëŸ¬ ê°ˆê¹Œìš”?', fr: "On va voir un film demain ?" }
            ],
            vocabulary: [
                { id: 1, ko: 'í•™êµ', fr: 'Ã‰cole' }, { id: 2, ko: 'ì¹œêµ¬', fr: 'Ami(e)' },
                { id: 3, ko: 'ë¬¼', fr: 'Eau' }, { id: 4, ko: 'ë°¥', fr: 'Riz/Repas' },
                { id: 5, ko: 'ì˜¤ëŠ˜', fr: 'Aujourd\'hui' }, { id: 6, ko: 'ë‚´ì¼', fr: 'Demain' },
                { id: 7, ko: 'ê°€ë‹¤', fr: 'Aller' }, { id: 8, ko: 'ë³´ë‹¤', fr: 'Voir/Regarder' },
                { id: 9, ko: 'ë¨¹ë‹¤', fr: 'Manger' }, { id: 10, ko: 'í•˜ë‹¤', fr: 'Faire' },
                { id: 11, ko: 'í¬ë‹¤', fr: 'Grand(e)' }, { id: 12, ko: 'ì‘ë‹¤', fr: 'Petit(e)' },
                { id: 13, ko: 'ìˆë‹¤', fr: 'Avoir/ÃŠtre (lÃ )' }, { id: 14, ko: 'ì—†ë‹¤', fr: 'Ne pas avoir/Ne pas Ãªtre (lÃ )' },
                { id: 15, ko: 'ê°ì‚¬í•©ë‹ˆë‹¤', fr: 'Merci' }
            ],
            comprehension: [
                { id: 'c1', ko: 'ì €ëŠ” ë§¤ì¼ ìš´ë™í•´ìš”.', fr: "Je fais de l'exercice tous les jours." },
                { id: 'c2', ko: 'ì´ ë²„ìŠ¤ëŠ” ì–´ë””ë¡œ ê°€ìš”?', fr: "OÃ¹ va ce bus ?" },
                { id: 'c3', ko: 'ì§€ê¸ˆ ë¹„ê°€ ì™€ìš”.', fr: "Il pleut maintenant." },
                { id: 'c4', ko: 'ë„ì„œê´€ì€ ì €ìª½ì´ì—ìš”.', fr: "La bibliothÃ¨que est par lÃ -bas." },
                { id: 'c5', ko: 'ìƒì¼ ì¶•í•˜í•´ìš”!', fr: "Joyeux anniversaire !" },
                { id: 'c6', ko: 'ë„ˆë¬´ í”¼ê³¤í•´ì„œ ìê³  ì‹¶ì–´ìš”.', fr: "Je suis trÃ¨s fatiguÃ©(e) et je veux dormir." },
                { id: 'c7', ko: 'ì´ ìŒì‹ì€ ì¡°ê¸ˆ ë§¤ì›Œìš”.', fr: "Ce plat est un peu Ã©picÃ©." },
                { id: 'c8', ko: 'ì €ëŠ” ê°•ì•„ì§€ë¥¼ ë” ì¢‹ì•„í•´ìš”.', fr: "Je prÃ©fÃ¨re les chiens." },
                { id: 'c9', ko: 'ì§€í•˜ì² ì—­ê¹Œì§€ ê±¸ì–´ì„œ 10ë¶„ ê±¸ë ¤ìš”.', fr: "Ã‡a prend 10 minutes Ã  pied jusqu'Ã  la station de mÃ©tro." },
                { id: 'c10', ko: 'ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”.', fr: "On se revoit la prochaine fois." }
            ],
            listenSpeak: [
                { id: 'ls1', ko: 'ì´ë¦„ì´ ë­ì˜ˆìš”?', fr: "Comment vous appelez-vous ?" },
                { id: 'ls2', ko: 'ì–´ë””ì—ì„œ ì™”ì–´ìš”?', fr: "D'oÃ¹ venez-vous ?" },
                { id: 'ls3', ko: 'ì·¨ë¯¸ê°€ ë­ì˜ˆìš”?', fr: "Quel est votre loisir ?" },
                { id: 'ls4', ko: 'ë¬´ìŠ¨ ìŒì‹ì„ ì¢‹ì•„í•´ìš”?', fr: "Quel genre de nourriture aimez-vous ?" },
                { id: 'ls5', ko: 'ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë•Œìš”?', fr: "Comment vous sentez-vous aujourd'hui ?" },
                { id: 'ls6', ko: 'ëª‡ ì‚´ì´ì—ìš”?', fr: "Quel Ã¢ge avez-vous ?" },
                { id: 'ls7', ko: 'ì§ì—…ì´ ë­ì˜ˆìš”?', fr: "Quel est votre mÃ©tier ?" },
                { id: 'ls8', ko: 'í•œêµ­ì–´ ê³µë¶€ëŠ” ì¬ë¯¸ìˆì–´ìš”?', fr: "Est-ce que l'Ã©tude du corÃ©en est amusante ?" },
                { id: 'ls9', ko: 'ì£¼ë§ì— ë³´í†µ ë­ í•´ìš”?', fr: "Que faites-vous habituellement le week-end ?" },
                { id: 'ls10', ko: 'ë„ì™€ì¤„ê¹Œìš”?', fr: "Puis-je vous aider ?" }
            ]
        };

        // --- ìƒíƒœ ê´€ë¦¬ ---
        let currentStage = 0;
        const totalStages = 5;
        const studentData = {
            recordings: {}
        };
        let startTime;

        // --- UI ìš”ì†Œ ---
        const progressBar = document.getElementById('progress-bar');
        const sections = document.querySelectorAll('.section');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const startBtn = document.getElementById('start-btn');
        const studentNameInput = document.getElementById('studentName');

        // --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
        function initializeTest() {
            const placeholders = ["ë§Œìˆ˜ë¥´", "ë¹Œ ê²Œì´ì¸ ", "ì¼ë¡  ë¨¸ìŠ¤í¬", "ìŠˆí¼ìŠ¤íƒ€ ì´ì¬ìš©", "ë°©íƒ„ì†Œë…„ë‹¨ RM"];
            studentNameInput.placeholder = `ì˜ˆ) ${placeholders[Math.floor(Math.random() * placeholders.length)]}`;
            
            // 1ë‹¨ê³„: ë“£ê³  ì½ê¸°
            const listenReadContainer = document.getElementById('listen-read-tasks');
            testData.listenRead.forEach((task, index) => {
                listenReadContainer.innerHTML += createRecordingTaskHTML(task.id, index + 1, task.ko, true);
            });

            // 2ë‹¨ê³„: í˜¼ì ì½ê¸°
            const readAloneContainer = document.getElementById('read-alone-tasks');
            testData.readAlone.forEach((task, index) => {
                readAloneContainer.innerHTML += createRecordingTaskHTML(task.id, index + 1, task.ko, false);
            });
            
            // 3ë‹¨ê³„: ì–´íœ˜
            initializeVocabGame();

            // 4ë‹¨ê³„: ì´í•´ë ¥
            const comprehensionContainer = document.getElementById('comprehension-tasks');
            testData.comprehension.forEach((task, index) => {
                comprehensionContainer.innerHTML += `
                    <div class="p-4 border rounded-lg" data-task-id="${task.id}">
                        <p class="text-lg font-semibold mb-2">${index + 1}. ${task.ko}</p>
                        <div class="flex items-center gap-4">
                            <input type="text" id="comprehension-input-${task.id}" class="w-full p-2 border rounded-md" placeholder="FranÃ§ais...">
                        </div>
                    </div>
                `;
            });
            
            // 5ë‹¨ê³„: ë“£ê³  ë§í•˜ê¸°
            const listenSpeakContainer = document.getElementById('listen-speak-tasks');
            testData.listenSpeak.forEach((task, index) => {
                listenSpeakContainer.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-lg font-bold mb-3">Question ${index + 1}</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold mb-1">a) Ã‰coutez et Ã©crivez (ë“£ê³  ë°›ì•„ì“°ê¸°)</label>
                                <div class="flex items-center gap-2">
                                    <button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-text="${task.ko}">ğŸ”Š Ã‰couter</button>
                                    <input type="text" id="ls-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="CorÃ©en...">
                                </div>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">b) Traduisez (ë¶ˆì–´ë¡œ ë²ˆì—­)</label>
                                <input type="text" id="ls-translation-${task.id}" class="w-full p-2 border rounded-md" placeholder="FranÃ§ais...">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">c) RÃ©pondez en corÃ©en (í•œêµ­ì–´ë¡œ ë‹µë³€ ë…¹ìŒ)</label>
                                ${createRecordingTaskHTML(task.id + '-answer', null, '', false)}
                            </div>
                             <div>
                                <label class="block font-semibold mb-1">d) Ã‰coutez votre enregistrement et Ã©crivez (ìê¸° ë…¹ìŒ ë“£ê³  ë°›ì•„ì“°ê¸°)</label>
                                <input type="text" id="ls-self-dictation-${task.id}" class="w-full p-2 border rounded-md" placeholder="CorÃ©en...">
                            </div>
                        </div>
                    </div>
                `;
            });

            addEventListeners();
        }

        function createRecordingTaskHTML(id, number, sentence, includePlayBtn) {
            return `
                <div class="p-4 border rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex-grow">
                        ${number ? `<p class="text-lg font-semibold">${number}. ${sentence}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${includePlayBtn ? `<button class="play-audio-btn btn-action bg-blue-500 text-white py-2 px-4 rounded-lg" data-text="${sentence}">ğŸ”Š</button>` : ''}
                        <button class="record-btn btn-action bg-green-500 text-white py-2 px-4 rounded-lg flex items-center gap-1" data-id="${id}">
                            <span class="icon">ğŸ¤</span><span class="text hidden sm:inline"> ë…¹ìŒ</span>
                        </button>
                        <div class="recording-status hidden items-center gap-2 text-red-500">
                            <div class="recording-dot"></div>
                        </div>
                        <audio controls class="hidden w-40 h-10" id="audio-${id}"></audio>
                    </div>
                </div>
            `;
        }

        // --- ì–´íœ˜ ê²Œì„ ë¡œì§ ---
        function initializeVocabGame() {
            const gameContainer = document.getElementById('vocab-game');
            const scoreEl = document.getElementById('vocab-score');
            let score = 0;
            let selectedKo = null, selectedFr = null;
            let lockBoard = false;

            const koreanWords = [...testData.vocabulary];
            const frenchWords = [...testData.vocabulary].sort(() => 0.5 - Math.random());

            const koContainer = document.createElement('div');
            koContainer.className = 'flex flex-col gap-2';
            const frContainer = document.createElement('div');
            frContainer.className = 'flex flex-col gap-2';

            koreanWords.forEach(word => {
                const card = document.createElement('button');
                card.className = 'vocab-card';
                card.textContent = word.ko;
                card.dataset.id = word.id;
                card.dataset.lang = 'ko';
                koContainer.appendChild(card);
            });

            frenchWords.forEach(word => {
                const card = document.createElement('button');
                card.className = 'vocab-card';
                card.textContent = word.fr;
                card.dataset.id = word.id;
                card.dataset.lang = 'fr';
                frContainer.appendChild(card);
            });

            gameContainer.append(koContainer, frContainer);

            gameContainer.addEventListener('click', (e) => {
                if (lockBoard || !e.target.classList.contains('vocab-card') || e.target.classList.contains('correct')) return;

                const clickedCard = e.target;

                if (clickedCard.dataset.lang === 'ko') {
                    if (selectedKo) selectedKo.classList.remove('selected');
                    selectedKo = clickedCard;
                    selectedKo.classList.add('selected');
                } else {
                    if (selectedFr) selectedFr.classList.remove('selected');
                    selectedFr = clickedCard;
                    selectedFr.classList.add('selected');
                }

                if (selectedKo && selectedFr) {
                    lockBoard = true;
                    if (selectedKo.dataset.id === selectedFr.dataset.id) {
                        score++;
                        scoreEl.textContent = score;
                        selectedKo.classList.add('correct');
                        selectedFr.classList.add('correct');
                        selectedKo.classList.remove('selected');
                        selectedFr.classList.remove('selected');
                        selectedKo = null;
                        selectedFr = null;
                        lockBoard = false;
                        if (score === testData.vocabulary.length) {
                           setTimeout(() => alert('ì–´íœ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! (Test de vocabulaire terminÃ© !)'), 200);
                        }
                    } else {
                        selectedKo.classList.add('incorrect');
                        selectedFr.classList.add('incorrect');
                        setTimeout(() => {
                            selectedKo.classList.remove('selected', 'incorrect');
                            selectedFr.classList.remove('selected', 'incorrect');
                            selectedKo = null;
                            selectedFr = null;
                            lockBoard = false;
                        }, 800);
                    }
                }
            });
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ---
        function addEventListeners() {
            document.querySelectorAll('.play-audio-btn').forEach(btn => {
                btn.addEventListener('click', () => playAudio(btn.dataset.text, btn));
            });
            document.querySelectorAll('.record-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleRecording(btn));
            });
        }
        
        // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        const playAudio = async (text, button) => {
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'ğŸ”Š...';
            try {
                const response = await fetch('/.netlify/functions/generate-audio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text }),
                });
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                
                const { audioData, mimeType } = await response.json();
                const audio = new Audio(`data:${mimeType};base64,${audioData}`);
                audio.play();
                audio.onended = () => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                };
            } catch (error) {
                console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        };

        let mediaRecorders = {};
        let audioChunks = {};
        function toggleRecording(button) {
            const id = button.dataset.id;
            const statusDiv = button.nextElementSibling;
            const audioEl = document.getElementById(`audio-${id}`);
            
            if (!mediaRecorders[id] || mediaRecorders[id].state === "inactive") {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const options = { mimeType: 'audio/webm' };
                        mediaRecorders[id] = new MediaRecorder(stream, options);
                        audioChunks[id] = [];
                        let recordingStartTime;

                        mediaRecorders[id].ondataavailable = e => audioChunks[id].push(e.data);
                        
                        mediaRecorders[id].onstop = () => {
                            const duration = Math.round((Date.now() - recordingStartTime) / 1000);
                            const blob = new Blob(audioChunks[id], { type: options.mimeType });
                            const audioURL = window.URL.createObjectURL(blob);
                            audioEl.src = audioURL;
                            audioEl.classList.remove('hidden');
                            
                            const reader = new FileReader();
                            reader.readAsDataURL(blob); 
                            reader.onloadend = function() {
                                studentData.recordings[id] = {
                                    base64: reader.result.split(',')[1],
                                    filename: `recording_${id}.webm`,
                                    mimeType: options.mimeType,
                                    duration: duration
                                };
                            }
                        };
                        
                        recordingStartTime = Date.now();
                        mediaRecorders[id].start();
                        button.querySelector('.icon').textContent = 'â¹ï¸';
                        button.querySelector('.text').textContent = ' ì¤‘ì§€';
                        button.classList.replace('bg-green-500', 'bg-red-500');
                        statusDiv.classList.remove('hidden');
                    }).catch(err => alert("ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. (L'accÃ¨s au microphone est requis.)"));
            } else {
                mediaRecorders[id].stop();
                button.querySelector('.icon').textContent = 'ï¿½';
                button.querySelector('.text').textContent = ' ë…¹ìŒ';
                button.classList.replace('bg-red-500', 'bg-green-500');
                statusDiv.classList.add('hidden');
            }
        }

        // --- ë„¤ë¹„ê²Œì´ì…˜ ë° ì§„í–‰ ê´€ë¦¬ ---
        function updateStage(newStage) {
            if (newStage < 0 || newStage > totalStages + 1) return;
            currentStage = newStage;
            
            sections.forEach(s => s.classList.remove('active'));
            const activeSection = document.getElementById(`stage-${currentStage}`);
            if(activeSection) activeSection.classList.add('active');

            const progress = (currentStage > 0) ? ((currentStage -1) / totalStages) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;

            prevBtn.classList.toggle('hidden', currentStage <= 1);
            nextBtn.classList.toggle('hidden', currentStage >= totalStages || currentStage === 0);
            finishBtn.classList.toggle('hidden', currentStage !== totalStages);
        }

        startBtn.addEventListener('click', () => {
            const studentName = studentNameInput.value.trim();
            if (!studentName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! (Veuillez entrer votre nom !)');
                studentNameInput.focus();
                return;
            }
            studentData.name = studentName;
            startTime = new Date();
            updateStage(1);
        });

        nextBtn.addEventListener('click', () => updateStage(currentStage + 1));
        prevBtn.addEventListener('click', () => updateStage(currentStage - 1));
        
        function collectAllData() {
            const questions = [];
            let questionNumber = 1;

            // Stage 1 & 2
            [...testData.listenRead, ...testData.readAlone].forEach(task => {
                questions.push({
                    number: questionNumber++,
                    ko: task.ko,
                    fr: task.fr,
                    userAnswer: '',
                    isCorrect: null,
                    recording: studentData.recordings[task.id] || null
                });
            });

            // Stage 3
            const vocabScore = document.getElementById('vocab-score').textContent;
            questions.push({
                number: questionNumber++,
                ko: 'ì–´íœ˜ ì§ì§“ê¸° ê²Œì„',
                fr: 'Jeu d\'association de vocabulaire',
                userAnswer: `Score: ${vocabScore} / ${testData.vocabulary.length}`,
                isCorrect: parseInt(vocabScore) === testData.vocabulary.length,
            });

            // Stage 4
            testData.comprehension.forEach(task => {
                const userAnswer = document.getElementById(`comprehension-input-${task.id}`).value;
                questions.push({
                    number: questionNumber++,
                    ko: task.ko,
                    fr: `(Question de comprÃ©hension) ${task.fr}`,
                    userAnswer: userAnswer,
                    isCorrect: null,
                });
            });

            // Stage 5
            testData.listenSpeak.forEach(task => {
                const dictation = document.getElementById(`ls-dictation-${task.id}`).value;
                const translation = document.getElementById(`ls-translation-${task.id}`).value;
                const selfDictation = document.getElementById(`ls-self-dictation-${task.id}`).value;
                questions.push({
                    number: questionNumber++,
                    ko: `(ì§ˆë¬¸) ${task.ko}`,
                    fr: `(Question) ${task.fr}`,
                    userAnswer: JSON.stringify({ dictation, translation, selfDictation }),
                    isCorrect: null,
                    recording: studentData.recordings[task.id + '-answer'] || null
                });
            });

            return questions;
        }

        finishBtn.addEventListener('click', async () => {
            finishBtn.disabled = true;
            finishBtn.textContent = 'ê²°ê³¼ë¥¼ ì „ì†¡í•˜ëŠ” ì¤‘...';
            
            const questions = collectAllData();
            const endTime = new Date();
            
            const payload = {
                studentName: studentData.name,
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                totalTimeSeconds: Math.round((endTime - startTime) / 1000),
                questions: questions
            };

            try {
                const response = await fetch('/.netlify/functions/send-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const vocabScore = document.getElementById('vocab-score').textContent;
                    const vocabTotal = testData.vocabulary.length;

                    let comprehensionHTML = '';
                    testData.comprehension.forEach((task, index) => {
                        const userAnswer = document.getElementById(`comprehension-input-${task.id}`).value;
                        comprehensionHTML += `
                            <div class="text-left p-3 bg-gray-50 rounded-md mb-2">
                                <p class="font-semibold text-gray-700">${index + 1}. ${task.ko}</p>
                                <p class="text-blue-600">Votre rÃ©ponse : <span class="font-mono">${userAnswer || '(vide)'}</span></p>
                            </div>
                        `;
                    });

                    const resultHTML = `
                        <div class="task-container text-center">
                            <h1 class="text-4xl font-bold text-green-600 mb-4">ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰</h1>
                            <p class="text-lg text-gray-700 mb-6">ìˆ˜ê³  ë§ì•˜ì–´ìš”, ${studentData.name}ë‹˜! ê²°ê³¼ë¥¼ ì„ ìƒë‹˜ê»˜ ì•ˆì „í•˜ê²Œ ë³´ëƒˆì–´ìš”.</p>
                            
                            <div class="bg-gray-100 p-6 rounded-lg border border-gray-200 text-left">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (AperÃ§u des rÃ©sultats)</h2>
                                
                                <div class="mb-4">
                                    <h3 class="text-xl font-semibold text-indigo-700">3ë‹¨ê³„: ì–´íœ˜ (Vocabulaire)</h3>
                                    <p class="text-lg">ë§ì¶˜ ê°œìˆ˜: <span class="font-bold">${vocabScore} / ${vocabTotal}</span></p>
                                </div>

                                <div>
                                    <h3 class="text-xl font-semibold text-indigo-700">4ë‹¨ê³„: ì´í•´ë ¥ (ComprÃ©hension)</h3>
                                    ${comprehensionHTML}
                                </div>
                            </div>

                            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 mt-6">
                                <p class="text-blue-800 font-semibold">ë§í•˜ê¸°, ì½ê¸° ë“± ë‚˜ë¨¸ì§€ íŒŒíŠ¸ì˜ ìì„¸í•œ ê²°ê³¼ëŠ” ì„ ìƒë‹˜ì´ ì‹œë²” ìˆ˜ì—…ì—ì„œ ì§ì ‘ í”¼ë“œë°±í•´ ì£¼ì‹¤ ê±°ì˜ˆìš”. ê³§ ë§Œë‚˜ìš”!</p>
                                <p class="text-blue-700 mt-2 text-sm">Les rÃ©sultats dÃ©taillÃ©s pour l'expression orale, la lecture, etc., seront discutÃ©s par votre professeur lors du cours d'essai. Ã€ bientÃ´t !</p>
                            </div>

                            <div class="creator-stamp" style="margin-top: 40px;">Made by ì„±ì¼, Pondant, Laon</div>
                        </div>
                    `;
                    document.body.innerHTML = resultHTML;
                } else {
                    throw new Error('Server responded with an error');
                }
            } catch (error) {
                console.error('ê²°ê³¼ ì „ì†¡ ì‹¤íŒ¨:', error);
                alert('ê²°ê³¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                finishBtn.disabled = false;
                finishBtn.textContent = 'ì œì¶œí•˜ê³  ê²°ê³¼ í™•ì¸í•˜ê¸°';
            }
        });

        // --- ì´ˆê¸° ì‹¤í–‰ ---
        initializeTest();
    </script>
</body>
</html>
ï¿½
