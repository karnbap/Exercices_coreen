<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comment dire Â« Comme Â» en corÃ©en | ê°™ì•„ìš” Â· ì²˜ëŸ¼ Â· ê°™ì´ Â· ê°™ì€ (Ã‰crit)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#f0f4f8;color:#0f172a}
    .korean-font{font-family:'Gowun Dodum',sans-serif}
    .card{background:#fff;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1)}
    .btn{display:inline-block;padding:.5rem 1rem;border-radius:.75rem;font-weight:600;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
    .btn-secondary{background:#f3f4f6;color:#374151;border-color:#e5e7eb}
    .btn-secondary:hover:not(:disabled){background:#e5e7eb}
    .btn-primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
    .btn-primary:hover:not(:disabled){background:#1d4ed8}
    .btn.selected{background:#dbeafe;border-color:#93c5fd;color:#1e40af}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    .exercise-item{padding:1.5rem;border:1px solid #e5e7eb;border-radius:1rem;margin-bottom:1.5rem;background:#fff;transition:background-color .3s}
    .feedback{padding:1rem;border-radius:.75rem;margin-top:1rem}
    .feedback.correct{background:#dcfce7;color:#166534}
    .feedback.incorrect{background:#fee2e2;color:#991b1b}
    .feedback.soft{background:#fef9c3;color:#854d0e}
    .made-by-top,.made-by-bottom{ text-align:center; padding:.5rem; color:#475569; font-size:.875rem }
    .made-by-top{ border-bottom:1px solid #e5e7eb }
    .made-by-bottom{ border-top:1px solid #e5e7eb; margin-top:2rem }
    .print-btn{ position:sticky; top:.75rem; float:right; margin-top:-.5rem }
    .hint-note{background:#fff7ed;border:1px solid #fed7aa; white-space: pre-wrap; padding-left: 0.75rem; border-left: 4px solid #fb923c;}
  </style>
</head>

<body class="text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <!-- ìƒë‹¨ í¬ë ˆë”§ + ì¸ì‡„ -->
    <div class="made-by-top">
      made by ì„±ì¼, Pongdang Â·
      <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
      Â· <button onclick="window.print()" class="btn btn-secondary print-btn">ğŸ–¨ï¸ Imprimer</button>
    </div>

    <!-- Header -->
    <header class="text-center mb-6">
      <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-2">Comme en CorÃ©en (Ã‰crit) ğŸ‡°ğŸ‡·</h1>
      <p class="text-lg text-slate-600">Exercice d'Ã©criture: ê°™ì•„ìš” Â· ì²˜ëŸ¼ Â· ê°™ì´ Â· ê°™ì€</p>
    </header>

    <!-- Student bar -->
    <div id="student-bar" class="flex items-center gap-3 mb-6 p-3 rounded-lg bg-white border border-slate-200">
      <label class="text-sm text-slate-600">ğŸ‘¤ Nom (ì´ë¦„)</label>
      <input id="student-name" type="text" class="p-2 border rounded-md flex-1" placeholder="ex) Julie / CÃ©dric / Naomi" />
      <span class="text-xs text-slate-500">ëª¨ë“  ê¸°ë¡(íŒíŠ¸/ì ìˆ˜)ì— ì´ë¦„ì´ í¬í•¨ë¼ìš”.</span>
    </div>

    <!-- Exercises Section -->
    <section id="exercises">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold text-slate-700">Exercices (20)</h2>
        <button id="reset-btn" class="btn btn-secondary">Recommencer</button>
      </div>
      <div id="exercise-list"></div>
    </section>

    <!-- Page actions -->
    <div id="page-actions" class="mt-8 flex flex-col md:flex-row gap-3 md:items-center justify-between">
      <div class="flex gap-2">
        <a href="../index.html" class="btn btn-secondary">âŸµ Accueil</a>
        <a href="../assignments/Exercice_ecrit_comme.html" class="btn btn-secondary">âŸµ Exercice prÃ©cÃ©dent</a>
      </div>
      <div class="flex gap-2">
        <button id="finish-btn" class="btn btn-primary">âœ… Terminer / ëë‚´ê¸°</button>
        <button id="retry-btn" class="btn btn-secondary">ğŸ” Recommencer</button>
      </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="hidden mt-6 p-4 rounded-xl bg-slate-50 border border-slate-200"></div>

    <!-- í•˜ë‹¨ í¬ë ˆë”§ -->
    <div class="made-by-bottom">
      made by ì„±ì¼, Pongdang Â· <a href="mailto:Lapeace29@gmail.com" class="underline">Lapeace29@gmail.com</a>
    </div>
  </div>

  <script>
  /* ===== ì •ê·œí™” & ê´€ëŒ€í•œ ì±„ì  ìœ í‹¸ ===== */
  function normalizeKo(s=''){
    return s
      .replace(/\s+/g,'')                                // ëª¨ë“  ê³µë°± ì œê±°
      .replace(/[.,!?;:'"â€œâ€â€˜â€™()[\]Â·\-â€“â€”~â€¦]/g,'');        // ë¬¸ì¥ë¶€í˜¸ ì œê±°
  }
  function stripYo(s=''){ return s.replace(/ìš”$/,''); }

  // ë ˆë²¤ìŠˆíƒ€ì¸
  function levenshtein(a,b){
    const m=a.length,n=b.length;
    if(m===0) return n; if(n===0) return m;
    const dp=new Array(n+1);
    for(let j=0;j<=n;j++) dp[j]=j;
    for(let i=1;i<=m;i++){
      let prev=dp[0]; dp[0]=i;
      for(let j=1;j<=n;j++){
        const tmp=dp[j];
        dp[j]=Math.min(
          dp[j]+1,               // ì‚­ì œ
          dp[j-1]+1,             // ì‚½ì…
          prev + (a[i-1]===b[j-1]?0:1) // ì¹˜í™˜
        );
        prev=tmp;
      }
    }
    return dp[n];
  }

  // â€˜ë¶€ë¶„ í¬í•¨â€™, ê³µë°±/ë§ˆì¹¨í‘œ ë¬´ì‹œ, â€˜ìš”â€™ ìœ ë¬´/ê²½ë¯¸ ì˜¤íƒ€ í—ˆìš©
  function classifyFill(userRaw, fillAnswer){
    const targetsRaw = fillAnswer.split('/').map(v=>v.trim());
    const userN = normalizeKo(userRaw);
    const targetsN = targetsRaw.map(normalizeKo);
    const targetsNoYo = targetsRaw.map(v=>normalizeKo(stripYo(v)));

    if (targetsN.includes(userN)) {
      return { correct:true, perfect:true, reason:null, ref: targetsRaw[targetsN.indexOf(userN)] };
    }
    if (targetsNoYo.includes(normalizeKo(stripYo(userRaw)))) {
      const idx = targetsNoYo.indexOf(normalizeKo(stripYo(userRaw)));
      return { correct:true, perfect:false, reason:"DiffÃ©rence uniquement de -ìš”.", ref: targetsRaw[idx] };
    }
    for (let k=0; k<targetsN.length; k++){
      if (userN.includes(targetsN[k])) {
        return { correct:true, perfect:false, reason:"La forme correcte est incluse partiellement.", ref: targetsRaw[k] };
      }
    }
    const dists = targetsN.map(t => levenshtein(userN, t));
    const minDist = Math.min(...dists);
    if (minDist <= 1) {
      const idx = dists.indexOf(minDist);
      return { correct:true, perfect:false, reason:"Petite faute (espace/orthographe) mineure.", ref: targetsRaw[idx] };
    }
    return { correct:false, perfect:false, reason:null, ref: targetsRaw[0] };
  }

  /* ===== ë§íˆ¬(ë†’ì„) íŒì • ìœ í‹¸ ===== */
  function getPronounClass(text=''){
    if (/ì €ëŠ”|ì „/.test(text)) return 'polite';   // ìš”/ìŠµë‹ˆë‹¤ ê³„ì—´
    if (/ë‚˜ëŠ”|ë‚œ/.test(text)) return 'casual';   // ì•„/ì–´(í•´ì²´)
    return 'neutral';
  }
  function getEndingStyle(text=''){
    const tail = (text || '').trim().replace(/[\s\n]+/g,' ');
    if (/(ìŠµë‹ˆë‹¤|ã…‚ë‹ˆë‹¤|ìŠµë‹ˆê¹Œ\??)[.!?]?$/.test(tail)) return 'deferential';
    if (/ìš”[.!?]?$/.test(tail)) return 'haeyo';
    if (/(ì•„|ì–´)[.!?]?$/.test(tail)) return 'haeche';
    if (/ë‹¤[.!?]?$/.test(tail)) return 'plain';
    return 'unknown';
  }
  function suggestRefByPoliteness(ex, pronounClass, currentRef){
    if (ex.typeAnswer !== 'etre') return currentRef;
    if (pronounClass === 'casual') return currentRef.replace(/ê°™ì•„ìš”$/, 'ê°™ì•„');
    if (pronounClass === 'polite') return currentRef.replace(/ê°™ì•„$/, 'ê°™ì•„ìš”');
    return currentRef;
  }
  function checkPolitenessConsistency(fullSentence, ex, userFillRaw){
    const p = getPronounClass(fullSentence);
    const e = getEndingStyle(fullSentence);
    const fillHasYo = /ìš”$/.test((userFillRaw||'').trim());
    const fillHaeche = /(ì•„|ì–´)$/.test((userFillRaw||'').trim());

    if (p==='casual' && (e==='haeyo' || e==='deferential' || fillHasYo)) {
      return { ok:false, reasonFr:"IncohÃ©rence de politesse : avec Â« ë‚˜ëŠ”/ë‚œ Â», n'utilisez pas -ìš”/-(ìŠ¤)ã…‚ë‹ˆë‹¤ (utilisez -ì•„/ì–´).", target:'casual' };
    }
    if (p==='polite' && (e==='haeche' || fillHaeche)) {
      return { ok:false, reasonFr:"IncohÃ©rence de politesse : avec Â« ì €ëŠ”/ì „ Â», n'utilisez pas la forme informelle -ì•„/ì–´ (utilisez -ìš”/-(ìŠ¤)ã…‚ë‹ˆë‹¤).", target:'polite' };
    }
    return { ok:true };
  }

  /* ===== HINT (FR SIMPLE, LISIBLE) ===== */
  function usageHint(ex){
    if (ex.typeAnswer === 'verbe'){
      return [
        "â€¢ Action (verbe)",
        "  Utilise Â« comme Â» pour comparer une action.",
        "  Ex.: courir comme le vent ; chanter comme une sirÃ¨ne."
      ].join("\n");
    }
    if (ex.typeAnswer === 'nom'){
      return [
        "â€¢ Nom (objet)",
        "  Â« Comme Â» sert Ã  qualifier un nom.",
        "  Ex.: un enfant comme une poupÃ©e ; un cadeau comme un trÃ©sor."
      ].join("\n");
    }
    return [
      "â€¢ ÃŠtre (Â« A est comme B Â»)",
      "  Garde simplement la structure Â« A est comme B Â».",
      "  Astuce : garde le mÃªme niveau de politesse dans toute la phrase."
    ].join("\n");
  }

  function firstAnswer(ex){ return ex.fillAnswer.split('/')[0].trim(); }

  // í•œêµ­ì–´ ë„ì–´ì“°ê¸° ê·œì¹™ ë°˜ì˜í•˜ì—¬ ë¬¸ì¥ ì¡°ë¦½
  function buildSentence(ex, userAns){
    const ans = (userAns && userAns.trim()) ? userAns.trim() : firstAnswer(ex);
    const mid = ex.koreanParts[0].trimEnd();
    const tail = ex.koreanParts[1].trimStart();
    // type=verbe: ì¡°ì‚¬ 'ì²˜ëŸ¼/ê°™ì´'ëŠ” ì•ë§ì— ë¶™ì„ â†’ ê³µë°± ì—†ì´ ê²°í•©
    if (ex.typeAnswer === 'verbe'){
      return `${mid}${ans}${tail}`.replace(/\s+/g,' ').trim();
    }
    // ê·¸ ì™¸: ì¼ë°˜ì ì¸ ë„ì–´ì“°ê¸° ì ìš© (ëª…ì‚¬ 'ê°™ì€', ì„œìˆ  'ê°™ì•„ìš”')
    return `${mid} ${ans}${tail}`.replace(/\s+/g,' ').trim();
  }

  /* ===== ì„¸ì…˜ ìƒíƒœ ===== */
  const session = {
    startTime: new Date().toISOString(),
    sentOnce: false,
    questions: []
  };

  document.addEventListener('DOMContentLoaded', () => {
    const exercises = [
      { french:"Ce bÃ©bÃ© est comme un ange.", vocab:[{fr:"bÃ©bÃ©",ko:"ì•„ê¸°"},{fr:"ange",ko:"ì²œì‚¬"}], typeAnswer:"etre",  koreanParts:["ì´ ì•„ê¸°ëŠ” ì²œì‚¬","."],           fillAnswer:"ê°™ì•„ìš”" },
      { french:"Le temps est comme de l'or.", vocab:[{fr:"temps",ko:"ì‹œê°„"},{fr:"or",ko:"ê¸ˆ"}],     typeAnswer:"etre",  koreanParts:["ì‹œê°„ì€ ê¸ˆ","."],               fillAnswer:"ê°™ì•„ìš”" },
      { french:"C'est une amie comme ma famille.", vocab:[{fr:"amie",ko:"ì¹œêµ¬"},{fr:"famille",ko:"ê°€ì¡±"}], typeAnswer:"nom", koreanParts:["ê°€ì¡±"," ì¹œêµ¬ì˜ˆìš”."],       fillAnswer:"ê°™ì€" },
      { french:"J'ai un ami comme un frÃ¨re.", vocab:[{fr:"ami",ko:"ì¹œêµ¬"},{fr:"frÃ¨re",ko:"í˜•ì œ"}],  typeAnswer:"nom",   koreanParts:["í˜•ì œ"," ì¹œêµ¬ê°€ ìˆì–´ìš”."],     fillAnswer:"ê°™ì€" },
      { french:"Il court comme le vent.", vocab:[{fr:"courir",ko:"ë‹¬ë¦¬ë‹¤"},{fr:"vent",ko:"ë°”ëŒ"}], typeAnswer:"verbe", koreanParts:["ë°”ëŒ"," ë‹¬ë ¤ìš”."],              fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Elle chante comme une sirÃ¨ne.", vocab:[{fr:"chanter",ko:"ë…¸ë˜í•˜ë‹¤"},{fr:"sirÃ¨ne",ko:"ì¸ì–´"}], typeAnswer:"verbe", koreanParts:["ì¸ì–´"," ë…¸ë˜í•´ìš”."], fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Ceci est comme un rÃªve.", vocab:[{fr:"ceci",ko:"ì´ê²ƒ"},{fr:"rÃªve",ko:"ê¿ˆ"}],       typeAnswer:"etre",  koreanParts:["ì´ê±´ ê¿ˆ","."],                 fillAnswer:"ê°™ì•„ìš”" },
      { french:"C'est une femme comme un renard.", vocab:[{fr:"femme",ko:"ì—¬ì"},{fr:"renard",ko:"ì—¬ìš°"}], typeAnswer:"nom", koreanParts:["ì—¬ìš°"," ì—¬ìì˜ˆìš”."],   fillAnswer:"ê°™ì€" },
      { french:"Il danse comme un professionnel.", vocab:[{fr:"danser",ko:"ì¶¤ì¶”ë‹¤"},{fr:"professionnel",ko:"ì „ë¬¸ê°€"}], typeAnswer:"verbe", koreanParts:["ì „ë¬¸ê°€"," ì¶¤ì„ ì¶°ìš”."], fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Aujourd'hui est comme hier.", vocab:[{fr:"aujourd'hui",ko:"ì˜¤ëŠ˜"},{fr:"hier",ko:"ì–´ì œ"}], typeAnswer:"etre", koreanParts:["ì˜¤ëŠ˜ì€ ì–´ì œ","."],      fillAnswer:"ê°™ì•„ìš”" },
      { french:"C'est un cadeau comme un trÃ©sor.", vocab:[{fr:"cadeau",ko:"ì„ ë¬¼"},{fr:"trÃ©sor",ko:"ë³´ë¬¼"}], typeAnswer:"nom", koreanParts:["ë³´ë¬¼"," ì„ ë¬¼ì´ì—ìš”."], fillAnswer:"ê°™ì€" },
      { french:"Elle parle comme un poÃ¨te.", vocab:[{fr:"parler",ko:"ë§í•˜ë‹¤"},{fr:"poÃ¨te",ko:"ì‹œì¸"}], typeAnswer:"verbe", koreanParts:["ì‹œì¸"," ë§í•´ìš”."],     fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Un coeur large comme la mer.", vocab:[{fr:"coeur",ko:"ë§ˆìŒ"},{fr:"mer",ko:"ë°”ë‹¤"}], typeAnswer:"nom",   koreanParts:["ë°”ë‹¤"," ë„“ì€ ë§ˆìŒ."],          fillAnswer:"ê°™ì€" },
      { french:"Il dort comme un ours.", vocab:[{fr:"dormir",ko:"ìë‹¤"},{fr:"ours",ko:"ê³°"}],      typeAnswer:"verbe", koreanParts:["ê³°"," ììš”."],                fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Un enfant comme une poupÃ©e.", vocab:[{fr:"enfant",ko:"ì•„ì´"},{fr:"poupÃ©e",ko:"ì¸í˜•"}], typeAnswer:"nom", koreanParts:["ì¸í˜•"," ì•„ì´."],         fillAnswer:"ê°™ì€" },
      { french:"Il marche comme un robot.", vocab:[{fr:"marcher",ko:"ê±·ë‹¤"},{fr:"robot",ko:"ë¡œë´‡"}], typeAnswer:"verbe", koreanParts:["ë¡œë´‡"," ê±¸ì–´ìš”."],      fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Une voix douce comme le sucre.", vocab:[{fr:"voix",ko:"ëª©ì†Œë¦¬"},{fr:"sucre",ko:"ì„¤íƒ•"}], typeAnswer:"nom", koreanParts:["ì„¤íƒ•"," ëª©ì†Œë¦¬."],     fillAnswer:"ê°™ì€" },
      { french:"Il est lent comme une tortue.", vocab:[{fr:"lent",ko:"ëŠë¦¬ë‹¤"},{fr:"tortue",ko:"ê±°ë¶ì´"}], typeAnswer:"verbe", koreanParts:["ê±°ë¶ì´"," ëŠë ¤ìš”."], fillAnswer:"ì²˜ëŸ¼/ê°™ì´" },
      { french:"Cette personne est comme un acteur.", vocab:[{fr:"personne",ko:"ì‚¬ëŒ"},{fr:"acteur",ko:"ë°°ìš°"}], typeAnswer:"etre", koreanParts:["ì´ ì‚¬ëŒì€ ë°°ìš°","."], fillAnswer:"ê°™ì•„ìš”" },
      { french:"Il dÃ©pense de l'argent comme de l'eau.", vocab:[{fr:"dÃ©penser",ko:"ëˆì„ ì“°ë‹¤"},{fr:"eau",ko:"ë¬¼"}], typeAnswer:"verbe", koreanParts:["ë¬¼"," ëˆì„ ì¨ìš”."], fillAnswer:"ì²˜ëŸ¼/ê°™ì´" }
    ];

    const exerciseListContainer = document.getElementById('exercise-list');
    const resetBtn = document.getElementById('reset-btn');

    function renderExercises(){
      exerciseListContainer.innerHTML = '';
      exercises.forEach((ex, index) => {
        const exerciseEl = document.createElement('div');
        exerciseEl.className = 'exercise-item';
        exerciseEl.id = `ex-${index}`;

        const vocabList = ex.vocab.map(v => `<li class="text-sm"><span class="font-semibold">${v.fr}</span>: <span class="korean-font">${v.ko}</span></li>`).join('');

        exerciseEl.innerHTML = `
          <div class="flex items-start">
            <span class="text-xl font-bold text-blue-500 mr-4">${index+1}.</span>
            <div class="w-full">
              <p class="font-semibold text-lg text-slate-800 mb-2">"${ex.french}"</p>
              <ul class="list-disc list-inside bg-slate-50 p-2 rounded-md mb-4">${vocabList}</ul>

              <!-- Step 1 -->
              <div class="mb-4">
                <p class="font-semibold text-slate-700 mb-2">1. Quel est le type de la phrase ?</p>
                <div class="flex flex-wrap gap-2 type-options">
                  <button data-type="verbe" class="btn btn-secondary">Action (Verbe) ğŸƒâ€â™‚ï¸</button>
                  <button data-type="nom" class="btn btn-secondary">Objet (Nom) âœï¸</button>
                  <button data-type="etre" class="btn btn-secondary">Identification (ÃŠtre comme) ğŸ™‹â€â™€ï¸</button>
                </div>
              </div>

              <!-- Step 2 -->
              <div>
                <p class="font-semibold text-slate-700 mb-2">2. ComplÃ©tez la phrase en corÃ©en.</p>
                <div class="flex items-center gap-2">
                  <p class="korean-font text-xl">${ex.koreanParts[0]}</p>
                  <input type="text" class="korean-font text-xl p-2 border-2 border-slate-300 rounded-lg w-48 focus:border-blue-500 focus:ring-blue-500 transition ans-input" placeholder="RÃ©ponse">
                  <p class="korean-font text-xl">${ex.koreanParts[1]}</p>
                </div>

                <!-- íŒíŠ¸: ì‚¬ìš© ë§¥ë½ ì„¤ëª… (FR seul) -->
                <div class="flex gap-3 mt-3">
                  <button class="text-sm text-rose-600 hover:underline hint2-btn">Astuce â€” Quand utiliser ? (Aidez-moi ğŸ™)</button>
                </div>
                <p class="text-sm text-rose-700 mt-2 hint2-text hidden hint-note p-2 rounded-lg"></p>
              </div>

              <div class="mt-4 border-t pt-4">
                <button class="btn btn-primary w-full check-btn">VÃ©rifier</button>
              </div>
              <div class="feedback mt-4 hidden"></div>
            </div>
          </div>
        `;
        exerciseListContainer.appendChild(exerciseEl);
      });

      // ì„¸ì…˜ ì§ˆë¬¸ ë°°ì—´ êµ¬ì„±/ë¦¬ì…‹
      session.questions = exercises.map((ex, i) => ({
        number: i+1,
        fr: ex.french,
        ko: buildSentence(ex, firstAnswer(ex)),
        userAnswer: "",
        isCorrect: false,
        hint2Count: 0
      }));

      addEventListeners();
    }

    function addEventListeners(){
      // íƒ€ì… ì„ íƒ í† ê¸€
      document.querySelectorAll('.type-options button').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const parent=e.currentTarget.parentElement;
          parent.querySelectorAll('button').forEach(b=>b.classList.remove('selected'));
          e.currentTarget.classList.add('selected');
        });
      });

      // íŒíŠ¸: ì‚¬ìš© ë§¥ë½ (FR seul)
      document.querySelectorAll('.hint2-btn').forEach((button,index)=>{
        button.addEventListener('click',()=>{
          const hintText = document.querySelector(`#ex-${index} .hint2-text`);
          hintText.textContent = usageHint(exercises[index]);
          hintText.classList.remove('hidden'); button.disabled=true;
          session.questions[index].hint2Count = (session.questions[index].hint2Count||0)+1;
        });
      });

      // Enterë¡œ ì±„ì 
      document.querySelectorAll('.ans-input').forEach((inp,index)=>{
        inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter') handleCheck(index); });
      });

      // ì±„ì  ë²„íŠ¼
      document.querySelectorAll('.check-btn').forEach((button,index)=>{
        button.addEventListener('click',()=>handleCheck(index));
      });

      // ë¦¬ì…‹
      resetBtn.addEventListener('click', renderExercises);
    }

    function handleCheck(index){
      const exerciseEl = document.getElementById(`ex-${index}`);
      const ex = exercises[index];
      const feedbackEl = exerciseEl.querySelector('.feedback');

      // Step 1: íƒ€ì…
      const selectedTypeBtn = exerciseEl.querySelector('.type-options .selected');
      const typeAnswer = selectedTypeBtn ? selectedTypeBtn.dataset.type : null;
      const isTypeCorrect = typeAnswer === ex.typeAnswer;

      // Step 2: ì±„ìš°ê¸°
      const inputEl = exerciseEl.querySelector('.ans-input');
      const userFill = (inputEl.value||'').trim();
      const judged = classifyFill(userFill, ex.fillAnswer);

      // ë¬¸ì¥ êµ¬ì„±(í•™ìƒ ì…ë ¥ ê¸°ë°˜, ì—†ìœ¼ë©´ ê¸°ì¤€ ì •ë‹µ) â€” ê·œì¹™ ê¸°ë°˜ ë„ì–´ì“°ê¸° ì ìš©
      const userFullSentence = buildSentence(ex, userFill || judged.ref);

      // ë§íˆ¬(ë†’ì„) ì¼ì¹˜ ê²€ì‚¬
      const politeness = checkPolitenessConsistency(userFullSentence, ex, userFill || judged.ref);

      // ê¸°ë³¸ ì •ì˜¤ íŒì •
      const baseCorrect = isTypeCorrect && judged.correct;

      let html = '';
      let className = 'incorrect';

      if (baseCorrect && !politeness.ok){
        className = 'incorrect';
        html += `
          <p class="font-bold">âš ï¸ Styles de politesse incohÃ©rents</p>
          <p class="text-sm mt-1">${politeness.reasonFr}</p>
          <p class="text-xs mt-1 text-slate-600">âœ… Les espaces, la ponctuation et lâ€™Â« inclusion partielle Â» sont acceptÃ©s, mais la politesse (ë‚˜ëŠ”/ì €ëŠ” â†” terminaison) doit correspondre.</p>
        `;
      } else if (isTypeCorrect && judged.correct){
        className = judged.perfect ? 'correct' : 'soft';
        html += judged.perfect
          ? `<p class="font-bold">ğŸ¥³ Parfait !</p>`
          : `
             <p class="font-bold">âœ… Le sens est correct (acceptÃ©)</p>
             <p class="text-sm mt-1">VÃ©rifie la forme exacte ci-dessous.</p>
             ${ judged.reason ? `<p class="text-xs mt-1 text-slate-700">(${judged.reason})</p>` : '' }
            `;
      } else {
        className = 'incorrect';
        html = `<p class="font-bold">ğŸ¤” Presque ! Regardons ensemble :</p><ul class="list-disc list-inside mt-2">`;
        html += isTypeCorrect
          ? `<li><strong>Partie 1 (Type) :</strong> Bien jouÃ©, c'est correct !</li>`
          : `<li><strong>Partie 1 (Type) :</strong> La bonne rÃ©ponse Ã©tait Â« <strong>${ex.typeAnswer}</strong> Â».</li>`;
        html += judged.correct
          ? `<li><strong>Partie 2 (Phrase) :</strong> Sens OK. VÃ©rifie la bonne forme ci-dessous.</li>`
          : `<li><strong>Partie 2 (Phrase) :</strong> Il fallait Ã©crire Â« <strong>${ex.fillAnswer.replace('/', ' / ')}</strong> Â».</li>`;
        html += `</ul>`;
      }

      // í‘œì‹œìš© ê¸°ì¤€ ì •ë‹µ(ë§íˆ¬ êµì • í•„ìš”ì‹œ ì¶”ì²œí˜•ìœ¼ë¡œ ì¡°ì •) â€” verbe íƒ€ì…ì€ ê³µë°± ì—†ì´
      let refAnswer = judged.ref || ex.fillAnswer.split('/')[0];
      const joiner = (ex.typeAnswer === 'verbe') ? '' : ' ';
      const fullSentenceHtml = `<strong>Phrase complÃ¨te :</strong> <span class='korean-font'>${ex.koreanParts[0]}${joiner}<span class='font-bold text-blue-700'>${refAnswer}</span>${ex.koreanParts[1]}</span>`;

      html += `<p class="mt-2 border-t border-slate-300 pt-2">${fullSentenceHtml}</p>`;

      feedbackEl.className = `feedback ${className}`;
      feedbackEl.innerHTML = html;
      feedbackEl.classList.remove('hidden');

      // ì„¸ì…˜ ì €ì¥
      const isCorrect = (isTypeCorrect && judged.correct && politeness.ok);
      session.questions[index].userAnswer = userFill || judged.ref || '';
      session.questions[index].isCorrect = isCorrect;
      session.questions[index].ko = userFullSentence;
    }

    async function sendResults(){
      if (session.sentOnce) return { ok:true, skipped:true };
      const studentName = (document.getElementById('student-name')?.value || '').trim() || 'Ã‰lÃ¨ve';

      const endTime = new Date().toISOString();
      const payload = {
        studentName,
        startTime: session.startTime,
        endTime,
        totalTimeSeconds: Math.max(1, Math.round((new Date(endTime) - new Date(session.startTime))/1000)),
        questions: session.questions.map(q=>({
          number: q.number,
          fr: q.fr,
          ko: q.ko,
          userAnswer: q.userAnswer,
          isCorrect: q.isCorrect,
          hint2Count: q.hint2Count
        }))
      };

      try{
        const r = await fetch('/.netlify/functions/send-results',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(`send-results ${r.status}`);
        session.sentOnce = true;
        return { ok:true };
      }catch(e){
        console.error(e);
        try{
          await fetch('/.netlify/functions/log-error',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              studentName, functionName:'send-results',
              pageUrl: location.href, context:{ total: session.questions.length }, error:{ message:String(e) }
            })
          });
        }catch(_){}
        return { ok:false, error:e };
      }
    }

    function showSummary(){
      const correct = session.questions.filter(q=>q.isCorrect).length;
      const total = session.questions.length;
      const score = Math.round((correct/total)*100);
      const rows = session.questions.map(q=>{
        return `<tr>
          <td class="border px-2 py-1 text-center">${q.number}</td>
          <td class="border px-2 py-1">${q.fr}</td>
          <td class="border px-2 py-1 korean-font">${q.ko}</td>
          <td class="border px-2 py-1">${q.userAnswer || '<i>(vide)</i>'}</td>
          <td class="border px-2 py-1 text-center">${q.isCorrect ? 'âœ”ï¸' : 'âŒ'}</td>
          <td class="border px-2 py-1 text-center">${q.hint2Count||0}</td>
        </tr>`;
      }).join('');

      const summaryEl = document.getElementById('summary');
      summaryEl.innerHTML = `
        <div class="mb-3">
          <h3 class="text-xl font-bold">ğŸ§¾ RÃ©sumÃ© / ìš”ì•½</h3>
          <p class="text-slate-700">Score: <b>${score}</b> / 100 &nbsp; 
            (<span class="text-emerald-700">${correct}</span> / ${total} correct)</p>
          <p class="text-xs text-slate-500">Espaces/ponctuation/inclusion partielle tolÃ©rÃ©s. La politesse doit correspondre quand le registre change.</p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border border-slate-200">
            <thead class="bg-slate-100">
              <tr>
                <th class="border px-2 py-1">#</th><th class="border px-2 py-1">FR</th>
                <th class="border px-2 py-1">KO</th><th class="border px-2 py-1">RÃ©ponse</th>
                <th class="border px-2 py-1">OK?</th><th class="border px-2 py-1">Hints</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <p class="mt-2 text-sm text-slate-600">RÃ©sultat envoyÃ©.</p>
      `;
      summaryEl.classList.remove('hidden');
    }

    const finishBtn = document.getElementById('finish-btn');
    const retryBtn  = document.getElementById('retry-btn');

    finishBtn.addEventListener('click', async ()=>{
      finishBtn.disabled = true;
      showSummary();
      const { ok } = await sendResults();
      if (!ok) alert("Ã‰chec dâ€™envoi. RÃ©essayez plus tard ou contactez le professeur.");
      finishBtn.textContent = 'âœ… EnvoyÃ©';
    });

    retryBtn.addEventListener('click', ()=>{
      session.startTime = new Date().toISOString();
      session.sentOnce = false;
      document.getElementById('summary').classList.add('hidden');
      renderExercises();
    });

    // ì´ˆê¸° ë Œë”
    renderExercises();
  });
  </script>
</body>
</html>
