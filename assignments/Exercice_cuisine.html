<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice de DictÃ©e CorÃ©enne - í•œêµ­ì–´ ë°›ì•„ì“°ê¸° ì—°ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        /* Custom focus styles for better accessibility */
        .custom-focus:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* blue-500 with opacity */
            border-color: #3b82f6; /* blue-500 */
        }
        /* Style for disabled button */
        .speak-btn:disabled {
            background-color: #93c5fd; /* blue-300 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Exercice de DictÃ©e CorÃ©enne ğŸ§</h1>
            <p class="text-lg text-slate-600 mt-2">í•œêµ­ì–´ ë°›ì•„ì“°ê¸° ì—°ìŠµ (Netlify ìŒì„± API)</p>
        </header>

        <main id="questions-container" class="space-y-6">
            <!-- Les questions seront injectÃ©es ici par JavaScript -->
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¬¸ì œê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </main>
    </div>

    <script type="module">
        // --- CONFIGURATION / ì„¤ì • ---
        // netlify.toml ì„¤ì •ì— ë”°ë¼ API ê²½ë¡œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // `netlify/functions` í´ë”ì˜ íŒŒì¼ ì´ë¦„ì´ tts.jsê°€ ì•„ë‹ˆë¼ë©´ ê²½ë¡œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
        // (ì˜ˆ: íŒŒì¼ ì´ë¦„ì´ speech.js -> "/api/speech")
        const NETLIFY_API_URL = "/.netlify/functions/generate-audio"; 

        // --- DATA / ë°ì´í„° ---
        const questions = [
            { id: 1, korean: "ì €ëŠ” ë¹µê³¼ ë¬¼ì„ ë¨¹ì–´ìš”.", french: "Je mange du pain et de l'eau.", hint2: "ë¹µ (pa..): pain / ë¬¼ (e..): eau" },
            { id: 2, korean: "ê³ ì–‘ì´ë‘ ê°•ì•„ì§€ëŠ” ê·€ì—¬ì›Œìš”.", french: "Les chats et les chiens sont mignons.", hint2: "ê³ ì–‘ì´ (ch..): chat / ê°•ì•„ì§€ (ch...): chien" },
            { id: 3, korean: "ê°€ë°©ì— ì±…ê³¼ ê³µì±…ì´ ìˆì–´ìš”.", french: "Dans mon sac, il y a un livre et un cahier.", hint2: "ì±… (li...): livre / ê³µì±… (ca...): cahier" },
            { id: 4, korean: "ì €ëŠ” í•œêµ­ ë“œë¼ë§ˆí•˜ê³  í•œêµ­ ì˜í™”ë¥¼ ì¢‹ì•„í•´ìš”.", french: "J'aime les dramas corÃ©ens et les films corÃ©ens.", hint2: "ë“œë¼ë§ˆ (dr...): drama / ì˜í™” (fi..): film" },
            { id: 5, korean: "ì €ëŠ” ì˜í™”ë¥¼ ë³´ê³  ì ì„ ììš”.", french: "Je regarde un film et puis je dors.", hint2: "ë³´ë‹¤ (re...): regarder / ì ì„ ìë‹¤ (do...): dormir" },
            { id: 6, korean: "í•™ìƒì€ ê³µë¶€ë¥¼ í•˜ê³  ë†€ì•„ìš”.", french: "L'Ã©tudiant Ã©tudie et puis il s'amuse.", hint2: "ê³µë¶€í•˜ë‹¤ (Ã©t...): Ã©tudier / ë†€ë‹¤ (s'am...): s'amuser" },
            { id: 7, korean: "ì–´ì œ ì €ë…ì„ ë¨¹ê³  ìˆ™ì œë¥¼ í–ˆì–´ìš”.", french: "Hier, j'ai dÃ®nÃ© et puis j'ai fait mes devoirs.", hint2: "ì €ë…ì„ ë¨¹ë‹¤ (dÃ®...): dÃ®ner / ìˆ™ì œ (de...): devoirs" },
            { id: 8, korean: "ìƒ¤ì›Œë¥¼ í•˜ê³  ì˜·ì„ ì…ì—ˆì–´ìš”.", french: "J'ai pris une douche et puis je me suis habillÃ©.", hint2: "ìƒ¤ì›Œë¥¼ í•˜ë‹¤ (pr... une douche): prendre une douche / ì˜·ì„ ì…ë‹¤ (s'ha...): s'habiller" },
            { id: 9, korean: "ì»¤í”¼ë‚˜ ì£¼ìŠ¤ ì£¼ì„¸ìš”.", french: "Donnez-moi du cafÃ© ou du jus.", hint2: "ì»¤í”¼ (ca..): cafÃ© / ì£¼ìŠ¤ (j..): jus" },
            { id: 10, korean: "ë²„ìŠ¤ë‚˜ ì§€í•˜ì² ì„ íƒ€ìš”.", french: "Je prends le bus ou le mÃ©tro.", hint2: "ë²„ìŠ¤ (b..): bus / ì§€í•˜ì²  (mÃ©...): mÃ©tro" },
            { id: 11, korean: "ì•„ì¹¨ì— ë¹µì´ë‚˜ ë°¥ì„ ë¨¹ì–´ìš”.", french: "Le matin, je mange du pain ou du riz.", hint2: "ì•„ì¹¨ (ma...): matin / ë°¥ (r..): riz (cuit)" },
            { id: 12, korean: "ì£¼ë§ì— ë³´í†µ ì§‘ì—ì„œ ì‰¬ê±°ë‚˜ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.", french: "Le week-end, d'habitude je me repose Ã  la maison ou je rencontre mes amis.", hint2: "ì‰¬ë‹¤ (se re...): se reposer / ë§Œë‚˜ë‹¤ (re...): rencontrer" },
            { id: 13, korean: "ì‹œê°„ì´ ìˆì„ ë•Œ, ìŒì•…ì„ ë“£ê±°ë‚˜ ì˜í™”ë¥¼ ë´ìš”.", french: "Quand j'ai le temps, j'Ã©coute de la musique ou je regarde un film.", hint2: "ìŒì•…ì„ ë“£ë‹¤ (Ã©c... de la musique): Ã©couter de la musique / ì˜í™”ë¥¼ ë³´ë‹¤ (re... un film): regarder un film" },
            { id: 14, korean: "ë‚´ì¼ ì‡¼í•‘ì„ í•˜ê±°ë‚˜ ë„ì„œê´€ì— ê°ˆ ê±°ì˜ˆìš”.", french: "Demain, je vais faire du shopping ou aller Ã  la bibliothÃ¨que.", hint2: "ì‡¼í•‘ì„ í•˜ë‹¤ (fa... du shopping): faire du shopping / ë„ì„œê´€ (bi...): bibliothÃ¨que" },
            { id: 15, korean: "ë°°ê³ íŒŒìš”. ë¼ë©´ì„ ë“ì—¬ ë¨¹ê±°ë‚˜ ë¹µì„ ë¨¹ì„ ê±°ì˜ˆìš”.", french: "J'ai faim. Je vais me faire des ramyeon ou manger du pain.", hint2: "ë°°ê³ í”„ë‹¤ (av... faim): avoir faim / ë“ì´ë‹¤ (fa... bouillir): faire bouillir" },
            { id: 16, korean: "í•œêµ­ ì‚¬ëŒë“¤ì€ ê¹€ì¹˜ì°Œê°œë¥¼ ìì£¼ ë¨¹ì–´ìš”.", french: "Les corÃ©ens mangent souvent du ragoÃ»t de kimchi.", hint2: "ìì£¼ (sou...): souvent / ë¨¹ë‹¤ (man...): manger" },
            { id: 17, korean: "ê¹€ì¹˜ì°Œê°œì—ëŠ” ê¹€ì¹˜í•˜ê³  ë¼ì§€ê³ ê¸°ê°€ ë“¤ì–´ê°€ìš”.", french: "Dans le ragoÃ»t de kimchi, on met du kimchi et de la viande de porc.", hint2: "ë¼ì§€ê³ ê¸° (vi... de porc): viande de porc / ë“¤ì–´ê°€ë‹¤ (con...): contenir" },
            { id: 18, korean: "ë¨¼ì € ë¼ì§€ê³ ê¸°ë¥¼ ëƒ„ë¹„ì— ë„£ê³  ë³¶ì•„ìš”.", french: "D'abord, on met la viande de porc dans la marmite et on la fait revenir.", hint2: "ë¨¼ì € (d'ab...): d'abord / ë³¶ë‹¤ (fa... revenir): faire revenir" },
            { id: 19, korean: "ê·¸ë¦¬ê³  ë¼ì§€ê³ ê¸°ê°€ ìµìœ¼ë©´ ê¹€ì¹˜ë¥¼ ë„£ì–´ìš”.", french: "Et quand la viande de porc est cuite, on ajoute le kimchi.", hint2: "ìµë‹¤ (Ãªtre c...): Ãªtre cuit / ë„£ë‹¤ (aj...): ajouter" },
            { id: 20, korean: "ë§ˆì§€ë§‰ìœ¼ë¡œ ë¬¼ì´ë‚˜ ìœ¡ìˆ˜ë¥¼ ë„£ê³  ë“ì´ë©´ ì™„ì„±ë¼ìš”.", french: "Pour finir, on ajoute de lâ€™eau ou du bouillon, on laisse bouillir et câ€™est prÃªt.", hint2: "ë§ˆì§€ë§‰ìœ¼ë¡œ (po... finir): pour finir / ë“ì´ë‹¤ (fa... bouillir): faire bouillir" },
            { id: 21, korean: "ë§ˆëŠ˜, ì–‘íŒŒ, ë‘ë¶€ë¥¼ ë„£ìœ¼ë©´ ë” ë§›ìˆì–´ìš”.", french: "Si on ajoute de lâ€™ail, de lâ€™oignon, du tofu, câ€™est encore meilleur.", hint2: "ë§ˆëŠ˜ (a..): ail / ì–‘íŒŒ (oi...): oignon / ë” (pl..): plus" }
        ];

        // --- AUDIO HELPERS / ì˜¤ë””ì˜¤ í—¬í¼ ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData);
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(44 + i * 2, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // --- SPEECH SYNTHESIS (Netlify API) / ìŒì„± í•©ì„± (Netlify API) ---
        const audioCache = {}; // Cache for generated audio

        async function speak(text, buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading... / ë¡œë”© ì¤‘...`;

            try {
                if (audioCache[text]) {
                    const audio = new Audio(audioCache[text]);
                    await audio.play();
                    return;
                }
                
                // Netlify API í˜¸ì¶œ
                const response = await fetch(NETLIFY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text }) // APIê°€ ë°›ì„ ë°ì´í„° í˜•ì‹
                });

                if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);

                const result = await response.json();
                // API ì‘ë‹µ í˜•ì‹ì— ë§ì¶° audioDataì™€ mimeTypeì„ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
                // ì•„ë˜ëŠ” ì˜ˆì‹œì´ë©°, ì‹¤ì œ API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                const audioData = result.audioData; // e.g., result.audioContent, result.data ë“±
                const mimeType = result.mimeType;   // e.g., "audio/L16;rate=24000"

                if (audioData && mimeType?.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioCache[text] = audioUrl;
                    const audio = new Audio(audioUrl);
                    await audio.play();
                } else {
                    throw new Error("Audio data not found in API response.");
                }
            } catch (error) {
                console.error("Error generating speech:", error);
                alert("ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Netlify API ì£¼ì†Œì™€ ì‘ë‹µ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalText;
            }
        }

        // --- HINT GENERATION / íŒíŠ¸ ìƒì„± ---
        function getChosung(text) {
            const chosung = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            let result = "";
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                if (charCode >= 0xAC00 && charCode <= 0xD7A3) { // Hangul Syllables
                    const hangulIndex = charCode - 0xAC00;
                    const chosungIndex = Math.floor(hangulIndex / (21 * 28));
                    result += chosung[chosungIndex];
                } else {
                    result += text[i];
                }
            }
            return result;
        }

        // --- RENDER QUESTIONS / ë¬¸ì œ ë Œë”ë§ ---
        const questionsContainer = document.getElementById('questions-container');
        questions.forEach(q => {
            const card = document.createElement('div');
            card.className = 'question-card bg-white p-5 rounded-xl shadow-md border border-slate-200';
            card.dataset.id = q.id;
            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-blue-600">Question ${q.id} / ë¬¸ì œ ${q.id}</h2>
                    <button data-action="speak" data-text="${q.korean}" class="speak-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 custom-focus flex items-center justify-center min-w-[150px]">
                        Ã‰couter ğŸ”Š / ë“£ê¸°
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="korean-answer-${q.id}" class="block text-sm font-medium text-slate-700 mb-1">Ã‰crivez en corÃ©en / í•œêµ­ì–´ë¡œ ë°›ì•„ì“°ê¸°</label>
                        <input type="text" id="korean-answer-${q.id}" class="korean-answer w-full p-2 border border-slate-300 rounded-md custom-focus" placeholder="ë“¤ë¦¬ëŠ” ëŒ€ë¡œ ì ì–´ë³´ì„¸ìš”...">
                    </div>
                    <div>
                        <label for="french-answer-${q.id}" class="block text-sm font-medium text-slate-700 mb-1">Traduisez en franÃ§ais / í”„ë‘ìŠ¤ì–´ë¡œ ë²ˆì—­</label>
                        <input type="text" id="french-answer-${q.id}" class="french-answer w-full p-2 border border-slate-300 rounded-md custom-focus" placeholder="ëœ»ì„ ë²ˆì—­í•´ ë³´ì„¸ìš”...">
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button data-action="hint1" class="hint-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 text-sm font-semibold py-1 px-3 rounded-full custom-focus">ğŸ’¡ Indice 1 (ì´ˆì„±)</button>
                    <button data-action="hint2" data-hint="${q.hint2}" class="hint-btn bg-orange-400 hover:bg-orange-500 text-orange-900 text-sm font-semibold py-1 px-3 rounded-full custom-focus">ğŸ’¡ Indice 2 (ë‹¨ì–´ ëœ»)</button>
                </div>
                <div class="hint-display mt-2 p-3 bg-slate-100 rounded-md text-slate-600 text-sm min-h-[40px]" style="display: none;"></div>
                <div class="mt-4 text-right">
                    <button data-action="check" class="check-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105 custom-focus">VÃ©rifier / ì •ë‹µ í™•ì¸</button>
                </div>
                <div class="result-display mt-3 p-3 rounded-md text-sm"></div>`;
            questionsContainer.appendChild(card);
        });

        // --- EVENT HANDLING / ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
        questionsContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const card = target.closest('.question-card');
            if (!card) return;

            const questionId = parseInt(card.dataset.id);
            const questionData = questions.find(q => q.id === questionId);
            const hintDisplay = card.querySelector('.hint-display');
            const action = target.dataset.action;

            if (action === 'speak') {
                speak(target.dataset.text, target);
            } 
            else if (action === 'hint1') {
                hintDisplay.textContent = `ì´ˆì„± íŒíŠ¸: ${getChosung(questionData.korean)}`;
                hintDisplay.style.display = 'block';
            } 
            else if (action === 'hint2') {
                hintDisplay.textContent = `ë‹¨ì–´ íŒíŠ¸: ${target.dataset.hint}`;
                hintDisplay.style.display = 'block';
            } 
            else if (action === 'check') {
                const koreanInput = card.querySelector('.korean-answer');
                const frenchInput = card.querySelector('.french-answer');
                const resultDisplay = card.querySelector('.result-display');
                const userAnswerKorean = koreanInput.value.trim().replace(/[.,!?]/g, "");
                const correctAnswerKorean = questionData.korean.trim().replace(/[.,!?]/g, "");
                const userAnswerFrench = frenchInput.value.trim().toLowerCase().replace(/[.,!?]/g, "");
                const correctAnswerFrench = questionData.french.trim().toLowerCase().replace(/[.,!?]/g, "");

                let isKoreanCorrect = userAnswerKorean === correctAnswerKorean;
                let isFrenchCorrect = userAnswerFrench === correctAnswerFrench;

                if (isKoreanCorrect && isFrenchCorrect) {
                    resultDisplay.innerHTML = `<p class="font-bold text-green-700">ğŸ‰ Bravo ! C'est parfait ! / ì™„ë²½í•´ìš”!</p>`;
                    resultDisplay.className = 'result-display mt-3 p-3 rounded-md text-sm bg-green-100 border border-green-200';
                } else {
                    let feedback = '<p class="font-bold text-red-700 mb-2">ğŸ¤” Oups ! VÃ©rifions ensemble. / ë‹¤ì‹œ í™•ì¸í•´ ë´ìš”.</p>';
                    if (!isKoreanCorrect) feedback += `<p><strong class="text-slate-600">ğŸ‡°ğŸ‡· CorÃ©en :</strong> ${questionData.korean}</p>`;
                    if (!isFrenchCorrect) feedback += `<p><strong class="text-slate-600">ğŸ‡«ğŸ‡· FranÃ§ais :</strong> ${questionData.french}</p>`;
                    resultDisplay.innerHTML = feedback;
                    resultDisplay.className = 'result-display mt-3 p-3 rounded-md text-sm bg-red-100 border border-red-200';
                }
            }
        });
    </script>
</body>
</html>
